<!-- views/product-details.ejs -->
<%
  // ---- locals / helpers (mobile-first) ----
  const pd   = product || {};
  const name = pd.name || 'Product';
  const img  = pd.imageUrl || '/img/placeholder.png';

  const price        = Number(pd.price || 0);
  const color        = pd.color || '';
  const size         = pd.size || '';
  const type         = pd.type || '';
  const quality      = pd.quality || '';
  const made         = pd.made || '';
  const manufacturer = pd.manufacturer || '';
  const desc         = pd.description || '';

  const backToSales = '/products/sales';

  // Wishlist helpers
  const productIdForWishlist = String(pd._id || pd.productId || pd.id || '');
  const inWish = (typeof wishset !== 'undefined') && wishset && wishset.has(productIdForWishlist);

  // Ratings (client-driven)
  const customId = pd.customId || '';
%>

<% if (success && success.length > 0) { %>
  <div class="flash flash-success">‚úÖ <%= success %></div>
<% } %>
<% if (error && error.length > 0) { %>
  <div class="flash flash-error">‚ùå <%= error %></div>
<% } %>

<main class="pd-page <%= themeCss && themeCss.includes('dark') ? 'dark-theme' : 'light-theme' %>">

  <!-- Back / crumbs -->
  <nav class="crumbs">
    <a href="<%= backToSales %>" class="crumb-back" aria-label="Back to shop">‚Üê Back</a>
    <span class="crumb-sep">/</span>
    <span class="crumb-current"><%= name %></span>
  </nav>

  <article class="pd-wrap">
    <!-- Media -->
    <div class="pd-media">
      <img class="pd-img" src="<%= img %>" alt="<%= name %>" loading="lazy" decoding="async" />
    </div>

    <!-- Info -->
    <div class="pd-info">
      <h1 class="pd-title"><%= name %></h1>

      <!-- Price (always show) -->
      <div class="pd-price-row">
        <span class="pd-price">R <%= price.toFixed(2) %></span>
      </div>

      <!-- ‚≠ê Rating summary (hidden until API fills) -->
      <div id="pd-rating-summary" data-customid="<%= customId %>" hidden>
        <div class="pd-rating-summary" aria-label="Average rating">
          <div class="stars" aria-hidden="true"></div>
          <div class="meta">
            <strong class="avg">0.0</strong> / 5
            <span class="count">(0 reviews)</span>
          </div>
        </div>
      </div>

      <!-- Attributes (only render rows that have values) -->
      <dl class="pd-attrs">
        <% if (color) { %><div class="row"><dt>Color</dt><dd><%= color %></dd></div><% } %>
        <% if (size) { %><div class="row"><dt>Size</dt><dd><%= size %></dd></div><% } %>
        <% if (type) { %><div class="row"><dt>Type</dt><dd><%= type %></dd></div><% } %>
        <% if (quality) { %><div class="row"><dt>Quality</dt><dd><%= quality %></dd></div><% } %>
        <% if (made) { %><div class="row"><dt>Made in</dt><dd><%= made %></dd></div><% } %>
        <% if (manufacturer) { %><div class="row"><dt>Manufacturer</dt><dd><%= manufacturer %></dd></div><% } %>
      </dl>

      <% if (desc) { %>
        <section class="pd-desc">
          <h2>Description</h2>
          <p><%= desc %></p>
        </section>
      <% } %>

      <!-- ‚≠ê Ratings & reviews (compact) -->
      <section class="pd-ratings">
        <h2 class="section-title">Ratings &amp; Reviews</h2>

        <!-- List (loaded from API) -->
        <div id="ratings-list" data-customid="<%= customId %>">
          <div class="ratings-empty state">Loading ratings‚Ä¶</div>
        </div>

        <!-- Rate this product (user or business) -->
        <% if (customId) { %>
        <form class="rating-form card compact" action="/products/view/<%= customId %>/ratings" method="post" novalidate>
          <fieldset class="stars-input" aria-label="Choose stars">
            <% for (let i = 5; i >= 1; i--) { %>
              <input type="radio" id="rate-<%= i %>" name="stars" value="<%= i %>">
              <label for="rate-<%= i %>" title="<%= i %> star<%= i>1?'s':'' %>">‚òÖ</label>
            <% } %>
          </fieldset>

          <div class="grid-2">
            <label class="inp">
              <input class="inp-sm" type="text" name="title" maxlength="120" placeholder="Title (optional)" />
            </label>
            <button type="submit" class="btn btn-primary xs">Save</button>
          </div>

          <label class="inp">
            <textarea class="inp-sm" name="body" rows="2" maxlength="2000" placeholder="Short review (optional)"></textarea>
          </label>
        </form>
        <% } %>
      </section>

      <!-- Actions -->
      <div class="pd-actions">
        <a
          class="btn btn-primary xs"
          href="/api/cart/add?pid=<%= pd.customId %>&back=<%= backToSales %>">
          üõí Add to Cart
        </a>

        <% if (productIdForWishlist) { %>
          <% if (!inWish) { %>
            <form action="/users/wishlist/add/<%= product._id || product.customId %>" method="POST" class="inline">
              <input type="hidden" name="redirect" value="/users/wishlist">
              <button class="btn btn-success xs" type="submit">üíö Wishlist</button>
            </form>
          <% } else { %>
            <form action="/users/wishlist/remove/<%= productIdForWishlist %>" method="POST" class="inline">
              <input type="hidden" name="redirect" value="/users/wishlist">
              <button type="submit" class="btn btn-danger xs">‚ùå Remove</button>
            </form>
          <% } %>
        <% } %>

        <a class="btn xs" href="<%= backToSales %>">‚Üê Back</a>
      </div>
    </div>
  </article>
</main>

<style nonce="<%= nonce %>">
  /* ===== Compact shell (Hisense U50 Lite friendly) ===== */
  .pd-page{ padding:clamp(.45rem,3vw,.8rem); }
  .crumbs{ display:flex; align-items:center; gap:.3rem; font-size:.82rem; margin:.05rem 0 .4rem; }
  .crumb-back{ text-decoration:none; padding:.18rem .4rem; border-radius:8px; border:1px solid #e5e7eb; background:#fff; color:inherit; }
  .crumb-back:hover{ background:#f8fafc }
  .crumb-sep{ color:#9ca3af }
  .crumb-current{ color:#6b7280; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:72vw; }

  /* ===== Layout ===== */
  .pd-wrap{ display:grid; gap:clamp(.5rem,2vw,.8rem); grid-template-columns: 1fr; max-width:960px; margin:0 auto; align-items:start; }
  @media (min-width: 880px){ .pd-wrap{ grid-template-columns: 1.05fr 1fr; gap:.9rem; } }

  /* ===== Media ===== */
  .pd-media{ background:#f3f4f6; border-radius:10px; overflow:hidden; box-shadow:0 3px 10px rgba(0,0,0,.05); }
  .pd-img{ width:100%; height:auto; display:block; max-height: 220px; object-fit: contain; }
  @media (min-width: 520px){ .pd-img{ max-height: 280px } }
  @media (min-width: 880px){ .pd-img{ max-height: 360px } }

  /* ===== Info ===== */
  .pd-title{ margin:.02rem 0 .15rem; line-height:1.2; font-size: clamp(.95rem, 4vw, 1.35rem); }
  .pd-price-row{ margin:.05rem 0 .25rem; }
  .pd-price{ font-weight:800; color:#2563eb; letter-spacing:.1px; font-size: clamp(.95rem, 3.4vw, 1.15rem); }

  /* ‚≠ê Rating summary (more compact) */
  .pd-rating-summary{ display:flex; align-items:center; gap:.35rem; margin:.1rem 0 .5rem; }
  .pd-rating-summary .stars{ font-size:.95rem; line-height:1; }
  .pd-rating-summary .meta{ font-size:.82rem; color:#374151; }

  /* Attributes list (denser) */
  .pd-attrs{ display:grid; gap:.35rem; margin:.35rem 0 .7rem; }
  .pd-attrs .row{
    display:grid; grid-template-columns: 86px 1fr;
    align-items:center; gap:.45rem; padding:.35rem .45rem;
    background:#fff; border:1px solid #e5e7eb; border-radius:9px;
  }
  .pd-attrs dt{ font-weight:700; color:#374151; font-size:.8rem; }
  .pd-attrs dd{ margin:0; color:#111827; font-size:.86rem; word-break: break-word; }

  /* Description (tight) */
  .pd-desc{ margin:.5rem 0 .8rem; }
  .pd-desc h2{ margin:0 0 .3rem; font-size:.9rem; }
  .pd-desc p{ margin:0; line-height:1.45; color:#374151; font-size:.88rem; }

  /* ‚≠ê Ratings (compact) */
  .pd-ratings{ margin:.55rem 0 .8rem; }
  .pd-ratings .section-title{ font-size:.9rem; margin:0 0 .35rem; }
  #ratings-list .state{ font-size:.86rem; color:#6b7280; }
  .rating-item{
    border:1px solid #e5e7eb; border-radius:9px; padding:.45rem .5rem; margin:.35rem 0; background:#fff;
  }
  .rating-item .ri-head{ display:flex; align-items:center; gap:.45rem; justify-content:space-between; margin-bottom:.1rem; }
  .rating-item .ri-stars{ font-size:.9rem; }
  .rating-item .ri-title{ font-weight:700; font-size:.88rem; }
  .rating-item .ri-body{ margin:.14rem 0 0; color:#374151; line-height:1.35; font-size:.86rem; }

  /* Rate form (denser + smaller inputs) */
  .rating-form.card { padding:.55rem; border:1px solid var(--border,#e5e7eb); border-radius:9px; }
  .rating-form.compact .stars-input{ display:flex; flex-direction:row-reverse; gap:.18rem; margin-bottom:.35rem; }
  .rating-form .stars-input input{ display:none; }
  .rating-form .stars-input label{ cursor:pointer; font-size:1rem; line-height:1; }
  .rating-form .stars-input input:checked ~ label,
  .rating-form .stars-input label:hover,
  .rating-form .stars-input label:hover ~ label { color:#f59e0b; }
  .rating-form .inp{ display:block; margin:.28rem 0; }
  .rating-form .inp-sm{ width:100%; border:1px solid #d1d5db; border-radius:7px; padding:.35rem .45rem; font-size:.86rem; }
  .rating-form textarea.inp-sm{ min-height:2.2rem; }

  .grid-2{ display:grid; grid-template-columns: 1fr auto; gap:.35rem; align-items:center; }

  /* Actions (stack on phones, smaller buttons) */
  .pd-actions{ display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.45rem; }
  .btn{ display:inline-block; padding:.48rem .7rem; border-radius:9px; text-decoration:none; border:1px solid #d1d5db; font-weight:700; font-size:.9rem; line-height:1; }
  .btn.sm{ padding:.4rem .6rem; font-size:.88rem; border-radius:8px; }
  .btn.xs{ padding:.34rem .5rem; font-size:.82rem; border-radius:7px; }
  .btn-primary{ background:#2563eb; color:#fff; border-color:#2563eb }
  .btn-primary:hover{ filter:brightness(.98) }
  .btn:hover{ background:#f9fafb }
  .btn-danger{ background:#d12b2b; color:#fff; border-color:#d12b2b }
  .btn-success{ background:#16a34a; color:#fff; border-color:#16a34a }
  .btn-success:hover{ filter:brightness(.98) }
  .inline{ display:inline-block; }

  /* Buttons full width on very small screens */
  @media (max-width: 520px){
    .btn { width:100%; text-align:center }
    .pd-actions{ flex-direction:column; }
    .grid-2{ grid-template-columns: 1fr; }
  }

  /* ===== Dark theme ===== */
  .dark-theme .crumb-back{ background:#111827; border-color:#374151; color:#e5e7eb; }
  .dark-theme .crumb-back:hover{ background:#0b1220; }
  .dark-theme .pd-media{ background:#0f172a; }
  .dark-theme .pd-attrs .row{ background:#111827; border-color:#374151; }
  .dark-theme .pd-attrs dt{ color:#e5e7eb; }
  .dark-theme .pd-attrs dd{ color:#f9fafb; }
  .dark-theme .pd-desc p{ color:#e5e7eb; }
  .dark-theme .rating-item{ background:#0f172a; border-color:#374151; }
  .dark-theme #ratings-list .state{ color:#9ca3af; }
</style>

<script nonce="<%= nonce %>">
(function(){
  const listEl = document.getElementById('ratings-list');
  const sumEl  = document.getElementById('pd-rating-summary');

  const customId =
    (listEl && listEl.getAttribute('data-customid')) ||
    (sumEl  && sumEl.getAttribute('data-customid'));

  if (!customId) {
    if (listEl) listEl.innerHTML = '<div class="ratings-empty state">Ratings unavailable.</div>';
    if (sumEl)  sumEl.hidden = true;
    return;
  }

  function renderStars(avg){
    const full = Math.floor(avg);
    const half = (avg - full) >= 0.5 ? 1 : 0;
    const empty = 5 - full - half;
    return '‚òÖ'.repeat(full) + (half ? '‚òÜ' : '') + '‚ú©'.repeat(empty);
  }

  fetch(`/api/products/${encodeURIComponent(customId)}/ratings?limit=5`)
    .then(r => r.json())
    .then(data => {
      if (!data || !data.ok) throw new Error('Bad response');

      // ----- LIST -----
      if (listEl) {
        const items = data.items || [];
        if (!items.length) {
          listEl.innerHTML = '<div class="ratings-empty state">No ratings yet ‚Äî be the first to review.</div>';
        } else {
          listEl.innerHTML = items.map(it => {
            const stars = '‚òÖ'.repeat(it.stars || 0) + '‚ú©'.repeat(5 - (it.stars || 0));
            const safeTitle = (it.title || '').toString().substring(0,120);
            const safeBody  = (it.body  || '').toString().substring(0,2000);
            const when = new Date(it.createdAt).toLocaleDateString();
            return `
              <div class="rating-item">
                <div class="ri-head">
                  <div class="ri-stars" aria-label="Rating ${it.stars}/5">${stars}</div>
                  <div class="ri-when">${when}</div>
                </div>
                ${safeTitle ? `<div class="ri-title">${safeTitle}</div>` : ''}
                ${safeBody  ? `<div class="ri-body">${safeBody}</div>` : ''}
              </div>
            `;
          }).join('');
        }
      }

      // ----- SUMMARY -----
      if (sumEl) {
        const avg  = Number(data.product?.avgRating || 0);
        const cnt  = Number(data.product?.ratingsCount || 0);
        if (cnt > 0) {
          const starsHost = sumEl.querySelector('.stars');
          const avgEl     = sumEl.querySelector('.avg');
          const cntEl     = sumEl.querySelector('.count');

          if (starsHost) starsHost.innerHTML = renderStars(avg);
          if (avgEl)     avgEl.textContent   = avg.toFixed(1);
          if (cntEl)     cntEl.textContent   = `(${cnt} review${cnt===1?'':'s'})`;

          sumEl.hidden = false;
        } else {
          sumEl.hidden = true;
        }
      }
    })
    .catch(() => {
      if (listEl) listEl.innerHTML = '<div class="ratings-empty state">Could not load ratings.</div>';
      if (sumEl)  sumEl.hidden = true;
    });
})();
</script>
