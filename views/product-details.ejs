<!-- views/product-details.ejs -->
<%
  // ---- locals / helpers (mobile-first) ----
  const pd   = product || {};
  const name = pd.name || 'Product';
  const img  = pd.imageUrl || '/img/placeholder.png';

  const price        = Number(pd.price || 0);
  const color        = pd.color || '';
  const size         = pd.size || '';
  const type         = pd.type || '';
  const quality      = pd.quality || '';
  const made         = pd.made || '';
  const manufacturer = pd.manufacturer || '';
  const desc         = pd.description || '';

  const backToSales = '/products/sales';

  // Wishlist helpers
  const productIdForWishlist = String(pd._id || pd.productId || pd.id || '');
  const inWish = (typeof wishset !== 'undefined') && wishset && wishset.has(productIdForWishlist);

  // Ratings (client-driven)
  const customId = pd.customId || '';
%>

<% if (success && success.length > 0) { %>
  <div class="flash flash-success">✅ <%= success %></div>
<% } %>
<% if (error && error.length > 0) { %>
  <div class="flash flash-error">❌ <%= error %></div>
<% } %>

<main class="product-details <%= themeCss && themeCss.includes('dark') ? 'dark-theme' : 'light-theme' %>">
  <!-- Back navigation -->
  <nav class="breadcrumbs">
    <a href="<%= backToSales %>" class="breadcrumb-back" aria-label="Back to shop">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      Back to Shop
    </a>
  </nav>

  <div class="product-container">
    <!-- Product Media -->
    <div class="product-media">
      <div class="product-image-container">
        <img class="product-image" src="<%= img %>" alt="<%= name %>" loading="lazy" decoding="async" />
      </div>
    </div>

    <!-- Product Info -->
    <div class="product-info">
      <div class="product-header">
        <h1 class="product-title"><%= name %></h1>
        
        <!-- Price -->
        <div class="product-price">
          R <%= price.toFixed(2) %>
        </div>
        
        <!-- Rating summary -->
        <div id="product-rating-summary" data-customid="<%= customId %>" hidden>
          <div class="rating-summary" aria-label="Average rating">
            <div class="rating-stars" aria-hidden="true"></div>
            <div class="rating-meta">
              <strong class="rating-avg">0.0</strong> / 5
              <span class="rating-count">(0 reviews)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Product Actions -->
      <div class="product-actions">
        <a
          class="btn btn-primary btn-cart"
          href="/api/cart/add?pid=<%= pd.customId %>&back=<%= backToSales %>">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 3H5L5.4 5M7 13H17L21 5H5.4M7 13L5.4 5M7 13L4.7 15.3C4.3 15.7 4.6 16.4 5.2 16.4H17M17 16C16.4 16 16 16.4 16 17C16 17.6 16.4 18 17 18C17.6 18 18 17.6 18 17C18 16.4 17.6 16 17 16ZM9 17C9 17.6 8.6 18 8 18C7.4 18 7 17.6 7 17C7 16.4 7.4 16 8 16C8.6 16 9 16.4 9 17Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Add to Cart
        </a>

        <% if (productIdForWishlist) { %>
          <% if (!inWish) { %>
            <form action="/users/wishlist/add/<%= product._id || product.customId %>" method="POST" class="wishlist-form">
              <input type="hidden" name="redirect" value="/users/wishlist">
              <button class="btn btn-secondary btn-wishlist" type="submit">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.04L12 21.35Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Add to Wishlist
              </button>
            </form>
          <% } else { %>
            <form action="/users/wishlist/remove/<%= productIdForWishlist %>" method="POST" class="wishlist-form">
              <input type="hidden" name="redirect" value="/users/wishlist">
              <button type="submit" class="btn btn-secondary btn-wishlist active">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 21.35L10.55 20.03C5.4 15.36 2 12.28 2 8.5C2 5.42 4.42 3 7.5 3C9.24 3 10.91 3.81 12 5.09C13.09 3.81 14.76 3 16.5 3C19.58 3 22 5.42 22 8.5C22 12.28 18.6 15.36 13.45 20.04L12 21.35Z"/>
                </svg>
                Remove from Wishlist
              </button>
            </form>
          <% } %>
        <% } %>
      </div>

      <!-- Product Attributes -->
      <div class="product-attributes">
        <% if (color || size || type || quality || made || manufacturer) { %>
          <h3 class="section-title">Product Details</h3>
          <div class="attributes-grid">
            <% if (color) { %><div class="attribute"><span class="attribute-label">Color</span><span class="attribute-value"><%= color %></span></div><% } %>
            <% if (size) { %><div class="attribute"><span class="attribute-label">Size</span><span class="attribute-value"><%= size %></span></div><% } %>
            <% if (type) { %><div class="attribute"><span class="attribute-label">Type</span><span class="attribute-value"><%= type %></span></div><% } %>
            <% if (quality) { %><div class="attribute"><span class="attribute-label">Quality</span><span class="attribute-value"><%= quality %></span></div><% } %>
            <% if (made) { %><div class="attribute"><span class="attribute-label">Made in</span><span class="attribute-value"><%= made %></span></div><% } %>
            <% if (manufacturer) { %><div class="attribute"><span class="attribute-label">Manufacturer</span><span class="attribute-value"><%= manufacturer %></span></div><% } %>
          </div>
        <% } %>
      </div>

      <!-- Product Description -->
      <% if (desc) { %>
        <section class="product-description">
          <h3 class="section-title">Description</h3>
          <p><%= desc %></p>
        </section>
      <% } %>

      <!-- Ratings & Reviews -->
      <section class="product-reviews">
        <h3 class="section-title">Ratings & Reviews</h3>

        <!-- Reviews List -->
        <div id="reviews-list" data-customid="<%= customId %>">
          <div class="reviews-empty">Loading reviews…</div>
        </div>

        <!-- Review Form -->
        <% if (customId) { %>
        <div class="review-form-container">
          <h4>Add Your Review</h4>
          <form class="review-form" action="/products/view/<%= customId %>/ratings" method="post" novalidate>
            <div class="rating-input">
              <span class="rating-label">Your Rating:</span>
              <div class="stars-input" aria-label="Choose stars">
                <% for (let i = 5; i >= 1; i--) { %>
                  <input type="radio" id="rate-<%= i %>" name="stars" value="<%= i %>">
                  <label for="rate-<%= i %>" title="<%= i %> star<%= i>1?'s':'' %>">★</label>
                <% } %>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <input type="text" name="title" maxlength="120" placeholder="Review title (optional)" />
              </div>
            </div>

            <div class="form-group">
              <textarea name="body" rows="3" maxlength="2000" placeholder="Share your experience with this product (optional)"></textarea>
            </div>

            <button type="submit" class="btn btn-primary">Submit Review</button>
          </form>
        </div>
        <% } %>
      </section>
    </div>
  </div>
</main>

<style nonce="<%= nonce %>">
  /* ===== BASE STYLES ===== */
  .product-details {
    padding: 0.75rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* ===== BREADCRUMBS ===== */
  .breadcrumbs {
    margin-bottom: 1.25rem;
  }

  .breadcrumb-back {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    text-decoration: none;
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 500;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    transition: all 0.2s ease;
    border: 1px solid #e5e7eb;
  }

  .breadcrumb-back:hover {
    background-color: #f9fafb;
    color: #374151;
  }

  /* ===== PRODUCT LAYOUT ===== */
  .product-container {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    align-items: start;
  }

  @media (min-width: 768px) {
    .product-container {
      grid-template-columns: 1fr 1fr;
      gap: 3rem;
    }
  }

  /* ===== PRODUCT MEDIA ===== */
  .product-media {
    position: relative;
  }

  .product-image-container {
    background: #f8fafc;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .product-image {
    width: 100%;
    height: auto;
    display: block;
    aspect-ratio: 1 / 1;
    object-fit: contain;
  }

  /* ===== PRODUCT INFO ===== */
  .product-header {
    margin-bottom: 1.5rem;
  }

  .product-title {
    font-size: 1.5rem;
    font-weight: 700;
    line-height: 1.2;
    margin: 0 0 0.75rem 0;
    color: #111827;
  }

  .product-price {
    font-size: 1.75rem;
    font-weight: 800;
    color: #2563eb;
    margin-bottom: 1rem;
  }

  /* ===== RATING SUMMARY ===== */
  .rating-summary {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .rating-stars {
    font-size: 1.125rem;
    color: #f59e0b;
    line-height: 1;
  }

  .rating-meta {
    font-size: 0.875rem;
    color: #6b7280;
  }

  .rating-avg {
    color: #111827;
  }

  /* ===== PRODUCT ACTIONS ===== */
  .product-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-bottom: 2rem;
  }

  @media (min-width: 480px) {
    .product-actions {
      flex-direction: row;
    }
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    border-radius: 8px;
    font-weight: 600;
    font-size: 0.875rem;
    text-decoration: none;
    border: 1px solid transparent;
    cursor: pointer;
    transition: all 0.2s ease;
    line-height: 1;
  }

  .btn-primary {
    background-color: #2563eb;
    color: white;
    flex: 1;
  }

  .btn-primary:hover {
    background-color: #1d4ed8;
  }

  .btn-secondary {
    background-color: white;
    color: #374151;
    border-color: #d1d5db;
    flex: 1;
  }

  .btn-secondary:hover {
    background-color: #f9fafb;
    border-color: #9ca3af;
  }

  .btn-wishlist.active {
    background-color: #fef2f2;
    color: #dc2626;
    border-color: #fecaca;
  }

  /* ===== PRODUCT ATTRIBUTES ===== */
  .section-title {
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 1rem 0;
    color: #111827;
  }

  .product-attributes {
    margin-bottom: 2rem;
  }

  .attributes-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 0.75rem;
  }

  .attribute {
    display: flex;
    flex-direction: column;
    padding: 0.75rem;
    background-color: #f9fafb;
    border-radius: 8px;
  }

  .attribute-label {
    font-size: 0.75rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.025em;
    margin-bottom: 0.25rem;
  }

  .attribute-value {
    font-size: 0.875rem;
    font-weight: 500;
    color: #111827;
  }

  /* ===== PRODUCT DESCRIPTION ===== */
  .product-description {
    margin-bottom: 2rem;
  }

  .product-description p {
    line-height: 1.6;
    color: #4b5563;
    margin: 0;
  }

  /* ===== REVIEWS ===== */
  .product-reviews {
    margin-top: 2rem;
  }

  .reviews-empty {
    text-align: center;
    padding: 2rem;
    color: #6b7280;
    font-style: italic;
  }

  .review-item {
    padding: 1.25rem 0;
    border-bottom: 1px solid #e5e7eb;
  }

  .review-item:last-child {
    border-bottom: none;
  }

  .review-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
  }

  .review-stars {
    color: #f59e0b;
    font-size: 0.875rem;
  }

  .review-title {
    font-weight: 600;
    margin: 0 0 0.5rem 0;
    color: #111827;
  }

  .review-body {
    color: #4b5563;
    line-height: 1.5;
    margin: 0;
  }

  .review-date {
    font-size: 0.75rem;
    color: #9ca3af;
  }

  /* ===== REVIEW FORM ===== */
  .review-form-container {
    margin-top: 2rem;
    padding: 1.5rem;
    background-color: #f9fafb;
    border-radius: 12px;
  }

  .review-form-container h4 {
    margin: 0 0 1rem 0;
    font-size: 1rem;
    font-weight: 600;
    color: #111827;
  }

  .rating-input {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .rating-label {
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
  }

  .stars-input {
    display: flex;
    flex-direction: row-reverse;
    gap: 0.25rem;
  }

  .stars-input input {
    display: none;
  }

  .stars-input label {
    cursor: pointer;
    font-size: 1.25rem;
    color: #d1d5db;
    transition: color 0.2s ease;
  }

  .stars-input input:checked ~ label,
  .stars-input label:hover,
  .stars-input label:hover ~ label {
    color: #f59e0b;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  @media (min-width: 480px) {
    .form-row {
      grid-template-columns: 1fr auto;
    }
  }

  .form-group {
    margin-bottom: 1rem;
  }

  .form-group input,
  .form-group textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 0.875rem;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .form-group input:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  /* ===== FLASH MESSAGES ===== */
  .flash {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
    font-size: 0.875rem;
    font-weight: 500;
  }

  .flash-success {
    background-color: #d1fae5;
    color: #065f46;
    border: 1px solid #a7f3d0;
  }

  .flash-error {
    background-color: #fee2e2;
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  /* ===== DARK THEME ===== */
  .dark-theme {
    background-color: #111827;
    color: #f9fafb;
  }

  .dark-theme .breadcrumb-back {
    background-color: #1f2937;
    border-color: #374151;
    color: #d1d5db;
  }

  .dark-theme .breadcrumb-back:hover {
    background-color: #374151;
  }

  .dark-theme .product-image-container {
    background: #1f2937;
  }

  .dark-theme .product-title,
  .dark-theme .section-title {
    color: #f9fafb;
  }

  .dark-theme .attribute {
    background-color: #1f2937;
  }

  .dark-theme .attribute-value {
    color: #e5e7eb;
  }

  .dark-theme .product-description p {
    color: #d1d5db;
  }

  .dark-theme .btn-secondary {
    background-color: #1f2937;
    color: #e5e7eb;
    border-color: #374151;
  }

  .dark-theme .btn-secondary:hover {
    background-color: #374151;
  }

  .dark-theme .review-form-container {
    background-color: #1f2937;
  }

  .dark-theme .form-group input,
  .dark-theme .form-group textarea {
    background-color: #111827;
    border-color: #374151;
    color: #f9fafb;
  }

  .dark-theme .review-item {
    border-bottom-color: #374151;
  }

  .dark-theme .review-title {
    color: #f9fafb;
  }

  .dark-theme .review-body {
    color: #d1d5db;
  }
</style>

<script nonce="<%= nonce %>">
(function(){
  const listEl = document.getElementById('reviews-list');
  const sumEl  = document.getElementById('product-rating-summary');

  const customId =
    (listEl && listEl.getAttribute('data-customid')) ||
    (sumEl  && sumEl.getAttribute('data-customid'));

  if (!customId) {
    if (listEl) listEl.innerHTML = '<div class="reviews-empty">Reviews unavailable.</div>';
    if (sumEl)  sumEl.hidden = true;
    return;
  }

  function renderStars(avg){
    const full = Math.floor(avg);
    const half = (avg - full) >= 0.5 ? 1 : 0;
    const empty = 5 - full - half;
    return '★'.repeat(full) + (half ? '☆' : '') + '✩'.repeat(empty);
  }

  fetch(`/api/products/${encodeURIComponent(customId)}/ratings?limit=5`)
    .then(r => r.json())
    .then(data => {
      if (!data || !data.ok) throw new Error('Bad response');

      // ----- REVIEWS LIST -----
      if (listEl) {
        const items = data.items || [];
        if (!items.length) {
          listEl.innerHTML = '<div class="reviews-empty">No reviews yet — be the first to review this product.</div>';
        } else {
          listEl.innerHTML = items.map(it => {
            const stars = '★'.repeat(it.stars || 0) + '✩'.repeat(5 - (it.stars || 0));
            const safeTitle = (it.title || '').toString().substring(0,120);
            const safeBody  = (it.body  || '').toString().substring(0,2000);
            const when = new Date(it.createdAt).toLocaleDateString();
            return `
              <div class="review-item">
                <div class="review-header">
                  <div class="review-stars" aria-label="Rating ${it.stars}/5">${stars}</div>
                  <div class="review-date">${when}</div>
                </div>
                ${safeTitle ? `<h4 class="review-title">${safeTitle}</h4>` : ''}
                ${safeBody  ? `<p class="review-body">${safeBody}</p>` : ''}
              </div>
            `;
          }).join('');
        }
      }

      // ----- RATING SUMMARY -----
      if (sumEl) {
        const avg  = Number(data.product?.avgRating || 0);
        const cnt  = Number(data.product?.ratingsCount || 0);
        if (cnt > 0) {
          const starsHost = sumEl.querySelector('.rating-stars');
          const avgEl     = sumEl.querySelector('.rating-avg');
          const cntEl     = sumEl.querySelector('.rating-count');

          if (starsHost) starsHost.innerHTML = renderStars(avg);
          if (avgEl)     avgEl.textContent   = avg.toFixed(1);
          if (cntEl)     cntEl.textContent   = `(${cnt} review${cnt===1?'':'s'})`;

          sumEl.hidden = false;
        } else {
          sumEl.hidden = true;
        }
      }
    })
    .catch(() => {
      if (listEl) listEl.innerHTML = '<div class="reviews-empty">Could not load reviews.</div>';
      if (sumEl)  sumEl.hidden = true;
    });
})();
</script>