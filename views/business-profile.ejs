<% const NONCE = typeof nonce !== 'undefined' ? nonce : '' %>
<% const b = business || {} %>
<% const ver = (b.verification || {}) %>
<% const bank = (b.bankDetails || {}) %>

<% const emailVerified = !!b.isVerified %>
<% const numStatus = ((ver.status || 'pending') + '').toLowerCase() %>

<section class="biz-profile-page">
  <div class="bp-wrap">

    <!-- Header -->
    <header class="bp-header">
      <div class="bp-header-top">

        <div class="bp-brand">
          <div class="bp-swatches" aria-label="Company colors">
            <span class="sw blue" title="Blue"></span>
            <span class="sw purple" title="Purple"></span>
            <span class="sw green" title="Green"></span>
            <span class="sw black" title="Black"></span>
          </div>

          <div class="bp-title">
            <h1>Business Profile</h1>
            <p>Manage your business settings and verification status</p>
          </div>
        </div>

        <div class="bp-actions">
          <a href="/business/dashboard" class="btn btn-ghost">
            <span aria-hidden="true">‚Üê</span>
            <span>Dashboard</span>
          </a>

          <% if (!emailVerified) { %>
            <a href="/business/verify-pending" class="btn btn-primary">Verify Email</a>
          <% } else { %>
            <span class="badge ok">
              <span class="dot"></span>
              Email Verified
            </span>
          <% } %>
        </div>

      </div>

      <!-- Status pills -->
      <div class="bp-pills" role="list" aria-label="Status">
        <span class="pill pill-blue" role="listitem"><%= (b.role || 'business').toUpperCase() %></span>

        <span class="pill pill-purple" role="listitem">
          ID: <%= b.internalBusinessId || String(b._id || '‚Äî') %>
        </span>

        <% if (emailVerified) { %>
          <span class="pill pill-green" role="listitem">Email Status: Verified</span>
        <% } else { %>
          <span class="pill pill-amber" role="listitem">Email Status: Unverified</span>
        <% } %>

        <% if (numStatus === 'verified') { %>
          <span class="pill pill-green" role="listitem">Official Number Status: Verified</span>
        <% } else if (numStatus === 'rejected') { %>
          <span class="pill pill-red" role="listitem">Official Number Status: Rejected</span>
        <% } else { %>
          <span class="pill pill-amber" role="listitem">Official Number Status: Pending</span>
        <% } %>
      </div>
    </header>

    <!-- Grid -->
    <div class="bp-grid">

      <!-- Overview -->
      <article class="card card-purple">
        <div class="card-head">
          <div class="card-head-left">
            <div class="ic ic-purple" aria-hidden="true">üè¢</div>
            <div>
              <h2>Business Overview</h2>
              <p class="muted">Your public and contact details</p>
            </div>
          </div>
          <span class="tag tag-purple">Details</span>
        </div>

        <div class="card-body">
          <div class="row">
            <span class="k">Name</span>
            <span class="v"><%= b.name || '‚Äî' %></span>
          </div>
          <div class="row">
            <span class="k">Email</span>
            <span class="v wrap"><%= b.email || '‚Äî' %></span>
          </div>
          <div class="row">
            <span class="k">Phone</span>
            <span class="v wrap"><%= b.phone || '‚Äî' %></span>
          </div>
          <div class="row">
            <span class="k">Location</span>
            <span class="v wrap"><%= [b.city, b.country].filter(Boolean).join(', ') || '‚Äî' %></span>
          </div>
          <div class="row">
            <span class="k">Address</span>
            <span class="v wrap"><%= b.address || '‚Äî' %></span>
          </div>
          <div class="row">
            <span class="k">Member Since</span>
            <span class="v">
              <%= b.createdAt ? new Date(b.createdAt).toLocaleDateString('en-ZA', { year:'numeric', month:'short', day:'numeric' }) : '‚Äî' %>
            </span>
          </div>
        </div>

        <div class="card-foot">
          <a href="/business/profile/edit-details" class="btn btn-outline">Edit Business Details</a>
        </div>
      </article>

      <!-- Verification -->
      <article class="card card-blue">
        <div class="card-head">
          <div class="card-head-left">
            <div class="ic ic-blue" aria-hidden="true">‚úÖ</div>
            <div>
              <h2>Verification Status</h2>
              <p class="muted">Email + official number checks</p>
            </div>
          </div>

          <% if (emailVerified && numStatus === 'verified') { %>
            <span class="tag tag-green">Complete</span>
          <% } else { %>
            <span class="tag tag-amber">Action</span>
          <% } %>
        </div>

        <div class="card-body">
          <div class="row">
            <span class="k">Email Status</span>
            <span class="v">
              <% if (emailVerified) { %>
                <span class="chip chip-green">Verified</span>
              <% } else { %>
                <span class="chip chip-amber">Pending</span>
              <% } %>
            </span>
          </div>

          <div class="row">
            <span class="k">Official Number</span>
            <span class="v wrap"><%= b.officialNumber || '‚Äî' %></span>
          </div>

          <div class="row">
            <span class="k">Number Type</span>
            <span class="v"><%= b.officialNumberType || 'OTHER' %></span>
          </div>

          <div class="row">
            <span class="k">Verification</span>
            <span class="v">
              <% if (numStatus === 'verified') { %>
                <span class="chip chip-green">Verified</span>
              <% } else if (numStatus === 'rejected') { %>
                <span class="chip chip-red">Rejected</span>
              <% } else { %>
                <span class="chip chip-amber">Pending Review</span>
              <% } %>
            </span>
          </div>
        </div>

        <div class="card-foot">
          <% if (!emailVerified) { %>
            <a href="/business/verify-pending" class="btn btn-primary">Verify Email Address</a>
            <p class="note">Tip: Check your spam/junk folder too.</p>
          <% } else if (numStatus === 'rejected') { %>
            <div class="msg msg-red">
              Your official number was rejected. Update details and wait for admin review.
            </div>
          <% } else if (numStatus !== 'verified') { %>
            <div class="msg msg-amber">
              Official number is pending admin review. This usually takes 1‚Äì2 business days.
            </div>
          <% } else { %>
            <div class="msg msg-green">
              All verifications are complete ‚úÖ
            </div>
          <% } %>
        </div>
      </article>

      <!-- Bank -->
      <article class="card card-green">
        <div class="card-head">
          <div class="card-head-left">
            <div class="ic ic-green" aria-hidden="true">üè¶</div>
            <div>
              <h2>Bank Details</h2>
              <p class="muted">Masked preview for security</p>
            </div>
          </div>
          <span class="tag tag-green">Preview</span>
        </div>

        <!--card body-->
        <div class="card-body">
          <div class="row">
            <span class="k">Payout Method</span>
            <span class="v"><%= String(bank.payoutMethod || 'bank').toUpperCase() %></span>
          </div>

          <div class="row">
            <span class="k">Bank Name</span>
            <span class="v wrap"><%= bank.bankName || '‚Äî' %></span>
          </div>

          <div class="row">
            <span class="k">Account Holder</span>
            <span class="v wrap"><%= bank.accountHolderName || '‚Äî' %></span>
          </div>

          <!--row-->
          <div class="row">
            <span class="k">Account</span>
            <span class="v"><%= bank.accountNumberMasked || '‚Äî' %></span>
          </div>

          <div class="row">
            <span class="k">Branch Code</span>
            <span class="v wrap"><%= bank.branchCode || '‚Äî' %></span>
          </div>

          <div class="row">
            <span class="k">Account Type</span>
            <span class="v wrap"><%= bank.accountType || '‚Äî' %></span>
          </div>

          <div class="row">
            <span class="k">Currency</span>
            <span class="v"><%= bank.currency || '‚Äî' %></span>
          </div>

          <div class="snapshot">
            <div class="snap-title">Latest Bank Snapshot</div>
            <div class="snap-grid">
              <div class="snap-item">
                <span class="k">SWIFT</span>
                <span class="v wrap"><%= bank.swiftCode || '‚Äî' %></span>
              </div>
              <div class="snap-item">
                <span class="k">IBAN</span>
                <span class="v wrap">
                  <% const iban = String(bank.iban || ''); %>
                  <%= iban ? ('‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ' + iban.slice(-6)) : '‚Äî' %>
                </span>
              </div>
              <div class="snap-item">
                <span class="k">Last Updated</span>
                <span class="v wrap">
                  <%= bank.updatedAt ? new Date(bank.updatedAt).toLocaleString('en-ZA') : '‚Äî' %>
                </span>
              </div>
            </div>
          </div>
        </div>

        <div class="card-foot">
          <a href="/business/profile/edit-bank" class="btn btn-outline">Edit Bank Details</a>
          <p class="note">Only masked values are displayed on this page.</p>
        </div>
      </article>

    </div>

    <!-- Privacy & Security -->
    <section class="sec">
      <div class="sec-head">
        <h2>Privacy &amp; Security</h2>
        <p>Use the links below to manage your account safely.</p>
      </div>

      <div class="sec-grid">
        <a href="/business/profile/edit-details" class="sec-item sec-blue">
          <div class="sec-ic">‚úèÔ∏è</div>
          <div class="sec-txt">
            <h3>Edit Business Details</h3>
            <p>Update name, email, address, and official number</p>
          </div>
          <div class="sec-go">‚Ä∫</div>
        </a>

        <a href="/business/profile/edit-bank" class="sec-item sec-green">
          <div class="sec-ic">üí≥</div>
          <div class="sec-txt">
            <h3>Bank Details</h3>
            <p>Update bank, holder, and payout method</p>
          </div>
          <div class="sec-go">‚Ä∫</div>
        </a>

        <a href="/business/change-password" class="sec-item sec-purple">
          <div class="sec-ic">üîí</div>
          <div class="sec-txt">
            <h3>Change Password</h3>
            <p>Update your password securely</p>
          </div>
          <div class="sec-go">‚Ä∫</div>
        </a>

        <a href="/business/profile/edit" class="sec-item sec-black">
          <div class="sec-ic">‚öôÔ∏è</div>
          <div class="sec-txt">
            <h3>Full Profile Editor</h3>
            <p>Advanced editor for all profile fields</p>
          </div>
          <div class="sec-go">‚Ä∫</div>
        </a>
      </div>

      <!-- Danger zone -->
      <div class="danger">
        <div class="danger-head">
          <h3>Danger Zone</h3>
          <p>Permanent actions that cannot be undone.</p>
        </div>

        <div class="danger-actions">
          <a href="/business/profile/edit" class="btn btn-danger">Manage Account Settings</a>
          <p class="note">Deleting your business account is permanent and cannot be recovered.</p>
        </div>
      </div>
    </section>
  </div>
</section>

<style nonce="<%= NONCE %>">
  .biz-profile-page{
    --p:#7C3AED; --p2:#6D28D9;
    --b:#2563EB; --g:#22C55E; --k:#0F172A;
    --bg:#F8FAFC; --w:#ffffff;
    --t:#0F172A; --mut:#64748B;
    --br:#E2E8F0; --br2:#CBD5E1;
    --rad:14px; --rad2:12px;
    --sh:0 8px 18px rgba(15,23,42,.08);
    background: var(--bg);
    padding: 14px 0 24px;
  }

  .bp-wrap{
    width: min(1100px, 100%);
    margin: 0 auto;
    padding: 0 12px;
  }

  /* Header */
  .bp-header{
    background: linear-gradient(135deg, rgba(124,58,237,.14), rgba(37,99,235,.10));
    border: 1px solid rgba(124,58,237,.22);
    border-radius: var(--rad);
    padding: 14px;
    box-shadow: var(--sh);
    overflow: hidden;
  }

  .bp-header-top{
    display:flex;
    flex-direction:column;
    gap:12px;
  }

  .bp-brand{
    display:flex;
    gap:12px;
    align-items:center;
    min-width:0;
  }

  .bp-swatches{
    display:flex;
    gap:6px;
    padding:8px;
    border-radius: 12px;
    background: rgba(255,255,255,.75);
    border: 1px solid rgba(124,58,237,.18);
    flex-shrink:0;
  }
  .sw{ width:10px; height:34px; border-radius:10px; display:block; }
  .sw.blue{ background: var(--b); }
  .sw.purple{ background: var(--p); }
  .sw.green{ background: var(--g); }
  .sw.black{ background: var(--k); }

  .bp-title{ min-width:0; }
  .bp-title h1{
    margin:0;
    font-size: 18px;
    line-height:1.2;
    color: var(--t);
    letter-spacing:.2px;
  }
  .bp-title p{
    margin:4px 0 0;
    font-size: 12.5px;
    color: var(--mut);
    line-height:1.35;
  }

  .bp-actions{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  .bp-pills{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-top: 12px;
  }

  /* Buttons + badges */
  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding: 10px 12px;
    border-radius: 12px;
    font-size: 13px;
    font-weight: 700;
    text-decoration:none;
    border:1px solid transparent;
    cursor:pointer;
    user-select:none;
    min-height: 42px; /* touch */
  }

  .btn-primary{
    background: var(--p);
    color:#fff;
    border-color: rgba(124,58,237,.55);
  }
  .btn-primary:hover{ background: var(--p2); }

  .btn-ghost{
    background: rgba(255,255,255,.85);
    border-color: rgba(124,58,237,.22);
    color: var(--k);
  }
  .btn-ghost:hover{ border-color: rgba(124,58,237,.45); }

  .btn-outline{
    background: rgba(255,255,255,.9);
    border-color: rgba(124,58,237,.45);
    color: var(--p);
  }
  .btn-outline:hover{ background: rgba(124,58,237,.08); }

  .btn-danger{
    background: rgba(220,38,38,.08);
    border-color: rgba(220,38,38,.4);
    color:#B91C1C;
  }
  .btn-danger:hover{ background: rgba(220,38,38,.12); }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 10px 12px;
    border-radius: 999px;
    border: 1px solid transparent;
    font-size: 13px;
    font-weight: 800;
    min-height: 42px;
    white-space: nowrap;
  }
  .badge.ok{
    background: rgba(34,197,94,.12);
    border-color: rgba(34,197,94,.25);
    color:#15803D;
  }
  .badge .dot{
    width:10px;height:10px;border-radius:50%;
    background:#22C55E;
    box-shadow: 0 0 0 3px rgba(34,197,94,.18);
  }

  .pill{
    display:inline-flex;
    align-items:center;
    padding: 7px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 800;
    border: 1px solid transparent;
    max-width: 100%;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .pill-blue{ background: rgba(37,99,235,.12); border-color: rgba(37,99,235,.22); color: var(--b); }
  .pill-purple{ background: rgba(124,58,237,.12); border-color: rgba(124,58,237,.22); color: var(--p); }
  .pill-green{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.22); color:#15803D; }
  .pill-amber{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.28); color:#B45309; }
  .pill-red{ background: rgba(220,38,38,.12); border-color: rgba(220,38,38,.24); color:#B91C1C; }

  /* Grid */
  .bp-grid{
    display:grid;
    gap: 12px;
    margin-top: 12px;
  }
  @media (min-width: 860px){
    .bp-grid{ grid-template-columns: 1.05fr .95fr .95fr; }
  }

  /* Cards */
  .card{
    background: rgba(255,255,255,.95);
    border: 1px solid var(--br);
    border-radius: var(--rad);
    box-shadow: var(--sh);
    overflow:hidden;
  }

  .card-head{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap: 10px;
    padding: 12px;
    border-bottom: 1px solid rgba(226,232,240,.9);
  }
  .card-head-left{ display:flex; gap:10px; align-items:center; min-width:0; }

  .card h2{
    margin:0;
    font-size: 14.5px;
    line-height: 1.2;
    color: var(--t);
  }
  .muted{ margin:4px 0 0; color: var(--mut); font-size: 12px; line-height:1.35; }

  .ic{
    width: 40px; height: 40px;
    border-radius: 12px;
    display:flex; align-items:center; justify-content:center;
    font-size: 18px;
    flex-shrink:0;
    border: 1px solid transparent;
  }
  .ic-purple{ background: rgba(124,58,237,.12); border-color: rgba(124,58,237,.25); }
  .ic-blue{ background: rgba(37,99,235,.12); border-color: rgba(37,99,235,.25); }
  .ic-green{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.25); }

  .tag{
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 900;
    white-space:nowrap;
    border: 1px solid transparent;
  }
  .tag-purple{ background: rgba(124,58,237,.12); border-color: rgba(124,58,237,.22); color: var(--p); }
  .tag-green{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.22); color:#15803D; }
  .tag-amber{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.28); color:#B45309; }

  .card-body{ padding: 12px; }
  .row{
    display:flex;
    justify-content:space-between;
    gap: 10px;
    padding: 10px 0;
    border-bottom: 1px dashed rgba(203,213,225,.7);
  }
  .row:last-child{ border-bottom:none; }

  .k{
    font-size: 12px;
    color: var(--mut);
    font-weight: 800;
    min-width: 96px;
  }
  .v{
    font-size: 12.5px;
    color: var(--t);
    font-weight: 900;
    text-align:right;
    max-width: 65%;
  }
  .wrap{
    white-space: normal;
    word-break: break-word;
    overflow-wrap: anywhere;
  }

  .card-foot{
    padding: 12px;
    border-top: 1px solid rgba(226,232,240,.9);
    background: rgba(248,250,252,.85);
    display:flex;
    flex-direction:column;
    gap: 8px;
  }

  .note{
    margin:0;
    font-size: 12px;
    color: var(--mut);
    line-height:1.4;
  }

  .msg{
    padding: 10px 12px;
    border-radius: 12px;
    font-size: 12.5px;
    font-weight: 800;
    border: 1px solid transparent;
    line-height:1.35;
  }
  .msg-green{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.22); color:#15803D; }
  .msg-amber{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.28); color:#B45309; }
  .msg-red{ background: rgba(220,38,38,.12); border-color: rgba(220,38,38,.24); color:#B91C1C; }

  .chip{
    padding: 5px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 900;
    border: 1px solid transparent;
    white-space:nowrap;
  }
  .chip-green{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.22); color:#15803D; }
  .chip-amber{ background: rgba(245,158,11,.14); border-color: rgba(245,158,11,.28); color:#B45309; }
  .chip-red{ background: rgba(220,38,38,.12); border-color: rgba(220,38,38,.24); color:#B91C1C; }

  /* Bank snapshot box */
  .snapshot{
    margin-top: 12px;
    padding: 10px;
    border-radius: 14px;
    background: rgba(34,197,94,.08);
    border: 1px solid rgba(34,197,94,.18);
  }
  .snap-title{
    font-size: 12px;
    font-weight: 1000;
    color: #166534;
    margin-bottom: 8px;
    letter-spacing: .2px;
  }
  .snap-grid{
    display:grid;
    gap: 8px;
  }
  @media (min-width: 520px){
    .snap-grid{ grid-template-columns: 1fr 1fr; }
  }
  .snap-item{
    background: rgba(255,255,255,.75);
    border: 1px solid rgba(34,197,94,.14);
    border-radius: 12px;
    padding: 8px;
  }
  .snap-item .k{ min-width: auto; display:block; margin-bottom: 4px; }
  .snap-item .v{ max-width:100%; text-align:left; display:block; }

  /* Privacy & Security */
  .sec{
    margin-top: 14px;
    background: rgba(255,255,255,.9);
    border: 1px solid rgba(124,58,237,.18);
    border-radius: var(--rad);
    padding: 12px;
    box-shadow: var(--sh);
  }
  .sec-head h2{
    margin:0;
    font-size: 15px;
    color: var(--t);
  }
  .sec-head p{
    margin: 6px 0 0;
    font-size: 12.5px;
    color: var(--mut);
    line-height:1.35;
  }

  .sec-grid{
    display:grid;
    gap: 10px;
    margin-top: 12px;
  }
  @media (min-width: 700px){
    .sec-grid{ grid-template-columns: 1fr 1fr; }
  }

  .sec-item{
    display:flex;
    gap: 10px;
    align-items:center;
    text-decoration:none;
    border-radius: 14px;
    padding: 12px;
    border: 1px solid transparent;
    background: #fff;
  }
  .sec-item:hover{ border-color: rgba(124,58,237,.35); }

  .sec-ic{
    width: 44px;
    height: 44px;
    border-radius: 14px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 18px;
    flex-shrink:0;
    border: 1px solid transparent;
  }
  .sec-txt{ min-width:0; flex:1; }
  .sec-txt h3{
    margin:0;
    font-size: 13.5px;
    color: var(--t);
  }
  .sec-txt p{
    margin: 4px 0 0;
    font-size: 12px;
    color: var(--mut);
    line-height: 1.35;
  }
  .sec-go{
    font-size: 22px;
    font-weight: 900;
    color: rgba(124,58,237,.55);
    flex-shrink:0;
  }

  .sec-blue{ border-color: rgba(37,99,235,.18); }
  .sec-blue .sec-ic{ background: rgba(37,99,235,.12); border-color: rgba(37,99,235,.18); }
  .sec-green{ border-color: rgba(34,197,94,.18); }
  .sec-green .sec-ic{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.18); }
  .sec-purple{ border-color: rgba(124,58,237,.18); }
  .sec-purple .sec-ic{ background: rgba(124,58,237,.12); border-color: rgba(124,58,237,.18); }
  .sec-black{ border-color: rgba(15,23,42,.18); }
  .sec-black .sec-ic{ background: rgba(15,23,42,.10); border-color: rgba(15,23,42,.18); }

  /* Danger */
  .danger{
    margin-top: 12px;
    border-radius: 14px;
    border: 1px solid rgba(220,38,38,.22);
    background: rgba(220,38,38,.06);
    padding: 12px;
  }
  .danger-head h3{
    margin:0;
    color:#B91C1C;
    font-size: 14px;
  }
  .danger-head p{
    margin: 6px 0 0;
    color: #7f1d1d;
    font-size: 12px;
    line-height:1.35;
  }
  .danger-actions{
    margin-top: 10px;
    display:flex;
    flex-direction:column;
    gap: 10px;
  }

  /* Small phones (Hisense U50 Lite friendly) */
  @media (max-width: 360px){
    .bp-wrap{ padding: 0 10px; }
    .bp-actions{ flex-direction:column; align-items:stretch; }
    .btn, .badge{ width:100%; }
    .v{ max-width: 100%; }
    .row{ flex-direction:column; align-items:flex-start; }
    .v{ text-align:left; }
  }

  /* Optional: If user has dark theme CSS already, we avoid forcing dark here */
</style>
