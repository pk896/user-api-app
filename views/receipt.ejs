<!-- views/receipt.ejs -->
<%
  var NONCE = (typeof nonce !== 'undefined') ? nonce : (typeof NONCE !== 'undefined' ? NONCE : '');
  var o = order || {};

  // Resolve id across shapes
  var ORDER_ID = String(o.id || o.orderId || o.paypalOrderId || '').trim();

  // Currency + formatter (prefer Intl, fallback to map)
  var C = String(o.currency || (o.amount && o.amount.currency_code) || 'USD').toUpperCase();
  var symMap = { USD:'$', ZAR:'R', EUR:'‚Ç¨', GBP:'¬£' };
  function money(n){
    var v = Number(n || 0);
    try {
      if (typeof Intl !== 'undefined' && Intl.NumberFormat) {
        return new Intl.NumberFormat('en-ZA', { style: 'currency', currency: C, currencyDisplay: 'symbol' }).format(v);
      }
    } catch(_) {}
    return (symMap[C] || (C + ' ')) + v.toFixed(2);
  }

  // --- Normalize items from multiple possible sources ---
  var items = [];
  (function(){
    function norm(it){
      var name = it && it.name ? String(it.name) : 'Item';
      var qty  = Number((it && it.quantity != null) ? it.quantity : 1);
      var unit = (it && it.price && it.price.value != null)               ? Number(it.price.value)
               : (it && it.unitPrice != null)                              ? Number(it.unitPrice)
               : (it && it.unit_amount && it.unit_amount.value != null)    ? Number(it.unit_amount.value)
               : (it && it.price != null)                                  ? Number(it.price)
               : 0;
      return { name: name, qty: qty, unit: unit, line: qty * unit };
    }

    var src = null;
    if (Array.isArray(o.items) && o.items.length) {
      src = o.items;
    } else if (o.purchase_units && Array.isArray(o.purchase_units) && o.purchase_units[0] && Array.isArray(o.purchase_units[0].items)) {
      src = o.purchase_units[0].items;
    } else if (o.raw && o.raw.purchase_units && Array.isArray(o.raw.purchase_units) && o.raw.purchase_units[0] && Array.isArray(o.raw.purchase_units[0].items)) {
      src = o.raw.purchase_units[0].items;
    } else if (o.pp && Array.isArray(o.pp.items) && o.pp.items.length) {
      src = o.pp.items;
    }
    if (src) items = src.map(norm).filter(function(x){ return x && x.name; });
  })();

  // --- Totals (defensive) ---
  var totals = o.totals || {};
  var t_sub = Number((totals.subtotal != null) ? totals.subtotal
                  : (o.breakdown && o.breakdown.itemTotal && o.breakdown.itemTotal.value != null) ? o.breakdown.itemTotal.value
                  : 0);
  var t_tax = Number((totals.tax != null) ? totals.tax
                  : (o.breakdown && o.breakdown.taxTotal && o.breakdown.taxTotal.value != null) ? o.breakdown.taxTotal.value
                  : 0);
  var t_ship = Number((totals.shipping != null) ? totals.shipping
                    : (o.breakdown && o.breakdown.shipping && o.breakdown.shipping.value != null) ? o.breakdown.shipping.value
                    : (o.delivery && o.delivery.amount != null) ? o.delivery.amount
                    : 0);
  var t_tot = Number((totals.total != null) ? totals.total
                   : (o.amount && o.amount.value != null) ? o.amount.value
                   : (t_sub + t_tax + t_ship));

  // --- Johannesburg time formatting ---
  function fmtZA(d){
    try{
      if (!d) return '';
      var dd = (d instanceof Date) ? d : new Date(d);
      return dd.toLocaleString('en-ZA', {
        timeZone: 'Africa/Johannesburg',
        dateStyle: 'medium',
        timeStyle: 'short'
      });
    } catch { return String(d || ''); }
  }
%>

<main class="rcpt-page <%= (themeCss && themeCss.indexOf('dark') !== -1) ? 'dark-theme' : 'light-theme' %>">
  <header class="rcpt-head">
    <div class="rcpt-title">
      <h1>üßæ Order Receipt</h1>
      <p class="muted">Keep this page for your records.</p>
    </div>
    <nav class="btns">
      <a class="btn btn-primary" href="/sales" rel="nofollow">‚Üê Continue shopping</a>
      <button id="btnPrintReceipt" class="btn btn-ghost" type="button">üñ®Ô∏è Print / Save PDF</button>
    </nav>
  </header>

  <section class="card">
    <div class="meta">
      <div><strong>Order:</strong> <span class="wrap"><%= ORDER_ID || '‚Äî' %></span></div>
      <div><strong>Status:</strong> <span><%= o.status || '‚Äî' %></span></div>
      <div><strong>Date:</strong> <span><%= fmtZA(o.createdAt) %></span></div>
    </div>

    <div class="items">
      <% if (!items.length) { %>
        <p class="muted">No line items.</p>
      <% } else { %>
        <% items.forEach(function(it){ %>
          <article class="item">
            <div class="name"><%= it.name %></div>
            <div class="qty">√ó <%= it.qty %> @ <%= money(it.unit) %></div>
            <div class="line"><strong><%= money(it.line) %></strong></div>
          </article>
        <% }); %>
      <% } %>
    </div>

    <div class="totals">
      <div class="row"><span>Subtotal</span><span><%= money(t_sub) %></span></div>
      <div class="row"><span>VAT</span><span><%= money(t_tax) %></span></div>
      <div class="row"><span>Shipping</span><span><%= money(t_ship) %></span></div>
      <div class="row total"><span>Total</span><span><%= money(t_tot) %></span></div>
    </div>

    <% if (o.delivery || o.shipping) { %>
      <div class="ship">
        <h3>Delivery</h3>
        <% if (o.delivery) { %>
          <div><strong>Method:</strong> <%= o.delivery.name || '‚Äî' %></div>
          <div class="muted">
            <%= (o.delivery.deliveryDays != null)
                  ? ('ETA: ' + o.delivery.deliveryDays + ' day' + (Number(o.delivery.deliveryDays) === 1 ? '' : 's'))
                  : '' %>
          </div>
          <% if (o.delivery.amount != null) { %>
            <div class="muted">Delivery price: <%= money(o.delivery.amount) %></div>
          <% } %>
        <% } %>

        <% if (o.shipping) { %>
          <div class="ship-name"><%= o.shipping.name || '' %></div>
          <div class="ship-addr muted">
            <%= [
                  o.shipping.address_line_1,
                  o.shipping.admin_area_2,
                  o.shipping.admin_area_1,
                  o.shipping.postal_code,
                  o.shipping.country_code
                ].filter(function(p){ return !!p; }).join(', ')
            %>
          </div>
        <% } %>
      </div>
    <% } %>
  </section>
</main>

<style nonce="<%= NONCE %>">
  :root{
    --bg:#fff; --text:#111827; --muted:#6b7280; --card:#fff; --border:#e5e7eb;
    --shadow:0 6px 18px rgba(0,0,0,.08); --brand:#111827; --brand-contrast:#fff;
    --radius:12px; --pad:12px;
  }
  .dark-theme{
    --bg:#0b0b0b; --text:#f3f4f6; --muted:#9ca3af; --card:#141414; --border:#262626;
    --brand:#f3f4f6; --brand-contrast:#111;
  }
  html,body{background:var(--bg); color:var(--text); margin:0}
  .rcpt-page{max-width:680px; margin:0 auto; padding:12px}
  .rcpt-head{display:flex; flex-direction:column; gap:10px; margin:4px 0 12px}
  .rcpt-title h1{font-size:clamp(18px,5.5vw,28px); margin:0 0 2px; line-height:1.2}
  .muted{color:var(--muted)}
  .wrap{word-break:break-word}
  .btns{display:flex; flex-wrap:wrap; gap:8px}
  .btn{flex:1 1 100%; text-align:center; border:1px solid var(--brand); border-radius:10px; padding:10px 12px; text-decoration:none; cursor:pointer; font-size:clamp(14px,4.2vw,16px)}
  .btn-primary{background:var(--brand); color:var(--brand-contrast)}
  .btn-ghost{border-color:var(--border); background:transparent; color:var(--text)}
  .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:var(--pad)}
  .meta{display:grid; gap:6px; margin-bottom:10px}
  .items{display:flex; flex-direction:column; gap:8px}
  .item{display:grid; grid-template-columns:1fr auto auto; gap:8px; border-bottom:1px dashed var(--border); padding-bottom:6px}
  .qty{text-align:right; min-width:56px}
  .totals{display:grid; gap:6px; margin-top:.75rem}
  .row{display:flex; justify-content:space-between}
  .row.total{font-weight:900; border-top:1px solid var(--border); padding-top:.5rem}
  .ship{margin-top:12px}
  .ship h3{margin:0 0 6px}
  @media (min-width:420px){ .btn{flex:0 0 auto; min-width:180px} }
  @media print{ .btns{display:none !important} .rcpt-page{max-width:100%; padding:0} body{background:#fff} }
</style>

<script nonce="<%= NONCE %>">
  document.addEventListener('DOMContentLoaded', function(){
    var btn = document.getElementById('btnPrintReceipt');
    if (btn) btn.addEventListener('click', function(){ window.print(); });
  });
</script>
