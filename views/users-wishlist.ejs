<%
// views/users-wishlist.ejs
// Expects locals: title, themeCss, nonce, items, success, error
const list = Array.isArray(items) ? items : [];
%>

<style nonce="<%= nonce %>">
  :root{
    --brand-blue:#2563EB;
    --brand-purple:#7C3AED;
    --brand-green:#22C55E;
    --brand-black:#0F172A;

    --card-border: rgba(15,23,42,.10);
    --muted: rgba(15,23,42,.70);
    --shadow: 0 10px 22px rgba(15,23,42,.06);
  }

  .wl-wrap { max-width: 1100px; margin: 0 auto; padding: 14px 12px 28px; }

  .wl-head{
    background: linear-gradient(135deg, var(--brand-black), var(--brand-purple));
    border-radius: 16px;
    padding: 14px 14px 12px;
    color: #fff;
    box-shadow: 0 10px 26px rgba(15,23,42,.18);
  }
  .wl-title{
    font-size: 18px;
    font-weight: 900;
    margin: 0;
    letter-spacing:.2px;
  }
  .wl-sub{
    margin: 6px 0 0;
    font-size: 13px;
    opacity: .92;
    display:flex;
    align-items:center;
    gap: 8px;
    flex-wrap: wrap;
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 900;
    background: rgba(124,58,237,.12);
    color: var(--brand-purple);
    border: 1px solid rgba(124,58,237,.20);
  }
  .pill-green{
    background: rgba(34,197,94,.14);
    color: var(--brand-green);
    border: 1px solid rgba(34,197,94,.22);
  }
  .pill-blue{
    background: rgba(37,99,235,.12);
    color: var(--brand-blue);
    border: 1px solid rgba(37,99,235,.22);
  }
  .pill-gray{
    background: rgba(15,23,42,.06);
    color: var(--brand-black);
    border: 1px solid rgba(15,23,42,.10);
  }

  .wl-grid{
    margin-top: 12px;
    display:grid;
    grid-template-columns: 1fr;
    gap: 10px;
  }

  .wl-card{
    background:#fff;
    border: 1px solid var(--card-border);
    border-radius: 16px;
    overflow:hidden;
    box-shadow: var(--shadow);
    display:grid;
    grid-template-columns: 92px 1fr;
    gap: 10px;
    padding: 10px;
  }

  .wl-img{
    width: 92px;
    height: 92px;
    border-radius: 14px;
    background: rgba(15,23,42,.06);
    object-fit: cover;
    display:block;
  }

  .wl-name{
    margin: 0;
    font-weight: 900;
    color: var(--brand-black);
    font-size: 14px;
    line-height: 1.25;
  }

  .wl-meta{
    margin: 6px 0 0;
    font-size: 12px;
    color: var(--muted);
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items:center;
  }

  .wl-actions{
    margin-top: 10px;
    display:flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items:center;
  }

  .btn{
    border: 0;
    border-radius: 12px;
    padding: 10px 12px;
    font-weight: 900;
    font-size: 13px;
    cursor: pointer;
    display:inline-flex;
    align-items:center;
    gap: 8px;
    text-decoration: none;
    line-height: 1;
  }
  .btn-view{ background: var(--brand-blue); color:#fff; }
  .btn-remove{ background: rgba(220,38,38,.12); color:#b91c1c; border: 1px solid rgba(220,38,38,.18); }

  .wl-empty{
    margin-top: 12px;
    border-radius: 16px;
    padding: 16px;
    background: rgba(124,58,237,.08);
    border: 1px dashed rgba(124,58,237,.35);
    color: var(--brand-black);
  }
  .wl-empty strong{ display:block; margin-bottom: 6px; }

  .wl-missing{
    background: rgba(15,23,42,.04);
    border: 1px solid rgba(15,23,42,.08);
  }

  @media (min-width: 640px) {
    .wl-grid{ grid-template-columns: 1fr 1fr; }
    .wl-title{ font-size: 20px; }
  }
</style>

<main class="wl-wrap">
  <section class="wl-head">
    <h1 class="wl-title">‚ù§Ô∏è My Wishlist</h1>
    <div class="wl-sub">
      Saved items you can come back to later.
      <span class="pill"><%= list.length %> item(s)</span>
    </div>
  </section>

  <% if (!list.length) { %>
    <section class="wl-empty">
      <strong>Your wishlist is empty.</strong>
      <div style="font-size:13px; opacity:.85;">
        Go to the shop and tap ‚Äú‚ô° Wishlist‚Äù on items you love.
      </div>
      <div style="margin-top:10px;">
        <a class="btn btn-view" href="/sales">üõí Browse products</a>
      </div>
    </section>
  <% } else { %>

    <section class="wl-grid">
      <% list.forEach((it) => { %>
        <% const p = it && it.product ? it.product : null; %>

        <%
// robust image fallback
const imgSrc =
  p && (p.imageUrl || p.image || p.img || p.image_key || p.imageKey)
    ? (p.imageUrl || p.image || p.img || p.image_key || p.imageKey)
    : '/img/placeholder.png';

// label id for display + actions
const actionId =
  p && (p.customId || p._id)
    ? String(p.customId || p._id)
    : (it && it.productId ? String(it.productId) : '');

// product name fallback
const name =
  p && (p.name || p.title)
    ? String(p.name || p.title)
    : 'Product not available';
        %>

        <article class="wl-card <%= p ? '' : 'wl-missing' %>">
          <div>
            <img class="wl-img" src="<%= imgSrc %>" alt="product">
          </div>

          <div>
            <h3 class="wl-name"><%= name %></h3>

            <div class="wl-meta">
              <% if (p && p.customId) { %>
                <span class="pill pill-blue">ID: <%= p.customId %></span>
              <% } else if (p && p._id) { %>
                <span class="pill pill-gray">Saved</span>
              <% } else { %>
                <span class="pill pill-green">Saved</span>
              <% } %>

              <% if (it && it.addedAt) { %>
                <span class="pill pill-gray">
                  Added: <%= new Date(it.addedAt).toLocaleDateString() %>
                </span>
              <% } %>
            </div>

            <div class="wl-actions">
              <% if (p && p.customId) { %>
                <a class="btn btn-view" href="/products/view/<%= p.customId %>">üëÄ View</a>
              <% } else { %>
                <a class="btn btn-view" href="/sales">üõí Back to shop</a>
              <% } %>

              <form method="POST" action="/users/wishlist/remove/<%= actionId %>">
                <button class="btn btn-remove" type="submit">üóëÔ∏è Remove</button>
              </form>
            </div>
          </div>
        </article>
      <% }) %>
    </section>

  <% } %>
</main>
