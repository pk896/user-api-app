<!-- views/admin-payouts.ejs -->
<%
  const NONCE = typeof nonce !== 'undefined' ? nonce : (typeof NONCE !== 'undefined' ? NONCE : '');
  const payoutList = Array.isArray(payouts) ? payouts : [];
  const KPIS = (typeof kpis === 'object' && kpis) ? kpis : {};
  const preview = Array.isArray(previewSellers) ? previewSellers : [];

  function esc(s) {
    return String(s ?? '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function money(cents) {
    const n = Math.round(Number(cents || 0));
    return (n / 100).toFixed(2);
  }

  function badgeClass(status) {
    const v = String(status || '').trim().toUpperCase();
    if (v === 'COMPLETED' || v === 'SUCCESS') return 'ap-badge ap-badge-green';
    if (v === 'FAILED' || v === 'DENIED') return 'ap-badge ap-badge-red';
    return 'ap-badge ap-badge-purple';
  }

  function yesNoPill(ok, yesText, noText) {
    return ok
      ? ('<span class="ap-pill ap-pill-ok">' + esc(yesText || 'YES') + '</span>')
      : ('<span class="ap-pill ap-pill-bad">' + esc(noText || 'NO') + '</span>');
  }

  // ‚úÖ local mask helper (so we never leak raw PayPal emails in UI)
  function maskEmailLocal(email = '') {
    const [name, domain] = String(email || '').split('@');
    if (!name || !domain) return String(email || '');
    const maskedName =
      name.length <= 2
        ? name[0] + '*'
        : name[0] + '*'.repeat(Math.max(1, name.length - 2)) + name[name.length - 1];

    const parts = domain.split('.');
    const domName = parts[0] || '';
    const domExt = parts.slice(1).join('.') || '';

    const maskedDomain =
      domName.length <= 2
        ? (domName[0] || '*') + '*'
        : domName[0] + '*'.repeat(Math.max(1, domName.length - 2)) + domName[domName.length - 1];

    return `${maskedName}@${maskedDomain}${domExt ? '.' + domExt : ''}`;
  }

  const previewCurrency = String(KPIS.previewCurrency || 'USD').toUpperCase();

  const totalBatches = (typeof KPIS.totalBatches !== 'undefined') ? KPIS.totalBatches : payoutList.length;
  const totalPaidOut = KPIS.totalPaidOut ? KPIS.totalPaidOut : '‚Äî';
  const lastStatus   = KPIS.lastStatus ? KPIS.lastStatus : (payoutList[0] && payoutList[0].status ? payoutList[0].status : '‚Äî');

  const eligibleSellers = (KPIS.eligibleSellers ?? 0);
  const eligibleTotal   = (KPIS.eligibleTotal ?? '0.00');
%>

<section class="ap-page">
  <div class="ap-wrap">

    <!-- Compact Hero (Purple dominant) -->
    <div class="ap-hero">
      <div class="ap-hero-left">
        <div class="ap-hero-ic" aria-hidden="true">üí∏</div>
        <div class="ap-hero-text">
          <div class="ap-hero-title">Seller Payouts</div>
          <div class="ap-hero-sub">
            Preview balances, create PayPal payout batches, then sync to update statuses. Failed items auto-credit back (idempotent).
          </div>
        </div>
      </div>

      <div class="ap-hero-right">
        <span class="ap-chip"><span class="dot dot-p"></span> Purple <b>#7C3AED</b></span>
        <span class="ap-chip"><span class="dot dot-b"></span> Blue <b>#2563EB</b></span>
        <span class="ap-chip"><span class="dot dot-g"></span> Green <b>#22C55E</b></span>
        <span class="ap-chip"><span class="dot dot-k"></span> Black <b>#0F172A</b></span>
      </div>
    </div>

    <!-- ‚úÖ IMPORTANT: You said flash-messages are already in layout.ejs
         So we REMOVE local flash blocks to avoid duplicates. -->

    <!-- KPI Row (color blocks visible) -->
    <div class="ap-kpis">
      <div class="ap-kpi ap-kpi-purple">
        <div class="ap-kpi-l">Total Batches</div>
        <div class="ap-kpi-v"><%= esc(String(totalBatches)) %></div>
      </div>

      <div class="ap-kpi ap-kpi-blue">
        <div class="ap-kpi-l">Total Paid Out</div>
        <div class="ap-kpi-v"><%= esc(String(totalPaidOut)) %></div>
        <div class="ap-kpi-h">All-time (best-effort)</div>
      </div>

      <div class="ap-kpi ap-kpi-green">
        <div class="ap-kpi-l">Last Batch Status</div>
        <div class="ap-kpi-v"><%= esc(String(lastStatus)) %></div>
      </div>
    </div>

    <!-- Preview Sellers -->
    <div class="ap-card ap-card-purple">
      <div class="ap-card-h ap-row">
        <div>
          <h2 class="ap-h2">Seller payout preview</h2>
          <p class="ap-sub">
            Currency: <b><%= esc(previewCurrency) %></b>. Shows each seller‚Äôs available balance (only computed for enabled + PayPal-ready sellers).
          </p>
        </div>

        <div class="ap-mini-kpis">
          <div class="ap-mini">
            <div class="ap-mini-l">Eligible sellers</div>
            <div class="ap-mini-v"><%= esc(String(eligibleSellers)) %></div>
          </div>
          <div class="ap-mini">
            <div class="ap-mini-l">Eligible total</div>
            <div class="ap-mini-v"><%= esc(String(eligibleTotal)) %> <span class="ap-mini-cur"><%= esc(previewCurrency) %></span></div>
          </div>
        </div>
      </div>

      <!-- Desktop/tablet: table scrolls. Mobile: becomes cards (CSS below). -->
      <div class="ap-table-wrap ap-table-preview">
        <table class="ap-table">
          <thead>
            <tr>
              <th>Seller</th>
              <th>Payouts enabled</th>
              <th>PayPal email</th>
              <th>Available</th>
              <th>Eligible now</th>
            </tr>
          </thead>
          <tbody>
            <% if (!preview.length) { %>
              <tr><td colspan="5" class="ap-muted ap-center">No sellers found.</td></tr>
            <% } else { %>
              <% preview.forEach(function(s){ %>
                <tr>
                  <td>
                    <div class="ap-strong"><%= esc(s.name || '‚Äî') %></div>
                    <div class="ap-subline">businessId: <%= esc(s.businessId) %></div>
                  </td>

                  <td><%- yesNoPill(!!s.enabled, 'ENABLED', 'DISABLED') %></td>

                  <td>
                    <% if (s.hasPaypal) { %>
                      <span class="ap-pill"><%= esc(s.paypalEmailMasked || maskEmailLocal(s.paypalEmail || '')) %></span>
                    <% } else { %>
                      <span class="ap-pill ap-pill-bad">NOT SET</span>
                    <% } %>
                  </td>

                  <td>
                    <div class="ap-strong">
                      <%= money(s.availableCents) %> <span class="ap-subline-inline"><%= esc(previewCurrency) %></span>
                    </div>
                    <div class="ap-subline">cents: <%= Number(s.availableCents||0) %></div>
                  </td>

                  <td>
                    <% if (s.eligible) { %>
                      <span class="ap-badge ap-badge-green">YES</span>
                    <% } else { %>
                      <span class="ap-badge ap-badge-slate">NO</span>
                    <% } %>
                  </td>
                </tr>
              <% }) %>
            <% } %>
          </tbody>
        </table>
      </div>

      <div class="ap-note">
        Note: ‚ÄúEligible now‚Äù means payouts enabled + PayPal email set + available balance &gt; 0 in <b><%= esc(previewCurrency) %></b>.
        The ‚ÄúMinimum payout‚Äù in the Create form below filters further.
      </div>
    </div>

    <!-- Create payout + Sync recent (‚úÖ NOT NESTED FORMS) -->
    <div class="ap-card ap-card-blue">
      <div class="ap-card-h">
        <h2 class="ap-h2">Auto pay sellers now</h2>
        <p class="ap-sub">
          Pays all eligible sellers (role=seller, payouts enabled, PayPal email set). Creates PayPal batch + local <code>Payout</code> doc + debits ledger (idempotent).
        </p>
      </div>

      <div class="ap-split">
        <!-- ‚úÖ Create payout form -->
        <form class="ap-form" method="POST" action="/admin/payouts/create" autocomplete="off">
          <div class="ap-grid">
            <!-- ‚úÖ Use dropdown where important -->
            <div class="ap-field">
              <label for="currency" class="ap-lbl">Currency</label>
              <select id="currency" name="currency">
                <option value="<%= esc(previewCurrency) %>" selected><%= esc(previewCurrency) %> (recommended)</option>
                <option value="USD">USD</option>
                <option value="ZAR">ZAR</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
              </select>
              <div class="ap-hint">Keep it consistent with your ledger currency.</div>
            </div>

            <div class="ap-field">
              <label for="minCents" class="ap-lbl">Minimum payout (cents)</label>
              <input
                id="minCents"
                name="minCents"
                placeholder="0 (example: 5000 = 50.00)"
                inputmode="numeric"
                value="0"
                autocomplete="off"
              />
              <div class="ap-hint">Only sellers with available ‚â• minCents will be paid.</div>
            </div>

            <div class="ap-field ap-full">
              <label for="note" class="ap-lbl">Note</label>
              <input
                id="note"
                name="note"
                placeholder="Seller payout (for internal records)"
                value="Seller payout"
                autocomplete="off"
              />
            </div>

            <div class="ap-field ap-full">
              <label class="ap-check">
                <input type="checkbox" name="autoSync" value="1" checked />
                <span>Auto-sync immediately after create (best-effort)</span>
              </label>
              <div class="ap-hint">Updates item statuses quickly. You can still sync later from history.</div>
            </div>

            <div class="ap-actions ap-full">
              <button class="ap-btn ap-btn-primary" type="submit">Auto Pay Now</button>
              <div class="ap-mini-note">
                Creates PayPal payout batch and debits each seller with <code>PAYOUT_DEBIT</code>. Failed payout items are auto-credited on sync.
              </div>
            </div>
          </div>
        </form>

        <!-- ‚úÖ Sync recent form (separate, not nested) -->
        <form method="POST" action="/admin/payouts/sync-recent" class="ap-sync" autocomplete="off">
          <input type="hidden" name="limit" value="10" />
          <button class="ap-btn ap-btn-ghost" type="submit">Sync Recent Batches</button>
          <div class="ap-hint">Syncs the most recent batches (best-effort). You can also sync per batch below.</div>
        </form>
      </div>
    </div>

    <!-- Payout history -->
    <div class="ap-card ap-card-green">
      <div class="ap-card-h ap-row">
        <div>
          <h2 class="ap-h2">Payout history</h2>
          <p class="ap-sub">Sync any batch to refresh item statuses (SENT / FAILED / PENDING). Failed items auto-credit back (idempotent).</p>
        </div>

        <div class="ap-legend">
          <span class="ap-badge ap-badge-green">COMPLETED</span>
          <span class="ap-badge ap-badge-purple">PROCESSING</span>
          <span class="ap-badge ap-badge-red">FAILED</span>
        </div>
      </div>

      <% if (!payoutList.length) { %>
        <div class="ap-empty">
          <div class="ap-empty-ic">üì≠</div>
          <div class="ap-empty-t">No payout batches yet</div>
          <div class="ap-empty-s">Use ‚ÄúAuto Pay Now‚Äù above.</div>
        </div>
      <% } else { %>

        <div class="ap-table-wrap ap-table-history">
          <table class="ap-table ap-table-wide">
            <thead>
              <tr>
                <th>Created</th>
                <th>Mode</th>
                <th>Status</th>
                <th>Currency</th>
                <th>Total</th>
                <th>Batch IDs</th>
                <th>Items</th>
                <th class="ap-right">Actions</th>
              </tr>
            </thead>

            <tbody>
              <% payoutList.forEach(function(p){
                const items = Array.isArray(p.items) ? p.items : [];
                const sent = items.filter(i => String(i.status||'').toUpperCase()==='SENT').length;
                const failed = items.filter(i => String(i.status||'').toUpperCase()==='FAILED').length;
                const pending = items.filter(i => String(i.status||'').toUpperCase()==='PENDING').length;
              %>
                <tr>
                  <td>
                    <div class="ap-strong"><%= p.createdAt ? new Date(p.createdAt).toLocaleString() : '‚Äî' %></div>
                    <div class="ap-subline">Admin payouts</div>
                  </td>

                  <td><span class="ap-pill"><%= esc(p.mode || 'SANDBOX') %></span></td>

                  <td><span class="<%= badgeClass(p.status) %>"><%= esc(p.status || '‚Äî') %></span></td>

                  <td><%= esc(p.currency || 'USD') %></td>

                  <td>
                    <div class="ap-strong"><%= money(p.totalCents) %></div>
                    <div class="ap-subline">cents: <%= Number(p.totalCents||0) %></div>
                  </td>

                  <td>
                    <div class="ap-subline">
                      <div><b>batchId:</b> <%= esc(p.batchId || '‚Äî') %></div>
                      <div><b>senderBatchId:</b> <%= esc(p.senderBatchId || '‚Äî') %></div>
                    </div>
                  </td>

                  <td>
                    <div class="ap-stack">
                      <span class="ap-mini ap-mini-ok">SENT: <b><%= sent %></b></span>
                      <span class="ap-mini ap-mini-warn">PENDING: <b><%= pending %></b></span>
                      <span class="ap-mini ap-mini-err">FAILED: <b><%= failed %></b></span>
                    </div>
                  </td>

                  <td class="ap-right">
                    <form method="POST" action="/admin/payouts/<%= esc(p._id) %>/sync" class="ap-inline">
                      <button class="ap-btn ap-btn-ghost" type="submit">Sync</button>
                    </form>
                  </td>
                </tr>

                <!-- items -->
                <tr class="ap-subrow">
                  <td colspan="8">
                    <div class="ap-items">
                      <div class="ap-items-head">
                        <div>
                          <div class="ap-items-title">Items (<%= items.length %>)</div>
                          <div class="ap-items-sub">Each seller receiver and status after sync (emails masked).</div>
                        </div>
                      </div>

                      <% if (!items.length) { %>
                        <div class="ap-items-empty">No items for this payout batch.</div>
                      <% } else { %>
                        <div class="ap-items-grid">
                          <% items.forEach(function(it){
                            const st = String(it.status||'PENDING').toUpperCase();
                            const receiverRaw = String(it.receiver || '').trim();
                            const receiverMasked = receiverRaw ? maskEmailLocal(receiverRaw) : '‚Äî';
                          %>
                            <div class="ap-item">
                              <div class="ap-item-top">
                                <span class="ap-pill"><%= esc(it.currency || p.currency || 'USD') %></span>
                                <span class="ap-badge <%= st==='SENT' ? 'ap-badge-green' : (st==='FAILED' ? 'ap-badge-red' : 'ap-badge-slate') %>"><%= esc(st) %></span>
                              </div>

                              <div class="ap-item-main">
                                <div class="ap-item-amt"><%= money(it.amountCents) %></div>
                                <div class="ap-item-rec"><%= esc(receiverMasked) %></div>
                                <div class="ap-subline">businessId: <%= esc(it.businessId) %></div>
                              </div>

                              <% if (it.error) { %>
                                <div class="ap-item-err">Error: <%= esc(it.error) %></div>
                              <% } %>

                              <div class="ap-subline ap-tiny">
                                paypalItemId: <%= esc(it.paypalItemId || '‚Äî') %>
                              </div>
                            </div>
                          <% }) %>
                        </div>
                      <% } %>
                    </div>
                  </td>
                </tr>

              <% }) %>
            </tbody>
          </table>
        </div>

      <% } %>
    </div>

  </div>
</section>

<%
  // ‚úÖ Use layout "styles" slot if available (like your orders page).
  // If not available, it still renders safely in-page.
  styles = `
<style nonce="${NONCE}">
  /* ===== Brand palette (Purple dominant) ===== */
  .ap-page{
    --b:#2563EB;
    --p:#7C3AED;
    --g:#22C55E;
    --k:#0F172A;
    --bg:#f8fafc;
    --mut:#64748B;
    --line:rgba(15,23,42,.10);
    --shadow:0 12px 26px rgba(15,23,42,.10);
    padding: .75rem 0;
    background:
      radial-gradient(900px 420px at 50% -10%, rgba(124,58,237,.22) 0%, rgba(37,99,235,.08) 55%, rgba(34,197,94,.06) 100%),
      linear-gradient(180deg, var(--bg), var(--bg));
  }
  .ap-wrap{max-width:1100px;margin:0 auto;padding:0 .8rem}

  /* ===== Hero ===== */
  .ap-hero{
    border-radius:18px;
    padding:.9rem;
    color:#fff;
    background: linear-gradient(135deg, rgba(124,58,237,1), rgba(37,99,235,1));
    box-shadow: var(--shadow);
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:.8rem;
    border:1px solid rgba(255,255,255,.18);
  }
  .ap-hero-left{display:flex;gap:.75rem;align-items:flex-start}
  .ap-hero-ic{
    width:44px;height:44px;border-radius:14px;
    display:grid;place-items:center;
    background: rgba(255,255,255,.16);
    border:1px solid rgba(255,255,255,.22);
    font-size:20px;
    flex:0 0 auto;
  }
  .ap-hero-title{font-weight:950;font-size:1.05rem;letter-spacing:.2px}
  .ap-hero-sub{margin-top:.35rem;font-size:.86rem;color:rgba(255,255,255,.92);max-width:640px;font-weight:700}
  .ap-hero-right{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:flex-end}
  .ap-chip{
    display:inline-flex;align-items:center;gap:.45rem;
    padding:.35rem .55rem;border-radius:999px;
    background: rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.20);
    font-size:.78rem;font-weight:850;white-space:nowrap;
  }
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .dot-p{background:var(--p)} .dot-b{background:var(--b)} .dot-g{background:var(--g)} .dot-k{background:var(--k)}

  /* ===== KPI row ===== */
  .ap-kpis{
    margin:.75rem 0 .8rem;
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:.6rem;
  }
  .ap-kpi{
    background:#fff;
    border:1px solid var(--line);
    border-radius:18px;
    padding:.75rem;
    box-shadow: 0 10px 18px rgba(15,23,42,.06);
    position:relative;
    overflow:hidden;
  }
  .ap-kpi:before{content:"";position:absolute;inset:0 0 auto 0;height:6px;background: rgba(124,58,237,.35);}
  .ap-kpi-purple:before{ background: rgba(124,58,237,.7); }
  .ap-kpi-blue:before{ background: rgba(37,99,235,.7); }
  .ap-kpi-green:before{ background: rgba(34,197,94,.7); }
  .ap-kpi-l{font-size:.82rem;color:#475569;font-weight:850}
  .ap-kpi-v{margin-top:.35rem;font-size:1.15rem;font-weight:950;color:var(--k)}
  .ap-kpi-h{margin-top:.15rem;font-size:.75rem;color:var(--mut);font-weight:750}

  /* ===== Cards ===== */
  .ap-card{
    background:#fff;
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow: var(--shadow);
    margin-top:.75rem;
    overflow:hidden;
  }
  .ap-card-h{
    padding:.8rem .85rem;
    border-bottom:1px solid rgba(15,23,42,.08);
  }
  .ap-card-purple .ap-card-h{ background: rgba(124,58,237,.09); }
  .ap-card-blue .ap-card-h{ background: rgba(37,99,235,.08); }
  .ap-card-green .ap-card-h{ background: rgba(34,197,94,.08); }

  .ap-row{display:flex;align-items:flex-start;justify-content:space-between;gap:.8rem}
  .ap-h2{margin:0;font-size:1rem;font-weight:950;color:var(--k)}
  .ap-sub{margin:.35rem 0 0;color:#475569;font-size:.86rem;font-weight:750}
  .ap-note{padding:.7rem .85rem;color:var(--mut);font-size:.78rem;font-weight:750}

  /* Mini KPIs */
  .ap-mini-kpis{display:flex;gap:.6rem;flex-wrap:wrap;justify-content:flex-end}
  .ap-mini{
    min-width:150px;
    background: rgba(15,23,42,.02);
    border:1px solid rgba(15,23,42,.10);
    border-radius:16px;
    padding:.65rem .7rem;
  }
  .ap-mini-l{font-size:.75rem;color:var(--mut);font-weight:800}
  .ap-mini-v{margin-top:.25rem;font-size:1rem;font-weight:950;color:var(--k)}
  .ap-mini-cur{font-size:.75rem;color:var(--mut);font-weight:850;margin-left:.35rem}

  /* ===== Forms ===== */
  .ap-split{
    padding:.85rem;
    display:grid;
    grid-template-columns: 1fr;
    gap:.75rem;
  }
  .ap-grid{
    display:grid;
    grid-template-columns: repeat(2, 1fr);
    gap:.75rem;
    align-items:end;
  }
  .ap-full{grid-column:1/-1}
  .ap-lbl{display:block;margin:0 0 .35rem;color:var(--k);font-size:.82rem;font-weight:950}

  input, select{
    width:100%;
    padding:.7rem .75rem;
    border-radius:16px;
    border:1px solid rgba(15,23,42,.14);
    outline:none;
    font-size:.9rem;
    font-weight:800;
    background:#fff;
    color:var(--k);
  }
  input::placeholder{color:rgba(100,116,139,.9);font-weight:750}
  input:focus, select:focus{
    border-color: rgba(124,58,237,.55);
    box-shadow: 0 0 0 4px rgba(124,58,237,.14);
  }
  .ap-hint{margin-top:.35rem;color:var(--mut);font-size:.78rem;font-weight:750}

  .ap-check{display:flex;gap:.55rem;align-items:center}
  .ap-check input{width:auto}

  .ap-actions{
    display:flex;gap:.65rem;align-items:center;flex-wrap:wrap;
    margin-top:.1rem;
  }
  .ap-mini-note{font-size:.78rem;color:var(--mut);font-weight:750}

  .ap-btn{
    border-radius:16px;
    padding:.65rem .75rem;
    font-weight:950;
    border:1px solid rgba(15,23,42,.12);
    background:#fff;
    color:var(--k);
    cursor:pointer;
    transition: transform .12s ease, filter .12s ease;
    user-select:none;
    white-space:nowrap;
    -webkit-tap-highlight-color: transparent;
  }
  .ap-btn:hover{transform: translateY(-1px)}
  .ap-btn-primary{
    background: linear-gradient(135deg, var(--p), var(--b));
    border-color: transparent;
    color:#fff;
    box-shadow: 0 12px 22px rgba(124,58,237,.18);
  }
  .ap-btn-ghost{background:#fff}

  .ap-sync{
    border:1px dashed rgba(37,99,235,.25);
    background: rgba(37,99,235,.05);
    border-radius:18px;
    padding:.75rem;
    display:flex;
    flex-direction:column;
    gap:.45rem;
  }

  /* ===== Tables (desktop/tablet: scroll) ===== */
  .ap-table-wrap{
    overflow:auto;
    border-top:1px solid rgba(15,23,42,.06);
  }
  .ap-table{
    width:100%;
    border-collapse:separate;
    border-spacing:0;
    background:#fff;
    min-width: 920px;
  }
  .ap-table-wide{min-width: 1040px;}
  th, td{
    padding:.65rem .65rem;
    border-bottom:1px solid rgba(15,23,42,.06);
    vertical-align:top;
    text-align:left;
    font-size:.86rem;
  }
  th{
    background: rgba(124,58,237,.07);
    color: var(--k);
    font-weight:950;
    position: sticky;
    top: 0;
    z-index: 1;
  }
  .ap-right{text-align:right}
  .ap-center{text-align:center}
  .ap-strong{font-weight:950;color:var(--k)}
  .ap-subline{margin-top:.18rem;font-size:.75rem;color:var(--mut);font-weight:750}
  .ap-subline-inline{font-size:.75rem;color:var(--mut);font-weight:900;margin-left:.35rem}
  .ap-muted{color:var(--mut);font-weight:750}

  /* Pills + Badges */
  .ap-pill{
    display:inline-flex;align-items:center;
    padding:.38rem .6rem;border-radius:999px;
    border:1px solid rgba(15,23,42,.10);
    background:#fff;font-size:.75rem;font-weight:850;color:var(--k);
  }
  .ap-pill-ok{border-color:rgba(34,197,94,.25);background:rgba(34,197,94,.08)}
  .ap-pill-bad{border-color:rgba(239,68,68,.22);background:rgba(239,68,68,.08);color:#7f1d1d}

  .ap-badge{
    display:inline-flex;align-items:center;
    padding:.34rem .55rem;border-radius:999px;
    font-size:.75rem;font-weight:950;border:1px solid transparent;
    color:var(--k);
    background:#fff;
  }
  .ap-badge-green{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.25)}
  .ap-badge-purple{background:rgba(124,58,237,.12);border-color:rgba(124,58,237,.25)}
  .ap-badge-red{background:rgba(239,68,68,.10);border-color:rgba(239,68,68,.25)}
  .ap-badge-slate{background:rgba(71,85,105,.10);border-color:rgba(71,85,105,.18)}

  /* Subrow + items */
  .ap-subrow td{background: rgba(15,23,42,.02)}
  .ap-items{padding:.8rem}
  .ap-items-head{display:flex;align-items:flex-end;justify-content:space-between;gap:.6rem;margin-bottom:.6rem}
  .ap-items-title{font-weight:950;color:var(--k)}
  .ap-items-sub{font-size:.75rem;color:var(--mut);font-weight:750}
  .ap-items-empty{color:var(--mut);font-weight:750;font-size:.85rem;padding:.35rem 0}

  .ap-items-grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:.6rem;
  }
  .ap-item{
    background:#fff;
    border:1px solid rgba(15,23,42,.08);
    border-radius:18px;
    padding:.7rem;
    box-shadow: 0 10px 18px rgba(15,23,42,.06);
  }
  .ap-item-top{display:flex;justify-content:space-between;align-items:center;gap:.5rem;margin-bottom:.55rem}
  .ap-item-amt{font-size:1.05rem;font-weight:950;color:var(--k)}
  .ap-item-rec{font-size:.86rem;color:var(--k);font-weight:850;margin-top:.15rem}
  .ap-item-err{
    margin-top:.55rem;
    font-size:.78rem;
    color:#b91c1c;
    background: rgba(239,68,68,.08);
    border:1px solid rgba(239,68,68,.18);
    padding:.55rem .6rem;
    border-radius:14px;
    font-weight:800;
  }
  .ap-tiny{font-size:.72rem}

  .ap-legend{display:flex;gap:.45rem;flex-wrap:wrap;justify-content:flex-end}
  .ap-stack{display:flex;flex-direction:column;gap:.4rem}
  .ap-mini{
    font-size:.75rem;
    color:var(--k);
    border:1px solid rgba(15,23,42,.10);
    background:#fff;
    border-radius:14px;
    padding:.35rem .5rem;
    font-weight:850;
  }
  .ap-mini-ok{border-color:rgba(34,197,94,.25);background:rgba(34,197,94,.08)}
  .ap-mini-warn{border-color:rgba(124,58,237,.25);background:rgba(124,58,237,.08)}
  .ap-mini-err{border-color:rgba(239,68,68,.25);background:rgba(239,68,68,.07)}

  .ap-empty{padding:1rem;text-align:center;color:#475569}
  .ap-empty-ic{font-size:1.35rem}
  .ap-empty-t{margin-top:.35rem;font-weight:950;color:var(--k)}
  .ap-empty-s{margin-top:.2rem;font-size:.85rem;font-weight:750;color:var(--mut)}

  .ap-inline{display:inline}
  code{
    font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    font-size:.78rem;
  }

  /* ===== Mobile-first (Hisense-friendly) ===== */
  @media (max-width: 820px){
    .ap-hero{flex-direction:column}
    .ap-kpis{grid-template-columns:1fr}
    .ap-grid{grid-template-columns:1fr}
    .ap-items-grid{grid-template-columns:1fr}
    .ap-row{flex-direction:column;align-items:flex-start}
    .ap-mini-kpis{justify-content:flex-start}
    .ap-legend{justify-content:flex-start}
  }

  /* ‚úÖ PHONE MODE: Turn the TABLE into stacked cards (like your orders page) */
  @media (max-width: 780px){
    .ap-table{min-width: 0 !important; width:100%;}
    .ap-table-wide{min-width: 0 !important;}

    .ap-table-wrap{overflow: visible;}
    .ap-table thead{display:none;}
    .ap-table tbody{display:block;}

    /* base row card */
    .ap-table tbody tr{
      display:block;
      margin: 10px;
      border: 1px solid rgba(124,58,237,.18);
      border-radius: 16px;
      padding: 10px;
      background:#fff;
      box-shadow: 0 10px 22px rgba(15,23,42,.06);
    }

    /* normal rows (cells become labeled lines) */
    .ap-table tbody tr td{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px dashed rgba(15,23,42,.10);
    }
    .ap-table tbody tr td:last-child{border-bottom:none;}

    /* default label styles */
    .ap-table tbody tr td::before{
      flex: 0 0 auto;
      color: var(--mut);
      font-weight: 950;
    }
    .ap-table tbody tr td > *{text-align:right;}

    /* -------- Preview table labels (5 cols) -------- */
    .ap-table-preview .ap-table tbody tr td:nth-child(1)::before{content:"Seller";}
    .ap-table-preview .ap-table tbody tr td:nth-child(2)::before{content:"Payouts";}
    .ap-table-preview .ap-table tbody tr td:nth-child(3)::before{content:"PayPal";}
    .ap-table-preview .ap-table tbody tr td:nth-child(4)::before{content:"Available";}
    .ap-table-preview .ap-table tbody tr td:nth-child(5)::before{content:"Eligible";}

    /* -------- History table labels (8 cols) -------- */
    .ap-table-history .ap-table tbody tr td:nth-child(1)::before{content:"Created";}
    .ap-table-history .ap-table tbody tr td:nth-child(2)::before{content:"Mode";}
    .ap-table-history .ap-table tbody tr td:nth-child(3)::before{content:"Status";}
    .ap-table-history .ap-table tbody tr td:nth-child(4)::before{content:"Currency";}
    .ap-table-history .ap-table tbody tr td:nth-child(5)::before{content:"Total";}
    .ap-table-history .ap-table tbody tr td:nth-child(6)::before{content:"Batch IDs";}
    .ap-table-history .ap-table tbody tr td:nth-child(7)::before{content:"Items";}
    .ap-table-history .ap-table tbody tr td:nth-child(8)::before{content:"Actions";}

    /* subrow (items row) ‚Äì show it as a full-width block, no labels */
    .ap-subrow td{
      display:block !important;
      padding: 0 !important;
      border-bottom: none !important;
    }
    .ap-subrow td::before{content:"" !important; display:none !important;}

    /* align action area nicely */
    .ap-right{text-align:left;}
    .ap-inline{display:block;}
    .ap-inline .ap-btn{width:100%;}
  }
</style>
`;
%>
