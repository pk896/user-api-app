<!-- views/order-list.ejs -->
<%
  // ‚úÖ FIX: avoid "Cannot access 'nonce' before initialization"
  const NONCE = (typeof nonce !== 'undefined' && nonce) ? String(nonce) : '';
%>

<main class="orders-list-page">
  <!-- Header Section -->
  <header class="page-header" aria-label="Order history header">
    <div class="header-content">
      <div class="header-main">
        <div class="title-row">
          <h1 class="page-title">
            <span class="title-icon" aria-hidden="true">üì¶</span>
            Order History
          </h1>
          <p class="subtitle">View and manage your recent orders</p>
        </div>

        <div class="order-stats" role="list" aria-label="Order statistics">
          <div class="stat-item stat-total" role="listitem">
            <span class="stat-icon" aria-hidden="true">üìä</span>
            <span class="stat-label">Total Orders</span>
            <span class="stat-value" id="total-orders">‚Äî</span>
          </div>
          <div class="stat-item stat-active" role="listitem">
            <span class="stat-icon" aria-hidden="true">‚è≥</span>
            <span class="stat-label">Active</span>
            <span class="stat-value" id="active-orders">‚Äî</span>
          </div>
          <div class="stat-item stat-completed" role="listitem">
            <span class="stat-icon" aria-hidden="true">‚úÖ</span>
            <span class="stat-label">Completed</span>
            <span class="stat-value" id="completed-orders">‚Äî</span>
          </div>
        </div>
      </div>

      <div class="header-actions">
        <a href="/sales" class="btn btn-primary btn-with-icon">
          <span class="btn-icon" aria-hidden="true">‚Üê</span>
          Continue Shopping
        </a>

        <div class="view-toggle" role="group" aria-label="Change view">
          <button class="view-btn active" data-view="grid" aria-label="Grid view" type="button">
            <span class="view-icon" aria-hidden="true">‚¨ú</span>
          </button>
          <button class="view-btn" data-view="list" aria-label="List view" type="button">
            <span class="view-icon" aria-hidden="true">‚ò∞</span>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <section class="main-content" aria-label="Orders content">
    <!-- Notifications -->
    <div class="notifications-container" id="notifications" aria-live="polite">
      <% if (success && success.length > 0) { %>
        <div class="notification notification-success" role="status">
          <span class="notification-icon" aria-hidden="true">‚úì</span>
          <span class="notification-text"><%= success %></span>
          <button class="notification-close" type="button" aria-label="Close notification">&times;</button>
        </div>
      <% } %>
      <% if (error && error.length > 0) { %>
        <div class="notification notification-error" role="alert">
          <span class="notification-icon" aria-hidden="true">!</span>
          <span class="notification-text"><%= error %></span>
          <button class="notification-close" type="button" aria-label="Close notification">&times;</button>
        </div>
      <% } %>
    </div>

    <!-- Orders Container -->
    <section class="orders-container" aria-label="Orders list">
      <div class="orders-header">
        <div class="orders-header-left">
          <h2 class="orders-title">Recent Orders</h2>
          <p class="orders-hint" id="ordersHint">
            Search by <strong>Order ID</strong>, <strong>Status</strong>, or <strong>Item name</strong>.
          </p>
        </div>

        <div class="orders-controls">
          <div class="search-box">
            <label class="sr-only" for="order-search">Search orders</label>
            <input
              type="text"
              id="order-search"
              placeholder="Search orders‚Ä¶ (e.g. 8AR41122 or chair)"
              class="search-input"
              aria-describedby="ordersHint"
              autocomplete="off"
              inputmode="search"
            />
            <span class="search-icon" aria-hidden="true">üîç</span>
            <button id="clear-search" class="clear-search" type="button" aria-label="Clear search" title="Clear">
              ‚úï
            </button>
          </div>

          <div class="sort-wrap">
            <label class="sr-only" for="sort-orders">Sort orders</label>
            <select class="sort-select" id="sort-orders" aria-label="Sort orders by">
              <option value="newest">Newest First</option>
              <option value="oldest">Oldest First</option>
              <option value="amount-high">Amount (High to Low)</option>
              <option value="amount-low">Amount (Low to High)</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Orders Grid/List -->
      <div id="ordersWrap" class="orders-view grid-view" aria-live="polite">
        <div class="loading-state" role="status" aria-label="Loading orders">
          <div class="loading-spinner" aria-hidden="true"></div>
          <p>Loading your orders‚Ä¶</p>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="empty-state" style="display:none;">
        <div class="empty-content">
          <span class="empty-icon" aria-hidden="true">üì¶</span>
          <h3>No Orders Found</h3>
          <p>You haven't placed any orders yet, or your search returned no results.</p>
          <a href="/sales" class="btn btn-primary">Browse Products</a>
        </div>
      </div>

      <!-- Loading More -->
      <div id="loading-more" class="loading-more" style="display:none;">
        <div class="loading-spinner" aria-hidden="true"></div>
        <span>Loading more orders‚Ä¶</span>
      </div>
    </section>

    <!-- Quick Actions -->
    <section class="quick-actions" aria-label="Quick actions">
      <div class="action-card qa-purple">
        <div class="action-icon" aria-hidden="true">üì±</div>
        <div class="action-content">
          <h4>Mobile Friendly</h4>
          <p>Compact layout with easy tap targets.</p>
        </div>
      </div>

      <div class="action-card qa-blue">
        <div class="action-icon" aria-hidden="true">üöö</div>
        <div class="action-content">
          <h4>Track Shipments</h4>
          <p>Monitor delivery status in one click.</p>
        </div>
      </div>

      <div class="action-card qa-green">
        <div class="action-icon" aria-hidden="true">üìÑ</div>
        <div class="action-content">
          <h4>Download Receipts</h4>
          <p>Save or print invoices anytime.</p>
        </div>
      </div>
    </section>

    <!-- Footer Panel (inside page content) -->
    <section class="page-footer" aria-label="Order help and links">
      <div class="footer-content">
        <div class="footer-section fs-purple">
          <h4>Need Help?</h4>
          <a href="/contact" class="footer-link">Contact Support</a>
          <a href="/help/returns" class="footer-link">Returns & Refunds</a>
          <a href="/help/shipping" class="footer-link">Shipping Info</a>
        </div>

        <div class="footer-section fs-blue">
          <h4>Quick Links</h4>
          <button class="footer-action" type="button" onclick="window.print()">
            <span class="action-icon" aria-hidden="true">üñ®Ô∏è</span>
            Print Order History
          </button>
          <a href="/cart" class="footer-action">
            <span class="action-icon" aria-hidden="true">üõí</span>
            View Cart
          </a>
          <a href="/account" class="footer-action">
            <span class="action-icon" aria-hidden="true">üë§</span>
            My Account
          </a>
        </div>

        <div class="footer-section fs-green">
          <h4>Order Status Guide</h4>
          <div class="status-guide">
            <div class="status-item">
              <span class="status-dot processing" aria-hidden="true"></span>
              <span>Processing ‚Äî order confirmed</span>
            </div>
            <div class="status-item">
              <span class="status-dot shipped" aria-hidden="true"></span>
              <span>Shipped ‚Äî on its way</span>
            </div>
            <div class="status-item">
              <span class="status-dot delivered" aria-hidden="true"></span>
              <span>Delivered ‚Äî received</span>
            </div>
          </div>
        </div>
      </div>
    </section>
  </section>
</main>

<!-- ‚úÖ FIX: correct nonce attribute + correct quote closing -->
<style<% if (NONCE) { %> nonce="<%= NONCE %>"<% } %>>
  /* =========================================================
     Phakisi / Unicoporate Brand Tokens (Purple dominant)
     Scoped to .orders-list-page ONLY (won't touch layout/nav/footer)
     ========================================================= */
  .orders-list-page{
    --blue:#2563EB;
    --purple:#7C3AED;      /* dominant */
    --green:#22C55E;
    --black:#0F172A;

    --bg0:#070A13;
    --bg1:#0B1022;
    --muted:#94A3B8;
    --line:rgba(148,163,184,.18);
    --w:#FFFFFF;

    --shadow: 0 10px 22px rgba(2,6,23,.35);
    --shadow2: 0 6px 16px rgba(2,6,23,.28);

    --r-lg:18px;
    --r-md:14px;
    --r-sm:10px;

    padding: .85rem;
    min-height: 100vh;

    background:
      radial-gradient(900px 420px at 20% -10%, rgba(124,58,237,.38), transparent 58%),
      radial-gradient(900px 420px at 95% 0%, rgba(37,99,235,.28), transparent 55%),
      radial-gradient(900px 420px at 70% 105%, rgba(34,197,94,.18), transparent 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
    color: var(--w);
  }

  .sr-only{
    position:absolute !important;
    width:1px;height:1px;
    padding:0;margin:-1px;
    overflow:hidden;clip:rect(0,0,0,0);
    white-space:nowrap;border:0;
  }

  /* Header */
  .page-header{
    background: linear-gradient(180deg, rgba(124,58,237,.18), rgba(15,23,42,.92));
    border: 1px solid rgba(124,58,237,.20);
    border-radius: var(--r-lg);
    padding: 1rem;
    box-shadow: var(--shadow);
  }

  .header-content{
    display:flex;
    gap:1rem;
    justify-content:space-between;
    align-items:flex-start;
    flex-wrap:wrap;
  }

  .header-main{ flex:1; min-width: 260px; }
  .title-row{ display:flex; flex-direction:column; gap:.35rem; }

  .page-title{
    margin:0;
    display:flex;
    gap:.6rem;
    align-items:center;
    font-weight:900;
    font-size:1.35rem;
    letter-spacing:.2px;
    color: var(--w);
  }

  .title-icon{ font-size:1.35rem; filter: drop-shadow(0 6px 10px rgba(124,58,237,.25)); }

  .subtitle{
    margin:0;
    color: rgba(226,232,240,.86);
    font-size:.92rem;
    line-height:1.25;
  }

  .order-stats{
    margin-top:.85rem;
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:.6rem;
  }

  .stat-item{
    border-radius: var(--r-md);
    padding:.75rem .75rem;
    border:1px solid var(--line);
    background: rgba(15,23,42,.55);
    display:flex;
    flex-direction:column;
    gap:.2rem;
    position:relative;
    overflow:hidden;
  }

  .stat-item::before{
    content:"";
    position:absolute; inset:0;
    background: radial-gradient(250px 90px at 20% 0%, rgba(124,58,237,.22), transparent 60%);
    pointer-events:none;
  }

  .stat-total{ border-color: rgba(124,58,237,.22); }
  .stat-active{ border-color: rgba(37,99,235,.22); }
  .stat-completed{ border-color: rgba(34,197,94,.22); }

  .stat-icon{ font-size:1rem; opacity:.95; }
  .stat-label{
    font-size:.70rem;
    text-transform:uppercase;
    letter-spacing:.12em;
    color: rgba(148,163,184,.95);
  }
  .stat-value{
    font-size:1.12rem;
    font-weight:900;
    color: var(--w);
  }

  .header-actions{
    display:flex;
    gap:.6rem;
    align-items:flex-end;
    flex-direction:column;
  }

  .view-toggle{
    display:flex;
    gap:.35rem;
    background: rgba(2,6,23,.35);
    border: 1px solid var(--line);
    padding:.25rem;
    border-radius: 999px;
  }

  .view-btn{
    border:0;
    background: transparent;
    color: rgba(226,232,240,.75);
    padding:.5rem .6rem;
    border-radius: 999px;
    cursor:pointer;
    transition: transform .12s ease, background .12s ease, color .12s ease;
  }
  .view-btn:hover{ transform: translateY(-1px); }
  .view-btn.active{
    background: rgba(124,58,237,.22);
    color: var(--w);
    border: 1px solid rgba(124,58,237,.28);
    box-shadow: 0 8px 18px rgba(124,58,237,.18);
  }

  /* Main content */
  .main-content{
    display:flex;
    flex-direction:column;
    gap:1rem;
    margin-top:1rem;
  }

  /* Notifications */
  .notifications-container{ display:flex; flex-direction:column; gap:.5rem; }
  .notification{
    display:flex;
    gap:.65rem;
    align-items:center;
    padding:.75rem .85rem;
    border-radius: var(--r-md);
    border:1px solid var(--line);
    background: rgba(15,23,42,.72);
    box-shadow: var(--shadow2);
  }

  .notification-success{
    border-color: rgba(34,197,94,.25);
    background: linear-gradient(180deg, rgba(34,197,94,.12), rgba(15,23,42,.75));
  }
  .notification-error{
    border-color: rgba(239,68,68,.25);
    background: linear-gradient(180deg, rgba(239,68,68,.12), rgba(15,23,42,.75));
  }

  .notification-icon{ font-weight:900; }
  .notification-text{ font-size:.92rem; color: rgba(226,232,240,.95); }
  .notification-close{
    margin-left:auto;
    border:0;
    background: transparent;
    color: rgba(226,232,240,.85);
    font-size:1.2rem;
    cursor:pointer;
    opacity:.85;
  }
  .notification-close:hover{ opacity:1; }

  /* Orders container */
  .orders-container{
    background: linear-gradient(180deg, rgba(17,26,46,.92), rgba(15,23,42,.92));
    border: 1px solid rgba(37,99,235,.16);
    border-radius: var(--r-lg);
    padding: 1rem;
    box-shadow: var(--shadow);
  }

  .orders-header{
    display:flex;
    flex-wrap:wrap;
    gap:.85rem;
    justify-content:space-between;
    align-items:flex-start;
    margin-bottom:.85rem;
  }

  .orders-title{
    margin:0;
    font-size:1.05rem;
    font-weight:900;
    color: var(--w);
  }

  .orders-hint{
    margin:.35rem 0 0 0;
    color: rgba(148,163,184,.95);
    font-size:.82rem;
    line-height:1.2;
  }

  .orders-controls{
    display:flex;
    flex-wrap:wrap;
    gap:.6rem;
    align-items:center;
  }

  .search-box{
    position:relative;
    min-width: 240px;
    flex: 1;
  }

  .search-input{
    width:100%;
    padding:.65rem 2.6rem .65rem 2.4rem;
    border-radius: 999px;
    border: 1px solid rgba(124,58,237,.28);
    background: rgba(2,6,23,.35);
    color: rgba(226,232,240,.95);
    font-size:.92rem;
    outline:none;
  }
  .search-input::placeholder{ color: rgba(148,163,184,.85); }
  .search-input:focus{
    border-color: rgba(124,58,237,.55);
    box-shadow: 0 0 0 3px rgba(124,58,237,.18);
  }

  .search-icon{
    position:absolute;
    left:.85rem;
    top:50%;
    transform: translateY(-50%);
    opacity:.9;
    pointer-events:none;
  }

  .clear-search{
    position:absolute;
    right:.55rem;
    top:50%;
    transform: translateY(-50%);
    border:0;
    cursor:pointer;
    width: 32px; height: 32px;
    border-radius: 999px;
    background: rgba(148,163,184,.12);
    color: rgba(226,232,240,.88);
    display:none;
  }
  .clear-search:hover{ background: rgba(124,58,237,.22); }

  .sort-wrap{ min-width: 170px; }
  .sort-select{
    width:100%;
    appearance:none;
    border-radius: 999px;
    border: 1px solid rgba(37,99,235,.28);
    background: rgba(2,6,23,.35);
    color: rgba(226,232,240,.95);
    padding:.65rem 2.2rem .65rem 1rem;
    font-size:.92rem;
    cursor:pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23CBD5E1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right .85rem center;
    background-size: 1rem;
    outline:none;
  }
  .sort-select:focus{
    border-color: rgba(37,99,235,.55);
    box-shadow: 0 0 0 3px rgba(37,99,235,.18);
  }

  /* Orders view */
  .orders-view.grid-view{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap:.75rem;
  }
  .orders-view.list-view{
    display:flex;
    flex-direction:column;
    gap:.6rem;
  }

  /* Loading */
  .loading-state{
    grid-column: 1 / -1;
    display:flex;
    flex-direction:column;
    gap:.75rem;
    align-items:center;
    justify-content:center;
    padding: 2.2rem 1rem;
    color: rgba(148,163,184,.95);
  }
  .loading-spinner{
    width: 38px;
    height: 38px;
    border-radius: 50%;
    border: 3px solid rgba(148,163,184,.18);
    border-top-color: rgba(124,58,237,.85);
    animation: spin 1s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  /* Empty state */
  .empty-state{
    padding: 2.4rem 1rem;
    text-align:center;
  }
  .empty-content{
    display:flex;
    flex-direction:column;
    gap:.75rem;
    align-items:center;
    color: rgba(148,163,184,.95);
  }
  .empty-icon{ font-size: 2.6rem; opacity:.85; }

  /* Quick actions */
  .quick-actions{
    display:grid;
    grid-template-columns: 1fr;
    gap:.75rem;
  }
  .action-card{
    border-radius: var(--r-lg);
    border: 1px solid var(--line);
    padding: .9rem;
    display:flex;
    gap:.75rem;
    align-items:center;
    background: rgba(15,23,42,.72);
    box-shadow: var(--shadow2);
  }
  .qa-purple{ border-color: rgba(124,58,237,.25); }
  .qa-blue{ border-color: rgba(37,99,235,.25); }
  .qa-green{ border-color: rgba(34,197,94,.25); }

  .action-icon{
    width: 44px; height: 44px;
    display:flex; align-items:center; justify-content:center;
    border-radius: 14px;
    background: rgba(2,6,23,.35);
    border: 1px solid var(--line);
    font-size: 1.2rem;
  }

  .action-content h4{
    margin:0;
    color: rgba(226,232,240,.96);
    font-size: .92rem;
    font-weight: 950;
  }
  .action-content p{
    margin:.15rem 0 0 0;
    color: rgba(148,163,184,.95);
    font-size: .82rem;
  }

  /* Footer panel */
  .page-footer{
    background: rgba(15,23,42,.72);
    border: 1px solid var(--line);
    border-radius: var(--r-lg);
    padding: 1rem;
    box-shadow: var(--shadow2);
  }
  .footer-content{
    display:grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }
  .footer-section{
    padding:.85rem;
    border-radius: var(--r-md);
    border: 1px solid var(--line);
    background: rgba(2,6,23,.25);
  }
  .fs-purple{ border-color: rgba(124,58,237,.25); }
  .fs-blue{ border-color: rgba(37,99,235,.25); }
  .fs-green{ border-color: rgba(34,197,94,.25); }

  .footer-section h4{
    margin:0 0 .6rem 0;
    font-size:.80rem;
    font-weight: 950;
    letter-spacing:.10em;
    text-transform:uppercase;
    color: rgba(226,232,240,.95);
  }

  .footer-link{
    display:block;
    padding:.45rem 0;
    text-decoration:none;
    color: rgba(148,163,184,.98);
    font-size:.90rem;
  }
  .footer-link:hover{ color: rgba(226,232,240,.96); }

  .footer-action{
    width:100%;
    text-align:left;
    display:flex;
    gap:.55rem;
    align-items:center;
    padding:.45rem 0;
    border:0;
    background: transparent;
    color: rgba(148,163,184,.98);
    cursor:pointer;
    font-size:.90rem;
    text-decoration:none;
  }
  .footer-action:hover{ color: rgba(226,232,240,.96); }

  .status-guide{ display:flex; flex-direction:column; gap:.45rem; }
  .status-item{ display:flex; gap:.55rem; align-items:center; color: rgba(148,163,184,.98); font-size:.90rem; }
  .status-dot{ width: 9px; height: 9px; border-radius: 50%; }
  .status-dot.processing{ background:#F59E0B; }
  .status-dot.shipped{ background: var(--blue); }
  .status-dot.delivered{ background: var(--green); }

  /* Buttons */
  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.45rem;
    padding:.65rem 1rem;
    border-radius: 999px;
    border:1px solid transparent;
    text-decoration:none;
    cursor:pointer;
    font-weight:800;
    font-size:.92rem;
    transition: transform .12s ease, filter .12s ease;
    user-select:none;
  }
  .btn-primary{
    background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(37,99,235,.9));
    border-color: rgba(124,58,237,.35);
    color: var(--w);
    box-shadow: 0 12px 22px rgba(124,58,237,.18);
  }
  .btn-primary:hover{ transform: translateY(-1px); filter: brightness(1.03); }

  /* Responsive */
  @media (min-width: 520px){
    .quick-actions{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .footer-content{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
  }
  @media (max-width: 520px){
    .orders-list-page{ padding:.7rem; }
    .order-stats{ grid-template-columns: 1fr; }
    .orders-controls{ width:100%; }
    .search-box, .sort-wrap{ width:100%; min-width: 0; }
    .header-actions{ width:100%; align-items:stretch; }
    .btn{ width:100%; }
    .orders-view.grid-view{ grid-template-columns: 1fr; }
  }
  @media (prefers-reduced-motion: reduce){
    *{ transition:none !important; animation:none !important; }
  }
</style>

<script<% if (NONCE) { %> nonce="<%= NONCE %>"<% } %>>
  (function () {
    const ordersWrap = document.getElementById('ordersWrap');
    const emptyState = document.getElementById('empty-state');
    const orderSearch = document.getElementById('order-search');
    const clearBtn = document.getElementById('clear-search');
    const sortSelect = document.getElementById('sort-orders');
    const viewBtns = document.querySelectorAll('.view-btn');
    const statTotal = document.getElementById('total-orders');
    const statActive = document.getElementById('active-orders');
    const statCompleted = document.getElementById('completed-orders');

    let allOrders = [];
    let filteredOrders = [];
    let currentView = 'grid';
    let currentSearch = '';
    let currentSort = 'newest';

    function formatCurrency(amount, currency = 'ZAR') {
      const symbols = { USD: '$', ZAR: 'R', EUR: '‚Ç¨', GBP: '¬£' };
      const c = String(currency || 'ZAR').toUpperCase();
      const symbol = symbols[c] || (c + ' ');
      const n = Number(amount || 0);
      return symbol + (Number.isFinite(n) ? n.toFixed(2) : '0.00');
    }

    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-ZA', { day: 'numeric', month: 'short', year: 'numeric' });
      } catch {
        return '‚Äî';
      }
    }

    function getStatusClass(status) {
      if (!status) return 'processing';
      status = String(status).toLowerCase();
      if (status.includes('shipped') || status.includes('transit')) return 'shipped';
      if (status.includes('delivered') || status.includes('completed')) return 'delivered';
      if (status.includes('cancelled') || status.includes('refunded')) return 'cancelled';
      return 'processing';
    }

    function getStatusIcon(status) {
      if (!status) return '‚è≥';
      status = String(status).toLowerCase();
      if (status.includes('shipped') || status.includes('transit')) return 'üöö';
      if (status.includes('delivered') || status.includes('completed')) return '‚úÖ';
      if (status.includes('cancelled') || status.includes('refunded')) return '‚ùå';
      return '‚è≥';
    }

    function normalizeItemsText(order) {
      const items = Array.isArray(order.items) ? order.items : [];
      const parts = [];
      for (const it of items) {
        const name = (it && (it.name || it.title || it.productName)) ? String(it.name || it.title || it.productName) : '';
        if (name) parts.push(name);
      }
      return parts.join(' ').toLowerCase();
    }

    function setupNotifications() {
      document.querySelectorAll('.notification-close').forEach((button) => {
        button.addEventListener('click', (e) => {
          const notification = e.target.closest('.notification');
          if (!notification) return;
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 200);
        });
      });

      setTimeout(() => {
        document.querySelectorAll('.notification-success').forEach((notification) => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 200);
        });
      }, 5000);
    }

    function createOrderCard(order) {
      const orderId = (order.orderId || order.id || order.paypalOrderId || '').toString().trim();
      const shortId = orderId.slice(-8) || '‚Äî';
      const date = formatDate(order.createdAt);
      const amount = formatCurrency(order.amount, order.currency);
      const status = order.status || 'Processing';
      const statusClass = getStatusClass(status);
      const statusIcon = getStatusIcon(status);

      // ‚úÖ DO NOT CHANGE PATHS/LINKS
      const receiptHref = `/payment/receipt/${encodeURIComponent(orderId)}`;
      const trackHref = `/payment/orders/${encodeURIComponent(orderId)}/track`;

      const itemCount = Array.isArray(order.items) ? order.items.length : 0;
      const itemsText = itemCount === 1 ? '1 item' : `${itemCount} items`;

      return `
        <div class="order-card ${statusClass}">
          <div class="order-header">
            <div class="order-id">Order #${shortId}</div>
            <span class="order-status ${statusClass}">${statusIcon} ${status}</span>
          </div>

          <div class="order-meta">
            <div class="order-date">${date}</div>
            ${itemCount > 0 ? '<div class="order-items">üßæ ' + itemsText + '</div>' : ''}
          </div>

          <div class="order-right">
            <div class="order-amount">${amount}</div>
            <div class="order-actions">
              <a href="${receiptHref}" class="action-btn receipt" title="View receipt">üìÑ Receipt</a>
              <a href="${trackHref}" class="action-btn track" title="Track shipment">üöö Track</a>
            </div>
          </div>
        </div>
      `;
    }

    async function loadOrders() {
      ordersWrap.innerHTML = `
        <div class="loading-state" role="status" aria-label="Loading orders">
          <div class="loading-spinner" aria-hidden="true"></div>
          <p>Loading your orders‚Ä¶</p>
        </div>
      `;

      emptyState.style.display = 'none';

      try {
        const response = await fetch('/payment/my-orders', {
          credentials: 'same-origin',
          headers: { 'Cache-Control': 'no-cache' }
        });

        if (!response.ok) throw new Error('Failed to load orders');

        const data = await response.json();
        if (!data.ok) throw new Error(data.error || 'Invalid response');

        allOrders = data.orders || [];
        updateOrderStats();
        applyFiltersAndSort();
      } catch (error) {
        console.error('Error loading orders:', error);
        ordersWrap.innerHTML = `
          <div class="empty-state">
            <div class="empty-content">
              <span class="empty-icon" aria-hidden="true">‚ö†Ô∏è</span>
              <h3>Unable to Load Orders</h3>
              <p>Please try again later.</p>
              <button type="button" onclick="window.location.reload()" class="btn btn-primary">Retry</button>
            </div>
          </div>
        `;
      }
    }

    function updateOrderStats() {
      const total = allOrders.length;

      const active = allOrders.filter((o) => {
        const s = (o.status || '').toLowerCase();
        return !s.includes('delivered') && !s.includes('completed') && !s.includes('cancelled') && !s.includes('refunded');
      }).length;

      const completed = allOrders.filter((o) => {
        const s = (o.status || '').toLowerCase();
        return s.includes('delivered') || s.includes('completed');
      }).length;

      statTotal.textContent = total;
      statActive.textContent = active;
      statCompleted.textContent = completed;
    }

    function applyFiltersAndSort() {
      let filtered = [...allOrders];

      if (currentSearch) {
        const term = currentSearch.toLowerCase();
        filtered = filtered.filter((order) => {
          const orderId = (order.orderId || order.id || '').toString().toLowerCase();
          const status = (order.status || '').toLowerCase();
          const itemsText = normalizeItemsText(order);
          return orderId.includes(term) || status.includes(term) || itemsText.includes(term);
        });
      }

      filtered.sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        const amountA = parseFloat(a.amount || 0);
        const amountB = parseFloat(b.amount || 0);

        switch (currentSort) {
          case 'newest': return dateB - dateA;
          case 'oldest': return dateA - dateB;
          case 'amount-high': return amountB - amountA;
          case 'amount-low': return amountA - amountB;
          default: return dateB - dateA;
        }
      });

      filteredOrders = filtered;
      renderOrders();
    }

    function renderOrders() {
      if (filteredOrders.length === 0) {
        ordersWrap.innerHTML = '';
        emptyState.style.display = 'block';
        return;
      }

      ordersWrap.className = `orders-view ${currentView}-view`;
      ordersWrap.innerHTML = filteredOrders.map(createOrderCard).join('');
      emptyState.style.display = 'none';
    }

    function setupEventListeners() {
      viewBtns.forEach((btn) => {
        btn.addEventListener('click', () => {
          viewBtns.forEach((b) => b.classList.remove('active'));
          btn.classList.add('active');
          currentView = btn.dataset.view;
          renderOrders();
        });
      });

      let searchTimeout;
      orderSearch.addEventListener('input', (e) => {
        const v = String(e.target.value || '');
        clearBtn.style.display = v.trim().length ? 'inline-flex' : 'none';

        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
          currentSearch = v.trim().toLowerCase();
          applyFiltersAndSort();
        }, 250);
      });

      clearBtn.addEventListener('click', () => {
        orderSearch.value = '';
        clearBtn.style.display = 'none';
        currentSearch = '';
        applyFiltersAndSort();
        orderSearch.focus();
      });

      sortSelect.addEventListener('change', (e) => {
        currentSort = e.target.value;
        applyFiltersAndSort();
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupNotifications();
      setupEventListeners();
      loadOrders();
    });

    window.orderListApp = { loadOrders, applyFiltersAndSort, renderOrders };
  })();
</script>
