<!-- views/order-list.ejs -->
<% const NONCE = typeof nonce !== 'undefined' ? nonce : ''; %>

<!-- Flash -->
<% if (success && success.length > 0) { %>
  <div class="flash flash-success">‚úÖ <%= success %></div>
<% } %>
<% if (error && error.length > 0) { %>
  <div class="flash flash-error">‚ùå <%= error %></div>
<% } %>

<main class="orders-page <%= themeCss && themeCss.includes('dark') ? 'dark-theme' : 'light-theme' %>">
  <header class="orders-head">
    <div>
      <h1>üßæ My Orders</h1>
      <p class="muted">View your recent orders and receipts.</p>
    </div>
    <a href="/sales" class="btn-back" aria-label="Continue shopping">‚Üê Continue shopping</a>
  </header>

  <section class="card" aria-live="polite" aria-busy="true">
    <div id="ordersWrap">
      <p class="muted">Loading orders‚Ä¶</p>
    </div>
  </section>
</main>

<style nonce="<%= NONCE %>">
  :root{
    --bg:#fff; --text:#111827; --muted:#6b7280; --card:#fff; --border:#e5e7eb;
    --shadow:0 6px 18px rgba(0,0,0,.08); --brand:#111827; --brand-contrast:#fff;
    --radius:12px; --pad:12px; --chip:#f3f4f6;
  }
  .dark-theme{
    --bg:#0b0b0b; --text:#f3f4f6; --muted:#9ca3af; --card:#141414; --border:#262626;
    --brand:#f3f4f6; --brand-contrast:#111; --chip:#1f2937;
  }

  html,body{background:var(--bg); color:var(--text); margin:0}
  .orders-page{max-width:680px; margin:0 auto; padding:12px}

  .orders-head{
    display:flex; align-items:flex-start; justify-content:space-between; gap:10px; margin:4px 0 12px;
  }
  .orders-head h1{font-size:clamp(18px,5.5vw,28px); margin:0 0 2px; line-height:1.2}
  .muted{color:var(--muted)}
  .btn-back{
    display:inline-block; padding:10px 12px; border-radius:10px; text-decoration:none;
    border:1px solid var(--brand); color:var(--brand); background:transparent;
    font-size:clamp(14px,4.2vw,16px)
  }

  .card{background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); padding:var(--pad)}
  #ordersWrap{display:flex; flex-direction:column; gap:8px}

  .row{
    display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center;
    border:1px solid var(--border); border-radius:10px; padding:10px; background:var(--chip);
  }
  .main{display:flex; flex-direction:column; gap:4px}
  .oid{font-weight:700; font-size:clamp(14px,4.5vw,16px); word-break:break-all}
  .sub{font-size:clamp(13px,4vw,15px); color:var(--muted)}
  .right{display:flex; flex-direction:column; align-items:flex-end; gap:6px}
  .amt{font-weight:800; font-size:clamp(14px,4.6vw,16px)}
  .link{display:inline-block; text-decoration:none; border:1px solid var(--border); padding:8px 10px; border-radius:10px}

  .flash{margin:.6rem 0; padding:.6rem .8rem; border-radius:10px; font-size:clamp(14px,4.2vw,16px)}
  .flash-success{background:#ecfdf5; color:#065f46; border:1px solid #34d399}
  .flash-error{background:#fef2f2; color:#991b1b; border:1px solid #fca5a5}
</style>

<script nonce="<%= NONCE %>">
(function(){
  function qs(s, c){ return (c||document).querySelector(s); }
  function fmtZA(d){
    try{
      if (!d) return '';
      var dd = (d instanceof Date) ? d : new Date(d);
      return dd.toLocaleString('en-ZA', { timeZone:'Africa/Johannesburg', dateStyle:'medium', timeStyle:'short' });
    } catch(_) { return String(d || ''); }
  }
  function money(n, cur){
    var C = (cur || 'USD').toUpperCase();
    try{
      if (typeof Intl !== 'undefined' && Intl.NumberFormat) {
        return new Intl.NumberFormat('en-ZA', { style:'currency', currency:C, currencyDisplay:'symbol' }).format(Number(n||0));
      }
    }catch(_){}
    var sym = { USD:'$', ZAR:'R', EUR:'‚Ç¨', GBP:'¬£' }[C] || (C + ' ');
    return sym + Number(n||0).toFixed(2);
  }

  document.addEventListener('DOMContentLoaded', function(){
    var wrap = qs('#ordersWrap');
    var host = wrap && wrap.closest('.card');
    if (host) host.setAttribute('aria-busy','true');

    fetch('/payment/my-orders', { credentials:'same-origin' })
      .then(function(r){ return r.json().catch(function(){ return {}; }).then(function(j){ return {ok:r.ok, j:j}; }); })
      .then(function(res){
        if (host) host.removeAttribute('aria-busy');
        if (!res.ok || !res.j || !res.j.ok) throw new Error('Load failed');
        var orders = res.j.orders || [];
        if (!orders.length){
          wrap.innerHTML = '<p class="muted">No recent orders found.</p>';
          return;
        }
        var html = orders.map(function(o){
          var id  = String(o.orderId || o.id || o.paypalOrderId || '').trim();
          var dt  = o.createdAt ? fmtZA(o.createdAt) : '';
          var amt = (o.amount != null && o.currency) ? money(o.amount, o.currency) : '';
          var href = '/payment/receipt/' + encodeURIComponent(id);
          return ''+
            '<article class="row" role="article">'+
              '<div class="main">'+
                '<div class="oid">'+(id || '‚Äî')+'</div>'+
                '<div class="sub">'+(o.status || '‚Äî')+(dt ? ' ‚Ä¢ '+dt : '')+'</div>'+
              '</div>'+
              '<div class="right">'+
                (amt ? '<div class="amt">'+amt+'</div>' : '')+
                '<a class="link" href="'+href+'" aria-label="Open receipt for order '+(id || '')+'">Open</a>'+
              '</div>'+
            '</article>';
        }).join('');
        wrap.innerHTML = html;
      })
      .catch(function(err){
        if (host) host.removeAttribute('aria-busy');
        console.error(err);
        wrap.innerHTML = '<p class="muted">Could not load orders. Please try again later.</p>';
      });
  });
})();
</script>
