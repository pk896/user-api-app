<!-- views/orders.ejs -->
<%
  const NONCE = typeof nonce !== 'undefined' ? nonce : '';
%>

<main class="orders-page">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="user-greeting">
        <h1 class="page-title">Order History</h1>
        <div class="subtitle-container">
          <p class="subtitle">Track your purchases and shipments</p>
          <div class="order-summary">
            <span class="summary-item">
              <span class="summary-icon">üì¶</span>
              <span class="summary-value" id="total-orders">‚Äî</span>
              <span class="summary-label">Total</span>
            </span>
            <span class="summary-item">
              <span class="summary-icon">‚úÖ</span>
              <span class="summary-value" id="completed-orders">‚Äî</span>
              <span class="summary-label">Completed</span>
            </span>
            <span class="summary-item">
              <span class="summary-icon">üöö</span>
              <span class="summary-value" id="shipped-orders">‚Äî</span>
              <span class="summary-label">Shipped</span>
            </span>
          </div>
        </div>
      </div>

      <div class="header-actions">
        <a href="/sales" class="btn btn-primary btn-with-icon">
          <span class="btn-icon">‚Üê</span>
          Continue Shopping
        </a>
        <button class="btn btn-outline" id="filter-toggle" type="button">
          <span class="btn-icon">üîç</span>
          Filter
        </button>
      </div>
    </div>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel" id="filter-panel">
    <div class="filter-content">
      <div class="filter-group">
        <h4 class="filter-title">Order Status</h4>
        <div class="filter-options">
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" value="all" checked>
            <span class="filter-label">All Orders</span>
            <span class="filter-count" id="count-all">‚Äî</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" value="pending">
            <span class="filter-label">‚è≥ Pending</span>
            <span class="filter-count" id="count-pending">‚Äî</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" value="shipped">
            <span class="filter-label">üöö Shipped</span>
            <span class="filter-count" id="count-shipped">‚Äî</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" value="delivered">
            <span class="filter-label">‚úÖ Delivered</span>
            <span class="filter-count" id="count-delivered">‚Äî</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" value="cancelled">
            <span class="filter-label">‚ùå Cancelled / Refunded</span>
            <span class="filter-count" id="count-cancelled">‚Äî</span>
          </label>
        </div>
      </div>

      <div class="filter-group">
        <h4 class="filter-title">Time Range</h4>
        <div class="filter-options time-range">
          <label class="filter-option">
            <input type="radio" name="time-range" class="filter-radio" value="all" checked>
            <span class="filter-label">All Time</span>
          </label>
          <label class="filter-option">
            <input type="radio" name="time-range" class="filter-radio" value="30">
            <span class="filter-label">Last 30 Days</span>
          </label>
          <label class="filter-option">
            <input type="radio" name="time-range" class="filter-radio" value="90">
            <span class="filter-label">Last 90 Days</span>
          </label>
        </div>
      </div>

      <div class="filter-actions">
        <button class="btn btn-sm btn-outline" id="clear-filters" type="button">Clear Filters</button>
        <button class="btn btn-sm btn-primary" id="apply-filters" type="button">Apply</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Notifications -->
    <div class="notifications-container" id="notifications">
      <% if (success && success.length > 0) { %>
        <div class="notification notification-success">
          <span class="notification-icon">‚úì</span>
          <span class="notification-text"><%= success %></span>
          <button class="notification-close" type="button">&times;</button>
        </div>
      <% } %>
      <% if (error && error.length > 0) { %>
        <div class="notification notification-error">
          <span class="notification-icon">!</span>
          <span class="notification-text"><%= error %></span>
          <button class="notification-close" type="button">&times;</button>
        </div>
      <% } %>
    </div>

    <!-- Orders Container -->
    <div class="orders-container">
      <div class="orders-header">
        <h2 class="orders-title">Recent Orders</h2>
        <div class="sort-control">
          <select class="sort-select" id="sort-orders">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="amount-high">Amount (High to Low)</option>
            <option value="amount-low">Amount (Low to High)</option>
          </select>
        </div>
      </div>

      <!-- Orders List -->
      <div id="ordersList" class="orders-grid">
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>Loading your orders‚Ä¶</p>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="empty-state" style="display: none;">
        <div class="empty-content">
          <span class="empty-icon">üì¶</span>
          <h3>No Orders Found</h3>
          <p>You haven't placed any orders yet, or no orders match your filters.</p>
          <a href="/sales" class="btn btn-primary">Start Shopping</a>
        </div>
      </div>

      <!-- Load More placeholder (kept for future) -->
      <div class="load-more-container">
        <button id="load-more" class="btn btn-outline" style="display: none;" type="button">
          Load More Orders
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="page-footer">
    <div class="footer-content">
      <div class="footer-section">
        <h4>Need Help?</h4>
        <a href="/contact" class="footer-link">Contact Support</a>
        <a href="/help/orders" class="footer-link">Order Help Center</a>
        <a href="/help/shipping" class="footer-link">Shipping Information</a>
      </div>

      <div class="footer-section">
        <h4>Quick Actions</h4>
        <button class="footer-action" type="button" onclick="window.print()">
          <span class="action-icon">üñ®Ô∏è</span>
          Print Order History
        </button>
        <button class="footer-action" id="export-orders" type="button">
          <span class="action-icon">üìä</span>
          Export as CSV
        </button>
        <a href="/cart" class="footer-action">
          <span class="action-icon">üõí</span>
          View Cart
        </a>
      </div>

      <div class="footer-section">
        <h4>Order Status Guide</h4>
        <div class="status-guide">
          <div class="status-item">
            <span class="status-dot pending"></span>
            <span>Pending - Order being processed</span>
          </div>
          <div class="status-item">
            <span class="status-dot shipped"></span>
            <span>Shipped - On its way to you</span>
          </div>
          <div class="status-item">
            <span class="status-dot delivered"></span>
            <span>Delivered - Order received</span>
          </div>
          <div class="status-item">
            <span class="status-dot refunded"></span>
            <span>Refunded - Payment returned</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<style nonce="<%= NONCE %>">
  .orders-page {
    --primary-blue: #2563EB;
    --primary-purple: #7C3AED;
    --primary-green: #22C55E;
    --primary-black: #0F172A;

    --gray-50: #F8FAFC;
    --gray-100: #F1F5F9;
    --gray-200: #E2E8F0;
    --gray-300: #CBD5E1;
    --gray-400: #94A3B8;
    --gray-500: #64748B;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1E293B;
    --gray-900: #0F172A;

    --radius-lg: 16px;
    --radius-md: 12px;
    --radius-sm: 8px;

    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);

    padding: 1rem;
    background: var(--primary-green);
    min-height: 100vh;
  }

  .page-header,
  .filter-panel,
  .orders-container,
  .page-footer {
    background: white;
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-md);
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1.5rem;
  }

  .user-greeting { flex: 1; min-width: 280px; }

  .page-title {
    font-size: 2rem;
    font-weight: 800;
    margin: 0 0 0.5rem 0;
    background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .subtitle { color: var(--gray-600); margin: 0; }

  .order-summary {
    display: flex;
    gap: 1.25rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }

  .summary-item { display: flex; flex-direction: column; align-items: center; min-width: 80px; }
  .summary-icon { font-size: 1.5rem; }
  .summary-value { font-size: 1.25rem; font-weight: 900; color: var(--primary-black); }
  .summary-label { font-size: 0.75rem; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; }

  .header-actions { display: flex; gap: 0.75rem; flex-wrap: wrap; }

  .filter-panel { display: none; }
  .filter-panel.show { display: block; animation: slideDown 0.25s ease; }
  @keyframes slideDown { from { opacity: 0; transform: translateY(-8px);} to { opacity: 1; transform: translateY(0);} }

  .filter-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 2rem; }
  .filter-title { font-size: 0.85rem; font-weight: 700; color: var(--primary-black); margin: 0 0 0.75rem 0; text-transform: uppercase; letter-spacing: 0.5px; }
  .filter-options { display: flex; flex-direction: column; gap: 0.5rem; }
  .filter-options.time-range { flex-direction: row; flex-wrap: wrap; gap: 0.75rem; }

  .filter-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem;
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: background 0.2s ease;
  }
  .filter-option:hover { background: var(--gray-50); }
  .filter-checkbox, .filter-radio { margin-right: 0.5rem; }
  .filter-label { flex: 1; font-size: 0.875rem; color: var(--gray-700); }
  .filter-count { font-size: 0.75rem; color: var(--gray-500); background: var(--gray-100); padding: 0.125rem 0.375rem; border-radius: 999px; min-width: 1.5rem; text-align: center; }

  .filter-actions { display: flex; gap: 0.75rem; margin-top: 1rem; grid-column: 1 / -1; }

  .orders-header { display: flex; justify-content: space-between; align-items: center; gap: 1rem; flex-wrap: wrap; margin-bottom: 1.25rem; }
  .orders-title { margin: 0; color: var(--primary-black); font-size: 1.25rem; font-weight: 700; }

  .sort-select {
    appearance: none;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    padding: 0.5rem 2rem 0.5rem 1rem;
    font-size: 0.875rem;
    color: var(--gray-700);
    cursor: pointer;
    min-width: 160px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748B'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1rem;
  }
  .sort-select:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

  .orders-grid { display: flex; flex-direction: column; gap: 1rem; }

  .order-card {
    background: var(--gray-50);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    border: 1px solid var(--gray-200);
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }
  .order-card:hover { border-color: var(--primary-blue); box-shadow: var(--shadow-md); transform: translateY(-2px); }

  /* IMPORTANT: don't block clicks */
  .order-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--gray-300);
    pointer-events: none; /* ‚úÖ FIX click issues */
  }

  .order-card.pending::before { background: #F59E0B; }
  .order-card.shipped::before { background: var(--primary-blue); }
  .order-card.delivered::before { background: var(--primary-green); }
  .order-card.cancelled::before { background: #EF4444; }
  .order-card.refunded::before { background: #F97316; } /* orange */

  .order-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
  .order-id { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.875rem; font-weight: 700; color: var(--primary-black); }

  .order-meta { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
  .order-date { font-size: 0.875rem; color: var(--gray-600); }

  .order-status {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .order-status.pending { background: rgba(245, 158, 11, 0.12); color: #92400E; }
  .order-status.shipped { background: rgba(37, 99, 235, 0.12); color: var(--primary-blue); }
  .order-status.delivered { background: rgba(34, 197, 94, 0.12); color: #166534; }
  .order-status.cancelled { background: rgba(239, 68, 68, 0.12); color: #B91C1C; }
  .order-status.refunded { background: rgba(249, 115, 22, 0.12); color: #C2410C; }

  .order-content { display: grid; grid-template-columns: 1fr auto; gap: 1.5rem; }
  @media (max-width: 768px) { .order-content { grid-template-columns: 1fr; gap: 1rem; } }

  .order-details { display: flex; flex-direction: column; gap: 0.75rem; }
  .order-amount { font-size: 1.25rem; font-weight: 900; color: var(--primary-black); }
  .order-amount .currency { color: var(--primary-green); }

  .order-shipping { display: flex; flex-direction: column; gap: 0.5rem; }
  .shipping-info { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--gray-600); }
  .tracking-number { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 0.75rem; background: var(--gray-100); padding: 0.25rem 0.5rem; border-radius: var(--radius-sm); color: var(--gray-700); }

  .order-actions { display: flex; flex-direction: column; gap: 0.5rem; min-width: 200px; }
  @media (max-width: 768px) { .order-actions { flex-direction: row; flex-wrap: wrap; } }

  .order-items { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--gray-200); }
  .items-label { font-size: 0.875rem; font-weight: 700; color: var(--gray-700); margin-bottom: 0.5rem; }
  .items-list { display: flex; gap: 0.5rem; overflow-x: auto; padding-bottom: 0.5rem; }
  .item-preview { flex-shrink: 0; width: 48px; height: 48px; border-radius: var(--radius-sm); overflow: hidden; border: 1px solid var(--gray-200); background: white; }
  .item-preview img { width: 100%; height: 100%; object-fit: cover; }
  .item-preview.placeholder { background: var(--gray-200); display: flex; align-items: center; justify-content: center; color: var(--gray-500); font-size: 0.8rem; font-weight: 800; }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s ease;
  }
  .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; }
  .btn-primary { background: var(--primary-blue); color: white; border-color: var(--primary-blue); }
  .btn-primary:hover { background: #1D4ED8; border-color: #1D4ED8; transform: translateY(-1px); }
  .btn-outline { background: transparent; color: var(--gray-700); border-color: var(--gray-300); }
  .btn-outline:hover { background: var(--gray-50); border-color: var(--gray-400); }

  .action-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 700;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s ease;
    text-align: center;
    user-select: none;
  }
  .action-btn.receipt { background: rgba(6, 182, 212, 0.12); color: #0891B2; border-color: rgba(6, 182, 212, 0.25); }
  .action-btn.receipt:hover { background: #06B6D4; color: white; }
  .action-btn.track { background: rgba(245, 158, 11, 0.12); color: #D97706; border-color: rgba(245, 158, 11, 0.25); }
  .action-btn.track:hover { background: #F59E0B; color: white; }
  .action-btn.details { background: rgba(124, 58, 237, 0.12); color: var(--primary-purple); border-color: rgba(124, 58, 237, 0.25); }
  .action-btn.details:hover { background: var(--primary-purple); color: white; }

  .loading-state { display: flex; flex-direction: column; align-items: center; gap: 1rem; padding: 3rem; color: var(--gray-500); }
  .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--gray-200); border-top-color: var(--primary-blue); border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-state { padding: 3rem; text-align: center; }
  .empty-content { display: flex; flex-direction: column; align-items: center; gap: 1rem; color: var(--gray-500); }
  .empty-icon { font-size: 3rem; opacity: 0.6; }

  .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; }
  .footer-section h4 { font-size: 0.875rem; font-weight: 800; color: var(--primary-black); margin: 0 0 1rem 0; text-transform: uppercase; letter-spacing: 0.5px; }

  .footer-link { display: block; padding: 0.5rem 0; color: var(--gray-600); text-decoration: none; font-size: 0.875rem; transition: color 0.2s ease; }
  .footer-link:hover { color: var(--primary-blue); }

  .footer-action { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0; color: var(--gray-600); background: none; border: none; cursor: pointer; width: 100%; text-align: left; font-size: 0.875rem; transition: color 0.2s ease; }
  .footer-action:hover { color: var(--primary-blue); }
  .status-guide { display: flex; flex-direction: column; gap: 0.5rem; }
  .status-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: var(--gray-600); }

  .status-dot { width: 8px; height: 8px; border-radius: 50%; }
  .status-dot.pending { background: #F59E0B; }
  .status-dot.shipped { background: var(--primary-blue); }
  .status-dot.delivered { background: var(--primary-green); }
  .status-dot.refunded { background: #F97316; }

  @media (max-width: 768px) {
    .orders-page { padding: 0.75rem; }
    .page-header, .filter-panel, .orders-container, .page-footer { padding: 1rem; }
    .header-content { flex-direction: column; align-items: stretch; gap: 1rem; }
    .header-actions { flex-direction: column; }
    .btn { width: 100%; }
    .order-actions { flex-direction: row; flex-wrap: wrap; }
    .action-btn { flex: 1; min-width: 120px; }
    .footer-content { grid-template-columns: 1fr; }
  }

  @media (prefers-color-scheme: dark) {
    .orders-page { background: var(--gray-900); }
    .page-header, .filter-panel, .orders-container, .page-footer { background: var(--gray-800); }
    .subtitle, .summary-label, .filter-label, .order-date, .shipping-info, .items-label, .footer-link, .footer-action, .status-item { color: var(--gray-400); }
    .orders-title, .filter-title, .order-id, .order-amount, .footer-section h4 { color: var(--gray-100); }
    .summary-value { color: var(--gray-200); }
    .order-card { background: var(--gray-700); border-color: var(--gray-600); }
    .sort-select { background: var(--gray-700); border-color: var(--gray-600); color: var(--gray-300); }
    .filter-option:hover { background: var(--gray-700); }
    .filter-count { background: var(--gray-600); color: var(--gray-300); }
    .btn-outline { color: var(--gray-300); border-color: var(--gray-600); }
    .btn-outline:hover { background: var(--gray-700); border-color: var(--gray-500); }
    .tracking-number { background: var(--gray-600); color: var(--gray-300); }
    .item-preview.placeholder { background: var(--gray-600); color: var(--gray-300); }
    .loading-spinner { border-color: var(--gray-700); border-top-color: var(--primary-blue); }
  }
</style>

<script nonce="<%= NONCE %>">
  (function () {
    const ordersList = document.getElementById('ordersList');
    const emptyState = document.getElementById('empty-state');
    const filterPanel = document.getElementById('filter-panel');
    const filterToggle = document.getElementById('filter-toggle');
    const applyFiltersBtn = document.getElementById('apply-filters');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const sortSelect = document.getElementById('sort-orders');
    const exportBtn = document.getElementById('export-orders');

    const elTotal = document.getElementById('total-orders');
    const elCompleted = document.getElementById('completed-orders');
    const elShipped = document.getElementById('shipped-orders');

    let allOrders = [];
    let filteredOrders = [];
    let currentFilters = { status: ['all'], timeRange: 'all' };
    let currentSort = 'newest';
    let isLoading = false;

    function toNum(v, fallback = 0) {
      const n = Number(String(v ?? '').trim());
      return Number.isFinite(n) ? n : fallback;
    }

    function currencySymbol(ccy) {
      const symbols = { USD: '$', ZAR: 'R', EUR: '‚Ç¨', GBP: '¬£' };
      const up = String(ccy || '').toUpperCase();
      return symbols[up] || (up ? up + ' ' : '');
    }

    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '‚Äî';
        return date.toLocaleDateString('en-ZA', { day: 'numeric', month: 'short', year: 'numeric' });
      } catch {
        return '‚Äî';
      }
    }

    function normalizeStatus(order) {
      const s = String(order?.status || '').toLowerCase();
      const ps = String(order?.paymentStatus || '').toLowerCase();

      if (ps.includes('refunded') || s.includes('refunded')) return 'refunded';
      if (ps.includes('partially_refunded') || s.includes('partially_refunded')) return 'refunded';

      if (s.includes('shipped') || s.includes('transit')) return 'shipped';
      if (s.includes('delivered') || s.includes('completed')) return 'delivered';

      if (s.includes('cancelled') || s.includes('canceled')) return 'cancelled';
      return 'pending';
    }

    function statusLabel(norm, rawStatus) {
      if (norm === 'refunded') return 'Refunded';
      if (norm === 'shipped') return 'Shipped';
      if (norm === 'delivered') return 'Delivered';
      if (norm === 'cancelled') return 'Cancelled';
      return rawStatus || 'Pending';
    }

    function statusIcon(norm) {
      if (norm === 'refunded') return '‚Ü©Ô∏è';
      if (norm === 'shipped') return 'üöö';
      if (norm === 'delivered') return '‚úÖ';
      if (norm === 'cancelled') return '‚ùå';
      return '‚è≥';
    }

    function getShipmentStatus(status) {
      if (!status) return 'Pending';
      status = String(status).toLowerCase();
      const statusMap = {
        pending: 'Pending',
        processing: 'Processing',
        shipped: 'Shipped',
        in_transit: 'In Transit',
        delivered: 'Delivered',
        cancelled: 'Cancelled',
      };
      return statusMap[status] || status;
    }

    function getShipmentIcon(status) {
      if (!status) return 'üì¶';
      status = String(status).toLowerCase();
      if (status === 'delivered') return '‚úÖ';
      if (status === 'shipped' || status === 'in_transit') return 'üöö';
      if (status === 'processing') return '‚öôÔ∏è';
      if (status === 'cancelled') return '‚ùå';
      return 'üì¶';
    }

    function setupNotifications() {
      document.querySelectorAll('.notification-close').forEach((button) => {
        button.addEventListener('click', (e) => {
          const notification = e.target.closest('.notification');
          if (!notification) return;
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 250);
        });
      });

      setTimeout(() => {
        document.querySelectorAll('.notification-success').forEach((notification) => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 250);
        });
      }, 5000);
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function createOrderCard(order) {
      const internalId = String(order.id || order._id || '').trim();
      const orderId = String(order.orderId || '').trim();

      const displayId = (orderId || internalId || '').slice(-8) || '‚Äî';
      const date = formatDate(order.createdAt);

      const norm = normalizeStatus(order);
      const icon = statusIcon(norm);
      const label = statusLabel(norm, order.status);

      const shipment = order.shippingTracking || {};
      const shipmentStatusText = getShipmentStatus(shipment.status || '');
      const shipmentIcon = getShipmentIcon(shipment.status || '');
      const trackingNumber = String(shipment.trackingNumber || '').trim();
      const carrier = String(shipment.carrierLabel || shipment.carrier || '').trim();

      const items = Array.isArray(order.items) ? order.items : [];
      const itemsHtml = items.slice(0, 5).map((item) => {
        const name = item?.name || '';
        const img = item?.imageUrl || '';
        if (img) {
          return `<div class="item-preview"><img src="${escapeHtml(img)}" alt="${escapeHtml(name)}"></div>`;
        }
        return `<div class="item-preview placeholder">${escapeHtml((name.charAt(0) || '?').toUpperCase())}</div>`;
      }).join('');

      // ‚úÖ Receipt link priority:
      // 1) API receiptLink
      // 2) PayPal orderId
      // 3) Mongo _id
      let receiptHref = '#';
      if (order?.receiptLink) receiptHref = String(order.receiptLink);
      else if (orderId) receiptHref = `/payment/receipt/${encodeURIComponent(orderId)}`;
      else if (internalId) receiptHref = `/payment/receipt/${encodeURIComponent(internalId)}`;

      const receiptDisabled = (receiptHref === '#');

      const trackHref = internalId ? `/orders/${encodeURIComponent(internalId)}/track` : '';
      const detailsHref = internalId ? `/orders/${encodeURIComponent(internalId)}` : '';

      const amountNumber = toNum(order.amount, 0);
      const currency = String(order.currency || 'USD').toUpperCase();

      return `
        <div class="order-card ${escapeHtml(norm)}">
          <div class="order-header">
            <div class="order-id">Order #${escapeHtml(displayId)}</div>
            <div class="order-meta">
              <span class="order-date">${escapeHtml(date)}</span>
              <span class="order-status ${escapeHtml(norm)}">${escapeHtml(icon)} ${escapeHtml(label)}</span>
            </div>
          </div>

          <div class="order-content">
            <div class="order-details">
              <div class="order-amount">
                <span class="currency">${escapeHtml(currencySymbol(currency))}</span>
                <span>${escapeHtml(amountNumber.toFixed(2))}</span>
              </div>

              <div class="order-shipping">
                <div class="shipping-info">
                  <span class="shipping-icon">${escapeHtml(shipmentIcon)}</span>
                  <span>${escapeHtml(shipmentStatusText)}</span>
                  ${carrier ? `<span>‚Ä¢ ${escapeHtml(carrier)}</span>` : ''}
                </div>

                ${trackingNumber ? `
                  <div class="shipping-info">
                    <span class="shipping-icon">#</span>
                    <span class="tracking-number">${escapeHtml(trackingNumber.slice(-8))}</span>
                  </div>
                ` : ''}
              </div>
            </div>

            <div class="order-actions">
              <a href="${escapeHtml(receiptHref)}"
                 class="action-btn receipt"
                 title="${receiptDisabled ? 'Receipt not available yet' : 'View receipt'}"
                 ${receiptDisabled ? 'aria-disabled="true" onclick="return false;" style="opacity:.55;pointer-events:none;"' : ''}>
                <span class="btn-icon">üìÑ</span>
                Receipt
              </a>

              ${trackHref ? `
                <a href="${escapeHtml(trackHref)}" class="action-btn track" title="Track shipment">
                  <span class="btn-icon">üöö</span>
                  Track
                </a>
              ` : ''}

              ${detailsHref ? `
                <a href="${escapeHtml(detailsHref)}" class="action-btn details" title="Order details">
                  <span class="btn-icon">üëÅÔ∏è</span>
                  Details
                </a>
              ` : ''}
            </div>
          </div>

          ${items.length > 0 ? `
            <div class="order-items">
              <div class="items-label">Items (${items.length})</div>
              <div class="items-list">
                ${itemsHtml}
                ${items.length > 5 ? `<div class="item-preview placeholder">+${items.length - 5}</div>` : ''}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    async function loadOrders() {
      if (isLoading) return;
      isLoading = true;

      ordersList.innerHTML =
        '<div class="loading-state"><div class="loading-spinner"></div><p>Loading your orders‚Ä¶</p></div>';
      emptyState.style.display = 'none';

      try {
        const response = await fetch('/payment/my-orders', {
          credentials: 'same-origin',
          cache: 'no-store',
          headers: { 'Accept': 'application/json' },
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok || !data?.ok) throw new Error(data?.error || `Failed to load orders (${response.status})`);

        allOrders = Array.isArray(data.orders) ? data.orders : [];
        updateOrderSummary();
        updateFilterCounts();
        applyFiltersAndSort();

        if (allOrders.length === 0) showEmptyState();
      } catch (error) {
        console.error('Error loading orders:', error);
        ordersList.innerHTML = `
          <div class="empty-state">
            <div class="empty-content">
              <span class="empty-icon">‚ö†Ô∏è</span>
              <h3>Unable to Load Orders</h3>
              <p>${escapeHtml(String(error?.message || 'Please try again later.'))}</p>
              <button type="button" onclick="window.location.reload()" class="btn btn-primary">Retry</button>
            </div>
          </div>
        `;
      } finally {
        isLoading = false;
      }
    }

    function updateOrderSummary() {
      const total = allOrders.length;
      const delivered = allOrders.filter((o) => normalizeStatus(o) === 'delivered').length;
      const shipped = allOrders.filter((o) => normalizeStatus(o) === 'shipped').length;

      if (elTotal) elTotal.textContent = String(total);
      if (elCompleted) elCompleted.textContent = String(delivered);
      if (elShipped) elShipped.textContent = String(shipped);
    }

    function updateFilterCounts() {
      const counts = { all: 0, pending: 0, shipped: 0, delivered: 0, cancelled: 0 };

      for (const o of allOrders) {
        counts.all++;
        const norm = normalizeStatus(o);
        if (norm === 'pending') counts.pending++;
        else if (norm === 'shipped') counts.shipped++;
        else if (norm === 'delivered') counts.delivered++;
        else counts.cancelled++; // cancelled/refunded grouped
      }

      const set = (id, v) => {
        const el = document.getElementById(id);
        if (el) el.textContent = String(v);
      };

      set('count-all', counts.all);
      set('count-pending', counts.pending);
      set('count-shipped', counts.shipped);
      set('count-delivered', counts.delivered);
      set('count-cancelled', counts.cancelled);
    }

    function applyFiltersAndSort() {
      let filtered = [...allOrders];

      if (!currentFilters.status.includes('all')) {
        filtered = filtered.filter((order) => {
          const norm = normalizeStatus(order);
          return currentFilters.status.some((filter) => {
            if (filter === 'pending') return norm === 'pending';
            if (filter === 'shipped') return norm === 'shipped';
            if (filter === 'delivered') return norm === 'delivered';
            if (filter === 'cancelled') return norm === 'cancelled' || norm === 'refunded';
            return false;
          });
        });
      }

      if (currentFilters.timeRange !== 'all') {
        const days = Math.max(1, parseInt(currentFilters.timeRange, 10) || 0);
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);

        filtered = filtered.filter((order) => {
          const d = new Date(order.createdAt);
          return !isNaN(d.getTime()) && d >= cutoff;
        });
      }

      filtered.sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        const amountA = toNum(a.amount, 0);
        const amountB = toNum(b.amount, 0);

        switch (currentSort) {
          case 'oldest': return dateA - dateB;
          case 'amount-high': return amountB - amountA;
          case 'amount-low': return amountA - amountB;
          case 'newest':
          default: return dateB - dateA;
        }
      });

      filteredOrders = filtered;
      renderOrders();
    }

    function renderOrders() {
      if (filteredOrders.length === 0) return showEmptyState();
      ordersList.innerHTML = filteredOrders.map((o) => createOrderCard(o)).join('');
      emptyState.style.display = 'none';
    }

    function showEmptyState() {
      ordersList.innerHTML = '';
      emptyState.style.display = 'block';
    }

    function exportToCSV() {
      const headers = ['Order ID', 'Date', 'Status', 'Amount', 'Currency', 'Shipping Status', 'Tracking Number', 'Receipt'];
      const rows = filteredOrders.map((order) => {
        const shipment = order.shippingTracking || {};
        const norm = normalizeStatus(order);

        const internalId = String(order.id || order._id || '').trim();
        const orderId = String(order.orderId || '').trim();
        let receiptHref = '';
        if (order?.receiptLink) receiptHref = String(order.receiptLink);
        else if (orderId) receiptHref = `/payment/receipt/${orderId}`;
        else if (internalId) receiptHref = `/payment/receipt/${internalId}`;

        return [
          orderId || internalId || '',
          formatDate(order.createdAt),
          statusLabel(norm, order.status),
          toNum(order.amount, 0).toFixed(2),
          String(order.currency || 'USD').toUpperCase(),
          getShipmentStatus(shipment.status),
          shipment.trackingNumber || '',
          receiptHref || '',
        ];
      });

      const csv = [
        headers.join(','),
        ...rows.map((row) => row.map((cell) => `"${String(cell ?? '').replaceAll('"', '""')}"`).join(',')),
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `orders-${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }

    function setupEventListeners() {
      if (filterToggle) {
        filterToggle.addEventListener('click', () => filterPanel.classList.toggle('show'));
      }

      if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', () => {
          const checked = document.querySelectorAll('.filter-checkbox:checked');
          currentFilters.status = Array.from(checked).map((cb) => cb.value);

          const timeRangeRadio = document.querySelector('.filter-radio:checked');
          currentFilters.timeRange = timeRangeRadio ? timeRangeRadio.value : 'all';

          applyFiltersAndSort();
          filterPanel.classList.remove('show');
        });
      }

      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
          document.querySelectorAll('.filter-checkbox').forEach((cb) => (cb.checked = cb.value === 'all'));
          document.querySelectorAll('.filter-radio').forEach((rb) => (rb.checked = rb.value === 'all'));
          currentFilters = { status: ['all'], timeRange: 'all' };
          applyFiltersAndSort();
        });
      }

      if (sortSelect) {
        sortSelect.addEventListener('change', (e) => {
          currentSort = e.target.value;
          applyFiltersAndSort();
        });
      }

      if (exportBtn) exportBtn.addEventListener('click', exportToCSV);
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupNotifications();
      setupEventListeners();
      loadOrders();
    });

    window.ordersApp = { loadOrders, applyFiltersAndSort, exportToCSV };
  })();
</script>
