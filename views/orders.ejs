<!-- views/orders.ejs -->
<%
  const NONCE = typeof nonce !== 'undefined' ? nonce : '';
%>

<main class="orders-page">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="user-greeting">
        <h1 class="page-title">Order History</h1>
        <div class="subtitle-container">
          <p class="subtitle">Track your purchases and shipments</p>
          <div class="order-summary">
            <span class="summary-item">
              <span class="summary-icon">üì¶</span>
              <span class="summary-value" id="total-orders">‚Äî</span>
              <span class="summary-label">Total</span>
            </span>
            <span class="summary-item">
              <span class="summary-icon">‚úÖ</span>
              <span class="summary-value" id="completed-orders">‚Äî</span>
              <span class="summary-label">Completed</span>
            </span>
            <span class="summary-item">
              <span class="summary-icon">üöö</span>
              <span class="summary-value" id="shipped-orders">‚Äî</span>
              <span class="summary-label">Shipped</span>
            </span>
          </div>
        </div>
      </div>
      
      <div class="header-actions">
        <a href="/sales" class="btn btn-primary btn-with-icon">
          <span class="btn-icon">‚Üê</span>
          Continue Shopping
        </a>
        <button class="btn btn-outline" id="filter-toggle">
          <span class="btn-icon">üîç</span>
          Filter
        </button>
      </div>
    </div>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel" id="filter-panel">
    <div class="filter-content">
      <div class="filter-group">
        <h4 class="filter-title">Order Status</h4>
        <div class="filter-options">
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" value="all" checked>
            <span class="filter-label">All Orders</span>
            <span class="filter-count" id="count-all">‚Äî</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" value="pending">
            <span class="filter-label">‚è≥ Pending</span>
            <span class="filter-count" id="count-pending">‚Äî</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" value="shipped">
            <span class="filter-label">üöö Shipped</span>
            <span class="filter-count" id="count-shipped">‚Äî</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" value="delivered">
            <span class="filter-label">‚úÖ Delivered</span>
            <span class="filter-count" id="count-delivered">‚Äî</span>
          </label>
          <label class="filter-option">
            <input type="checkbox" class="filter-checkbox" value="cancelled">
            <span class="filter-label">‚ùå Cancelled</span>
            <span class="filter-count" id="count-cancelled">‚Äî</span>
          </label>
        </div>
      </div>
      
      <div class="filter-group">
        <h4 class="filter-title">Time Range</h4>
        <div class="filter-options time-range">
          <label class="filter-option">
            <input type="radio" name="time-range" class="filter-radio" value="all" checked>
            <span class="filter-label">All Time</span>
          </label>
          <label class="filter-option">
            <input type="radio" name="time-range" class="filter-radio" value="30">
            <span class="filter-label">Last 30 Days</span>
          </label>
          <label class="filter-option">
            <input type="radio" name="time-range" class="filter-radio" value="90">
            <span class="filter-label">Last 90 Days</span>
          </label>
        </div>
      </div>
      
      <div class="filter-actions">
        <button class="btn btn-sm btn-outline" id="clear-filters">Clear Filters</button>
        <button class="btn btn-sm btn-primary" id="apply-filters">Apply</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Notifications -->
    <div class="notifications-container" id="notifications">
      <% if (success && success.length > 0) { %>
        <div class="notification notification-success">
          <span class="notification-icon">‚úì</span>
          <span class="notification-text"><%= success %></span>
          <button class="notification-close">&times;</button>
        </div>
      <% } %>
      <% if (error && error.length > 0) { %>
        <div class="notification notification-error">
          <span class="notification-icon">!</span>
          <span class="notification-text"><%= error %></span>
          <button class="notification-close">&times;</button>
        </div>
      <% } %>
    </div>

    <!-- Orders Container -->
    <div class="orders-container">
      <div class="orders-header">
        <h2 class="orders-title">Recent Orders</h2>
        <div class="sort-control">
          <select class="sort-select" id="sort-orders">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="amount-high">Amount (High to Low)</option>
            <option value="amount-low">Amount (Low to High)</option>
          </select>
        </div>
      </div>

      <!-- Orders List -->
      <div id="ordersList" class="orders-grid">
        <div class="loading-state">
          <div class="loading-spinner"></div>
          <p>Loading your orders‚Ä¶</p>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="empty-state" style="display: none;">
        <div class="empty-content">
          <span class="empty-icon">üì¶</span>
          <h3>No Orders Found</h3>
          <p>You haven't placed any orders yet, or no orders match your filters.</p>
          <a href="/sales" class="btn btn-primary">Start Shopping</a>
        </div>
      </div>

      <!-- Loading More -->
      <div id="loading-more" class="loading-more" style="display: none;">
        <div class="loading-spinner"></div>
        <span>Loading more orders‚Ä¶</span>
      </div>

      <!-- Load More Button -->
      <div class="load-more-container">
        <button id="load-more" class="btn btn-outline" style="display: none;">
          Load More Orders
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="page-footer">
    <div class="footer-content">
      <div class="footer-section">
        <h4>Need Help?</h4>
        <a href="/contact" class="footer-link">Contact Support</a>
        <a href="/help/orders" class="footer-link">Order Help Center</a>
        <a href="/help/shipping" class="footer-link">Shipping Information</a>
      </div>
      
      <div class="footer-section">
        <h4>Quick Actions</h4>
        <button class="footer-action" onclick="window.print()">
          <span class="action-icon">üñ®Ô∏è</span>
          Print Order History
        </button>
        <button class="footer-action" id="export-orders">
          <span class="action-icon">üìä</span>
          Export as CSV
        </button>
        <a href="/cart" class="footer-action">
          <span class="action-icon">üõí</span>
          View Cart
        </a>
      </div>
      
      <div class="footer-section">
        <h4>Order Status Guide</h4>
        <div class="status-guide">
          <div class="status-item">
            <span class="status-dot pending"></span>
            <span>Pending - Order being processed</span>
          </div>
          <div class="status-item">
            <span class="status-dot shipped"></span>
            <span>Shipped - On its way to you</span>
          </div>
          <div class="status-item">
            <span class="status-dot delivered"></span>
            <span>Delivered - Order received</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<style nonce="<%= NONCE %>">
  /* ===== VARIABLES ===== */
  .orders-page {
    --primary-blue: #2563EB;
    --primary-purple: #7C3AED;
    --primary-green: #22C55E;
    --primary-black: #0F172A;
    --gray-50: #F8FAFC;
    --gray-100: #F1F5F9;
    --gray-200: #E2E8F0;
    --gray-300: #CBD5E1;
    --gray-400: #94A3B8;
    --gray-500: #64748B;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1E293B;
    --gray-900: #0F172A;
    --radius-lg: 16px;
    --radius-md: 12px;
    --radius-sm: 8px;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    background: var(--primary-green);
    min-height: 100vh;
  }

  /* ===== PAGE HEADER ===== */
  .page-header {
    background: white;
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-md);
  }

  .header-content {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
    gap: 1.5rem;
  }

  .user-greeting {
    flex: 1;
    min-width: 300px;
  }

  .page-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-black);
    margin: 0 0 0.5rem 0;
    background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .subtitle-container {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .subtitle {
    font-size: 1rem;
    color: var(--gray-600);
    margin: 0;
  }

  .order-summary {
    display: flex;
    gap: 1.5rem;
    flex-wrap: wrap;
  }

  .summary-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 80px;
  }

  .summary-icon {
    font-size: 1.5rem;
    margin-bottom: 0.25rem;
  }

  .summary-value {
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--primary-black);
    margin-bottom: 0.125rem;
  }

  .summary-label {
    font-size: 0.75rem;
    color: var(--gray-500);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .header-actions {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  /* ===== FILTER PANEL ===== */
  .filter-panel {
    background: white;
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-md);
    display: none;
  }

  .filter-panel.show {
    display: block;
    animation: slideDown 0.3s ease;
  }

  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .filter-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
  }

  .filter-group {
    margin-bottom: 1rem;
  }

  .filter-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--primary-black);
    margin: 0 0 0.75rem 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .filter-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .filter-options.time-range {
    flex-direction: row;
    flex-wrap: wrap;
  }

  .filter-option {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.5rem;
    cursor: pointer;
    border-radius: var(--radius-sm);
    transition: background-color 0.2s ease;
  }

  .filter-option:hover {
    background: var(--gray-50);
  }

  .filter-checkbox,
  .filter-radio {
    margin-right: 0.5rem;
  }

  .filter-label {
    flex: 1;
    font-size: 0.875rem;
    color: var(--gray-700);
  }

  .filter-count {
    font-size: 0.75rem;
    color: var(--gray-500);
    background: var(--gray-100);
    padding: 0.125rem 0.375rem;
    border-radius: 999px;
    min-width: 1.5rem;
    text-align: center;
  }

  .filter-actions {
    display: flex;
    gap: 0.75rem;
    margin-top: 1rem;
    grid-column: 1 / -1;
  }

  /* ===== MAIN CONTENT ===== */
  .main-content {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* ===== NOTIFICATIONS ===== */
  .notifications-container {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .notification {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    animation: slideIn 0.3s ease-out;
    border-left: 4px solid transparent;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .notification-success {
    background: rgba(34, 197, 94, 0.1);
    color: #166534;
    border-left-color: var(--primary-green);
  }

  .notification-error {
    background: rgba(239, 68, 68, 0.1);
    color: #b91c1c;
    border-left-color: #EF4444;
  }

  .notification-icon {
    font-weight: bold;
    font-size: 1rem;
  }

  .notification-close {
    margin-left: auto;
    background: none;
    border: none;
    cursor: pointer;
    color: inherit;
    opacity: 0.7;
    font-size: 1.25rem;
    line-height: 1;
  }

  .notification-close:hover {
    opacity: 1;
  }

  /* ===== ORDERS CONTAINER ===== */
  .orders-container {
    background: white;
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    box-shadow: var(--shadow-md);
  }

  .orders-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .orders-title {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--primary-black);
    margin: 0;
  }

  .sort-control {
    position: relative;
  }

  .sort-select {
    appearance: none;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    padding: 0.5rem 2rem 0.5rem 1rem;
    font-size: 0.875rem;
    color: var(--gray-700);
    cursor: pointer;
    min-width: 160px;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2364748B'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 0.75rem center;
    background-size: 1rem;
  }

  .sort-select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  /* ===== ORDERS GRID ===== */
  .orders-grid {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  /* ===== ORDER CARD ===== */
  .order-card {
    background: var(--gray-50);
    border-radius: var(--radius-md);
    padding: 1.5rem;
    border: 1px solid var(--gray-200);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }

  .order-card:hover {
    border-color: var(--primary-blue);
    box-shadow: var(--shadow-md);
    transform: translateY(-2px);
  }

  .order-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 4px;
    height: 100%;
    background: var(--gray-300);
  }

  .order-card.pending::before {
    background: #F59E0B;
  }

  .order-card.shipped::before {
    background: var(--primary-blue);
  }

  .order-card.delivered::before {
    background: var(--primary-green);
  }

  .order-card.cancelled::before {
    background: #EF4444;
  }

  .order-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .order-id {
    font-family: 'SF Mono', Monaco, 'Cascadia Mono', monospace;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--primary-black);
  }

  .order-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .order-date {
    font-size: 0.875rem;
    color: var(--gray-600);
  }

  .order-status {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .order-status.pending {
    background: rgba(245, 158, 11, 0.1);
    color: #92400E;
  }

  .order-status.shipped {
    background: rgba(37, 99, 235, 0.1);
    color: var(--primary-blue);
  }

  .order-status.delivered {
    background: rgba(34, 197, 94, 0.1);
    color: #166534;
  }

  .order-status.cancelled {
    background: rgba(239, 68, 68, 0.1);
    color: #B91C1C;
  }

  .order-content {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 1.5rem;
    margin-bottom: 1rem;
  }

  @media (max-width: 768px) {
    .order-content {
      grid-template-columns: 1fr;
      gap: 1rem;
    }
  }

  .order-details {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .order-amount {
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--primary-black);
  }

  .order-amount .currency {
    color: var(--primary-green);
  }

  .order-shipping {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .shipping-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--gray-600);
  }

  .shipping-icon {
    font-size: 1rem;
    flex-shrink: 0;
  }

  .tracking-number {
    font-family: 'SF Mono', Monaco, 'Cascadia Mono', monospace;
    font-size: 0.75rem;
    background: var(--gray-100);
    padding: 0.25rem 0.5rem;
    border-radius: var(--radius-sm);
    color: var(--gray-700);
  }

  .order-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 200px;
  }

  @media (max-width: 768px) {
    .order-actions {
      flex-direction: row;
      flex-wrap: wrap;
    }
  }

  .order-items {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid var(--gray-200);
  }

  .items-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.5rem;
  }

  .items-list {
    display: flex;
    gap: 0.5rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }

  .item-preview {
    flex-shrink: 0;
    width: 48px;
    height: 48px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    border: 1px solid var(--gray-200);
  }

  .item-preview img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .item-preview.placeholder {
    background: var(--gray-200);
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-400);
    font-size: 0.75rem;
  }

  /* ===== BUTTONS ===== */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s ease;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
  }

  .btn-primary {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
  }

  .btn-primary:hover {
    background: #1D4ED8;
    border-color: #1D4ED8;
    transform: translateY(-1px);
  }

  .btn-outline {
    background: transparent;
    color: var(--gray-700);
    border-color: var(--gray-300);
  }

  .btn-outline:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
  }

  .btn-with-icon {
    padding: 0.5rem 1rem;
  }

  .btn-icon {
    font-size: 1rem;
  }

  .action-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s ease;
    text-align: center;
  }

  .action-btn.receipt {
    background: rgba(6, 182, 212, 0.1);
    color: #0891B2;
    border-color: rgba(6, 182, 212, 0.2);
  }

  .action-btn.receipt:hover {
    background: #06B6D4;
    color: white;
  }

  .action-btn.track {
    background: rgba(245, 158, 11, 0.1);
    color: #D97706;
    border-color: rgba(245, 158, 11, 0.2);
  }

  .action-btn.track:hover {
    background: #F59E0B;
    color: white;
  }

  .action-btn.details {
    background: rgba(124, 58, 237, 0.1);
    color: var(--primary-purple);
    border-color: rgba(124, 58, 237, 0.2);
  }

  .action-btn.details:hover {
    background: var(--primary-purple);
    color: white;
  }

  /* ===== LOADING STATES ===== */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 3rem;
    color: var(--gray-500);
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--gray-200);
    border-top-color: var(--primary-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-more {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
    padding: 2rem;
    color: var(--gray-500);
  }

  .load-more-container {
    text-align: center;
    padding: 1.5rem;
  }

  /* ===== EMPTY STATE ===== */
  .empty-state {
    padding: 3rem;
    text-align: center;
  }

  .empty-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    color: var(--gray-500);
  }

  .empty-icon {
    font-size: 3rem;
    opacity: 0.5;
  }

  .empty-content h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-700);
    margin: 0;
  }

  .empty-content p {
    margin: 0;
    max-width: 400px;
  }

  /* ===== PAGE FOOTER ===== */
  .page-footer {
    background: white;
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: var(--shadow-md);
  }

  .footer-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
  }

  .footer-section h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--primary-black);
    margin: 0 0 1rem 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .footer-link {
    display: block;
    padding: 0.5rem 0;
    color: var(--gray-600);
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.2s ease;
  }

  .footer-link:hover {
    color: var(--primary-blue);
  }

  .footer-action {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0;
    color: var(--gray-600);
    text-decoration: none;
    font-size: 0.875rem;
    background: none;
    border: none;
    cursor: pointer;
    width: 100%;
    text-align: left;
    transition: color 0.2s ease;
  }

  .footer-action:hover {
    color: var(--primary-blue);
  }

  .action-icon {
    font-size: 1rem;
  }

  .status-guide {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .status-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: var(--gray-600);
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .status-dot.pending {
    background: #F59E0B;
  }

  .status-dot.shipped {
    background: var(--primary-blue);
  }

  .status-dot.delivered {
    background: var(--primary-green);
  }

  /* ===== MOBILE OPTIMIZATIONS ===== */
  @media (max-width: 768px) {
    .orders-page {
      padding: 0.75rem;
    }

    .page-header,
    .filter-panel,
    .orders-container,
    .page-footer {
      padding: 1rem;
    }

    .header-content {
      flex-direction: column;
      align-items: stretch;
      gap: 1rem;
    }

    .header-actions {
      flex-direction: column;
    }

    .btn {
      width: 100%;
      justify-content: center;
    }

    .filter-content {
      grid-template-columns: 1fr;
    }

    .order-actions {
      flex-direction: row;
      flex-wrap: wrap;
    }

    .action-btn {
      flex: 1;
      min-width: 120px;
    }

    .footer-content {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    .page-title {
      font-size: 1.5rem;
    }

    .order-summary {
      justify-content: space-between;
    }

    .summary-item {
      min-width: 60px;
    }

    .order-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .order-content {
      grid-template-columns: 1fr;
    }

    .order-actions {
      flex-direction: column;
    }

    .action-btn {
      width: 100%;
    }
  }

  /* ===== DARK THEME SUPPORT ===== */
  @media (prefers-color-scheme: dark) {
    .orders-page {
      background: var(--gray-900);
    }

    .page-header,
    .filter-panel,
    .orders-container,
    .page-footer {
      background: var(--gray-800);
    }

    .page-title,
    .orders-title,
    .filter-title,
    .order-id,
    .order-amount,
    .footer-section h4 {
      color: var(--gray-100);
    }

    .subtitle,
    .summary-label,
    .filter-label,
    .order-date,
    .shipping-info,
    .items-label,
    .footer-link,
    .footer-action,
    .status-item {
      color: var(--gray-400);
    }

    .summary-value {
      color: var(--gray-200);
    }

    .order-card {
      background: var(--gray-700);
      border-color: var(--gray-600);
    }

    .order-card:hover {
      border-color: var(--primary-blue);
    }

    .sort-select {
      background: var(--gray-700);
      border-color: var(--gray-600);
      color: var(--gray-300);
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23CBD5E1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    }

    .filter-option:hover {
      background: var(--gray-700);
    }

    .filter-count {
      background: var(--gray-600);
      color: var(--gray-300);
    }

    .btn-outline {
      color: var(--gray-300);
      border-color: var(--gray-600);
    }

    .btn-outline:hover {
      background: var(--gray-700);
      border-color: var(--gray-500);
    }

    .tracking-number {
      background: var(--gray-600);
      color: var(--gray-300);
    }

    .item-preview.placeholder {
      background: var(--gray-600);
      color: var(--gray-400);
    }

    .loading-spinner {
      border-color: var(--gray-700);
      border-top-color: var(--primary-blue);
    }
  }
</style>

<script nonce="<%= NONCE %>">
  (function(){
    // DOM Elements
    const ordersList = document.getElementById('ordersList');
    const emptyState = document.getElementById('empty-state');
    const loadingMore = document.getElementById('loading-more');
    const loadMoreBtn = document.getElementById('load-more');
    const filterPanel = document.getElementById('filter-panel');
    const filterToggle = document.getElementById('filter-toggle');
    const applyFiltersBtn = document.getElementById('apply-filters');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const sortSelect = document.getElementById('sort-orders');
    const exportBtn = document.getElementById('export-orders');
    
    // State
    let allOrders = [];
    let filteredOrders = [];
    let currentFilters = {
      status: ['all'],
      timeRange: 'all'
    };
    let currentSort = 'newest';
    let isLoading = false;
    let hasMore = true;
    let page = 1;

    // Utility Functions
    function formatCurrency(amount, currency = 'ZAR') {
      const symbols = { USD: '$', ZAR: 'R', EUR: '‚Ç¨', GBP: '¬£' };
      const symbol = symbols[currency.toUpperCase()] || currency + ' ';
      return symbol + Number(amount || 0).toFixed(2);
    }

    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-ZA', {
          day: 'numeric',
          month: 'short',
          year: 'numeric'
        });
      } catch {
        return '‚Äî';
      }
    }

    function getStatusClass(status) {
      if (!status) return 'pending';
      status = String(status).toLowerCase();
      if (status.includes('shipped') || status.includes('transit')) return 'shipped';
      if (status.includes('delivered') || status.includes('completed')) return 'delivered';
      if (status.includes('cancelled') || status.includes('refunded')) return 'cancelled';
      return 'pending';
    }

    function getStatusIcon(status) {
      if (!status) return '‚è≥';
      status = String(status).toLowerCase();
      if (status.includes('shipped') || status.includes('transit')) return 'üöö';
      if (status.includes('delivered') || status.includes('completed')) return '‚úÖ';
      if (status.includes('cancelled') || status.includes('refunded')) return '‚ùå';
      return '‚è≥';
    }

    function getShipmentStatus(status) {
      if (!status) return 'Pending';
      status = String(status).toLowerCase();
      const statusMap = {
        'pending': 'Pending',
        'processing': 'Processing',
        'shipped': 'Shipped',
        'in_transit': 'In Transit',
        'delivered': 'Delivered',
        'cancelled': 'Cancelled'
      };
      return statusMap[status] || status;
    }

    function getShipmentIcon(status) {
      if (!status) return 'üì¶';
      status = String(status).toLowerCase();
      if (status === 'delivered') return '‚úÖ';
      if (status === 'shipped' || status === 'in_transit') return 'üöö';
      if (status === 'processing') return '‚öôÔ∏è';
      if (status === 'cancelled') return '‚ùå';
      return 'üì¶';
    }

    // Notification Management
    function setupNotifications() {
      document.querySelectorAll('.notification-close').forEach(button => {
        button.addEventListener('click', (e) => {
          const notification = e.target.closest('.notification');
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 300);
        });
      });

      // Auto-hide success notifications after 5 seconds
      setTimeout(() => {
        document.querySelectorAll('.notification-success').forEach(notification => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 300);
        });
      }, 5000);
    }

    // Order Card Template
    function createOrderCard(order) {
      const internalId = (order.id || order._id || '').toString().trim();
      const receiptId = String(order.orderId || order.paypalOrderId || internalId).trim();
      const date = formatDate(order.createdAt);
      const amount = formatCurrency(order.amount, order.currency);
      const status = order.status || 'Pending';
      const statusClass = getStatusClass(status);
      const statusIcon = getStatusIcon(status);
      
      // Shipment data
      const shipment = order.shippingTracking || {};
      const shipmentStatus = shipment.status || '';
      const shipmentStatusText = getShipmentStatus(shipmentStatus);
      const shipmentIcon = getShipmentIcon(shipmentStatus);
      const trackingNumber = shipment.trackingNumber || '';
      const carrier = shipment.carrierLabel || shipment.carrier || '';

      // Order items preview
      const items = order.items || [];
      const itemsHtml = items.slice(0, 5).map(item => {
        if (item.imageUrl) {
          return `<div class="item-preview"><img src="${item.imageUrl}" alt="${item.name}"></div>`;
        } else {
          return `<div class="item-preview placeholder">${item.name?.charAt(0) || '?'}</div>`;
        }
      }).join('');

      const receiptHref = `/payment/receipt/${encodeURIComponent(receiptId)}`;
      const trackHref = internalId ? `/orders/${encodeURIComponent(internalId)}/track` : '#';
      const detailsHref = internalId ? `/orders/${encodeURIComponent(internalId)}` : '#';

      return `
        <div class="order-card ${statusClass}">
          <div class="order-header">
            <div class="order-id">Order #${receiptId.slice(-8) || '‚Äî'}</div>
            <div class="order-meta">
              <span class="order-date">${date}</span>
              <span class="order-status ${statusClass}">${statusIcon} ${status}</span>
            </div>
          </div>
          
          <div class="order-content">
            <div class="order-details">
              <div class="order-amount">
                <span class="currency">${amount.split(' ')[0]}</span>
                <span>${amount.split(' ')[1]}</span>
              </div>
              
              <div class="order-shipping">
                <div class="shipping-info">
                  <span class="shipping-icon">${shipmentIcon}</span>
                  <span>${shipmentStatusText}</span>
                  ${carrier ? `<span>‚Ä¢ ${carrier}</span>` : ''}
                </div>
                ${trackingNumber ? `
                  <div class="shipping-info">
                    <span class="shipping-icon">#</span>
                    <span class="tracking-number">${trackingNumber.slice(-8)}</span>
                  </div>
                ` : ''}
              </div>
            </div>
            
            <div class="order-actions">
              <a href="${receiptHref}" class="action-btn receipt" title="View receipt">
                <span class="btn-icon">üìÑ</span>
                Receipt
              </a>
              ${internalId ? `
                <a href="${trackHref}" class="action-btn track" title="Track shipment">
                  <span class="btn-icon">üöö</span>
                  Track
                </a>
                <a href="${detailsHref}" class="action-btn details" title="Order details">
                  <span class="btn-icon">üëÅÔ∏è</span>
                  Details
                </a>
              ` : ''}
            </div>
          </div>
          
          ${items.length > 0 ? `
            <div class="order-items">
              <div class="items-label">Items (${items.length})</div>
              <div class="items-list">
                ${itemsHtml}
                ${items.length > 5 ? '<div class="item-preview placeholder">+' + (items.length - 5) + '</div>' : ''}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    // Load Orders
    async function loadOrders() {
      if (isLoading) return;
      
      isLoading = true;
      ordersList.innerHTML = '<div class="loading-state"><div class="loading-spinner"></div><p>Loading your orders‚Ä¶</p></div>';
      emptyState.style.display = 'none';
      loadMoreBtn.style.display = 'none';

      try {
        const response = await fetch('/payment/my-orders', {
          credentials: 'same-origin',
          headers: {
            'Cache-Control': 'no-cache'
          }
        });

        if (!response.ok) throw new Error('Failed to load orders');

        const data = await response.json();
        if (!data.ok) throw new Error(data.error || 'Invalid response');

        allOrders = data.orders || [];
        updateOrderSummary();
        applyFiltersAndSort();
        
        if (allOrders.length === 0) {
          showEmptyState();
        }

      } catch (error) {
        console.error('Error loading orders:', error);
        ordersList.innerHTML = `
          <div class="empty-state">
            <div class="empty-content">
              <span class="empty-icon">‚ö†Ô∏è</span>
              <h3>Unable to Load Orders</h3>
              <p>Please try again later.</p>
              <button onclick="window.location.reload()" class="btn btn-primary">Retry</button>
            </div>
          </div>
        `;
      } finally {
        isLoading = false;
      }
    }

    // Update Order Summary
    function updateOrderSummary() {
      const total = allOrders.length;
      const completed = allOrders.filter(o => 
        o.status && o.status.toLowerCase().includes('delivered')
      ).length;
      const shipped = allOrders.filter(o => 
        o.status && (o.status.toLowerCase().includes('shipped') || o.status.toLowerCase().includes('transit'))
      ).length;

      document.getElementById('total-orders').textContent = total;
      document.getElementById('completed-orders').textContent = completed;
      document.getElementById('shipped-orders').textContent = shipped;
    }

    // Filter and Sort Orders
    function applyFiltersAndSort() {
      let filtered = [...allOrders];

      // Apply status filters
      if (!currentFilters.status.includes('all')) {
        filtered = filtered.filter(order => {
          const status = (order.status || '').toLowerCase();
          return currentFilters.status.some(filter => {
            if (filter === 'pending') return status.includes('pending') || status.includes('processing');
            if (filter === 'shipped') return status.includes('shipped') || status.includes('transit');
            if (filter === 'delivered') return status.includes('delivered') || status.includes('completed');
            if (filter === 'cancelled') return status.includes('cancelled') || status.includes('refunded');
            return false;
          });
        });
      }

      // Apply time range filter
      if (currentFilters.timeRange !== 'all') {
        const days = parseInt(currentFilters.timeRange);
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - days);
        
        filtered = filtered.filter(order => {
          try {
            const orderDate = new Date(order.createdAt);
            return orderDate >= cutoffDate;
          } catch {
            return false;
          }
        });
      }

      // Apply sorting
      filtered.sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        const amountA = parseFloat(a.amount || 0);
        const amountB = parseFloat(b.amount || 0);

        switch (currentSort) {
          case 'newest':
            return dateB - dateA;
          case 'oldest':
            return dateA - dateB;
          case 'amount-high':
            return amountB - amountA;
          case 'amount-low':
            return amountA - amountB;
          default:
            return dateB - dateA;
        }
      });

      filteredOrders = filtered;
      renderOrders();
    }

    // Render Orders
    function renderOrders() {
      if (filteredOrders.length === 0) {
        showEmptyState();
        return;
      }

      const ordersHtml = filteredOrders.map(order => createOrderCard(order)).join('');
      ordersList.innerHTML = ordersHtml;
      emptyState.style.display = 'none';
    }

    // Show Empty State
    function showEmptyState() {
      ordersList.innerHTML = '';
      emptyState.style.display = 'block';
    }

    // Export Orders to CSV
    function exportToCSV() {
      const headers = ['Order ID', 'Date', 'Status', 'Amount', 'Shipping Status', 'Tracking Number'];
      const rows = filteredOrders.map(order => {
        const shipment = order.shippingTracking || {};
        return [
          order.orderId || order._id,
          formatDate(order.createdAt),
          order.status || 'Pending',
          formatCurrency(order.amount, order.currency),
          getShipmentStatus(shipment.status),
          shipment.trackingNumber || ''
        ];
      });

      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.map(cell => `"${cell}"`).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `orders-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Event Listeners
    function setupEventListeners() {
      // Filter toggle
      filterToggle.addEventListener('click', () => {
        filterPanel.classList.toggle('show');
      });

      // Apply filters
      applyFiltersBtn.addEventListener('click', () => {
        const statusCheckboxes = document.querySelectorAll('.filter-checkbox:checked');
        currentFilters.status = Array.from(statusCheckboxes).map(cb => cb.value);
        
        const timeRangeRadio = document.querySelector('.filter-radio:checked');
        currentFilters.timeRange = timeRangeRadio ? timeRangeRadio.value : 'all';
        
        applyFiltersAndSort();
        filterPanel.classList.remove('show');
      });

      // Clear filters
      clearFiltersBtn.addEventListener('click', () => {
        document.querySelectorAll('.filter-checkbox').forEach(cb => {
          cb.checked = cb.value === 'all';
        });
        document.querySelectorAll('.filter-radio').forEach(rb => {
          rb.checked = rb.value === 'all';
        });
        
        currentFilters = {
          status: ['all'],
          timeRange: 'all'
        };
        
        applyFiltersAndSort();
      });

      // Sort orders
      sortSelect.addEventListener('change', (e) => {
        currentSort = e.target.value;
        applyFiltersAndSort();
      });

      // Export orders
      exportBtn.addEventListener('click', exportToCSV);

      // Load more (for future pagination)
      loadMoreBtn.addEventListener('click', () => {
        // Implement pagination if needed
      });
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupNotifications();
      setupEventListeners();
      loadOrders();
    });

    // Expose functions for debugging
    window.ordersApp = {
      loadOrders,
      applyFiltersAndSort,
      exportToCSV
    };

  })();
</script>