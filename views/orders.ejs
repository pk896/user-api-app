<!-- views/orders.ejs -->
<%
  const NONCE = typeof nonce !== 'undefined' ? nonce : '';
%>

<main class="orders-page">
  <!-- Header Section -->
  <div class="page-header" aria-label="Orders header">
    <div class="header-content">
      <div class="user-greeting">
        <h1 class="page-title">Order History</h1>

        <div class="subtitle-container">
          <p class="subtitle">Track your purchases and shipments</p>

          <div class="order-summary" role="list" aria-label="Order summary">
            <span class="summary-item sum-purple" role="listitem">
              <span class="summary-icon" aria-hidden="true">üì¶</span>
              <span class="summary-value" id="total-orders">‚Äî</span>
              <span class="summary-label">Total</span>
            </span>

            <span class="summary-item sum-green" role="listitem">
              <span class="summary-icon" aria-hidden="true">‚úÖ</span>
              <span class="summary-value" id="completed-orders">‚Äî</span>
              <span class="summary-label">Completed</span>
            </span>

            <span class="summary-item sum-blue" role="listitem">
              <span class="summary-icon" aria-hidden="true">üöö</span>
              <span class="summary-value" id="shipped-orders">‚Äî</span>
              <span class="summary-label">Shipped</span>
            </span>
          </div>
        </div>
      </div>

      <div class="header-actions" aria-label="Orders actions">
        <a href="/sales" class="btn btn-primary btn-with-icon">
          <span class="btn-icon" aria-hidden="true">‚Üê</span>
          Continue Shopping
        </a>

        <button class="btn btn-outline" id="filter-toggle" type="button" aria-expanded="false" aria-controls="filter-panel">
          <span class="btn-icon" aria-hidden="true">üîç</span>
          Filter
        </button>
      </div>
    </div>
  </div>

  <!-- Filter Panel -->
  <div class="filter-panel" id="filter-panel" aria-label="Filter orders panel" aria-hidden="true">
    <div class="filter-content">
      <div class="filter-group fg-purple">
        <h4 class="filter-title">Order Status</h4>

        <div class="filter-options" role="group" aria-label="Filter by order status">
          <label class="filter-option">
            <span class="left">
              <input type="checkbox" class="filter-checkbox" value="all" checked>
              <span class="filter-label">All Orders</span>
            </span>
            <span class="filter-count" id="count-all">‚Äî</span>
          </label>

          <label class="filter-option">
            <span class="left">
              <input type="checkbox" class="filter-checkbox" value="pending">
              <span class="filter-label">‚è≥ Pending</span>
            </span>
            <span class="filter-count" id="count-pending">‚Äî</span>
          </label>

          <label class="filter-option">
            <span class="left">
              <input type="checkbox" class="filter-checkbox" value="shipped">
              <span class="filter-label">üöö Shipped</span>
            </span>
            <span class="filter-count" id="count-shipped">‚Äî</span>
          </label>

          <label class="filter-option">
            <span class="left">
              <input type="checkbox" class="filter-checkbox" value="delivered">
              <span class="filter-label">‚úÖ Delivered</span>
            </span>
            <span class="filter-count" id="count-delivered">‚Äî</span>
          </label>

          <label class="filter-option">
            <span class="left">
              <input type="checkbox" class="filter-checkbox" value="cancelled">
              <span class="filter-label">‚ùå Cancelled / Refunded</span>
            </span>
            <span class="filter-count" id="count-cancelled">‚Äî</span>
          </label>
        </div>
      </div>

      <div class="filter-group fg-blue">
        <h4 class="filter-title">Time Range</h4>
        <div class="filter-options time-range" role="radiogroup" aria-label="Filter by time range">
          <label class="filter-option pill">
            <input type="radio" name="time-range" class="filter-radio" value="all" checked>
            <span class="filter-label">All Time</span>
          </label>

          <label class="filter-option pill">
            <input type="radio" name="time-range" class="filter-radio" value="30">
            <span class="filter-label">Last 30 Days</span>
          </label>

          <label class="filter-option pill">
            <input type="radio" name="time-range" class="filter-radio" value="90">
            <span class="filter-label">Last 90 Days</span>
          </label>
        </div>
      </div>

      <div class="filter-actions" aria-label="Filter actions">
        <button class="btn btn-sm btn-outline" id="clear-filters" type="button">Clear Filters</button>
        <button class="btn btn-sm btn-primary" id="apply-filters" type="button">Apply</button>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Notifications -->
    <div class="notifications-container" id="notifications" aria-live="polite">
      <% if (success && success.length > 0) { %>
        <div class="notification notification-success" role="status">
          <span class="notification-icon" aria-hidden="true">‚úì</span>
          <span class="notification-text"><%= success %></span>
          <button class="notification-close" type="button" aria-label="Close notification">&times;</button>
        </div>
      <% } %>
      <% if (error && error.length > 0) { %>
        <div class="notification notification-error" role="alert">
          <span class="notification-icon" aria-hidden="true">!</span>
          <span class="notification-text"><%= error %></span>
          <button class="notification-close" type="button" aria-label="Close notification">&times;</button>
        </div>
      <% } %>
    </div>

    <!-- Orders Container -->
    <div class="orders-container" aria-label="Orders list container">
      <div class="orders-header">
        <h2 class="orders-title">Recent Orders</h2>

        <div class="sort-control">
          <label class="sr-only" for="sort-orders">Sort orders</label>
          <select class="sort-select" id="sort-orders" aria-label="Sort orders by">
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="amount-high">Amount (High to Low)</option>
            <option value="amount-low">Amount (Low to High)</option>
          </select>
        </div>
      </div>

      <!-- Orders List -->
      <div id="ordersList" class="orders-grid" aria-live="polite">
        <div class="loading-state" role="status" aria-label="Loading orders">
          <div class="loading-spinner" aria-hidden="true"></div>
          <p>Loading your orders‚Ä¶</p>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="empty-state" style="display: none;">
        <div class="empty-content">
          <span class="empty-icon" aria-hidden="true">üì¶</span>
          <h3>No Orders Found</h3>
          <p>You haven't placed any orders yet, or no orders match your filters.</p>
          <a href="/sales" class="btn btn-primary">Start Shopping</a>
        </div>
      </div>

      <!-- Load More placeholder (kept for future) -->
      <div class="load-more-container">
        <button id="load-more" class="btn btn-outline" style="display: none;" type="button">
          Load More Orders
        </button>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="page-footer" aria-label="Orders help and links">
    <div class="footer-content">
      <div class="footer-section fs-purple">
        <h4>Need Help?</h4>
        <a href="/contact" class="footer-link">Contact Support</a>
        <a href="/help/orders" class="footer-link">Order Help Center</a>
        <a href="/help/shipping" class="footer-link">Shipping Information</a>
      </div>

      <div class="footer-section fs-blue">
        <h4>Quick Actions</h4>
        <button class="footer-action" type="button" onclick="window.print()">
          <span class="action-icon" aria-hidden="true">üñ®Ô∏è</span>
          Print Order History
        </button>
        <button class="footer-action" id="export-orders" type="button">
          <span class="action-icon" aria-hidden="true">üìä</span>
          Export as CSV
        </button>
        <a href="/cart" class="footer-action">
          <span class="action-icon" aria-hidden="true">üõí</span>
          View Cart
        </a>
      </div>

      <div class="footer-section fs-green">
        <h4>Order Status Guide</h4>
        <div class="status-guide">
          <div class="status-item">
            <span class="status-dot pending" aria-hidden="true"></span>
            <span>Pending - Order being processed</span>
          </div>
          <div class="status-item">
            <span class="status-dot shipped" aria-hidden="true"></span>
            <span>Shipped - On its way to you</span>
          </div>
          <div class="status-item">
            <span class="status-dot delivered" aria-hidden="true"></span>
            <span>Delivered - Order received</span>
          </div>
          <div class="status-item">
            <span class="status-dot refunded" aria-hidden="true"></span>
            <span>Refunded - Payment returned</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<style nonce="<%= NONCE %>">
  /* =========================================================
     Brand (Purple dominant) ‚Äî scoped ONLY to .orders-page
     Mobile-first for Hisense U50 Lite
     ========================================================= */
  .orders-page{
    --blue:#2563EB;
    --purple:#7C3AED;  /* dominant */
    --green:#22C55E;
    --black:#0F172A;

    --bg0:#070A13;
    --bg1:#0B1022;
    --panel: rgba(15,23,42,.78);
    --panel2: rgba(17,26,46,.82);
    --line: rgba(148,163,184,.18);
    --muted: rgba(148,163,184,.92);
    --text: rgba(226,232,240,.96);
    --shadow: 0 10px 22px rgba(2,6,23,.35);
    --shadow2: 0 6px 16px rgba(2,6,23,.28);

    --r-lg: 18px;
    --r-md: 14px;
    --r-sm: 10px;

    padding: .85rem;
    min-height: 100vh;
    color: var(--text);

    background:
      radial-gradient(900px 420px at 18% -10%, rgba(124,58,237,.38), transparent 58%),
      radial-gradient(900px 420px at 95% 0%, rgba(37,99,235,.26), transparent 55%),
      radial-gradient(900px 420px at 70% 110%, rgba(34,197,94,.16), transparent 55%),
      linear-gradient(180deg, var(--bg0), var(--bg1));
  }

  /* a11y */
  .orders-page .sr-only{
    position:absolute !important;
    width:1px;height:1px;
    padding:0;margin:-1px;
    overflow:hidden;clip:rect(0,0,0,0);
    white-space:nowrap;border:0;
  }

  /* =========================================================
     Shared card sections (each block has visible color identity)
     ========================================================= */
  .orders-page .page-header,
  .orders-page .orders-container,
  .orders-page .page-footer{
    border-radius: var(--r-lg);
    padding: 1rem;
    box-shadow: var(--shadow);
    border: 1px solid var(--line);
    background: linear-gradient(180deg, rgba(17,26,46,.86), rgba(15,23,42,.86));
  }

  .orders-page .page-header{
    border-color: rgba(124,58,237,.22);
    background: linear-gradient(180deg, rgba(124,58,237,.18), rgba(15,23,42,.88));
  }

  .orders-page .orders-container{
    border-color: rgba(37,99,235,.16);
    background: linear-gradient(180deg, rgba(17,26,46,.88), rgba(15,23,42,.88));
  }

  .orders-page .page-footer{
    border-color: rgba(34,197,94,.14);
    background: linear-gradient(180deg, rgba(34,197,94,.08), rgba(15,23,42,.86));
  }

  /* Layout */
  .orders-page .header-content{
    display:flex;
    gap: 1rem;
    justify-content: space-between;
    align-items: flex-start;
    flex-wrap: wrap;
  }
  .orders-page .user-greeting{ flex:1; min-width: 260px; }

  .orders-page .page-title{
    margin:0;
    font-size: 1.35rem;
    font-weight: 950;
    letter-spacing: .2px;
    background: linear-gradient(135deg, rgba(124,58,237,.98), rgba(37,99,235,.92));
    -webkit-background-clip:text;
    background-clip:text;
    -webkit-text-fill-color: transparent;
  }

  .orders-page .subtitle{
    margin:.35rem 0 0 0;
    color: rgba(226,232,240,.82);
    font-size: .92rem;
    line-height: 1.25;
  }

  /* Summary chips */
  .orders-page .order-summary{
    margin-top:.85rem;
    display:flex;
    flex-wrap: wrap;
    gap:.6rem;
  }
  .orders-page .summary-item{
    display:flex;
    align-items:center;
    gap:.55rem;
    padding:.55rem .75rem;
    border-radius: 999px;
    border: 1px solid var(--line);
    background: rgba(2,6,23,.32);
    box-shadow: var(--shadow2);
  }
  .orders-page .summary-icon{ font-size: 1rem; opacity: .95; }
  .orders-page .summary-value{
    font-weight: 950;
    font-size: 1.02rem;
    color: rgba(226,232,240,.98);
    min-width: 1.6rem;
    text-align:center;
  }
  .orders-page .summary-label{
    font-size: .72rem;
    letter-spacing: .10em;
    text-transform: uppercase;
    color: rgba(148,163,184,.95);
  }
  .orders-page .sum-purple{ border-color: rgba(124,58,237,.28); }
  .orders-page .sum-blue{ border-color: rgba(37,99,235,.28); }
  .orders-page .sum-green{ border-color: rgba(34,197,94,.26); }

  /* Header actions */
  .orders-page .header-actions{
    display:flex;
    gap:.6rem;
    flex-wrap: wrap;
    align-items: flex-end;
  }

  /* Buttons */
  .orders-page .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.45rem;
    padding:.65rem 1rem;
    border-radius: 999px;
    border:1px solid transparent;
    text-decoration:none;
    cursor:pointer;
    font-weight: 850;
    font-size: .92rem;
    transition: transform .12s ease, filter .12s ease, background .12s ease, border-color .12s ease;
    user-select:none;
    white-space: nowrap;
  }
  .orders-page .btn:active{ transform: translateY(1px); }

  .orders-page .btn-primary{
    background: linear-gradient(135deg, rgba(124,58,237,.95), rgba(37,99,235,.9));
    border-color: rgba(124,58,237,.35);
    color: #fff;
    box-shadow: 0 12px 22px rgba(124,58,237,.18);
  }
  .orders-page .btn-primary:hover{ transform: translateY(-1px); filter: brightness(1.03); }

  .orders-page .btn-outline{
    background: rgba(2,6,23,.28);
    border-color: rgba(148,163,184,.22);
    color: rgba(226,232,240,.92);
  }
  .orders-page .btn-outline:hover{
    border-color: rgba(124,58,237,.30);
    background: rgba(124,58,237,.14);
    transform: translateY(-1px);
  }

  .orders-page .btn-sm{
    padding:.55rem .85rem;
    font-size:.82rem;
  }

  /* =========================================================
     Filter panel (compact, mobile friendly)
     ========================================================= */
  .orders-page .filter-panel{
    display:none;
    margin-top: .9rem;
    border-radius: var(--r-lg);
    border: 1px solid rgba(124,58,237,.18);
    background: linear-gradient(180deg, rgba(124,58,237,.10), rgba(15,23,42,.88));
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .orders-page .filter-panel.show{ display:block; animation: slideDown .18s ease; }
  @keyframes slideDown{
    from { opacity:0; transform: translateY(-8px); }
    to { opacity:1; transform: translateY(0); }
  }

  .orders-page .filter-content{
    padding: 1rem;
    display:grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .orders-page .filter-group{
    border-radius: var(--r-md);
    border: 1px solid var(--line);
    background: rgba(2,6,23,.28);
    padding: .85rem;
  }
  .orders-page .fg-purple{ border-color: rgba(124,58,237,.22); }
  .orders-page .fg-blue{ border-color: rgba(37,99,235,.22); }

  .orders-page .filter-title{
    margin:0 0 .65rem 0;
    font-size:.78rem;
    font-weight: 950;
    letter-spacing:.12em;
    text-transform: uppercase;
    color: rgba(226,232,240,.92);
  }

  .orders-page .filter-options{
    display:flex;
    flex-direction: column;
    gap: .5rem;
  }

  .orders-page .filter-option{
    display:flex;
    align-items:center;
    justify-content: space-between;
    gap: .6rem;
    padding: .55rem .6rem;
    border-radius: var(--r-sm);
    border: 1px solid rgba(148,163,184,.14);
    background: rgba(15,23,42,.55);
    cursor:pointer;
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
  }
  .orders-page .filter-option:hover{
    transform: translateY(-1px);
    border-color: rgba(124,58,237,.24);
    background: rgba(124,58,237,.10);
  }

  .orders-page .filter-option .left{
    display:flex;
    align-items:center;
    gap:.55rem;
    min-width: 0;
  }

  .orders-page .filter-checkbox,
  .orders-page .filter-radio{
    accent-color: var(--purple);
  }

  .orders-page .filter-label{
    color: rgba(226,232,240,.90);
    font-size: .9rem;
  }

  .orders-page .filter-count{
    font-size:.78rem;
    color: rgba(226,232,240,.88);
    background: rgba(148,163,184,.14);
    border: 1px solid rgba(148,163,184,.16);
    padding: .15rem .45rem;
    border-radius: 999px;
    min-width: 1.8rem;
    text-align:center;
  }

  .orders-page .filter-options.time-range{
    flex-direction: row;
    flex-wrap: wrap;
    gap: .55rem;
  }

  .orders-page .filter-option.pill{
    justify-content:flex-start;
    gap:.5rem;
    padding:.55rem .7rem;
    border-radius: 999px;
  }

  .orders-page .filter-actions{
    display:flex;
    gap:.6rem;
    justify-content:flex-end;
  }

  /* =========================================================
     Main + notifications
     ========================================================= */
  .orders-page .main-content{
    margin-top: .9rem;
    display:flex;
    flex-direction: column;
    gap: .9rem;
  }

  .orders-page .notifications-container{
    display:flex;
    flex-direction: column;
    gap:.5rem;
  }

  .orders-page .notification{
    display:flex;
    align-items:center;
    gap:.65rem;
    padding:.75rem .85rem;
    border-radius: var(--r-md);
    border:1px solid var(--line);
    background: rgba(15,23,42,.70);
    box-shadow: var(--shadow2);
  }

  .orders-page .notification-success{
    border-color: rgba(34,197,94,.25);
    background: linear-gradient(180deg, rgba(34,197,94,.12), rgba(15,23,42,.75));
  }
  .orders-page .notification-error{
    border-color: rgba(239,68,68,.25);
    background: linear-gradient(180deg, rgba(239,68,68,.12), rgba(15,23,42,.75));
  }
  .orders-page .notification-text{
    color: rgba(226,232,240,.95);
    font-size:.92rem;
  }
  .orders-page .notification-close{
    margin-left:auto;
    border:0;
    background: transparent;
    color: rgba(226,232,240,.85);
    font-size: 1.2rem;
    cursor:pointer;
    opacity:.85;
  }
  .orders-page .notification-close:hover{ opacity:1; }

  /* =========================================================
     Orders list header + sort select
     ========================================================= */
  .orders-page .orders-header{
    display:flex;
    justify-content: space-between;
    align-items:center;
    flex-wrap: wrap;
    gap:.75rem;
    margin-bottom: .85rem;
  }
  .orders-page .orders-title{
    margin:0;
    font-size: 1.05rem;
    font-weight: 950;
    color: rgba(226,232,240,.96);
  }

  .orders-page .sort-select{
    width: 100%;
    min-width: 170px;
    appearance: none;
    border-radius: 999px;
    border: 1px solid rgba(37,99,235,.28);
    background: rgba(2,6,23,.30);
    color: rgba(226,232,240,.95);
    padding: .65rem 2.2rem .65rem 1rem;
    font-size: .92rem;
    cursor: pointer;
    outline: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23CBD5E1'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
    background-repeat:no-repeat;
    background-position:right .85rem center;
    background-size: 1rem;
  }
  .orders-page .sort-select:focus{
    border-color: rgba(37,99,235,.55);
    box-shadow: 0 0 0 3px rgba(37,99,235,.18);
  }

  /* =========================================================
     Order cards (colors visible per status)
     ========================================================= */
  .orders-page .orders-grid{
    display:flex;
    flex-direction: column;
    gap:.75rem;
  }

  .orders-page .order-card{
    border-radius: var(--r-md);
    border: 1px solid rgba(148,163,184,.16);
    background: linear-gradient(180deg, rgba(15,23,42,.82), rgba(2,6,23,.32));
    padding: .95rem;
    position: relative;
    overflow:hidden;
    box-shadow: 0 10px 18px rgba(2,6,23,.22);
    transition: transform .12s ease, border-color .12s ease, box-shadow .12s ease;
  }

  /* IMPORTANT: don't block clicks */
  .orders-page .order-card::before{
    content:'';
    position:absolute;
    top:0; left:0;
    width: 4px;
    height:100%;
    background: rgba(148,163,184,.35);
    pointer-events:none;
  }

  .orders-page .order-card:hover{
    transform: translateY(-2px);
    border-color: rgba(124,58,237,.30);
    box-shadow: 0 14px 28px rgba(2,6,23,.28);
  }

  .orders-page .order-card.pending::before{ background:#F59E0B; }
  .orders-page .order-card.shipped::before{ background: var(--blue); }
  .orders-page .order-card.delivered::before{ background: var(--green); }
  .orders-page .order-card.cancelled::before{ background:#EF4444; }
  .orders-page .order-card.refunded::before{ background:#F97316; }

  .orders-page .order-header{
    display:flex;
    justify-content: space-between;
    align-items:flex-start;
    gap: .75rem;
    flex-wrap: wrap;
    margin-bottom: .65rem;
  }

  .orders-page .order-id{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: .88rem;
    font-weight: 850;
    color: rgba(226,232,240,.96);
  }

  .orders-page .order-meta{
    display:flex;
    align-items:center;
    gap:.55rem;
    flex-wrap: wrap;
  }

  .orders-page .order-date{
    font-size: .86rem;
    color: rgba(148,163,184,.92);
  }

  .orders-page .order-status{
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    padding:.28rem .65rem;
    border-radius: 999px;
    font-size:.72rem;
    font-weight: 950;
    letter-spacing:.08em;
    text-transform: uppercase;
    border:1px solid transparent;
  }
  .orders-page .order-status.pending{ background: rgba(245,158,11,.12); color:#FBBF24; border-color: rgba(245,158,11,.22); }
  .orders-page .order-status.shipped{ background: rgba(37,99,235,.12); color:#93C5FD; border-color: rgba(37,99,235,.22); }
  .orders-page .order-status.delivered{ background: rgba(34,197,94,.12); color:#86EFAC; border-color: rgba(34,197,94,.22); }
  .orders-page .order-status.cancelled{ background: rgba(239,68,68,.12); color:#FCA5A5; border-color: rgba(239,68,68,.22); }
  .orders-page .order-status.refunded{ background: rgba(249,115,22,.12); color:#FDBA74; border-color: rgba(249,115,22,.22); }

  .orders-page .order-content{
    display:grid;
    grid-template-columns: 1fr;
    gap: .85rem;
  }

  .orders-page .order-details{
    display:flex;
    flex-direction: column;
    gap: .6rem;
  }

  .orders-page .order-amount{
    font-size: 1.05rem;
    font-weight: 950;
    color: rgba(226,232,240,.98);
    text-shadow: 0 8px 20px rgba(124,58,237,.10);
  }
  .orders-page .order-amount .currency{
    color: rgba(34,197,94,.90);
    margin-right: .15rem;
  }

  .orders-page .shipping-info{
    display:flex;
    align-items:center;
    gap:.5rem;
    font-size: .88rem;
    color: rgba(148,163,184,.92);
    flex-wrap: wrap;
  }

  .orders-page .tracking-number{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    font-size: .78rem;
    background: rgba(148,163,184,.12);
    border: 1px solid rgba(148,163,184,.16);
    padding: .15rem .45rem;
    border-radius: 999px;
    color: rgba(226,232,240,.90);
  }

  .orders-page .order-actions{
    display:flex;
    gap:.5rem;
    flex-wrap: wrap;
  }

  .orders-page .action-btn{
    flex: 1;
    min-width: 120px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.45rem;
    padding:.6rem .75rem;
    border-radius: 999px;
    font-size: .86rem;
    font-weight: 950;
    text-decoration:none;
    cursor:pointer;
    border: 1px solid transparent;
    transition: transform .12s ease, background .12s ease, border-color .12s ease;
    user-select:none;
  }

  /* Receipt = purple (dominant) */
  .orders-page .action-btn.receipt{
    background: rgba(124,58,237,.14);
    color: rgba(226,232,240,.95);
    border-color: rgba(124,58,237,.30);
  }
  .orders-page .action-btn.receipt:hover{ background: rgba(124,58,237,.28); transform: translateY(-1px); }

  /* Track = blue */
  .orders-page .action-btn.track{
    background: rgba(37,99,235,.14);
    color: rgba(226,232,240,.95);
    border-color: rgba(37,99,235,.30);
  }
  .orders-page .action-btn.track:hover{ background: rgba(37,99,235,.28); transform: translateY(-1px); }

  /* Details = green */
  .orders-page .action-btn.details{
    background: rgba(34,197,94,.14);
    color: rgba(226,232,240,.95);
    border-color: rgba(34,197,94,.30);
  }
  .orders-page .action-btn.details:hover{ background: rgba(34,197,94,.28); transform: translateY(-1px); }

  /* Items row */
  .orders-page .order-items{
    margin-top: .75rem;
    padding-top: .75rem;
    border-top: 1px solid rgba(148,163,184,.14);
  }
  .orders-page .items-label{
    font-size: .82rem;
    font-weight: 950;
    color: rgba(226,232,240,.90);
    margin-bottom: .45rem;
  }
  .orders-page .items-list{
    display:flex;
    gap:.45rem;
    overflow-x:auto;
    padding-bottom:.25rem;
  }
  .orders-page .item-preview{
    flex-shrink:0;
    width: 46px;
    height: 46px;
    border-radius: 12px;
    overflow:hidden;
    border: 1px solid rgba(148,163,184,.16);
    background: rgba(2,6,23,.28);
  }
  .orders-page .item-preview img{ width:100%; height:100%; object-fit: cover; }
  .orders-page .item-preview.placeholder{
    display:flex; align-items:center; justify-content:center;
    color: rgba(226,232,240,.88);
    font-weight: 950;
    font-size: .85rem;
    background: rgba(148,163,184,.12);
  }

  /* Loading / empty */
  .orders-page .loading-state{
    display:flex;
    flex-direction: column;
    align-items:center;
    gap:.75rem;
    padding: 2.2rem 1rem;
    color: rgba(148,163,184,.95);
  }
  .orders-page .loading-spinner{
    width: 38px;
    height: 38px;
    border-radius: 50%;
    border: 3px solid rgba(148,163,184,.18);
    border-top-color: rgba(124,58,237,.85);
    animation: spin 1s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  .orders-page .empty-state{ padding: 2.2rem 1rem; text-align:center; }
  .orders-page .empty-content{
    display:flex;
    flex-direction: column;
    align-items:center;
    gap:.75rem;
    color: rgba(148,163,184,.95);
  }
  .orders-page .empty-icon{ font-size: 2.6rem; opacity: .85; }

  /* Footer */
  .orders-page .footer-content{
    display:grid;
    grid-template-columns: 1fr;
    gap: 1rem;
  }

  .orders-page .footer-section{
    padding: .85rem;
    border-radius: var(--r-md);
    border: 1px solid var(--line);
    background: rgba(2,6,23,.22);
  }
  .orders-page .fs-purple{ border-color: rgba(124,58,237,.22); }
  .orders-page .fs-blue{ border-color: rgba(37,99,235,.22); }
  .orders-page .fs-green{ border-color: rgba(34,197,94,.22); }

  .orders-page .footer-section h4{
    margin:0 0 .6rem 0;
    font-size:.78rem;
    font-weight: 950;
    letter-spacing:.12em;
    text-transform: uppercase;
    color: rgba(226,232,240,.92);
  }

  .orders-page .footer-link{
    display:block;
    padding:.45rem 0;
    color: rgba(148,163,184,.98);
    text-decoration:none;
    font-size:.90rem;
  }
  .orders-page .footer-link:hover{ color: rgba(226,232,240,.96); }

  .orders-page .footer-action{
    width:100%;
    text-align:left;
    display:flex;
    gap:.55rem;
    align-items:center;
    padding:.45rem 0;
    border:0;
    background: transparent;
    color: rgba(148,163,184,.98);
    cursor:pointer;
    font-size:.90rem;
    text-decoration:none;
  }
  .orders-page .footer-action:hover{ color: rgba(226,232,240,.96); }

  .orders-page .status-guide{ display:flex; flex-direction: column; gap:.45rem; }
  .orders-page .status-item{ display:flex; align-items:center; gap:.55rem; color: rgba(148,163,184,.98); font-size:.90rem; }
  .orders-page .status-dot{ width: 9px; height: 9px; border-radius: 50%; }
  .orders-page .status-dot.pending{ background:#F59E0B; }
  .orders-page .status-dot.shipped{ background: var(--blue); }
  .orders-page .status-dot.delivered{ background: var(--green); }
  .orders-page .status-dot.refunded{ background:#F97316; }

  /* =========================================================
     Responsive (Hisense U50 Lite friendly)
     ========================================================= */
  @media (min-width: 520px){
    .orders-page .filter-content{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .orders-page .filter-actions{ grid-column: 1 / -1; }
    .orders-page .footer-content{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    .orders-page .order-content{ grid-template-columns: 1fr auto; align-items: start; }
    .orders-page .order-actions{ flex-direction: column; min-width: 210px; }
    .orders-page .action-btn{ min-width: 190px; }
  }

  @media (max-width: 520px){
    .orders-page{ padding: .7rem; }
    .orders-page .header-actions{ width:100%; }
    .orders-page .btn{ width:100%; }
    .orders-page .sort-control{ width:100%; }
    .orders-page .sort-select{ min-width: 0; }
    .orders-page .filter-actions{ flex-direction: column; }
    .orders-page .filter-actions .btn{ width:100%; }
  }

  @media (prefers-reduced-motion: reduce){
    *{ transition:none !important; animation:none !important; }
  }
  .orders-page .variants-row{
  display:flex;
  flex-wrap:wrap;
  gap:.35rem;
  margin-top:.55rem;
}

.orders-page .variant-chip{
  font-size: .72rem;
  font-weight: 950;
  padding: .18rem .55rem;
  border-radius: 999px;
  border: 1px solid rgba(124,58,237,.28);
  background: rgba(124,58,237,.12);
  color: rgba(226,232,240,.92);
}

.orders-page .variant-chip.more{
  border-color: rgba(34,197,94,.25);
  background: rgba(34,197,94,.10);
}

</style>

<script nonce="<%= NONCE %>">
  (function () {
    const ordersList = document.getElementById('ordersList');
    const emptyState = document.getElementById('empty-state');
    const filterPanel = document.getElementById('filter-panel');
    const filterToggle = document.getElementById('filter-toggle');
    const applyFiltersBtn = document.getElementById('apply-filters');
    const clearFiltersBtn = document.getElementById('clear-filters');
    const sortSelect = document.getElementById('sort-orders');
    const exportBtn = document.getElementById('export-orders');

    const elTotal = document.getElementById('total-orders');
    const elCompleted = document.getElementById('completed-orders');
    const elShipped = document.getElementById('shipped-orders');

    let allOrders = [];
    let filteredOrders = [];
    let currentFilters = { status: ['all'], timeRange: 'all' };
    let currentSort = 'newest';
    let isLoading = false;

    function toNum(v, fallback = 0) {
      const n = Number(String(v ?? '').trim());
      return Number.isFinite(n) ? n : fallback;
    }

    function currencySymbol(ccy) {
      const symbols = { USD: '$', ZAR: 'R', EUR: '‚Ç¨', GBP: '¬£' };
      const up = String(ccy || '').toUpperCase();
      return symbols[up] || (up ? up + ' ' : '');
    }

    function formatDate(dateString) {
      try {
        const date = new Date(dateString);
        if (isNaN(date.getTime())) return '‚Äî';
        return date.toLocaleDateString('en-ZA', { day: 'numeric', month: 'short', year: 'numeric' });
      } catch {
        return '‚Äî';
      }
    }

    function normalizeStatus(order) {
      const s = String(order?.status || '').toLowerCase();
      const ps = String(order?.paymentStatus || '').toLowerCase();

      if (ps.includes('refunded') || s.includes('refunded')) return 'refunded';
      if (ps.includes('partially_refunded') || s.includes('partially_refunded')) return 'refunded';

      if (s.includes('shipped') || s.includes('transit')) return 'shipped';
      if (s.includes('delivered') || s.includes('completed')) return 'delivered';

      if (s.includes('cancelled') || s.includes('canceled')) return 'cancelled';
      return 'pending';
    }

    function statusLabel(norm, rawStatus) {
      if (norm === 'refunded') return 'Refunded';
      if (norm === 'shipped') return 'Shipped';
      if (norm === 'delivered') return 'Delivered';
      if (norm === 'cancelled') return 'Cancelled';
      return rawStatus || 'Pending';
    }

    function statusIcon(norm) {
      if (norm === 'refunded') return '‚Ü©Ô∏è';
      if (norm === 'shipped') return 'üöö';
      if (norm === 'delivered') return '‚úÖ';
      if (norm === 'cancelled') return '‚ùå';
      return '‚è≥';
    }

    function getShipmentStatus(status) {
      if (!status) return 'Pending';
      status = String(status).toLowerCase();
      const statusMap = {
        pending: 'Pending',
        processing: 'Processing',
        shipped: 'Shipped',
        in_transit: 'In Transit',
        delivered: 'Delivered',
        cancelled: 'Cancelled',
      };
      return statusMap[status] || status;
    }

    function getShipmentIcon(status) {
      if (!status) return 'üì¶';
      status = String(status).toLowerCase();
      if (status === 'delivered') return '‚úÖ';
      if (status === 'shipped' || status === 'in_transit') return 'üöö';
      if (status === 'processing') return '‚öôÔ∏è';
      if (status === 'cancelled') return '‚ùå';
      return 'üì¶';
    }

    function setupNotifications() {
      document.querySelectorAll('.notification-close').forEach((button) => {
        button.addEventListener('click', (e) => {
          const notification = e.target.closest('.notification');
          if (!notification) return;
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 200);
        });
      });

      setTimeout(() => {
        document.querySelectorAll('.notification-success').forEach((notification) => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 200);
        });
      }, 5000);
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function variantSummary(item) {
      const v = item?.variants || {};
      const size = (v.size ?? item?.size ?? '').toString().trim();
      const color = (v.color ?? item?.color ?? '').toString().trim();

      if (!size && !color) return '';
      if (size && color) return `Size ${size} ‚Ä¢ Color ${color}`;
      if (size) return `Size ${size}`;
      return `Color ${color}`;
    }

    function createOrderCard(order) {
      const internalId = String(order.id || order._id || '').trim();
      const orderId = String(order.orderId || '').trim();

      const displayId = (orderId || internalId || '').slice(-8) || '‚Äî';
      const date = formatDate(order.createdAt);

      const norm = normalizeStatus(order);
      const icon = statusIcon(norm);
      const label = statusLabel(norm, order.status);

      const shipment = order.shippingTracking || {};
      const shipmentStatusText = getShipmentStatus(shipment.status || '');
      const shipmentIcon = getShipmentIcon(shipment.status || '');
      const trackingNumber = String(shipment.trackingNumber || '').trim();
      const carrier = String(shipment.carrierLabel || shipment.carrier || '').trim();

      const items = Array.isArray(order.items) ? order.items : [];
      const variantLines = items
        .map(variantSummary)
        .filter(Boolean);

      const variantChips = variantLines
        .slice(0, 3)
        .map((t) => `<span class="variant-chip">${escapeHtml(t)}</span>`)
        .join('');

      const moreVariants = variantLines.length > 3 ? (variantLines.length - 3) : 0;

      const itemsHtml = items.slice(0, 5).map((item) => {
        const name = item?.name || '';
        const img = item?.imageUrl || '';
        if (img) {
          return `<div class="item-preview"><img src="${escapeHtml(img)}" alt="${escapeHtml(name)}"></div>`;
        }
        return `<div class="item-preview placeholder">${escapeHtml((name.charAt(0) || '?').toUpperCase())}</div>`;
      }).join('');

      // ‚úÖ DO NOT CHANGE PATHS/LINKS
      let receiptHref = '#';
      if (order?.receiptLink) receiptHref = String(order.receiptLink);
      else if (orderId) receiptHref = `/payment/receipt/${encodeURIComponent(orderId)}`;
      else if (internalId) receiptHref = `/payment/receipt/${encodeURIComponent(internalId)}`;

      const receiptDisabled = (receiptHref === '#');

      const trackHref = internalId ? `/orders/${encodeURIComponent(internalId)}/track` : '';
      const detailsHref = internalId ? `/orders/${encodeURIComponent(internalId)}` : '';

      const amountNumber = toNum(order.amount, 0);
      const currency = String(order.currency || 'USD').toUpperCase();

      return `
        <div class="order-card ${escapeHtml(norm)}">
          <div class="order-header">
            <div class="order-id">Order #${escapeHtml(displayId)}</div>
            <div class="order-meta">
              <span class="order-date">${escapeHtml(date)}</span>
              <span class="order-status ${escapeHtml(norm)}">${escapeHtml(icon)} ${escapeHtml(label)}</span>
            </div>
          </div>

          <div class="order-content">
            <div class="order-details">
              <div class="order-amount">
                <span class="currency">${escapeHtml(currencySymbol(currency))}</span>
                <span>${escapeHtml(amountNumber.toFixed(2))}</span>
              </div>

              <div class="order-shipping">
                <div class="shipping-info">
                  <span class="shipping-icon">${escapeHtml(shipmentIcon)}</span>
                  <span>${escapeHtml(shipmentStatusText)}</span>
                  ${carrier ? `<span>‚Ä¢ ${escapeHtml(carrier)}</span>` : ''}
                </div>

                ${trackingNumber ? `
                  <div class="shipping-info">
                    <span class="shipping-icon">#</span>
                    <span class="tracking-number">${escapeHtml(trackingNumber.slice(-8))}</span>
                  </div>
                ` : ''}
              </div>
            </div>

            <div class="order-actions">
              <a href="${escapeHtml(receiptHref)}"
                 class="action-btn receipt"
                 title="${receiptDisabled ? 'Receipt not available yet' : 'View receipt'}"
                 ${receiptDisabled ? 'aria-disabled="true" onclick="return false;" style="opacity:.55;pointer-events:none;"' : ''}>
                <span class="btn-icon" aria-hidden="true">üìÑ</span>
                Receipt
              </a>

              ${trackHref ? `
                <a href="${escapeHtml(trackHref)}" class="action-btn track" title="Track shipment">
                  <span class="btn-icon" aria-hidden="true">üöö</span>
                  Track
                </a>
              ` : ''}

              ${detailsHref ? `
                <a href="${escapeHtml(detailsHref)}" class="action-btn details" title="Order details">
                  <span class="btn-icon" aria-hidden="true">üëÅÔ∏è</span>
                  Details
                </a>
              ` : ''}
            </div>
          </div>

         ${items.length > 0 ? `
          <div class="order-items">
            <div class="items-label">Items (${items.length})</div>

            <div class="items-list">
              ${itemsHtml}
              ${items.length > 5 ? `<div class="item-preview placeholder">+${items.length - 5}</div>` : ''}
            </div>

            ${variantChips ? `
              <div class="variants-row" aria-label="Selected variants">
                ${variantChips}
                ${moreVariants ? `<span class="variant-chip more">+${moreVariants} more</span>` : ''}
              </div>
            ` : ''}
          </div>
        ` : ''}
        </div>
      `;
    }

    async function loadOrders() {
      if (isLoading) return;
      isLoading = true;

      ordersList.innerHTML =
        '<div class="loading-state"><div class="loading-spinner"></div><p>Loading your orders‚Ä¶</p></div>';
      emptyState.style.display = 'none';

      try {
        const response = await fetch('/payment/my-orders', {
          credentials: 'same-origin',
          cache: 'no-store',
          headers: { 'Accept': 'application/json' },
        });

        const data = await response.json().catch(() => ({}));
        if (!response.ok || !data?.ok) throw new Error(data?.error || `Failed to load orders (${response.status})`);

        allOrders = Array.isArray(data.orders) ? data.orders : [];
        updateOrderSummary();
        updateFilterCounts();
        applyFiltersAndSort();

        if (allOrders.length === 0) showEmptyState();
      } catch (error) {
        console.error('Error loading orders:', error);
        ordersList.innerHTML = `
          <div class="empty-state">
            <div class="empty-content">
              <span class="empty-icon" aria-hidden="true">‚ö†Ô∏è</span>
              <h3>Unable to Load Orders</h3>
              <p>${escapeHtml(String(error?.message || 'Please try again later.'))}</p>
              <button type="button" onclick="window.location.reload()" class="btn btn-primary">Retry</button>
            </div>
          </div>
        `;
      } finally {
        isLoading = false;
      }
    }

    function updateOrderSummary() {
      const total = allOrders.length;
      const delivered = allOrders.filter((o) => normalizeStatus(o) === 'delivered').length;
      const shipped = allOrders.filter((o) => normalizeStatus(o) === 'shipped').length;

      if (elTotal) elTotal.textContent = String(total);
      if (elCompleted) elCompleted.textContent = String(delivered);
      if (elShipped) elShipped.textContent = String(shipped);
    }

    function updateFilterCounts() {
      const counts = { all: 0, pending: 0, shipped: 0, delivered: 0, cancelled: 0 };

      for (const o of allOrders) {
        counts.all++;
        const norm = normalizeStatus(o);
        if (norm === 'pending') counts.pending++;
        else if (norm === 'shipped') counts.shipped++;
        else if (norm === 'delivered') counts.delivered++;
        else counts.cancelled++; // cancelled/refunded grouped
      }

      const set = (id, v) => {
        const el = document.getElementById(id);
        if (el) el.textContent = String(v);
      };

      set('count-all', counts.all);
      set('count-pending', counts.pending);
      set('count-shipped', counts.shipped);
      set('count-delivered', counts.delivered);
      set('count-cancelled', counts.cancelled);
    }

    function applyFiltersAndSort() {
      let filtered = [...allOrders];

      if (!currentFilters.status.includes('all')) {
        filtered = filtered.filter((order) => {
          const norm = normalizeStatus(order);
          return currentFilters.status.some((filter) => {
            if (filter === 'pending') return norm === 'pending';
            if (filter === 'shipped') return norm === 'shipped';
            if (filter === 'delivered') return norm === 'delivered';
            if (filter === 'cancelled') return norm === 'cancelled' || norm === 'refunded';
            return false;
          });
        });
      }

      if (currentFilters.timeRange !== 'all') {
        const days = Math.max(1, parseInt(currentFilters.timeRange, 10) || 0);
        const cutoff = new Date();
        cutoff.setDate(cutoff.getDate() - days);

        filtered = filtered.filter((order) => {
          const d = new Date(order.createdAt);
          return !isNaN(d.getTime()) && d >= cutoff;
        });
      }

      filtered.sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        const amountA = toNum(a.amount, 0);
        const amountB = toNum(b.amount, 0);

        switch (currentSort) {
          case 'oldest': return dateA - dateB;
          case 'amount-high': return amountB - amountA;
          case 'amount-low': return amountA - amountB;
          case 'newest':
          default: return dateB - dateA;
        }
      });

      filteredOrders = filtered;
      renderOrders();
    }

    function renderOrders() {
      if (filteredOrders.length === 0) return showEmptyState();
      ordersList.innerHTML = filteredOrders.map((o) => createOrderCard(o)).join('');
      emptyState.style.display = 'none';
    }

    function showEmptyState() {
      ordersList.innerHTML = '';
      emptyState.style.display = 'block';
    }

    function exportToCSV() {
      const headers = ['Order ID', 'Date', 'Status', 'Amount', 'Currency', 'Shipping Status', 'Tracking Number', 'Receipt'];
      const rows = filteredOrders.map((order) => {
        const shipment = order.shippingTracking || {};
        const norm = normalizeStatus(order);

        const internalId = String(order.id || order._id || '').trim();
        const orderId = String(order.orderId || '').trim();
        let receiptHref = '';
        if (order?.receiptLink) receiptHref = String(order.receiptLink);
        else if (orderId) receiptHref = `/payment/receipt/${orderId}`;
        else if (internalId) receiptHref = `/payment/receipt/${internalId}`;

        return [
          orderId || internalId || '',
          formatDate(order.createdAt),
          statusLabel(norm, order.status),
          toNum(order.amount, 0).toFixed(2),
          String(order.currency || 'USD').toUpperCase(),
          getShipmentStatus(shipment.status),
          shipment.trackingNumber || '',
          receiptHref || '',
        ];
      });

      const csv = [
        headers.join(','),
        ...rows.map((row) => row.map((cell) => `"${String(cell ?? '').replaceAll('"', '""')}"`).join(',')),
      ].join('\n');

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `orders-${new Date().toISOString().slice(0, 10)}.csv`;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }

    function syncFilterPanelA11y() {
      const isOpen = filterPanel.classList.contains('show');
      filterPanel.setAttribute('aria-hidden', String(!isOpen));
      filterToggle.setAttribute('aria-expanded', String(isOpen));
    }

    function setupAllCheckboxBehavior() {
      const allCb = document.querySelector('.filter-checkbox[value="all"]');
      const otherCbs = Array.from(document.querySelectorAll('.filter-checkbox')).filter((cb) => cb.value !== 'all');
      if (!allCb) return;

      allCb.addEventListener('change', () => {
        if (allCb.checked) {
          otherCbs.forEach((cb) => (cb.checked = false));
        } else {
          // never allow "no selection" ‚Äî if user unchecks all, turn it back on
          const anyOtherChecked = otherCbs.some((cb) => cb.checked);
          if (!anyOtherChecked) allCb.checked = true;
        }
      });

      otherCbs.forEach((cb) => {
        cb.addEventListener('change', () => {
          const anyOtherChecked = otherCbs.some((x) => x.checked);
          if (anyOtherChecked) allCb.checked = false;
          else allCb.checked = true;
        });
      });
    }

    function setupEventListeners() {
      if (filterToggle) {
        filterToggle.addEventListener('click', () => {
          filterPanel.classList.toggle('show');
          syncFilterPanelA11y();
        });
      }

      if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', () => {
          const checked = document.querySelectorAll('.filter-checkbox:checked');
          currentFilters.status = Array.from(checked).map((cb) => cb.value);

          const timeRangeRadio = document.querySelector('.filter-radio:checked');
          currentFilters.timeRange = timeRangeRadio ? timeRangeRadio.value : 'all';

          applyFiltersAndSort();
          filterPanel.classList.remove('show');
          syncFilterPanelA11y();
        });
      }

      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
          document.querySelectorAll('.filter-checkbox').forEach((cb) => (cb.checked = cb.value === 'all'));
          document.querySelectorAll('.filter-radio').forEach((rb) => (rb.checked = rb.value === 'all'));
          currentFilters = { status: ['all'], timeRange: 'all' };
          applyFiltersAndSort();
        });
      }

      if (sortSelect) {
        sortSelect.addEventListener('change', (e) => {
          currentSort = e.target.value;
          applyFiltersAndSort();
        });
      }

      if (exportBtn) exportBtn.addEventListener('click', exportToCSV);
    }

    document.addEventListener('DOMContentLoaded', () => {
      setupNotifications();
      setupEventListeners();
      setupAllCheckboxBehavior();
      syncFilterPanelA11y();
      loadOrders();
    });

    window.ordersApp = { loadOrders, applyFiltersAndSort, exportToCSV };
  })();
</script>
