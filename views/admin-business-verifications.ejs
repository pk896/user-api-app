<!-- views/admin-business-verifications.ejs -->
<% const NONCE = typeof nonce !== 'undefined' ? nonce : '' %>

<%
  const f = filters || { status: 'pending', q: '', country: '', page: 1, totalPages: 1, total: 0 };
  const safe = (v, d='') => (typeof v === 'string' ? v : (v == null ? d : String(v)));
  const buildHref = (p) =>
    `/admin/business-verifications?status=${encodeURIComponent(f.status)}&q=${encodeURIComponent(safe(f.q))}&country=${encodeURIComponent(safe(f.country))}&page=${p}`;
%>

<section class="abv-page">
  <div class="abv-wrap">

    <!-- Header (Purple dominant) -->
    <header class="abv-hdr">
      <div class="abv-hdr-left">
        <div class="abv-badge">ADMIN</div>
        <div class="abv-title-wrap">
          <h1 class="abv-title"><%= title %></h1>
          <p class="abv-sub">Verify official numbers, review details, approve/reject.</p>
        </div>
      </div>

      <div class="abv-hdr-right">
        <button id="exportBtn" class="abv-btn abv-btn-purple" type="button">Export CSV</button>
      </div>
    </header>

    <!-- Filters -->
    <section class="abv-card abv-card-purple">
      <div class="abv-card-h abv-row">
        <div>
          <h2 class="abv-h2">Filters</h2>
          <p class="abv-sub2">Search quickly and filter by status/country. Status auto-applies when changed.</p>
        </div>
        <div class="abv-chips">
          <span class="abv-chip"><span class="dot dot-p"></span> Purple <b>#7C3AED</b></span>
          <span class="abv-chip"><span class="dot dot-b"></span> Blue <b>#2563EB</b></span>
          <span class="abv-chip"><span class="dot dot-g"></span> Green <b>#22C55E</b></span>
          <span class="abv-chip"><span class="dot dot-k"></span> Black <b>#0F172A</b></span>
        </div>
      </div>

      <form method="GET" action="/admin/business-verifications" id="filterForm" class="abv-grid" autocomplete="off">
        <div class="abv-field">
          <label for="q" class="abv-lbl">Search</label>
          <input
            id="q"
            name="q"
            value="<%= safe(f.q) %>"
            placeholder="Business name, email, official #, ID‚Ä¶"
            autocomplete="off"
          />
          <div class="abv-hint">Tip: try ‚Äú@gmail‚Äù or part of official number.</div>
        </div>

        <div class="abv-field">
          <label for="country" class="abv-lbl">Country</label>
          <input
            id="country"
            name="country"
            value="<%= safe(f.country) %>"
            placeholder="e.g. South Africa"
            autocomplete="off"
          />
          <div class="abv-hint">Exact or partial country works.</div>
        </div>

        <div class="abv-field">
          <label for="status" class="abv-lbl">Status</label>
          <select name="status" id="status">
            <option value="all" <%= f.status==='all'?'selected':'' %>>All</option>
            <option value="pending" <%= f.status==='pending'?'selected':'' %>>Pending</option>
            <option value="verified" <%= f.status==='verified'?'selected':'' %>>Verified</option>
            <option value="rejected" <%= f.status==='rejected'?'selected':'' %>>Rejected</option>
          </select>
          <div class="abv-hint">Auto-applies when changed.</div>
        </div>

        <div class="abv-actions">
          <button class="abv-btn abv-btn-blue" type="submit">Apply</button>
          <a href="/admin/business-verifications" class="abv-btn abv-btn-ghost">Clear</a>
        </div>
      </form>
    </section>

    <!-- Meta KPIs -->
    <section class="abv-kpis">
      <div class="abv-kpi abv-kpi-purple">
        <div class="abv-kpi-l">Showing</div>
        <div class="abv-kpi-v"><%= (items||[]).length %> <span class="abv-kpi-m">/ <%= f.total %></span></div>
      </div>

      <div class="abv-kpi abv-kpi-blue">
        <div class="abv-kpi-l">Page</div>
        <div class="abv-kpi-v"><%= f.page %> <span class="abv-kpi-m">/ <%= f.totalPages %></span></div>
      </div>

      <div class="abv-kpi abv-kpi-green">
        <div class="abv-kpi-l">Status filter</div>
        <div class="abv-kpi-v"><%= (safe(f.status)||'pending').toUpperCase() %></div>
      </div>
    </section>

    <!-- Cards -->
    <section class="abv-cards">
      <% if (!items || items.length === 0) { %>
        <div class="abv-empty">
          <div class="abv-empty-ic">üòï</div>
          <div class="abv-empty-t">No verification requests</div>
          <div class="abv-empty-s">Try changing filters above.</div>
        </div>
      <% } %>

      <% (items || []).forEach(b => {
        const status = (b.verification?.status || 'pending').toLowerCase();
        const statusLabel = status.charAt(0).toUpperCase() + status.slice(1);
        const tone = status === 'verified' ? 'tone-green' : (status === 'rejected' ? 'tone-red' : 'tone-amber');

        const role = b.role || '‚Äî';
        const name = b.name || '‚Äî';
        const email = b.email || '‚Äî';
        const created = b.createdAt ? new Date(b.createdAt).toLocaleDateString() : '‚Äî';
        const internalId = b.internalBusinessId;
        const country = b.country || '‚Äî';
        const offNum = b.officialNumber || '‚Äî';
        const offType = b.officialNumberType || '‚Äî';
      %>

        <article class="abv-card2 <%= tone %>">
          <div class="abv-top">
            <div class="abv-left">
              <div class="abv-avatar"><%= String(name).trim().charAt(0).toUpperCase() %></div>

              <div class="abv-main">
                <div class="abv-name-row">
                  <h3 class="abv-name"><%= name %></h3>
                  <span class="abv-status abv-status-<%= status %>"><%= statusLabel %></span>
                </div>

                <div class="abv-subrow">
                  <span class="abv-pill abv-pill-black"><%= role %></span>
                  <% if (internalId) { %>
                    <span class="abv-pill abv-pill-purple">ID: <%= internalId %></span>
                  <% } %>
                  <span class="abv-pill abv-pill-blue"><%= created %></span>
                </div>

                <div class="abv-email"><%= email %></div>
              </div>
            </div>

            <div class="abv-right">
              <a href="/admin/business-verifications/<%= b._id %>" class="abv-btn abv-btn-mini abv-btn-purple">Review ‚Üí</a>
            </div>
          </div>

          <div class="abv-body">
            <div class="abv-kv">
              <div class="abv-k">Country</div>
              <div class="abv-v"><%= country %></div>
            </div>

            <div class="abv-kv">
              <div class="abv-k">Official #</div>
              <div class="abv-v abv-mono"><%= offNum %></div>
            </div>

            <div class="abv-kv">
              <div class="abv-k">Type</div>
              <div class="abv-v"><%= offType %></div>
            </div>

            <div class="abv-kv">
              <div class="abv-k">Action</div>
              <div class="abv-v">
                <a href="/admin/business-verifications/<%= b._id %>" class="abv-link">Open verification</a>
              </div>
            </div>
          </div>
        </article>

      <% }) %>
    </section>

    <!-- Pagination -->
    <% if (f.totalPages > 1) { %>
      <nav class="abv-card abv-card-green">
        <div class="abv-pager">
          <% if (f.page > 1) { %>
            <a class="abv-btn abv-btn-ghost" href="<%= buildHref(f.page-1) %>">‚Üê Prev</a>
          <% } else { %>
            <span class="abv-btn abv-btn-ghost abv-disabled">‚Üê Prev</span>
          <% } %>

          <div class="abv-pager-mid">
            <span class="abv-pagepill">Page <b><%= f.page %></b> of <b><%= f.totalPages %></b></span>
          </div>

          <% if (f.page < f.totalPages) { %>
            <a class="abv-btn abv-btn-blue" href="<%= buildHref(f.page+1) %>">Next ‚Üí</a>
          <% } else { %>
            <span class="abv-btn abv-btn-blue abv-disabled">Next ‚Üí</span>
          <% } %>
        </div>
      </nav>
    <% } %>

  </div>
</section>

<%
  // ‚úÖ Use your layout styles slot if available.
  styles = `
<style nonce="${NONCE}">
  /* ===== Brand palette (Purple dominant) ===== */
  .abv-page{
    --b:#2563EB;
    --p:#7C3AED;
    --g:#22C55E;
    --k:#0F172A;
    --mut:#64748B;
    --line:rgba(15,23,42,.10);
    --shadow:0 12px 26px rgba(15,23,42,.10);
    padding:.75rem 0;
    background:
      radial-gradient(900px 420px at 50% -10%, rgba(124,58,237,.22) 0%, rgba(37,99,235,.08) 55%, rgba(34,197,94,.06) 100%),
      linear-gradient(180deg, #f8fafc, #f8fafc);
  }
  /* ‚úÖ hard stop: no horizontal scroll */
  html, body { max-width:100%; overflow-x:hidden; }
  .abv-page *{box-sizing:border-box}

  .abv-wrap{max-width:1200px;margin:0 auto;padding:0 .85rem;display:grid;gap:.85rem}

  /* Header */
  .abv-hdr{
    border-radius:18px;
    padding:.95rem;
    background: linear-gradient(135deg, rgba(124,58,237,.16), rgba(37,99,235,.10));
    border:1px solid rgba(124,58,237,.30);
    display:flex;align-items:flex-start;justify-content:space-between;gap:.75rem;flex-wrap:wrap;
    box-shadow: 0 10px 18px rgba(15,23,42,.06);
  }
  .abv-hdr-left{display:flex;gap:.75rem;align-items:flex-start;flex:1 1 260px;min-width:240px}
  .abv-badge{
    display:inline-flex;align-items:center;justify-content:center;
    height:38px;padding:0 .7rem;border-radius:999px;
    font-weight:950;font-size:.72rem;letter-spacing:.08em;
    background: rgba(124,58,237,.16);
    border:1px solid rgba(124,58,237,.28);
    color:var(--p);
    flex:0 0 auto;
  }
  .abv-title{margin:0;color:var(--k);font-weight:950;font-size:1.2rem}
  .abv-sub{margin:.25rem 0 0;color:var(--mut);font-weight:750;font-size:.86rem;max-width:60ch}
  .abv-hdr-right{display:flex;gap:.5rem;align-items:center}

  /* Generic card */
  .abv-card{
    background:#fff;
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow: var(--shadow);
    overflow:hidden;
  }
  .abv-card-h{
    padding:.8rem .85rem;
    border-bottom:1px solid rgba(15,23,42,.08);
  }
  .abv-card-purple .abv-card-h{background: rgba(124,58,237,.09)}
  .abv-card-green .abv-card-h{background: rgba(34,197,94,.08)}
  .abv-row{display:flex;align-items:flex-start;justify-content:space-between;gap:.75rem;flex-wrap:wrap}
  .abv-h2{margin:0;color:var(--k);font-weight:950;font-size:1rem}
  .abv-sub2{margin:.25rem 0 0;color:#475569;font-weight:750;font-size:.86rem}

  /* chips */
  .abv-chips{display:flex;flex-wrap:wrap;gap:.5rem;justify-content:flex-end}
  .abv-chip{
    display:inline-flex;align-items:center;gap:.45rem;
    padding:.35rem .55rem;border-radius:999px;
    background: rgba(15,23,42,.03);
    border:1px solid rgba(15,23,42,.10);
    font-size:.78rem;font-weight:850;white-space:nowrap;color:var(--k);
  }
  .dot{width:10px;height:10px;border-radius:999px;display:inline-block}
  .dot-p{background:var(--p)} .dot-b{background:var(--b)} .dot-g{background:var(--g)} .dot-k{background:var(--k)}

  /* buttons */
  .abv-btn{
    display:inline-flex;align-items:center;justify-content:center;
    border-radius:16px;
    padding:.65rem .8rem;
    font-weight:950;
    border:1px solid rgba(15,23,42,.12);
    background:#fff;
    color:var(--k);
    cursor:pointer;
    text-decoration:none;
    white-space:nowrap;
    min-height:44px;
    transition: transform .12s ease, filter .12s ease;
    -webkit-tap-highlight-color: transparent;
  }
  .abv-btn:hover{transform: translateY(-1px)}
  .abv-btn-purple{
    background: linear-gradient(135deg, var(--p), var(--b));
    border-color: transparent;
    color:#fff;
    box-shadow: 0 12px 22px rgba(124,58,237,.18);
  }
  .abv-btn-blue{
    background: rgba(37,99,235,1);
    border-color: transparent;
    color:#fff;
    box-shadow: 0 12px 22px rgba(37,99,235,.16);
  }
  .abv-btn-ghost{background:#fff}
  .abv-btn-mini{min-height:40px;padding:.55rem .8rem;border-radius:14px}
  .abv-disabled{opacity:.55;pointer-events:none}

  /* filters */
  .abv-grid{padding:.85rem;display:grid;grid-template-columns:1fr;gap:.75rem}
  .abv-field{
    background: rgba(255,255,255,.95);
    border:1px solid rgba(124,58,237,.14);
    border-radius:16px;
    padding:.75rem;
  }
  .abv-lbl{display:block;margin:0 0 .35rem;color:var(--p);font-weight:950;font-size:.8rem}
  .abv-field input, .abv-field select{
    width:100%;
    padding:.75rem .8rem;
    border-radius:14px;
    border:1.5px solid rgba(15,23,42,.12);
    font-size:.92rem;
    font-weight:800;
    background:#fff;
    outline:none;
    color:var(--k);
  }
  .abv-field input::placeholder{color:rgba(100,116,139,.92);font-weight:750}
  .abv-field input:focus, .abv-field select:focus{
    border-color: rgba(124,58,237,.65);
    box-shadow: 0 0 0 4px rgba(124,58,237,.14);
  }
  .abv-hint{margin-top:.4rem;color:var(--mut);font-size:.78rem;font-weight:750}
  .abv-actions{display:flex;gap:.6rem;flex-wrap:wrap;align-items:stretch}

  /* KPIs */
  .abv-kpis{display:grid;grid-template-columns:1fr;gap:.65rem}
  .abv-kpi{
    background:#fff;border:1px solid var(--line);border-radius:18px;
    padding:.75rem;box-shadow: 0 10px 18px rgba(15,23,42,.06);position:relative;overflow:hidden;
  }
  .abv-kpi:before{content:"";position:absolute;inset:0 0 auto 0;height:6px;background: rgba(124,58,237,.35)}
  .abv-kpi-purple:before{background: rgba(124,58,237,.7)}
  .abv-kpi-blue:before{background: rgba(37,99,235,.7)}
  .abv-kpi-green:before{background: rgba(34,197,94,.7)}
  .abv-kpi-l{font-size:.78rem;color:#475569;font-weight:900;text-transform:uppercase;letter-spacing:.03em}
  .abv-kpi-v{margin-top:.35rem;font-size:1.15rem;font-weight:950;color:var(--k)}
  .abv-kpi-m{color:var(--mut);font-weight:850;font-size:.9rem}

  /* cards list */
  .abv-cards{display:grid;grid-template-columns:1fr;gap:.85rem}

  .abv-card2{
    background:#fff;border:1px solid rgba(15,23,42,.10);
    border-radius:18px;overflow:hidden;box-shadow: var(--shadow);
  }
  .abv-card2.tone-amber{border-top:5px solid #f59e0b;background: linear-gradient(180deg, rgba(245,158,11,.08), #fff 60%)}
  .abv-card2.tone-green{border-top:5px solid var(--g);background: linear-gradient(180deg, rgba(34,197,94,.10), #fff 60%)}
  .abv-card2.tone-red{border-top:5px solid #ef4444;background: linear-gradient(180deg, rgba(239,68,68,.10), #fff 60%)}

  .abv-top{
    padding:.9rem;
    display:flex;align-items:flex-start;justify-content:space-between;gap:.75rem;flex-wrap:wrap;
  }
  .abv-left{display:flex;gap:.75rem;flex:1 1 260px;min-width:240px}
  .abv-avatar{
    width:44px;height:44px;border-radius:14px;flex:0 0 44px;
    background: linear-gradient(135deg, var(--b), var(--p));
    color:#fff;display:grid;place-items:center;font-weight:950;
  }
  .abv-name-row{display:flex;gap:.55rem;align-items:center;flex-wrap:wrap}
  .abv-name{margin:0;color:var(--k);font-weight:950;font-size:1.02rem}
  .abv-email{margin-top:.25rem;color:var(--mut);font-weight:750;font-size:.82rem;word-break:break-word}

  .abv-status{
    display:inline-flex;padding:.32rem .7rem;border-radius:999px;
    font-size:.72rem;font-weight:950;text-transform:uppercase;letter-spacing:.04em;
  }
  .abv-status-pending{background:#fef3c7;color:#92400e}
  .abv-status-verified{background:#dcfce7;color:#166534}
  .abv-status-rejected{background:#fee2e2;color:#991b1b}

  .abv-subrow{display:flex;flex-wrap:wrap;gap:.45rem;margin-top:.4rem}
  .abv-pill{
    display:inline-flex;align-items:center;
    padding:.24rem .58rem;border-radius:999px;
    font-size:.73rem;font-weight:900;
    border:1px solid rgba(15,23,42,.10);
    background:#fff;color:var(--k);
  }
  .abv-pill-black{background: rgba(15,23,42,.08);color:var(--k)}
  .abv-pill-purple{background: rgba(124,58,237,.14);border-color: rgba(124,58,237,.25);color:var(--p)}
  .abv-pill-blue{background: rgba(37,99,235,.10);border-color: rgba(37,99,235,.22);color:var(--k)}

  .abv-right{display:flex;gap:.5rem;align-items:center}

  .abv-body{
    padding:.9rem;
    border-top:1px solid rgba(15,23,42,.08);
    background: rgba(255,255,255,.92);
    display:grid;
    grid-template-columns:1fr;
    gap:.65rem;
  }
  .abv-kv{display:flex;align-items:flex-start;justify-content:space-between;gap:.75rem}
  .abv-k{font-size:.78rem;font-weight:950;color:var(--p)}
  .abv-v{font-size:.88rem;font-weight:850;color:var(--k);text-align:right;word-break:break-word}
  .abv-mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
  .abv-link{color:var(--b);font-weight:950;text-decoration:none}
  .abv-link:hover{text-decoration:underline}

  /* empty */
  .abv-empty{
    border-radius:18px;
    padding:1.1rem;
    background: rgba(124,58,237,.10);
    border:1px dashed rgba(124,58,237,.35);
    text-align:center;
    color:var(--k);
  }
  .abv-empty-ic{font-size:1.8rem}
  .abv-empty-t{margin-top:.35rem;font-weight:950}
  .abv-empty-s{margin-top:.2rem;font-size:.86rem;font-weight:750;color:var(--mut)}

  /* pager */
  .abv-pager{padding:.85rem;display:flex;gap:.75rem;align-items:center;justify-content:space-between;flex-wrap:wrap}
  .abv-pager-mid{flex:1 1 auto;display:flex;justify-content:center}
  .abv-pagepill{
    padding:.35rem .75rem;border-radius:999px;
    background: rgba(34,197,94,.12);
    border:1px solid rgba(34,197,94,.25);
    color:var(--k);
    font-weight:900;
    font-size:.82rem;
  }

  /* responsive */
  @media (min-width: 640px){
    .abv-grid{grid-template-columns: 1fr 1fr; align-items:stretch}
    .abv-actions{grid-column:1/-1}
    .abv-kpis{grid-template-columns: repeat(3, 1fr)}
    .abv-body{grid-template-columns: 1fr 1fr}
  }
  @media (min-width: 1024px){
    .abv-grid{grid-template-columns: 2fr 1fr 1fr; align-items:end}
    .abv-actions{grid-column:auto; justify-content:flex-end}
    .abv-cards{grid-template-columns: repeat(2, 1fr)}
  }
</style>
`;
%>

<script nonce="<%= NONCE %>">
  // Status auto-submit
  document.getElementById('status')?.addEventListener('change', function () {
    document.getElementById('filterForm')?.submit();
  });

  // Export CSV (keeps your current filters)
  document.getElementById('exportBtn')?.addEventListener('click', function () {
    const params = new URLSearchParams(window.location.search);
    params.set('export', 'csv');
    window.location.href = '/admin/business-verifications?' + params.toString();
  });
</script>



