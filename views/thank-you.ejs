<%
  const NONCE = typeof nonce !== 'undefined' ? nonce : '';
  const THEME_CLASS = themeCss && themeCss.includes('dark') ? 'dark-theme' : 'light-theme';
%>

<% if (success && success.length > 0) { %>
  <div class="flash flash-success" role="status">✅ <%= success %></div>
<% } %>
<% if (error && error.length > 0) { %>
  <div class="flash flash-error" role="alert">❌ <%= error %></div>
<% } %>

<main class="ty-page <%= THEME_CLASS %>">
  <header class="ty-head">
    <div class="ty-title">
      <div class="brand-badge">
        <svg class="check-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Order Confirmed</span>
      </div>
      <h1>Thank you for your purchase!</h1>
      <p class="muted">
        Your order has been received and is being processed
        <span id="tyOrderIdWrap" hidden>
          — <strong id="tyOrderId">—</strong>
          <a id="viewOrderLink" class="inline-link" href="#" target="_blank" rel="noopener" hidden>View this order</a>
        </span>
      </p>
    </div>

    <nav class="btns" aria-label="Post-purchase actions">
      <a href="/sales" class="btn btn-primary" id="btnShop">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 12H5M12 19l-7-7 7-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Continue shopping
      </a>
      <a id="btnReceipt" href="#" class="btn btn-secondary" hidden>
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        View receipt
      </a>
      <a href="/payment/orders" class="btn btn-secondary">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        View my orders
      </a>
      <button id="btnPrint" class="btn btn-ghost" type="button" aria-label="Print receipt">
        <svg class="btn-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Print
      </button>
    </nav>
  </header>

  <div class="cards-container">
    <section class="card totals-card" aria-labelledby="totalsTitle">
      <div class="card-header">
        <h2 id="totalsTitle">Order Summary</h2>
        <div class="status-badge" id="statusBadge">Processing</div>
      </div>
      
      <div id="totalsBox" class="totals">
        <div class="row"><span>Subtotal</span><span id="tSubtotal">—</span></div>
        <div class="row"><span>VAT/Tax</span><span id="tVat">—</span></div>
        <div class="row"><span id="tShipLabel">Delivery</span><span id="tShipping">—</span></div>
        <div class="row total">
          <span>Total Amount</span>
          <span id="tTotal" class="total-amount">—</span>
        </div>
      </div>
    </section>

    <!-- Order details card -->
    <section class="card details-card" id="metaBox" hidden>
      <div class="card-header">
        <h3>Order Details</h3>
      </div>
      <div class="details-grid">
        <div class="detail-item">
          <span class="detail-label">
            <svg class="detail-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Status
          </span>
          <span class="detail-value" id="ordStatus">—</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">
            <svg class="detail-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Date
          </span>
          <span class="detail-value" id="ordDate">—</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">
            <svg class="detail-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Amount Paid
          </span>
          <span class="detail-value" id="ordPaid">—</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">
            <svg class="detail-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Items
          </span>
          <span class="detail-value" id="itemCount">—</span>
        </div>
      </div>
    </section>

    <!-- Delivery card -->
    <section class="card delivery-card" id="deliveryBox" hidden>
      <div class="card-header">
        <h3>Delivery Information</h3>
      </div>
      <div class="delivery-content">
        <div class="delivery-method">
          <svg class="delivery-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16 16H5.6c-.88 0-1.6-.72-1.6-1.6V5.6C4 4.72 4.72 4 5.6 4h9.8c.88 0 1.6.72 1.6 1.6V16zm0 0l2.4 2.4 2.4-2.4m-4.8 0h4.8m-4.8 0V9.6a1.6 1.6 0 011.6-1.6h2.4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <div>
            <div class="delivery-label">Shipping Method</div>
            <div class="delivery-value" id="delName">—</div>
          </div>
        </div>
        <div class="delivery-eta" id="delEta">—</div>
      </div>
    </section>

    <!-- Items list card -->
    <section id="itemsBox" class="card items-card" hidden aria-labelledby="itemsTitle">
      <div class="card-header">
        <h3 id="itemsTitle">Order Items</h3>
      </div>
      <div id="itemsList" class="items-list"></div>
    </section>
  </div>

  <!-- Next Steps Section -->
  <section class="next-steps">
    <h3>What happens next?</h3>
    <div class="steps-container">
      <div class="step">
        <div class="step-number">1</div>
        <div class="step-content">
          <h4>Order Processing</h4>
          <p>We're preparing your items for shipment. You'll receive a confirmation email shortly.</p>
        </div>
      </div>
      <div class="step">
        <div class="step-number">2</div>
        <div class="step-content">
          <h4>Shipping Update</h4>
          <p>Track your order from the "My Orders" page. We'll notify you when it ships.</p>
        </div>
      </div>
      <div class="step">
        <div class="step-number">3</div>
        <div class="step-content">
          <h4>Delivery</h4>
          <p>Your order will arrive at your specified address. Contact us if you have any questions.</p>
        </div>
      </div>
    </div>
  </section>
</main>

<style nonce="<%= NONCE %>">
  :root {
    /* Company Colors */
    --blue: #2563EB;
    --purple: #7C3AED;
    --green: #22C55E;
    --black: #0F172A;
    
    /* Green as primary body color */
    --bg: #F0FDF4;
    --text: #0F172A;
    --muted: #64748B;
    --card: #FFFFFF;
    --border: #D1FAE5;
    --shadow: 0 4px 12px rgba(34, 197, 94, 0.08);
    --radius: 16px;
    --pad: 20px;
    --tap: 48px;
  }

  .dark-theme {
    --bg: #0A1F0A;
    --text: #F1F5F9;
    --muted: #94A3B8;
    --card: #132813;
    --border: #2D5A2D;
    --shadow: 0 4px 12px rgba(34, 197, 94, 0.12);
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html, body {
    background: var(--bg);
    color: var(--text);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .ty-page {
    max-width: 100%;
    margin: 0 auto;
    padding: 16px;
    min-height: 100vh;
    background: linear-gradient(180deg, var(--bg) 0%, #FFFFFF 100%);
  }

  /* Header Styles */
  .ty-head {
    margin-bottom: 32px;
    text-align: center;
  }

  .brand-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--green);
    color: white;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 16px;
  }

  .check-icon {
    width: 16px;
    height: 16px;
  }

  .ty-title h1 {
    font-size: clamp(24px, 5vw, 32px);
    line-height: 1.2;
    margin: 0 0 8px;
    background: linear-gradient(135deg, var(--black) 0%, var(--blue) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .muted {
    color: var(--muted);
    font-size: clamp(14px, 4vw, 16px);
  }

  .inline-link {
    color: var(--blue);
    text-decoration: none;
    font-weight: 500;
    transition: opacity 0.2s;
  }

  .inline-link:hover {
    opacity: 0.8;
  }

  /* Button Styles */
  .btns {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    justify-content: center;
    margin-top: 24px;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    flex: 1 1 calc(50% - 6px);
    min-width: 0;
    padding: 14px 20px;
    border-radius: var(--radius);
    font-size: clamp(14px, 4vw, 16px);
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
    border: 2px solid transparent;
    min-height: var(--tap);
  }

  .btn-icon {
    width: 18px;
    height: 18px;
    flex-shrink: 0;
  }

  .btn-primary {
    background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
    color: white;
    border: none;
  }

  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
  }

  .btn-secondary {
    background: var(--card);
    color: var(--blue);
    border: 2px solid var(--border);
  }

  .btn-secondary:hover {
    border-color: var(--blue);
    transform: translateY(-2px);
  }

  .btn-ghost {
    background: transparent;
    color: var(--muted);
    border: 2px solid var(--border);
  }

  .btn-ghost:hover {
    color: var(--text);
    border-color: var(--text);
  }

  /* Card Styles */
  .cards-container {
    display: grid;
    gap: 20px;
    margin-bottom: 40px;
  }

  .card {
    background: var(--card);
    border-radius: var(--radius);
    padding: var(--pad);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--border);
  }

  .card-header h2,
  .card-header h3 {
    font-size: clamp(18px, 4.5vw, 20px);
    color: var(--black);
    margin: 0;
  }

  /* Status Badge */
  .status-badge {
    background: linear-gradient(135deg, var(--green) 0%, #16A34A 100%);
    color: white;
    padding: 6px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
  }

  /* Totals Section */
  .totals {
    display: grid;
    gap: 12px;
  }

  .row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    font-size: clamp(14px, 4vw, 16px);
  }

  .row.total {
    border-top: 2px solid var(--border);
    margin-top: 8px;
    padding-top: 16px;
    font-size: clamp(16px, 4.5vw, 18px);
    font-weight: 700;
  }

  .total-amount {
    color: var(--green);
    font-size: clamp(18px, 5vw, 24px);
  }

  /* Details Grid */
  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .detail-label {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--muted);
    font-size: 14px;
    font-weight: 500;
  }

  .detail-icon {
    width: 16px;
    height: 16px;
    opacity: 0.7;
  }

  .detail-value {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }

  /* Delivery Section */
  .delivery-content {
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .delivery-method {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .delivery-icon {
    width: 24px;
    height: 24px;
    color: var(--blue);
  }

  .delivery-label {
    font-size: 12px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .delivery-value {
    font-size: 16px;
    font-weight: 600;
    color: var(--text);
  }

  .delivery-eta {
    padding: 12px;
    background: rgba(34, 197, 94, 0.1);
    border-radius: 8px;
    font-size: 14px;
    color: var(--green);
    font-weight: 500;
  }

  /* Items List */
  .items-list {
    display: grid;
    gap: 12px;
  }

  .item-row {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 16px;
    align-items: center;
    padding: 12px;
    background: rgba(34, 197, 94, 0.05);
    border-radius: 8px;
  }

  .item-name {
    font-weight: 500;
    overflow-wrap: anywhere;
  }

  .item-qty {
    color: var(--muted);
    font-size: 14px;
  }

  .item-line {
    font-weight: 600;
    color: var(--green);
  }

  /* Next Steps */
  .next-steps {
    margin-top: 40px;
    padding: 24px;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.05) 0%, rgba(34, 197, 94, 0.05) 100%);
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }

  .next-steps h3 {
    text-align: center;
    margin-bottom: 24px;
    color: var(--black);
    font-size: clamp(18px, 4.5vw, 20px);
  }

  .steps-container {
    display: grid;
    gap: 20px;
  }

  .step {
    display: flex;
    gap: 16px;
    align-items: flex-start;
  }

  .step-number {
    flex-shrink: 0;
    width: 32px;
    height: 32px;
    background: var(--purple);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
  }

  .step-content h4 {
    margin: 0 0 4px;
    color: var(--black);
    font-size: 16px;
  }

  .step-content p {
    margin: 0;
    color: var(--muted);
    font-size: 14px;
    line-height: 1.5;
  }

  /* Flash Messages */
  .flash {
    margin: 16px 0;
    padding: 16px 20px;
    border-radius: 12px;
    font-size: clamp(14px, 4vw, 16px);
    border: 1px solid transparent;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .flash-success {
    background: rgba(34, 197, 94, 0.1);
    color: #065F46;
    border-color: var(--green);
  }

  .flash-error {
    background: rgba(239, 68, 68, 0.1);
    color: #991B1B;
    border-color: #FCA5A5;
  }

  /* Mobile Optimization (Hisense U50 Lite - 720x1600) */
  @media (max-width: 720px) {
    .ty-page {
      padding: 12px;
    }
    
    .btn {
      flex: 1 1 100%;
    }
    
    .cards-container {
      gap: 16px;
    }
    
    .card {
      padding: 16px;
    }
    
    .details-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (min-width: 420px) and (max-width: 719px) {
    .btn {
      flex: 1 1 calc(50% - 6px);
    }
    
    .details-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 720px) {
    .ty-page {
      max-width: 680px;
      padding: 24px;
    }
    
    .cards-container {
      grid-template-columns: repeat(2, 1fr);
    }
    
    .totals-card,
    .details-card {
      grid-column: span 1;
    }
    
    .delivery-card,
    .items-card {
      grid-column: span 2;
    }
    
    .btns {
      justify-content: flex-start;
    }
    
    .btn {
      flex: 0 1 auto;
      min-width: 180px;
    }
  }

  /* Print Styles */
  @media print {
    .btns,
    .flash,
    .next-steps {
      display: none !important;
    }
    
    .ty-page {
      max-width: 100%;
      padding: 0;
      background: white !important;
    }
    
    body {
      background: white !important;
      color: black !important;
    }
    
    .card {
      box-shadow: none !important;
      border: 1px solid #ddd !important;
      break-inside: avoid;
    }
  }

  .visually-hidden {
    position: absolute !important;
    height: 1px;
    width: 1px;
    overflow: hidden;
    clip: rect(1px, 1px, 1px, 1px);
    white-space: nowrap;
  }
</style>

<script nonce="<%= NONCE %>">
(function () {
  function qs(sel, ctx){ return (ctx||document).querySelector(sel); }
  function qsa(sel, ctx){ return Array.from((ctx||document).querySelectorAll(sel)); }
  function qsp(name){
    var m = location.search.match(new RegExp('[?&]'+name+'=([^&]+)'));
    return m ? decodeURIComponent(m[1]) : '';
  }
  function moneyFmt(currency){
    var C=(currency||'USD').toUpperCase();
    var sym={USD:'$',ZAR:'R',EUR:'€',GBP:'£'}[C]||(C+' ');
    return function(n){ return sym + Number(n||0).toFixed(2); };
  }
  function fetchJsonSafe(url){
    return fetch(url, { credentials:'same-origin' })
      .then(function(r){
        var ct=(r.headers.get('content-type')||'').toLowerCase();
        if(!r.ok) return {ok:false,status:r.status,json:null};
        if(!ct.includes('application/json')) return {ok:false,status:r.status,json:null};
        return r.json().then(function(j){return {ok:true,status:r.status,json:j};});
      })
      .catch(function(){return {ok:false,status:0,json:null};});
  }

  document.addEventListener('DOMContentLoaded', function(){
    var btnPrint = qs('#btnPrint');
    if (btnPrint) btnPrint.addEventListener('click', function(){ window.print(); });

    // Order ID handling
    var orderId = qsp('orderId') || qsp('id') || '';
    var tyWrap = qs('#tyOrderIdWrap');
    var tyId = qs('#tyOrderId');
    var viewLink = qs('#viewOrderLink');
    var btnReceipt = qs('#btnReceipt');

    if (orderId && tyWrap && tyId) {
      tyWrap.hidden = false;
      tyId.textContent = orderId;
      var recHref = '/payment/receipt/' + encodeURIComponent(orderId);
      if (viewLink)  { viewLink.href = recHref; viewLink.hidden = false; }
      if (btnReceipt){ btnReceipt.href = recHref; btnReceipt.hidden = false; }
    }
    if (!orderId) return;

    // Fetch order details
    fetchJsonSafe('/payment/order/' + encodeURIComponent(orderId))
      .then(function(res){
        if (!res.ok || !res.json || !res.json.success) return;
        var o = res.json.order || {};
        var C = (o.currency || 'USD').toUpperCase();
        var money = moneyFmt(C);

        // Update status badge
        var statusBadge = qs('#statusBadge');
        if (statusBadge && o.status) {
          statusBadge.textContent = o.status.charAt(0).toUpperCase() + o.status.slice(1);
          if (o.status.toLowerCase() === 'completed') {
            statusBadge.style.background = 'linear-gradient(135deg, var(--green) 0%, #16A34A 100%)';
          }
        }

        // Show and update meta box
        var metaBox = qs('#metaBox');
        if (metaBox) {
          metaBox.hidden = false;
          var ordStatus = qs('#ordStatus');
          if (ordStatus) ordStatus.textContent = o.status ? o.status.charAt(0).toUpperCase() + o.status.slice(1) : '—';
          
          var ordDate = qs('#ordDate');
          if (ordDate && o.createdAt) {
            ordDate.textContent = new Date(o.createdAt).toLocaleDateString('en-US', {
              weekday: 'short',
              year: 'numeric',
              month: 'short',
              day: 'numeric',
              hour: '2-digit',
              minute: '2-digit'
            });
          }
          
          var paidVal = (o.amount && o.amount.value != null) ? o.amount.value : (o.totals ? o.totals.total : null);
          var ordPaid = qs('#ordPaid');
          if (ordPaid) ordPaid.textContent = (paidVal != null) ? money(paidVal) : '—';
          
          // Item count
          var itemCount = qs('#itemCount');
          if (itemCount && o.items && Array.isArray(o.items)) {
            itemCount.textContent = o.items.length + ' item' + (o.items.length !== 1 ? 's' : '');
          }
        }

        // Update totals
        var itemTotal = o.breakdown && o.breakdown.itemTotal ? o.breakdown.itemTotal.value : (o.totals ? o.totals.subtotal : null);
        var taxTotal  = o.breakdown && o.breakdown.taxTotal  ? o.breakdown.taxTotal.value  : (o.totals ? o.totals.tax : null);
        var shipTotal = o.breakdown && o.breakdown.shipping  ? o.breakdown.shipping.value  : (o.delivery ? o.delivery.amount : null);
        var grandTot  = (o.amount && (o.amount.value != null)) ? o.amount.value : (o.totals ? o.totals.total : null);

        var tSub=qs('#tSubtotal'), tVat=qs('#tVat'), tShip=qs('#tShipping'), tTot=qs('#tTotal');
        if (tSub)  tSub.textContent  = (itemTotal!=null) ? money(itemTotal) : '—';
        if (tVat)  tVat.textContent  = (taxTotal!=null)  ? money(taxTotal)  : '—';
        if (tShip) tShip.textContent = (shipTotal!=null) ? money(shipTotal) : '—';
        if (tTot)  tTot.textContent  = (grandTot!=null)  ? money(grandTot)  : '—';

        // Delivery information
        if (o.delivery && (o.delivery.name || (o.delivery.deliveryDays != null))) {
          var dBox = qs('#deliveryBox');
          if (dBox) {
            dBox.hidden = false;
            var dName = qs('#delName');
            var dEta = qs('#delEta');
            if (dName) dName.textContent = o.delivery.name || 'Standard Delivery';
            if (dEta) {
              if (o.delivery.deliveryDays != null) {
                var days = Number(o.delivery.deliveryDays);
                var date = new Date();
                date.setDate(date.getDate() + days);
                dEta.textContent = 'Estimated delivery: ' + date.toLocaleDateString('en-US', {
                  weekday: 'short',
                  month: 'short',
                  day: 'numeric'
                });
              } else {
                dEta.textContent = 'Delivery date to be confirmed';
              }
            }
          }
        }

        // Items list
        if (o.items && Array.isArray(o.items) && o.items.length > 0) {
          var itemsBox = qs('#itemsBox');
          var itemsList = qs('#itemsList');
          if (itemsBox && itemsList) {
            itemsBox.hidden = false;
            itemsList.innerHTML = '';
            
            o.items.forEach(function(item, index) {
              var div = document.createElement('div');
              div.className = 'item-row';
              div.innerHTML = `
                <span class="item-name">${item.name || 'Item ' + (index + 1)}</span>
                <span class="item-qty">${item.quantity || 1} × ${money(item.price || 0)}</span>
                <span class="item-line">${money((item.price || 0) * (item.quantity || 1))}</span>
              `;
              itemsList.appendChild(div);
            });
          }
        }
      })
      .catch(function(e){ 
        console.warn('Order details fetch failed:', e);
        // Show error state
        var statusBadge = qs('#statusBadge');
        if (statusBadge) {
          statusBadge.textContent = 'Error';
          statusBadge.style.background = 'linear-gradient(135deg, #EF4444 0%, #DC2626 100%)';
        }
      });
  });
})();
</script>