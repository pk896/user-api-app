<!-- views/order-track.ejs -->
<% 
  const PAGE_NONCE = typeof nonce !== 'undefined' ? nonce : '';
  const st = order.shippingTracking || {}; 
  const hasTracking = Boolean((st.trackingNumber || '').trim());
  const carrierToken = String(st.carrierToken || '').trim();
  const labelUrl = String(st.labelUrl || order?.shippo?.labelUrl || '').trim();
%>

<section class="tracking-container">
  <header class="tracking-header">
    <div class="header-main">
      <h1>üì¶ Track Order</h1>
      <span class="order-id-pill">#<%= order._id.toString().slice(-6) %></span>
    </div>
    <div class="price-strip">
      <span>Total Paid:</span>
      <strong class="text-green">
        <%= order.amount && order.amount.value %> <%= order.amount && order.amount.currency %>
      </strong>
    </div>
  </header>

  <div class="status-block-purple">
    <div class="block-head">
      <h2>Shipping Status</h2>
      <% if (hasTracking) { %>
        <button id="refreshTracking" class="btn-refresh" type="button">üîÑ Sync</button>
      <% } %>
    </div>

    <% if (hasTracking) { %>
      <div class="current-badge-wrap">
        <% 
          const currentStatus = (liveTracking && liveTracking.status) || st.liveStatus || st.status || 'SHIPPED';
        %>
        <span class="status-indicator-big status-<%= currentStatus.toLowerCase() %>">
          <%= currentStatus.replace(/_/g, ' ') %>
        </span>
      </div>

      <% if (liveTracking && liveTracking.estimatedDelivery) { %>
        <div class="eta-box">
          <small>Estimated Arrival</small>
          <p><%= new Date(liveTracking.estimatedDelivery).toLocaleDateString() %></p>
        </div>
      <% } %>
    <% } else { %>
      <p class="empty-msg">Waiting for tracking information to be uploaded...</p>
    <% } %>
  </div>

  <% if (liveTracking && liveTracking.events && liveTracking.events.length > 0) { %>
    <div class="timeline-card">
      <h3>Journey History</h3>
      <div class="vertical-timeline">
        <% liveTracking.events.slice(0, 8).forEach((event, index) => { %>
          <div class="timeline-step <%= index === 0 ? 'active' : '' %>">
            <div class="step-marker"></div>
            <div class="step-info">
              <p class="step-desc"><%= event.details || event.description || event.status %></p>
              <span class="step-time">
                <%= event.date ? new Date(event.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '' %> ‚Ä¢ 
                <%= typeof event.location === 'string' ? event.location : (event.location?.city || '') %>
              </span>
            </div>
          </div>
        <% }); %>
      </div>
    </div>
  <% } %>

  <div class="details-card-blue">
    <h3>Carrier Information</h3>
    <div class="info-row">
      <span class="info-label">Courier:</span>
      <span class="info-val"><%= st.carrierLabel || st.carrier || 'Pending' %></span>
    </div>
    <div class="info-row">
      <span class="info-label">Tracking #:</span>
      <span class="info-val mono"><%= st.trackingNumber || '---' %></span>
    </div>

    <div class="action-stack">
      <% if (st.trackingUrl) { %>
        <a href="<%= st.trackingUrl %>" target="_blank" class="btn-trust-blue">üîç Open Courier Website</a>
      <% } %>
      <% if (labelUrl) { %>
        <a href="<%= labelUrl %>" target="_blank" class="btn-premium-black">üè∑Ô∏è View Shipping Label</a>
      <% } %>
    </div>
  </div>

  <% if (isBusiness) { %>
    <div class="business-card-premium">
      <div class="card-head-dark">
        <h2>Business Management</h2>
        <p>Update tracking details for this customer below.</p>
      </div>

      <form action="/orders/tracking/<%= order._id %>" method="POST" class="styled-form">
        <div class="input-group">
          <label>Select Carrier</label>
          <select name="carrier" required class="full-select">
            <option value="" disabled selected>Choose a courier...</option>
            <optgroup label="Shippo Integrated">
              <option value="ups" <%= st.carrier === 'ups' ? 'selected' : '' %>>UPS</option>
              <option value="usps" <%= st.carrier === 'usps' ? 'selected' : '' %>>USPS</option>
              <option value="fedex" <%= st.carrier === 'fedex' ? 'selected' : '' %>>FedEx</option>
              <option value="dhl_express" <%= st.carrier === 'dhl_express' ? 'selected' : '' %>>DHL Express</option>
            </optgroup>
            <optgroup label="Other Options">
              <option value="COURIER_GUY" <%= st.carrier === 'COURIER_GUY' ? 'selected' : '' %>>Courier Guy</option>
              <option value="ARAMEX" <%= st.carrier === 'ARAMEX' ? 'selected' : '' %>>Aramex</option>
              <option value="OTHER">Other / Manual</option>
            </optgroup>
          </select>
        </div>

        <div class="input-group">
          <label>Tracking Number</label>
          <input type="text" name="trackingNumber" required value="<%= st.trackingNumber || '' %>" placeholder="Paste tracking code here (e.g. 1Z999...)">
        </div>

        <div class="input-group">
          <label>Carrier Label</label>
          <input type="text" name="carrierLabel" value="<%= st.carrierLabel || '' %>" placeholder="Display name (e.g. UPS Express)">
        </div>

        <div class="input-group">
          <label>Tracking URL</label>
          <input type="url" name="trackingUrl" value="<%= st.trackingUrl || '' %>" placeholder="Direct link to courier results">
        </div>

        <button type="submit" class="btn-submit-purple">üíæ Save Tracking Data</button>
      </form>
    </div>
  <% } %>

  <div class="footer-nav">
    <a href="/orders" class="btn-back-link">‚Üê Return to Order List</a>
  </div>
</section>

<style nonce="<%= PAGE_NONCE %>">
  :root {
    --p-purple: #7C3AED;
    --t-blue: #2563EB;
    --g-green: #22C55E;
    --p-black: #0F172A;
    --soft-gray: #F1F5F9;
  }

  .tracking-container { max-width: 500px; margin: 0 auto; padding: 10px; background: #fff; }

  /* Header */
  .tracking-header { background: var(--p-black); color: white; padding: 15px; border-radius: 12px; margin-bottom: 12px; }
  .header-main { display: flex; justify-content: space-between; align-items: center; }
  .tracking-header h1 { font-size: 1.2rem; margin: 0; }
  .order-id-pill { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 6px; font-size: 0.8rem; font-family: monospace; }
  .price-strip { margin-top: 10px; font-size: 0.9rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 8px; display: flex; justify-content: space-between; }
  .text-green { color: var(--g-green); }

  /* Purple Status Block */
  .status-block-purple { background: var(--p-purple); color: white; padding: 20px 15px; border-radius: 12px; margin-bottom: 12px; position: relative; }
  .block-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
  .block-head h2 { font-size: 0.9rem; text-transform: uppercase; margin: 0; opacity: 0.9; letter-spacing: 1px; }
  .btn-refresh { background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; cursor: pointer; font-weight: bold; }
  .current-badge-wrap { text-align: center; padding: 10px 0; }
  .status-indicator-big { font-size: 1.5rem; font-weight: 900; text-transform: uppercase; display: block; }
  .eta-box { background: rgba(0,0,0,0.15); padding: 10px; border-radius: 8px; margin-top: 10px; text-align: center; }
  .eta-box small { font-size: 0.7rem; text-transform: uppercase; opacity: 0.8; }
  .eta-box p { margin: 0; font-weight: bold; font-size: 1.1rem; }

  /* Timeline */
  .timeline-card { background: var(--soft-gray); padding: 15px; border-radius: 12px; margin-bottom: 12px; border: 1px solid #E2E8F0; }
  .timeline-card h3 { margin: 0 0 15px 0; font-size: 1rem; color: var(--p-black); }
  .vertical-timeline { position: relative; padding-left: 20px; }
  .timeline-step { position: relative; padding-bottom: 20px; border-left: 2px solid #CBD5E1; padding-left: 20px; }
  .timeline-step:last-child { border-left: transparent; }
  .step-marker { position: absolute; left: -7px; top: 0; width: 12px; height: 12px; border-radius: 50%; background: #94A3B8; border: 2px solid white; }
  .timeline-step.active .step-marker { background: var(--p-purple); box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.2); }
  .step-desc { margin: 0; font-size: 0.85rem; font-weight: 600; color: var(--p-black); }
  .step-time { font-size: 0.75rem; color: #64748B; }

  /* Info Card Blue */
  .details-card-blue { border: 2px solid var(--t-blue); padding: 15px; border-radius: 12px; margin-bottom: 12px; }
  .details-card-blue h3 { margin: 0 0 10px 0; font-size: 1rem; color: var(--t-blue); }
  .info-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.85rem; }
  .info-label { color: #64748B; }
  .info-val { font-weight: bold; color: var(--p-black); }
  .mono { font-family: monospace; background: #f1f5f9; padding: 2px 4px; border-radius: 4px; }

  /* Form & Buttons */
  .action-stack { display: flex; flex-direction: column; gap: 8px; margin-top: 15px; }
  .btn-trust-blue { background: var(--t-blue); color: white; text-align: center; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 0.9rem; }
  .btn-premium-black { background: var(--p-black); color: white; text-align: center; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; font-size: 0.9rem; }
  
  .business-card-premium { background: white; border: 1px solid #E2E8F0; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
  .card-head-dark { background: #f8fafc; padding: 15px; border-bottom: 1px solid #E2E8F0; }
  .card-head-dark h2 { margin: 0; font-size: 1rem; color: var(--p-purple); }
  .card-head-dark p { margin: 5px 0 0 0; font-size: 0.75rem; color: #64748B; }

  .styled-form { padding: 15px; }
  .input-group { margin-bottom: 12px; }
  .input-group label { display: block; font-size: 0.75rem; font-weight: 700; color: #475569; margin-bottom: 4px; text-transform: uppercase; }
  .input-group input, .input-group select { width: 100%; padding: 10px; border: 1px solid #CBD5E1; border-radius: 6px; font-size: 0.9rem; box-sizing: border-box; }
  .btn-submit-purple { width: 100%; background: var(--p-purple); color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; }

  .footer-nav { text-align: center; padding: 20px 0; }
  .btn-back-link { color: var(--p-purple); text-decoration: none; font-weight: bold; font-size: 0.9rem; }

  /* Status Colors */
  .status-delivered { color: var(--g-green) !important; }
  .status-out_for_delivery { color: #F59E0B !important; }
</style>

<script nonce="<%= PAGE_NONCE %>">
document.addEventListener('DOMContentLoaded', function() {
  const refreshBtn = document.getElementById('refreshTracking');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async function() {
      refreshBtn.disabled = true;
      const oldText = refreshBtn.textContent;
      refreshBtn.textContent = 'Syncing...';

      try {
        const response = await fetch(`/orders/tracking/<%= order._id %>/refresh`, {
          headers: { 'Accept': 'application/json' }
        });
        const data = await response.json();
        if (data && data.ok) {
          location.reload();
        } else {
          alert(data.message || 'Error updating status');
        }
      } catch (e) {
        alert('Network error during sync');
      } finally {
        refreshBtn.disabled = false;
        refreshBtn.textContent = oldText;
      }
    });
  }
});
</script>