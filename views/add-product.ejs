<!-- Add New Product Form -->
<div class="pf <%= themeCss.includes('dark') ? 'dark-theme' : 'light-theme' %>">
  <h1 class="pf-title">➕ Add New Product</h1>

  <!-- Toast Container -->
  <div id="toast-container" class="pf-toast-container"></div>

  <% if (!business) { %>
    <div class="pf-unauthorized">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true">
        <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-2.268-.833-3.036 0L4.33 16.5c-.77.833.192 2.5 1.732 2.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <p>You need a business account to add products</p>
      <a href="/business/login" class="pf-btn pf-btn-primary">Login</a>
    </div>
  <% } else { %>
    <form id="addProductForm" action="/products/add" method="POST" enctype="multipart/form-data">
      <!-- Form Grid -->
      <div class="pf-grid">
        <!-- Left Column -->
        <div class="pf-col">
          <div class="pf-field">
            <label class="pf-label">
              <span>Product ID <em>*</em></span>
              <input type="text" name="customId" placeholder="PROD-001" required class="pf-input" />
              <div class="pf-hint">Unique identifier for your product</div>
            </label>
          </div>

          <div class="pf-field">
            <label class="pf-label">
              <span>Product Name <em>*</em></span>
              <input type="text" name="name" placeholder="e.g., Orange Juice" required class="pf-input" />
            </label>
          </div>

          <div class="pf-field">
            <label class="pf-label">
              <span>Price <em>*</em></span>
              <div class="pf-input-group">
                <span class="pf-input-prefix">R</span>
                <input type="number" name="price" placeholder="10.99" step="0.01" min="0" required class="pf-input pf-input-with-prefix" />
              </div>
            </label>
          </div>

          <div class="pf-field">
            <label class="pf-label">
              <span>Stock Quantity</span>
              <input type="number" name="stock" placeholder="100" min="0" class="pf-input" />
              <div class="pf-hint">Leave empty for unlimited</div>
            </label>
          </div>

          <div class="pf-field">
            <label class="pf-label">
              <span>Category</span>
              <input type="text" name="category" placeholder="Beverages" class="pf-input" />
            </label>
          </div>

          <div class="pf-field">
            <label class="pf-label">
              <span>Color</span>
              <input type="text" name="color" placeholder="Orange" class="pf-input" />
            </label>
          </div>
        </div>

        <!-- Right Column -->
        <div class="pf-col">
          <div class="pf-field">
            <label class="pf-label">
              <span>Size</span>
              <input type="text" name="size" placeholder="1L Bottle" class="pf-input" />
            </label>
          </div>

          <div class="pf-field">
            <label class="pf-label">
              <span>Quality</span>
              <input type="text" name="quality" placeholder="Premium" class="pf-input" />
            </label>
          </div>

          <div class="pf-field">
            <label class="pf-label">
              <span>Made In</span>
              <input type="text" name="made" placeholder="South Africa" class="pf-input" />
            </label>
          </div>

          <div class="pf-field">
            <label class="pf-label">
              <span>Manufacturer</span>
              <input type="text" name="manufacturer" placeholder="PK's Engineering" class="pf-input" />
            </label>
          </div>

          <div class="pf-field">
            <label class="pf-label">
              <span>Type</span>
              <input type="text" name="type" placeholder="Organic Juice" class="pf-input" />
            </label>
          </div>

          <div class="pf-field">
            <label class="pf-label">
              <span>Description</span>
              <textarea name="description" rows="2" placeholder="Short product description..." maxlength="500" class="pf-textarea"></textarea>
              <div class="pf-hint">Max 500 characters</div>
            </label>
          </div>
        </div>
      </div>

      <!-- Image Upload -->
      <div class="pf-image-section">
        <label class="pf-label pf-label-block">
          <span>Product Image <em>*</em></span>
          <div class="pf-image-upload">
            <input id="imageFile" type="file" name="imageFile" accept="image/*" required class="pf-file-input" />
            <div class="pf-image-upload-area">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <span>Click to upload image</span>
              <div class="pf-hint">JPG, PNG or GIF • Max 5MB</div>
            </div>
          </div>
        </label>

        <div id="previewWrapper" class="pf-image-preview">
          <img id="imagePreview" class="pf-image-preview-img" alt="Product preview" />
          <button type="button" class="pf-image-remove" onclick="removeImage()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
              <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="pf-actions">
        <button type="submit" class="pf-btn pf-btn-primary">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none" aria-hidden="true">
            <path d="M4 8l3 3 5-6M2 8a6 6 0 1112 0A6 6 0 012 8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Save Product
        </button>
        <a href="/products/all" class="pf-btn pf-btn-secondary">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="none" aria-hidden="true">
            <path d="M10 12L6 8l4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Back to Products
        </a>
      </div>
    </form>
  <% } %>
</div>

<style>
  /* ===== COMPANY COLORS & VARIABLES ===== */
  .pf {
    --blue: #2563EB;
    --purple: #7C3AED;
    --green: #22C55E;
    --black: #0F172A;
    --radius: 10px;
    --transition: all 0.2s ease;
  }

  /* ===== FORM CONTAINER ===== */
  .pf {
    max-width: 700px;
    margin: 12px auto;
    background: linear-gradient(135deg, #F0FDF4 0%, #FFFFFF 100%);
    border-radius: var(--radius);
    padding: 20px;
    border: 1px solid #D1FAE5;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.08);
  }

  .dark-theme.pf {
    background: linear-gradient(135deg, #0A1F0A 0%, #132813 100%);
    border-color: #2D5A2D;
    box-shadow: 0 4px 12px rgba(34, 197, 94, 0.12);
  }

  /* ===== TITLE ===== */
  .pf-title {
    font-size: 18px;
    font-weight: 700;
    text-align: center;
    margin: 0 0 20px 0;
    color: var(--black);
    padding-bottom: 12px;
    border-bottom: 2px solid #D1FAE5;
  }

  .dark-theme .pf-title {
    color: #F1F5F9;
    border-bottom-color: #2D5A2D;
  }

  /* ===== UNAUTHORIZED ===== */
  .pf-unauthorized {
    text-align: center;
    padding: 30px 20px;
    background: rgba(34, 197, 94, 0.05);
    border-radius: var(--radius);
    border: 1px solid #D1FAE5;
  }

  .pf-unauthorized svg {
    color: #F59E0B;
    margin-bottom: 12px;
  }

  .pf-unauthorized p {
    margin: 0 0 16px 0;
    color: var(--black);
    font-weight: 500;
  }

  .dark-theme .pf-unauthorized {
    background: rgba(34, 197, 94, 0.1);
    border-color: #2D5A2D;
  }

  .dark-theme .pf-unauthorized p {
    color: #E2E8F0;
  }

  /* ===== FORM LAYOUT ===== */
  .pf-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 16px;
    margin-bottom: 24px;
  }

  @media (min-width: 640px) {
    .pf-grid {
      grid-template-columns: 1fr 1fr;
    }
  }

  .pf-col {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  /* ===== FORM FIELDS ===== */
  .pf-field {
    display: flex;
    flex-direction: column;
  }

  .pf-label {
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 13px;
    font-weight: 600;
    color: var(--black);
  }

  .pf-label em {
    color: #EF4444;
    font-style: normal;
  }

  .dark-theme .pf-label {
    color: #E2E8F0;
  }

  .pf-input,
  .pf-textarea {
    padding: 10px;
    border: 1px solid #D1FAE5;
    border-radius: 8px;
    font-size: 14px;
    font-family: inherit;
    background: #FFFFFF;
    color: var(--black);
    transition: var(--transition);
  }

  .pf-input:focus,
  .pf-textarea:focus {
    outline: none;
    border-color: var(--blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .dark-theme .pf-input,
  .dark-theme .pf-textarea {
    background: #1A341A;
    border-color: #2D5A2D;
    color: #F1F5F9;
  }

  .dark-theme .pf-input:focus,
  .dark-theme .pf-textarea:focus {
    background: #0F230F;
    border-color: var(--blue);
  }

  /* ===== INPUT GROUP ===== */
  .pf-input-group {
    position: relative;
    display: flex;
    align-items: center;
  }

  .pf-input-prefix {
    position: absolute;
    left: 10px;
    color: #64748B;
    font-weight: 500;
  }

  .pf-input-with-prefix {
    padding-left: 24px;
  }

  /* ===== HINT TEXT ===== */
  .pf-hint {
    font-size: 11px;
    color: #64748B;
    margin-top: 2px;
  }

  .dark-theme .pf-hint {
    color: #94A3B8;
  }

  /* ===== TEXTAREA ===== */
  .pf-textarea {
    resize: vertical;
    min-height: 60px;
    line-height: 1.4;
  }

  /* ===== IMAGE UPLOAD ===== */
  .pf-image-section {
    margin-bottom: 24px;
  }

  .pf-label-block {
    margin-bottom: 12px;
  }

  .pf-image-upload {
    position: relative;
  }

  .pf-file-input {
    position: absolute;
    width: 100%;
    height: 100%;
    opacity: 0;
    cursor: pointer;
  }

  .pf-image-upload-area {
    padding: 20px;
    border: 2px dashed #D1FAE5;
    border-radius: var(--radius);
    background: rgba(34, 197, 94, 0.05);
    text-align: center;
    transition: var(--transition);
  }

  .pf-image-upload-area:hover {
    border-color: var(--green);
    background: rgba(34, 197, 94, 0.1);
  }

  .pf-image-upload-area svg {
    color: var(--green);
    margin-bottom: 8px;
  }

  .pf-image-upload-area span {
    display: block;
    font-weight: 600;
    color: var(--black);
    margin-bottom: 4px;
  }

  .dark-theme .pf-image-upload-area {
    border-color: #2D5A2D;
    background: rgba(34, 197, 94, 0.1);
  }

  .dark-theme .pf-image-upload-area:hover {
    border-color: var(--green);
    background: rgba(34, 197, 94, 0.15);
  }

  .dark-theme .pf-image-upload-area span {
    color: #F1F5F9;
  }

  /* ===== IMAGE PREVIEW ===== */
  .pf-image-preview {
    display: none;
    position: relative;
    width: 120px;
    height: 120px;
    margin-top: 12px;
  }

  .pf-image-preview-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: var(--radius);
    border: 1px solid #D1FAE5;
  }

  .pf-image-remove {
    position: absolute;
    top: -8px;
    right: -8px;
    width: 24px;
    height: 24px;
    background: #FFFFFF;
    border: 1px solid #EF4444;
    border-radius: 50%;
    color: #EF4444;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: var(--transition);
  }

  .pf-image-remove:hover {
    background: #EF4444;
    color: white;
  }

  /* ===== BUTTONS ===== */
  .pf-actions {
    display: flex;
    gap: 12px;
    justify-content: center;
    flex-wrap: wrap;
  }

  .pf-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 12px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    text-decoration: none;
    border: 2px solid transparent;
    cursor: pointer;
    transition: var(--transition);
    min-width: 140px;
  }

  .pf-btn-primary {
    background: linear-gradient(135deg, var(--blue) 0%, var(--purple) 100%);
    color: white;
  }

  .pf-btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
  }

  .pf-btn-secondary {
    background: #FFFFFF;
    color: var(--blue);
    border-color: #D1FAE5;
  }

  .pf-btn-secondary:hover {
    background: #F8FAFC;
    border-color: var(--blue);
  }

  .dark-theme .pf-btn-secondary {
    background: #1A341A;
    color: #60A5FA;
    border-color: #2D5A2D;
  }

  .dark-theme .pf-btn-secondary:hover {
    background: #2D5A2D;
    border-color: var(--blue);
  }

  /* ===== TOAST NOTIFICATIONS ===== */
  .pf-toast-container {
    position: fixed;
    bottom: 16px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 8px;
    pointer-events: none;
  }

  .pf-toast {
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    color: white;
    background: linear-gradient(135deg, var(--green) 0%, #16A34A 100%);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    animation: toastSlideIn 0.3s ease-out;
    max-width: 320px;
    text-align: center;
  }

  .pf-toast.pf-toast-error {
    background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%);
  }

  @keyframes toastSlideIn {
    from {
      opacity: 0;
      transform: translateY(20px) translateX(-50%);
    }
    to {
      opacity: 1;
      transform: translateY(0) translateX(-50%);
    }
  }

  /* ===== COMPACT MOBILE DESIGN ===== */
  @media (max-width: 360px) {
    .pf {
      margin: 8px;
      padding: 16px;
    }
    
    .pf-title {
      font-size: 16px;
      margin-bottom: 16px;
    }
    
    .pf-grid {
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .pf-col {
      gap: 10px;
    }
    
    .pf-input,
    .pf-textarea {
      padding: 8px;
      font-size: 13px;
    }
    
    .pf-btn {
      padding: 10px 16px;
      font-size: 13px;
      min-width: 120px;
    }
    
    .pf-image-upload-area {
      padding: 16px;
    }
  }

  @media (min-width: 361px) and (max-width: 720px) {
    .pf {
      margin: 16px;
      padding: 20px;
    }
  }

  /* ===== FORM VALIDATION ===== */
  .pf-input:invalid,
  .pf-textarea:invalid {
    border-color: #EF4444;
  }

  .pf-input:invalid:focus,
  .pf-textarea:invalid:focus {
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
  }

  /* ===== LOADING STATE ===== */
  .pf-submitting .pf-btn-primary {
    opacity: 0.7;
    cursor: wait;
  }

  .pf-submitting .pf-btn-primary::after {
    content: '';
    display: inline-block;
    width: 12px;
    height: 12px;
    margin-left: 8px;
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script nonce="<%= nonce %>">
document.addEventListener("DOMContentLoaded", () => {
  // Image preview functionality
  const imageInput = document.getElementById("imageFile");
  const previewWrapper = document.getElementById("previewWrapper");
  const previewImg = document.getElementById("imagePreview");
  const form = document.getElementById("addProductForm");

  if (imageInput) {
    imageInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        // Validate file size (5MB limit)
        if (file.size > 5 * 1024 * 1024) {
          showToast("Image size must be less than 5MB", "error");
          imageInput.value = "";
          return;
        }

        // Validate file type
        const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!validTypes.includes(file.type)) {
          showToast("Only JPG, PNG, GIF, or WebP images are allowed", "error");
          imageInput.value = "";
          return;
        }

        const url = URL.createObjectURL(file);
        previewImg.src = url;
        previewWrapper.style.display = "block";
      }
    });
  }

  // Remove image function
  window.removeImage = function() {
    if (imageInput) imageInput.value = "";
    previewWrapper.style.display = "none";
  };

  // Toast notification function
  function showToast(message, type = "success") {
    const container = document.getElementById("toast-container");
    const toast = document.createElement("div");
    toast.className = `pf-toast ${type === "error" ? "pf-toast-error" : ""}`;
    toast.textContent = message;
    container.appendChild(toast);

    // Remove toast after 4 seconds
    setTimeout(() => {
      toast.style.opacity = "0";
      toast.style.transform = "translateY(20px) translateX(-50%)";
      setTimeout(() => toast.remove(), 300);
    }, 4000);
  }

  // Show any server-side messages
  const successMsg = "<%= success && success.length > 0 ? success : '' %>";
  const errorMsg = "<%= error && error.length > 0 ? error : '' %>";
  if (successMsg) showToast(successMsg);
  if (errorMsg) showToast(errorMsg, "error");

  // Form submission handling
  if (form) {
    form.addEventListener("submit", async (e) => {
      const submitBtn = form.querySelector('.pf-btn-primary');
      
      // Add loading state
      form.classList.add('pf-submitting');
      submitBtn.disabled = true;
      
      // Re-enable after 10 seconds if something goes wrong
      setTimeout(() => {
        form.classList.remove('pf-submitting');
        submitBtn.disabled = false;
      }, 10000);
    });
  }

  // Character counter for description
  const descriptionField = document.querySelector('textarea[name="description"]');
  if (descriptionField) {
    const hint = descriptionField.parentNode.querySelector('.pf-hint');
    const originalHint = hint.textContent;
    
    descriptionField.addEventListener('input', () => {
      const length = descriptionField.value.length;
      hint.textContent = `${length}/500 characters`;
      
      if (length > 500) {
        hint.style.color = '#EF4444';
      } else if (length > 450) {
        hint.style.color = '#F59E0B';
      } else {
        hint.style.color = '';
      }
    });
    
    // Initialize counter
    descriptionField.dispatchEvent(new Event('input'));
  }

  // Auto-format product ID
  const productIdField = document.querySelector('input[name="customId"]');
  if (productIdField) {
    productIdField.addEventListener('input', (e) => {
      let value = e.target.value.toUpperCase().replace(/[^A-Z0-9\-]/g, '');
      e.target.value = value;
    });
  }

  // Price formatting
  const priceField = document.querySelector('input[name="price"]');
  if (priceField) {
    priceField.addEventListener('blur', (e) => {
      let value = parseFloat(e.target.value);
      if (!isNaN(value)) {
        e.target.value = value.toFixed(2);
      }
    });
  }
});
</script>