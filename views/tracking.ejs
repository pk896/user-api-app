<!--views/tracking-->
<%
  const PAGE_NONCE = typeof nonce !== 'undefined' ? nonce : '';
  const BASE = (typeof baseUrl !== 'undefined' && baseUrl) ? baseUrl : '/orders/tracking';
  const o = order || {};
  const t = o.shippingTracking || {};
  const events = Array.isArray(t.liveEvents) ? t.liveEvents : [];

  function niceDate(d) {
    try {
      if (!d) return '';
      return new Date(d).toLocaleString('en-ZA', { timeZone: 'Africa/Johannesburg' });
    } catch { return String(d || ''); }
  }

  const pickEventDate = (ev) => {
    if (!ev) return null;
    return (
      ev.datetime ||
      ev.date ||
      ev.status_date ||
      ev.event_datetime ||
      ev.timestamp ||
      ev.created_at ||
      ev.updated_at ||
      null
    );
  };

  const eventsSorted = [...events].sort((a, b) => {
    const da = new Date(pickEventDate(a) || 0).getTime();
    const db = new Date(pickEventDate(b) || 0).getTime();
    return db - da;
  });

  const lastUpdateRaw =
    pickEventDate(eventsSorted[0]) ||
    t.lastTrackingUpdate ||
    t.lastUpdate ||
    t.lastUpdatedAt ||
    t.updatedAt ||
    o.updatedAt ||
    null;

  const etaRaw =
    t.eta ||
    t.estimated_delivery ||
    t.estimatedDelivery ||
    t.expected_delivery_date ||
    t.tracking_status?.eta ||
    null;

  const lastUpdateText = lastUpdateRaw ? niceDate(lastUpdateRaw) : '‚Äî';

  // Fallback ETA (approx) from chosen shipping rate (if tracking ETA is missing)
  const rateDays =
    o?.shippo?.chosenRate?.estimatedDays ??
    o?.shippo?.chosenRate?.estimated_days ??
    null;

  const labelDate =
    o?.shippo?.labelPurchasedAt ||
    o?.shippo?.transactionCreatedAt ||
    o?.updatedAt ||
    o?.createdAt ||
    null;

  const approxEtaRaw =
    (!etaRaw && rateDays != null && labelDate)
      ? new Date(new Date(labelDate).getTime() + (Number(rateDays) * 24 * 60 * 60 * 1000))
      : null;

  const etaFinalText = etaRaw
    ? niceDate(etaRaw)
    : (approxEtaRaw ? (niceDate(approxEtaRaw) + ' (approx)') : '‚Äî');

  // ----------------------------
  // UI display helpers (no DB changes)
  // ----------------------------
  const prettyCarrier = (v) => {
    const s = String(v || '').trim();
    if (!s) return '';
    const m = {
      usps: 'USPS',
      ups: 'UPS',
      fedex: 'FedEx',
      dhl_express: 'DHL Express',
      dhl: 'DHL',
      shippo: 'Shippo (Test)',
      COURIER_GUY: 'The Courier Guy',
      FASTWAY: 'Fastway',
      ARAMEX: 'Aramex',
      OTHER: 'Other',
    };
    return m[s] || m[s.toUpperCase()] || s;
  };

  const prettyStatus = (v) => {
    const s = String(v || '').trim().toUpperCase();
    const m = {
      PENDING: 'Pending',
      PROCESSING: 'Processing',
      LABEL_CREATED: 'Label created',
      SHIPPED: 'Shipped',
      IN_TRANSIT: 'In transit',
      OUT_FOR_DELIVERY: 'Out for delivery',
      DELIVERED: 'Delivered',
      CANCELLED: 'Cancelled',
      RETURNED: 'Returned',
      FAILURE: 'Tracking error',
      UNKNOWN: 'Unknown',
    };
    return m[s] || (s ? s.replace(/_/g, ' ').toLowerCase().replace(/^\w/, c => c.toUpperCase()) : '‚Äî');
  };

  // small tag text for pills (keeps your nice UI)
  const statusTag = (v) => String(prettyStatus(v) || '‚Äî');

  // Return a CSS class name based on status (UI-only)
  const statusClass = (v) => {
    const s = String(v || '').trim().toUpperCase();

    if (s === 'DELIVERED') return 'pill--ok';

    if (s === 'OUT_FOR_DELIVERY') return 'pill--ship';
    if (s === 'IN_TRANSIT') return 'pill--ship';
    if (s === 'SHIPPED') return 'pill--ship';
    if (s === 'LABEL_CREATED') return 'pill--ship';

    if (s === 'CANCELLED') return 'pill--bad';
    if (s === 'RETURNED') return 'pill--bad';
    if (s === 'FAILURE') return 'pill--bad';

    if (s === 'PROCESSING') return 'pill--muted';
    if (s === 'PENDING') return 'pill--muted';
    if (s === 'UNKNOWN') return 'pill--muted';

    return 'pill--muted';
  };

  const eventDetails = (ev) => {
    const d = String(ev?.details || '').trim();
    const r = String(ev?.rawStatus || '').trim();
    // Prefer details; fallback to raw status; fallback to pretty status
    return d || r || prettyStatus(ev?.status);
  };

  const eventLocationLine = (loc) => {
    if (!loc || typeof loc !== 'object') return '';
    const city = String(loc?.city || '').trim();
    const state = String(loc?.state || '').trim();
    const country = String(loc?.country || loc?.country_code || '').trim();
    const parts = [city, state, country].filter(Boolean);
    return parts.join(', ');
  };

  const toArray = (v) => {
    if (!v) return [];
    if (Array.isArray(v)) return v;
    return [String(v)];
  };

  // ----------------------------------------------------
  // Fallback tracking URL generator (when t.trackingUrl missing)
  // Supports common carriers incl. DHL Express (global / SA use)
  // ----------------------------------------------------
  const buildCarrierTrackingUrl = (carrierToken, trackingNumber) => {
    const c = String(carrierToken || '').trim().toLowerCase();
    const tn = encodeURIComponent(String(trackingNumber || '').trim());
    if (!c || !tn) return '';

    if (c === 'usps') {
      return `https://tools.usps.com/go/TrackConfirmAction?tLabels=${tn}`;
    }
    if (c === 'ups') {
      return `https://www.ups.com/track?tracknum=${tn}`;
    }
    if (c === 'fedex') {
      return `https://www.fedex.com/fedextrack/?trknbr=${tn}`;
    }
    if (c.includes('dhl')) {
      return `https://www.dhl.com/global-en/home/tracking/tracking-express.html?submit=1&tracking-id=${tn}`;
    }

    // South Africa carrier placeholders (add exact URL formats when ready)
    // if (c === 'courier_guy') return `...${tn}`;
    // if (c === 'fastway') return `...${tn}`;
    // if (c === 'aramex') return `...${tn}`;

    return '';
  };

  const trackingUrlFinal =
    String(t.trackingUrl || '').trim() ||
    buildCarrierTrackingUrl(t.carrierToken || t.carrier, t.trackingNumber);

  // Label link (prefer Shippo label URL, then any tracking-side label URL if you store one)
  const labelUrlFinal =
    String(
      o?.shippo?.labelUrl ||
      o?.shippo?.label_url ||
      o?.shippo?.labelPdfUrl ||
      o?.shippo?.label_pdf ||
      t?.labelUrl ||
      ''
    ).trim();

  const successList = toArray(success);
  const errorList = toArray(error);
%>

<section class="trk">
  <header class="trk__head">
    <div>
      <h1>üì¶ Order Tracking</h1>
      <div class="muted">OrderId: <span class="mono"><%= o.orderId || '‚Äî' %></span></div>
      <div class="muted tiny">Created: <%= niceDate(o.createdAt) %></div>
    </div>
    <div class="trk__actions">
      <a class="btn btn-outline" href="<%= isAdmin ? '/admin/shippo' : '/orders' %>">‚Üê Back</a>
      <button class="btn btn-primary" type="button" id="btnRefresh">Refresh live tracking</button>
    </div>
  </header>

  <% successList.forEach(msg => { %>
    <div class="flash ok">‚úÖ <%= msg %></div>
  <% }) %>
  <% errorList.forEach(msg => { %>
    <div class="flash bad">‚ùå <%= msg %></div>
  <% }) %>

  <div class="grid">
    <div class="card">
      <h2>Current tracking</h2>

      <div class="row">
        <div class="label">Carrier</div>
        <div class="value">
          <%= (t.carrierLabel || prettyCarrier(t.carrier) || '‚Äî') %>
          <% if (t.carrierToken) { %>
            <span class="pill"><%= prettyCarrier(t.carrierToken) %></span>
          <% } %>
        </div>
      </div>

      <% if (trackingUrlFinal) { %>
        <div class="row">
          <div class="label">Tracking link</div>
          <div class="value">
            <a class="link link-card" href="<%= trackingUrlFinal %>" target="_blank" rel="noopener noreferrer">
              Open carrier tracking ‚Üó
            </a>
          </div>
        </div>
      <% } %>

      <% if (labelUrlFinal) { %>
        <div class="row">
          <div class="label">Shipping label</div>
          <div class="value">
            <a class="link link-card" href="<%= labelUrlFinal %>" target="_blank" rel="noopener noreferrer">
              Open shipping label ‚Üó
            </a>
          </div>
        </div>
      <% } %>

      <div class="row">
        <div class="label">Status</div>
        <div class="value">
          <span class="pill solid <%= statusClass(t.liveStatus || t.status) %>">
            <%= statusTag(t.liveStatus || t.status) %>
          </span>
          <% if (t.status && t.liveStatus && String(t.status).toUpperCase() !== String(t.liveStatus).toUpperCase()) { %>
            <span class="pill <%= statusClass(t.status) %>"><%= 'Saved: ' + statusTag(t.status) %></span>
          <% } %>
        </div>
      </div>

      <div class="row">
        <div class="label">Last update</div>
        <div class="value muted"><%= lastUpdateText %></div>
      </div>

      <div class="row">
        <div class="label">ETA</div>
        <div class="value muted"><%= etaFinalText %></div>
      </div>

      <% if (isAdmin) { %>
        <hr class="hr" />

        <h2>Admin: set tracking</h2>

        <form method="POST" action="<%= BASE %>/<%= o._id %>" class="form">
          <label class="field">
            <span>Carrier (Shippo token)</span>
            <select name="carrier" class="select" required>
              <option value="">Choose‚Ä¶</option>
              <option value="usps" <%= t.carrierToken==='usps' ? 'selected' : '' %>>USPS</option>
              <option value="ups" <%= t.carrierToken==='ups' ? 'selected' : '' %>>UPS</option>
              <option value="fedex" <%= t.carrierToken==='fedex' ? 'selected' : '' %>>FedEx</option>
              <option value="dhl_express" <%= t.carrierToken==='dhl_express' ? 'selected' : '' %>>DHL Express</option>
            </select>
          </label>

          <label class="field">
            <span>Tracking number</span>
            <input name="trackingNumber" class="input" value="<%= t.trackingNumber || '' %>" placeholder="Enter tracking number" required />
          </label>

          <label class="field">
            <span>Carrier display name (optional)</span>
            <input
              name="carrierLabel"
              class="input"
              value="<%= t.carrierLabel || '' %>"
              placeholder="Name shown on page (e.g. DHL Express South Africa)"
            />
          </label>

          <div class="help muted">
            Tracking link is auto-shown from the saved URL (or generated from carrier + tracking number if URL is missing).
          </div>

          <% if (labelUrlFinal) { %>
            <div class="help muted">
              Shipping label is available above as a clickable link.
            </div>
          <% } else { %>
            <div class="help muted">
              Shipping label will appear automatically after a label URL is saved from your shipping flow.
            </div>
          <% } %>

          <button class="btn btn-primary" type="submit">Save tracking</button>

          <div class="help muted">
            We save the real carrier in <span class="mono">carrierToken</span>. This field only changes the display name shown on this page.
          </div>
        </form>
      <% } %>
    </div>

    <div class="card">
      <h2>Tracking events</h2>

      <div id="liveMsg" class="muted tiny"></div>

      <% if (!events.length) { %>
        <div class="empty muted">No live events yet. Click ‚ÄúRefresh live tracking‚Äù.</div>
      <% } else { %>
        <div class="events" id="eventsBox">
          <% events.slice().reverse().forEach(ev => { %>
            <div class="ev">
              <div class="ev__top">
                <span class="pill <%= statusClass(ev.status) %>"><%= statusTag(ev.status) %></span>
                <span class="muted tiny"><%= niceDate(pickEventDate(ev) || ev.date) %></span>
              </div>
              <div class="ev__mid"><%= eventDetails(ev) %></div>

              <% const locLine = eventLocationLine(ev.location); %>
              <% if (locLine) { %>
                <div class="muted tiny">üìç <%= locLine %></div>
              <% } else if (ev.location) { %>
                <div class="muted tiny"><%= JSON.stringify(ev.location) %></div>
              <% } %>
            </div>
          <% }) %>
        </div>
      <% } %>
    </div>
  </div>
</section>

<style nonce="<%= PAGE_NONCE %>">
.trk{
  --blue:#2563EB;
  --purple:#7C3AED;
  --green:#22C55E;
  --black:#0F172A;

  max-width: 1100px;
  margin: 0 auto;
  padding: 14px;
}
.trk *{box-sizing:border-box}
h1{margin:0;font-size:22px;color:var(--black)}
h2{margin:0 0 10px;font-size:14px;color:var(--black);text-transform:uppercase;letter-spacing:.05em}
.muted{color:#64748B}
.tiny{font-size:12px}
.mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}

.trk__head{
  display:flex;
  justify-content:space-between;
  gap:12px;
  flex-wrap:wrap;
  align-items:flex-start;
  padding: 12px;
  border-radius: 18px;
  border: 1px solid rgba(124,58,237,.18);
  background: linear-gradient(135deg, rgba(124,58,237,.10), rgba(37,99,235,.06));
  margin-bottom: 12px;
}
.trk__actions{display:flex;gap:10px;flex-wrap:wrap}

.btn{
  display:inline-flex;align-items:center;justify-content:center;
  gap:8px;padding:10px 12px;border-radius:14px;
  border:1px solid transparent;font-weight:950;cursor:pointer;text-decoration:none;
}
.btn-primary{background:linear-gradient(135deg, rgba(124,58,237,1), rgba(37,99,235,.95));color:#fff}
.btn-outline{background:#fff;border-color:rgba(148,163,184,.65);color:var(--black)}

.flash{
  padding:10px 12px;border-radius:14px;border:1px solid;margin: 10px 0;
}
.flash.ok{background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.25); color:#166534}
.flash.bad{background: rgba(239,68,68,.10); border-color: rgba(239,68,68,.25); color:#991B1B}

.grid{
  display:grid;
  grid-template-columns: 1.05fr .95fr;
  gap:12px;
}
.card{
  background:#fff;
  border:1px solid rgba(148,163,184,.45);
  border-radius: 18px;
  padding: 12px;
}

.row{
  display:grid;
  grid-template-columns: 160px 1fr;
  gap:10px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(148,163,184,.22);
}
.row:last-child{border-bottom:none}
.label{font-weight:950;color:rgba(15,23,42,.70);text-transform:uppercase;letter-spacing:.05em;font-size:11px}
.value{color:var(--black);font-weight:800}

.pill{
  display:inline-flex;align-items:center;gap:6px;
  padding: 4px 10px;border-radius:999px;
  border:1px solid rgba(124,58,237,.25);
  background: rgba(124,58,237,.10);
  color: var(--purple);
  font-size:12px;font-weight:950;
}
.pill.solid{
  border-color: rgba(15,23,42,.12);
  background: rgba(15,23,42,.04);
  color: var(--black);
}

/* -----------------------------
   Status color variants
------------------------------ */
.pill--ok{
  border-color: rgba(34,197,94,.35);
  background: rgba(34,197,94,.12);
  color: #166534;
}

.pill--ship{
  border-color: rgba(124,58,237,.35);
  background: rgba(124,58,237,.12);
  color: var(--purple);
}

.pill--muted{
  border-color: rgba(100,116,139,.35);
  background: rgba(100,116,139,.10);
  color: #334155;
}

.pill--bad{
  border-color: rgba(239,68,68,.35);
  background: rgba(239,68,68,.12);
  color: #991B1B;
}

/* When it's the main "solid" status pill, make it pop slightly */
.pill.solid.pill--ok{ background: rgba(34,197,94,.14); }
.pill.solid.pill--ship{ background: rgba(124,58,237,.14); }
.pill.solid.pill--muted{ background: rgba(100,116,139,.12); }
.pill.solid.pill--bad{ background: rgba(239,68,68,.14); }

.hr{border:none;border-top:1px solid rgba(148,163,184,.25);margin:12px 0}

.form{display:grid;gap:10px}
.field{display:grid;gap:6px}
.input,.select{
  width:100%;padding:10px 12px;border-radius:14px;
  border:1px solid rgba(148,163,184,.55);outline:none;
}
.input:focus,.select:focus{
  border-color: rgba(124,58,237,.55);
  box-shadow: 0 0 0 4px rgba(124,58,237,.14);
}
.help{font-size:12px}

.events{display:grid;gap:10px}
.ev{
  border:1px solid rgba(148,163,184,.40);
  border-radius:16px;
  padding:10px;
  background: rgba(248,250,252,1);
}
.ev__top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
.ev__mid{margin-top:6px;color:var(--black);font-weight:750}
.empty{padding:12px;border-radius:16px;border:1px dashed rgba(148,163,184,.55)}

@media (max-width: 880px){
  .grid{grid-template-columns:1fr}
  .row{grid-template-columns:1fr}
}

.link{color:var(--blue);font-weight:900;text-decoration:none}
.link:hover{text-decoration:underline}

.link-card{
  display:inline-flex;
  align-items:center;
  width:fit-content;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(37,99,235,.25);
  background: rgba(37,99,235,.06);
}
</style>

<script nonce="<%= PAGE_NONCE %>">
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('btnRefresh');
  const msg = document.getElementById('liveMsg');

  async function refresh() {
    if (msg) msg.textContent = 'Refreshing‚Ä¶';
    btn && (btn.disabled = true);

    let r, data;
    try {
      r = await fetch('<%= BASE %>/<%= o._id %>/refresh', {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      });
      data = await r.json().catch(() => ({}));
    } catch (e) {
      btn && (btn.disabled = false);
      if (msg) msg.textContent = '‚ùå Network error. Please try again.';
      return;
    }

    btn && (btn.disabled = false);

    if (!r.ok || !data.ok) {
      if (msg) msg.textContent = '‚ùå ' + (data.message || 'Failed to refresh');
      return;
    }

    if (msg) msg.textContent = '‚úÖ Updated. Reloading‚Ä¶';
    window.location.reload();
  }

  if (btn) btn.addEventListener('click', refresh);
});
</script>