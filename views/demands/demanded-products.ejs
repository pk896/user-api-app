<!-- views/demands/demanded-products.ejs -->
<%
const pageStyles = `
  /* ‚úÖ Brand Color System */
  :root {
    --blue: #2563EB;
    --blue-dark: #1d4ed8;
    --purple: #7C3AED;
    --purple-dark: #6d28d9;
    --green: #22C55E;
    --green-dark: #16a34a;
    --black: #0F172A;

    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-500: #64748b;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --gray-900: #0f172a;

    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    --radius-xl: 1rem;

    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);

    --transition: all 0.2s ease;
  }

  .dark-theme {
    --bg-primary: var(--black);
    --bg-secondary: var(--gray-800);
    --text-primary: var(--gray-100);
    --text-secondary: var(--gray-300);
    --text-muted: var(--gray-400);
    --border: var(--gray-700);
    --accent-bg: rgba(124, 58, 237, 0.14);
  }

  :root {
    --bg-primary: var(--gray-50);
    --bg-secondary: white;
    --text-primary: var(--gray-900);
    --text-secondary: var(--gray-600);
    --text-muted: var(--gray-500);
    --border: var(--gray-200);
    --accent-bg: rgba(124, 58, 237, 0.08);
  }

  /* ‚úÖ STOP horizontal scroll on phones */
  .demands-page,
  .demands-content {
    max-width: 100%;
    overflow-x: hidden;
  }

  /* ‚úÖ Page Container */
  .demands-page {
    width: min(1200px, calc(100% - 1rem));
    margin: 0.75rem auto;
    background: linear-gradient(135deg, var(--purple) 0%, var(--purple-dark) 100%);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-lg);
    border: 1px solid rgba(255,255,255,0.14);
  }

  .demands-content {
    background: var(--bg-primary);
    margin: 2px;
    border-radius: calc(var(--radius-xl) - 2px);
    padding: 1.1rem;
  }

  /* ‚úÖ Header */
  .demands-header {
    text-align: center;
    padding: 0.5rem 0 1.25rem;
    margin-bottom: 0.9rem;
    border-bottom: 2px solid var(--border);
  }

  .demands-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    background: linear-gradient(135deg, var(--purple), var(--blue));
    color: white;
    padding: 0.4rem 0.85rem;
    border-radius: 2rem;
    font-size: 0.75rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    box-shadow: var(--shadow-sm);
  }

  .page-title {
    font-size: 1.55rem;
    font-weight: 900;
    margin-bottom: 0.45rem;
    background: linear-gradient(135deg, var(--purple), var(--blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    line-height: 1.15;
  }

  .page-subtitle {
    color: var(--text-secondary);
    font-size: 0.9rem;
    max-width: 720px;
    margin: 0 auto;
  }

  /* ‚úÖ KPI Cards */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 0.85rem;
    margin: 1.25rem 0;
  }

  .kpi-card {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    padding: 1rem;
    border: 1px solid var(--border);
    transition: var(--transition);
    position: relative;
    overflow: hidden;
    min-width: 0;
  }

  .kpi-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
    border-color: rgba(124, 58, 237, 0.45);
  }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 4px;
    background: linear-gradient(to right, var(--purple), var(--green));
  }

  .kpi-label {
    font-size: 0.78rem;
    font-weight: 700;
    color: var(--text-muted);
    margin-bottom: 0.45rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .kpi-value {
    font-size: 1.6rem;
    font-weight: 900;
    color: var(--purple);
    line-height: 1;
  }

  /* ‚úÖ Filters */
  .filters-section {
    background: linear-gradient(135deg, rgba(124,58,237,0.10), rgba(37,99,235,0.08));
    border-radius: var(--radius-lg);
    padding: 1rem;
    margin: 1.1rem 0;
    border: 1px solid var(--border);
  }

  .filters-header {
    display: flex;
    align-items: center;
    gap: 0.7rem;
    margin-bottom: 0.85rem;
    justify-content: center;
  }

  .filters-header .section-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 36px;
    height: 36px;
    background: linear-gradient(135deg, var(--purple), var(--green));
    color: white;
    border-radius: var(--radius-md);
    font-size: 1rem;
    box-shadow: var(--shadow-sm);
  }

  .filters-header h2 {
    font-size: 1.05rem;
    color: var(--purple);
    font-weight: 900;
    margin: 0;
  }

  .filters-row {
    display: grid;
    grid-template-columns: 1fr 180px 160px;
    gap: 0.65rem;
    align-items: center;
  }

  .filter-input {
    width: 100%;
    padding: 0.7rem 0.9rem;
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 0.9rem;
    background: var(--bg-secondary);
    color: var(--text-primary);
    transition: var(--transition);
    min-width: 0;
  }

  .filter-input:focus {
    outline: none;
    border-color: var(--purple);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.12);
  }

  .filter-input::placeholder { color: var(--text-muted); }

  .filter-select {
    width: 100%;
    padding: 0.7rem 2.25rem 0.7rem 0.9rem;
    border: 2px solid var(--border);
    border-radius: var(--radius-md);
    font-size: 0.9rem;
    background: var(--bg-secondary) url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%2364748b' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e") no-repeat right 0.75rem center/16px 12px;
    color: var(--text-primary);
    transition: var(--transition);
    cursor: pointer;
    min-width: 0;
  }

  .filter-select:focus {
    outline: none;
    border-color: var(--purple);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.12);
  }

  /* ‚úÖ Buttons */
  .btn {
    padding: 0.7rem 1rem;
    border-radius: var(--radius-md);
    font-weight: 800;
    font-size: 0.9rem;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    transition: var(--transition);
    border: none;
    cursor: pointer;
    white-space: nowrap;
    min-width: 0;
  }

  .btn-secondary {
    background: linear-gradient(135deg, var(--purple), var(--purple-dark));
    color: white;
    box-shadow: var(--shadow-sm);
  }

  .btn-secondary:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .btn-export {
    background: linear-gradient(135deg, var(--green), var(--green-dark));
    color: white;
    box-shadow: var(--shadow-sm);
  }

  .btn-export:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  /* ‚úÖ Export row */
  .export-section {
    display: flex;
    justify-content: flex-end;
    margin: 0.9rem 0 1.2rem;
    gap: 0.5rem;
  }

  /* ‚úÖ Tabs */
  .tabs-section { margin: 1.2rem 0 0; }

  .tabs-header {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid var(--border);
    margin-bottom: 1rem;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 0.25rem;
  }

  .tab-btn {
    padding: 0.75rem 0.95rem;
    background: transparent;
    border: none;
    color: var(--text-secondary);
    font-weight: 900;
    font-size: 0.9rem;
    cursor: pointer;
    transition: var(--transition);
    white-space: nowrap;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
    border-radius: 0.75rem 0.75rem 0 0;
  }

  .tab-btn:hover { color: var(--purple); }

  .tab-btn.active {
    color: var(--purple);
    border-bottom-color: var(--purple);
    background: rgba(124, 58, 237, 0.06);
  }

  /* ‚úÖ Data blocks */
  .data-block {
    background: var(--bg-secondary);
    border-radius: var(--radius-lg);
    border: 1px solid var(--border);
    overflow: hidden;
    margin-bottom: 1.25rem;
  }

  .data-block.is-hidden { display: none; }

  .block-header {
    padding: 0.95rem 1rem;
    background: linear-gradient(135deg, rgba(124,58,237,0.10), rgba(37,99,235,0.06));
    border-bottom: 1px solid var(--border);
  }

  .block-header h3 {
    font-size: 1.05rem;
    color: var(--purple);
    font-weight: 900;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.55rem;
  }

  /* ‚úÖ Desktop Table */
  .table-wrapper { width: 100%; }

  .data-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  .data-table th {
    padding: 0.85rem 0.9rem;
    background: var(--bg-primary);
    color: var(--text-primary);
    font-weight: 900;
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.6px;
    border-bottom: 2px solid var(--border);
    text-align: left;
    white-space: nowrap;
  }

  .data-table td {
    padding: 0.75rem 0.9rem;
    border-bottom: 1px solid var(--border);
    color: var(--text-primary);
    font-size: 0.9rem;
    vertical-align: top;
    word-break: break-word;
    overflow-wrap: anywhere;
  }

  .data-table tbody tr:hover { background: rgba(124,58,237,0.06); }

  /* ‚úÖ Color-coded text */
  .cell-business { color: var(--green); font-weight: 900; }
  .cell-contact  { color: var(--blue); font-weight: 700; }
  .cell-product  { color: var(--purple); font-weight: 900; }
  .cell-type     { color: var(--green-dark); font-weight: 900; }
  .cell-quantity { color: var(--purple-dark); font-weight: 900; }
  .cell-country  { color: var(--blue); font-weight: 900; }
  .cell-province { color: var(--blue-dark); font-weight: 800; }
  .cell-city     { color: var(--purple); font-weight: 800; }
  .cell-town     { color: var(--purple-dark); font-weight: 800; }
  .cell-notes    { color: var(--text-secondary); font-style: italic; }

  .location-parts {
    display: flex;
    flex-wrap: wrap;
    gap: 0.35rem;
  }

  .location-part {
    background: rgba(124,58,237,0.08);
    border: 1px solid rgba(124,58,237,0.18);
    padding: 0.15rem 0.45rem;
    border-radius: var(--radius-sm);
    font-size: 0.78rem;
    max-width: 100%;
  }

  /* ‚úÖ No Data */
  .no-data {
    text-align: center;
    padding: 2.5rem 1rem;
    color: var(--text-muted);
  }

  .no-data-icon { font-size: 2rem; margin-bottom: 0.75rem; opacity: 0.7; }

  /* ‚úÖ MOBILE: turn table into cards (NO horizontal scroll) */
  @media (max-width: 768px) {
    .demands-page { width: calc(100% - 0.75rem); margin: 0.5rem auto; }
    .demands-content { padding: 0.95rem; }

    .kpi-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .kpi-card { padding: 0.9rem; }

    .filters-row {
      grid-template-columns: 1fr;
    }

    .export-section { justify-content: stretch; }
    .export-section .btn { width: 100%; }

    /* Card-table mode */
    .data-table,
    .data-table thead,
    .data-table tbody,
    .data-table th,
    .data-table td,
    .data-table tr {
      display: block;
      width: 100%;
    }

    .data-table thead { display: none; }

    .data-table tbody tr {
      border-bottom: 1px solid var(--border);
      padding: 0.85rem 0.85rem 0.65rem;
      background: var(--bg-secondary);
    }

    .data-table tbody tr:hover { background: rgba(124,58,237,0.05); }

    .data-table td {
      border: none;
      padding: 0.35rem 0;
    }

    .data-table td::before {
      content: attr(data-label);
      display: block;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      font-weight: 900;
      margin-bottom: 0.15rem;
    }
  }

  @media (max-width: 480px) {
    .page-title { font-size: 1.28rem; }
    .kpi-grid { grid-template-columns: 1fr; }
  }

  /* ‚úÖ Print */
  @media print {
    .demands-page { background: white !important; box-shadow: none !important; }
    .demands-content { background: white !important; margin: 0 !important; padding: 0 !important; }
    .btn, .filters-section, .tabs-header, .export-section { display: none !important; }
    .data-block { break-inside: avoid; }
  }

  /* ‚úÖ Animations */
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .kpi-card, .data-block { animation: fadeIn 0.25s ease-out; }
  .kpi-card:nth-child(2) { animation-delay: 0.06s; }
  .kpi-card:nth-child(3) { animation-delay: 0.12s; }
`;

const pageScripts = `
  document.addEventListener('DOMContentLoaded', function() {
    // Tabs
    const tabBtns = Array.from(document.querySelectorAll('.tab-btn'));
    const blocks = Array.from(document.querySelectorAll('.data-block'));

    function activateTab(targetId) {
      tabBtns.forEach(b => b.classList.toggle('active', b.getAttribute('data-target') === targetId));
      blocks.forEach(bl => bl.classList.toggle('is-hidden', bl.id !== targetId));
    }

    tabBtns.forEach(btn => {
      btn.addEventListener('click', () => activateTab(btn.getAttribute('data-target')));
    });

    // Filters
    const searchInput = document.getElementById('searchName');
    const filterType = document.getElementById('filterType');
    const clearFilters = document.getElementById('clearFilters');

    const rowsAll = Array.from(document.querySelectorAll('#tableAllDemands .row-demand'));
    const rowsNames = Array.from(document.querySelectorAll('#tableSummaryByName .row-name'));

    const kpiUnique = document.getElementById('kpiUniqueNames');
    const kpiQty = document.getElementById('kpiTotalQty');
    const kpiRequests = document.getElementById('kpiTotalRequests');

    function applyFilters() {
      const searchQuery = (searchInput?.value || '').trim().toLowerCase();
      const typeFilter = (filterType?.value || '').trim().toLowerCase();

      // All Demands
      let visibleRequests = 0;
      let runningQty = 0;

      rowsAll.forEach(row => {
        const name = row.dataset.name || '';
        const type = row.dataset.type || '';
        const qty  = Number(row.dataset.qty || 0);

        const matchesSearch = !searchQuery || name.includes(searchQuery);
        const matchesType   = !typeFilter || type === typeFilter;

        const show = matchesSearch && matchesType;
        row.style.display = show ? '' : 'none';

        if (show) {
          visibleRequests++;
          runningQty += qty;
        }
      });

      // Summary by Name
      let visibleNames = 0;
      let summaryTotalQty = 0;

      rowsNames.forEach(row => {
        const name = row.dataset.name || '';
        const types = row.dataset.types || '';
        const totalQty = Number(row.dataset.totalqty || 0);

        const matchesSearch = !searchQuery || name.includes(searchQuery);
        const matchesType   = !typeFilter || types.includes(typeFilter);

        const show = matchesSearch && matchesType;
        row.style.display = show ? '' : 'none';

        if (show) {
          visibleNames++;
          summaryTotalQty += totalQty;
        }
      });

      if (kpiUnique)   kpiUnique.textContent = String(visibleNames);
      if (kpiQty)      kpiQty.textContent = String(summaryTotalQty);
      if (kpiRequests) kpiRequests.textContent = String(visibleRequests);
    }

    if (searchInput) searchInput.addEventListener('input', applyFilters);
    if (filterType)  filterType.addEventListener('change', applyFilters);

    if (clearFilters) {
      clearFilters.addEventListener('click', function() {
        if (searchInput) searchInput.value = '';
        if (filterType) filterType.value = '';
        applyFilters();
      });
    }

    // Export
    const exportBtn = document.getElementById('exportData');
    if (exportBtn) {
      exportBtn.addEventListener('click', function() {
        const originalText = this.innerHTML;
        this.innerHTML = '<span>‚è≥</span> Preparing Export...';
        this.disabled = true;

        setTimeout(() => {
          alert('Export feature would download a CSV file with current filtered data.');
          this.innerHTML = originalText;
          this.disabled = false;
        }, 900);
      });
    }

    // Sort tables (desktop + mobile card-mode still sorts rows)
    function makeTableSortable(table) {
      const headers = table.querySelectorAll('th[data-sort]');
      headers.forEach(header => {
        header.style.cursor = 'pointer';
        header.addEventListener('click', function() {
          const column = this.getAttribute('data-sort');
          const isAsc = this.getAttribute('data-sort-direction') === 'asc';

          headers.forEach(h => {
            h.removeAttribute('data-sort-direction');
            h.innerHTML = h.innerHTML.replace(' ‚Üë', '').replace(' ‚Üì', '');
          });

          const dir = isAsc ? 'desc' : 'asc';
          this.setAttribute('data-sort-direction', dir);
          this.innerHTML += dir === 'asc' ? ' ‚Üë' : ' ‚Üì';

          sortTable(table, column, dir);
        });
      });
    }

    function sortTable(table, column, direction) {
      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r.style.display !== 'none');

      rows.sort((a, b) => {
        let aVal = a.querySelector(\`td[data-column="\${column}"]\`)?.textContent || '';
        let bVal = b.querySelector(\`td[data-column="\${column}"]\`)?.textContent || '';

        const aNum = parseFloat(aVal);
        const bNum = parseFloat(bVal);

        if (!Number.isNaN(aNum) && !Number.isNaN(bNum)) {
          aVal = aNum;
          bVal = bNum;
        } else {
          aVal = String(aVal).toLowerCase();
          bVal = String(bVal).toLowerCase();
        }

        if (direction === 'asc') return aVal > bVal ? 1 : -1;
        return aVal < bVal ? 1 : -1;
      });

      rows.forEach(r => tbody.appendChild(r));
    }

    document.querySelectorAll('.data-table').forEach(makeTableSortable);

    // Row quick action (KEEP PATH)
    document.querySelectorAll('.row-demand').forEach(row => {
      row.addEventListener('dblclick', function() {
        const productName = this.querySelector('.val-product-name')?.textContent;
        if (productName) window.open(\`/demands/search?q=\${encodeURIComponent(productName)}\`, '_blank');
      });
    });

    // Init
    activateTab('tableAllDemands');
    applyFilters();
  });
`;
%>

<!-- ‚úÖ Inject Styles -->
<style nonce="<%= nonce %>"><%- pageStyles %></style>

<!-- ‚úÖ Demanded Products Page -->
<div class="demands-page">
  <div class="demands-content">
    <!-- Header -->
    <header class="demands-header">
      <div class="demands-badge">
        <span>üìä</span>
        <span>Market Intelligence</span>
      </div>
      <h1 class="page-title">Demanded Products</h1>
      <p class="page-subtitle">
        Aggregated view of all product demands across the platform. Filter and analyze market trends.
      </p>
    </header>

    <!-- KPI Cards -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">Total Requests</div>
        <div class="kpi-value" id="kpiTotalRequests"><%= totals?.totalRequests || 0 %></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Unique Product Names</div>
        <div class="kpi-value" id="kpiUniqueNames"><%= totals?.uniqueProductNames || 0 %></div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">Total Quantity Demanded</div>
        <div class="kpi-value" id="kpiTotalQty"><%= totals?.totalQtyAll || 0 %></div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <div class="filters-header">
        <div class="section-icon">üîç</div>
        <h2>Filter & Search</h2>
      </div>

      <div class="filters-row">
        <input
          type="search"
          id="searchName"
          class="filter-input"
          placeholder="Search by product name‚Ä¶"
          aria-label="Search products"
        >

        <select id="filterType" class="filter-select" aria-label="Filter by type">
          <option value="">All Types</option>
          <% (types || []).forEach(t => { %>
            <option value="<%= t %>"><%= t %></option>
          <% }) %>
        </select>

        <button id="clearFilters" class="btn btn-secondary" type="button">Clear Filters</button>
      </div>
    </div>

    <!-- Export -->
    <div class="export-section">
      <button id="exportData" class="btn btn-export" type="button">
        <span>üì•</span>
        Export Data
      </button>
    </div>

    <!-- Tabs -->
    <div class="tabs-section">
      <div class="tabs-header">
        <button class="tab-btn active" type="button" data-target="tableAllDemands">
          <span>üìã</span> All Demands
        </button>
        <button class="tab-btn" type="button" data-target="tableSummaryByName">
          <span>üìà</span> Product Summary
        </button>
        <button class="tab-btn" type="button" data-target="tableByType">
          <span>üè∑Ô∏è</span> By Type
        </button>
        <button class="tab-btn" type="button" data-target="tableByLocation">
          <span>üìç</span> By Location
        </button>
      </div>

      <!-- ‚úÖ All Demands -->
      <div id="tableAllDemands" class="data-block">
        <div class="block-header">
          <h3><span>üìã</span> All Demands</h3>
        </div>
        <div class="table-wrapper">
          <% if (demandsAll && demandsAll.length) { %>
            <table class="data-table">
              <thead>
                <tr>
                  <th data-sort="requester">Requester</th>
                  <th data-sort="type">Type</th>
                  <th data-sort="product">Product</th>
                  <th data-sort="quantity">Qty</th>
                  <th data-sort="location">Location</th>
                  <th data-sort="notes">Notes</th>
                  <th data-sort="created">Created</th>
                </tr>
              </thead>
              <tbody>
                <% demandsAll.forEach(d => {
                  const nm  = (d.productName || '').trim();
                  const typ = (d.type || '').trim();
                %>
                  <tr
                    class="row-demand"
                    data-name="<%= nm.toLowerCase() %>"
                    data-type="<%= typ.toLowerCase() %>"
                    data-qty="<%= Number(d.quantity || 0) %>"
                  >
                    <td data-column="requester" data-label="Requester">
                      <div class="cell-business"><%= d.requester?.businessName || '‚Äî' %></div>
                      <div class="cell-contact">
                        <%= d.requester?.contactName || '‚Äî' %>
                        <% if (d.requester?.position) { %>
                          <span> ‚Ä¢ <%= d.requester.position %></span>
                        <% } %>
                      </div>
                    </td>

                    <td data-column="type" data-label="Type" class="cell-type"><%= typ || '‚Äî' %></td>

                    <td data-column="product" data-label="Product" class="cell-product">
                      <span class="val-product-name"><%= nm || '‚Äî' %></span>
                    </td>

                    <td data-column="quantity" data-label="Qty" class="cell-quantity">
                      <%= Number(d.quantity || 0) %>
                    </td>

                    <td data-column="location" data-label="Location">
                      <div class="location-parts">
                        <% if (d.country)  { %><span class="location-part cell-country"><%= d.country %></span><% } %>
                        <% if (d.province) { %><span class="location-part cell-province"><%= d.province %></span><% } %>
                        <% if (d.city)     { %><span class="location-part cell-city"><%= d.city %></span><% } %>
                        <% if (d.town)     { %><span class="location-part cell-town"><%= d.town %></span><% } %>
                      </div>
                    </td>

                    <td data-column="notes" data-label="Notes" class="cell-notes" title="<%= d.notes || '' %>">
                      <%= (d.notes || '').slice(0, 90) %><%= (d.notes && d.notes.length > 90) ? '‚Ä¶' : '' %>
                    </td>

                    <td data-column="created" data-label="Created">
                      <%= new Date(d.createdAt).toLocaleDateString() %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } else { %>
            <div class="no-data">
              <div class="no-data-icon">üì≠</div>
              <p>No demands found</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- ‚úÖ Product Summary -->
      <div id="tableSummaryByName" class="data-block is-hidden">
        <div class="block-header">
          <h3><span>üìà</span> Summary by Product Name</h3>
        </div>
        <div class="table-wrapper">
          <% if (summaryByName && summaryByName.length) { %>
            <table class="data-table">
              <thead>
                <tr>
                  <th data-sort="name">Product Name</th>
                  <th data-sort="types">Types (seen)</th>
                  <th data-sort="requests">Requests</th>
                  <th data-sort="totalqty">Total Qty</th>
                </tr>
              </thead>
              <tbody>
                <% summaryByName.forEach(s => { %>
                  <tr
                    class="row-name"
                    data-name="<%= (s.name || '').toLowerCase() %>"
                    data-types="<%= (s.types || []).map(t => String(t).toLowerCase()).join('|') %>"
                    data-totalqty="<%= Number(s.totalQty || 0) %>"
                  >
                    <td data-column="name" data-label="Product" class="cell-product"><%= s.name || '‚Äî' %></td>

                    <td data-column="types" data-label="Types">
                      <% (s.types || []).forEach((type, idx) => { %>
                        <span class="cell-type"><%= type %></span><%= idx < (s.types.length - 1) ? ', ' : '' %>
                      <% }) %>
                    </td>

                    <td data-column="requests" data-label="Requests" class="cell-quantity">
                      <%= Number(s.requests || 0) %>
                    </td>

                    <td data-column="totalqty" data-label="Total Qty" class="cell-quantity">
                      <%= Number(s.totalQty || 0) %>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } else { %>
            <div class="no-data">
              <div class="no-data-icon">üìä</div>
              <p>No summary data available</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- ‚úÖ By Type -->
      <div id="tableByType" class="data-block is-hidden">
        <div class="block-header">
          <h3><span>üè∑Ô∏è</span> By Type</h3>
        </div>
        <div class="table-wrapper">
          <% if (byType && byType.length) { %>
            <table class="data-table">
              <thead>
                <tr>
                  <th data-sort="type">Type</th>
                  <th data-sort="totalqty">Total Qty</th>
                  <th data-sort="requests">Requests</th>
                </tr>
              </thead>
              <tbody>
                <% byType.forEach(r => { %>
                  <tr>
                    <td data-column="type" data-label="Type" class="cell-type"><%= r._id || '‚Äî' %></td>
                    <td data-column="totalqty" data-label="Total Qty" class="cell-quantity"><%= Number(r.totalQty || 0) %></td>
                    <td data-column="requests" data-label="Requests" class="cell-quantity"><%= Number(r.docs || 0) %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } else { %>
            <div class="no-data">
              <div class="no-data-icon">üè∑Ô∏è</div>
              <p>No type data available</p>
            </div>
          <% } %>
        </div>
      </div>

      <!-- ‚úÖ By Location -->
      <div id="tableByLocation" class="data-block is-hidden">
        <div class="block-header">
          <h3><span>üìç</span> By Type & Location</h3>
        </div>
        <div class="table-wrapper">
          <% if (byTypeAndLocation && byTypeAndLocation.length) { %>
            <table class="data-table">
              <thead>
                <tr>
                  <th data-sort="type">Type</th>
                  <th data-sort="country">Country</th>
                  <th data-sort="province">Province</th>
                  <th data-sort="city">City</th>
                  <th data-sort="town">Town</th>
                  <th data-sort="totalqty">Total Qty</th>
                  <th data-sort="requests">Requests</th>
                </tr>
              </thead>
              <tbody>
                <% byTypeAndLocation.forEach(r => { %>
                  <tr>
                    <td data-column="type" data-label="Type" class="cell-type"><%= r._id?.type || '‚Äî' %></td>
                    <td data-column="country" data-label="Country" class="cell-country"><%= r._id?.country || '‚Äî' %></td>
                    <td data-column="province" data-label="Province" class="cell-province"><%= r._id?.province || '‚Äî' %></td>
                    <td data-column="city" data-label="City" class="cell-city"><%= r._id?.city || '‚Äî' %></td>
                    <td data-column="town" data-label="Town" class="cell-town"><%= r._id?.town || '‚Äî' %></td>
                    <td data-column="totalqty" data-label="Total Qty" class="cell-quantity"><%= Number(r.totalQty || 0) %></td>
                    <td data-column="requests" data-label="Requests" class="cell-quantity"><%= Number(r.docs || 0) %></td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          <% } else { %>
            <div class="no-data">
              <div class="no-data-icon">üìç</div>
              <p>No location data available</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ Inject Scripts -->
<script nonce="<%= nonce %>"><%- pageScripts %></script>

