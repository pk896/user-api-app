<!--views/edit-product.ejs-->
<div class="edit-product-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="28" height="28">
          <path fill="currentColor" d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
        </svg>
      </div>
      <div class="header-text">
        <h1 class="page-title">Edit Product</h1>
        <p class="page-subtitle">Update your product information and images</p>
      </div>
    </div>
    <a href="/products/all" class="back-button" aria-label="Back to all products">
      <svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
        <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
      <span>All Products</span>
    </a>
  </div>

  <!-- Flash Messages (kept as-is; styled only) -->
  <div class="flash-container">
    <% if (success && success.length > 0) { %>
      <div class="flash flash-success" role="status" aria-live="polite">
        <svg class="flash-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
        <div class="flash-content">
          <strong>Success!</strong>
          <p><%= success %></p>
        </div>
      </div>
    <% } %>
    <% if (error && error.length > 0) { %>
      <div class="flash flash-error" role="alert" aria-live="assertive">
        <svg class="flash-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
          <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
        <div class="flash-content">
          <strong>Error!</strong>
          <p><%= error %></p>
        </div>
      </div>
    <% } %>
  </div>

  <div class="page-content <%= themeCss.includes('dark') ? 'dark-theme' : 'light-theme' %>">
    <% if (!business) { %>
      <!-- No business session -->
      <div class="auth-required-card">
        <div class="auth-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="48" height="48">
            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
          </svg>
        </div>
        <h3>Authentication Required</h3>
        <p>You must be logged in with a business account to edit products.</p>
        <div class="auth-actions">
          <a href="/business/login" class="btn btn-primary">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path fill="currentColor" d="M10 17v-3H3v-4h7V7l5 5-5 5z"/>
            </svg>
            Business Login
          </a>
          <a href="/business/register" class="btn btn-secondary">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Register Business
          </a>
        </div>
      </div>

    <% } else if (["seller", "supplier"].includes(business.role)) { %>
      <!-- SELLER / SUPPLIER: Full edit form -->
      <%
        const prodRole  = (product.role  || '').toLowerCase();
        const prodType  = (product.type  || '').toLowerCase();
        const isShoes   = prodType === 'shoes' || prodRole === 'shoes';
        const isClothes = prodRole === 'clothes' || prodType === 'clothes';

        // ---------------------------
        // Shipping / package defaults (backwards compatible)
        // ---------------------------
        const ship = product.shipping || {};
        const shipWeight = ship.weight || {};
        const shipDims = ship.dimensions || {};

        const shipWeightValue = (shipWeight.value ?? '');
        const shipWeightUnit  = (shipWeight.unit  ?? 'kg');

        const shipLength = (shipDims.length ?? '');
        const shipWidth  = (shipDims.width  ?? '');
        const shipHeight = (shipDims.height ?? '');
        const shipDimUnit = (shipDims.unit ?? 'cm');

        const packagingHint = (ship.packagingHint ?? '');
        const shipSeparately = !!ship.shipSeparately;
        const fragile = !!ship.fragile;
      %>

      <div class="edit-form-container">
        <div class="form-tabs" role="tablist" aria-label="Edit product tabs">
          <button type="button" class="tab active" data-tab="basic" role="tab" aria-selected="true">Basic Info</button>
          <button type="button" class="tab" data-tab="details" role="tab" aria-selected="false">Details</button>
          <button type="button" class="tab" data-tab="media" role="tab" aria-selected="false">Media</button>
        </div>

        <form
          id="editProductForm"
          action="/products/edit/<%= product.customId %>"
          method="POST"
          enctype="multipart/form-data"
          class="product-form"
          novalidate
        >
          <!-- Basic Info Tab -->
          <div class="tab-content active" id="basic-tab" role="tabpanel">
            <div class="form-section section-purple">
              <div class="section-header">
                <svg class="section-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                  <path fill="currentColor" d="M4 6h16v2H4zm0 4h16v2H4zm0 4h16v2H4zm0 4h16v2H4z"/>
                </svg>
                <h3>Product Information</h3>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="name" class="form-label">
                    Product Name <span class="required">*</span>
                  </label>
                  <input
                    id="name"
                    type="text"
                    name="name"
                    value="<%= product.name %>"
                    required
                    class="form-input"
                    placeholder="Enter product name"
                    autocomplete="off"
                  />
                  <div class="form-hint">Make it descriptive and searchable</div>
                </div>

                <div class="form-group">
                  <label for="price" class="form-label">
                    Price ($) <span class="required">*</span>
                  </label>
                  <div class="input-with-icon">
                    <span class="currency-icon" aria-hidden="true">$</span>
                    <input
                      id="price"
                      type="number"
                      name="price"
                      step="0.01"
                      min="0.01"
                      value="<%= product.price %>"
                      required
                      class="form-input"
                      placeholder="0.00"
                      inputmode="decimal"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="stock" class="form-label">Stock Quantity</label>
                  <input
                    id="stock"
                    type="number"
                    name="stock"
                    min="0"
                    value="<%= product.stock %>"
                    class="form-input"
                    placeholder="Available units"
                    inputmode="numeric"
                  />
                  <div class="form-hint">Leave 0 for out of stock</div>
                </div>

                <div class="form-group">
                  <label for="category" class="form-label">Category</label>
                  <input
                    id="category"
                    type="text"
                    name="category"
                    value="<%= product.category || '' %>"
                    class="form-input"
                    placeholder="e.g., Electronics, Clothing"
                  />
                </div>
              </div>
            </div>

            <div class="form-section section-blue">
              <div class="section-header">
                <svg class="section-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                  <path fill="currentColor" d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 9c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm0-4c-.55 0-1 .45-1 1s.45 1 1 1 1-.45 1-1-.45-1-1-1zm6 10H6v-1.53c0-2.5 3.97-3.58 6-3.58s6 1.08 6 3.58V18zm-9.69-2h7.38c-.69-.56-2.38-1.12-3.69-1.12s-3.01.56-3.69 1.12z"/>
                </svg>
                <h3>Description</h3>
              </div>

              <div class="form-group">
                <label for="description" class="form-label">Product Description</label>
                <textarea
                  id="description"
                  name="description"
                  rows="6"
                  class="form-textarea"
                  placeholder="Describe your product features, benefits, and specifications..."
                ><%= product.description || '' %></textarea>
                <div class="form-hint">Include key details that help customers make decisions</div>
                <div class="char-counter">
                  <span id="charCount">0</span> / 2000 characters
                </div>
              </div>
            </div>
          </div>

          <!-- Details Tab -->
          <div class="tab-content" id="details-tab" role="tabpanel">
            <div class="form-section section-black">
              <div class="section-header">
                <svg class="section-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                  <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                </svg>
                <h3>Product Specifications</h3>
              </div>

              <div class="form-grid">
                <!-- ROLE (enum) -->
                <div class="form-group">
                  <label for="role" class="form-label">Product Role</label>
                  <select id="role" name="role" class="form-select">
                    <option value="">Select role...</option>
                    <option value="general"     <%= product.role === 'general' ? 'selected' : '' %>>General</option>
                    <option value="clothes"     <%= product.role === 'clothes' ? 'selected' : '' %>>Clothes</option>
                    <option value="electronics" <%= product.role === 'electronics' ? 'selected' : '' %>>Electronics</option>
                    <option value="home"        <%= product.role === 'home' ? 'selected' : '' %>>Home</option>
                    <option value="beauty"      <%= product.role === 'beauty' ? 'selected' : '' %>>Beauty</option>
                    <option value="groceries"   <%= product.role === 'groceries' ? 'selected' : '' %>>Groceries</option>
                  </select>
                  <div class="form-hint">
                    Controls variants (sizes/colors) and product behaviour.
                  </div>
                </div>

                <!-- MATCHING TYPE (string, used in demands etc.) -->
                <div class="form-group">
                  <label for="type" class="form-label">Product Type</label>
                  <input
                    id="type"
                    type="text"
                    name="type"
                    value="<%= product.type || '' %>"
                    class="form-input"
                    placeholder="e.g., shoes, t-shirt, laptop"
                  />
                  <div class="form-hint">
                    Used to match demands (e.g. type = "shoes").
                  </div>
                </div>

                <!-- MANUFACTURER -->
                <div class="form-group">
                  <label for="manufacturer" class="form-label">Manufacturer</label>
                  <input
                    id="manufacturer"
                    type="text"
                    name="manufacturer"
                    value="<%= product.manufacturer || '' %>"
                    class="form-input"
                    placeholder="Brand or manufacturer name"
                  />
                </div>

                <!-- COUNTRY OF ORIGIN -->
                <div class="form-group">
                  <label for="made" class="form-label">Country of Origin</label>
                  <input
                    id="made"
                    type="text"
                    name="made"
                    value="<%= product.made || '' %>"
                    class="form-input"
                    placeholder="e.g., South Africa, China, Germany"
                  />
                </div>

                <!-- SINGLE COLOR (backwards compatible) -->
                <div class="form-group">
                  <label for="color" class="form-label">Default Color</label>
                  <input
                    id="color"
                    type="text"
                    name="color"
                    value="<%= product.color || '' %>"
                    class="form-input"
                    placeholder="e.g., Black"
                  />
                  <div class="form-hint">
                    Used for non-clothing or default variant.
                  </div>
                </div>

                <!-- SINGLE SIZE (backwards compatible) -->
                <div class="form-group">
                  <label for="size" class="form-label">Default Size</label>
                  <input
                    id="size"
                    type="text"
                    name="size"
                    value="<%= product.size || '' %>"
                    class="form-input"
                    placeholder="e.g., M, 42, 10x5x2 cm"
                  />
                  <div class="form-hint">
                    Used for non-clothing or default variant.
                  </div>
                </div>

                <!-- QUALITY -->
                <div class="form-group">
                  <label for="quality" class="form-label">Quality Grade</label>
                  <select id="quality" name="quality" class="form-select">
                    <option value="">Select quality...</option>
                    <option value="Premium"  <%= product.quality === 'Premium'  ? 'selected' : '' %>>Premium</option>
                    <option value="Standard" <%= product.quality === 'Standard' ? 'selected' : '' %>>Standard</option>
                    <option value="Economy"  <%= product.quality === 'Economy'  ? 'selected' : '' %>>Economy</option>
                    <option value="Wholesale"<%= product.quality === 'Wholesale'? 'selected' : '' %>>Wholesale</option>
                  </select>
                </div>

                <!-- VARIANT SIZES ARRAY -->
                <div class="form-group">
                  <label for="sizes" class="form-label">
                    <%= isShoes ? 'Shoe sizes' : (isClothes ? 'Clothing sizes' : 'Sizes (array)') %>
                  </label>
                  <input
                    id="sizes"
                    type="text"
                    name="sizes"
                    value="<%= (product.sizes && product.sizes.length ? product.sizes.join(', ') : '') %>"
                    class="form-input"
                    placeholder="<%= isShoes
                      ? 'e.g., 3, 4, 5, 6, 7, 8, 9'
                      : (isClothes ? 'e.g., XS, S, M, L, XL' : 'Comma-separated sizes') %>"
                  />
                  <div class="form-hint">
                    <%= isShoes
                      ? 'Comma-separated shoe sizes. These are used in the shop size dropdown.'
                      : (isClothes
                        ? 'Comma-separated clothing sizes. For clothes this should not be empty.'
                        : 'Comma-separated list of sizes or dimensions.') %>
                  </div>
                </div>

                <!-- VARIANT COLORS ARRAY -->
                <div class="form-group">
                  <label for="colors" class="form-label">Colors (array)</label>
                  <input
                    id="colors"
                    type="text"
                    name="colors"
                    value="<%= (product.colors && product.colors.length ? product.colors.join(', ') : '') %>"
                    class="form-input"
                    placeholder="e.g., Red, Blue, Black"
                  />
                  <div class="form-hint">
                    Comma-separated list. For clothes this must not be empty.
                  </div>
                </div>

                <!-- ==========================
                ðŸ“¦ Shipping (for accurate Shippo rates)
                ========================== -->
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label class="form-label">ðŸ“¦ Shipping & Package Info</label>
                  <div class="form-hint">
                    <strong>Required.</strong> These measurements are used to calculate Shippo rates at checkout.
                    Enter ONE item (without the shipping box).
                  </div>
                </div>

                <!-- Weight -->
                <div class="form-group">
                  <label class="form-label">Item Weight <span class="required">*</span></label>
                  <div style="display:flex; gap:10px; align-items:center;">
                    <input
                      type="number"
                      name="shipWeightValue"
                      step="0.001"
                      min="0.1"
                      placeholder="e.g., 0.50"
                      required
                      value="<%= shipWeightValue %>"
                      required
                      class="form-input"
                    />
                    <select name="shipWeightUnit" class="form-select" style="max-width: 120px;">
                      <option value="kg" <%= shipWeightUnit === 'kg' ? 'selected' : '' %>>kg</option>
                      <option value="g"  <%= shipWeightUnit === 'g'  ? 'selected' : '' %>>g</option>
                      <option value="lb" <%= shipWeightUnit === 'lb' ? 'selected' : '' %>>lb</option>
                      <option value="oz" <%= shipWeightUnit === 'oz' ? 'selected' : '' %>>oz</option>
                    </select>
                  </div>
                  <div class="form-hint">Weight of ONE item (no box). Example: 0.5 kg</div>
                </div>

                <!-- Packaging hint -->
                <div class="form-group">
                  <label class="form-label">Packaging Hint (optional)</label>
                  <input
                    type="text"
                    name="packagingHint"
                    value="<%= packagingHint %>"
                    placeholder="e.g., small-box / tube / fragile"
                    class="form-input"
                  />
                  <div class="form-hint">Helps auto-packing later. Leave empty if unsure.</div>
                </div>

                <!-- Dimensions -->
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label class="form-label">Item Dimensions (L Ã— W Ã— H) <span class="required">*</span></label>
                  <div style="display:grid; grid-template-columns: 1fr 1fr 1fr auto; gap:10px;">
                    <input
                      type="number"
                      name="shipLength"
                      step="0.1"
                      min="0"
                      placeholder="Length"
                      value="<%= shipLength %>"
                      required
                      class="form-input"
                    />
                    <input
                      type="number"
                      name="shipWidth"
                      step="0.1"
                      min="0"
                      placeholder="Width"
                      value="<%= shipWidth %>"
                      required
                      class="form-input"
                    />
                    <input
                      type="number"
                      name="shipHeight"
                      step="0.1"
                      min="0"
                      placeholder="Height"
                      value="<%= shipHeight %>"
                      required
                      class="form-input"
                    />
                    <select name="shipDimUnit" class="form-select" style="max-width: 110px;">
                      <option value="cm" <%= shipDimUnit === 'cm' ? 'selected' : '' %>>cm</option>
                      <option value="in" <%= shipDimUnit === 'in' ? 'selected' : '' %>>in</option>
                    </select>
                  </div>
                  <div class="form-hint">Dimensions of ONE item (no box). Example: 30 Ã— 20 Ã— 10 cm</div>
                </div>

                <!-- Flags -->
                <div class="form-group" style="grid-column: 1 / -1;">
                  <label class="form-label">Shipping Flags</label>
                  <div class="flags-row">
                    <label class="flag">
                      <input type="hidden" name="shipSeparately" value="0" />
                      <input
                        type="checkbox"
                        name="shipSeparately"
                        value="on"
                        <%= shipSeparately ? 'checked' : '' %>
                      />
                      <span>Ship separately</span>
                    </label>

                    <label class="flag">
                      <!-- hidden ensures "fragile" is always present even when unchecked -->
                      <input type="hidden" name="fragile" value="0" />
                      <input
                        type="checkbox"
                        name="fragile"
                        value="on"
                        <%= fragile ? 'checked' : '' %>
                      />
                      <span>Fragile</span>
                    </label>

                  </div>
                  <div class="form-hint">Use if this product must be boxed alone or needs careful handling.</div>
                </div>

                <!-- STATUS FLAGS -->
                <div class="form-group">
                  <label class="form-label">Status Flags</label>
                  <div class="flags-row">
                    <label class="flag">
                      <input type="checkbox" name="isNew" <%= product.isNew ? 'checked' : '' %> />
                      <span>New</span>
                    </label>
                    <label class="flag">
                      <input type="checkbox" name="isOnSale" <%= product.isOnSale ? 'checked' : '' %> />
                      <span>On sale</span>
                    </label>
                    <label class="flag">
                      <input type="checkbox" name="isPopular" <%= product.isPopular ? 'checked' : '' %> />
                      <span>Popular</span>
                    </label>
                  </div>
                  <div class="form-hint">
                    Used for badges, filters and sorting in the shop.
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Media Tab -->
          <div class="tab-content" id="media-tab" role="tabpanel">
            <div class="form-section section-green">
              <div class="section-header">
                <svg class="section-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                  <path fill="currentColor" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                </svg>
                <h3>Product Images</h3>
              </div>

              <div class="media-grid">
                <div class="current-image-card">
                  <div class="image-card-header">
                    <h4>Current Image</h4>
                    <span class="image-status">Active</span>
                  </div>
                  <img
                    src="<%= product.imageUrl %>"
                    alt="Current image for <%= product.name %>"
                    class="current-image-preview"
                    loading="lazy"
                  />
                  <div class="image-info">
                    <div class="image-dimensions">Display image</div>
                    <div class="image-hint">This is the image customers see</div>
                  </div>
                </div>

                <div class="upload-image-card">
                  <div class="image-card-header">
                    <h4>Upload New Image</h4>
                    <span class="image-optional">Optional</span>
                  </div>

                  <div class="upload-area" id="uploadArea" tabindex="0" role="button" aria-label="Upload a new product image">
                    <svg class="upload-icon" viewBox="0 0 24 24" width="48" height="48" aria-hidden="true">
                      <path fill="currentColor" d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                    <p class="upload-text">Drag & drop or tap to upload</p>
                    <p class="upload-subtext">PNG, JPG up to 5MB</p>
                    <input
                      id="imageFile"
                      type="file"
                      name="imageFile"
                      accept="image/*"
                      class="file-input"
                    />
                  </div>

                  <div id="newImagePreviewWrapper" class="image-preview-wrapper" style="display:none;">
                    <div class="preview-header">
                      <h4>New Image Preview</h4>
                      <button type="button" class="remove-preview" id="removePreview" aria-label="Remove new image preview">
                        <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                          <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                      </button>
                    </div>
                    <img id="newImagePreview" class="new-image-preview" alt="New image preview" />
                    <div class="preview-info">
                      <span id="fileName"></span>
                      <span id="fileSize"></span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <div class="action-buttons">
              <button type="submit" class="btn btn-primary">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                </svg>
                Save Changes
              </button>

              <a href="/products/view/<%= product.customId %>" class="btn btn-secondary">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
                View Details
              </a>

              <button type="button" class="btn btn-danger" id="deleteProduct">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                Delete Product
              </button>
            </div>

            <div class="form-note">
              <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
              </svg>
              Fields marked with <span class="required">*</span> are required
            </div>
          </div>
        </form>
      </div>

    <% } else { %>
      <!-- BUYER: Read-only view -->
      <div class="view-only-container">
        <div class="product-view-card">
          <div class="product-header">
            <h2 class="product-title"><%= product.name %></h2>
            <div class="product-price">
              <span class="currency">$</span>
              <span class="amount"><%= Number(product.price).toFixed(2) %></span>
            </div>
          </div>

          <div class="product-content">
            <div class="product-media">
              <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="product-image" />
              <div class="stock-status <%= product.stock > 0 ? 'in-stock' : 'out-of-stock' %>">
                <% if (product.stock > 0) { %>
                  <svg class="status-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                    <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                  </svg>
                  <span>In Stock: <strong><%= product.stock %></strong> units</span>
                <% } else { %>
                  <svg class="status-icon" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
                    <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                  <span>Out of Stock</span>
                <% } %>
              </div>
            </div>

            <div class="product-details">
              <div class="details-section">
                <h3>Product Details</h3>
                <div class="details-grid">
                  <% if (product.category) { %>
                    <div class="detail-item">
                      <span class="detail-label">Category</span>
                      <span class="detail-value"><%= product.category %></span>
                    </div>
                  <% } %>
                  <% if (product.type) { %>
                    <div class="detail-item">
                      <span class="detail-label">Type</span>
                      <span class="detail-value"><%= product.type %></span>
                    </div>
                  <% } %>
                  <% if (product.color) { %>
                    <div class="detail-item">
                      <span class="detail-label">Color</span>
                      <span class="detail-value"><%= product.color %></span>
                    </div>
                  <% } %>
                  <% if (product.size) { %>
                    <div class="detail-item">
                      <span class="detail-label">Size</span>
                      <span class="detail-value"><%= product.size %></span>
                    </div>
                  <% } %>
                  <% if (product.quality) { %>
                    <div class="detail-item">
                      <span class="detail-label">Quality</span>
                      <span class="detail-value"><%= product.quality %></span>
                    </div>
                  <% } %>
                  <% if (product.made) { %>
                    <div class="detail-item">
                      <span class="detail-label">Made In</span>
                      <span class="detail-value"><%= product.made %></span>
                    </div>
                  <% } %>
                  <% if (product.manufacturer) { %>
                    <div class="detail-item">
                      <span class="detail-label">Manufacturer</span>
                      <span class="detail-value"><%= product.manufacturer %></span>
                    </div>
                  <% } %>
                </div>
              </div>

              <% if (product.description) { %>
                <div class="description-section">
                  <h3>Description</h3>
                  <div class="description-content">
                    <%= product.description %>
                  </div>
                </div>
              <% } %>
            </div>
          </div>

          <div class="product-actions">
            <a href="/products/all" class="btn btn-secondary">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
              </svg>
              Back to Products
            </a>
            <% if (product.stock > 0) { %>
              <a href="/api/cart/add?pid=<%= product.customId %>" class="btn btn-primary">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                Add to Cart
              </a>
            <% } else { %>
              <button class="btn btn-disabled" disabled>
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
                Out of Stock
              </button>
            <% } %>
          </div>
        </div>
      </div>
    <% } %>
  </div>
</div>

<style>
  /* =========================
     Unicoporate â€“ Edit Product
     Mobile-first, Purple-dominant
     ========================= */

  .edit-product-page {
    --pg-purple: #7C3AED;
    --pg-blue: #2563EB;
    --pg-green: #22C55E;
    --pg-black: #0F172A;

    --bg: #F8FAFC;
    --card: #FFFFFF;
    --muted: #64748B;
    --line: #E2E8F0;

    --radius-lg: 16px;
    --radius-md: 12px;
    --radius-sm: 10px;

    --shadow: 0 10px 30px rgba(2, 6, 23, 0.10);
    --shadow-soft: 0 6px 18px rgba(2, 6, 23, 0.08);

    max-width: 1100px;
    margin: 0 auto;
    padding: 0.75rem; /* mobile tighter */

    background: var(--bg);
    border-radius: var(--radius-lg);
  }

  /* Prevent overflow on small phones */
  .edit-product-page *,
  .edit-product-page *::before,
  .edit-product-page *::after {
    box-sizing: border-box;
  }
  .edit-product-page img { max-width: 100%; height: auto; }

  /* Dark theme overrides (page-scoped only) */
  .edit-product-page .dark-theme {
    --bg: #0B1220;
    --card: rgba(15, 23, 42, 0.85);
    --muted: #94A3B8;
    --line: rgba(148, 163, 184, 0.20);
  }

  /* Header */
  .page-header {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
    align-items: start;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(124, 58, 237, 0.25);
  }

  .header-content {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    min-width: 0;
  }

  .header-icon {
    width: 46px;
    height: 46px;
    border-radius: 14px;
    background: linear-gradient(135deg, var(--pg-purple) 0%, var(--pg-blue) 100%);
    display: grid;
    place-items: center;
    box-shadow: 0 10px 24px rgba(124, 58, 237, 0.22);
    flex: 0 0 auto;
  }
  .header-icon svg { color: #fff; }

  .header-text { min-width: 0; }
  .page-title {
    margin: 0;
    font-size: 1.18rem;
    line-height: 1.15;
    font-weight: 800;
    color: var(--pg-black);
    letter-spacing: -0.02em;
    word-break: break-word;
  }
  .dark-theme .page-title { color: #F1F5F9; }

  .page-subtitle {
    margin: 0.25rem 0 0;
    font-size: 0.9rem;
    color: var(--muted);
  }

  .back-button {
    width: 100%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.7rem 0.9rem;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 700;
    color: var(--pg-purple);
    background: rgba(124, 58, 237, 0.10);
    border: 1px solid rgba(124, 58, 237, 0.18);
    transition: transform .15s ease, background .15s ease, border-color .15s ease;
  }
  .back-button:hover {
    background: rgba(124, 58, 237, 0.14);
    border-color: rgba(124, 58, 237, 0.28);
    transform: translateY(-1px);
  }

  /* Flash */
  .flash-container { margin-bottom: 0.75rem; }
  .flash {
    display: flex;
    gap: 0.75rem;
    padding: 0.85rem;
    border-radius: 14px;
    margin-bottom: 0.6rem;
    border: 1px solid var(--line);
    box-shadow: var(--shadow-soft);
    background: var(--card);
  }
  .flash-icon { flex: 0 0 auto; margin-top: 2px; }
  .flash-content strong { display: block; font-size: 0.92rem; margin-bottom: 0.15rem; }
  .flash-content p { margin: 0; color: var(--muted); font-size: 0.92rem; }

  .flash-success {
    border-left: 5px solid var(--pg-green);
  }
  .flash-success .flash-icon { color: var(--pg-green); }
  .flash-error {
    border-left: 5px solid #EF4444;
  }
  .flash-error .flash-icon { color: #EF4444; }

  /* Auth card */
  .auth-required-card {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius-lg);
    padding: 1.25rem;
    text-align: center;
    box-shadow: var(--shadow);
    max-width: 520px;
    margin: 1rem auto;
  }
  .auth-icon {
    width: 70px;
    height: 70px;
    border-radius: 20px;
    margin: 0 auto 0.85rem;
    display: grid;
    place-items: center;
    background: linear-gradient(
      135deg,
      rgba(124, 58, 237, 0.14) 0%,
      rgba(37, 99, 235, 0.12) 100%
    );
    border: 1px solid rgba(124, 58, 237, 0.18);
  }
  .auth-icon svg { color: var(--pg-purple); }

  .auth-required-card h3 {
    margin: 0 0 0.5rem;
    color: var(--pg-black);
    font-size: 1.15rem;
    font-weight: 800;
  }
  .dark-theme .auth-required-card h3 { color: #F1F5F9; }

  .auth-required-card p {
    margin: 0 0 1rem;
    color: var(--muted);
    font-size: 0.95rem;
  }

  .auth-actions {
    display: grid;
    gap: 0.6rem;
  }

  /* Main container */
  .edit-form-container {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow);
  }

  /* Tabs: scrollable chips on mobile */
  .form-tabs {
    display: flex;
    gap: 0.5rem;
    padding: 0.75rem;
    background: rgba(124, 58, 237, 0.06);
    border-bottom: 1px solid rgba(124, 58, 237, 0.18);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
  .form-tabs::-webkit-scrollbar { height: 6px; }
  .form-tabs::-webkit-scrollbar-thumb { background: rgba(124, 58, 237, 0.25); border-radius: 999px; }

  .tab {
    flex: 0 0 auto;
    padding: 0.55rem 0.85rem;
    border-radius: 999px;
    border: 1px solid rgba(124, 58, 237, 0.18);
    background: #fff;
    color: var(--pg-black);
    font-weight: 800;
    font-size: 0.92rem;
    cursor: pointer;
    transition: transform .12s ease, background .12s ease, border-color .12s ease, color .12s ease;
    white-space: nowrap;
  }
  .dark-theme .tab { background: rgba(15, 23, 42, 0.65); color: #E2E8F0; }

  .tab:hover { transform: translateY(-1px); }
  .tab.active {
    background: linear-gradient(135deg, var(--pg-purple) 0%, var(--pg-blue) 100%);
    color: #fff;
    border-color: rgba(255,255,255,0.22);
    box-shadow: 0 12px 24px rgba(124, 58, 237, 0.22);
  }

  /* Content */
  .tab-content {
    display: none;
    padding: 0.85rem;
  }
  .tab-content.active { display: block; }

  /* Section cards with visible brand accents */
  .form-section {
    border-radius: var(--radius-lg);
    border: 1px solid var(--line);
    background: #fff;
    box-shadow: var(--shadow-soft);
    padding: 0.85rem;
    margin-bottom: 0.85rem;
    position: relative;
    overflow: hidden;
  }
  .dark-theme .form-section {
    background: rgba(15, 23, 42, 0.55);
    border-color: rgba(148, 163, 184, 0.20);
  }

  .form-section::before {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    width: 8px;
    height: 100%;
    background: var(--pg-purple);
    opacity: 0.95;
  }

  .section-purple::before { background: var(--pg-purple); }
  .section-blue::before { background: var(--pg-blue); }
  .section-green::before { background: var(--pg-green); }
  .section-black::before { background: var(--pg-black); }

  .section-header {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    margin-bottom: 0.75rem;
    padding-left: 0.25rem; /* space from accent bar */
  }
  .section-icon { color: var(--pg-purple); }
  .section-blue .section-icon { color: var(--pg-blue); }
  .section-green .section-icon { color: var(--pg-green); }
  .section-black .section-icon { color: var(--pg-black); }
  .dark-theme .section-black .section-icon { color: #E2E8F0; }

  .section-header h3 {
    margin: 0;
    font-size: 1.02rem;
    font-weight: 900;
    color: var(--pg-black);
    letter-spacing: -0.01em;
  }
  .dark-theme .section-header h3 { color: #F1F5F9; }

  /* Grid: mobile-first (1 col), then 2 cols */
  .form-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  @media (min-width: 720px) {
    .page-header { grid-template-columns: 1fr auto; align-items: center; }
    .back-button { width: auto; }
    .tab-content { padding: 1.25rem; }
    .form-section { padding: 1.15rem; }
    .form-grid { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
  }

  /* Labels + inputs */
  .form-group { margin-bottom: 0.4rem; }
  .form-label {
    display: block;
    margin-bottom: 0.4rem;
    font-weight: 900;
    color: var(--pg-black);
    font-size: 0.92rem;
  }
  .dark-theme .form-label { color: #E2E8F0; }
  .required { color: #EF4444; }

  .form-input,
  .form-textarea,
  .form-select {
    width: 100%;
    padding: 0.78rem 0.9rem;
    font-size: 0.98rem;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: #fff;
    color: var(--pg-black);
    transition: border-color .12s ease, box-shadow .12s ease, transform .12s ease;
  }
  .dark-theme .form-input,
  .dark-theme .form-textarea,
  .dark-theme .form-select {
    background: rgba(2, 6, 23, 0.25);
    border-color: rgba(148, 163, 184, 0.22);
    color: #F1F5F9;
  }

  .form-input:focus,
  .form-textarea:focus,
  .form-select:focus {
    outline: none;
    border-color: rgba(124, 58, 237, 0.65);
    box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.14);
    transform: translateY(-1px);
  }

  .form-select {
    appearance: none;
    background-image:
      linear-gradient(45deg, transparent 50%, rgba(124, 58, 237, 0.8) 50%),
      linear-gradient(135deg, rgba(124, 58, 237, 0.8) 50%, transparent 50%);
    background-position:
      calc(100% - 18px) calc(50% - 2px),
      calc(100% - 12px) calc(50% - 2px);
    background-size: 6px 6px, 6px 6px;
    background-repeat: no-repeat;
    padding-right: 2.2rem;
  }

  .form-textarea { min-height: 120px; resize: vertical; }

  .input-with-icon { position: relative; }
  .currency-icon {
    position: absolute;
    left: 0.9rem;
    top: 50%;
    transform: translateY(-50%);
    font-weight: 900;
    color: rgba(15, 23, 42, 0.65);
  }
  .dark-theme .currency-icon { color: rgba(241, 245, 249, 0.75); }
  .input-with-icon .form-input { padding-left: 2.1rem; }

  .form-hint {
    margin-top: 0.35rem;
    font-size: 0.88rem;
    color: var(--muted);
  }

  .char-counter {
    text-align: right;
    font-size: 0.85rem;
    color: var(--muted);
    margin-top: 0.35rem;
  }

  /* Status flags */
  .flags-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.6rem;
    align-items: center;
  }
  .flag {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.55rem 0.7rem;
    border-radius: 999px;
    border: 1px solid rgba(124, 58, 237, 0.22);
    background: rgba(124, 58, 237, 0.06);
    font-weight: 800;
    font-size: 0.92rem;
    color: var(--pg-black);
  }
  .dark-theme .flag { color: #E2E8F0; border-color: rgba(148, 163, 184, 0.22); background: rgba(148, 163, 184, 0.10); }
  .flag input { width: 16px; height: 16px; accent-color: var(--pg-purple); }

  /* Media */
  .media-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.85rem;
  }
  @media (min-width: 900px) {
    .media-grid { grid-template-columns: 1fr 1fr; gap: 1.25rem; }
  }

  .current-image-card,
  .upload-image-card {
    background: rgba(124, 58, 237, 0.04);
    border-radius: var(--radius-lg);
    padding: 0.9rem;
    border: 1px solid rgba(124, 58, 237, 0.16);
  }
  .dark-theme .current-image-card,
  .dark-theme .upload-image-card {
    background: rgba(2, 6, 23, 0.18);
    border-color: rgba(148, 163, 184, 0.20);
  }

  .image-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.75rem;
  }
  .image-card-header h4 {
    margin: 0;
    font-size: 0.98rem;
    font-weight: 900;
    color: var(--pg-black);
  }
  .dark-theme .image-card-header h4 { color: #F1F5F9; }

  .image-status {
    background: var(--pg-green);
    color: #fff;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    font-size: 0.78rem;
    font-weight: 900;
  }
  .image-optional {
    background: rgba(37, 99, 235, 0.12);
    color: var(--pg-blue);
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    font-size: 0.78rem;
    font-weight: 900;
  }

  .current-image-preview {
    width: 100%;
    height: 190px;
    object-fit: contain;
    border-radius: 14px;
    background: #fff;
    border: 1px solid rgba(15, 23, 42, 0.10);
  }
  .dark-theme .current-image-preview {
    background: rgba(2, 6, 23, 0.25);
    border-color: rgba(148, 163, 184, 0.20);
  }

  .image-info {
    display: flex;
    justify-content: space-between;
    gap: 0.75rem;
    margin-top: 0.6rem;
    color: var(--muted);
    font-size: 0.88rem;
  }

  /* Upload area: mobile tap-friendly */
  .upload-area {
    border: 2px dashed rgba(124, 58, 237, 0.35);
    border-radius: var(--radius-lg);
    padding: 1.1rem;
    text-align: center;
    position: relative;
    cursor: pointer;
    background: rgba(124, 58, 237, 0.05);
    transition: transform .12s ease, border-color .12s ease, background .12s ease;
    outline: none;
  }
  .upload-area:hover,
  .upload-area:focus {
    border-color: rgba(124, 58, 237, 0.65);
    background: rgba(124, 58, 237, 0.08);
    transform: translateY(-1px);
  }
  .upload-icon { color: rgba(124, 58, 237, 0.55); margin-bottom: 0.5rem; }
  .upload-text {
    margin: 0 0 0.25rem;
    font-weight: 900;
    color: var(--pg-black);
  }
  .dark-theme .upload-text { color: #F1F5F9; }
  .upload-subtext { margin: 0; font-size: 0.88rem; color: var(--muted); }

  .file-input {
    position: absolute;
    inset: 0;
    opacity: 0;
    cursor: pointer;
  }

  .image-preview-wrapper { margin-top: 0.75rem; }
  .preview-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.6rem;
    gap: 0.75rem;
  }
  .remove-preview {
    background: rgba(239, 68, 68, 0.12);
    border: 1px solid rgba(239, 68, 68, 0.20);
    width: 38px;
    height: 38px;
    border-radius: 12px;
    display: grid;
    place-items: center;
    cursor: pointer;
    transition: transform .12s ease, background .12s ease;
  }
  .remove-preview:hover { background: rgba(239, 68, 68, 0.18); transform: translateY(-1px); }
  .remove-preview svg { color: #EF4444; }

  .new-image-preview {
    width: 100%;
    height: 160px;
    object-fit: contain;
    border-radius: 14px;
    background: #fff;
    border: 1px solid rgba(15, 23, 42, 0.10);
  }
  .dark-theme .new-image-preview {
    background: rgba(2, 6, 23, 0.25);
    border-color: rgba(148, 163, 184, 0.20);
  }
  .preview-info {
    display: flex;
    justify-content: space-between;
    gap: 0.75rem;
    margin-top: 0.45rem;
    font-size: 0.88rem;
    color: var(--muted);
    word-break: break-word;
  }

  /* Actions: sticky-like feel on mobile without interfering with layout */
  .form-actions {
    padding: 0.9rem;
    border-top: 1px solid rgba(124, 58, 237, 0.16);
    background: rgba(124, 58, 237, 0.04);
  }
  .dark-theme .form-actions {
    background: rgba(2, 6, 23, 0.18);
    border-top-color: rgba(148, 163, 184, 0.18);
  }

  .action-buttons {
    display: grid;
    gap: 0.6rem;
    margin-bottom: 0.75rem;
  }
  @media (min-width: 720px) {
    .action-buttons { grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; }
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.55rem;
    padding: 0.85rem 1rem;
    font-size: 0.98rem;
    font-weight: 900;
    border-radius: 14px;
    border: 1px solid transparent;
    cursor: pointer;
    text-decoration: none;
    transition: transform .12s ease, box-shadow .12s ease, filter .12s ease, background .12s ease, border-color .12s ease;
    user-select: none;
  }

  /* Purple primary (dominant brand) */
  .btn-primary {
    background: linear-gradient(135deg, var(--pg-purple) 0%, var(--pg-blue) 100%);
    color: #fff;
    box-shadow: 0 14px 30px rgba(124, 58, 237, 0.22);
  }
  .btn-primary:hover { transform: translateY(-1px); filter: brightness(1.02); }

  /* Blue secondary */
  .btn-secondary {
    background: rgba(37, 99, 235, 0.10);
    color: var(--pg-blue);
    border-color: rgba(37, 99, 235, 0.22);
  }
  .btn-secondary:hover { background: rgba(37, 99, 235, 0.14); transform: translateY(-1px); }

  /* Danger */
  .btn-danger {
    background: rgba(239, 68, 68, 0.10);
    color: #EF4444;
    border-color: rgba(239, 68, 68, 0.22);
  }
  .btn-danger:hover { background: rgba(239, 68, 68, 0.14); transform: translateY(-1px); }

  .btn-disabled {
    background: rgba(148, 163, 184, 0.22);
    color: rgba(100, 116, 139, 1);
    cursor: not-allowed;
    border-color: transparent;
  }

  .form-note {
    display: flex;
    align-items: flex-start;
    gap: 0.55rem;
    font-size: 0.9rem;
    color: var(--muted);
  }
  .form-note svg { color: var(--pg-purple); margin-top: 2px; }

  /* Buyer (view only) */
  .view-only-container { max-width: 980px; margin: 0 auto; }
  .product-view-card {
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow);
    padding: 1rem;
  }

  .product-header {
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    justify-content: space-between;
    border-bottom: 1px solid var(--line);
    padding-bottom: 0.75rem;
    margin-bottom: 0.75rem;
  }
  .product-title { margin: 0; font-size: 1.12rem; font-weight: 900; color: var(--pg-black); }
  .dark-theme .product-title { color: #F1F5F9; }

  .product-price { display: flex; gap: 0.2rem; align-items: baseline; }
  .currency, .amount { color: var(--pg-green); font-weight: 900; }
  .currency { font-size: 1.05rem; }
  .amount { font-size: 1.55rem; }

  .product-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.9rem;
  }
  @media (min-width: 900px) {
    .product-content { grid-template-columns: 320px 1fr; gap: 1.25rem; }
  }

  .product-image {
    width: 100%;
    height: 260px;
    object-fit: contain;
    border-radius: 14px;
    border: 1px solid rgba(15, 23, 42, 0.10);
    background: #fff;
  }
  .dark-theme .product-image { background: rgba(2, 6, 23, 0.25); border-color: rgba(148, 163, 184, 0.20); }

  .stock-status {
    margin-top: 0.65rem;
    display: flex;
    gap: 0.5rem;
    align-items: center;
    padding: 0.7rem 0.85rem;
    border-radius: 14px;
    font-weight: 800;
  }
  .in-stock { background: rgba(34, 197, 94, 0.12); color: #166534; border: 1px solid rgba(34, 197, 94, 0.22); }
  .out-of-stock { background: rgba(239, 68, 68, 0.10); color: #991B1B; border: 1px solid rgba(239, 68, 68, 0.22); }

  .details-section h3,
  .description-section h3 {
    margin: 0 0 0.55rem;
    font-size: 1.02rem;
    font-weight: 900;
    color: var(--pg-black);
  }
  .dark-theme .details-section h3,
  .dark-theme .description-section h3 { color: #F1F5F9; }

  .details-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.55rem;
  }
  @media (min-width: 520px) {
    .details-grid { grid-template-columns: repeat(2, 1fr); }
  }

  .detail-item {
    display: flex;
    justify-content: space-between;
    gap: 0.75rem;
    padding: 0.7rem;
    border-radius: 14px;
    background: rgba(37, 99, 235, 0.06);
    border: 1px solid rgba(37, 99, 235, 0.14);
  }
  .dark-theme .detail-item {
    background: rgba(148, 163, 184, 0.10);
    border-color: rgba(148, 163, 184, 0.18);
  }
  .detail-label { font-weight: 900; color: rgba(15, 23, 42, 0.75); }
  .dark-theme .detail-label { color: rgba(241, 245, 249, 0.70); }
  .detail-value { font-weight: 800; color: var(--pg-black); }
  .dark-theme .detail-value { color: #F1F5F9; }

  .description-section {
    margin-top: 0.85rem;
    padding-top: 0.85rem;
    border-top: 1px solid var(--line);
  }
  .description-content { line-height: 1.6; color: var(--muted); }

  .product-actions {
    display: grid;
    gap: 0.6rem;
    margin-top: 0.9rem;
    padding-top: 0.9rem;
    border-top: 1px solid var(--line);
  }
  @media (min-width: 720px) {
    .product-actions { grid-template-columns: 1fr 1fr; }
  }

  /* Motion */
  @media (prefers-reduced-motion: reduce) {
    .tab, .btn, .back-button, .upload-area, .form-input, .form-select, .form-textarea { transition: none !important; }
  }
</style>

<!-- Secure Inline Script -->
<script nonce="<%= nonce %>">
  document.addEventListener("DOMContentLoaded", () => {
    console.log("âœï¸ Edit Product page loaded securely with CSP nonce âœ…");

    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');

        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // aria-selected
        tabs.forEach(t => t.setAttribute('aria-selected', t.classList.contains('active') ? 'true' : 'false'));

        // Show corresponding content
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === `${tabId}-tab`) {
            content.classList.add('active');
          }
        });
      });
    });

    // Character counter for description
    const descriptionTextarea = document.getElementById('description');
    const charCount = document.getElementById('charCount');

    if (descriptionTextarea && charCount) {
      // Set initial count
      charCount.textContent = descriptionTextarea.value.length;

      descriptionTextarea.addEventListener('input', function() {
        charCount.textContent = this.value.length;

        // Add warning for long text
        if (this.value.length > 2000) {
          charCount.style.color = '#EF4444';
        } else if (this.value.length > 1500) {
          charCount.style.color = '#F59E0B';
        } else {
          charCount.style.color = '';
        }
      });
    }

    // Image upload preview
    const imageInput = document.getElementById('imageFile');
    const uploadArea = document.getElementById('uploadArea');
    const previewWrapper = document.getElementById('newImagePreviewWrapper');
    const newImagePreview = document.getElementById('newImagePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removePreviewBtn = document.getElementById('removePreview');

    if (imageInput && uploadArea) {
      // Click on upload area
      uploadArea.addEventListener('click', () => {
        imageInput.click();
      });

      // Keyboard support
      uploadArea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          imageInput.click();
        }
      });

      // Drag and drop
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
      });

      function highlight() {
        uploadArea.style.borderColor = 'rgba(124, 58, 237, 0.75)';
        uploadArea.style.background = 'rgba(124, 58, 237, 0.10)';
      }

      function unhighlight() {
        uploadArea.style.borderColor = '';
        uploadArea.style.background = '';
      }

      // Handle file drop
      uploadArea.addEventListener('drop', handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }

      // Handle file input change
      imageInput.addEventListener('change', function() {
        if (this.files.length > 0) {
          handleFiles(this.files);
        }
      });

      function handleFiles(files) {
        const file = files[0];
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file');
          return;
        }

        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          return;
        }

        const url = URL.createObjectURL(file);
        newImagePreview.src = url;
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        previewWrapper.style.display = 'block';
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
    }

    // Remove preview
    if (removePreviewBtn) {
      removePreviewBtn.addEventListener('click', () => {
        imageInput.value = '';
        previewWrapper.style.display = 'none';
        newImagePreview.src = '';
      });
    }

    // Delete product confirmation
    const deleteBtn = document.getElementById('deleteProduct');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
          window.location.href = `/products/delete/<%= product.customId %>`;
        }
      });
    }

    // Form validation
    const form = document.getElementById('editProductForm');
    if (form) {
      form.addEventListener('submit', function(e) {
        const requiredFields = this.querySelectorAll('[required]');
        let isValid = true;

        // reset any previous borders
        requiredFields.forEach(field => (field.style.borderColor = ''));

        // 1) required non-empty
        requiredFields.forEach(field => {
          if (!String(field.value || '').trim()) {
            isValid = false;
            field.style.borderColor = '#EF4444';
          }
        });

        // 2) shipping > 0 validation (prevents 0 / negative / NaN)
        const w  = this.querySelector('input[name="shipWeightValue"]');
        const l  = this.querySelector('input[name="shipLength"]');
        const wi = this.querySelector('input[name="shipWidth"]');
        const h  = this.querySelector('input[name="shipHeight"]');

        const toNum = (el) => Number(String(el?.value || '').trim());
        const bad = [];

        if (!w  || !Number.isFinite(toNum(w))  || toNum(w)  <= 0) bad.push(w);
        if (!l  || !Number.isFinite(toNum(l))  || toNum(l)  <= 0) bad.push(l);
        if (!wi || !Number.isFinite(toNum(wi)) || toNum(wi) <= 0) bad.push(wi);
        if (!h  || !Number.isFinite(toNum(h))  || toNum(h)  <= 0) bad.push(h);

        bad.forEach((el) => {
          if (el) el.style.borderColor = '#EF4444';
        });

        if (bad.length) isValid = false;

        if (!isValid) {
          e.preventDefault();

          const firstBad =
            this.querySelector('[required]:invalid') ||
            bad.find(Boolean) ||
            this.querySelector('[required]');

          if (firstBad && firstBad.scrollIntoView) {
            firstBad.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }

          alert('Shipping weight and dimensions are required and must be greater than 0.');
        }
      });
    }
  });
</script>
