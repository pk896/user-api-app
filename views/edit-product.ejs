<!--views/edit-product.ejs-->
<div class="edit-product-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" width="26" height="26">
          <path fill="currentColor" d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
        </svg>
      </div>

      <div class="header-text">
        <h1 class="page-title">Edit Product</h1>
        <p class="page-subtitle">Update your product information and images</p>
      </div>
    </div>

    <a href="/products/all" class="back-button" aria-label="Back to all products">
      <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
        <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
      </svg>
      <span>All Products</span>
    </a>
  </div>

  <!-- Flash Messages (kept as-is; styled only) -->
  <div class="flash-container">
    <% if (success && success.length > 0) { %>
      <div class="flash flash-success" role="status" aria-live="polite">
        <svg class="flash-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
        </svg>
        <div class="flash-content">
          <strong>Success</strong>
          <p><%= success %></p>
        </div>
      </div>
    <% } %>

    <% if (error && error.length > 0) { %>
      <div class="flash flash-error" role="alert" aria-live="assertive">
        <svg class="flash-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
          <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
        <div class="flash-content">
          <strong>Error</strong>
          <p><%= error %></p>
        </div>
      </div>
    <% } %>
  </div>

  <div class="page-content <%= (themeCss && themeCss.includes('dark')) ? 'dark-theme' : 'light-theme' %>">
    <% if (business) { %>
      <%
        // âœ… Role removed: we only use product.type now
        const prodType  = (product.type  || '').toLowerCase();
        const isShoes   = prodType === 'shoes';
        const isClothes = prodType === 'clothes';

        // ---------------------------
        // Shipping / package defaults (backwards compatible)
        // ---------------------------
        const ship = product.shipping || {};
        const shipWeight = ship.weight || {};
        const shipDims = ship.dimensions || {};

        const shipWeightValue = (shipWeight.value ?? '');
        const shipWeightUnit  = (shipWeight.unit  ?? 'kg');

        const shipLength = (shipDims.length ?? '');
        const shipWidth  = (shipDims.width  ?? '');
        const shipHeight = (shipDims.height ?? '');
        const shipDimUnit = (shipDims.unit ?? 'cm');

        const packagingHint = (ship.packagingHint ?? '');
        const shipSeparately = !!ship.shipSeparately;
        const fragile = !!ship.fragile;
      %>

      <div class="edit-form-container">
        <div class="form-tabs" role="tablist" aria-label="Edit product tabs">
          <button type="button" class="tab active" data-tab="basic" role="tab" aria-selected="true">Basic</button>
          <button type="button" class="tab" data-tab="details" role="tab" aria-selected="false">Details</button>
          <button type="button" class="tab" data-tab="media" role="tab" aria-selected="false">Media</button>
        </div>

        <form
          id="editProductForm"
          action="/products/edit/<%= product.customId %>"
          method="POST"
          enctype="multipart/form-data"
          class="product-form"
          novalidate
        >
          <!-- Basic Info Tab -->
          <div class="tab-content active" id="basic-tab" role="tabpanel">
            <div class="form-section section-purple">
              <div class="section-header">
                <div class="sec-badge sec-purple" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18">
                    <path fill="currentColor" d="M4 6h16v2H4zm0 4h16v2H4zm0 4h16v2H4zm0 4h16v2H4z"/>
                  </svg>
                </div>
                <div>
                  <h3>Product Information</h3>
                  <p class="sec-sub">Core product fields shown on your shop card.</p>
                </div>
              </div>

              <div class="form-grid">
                <div class="form-group">
                  <label for="name" class="form-label">
                    Product Name <span class="required">*</span>
                  </label>
                  <input
                    id="name"
                    type="text"
                    name="name"
                    value="<%= product.name %>"
                    required
                    class="form-input"
                    placeholder="e.g., Cooling Chair"
                    autocomplete="off"
                  />
                  <div class="form-hint">Tip: short, clear, searchable.</div>
                </div>

                <div class="form-group">
                  <label for="price" class="form-label">
                    Price ($) <span class="required">*</span>
                  </label>
                  <div class="input-with-icon">
                    <span class="currency-icon" aria-hidden="true">$</span>
                    <input
                      id="price"
                      type="number"
                      name="price"
                      step="0.01"
                      min="0.01"
                      value="<%= product.price %>"
                      required
                      class="form-input"
                      placeholder="e.g., 199.99"
                      inputmode="decimal"
                    />
                  </div>
                </div>

                <div class="form-group">
                  <label for="stock" class="form-label">Stock Quantity</label>
                  <input
                    id="stock"
                    type="number"
                    name="stock"
                    min="0"
                    value="<%= product.stock %>"
                    class="form-input"
                    placeholder="e.g., 25"
                    inputmode="numeric"
                  />
                  <div class="form-hint">Use 0 for out of stock.</div>
                </div>

                <div class="form-group">
                  <label for="categorySelect" class="form-label">Category</label>

                  <%
                    const currentCat = String(product.category || '').trim().toLowerCase();
                  %>

                  <select id="categorySelect" name="category" class="form-select">
                    <option value="">Choose category</option>

                    <% if (Array.isArray(CATEGORIES)) { %>
                      <% CATEGORIES.forEach(function(c){ %>
                        <option
                          value="<%= c.value %>"
                          <%= String(c.value || '').toLowerCase() === currentCat ? 'selected' : '' %>
                        ><%= c.label %></option>
                      <% }) %>
                    <% } %>
                  </select>

                  <div class="form-hint">Used for filters on the shopping page.</div>
                </div>
              </div>
            </div>

            <div class="form-section section-blue">
              <div class="section-header">
                <div class="sec-badge sec-blue" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18">
                    <path fill="currentColor" d="M19 5v14H5V5h14m0-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                  </svg>
                </div>
                <div>
                  <h3>Description</h3>
                  <p class="sec-sub">Explain features, benefits, and specs for customers.</p>
                </div>
              </div>

              <div class="form-group">
                <label for="description" class="form-label">Product Description</label>
                <textarea
                  id="description"
                  name="description"
                  rows="6"
                  class="form-textarea"
                  placeholder="e.g., Comfortable chair with cooling design, durable material, perfect for office use..."
                ><%= product.description || '' %></textarea>

                <div class="row-split">
                  <div class="form-hint">Keep it clear and helpful.</div>
                  <div class="char-counter"><span id="charCount">0</span> / 2000</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Details Tab -->
          <div class="tab-content" id="details-tab" role="tabpanel">
            <div class="form-section section-black">
              <div class="section-header">
                <div class="sec-badge sec-black" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18">
                    <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
                  </svg>
                </div>
                <div>
                  <h3>Product Specifications</h3>
                  <p class="sec-sub">Type, origin, variants, quality, and shipping info.</p>
                </div>
              </div>

              <div class="form-grid">
                <!-- MATCHING TYPE (string, used in demands etc.) -->
                <div class="form-group">
                  <label for="typeSelect" class="form-label">Product Type <span class="required">*</span></label>

                  <select id="typeSelect" name="type" class="form-select" required>
                    <option value="">Choose type</option>

                    <% if (Array.isArray(PRODUCT_TYPES)) { %>
                      <% PRODUCT_TYPES.forEach(function(t){ %>
                        <option
                          value="<%= t.value %>"
                          <%= String(product.type || '').toLowerCase() === String(t.value || '').toLowerCase() ? 'selected' : '' %>
                        ><%= t.label %></option>
                      <% }) %>
                    <% } %>
                  </select>

                  <div class="form-hint">
                    Used to match demands. Use <strong>clothes</strong> or <strong>shoes</strong> to enable size + color variants.
                  </div>
                </div>

                <!-- MANUFACTURER -->
                <div class="form-group">
                  <label for="manufacturer" class="form-label">Manufacturer</label>
                  <input
                    id="manufacturer"
                    type="text"
                    name="manufacturer"
                    value="<%= product.manufacturer || '' %>"
                    class="form-input"
                    placeholder="e.g., Samsung, Nike, Ikea"
                  />
                </div>

                <!-- MADE IN (Custom searchable dropdown with flags) -->
                <div class="form-group ep-full">
                  <label class="form-label">
                    Made In <span class="required">*</span>
                  </label>

                  <div class="ep-country-dropdown" id="madeDropdown">
                    <div
                      class="ep-country-selected"
                      id="madeSelected"
                      tabindex="0"
                      role="button"
                      aria-haspopup="listbox"
                      aria-expanded="false"
                    >
                      <span class="ep-country-selected-left">
                        <img id="madeSelectedFlagImg" class="ep-flag-img" alt="" aria-hidden="true" />
                        <span id="madeSelectedText"><%= (product.made || 'Select country') %></span>
                      </span>
                      <span class="ep-country-arrow">â–¾</span>
                    </div>

                    <div class="ep-country-menu" id="madeMenu" role="listbox">
                      <input
                        type="text"
                        id="madeSearch"
                        placeholder="Search country..."
                        autocomplete="off"
                        class="ep-country-search-input"
                      />

                      <div class="ep-country-list" id="madeList">
                        <% if (Array.isArray(COUNTRIES)) { %>
                          <% COUNTRIES.forEach(function(c) { %>
                            <div
                              class="ep-country-option"
                              data-value="<%= c.name %>"
                              data-code="<%= c.code %>"
                              data-flag="<%= c.flag %>"
                              data-search="<%= String(c.name || '').toLowerCase() %>"
                              role="option"
                            >
                              <img
                                class="ep-flag-img"
                                src="https://flagcdn.com/20x15/<%= String(c.code || '').toLowerCase() %>.png"
                                alt=""
                                loading="lazy"
                              />
                              <span class="ep-country-name"><%= c.name %></span>
                            </div>
                          <% }) %>
                        <% } %>
                      </div>
                    </div>

                    <!-- âœ… backend-safe hidden inputs -->
                    <input
                      type="hidden"
                      name="made"
                      id="made"
                      value="<%= product.made || '' %>"
                      required
                    />
                    <input
                      type="hidden"
                      name="madeCode"
                      id="madeCode"
                      value="<%= (product && product.madeCode) ? product.madeCode : '' %>"
                    />
                  </div>

                  <div class="form-hint">
                    Select country of origin (required).
                  </div>
                </div>

                <!-- SINGLE COLOR -->
                <div class="form-group">
                  <label for="color" class="form-label">Default Color</label>
                  <input
                    id="color"
                    type="text"
                    name="color"
                    value="<%= product.color || '' %>"
                    class="form-input"
                    placeholder="e.g., Black"
                  />
                  <div class="form-hint">Used for non-clothing or default variant.</div>
                </div>

                <!-- SINGLE SIZE -->
                <div class="form-group">
                  <label for="size" class="form-label">Default Size</label>
                  <input
                    id="size"
                    type="text"
                    name="size"
                    value="<%= product.size || '' %>"
                    class="form-input"
                    placeholder="e.g., M, 42, 10x5x2 cm"
                  />
                  <div class="form-hint">Used for non-clothing or default variant.</div>
                </div>

                <!-- QUALITY -->
                <div class="form-group">
                  <label for="quality" class="form-label">Quality Grade</label>
                  <select id="quality" name="quality" class="form-select">
                    <option value="">Select quality...</option>
                    <option value="Premium"  <%= product.quality === 'Premium'  ? 'selected' : '' %>>Premium</option>
                    <option value="Standard" <%= product.quality === 'Standard' ? 'selected' : '' %>>Standard</option>
                    <option value="Economy"  <%= product.quality === 'Economy'  ? 'selected' : '' %>>Economy</option>
                    <option value="Wholesale"<%= product.quality === 'Wholesale'? 'selected' : '' %>>Wholesale</option>
                  </select>
                  <div class="form-hint">Helps customers compare products.</div>
                </div>

                <!-- VARIANT SIZES ARRAY -->
                <div class="form-group">
                  <label for="sizes" class="form-label">
                    <%= isShoes ? 'Shoe sizes' : (isClothes ? 'Clothing sizes' : 'Sizes (array)') %>
                  </label>
                  <input
                    id="sizes"
                    type="text"
                    name="sizes"
                    value="<%= (product.sizes && product.sizes.length ? product.sizes.join(', ') : '') %>"
                    class="form-input"
                    placeholder="<%= isShoes
                      ? 'e.g., 3, 4, 5, 6, 7'
                      : (isClothes ? 'e.g., XS, S, M, L, XL' : 'Comma-separated sizes') %>"
                  />
                  <div class="form-hint">
                    <%= isShoes
                      ? 'Comma-separated shoe sizes for shop dropdown.'
                      : (isClothes
                        ? 'Comma-separated clothing sizes (should not be empty for clothes).'
                        : 'Comma-separated list of sizes/dimensions.') %>
                  </div>
                </div>

                <!-- VARIANT COLORS ARRAY -->
                <div class="form-group">
                  <label for="colors" class="form-label">Colors (array)</label>
                  <input
                    id="colors"
                    type="text"
                    name="colors"
                    value="<%= (product.colors && product.colors.length ? product.colors.join(', ') : '') %>"
                    class="form-input"
                    placeholder="e.g., Red, Blue, Black"
                  />
                  <div class="form-hint">Comma-separated list (required for clothes).</div>
                </div>

                <!-- Shipping -->
                <div class="form-group ep-full">
                  <div class="ship-head">
                    <div class="ship-title">
                      <span class="ship-pill">ðŸ“¦ Shipping</span>
                      <strong>Package info for Shippo rates</strong>
                    </div>
                    <div class="ship-note">Required. One item only (no box).</div>
                  </div>
                </div>

                <!-- Weight -->
                <div class="form-group">
                  <label class="form-label">Item Weight <span class="required">*</span></label>
                  <div class="inline-2">
                    <input
                      type="number"
                      name="shipWeightValue"
                      step="0.001"
                      min="0.1"
                      placeholder="e.g., 0.50"
                      value="<%= shipWeightValue %>"
                      required
                      class="form-input"
                    />
                    <select name="shipWeightUnit" class="form-select">
                      <option value="kg" <%= shipWeightUnit === 'kg' ? 'selected' : '' %>>kg</option>
                      <option value="g"  <%= shipWeightUnit === 'g'  ? 'selected' : '' %>>g</option>
                      <option value="lb" <%= shipWeightUnit === 'lb' ? 'selected' : '' %>>lb</option>
                      <option value="oz" <%= shipWeightUnit === 'oz' ? 'selected' : '' %>>oz</option>
                    </select>
                  </div>
                  <div class="form-hint">Example: 0.5 kg</div>
                </div>

                <!-- Packaging hint -->
                <div class="form-group">
                  <label class="form-label">Packaging Hint</label>
                  <input
                    type="text"
                    name="packagingHint"
                    value="<%= packagingHint %>"
                    placeholder="e.g., small-box / tube / fragile"
                    class="form-input"
                  />
                  <div class="form-hint">Optional. Leave empty if unsure.</div>
                </div>

                <!-- Dimensions -->
                <div class="form-group ep-full">
                  <label class="form-label">Item Dimensions (L Ã— W Ã— H) <span class="required">*</span></label>
                  <div class="dims-grid">
                    <input
                      type="number"
                      name="shipLength"
                      step="0.1"
                      min="0"
                      placeholder="Length"
                      value="<%= shipLength %>"
                      required
                      class="form-input"
                    />
                    <input
                      type="number"
                      name="shipWidth"
                      step="0.1"
                      min="0"
                      placeholder="Width"
                      value="<%= shipWidth %>"
                      required
                      class="form-input"
                    />
                    <input
                      type="number"
                      name="shipHeight"
                      step="0.1"
                      min="0"
                      placeholder="Height"
                      value="<%= shipHeight %>"
                      required
                      class="form-input"
                    />
                    <select name="shipDimUnit" class="form-select">
                      <option value="cm" <%= shipDimUnit === 'cm' ? 'selected' : '' %>>cm</option>
                      <option value="in" <%= shipDimUnit === 'in' ? 'selected' : '' %>>in</option>
                    </select>
                  </div>
                  <div class="form-hint">Example: 30 Ã— 20 Ã— 10 cm</div>
                </div>

                <!-- Flags -->
                <div class="form-group ep-full">
                  <label class="form-label">Shipping Flags</label>
                  <div class="flags-row">
                    <label class="flag">
                      <input type="hidden" name="shipSeparately" value="0" />
                      <input
                        type="checkbox"
                        name="shipSeparately"
                        value="on"
                        <%= shipSeparately ? 'checked' : '' %>
                      />
                      <span>Ship separately</span>
                    </label>

                    <label class="flag">
                      <input type="hidden" name="fragile" value="0" />
                      <input
                        type="checkbox"
                        name="fragile"
                        value="on"
                        <%= fragile ? 'checked' : '' %>
                      />
                      <span>Fragile</span>
                    </label>
                  </div>
                  <div class="form-hint">Use when item must be boxed alone or needs careful handling.</div>
                </div>

                <!-- STATUS FLAGS -->
                <div class="form-group ep-full">
                  <label class="form-label">Status Flags</label>
                  <div class="flags-row">
                    <label class="flag">
                      <input type="checkbox" name="isNew" <%= product.isNew ? 'checked' : '' %> />
                      <span>New</span>
                    </label>
                    <label class="flag">
                      <input type="checkbox" name="isOnSale" <%= product.isOnSale ? 'checked' : '' %> />
                      <span>On sale</span>
                    </label>
                    <label class="flag">
                      <input type="checkbox" name="isPopular" <%= product.isPopular ? 'checked' : '' %> />
                      <span>Popular</span>
                    </label>
                  </div>
                  <div class="form-hint">Used for badges and filters in the shop.</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Media Tab -->
          <div class="tab-content" id="media-tab" role="tabpanel">
            <div class="form-section section-green">
              <div class="section-header">
                <div class="sec-badge sec-green" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18">
                    <path fill="currentColor" d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/>
                  </svg>
                </div>
                <div>
                  <h3>Product Images</h3>
                  <p class="sec-sub">Current image + upload a new one (optional).</p>
                </div>
              </div>

              <div class="media-grid">
                <div class="current-image-card">
                  <div class="image-card-header">
                    <h4>Current Image</h4>
                    <span class="image-status">Active</span>
                  </div>
                  <img
                    src="<%= product.imageUrl %>"
                    alt="Current image for <%= product.name %>"
                    class="current-image-preview"
                    loading="lazy"
                  />
                  <div class="image-info">
                    <span class="muted">Shown to customers</span>
                    <span class="pill pill-blue">Display</span>
                  </div>
                </div>

                <div class="upload-image-card">
                  <div class="image-card-header">
                    <h4>Upload New</h4>
                    <span class="image-optional">Optional</span>
                  </div>

                  <div class="upload-area" id="uploadArea" tabindex="0" role="button" aria-label="Upload a new product image">
                    <svg class="upload-icon" viewBox="0 0 24 24" width="46" height="46" aria-hidden="true">
                      <path fill="currentColor" d="M19.35 10.04C18.67 6.59 15.64 4 12 4 9.11 4 6.6 5.64 5.35 8.04 2.34 8.36 0 10.91 0 14c0 3.31 2.69 6 6 6h13c2.76 0 5-2.24 5-5 0-2.64-2.05-4.78-4.65-4.96zM14 13v4h-4v-4H7l5-5 5 5h-3z"/>
                    </svg>
                    <p class="upload-text">Tap to upload</p>
                    <p class="upload-subtext">PNG/JPG â€¢ Max 5MB</p>
                    <input
                      id="imageFile"
                      type="file"
                      name="imageFile"
                      accept="image/*"
                      class="file-input"
                    />
                  </div>

                  <div id="newImagePreviewWrapper" class="image-preview-wrapper" style="display:none;">
                    <div class="preview-header">
                      <h4>New Preview</h4>
                      <button type="button" class="remove-preview" id="removePreview" aria-label="Remove new image preview">
                        <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                          <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                        </svg>
                      </button>
                    </div>

                    <img id="newImagePreview" class="new-image-preview" alt="New image preview" />
                    <div class="preview-info">
                      <span id="fileName"></span>
                      <span id="fileSize"></span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="media-note">
                <span class="pill pill-green">Tip</span>
                Use a clear product photo with a clean background for better conversions.
              </div>
            </div>
          </div>

          <!-- Form Actions -->
          <div class="form-actions">
            <div class="action-buttons">
              <button type="submit" class="btn btn-primary">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z"/>
                </svg>
                Save Changes
              </button>

              <a href="/products/view/<%= product.customId %>" class="btn btn-secondary">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/>
                </svg>
                View Details
              </a>

              <button type="button" class="btn btn-danger" id="deleteProduct">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
                Delete
              </button>
            </div>

            <div class="form-note">
              <svg viewBox="0 0 24 24" width="16" height="16" aria-hidden="true">
                <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>
              </svg>
              Fields marked with <span class="required">*</span> are required
            </div>
          </div>
        </form>
      </div>

    <% } else { %>
      <!-- No business session -->
      <div class="auth-required-card">
        <div class="auth-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="48" height="48">
            <path fill="currentColor" d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
          </svg>
        </div>
        <h3>Authentication Required</h3>
        <p>You must be logged in with a business account to edit products.</p>
        <div class="auth-actions">
          <a href="/business/login" class="btn btn-primary">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path fill="currentColor" d="M10 17v-3H3v-4h7V7l5 5-5 5z"/>
            </svg>
            Business Login
          </a>
          <a href="/business/register" class="btn btn-secondary">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path fill="currentColor" d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
            </svg>
            Register Business
          </a>
        </div>
      </div>

      <!-- BUYER: Read-only view -->
      <div class="view-only-container">
        <div class="product-view-card">
          <div class="product-header">
            <h2 class="product-title"><%= product.name %></h2>
            <div class="product-price">
              <span class="currency">$</span>
              <span class="amount"><%= Number(product.price).toFixed(2) %></span>
            </div>
          </div>

          <div class="product-content">
            <div class="product-media">
              <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="product-image" />
              <div class="stock-status <%= product.stock > 0 ? 'in-stock' : 'out-of-stock' %>">
                <% if (product.stock > 0) { %>
                  <svg class="status-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                    <path fill="currentColor" d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                  </svg>
                  <span>In Stock: <strong><%= product.stock %></strong></span>
                <% } else { %>
                  <svg class="status-icon" viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                    <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                  </svg>
                  <span>Out of Stock</span>
                <% } %>
              </div>
            </div>

            <div class="product-details">
              <div class="details-section">
                <h3>Product Details</h3>
                <div class="details-grid">
                  <% if (product.category) { %>
                    <div class="detail-item">
                      <span class="detail-label">Category</span>
                      <span class="detail-value"><%= product.category %></span>
                    </div>
                  <% } %>
                  <% if (product.type) { %>
                    <div class="detail-item">
                      <span class="detail-label">Type</span>
                      <span class="detail-value"><%= product.type %></span>
                    </div>
                  <% } %>
                  <% if (product.color) { %>
                    <div class="detail-item">
                      <span class="detail-label">Color</span>
                      <span class="detail-value"><%= product.color %></span>
                    </div>
                  <% } %>
                  <% if (product.size) { %>
                    <div class="detail-item">
                      <span class="detail-label">Size</span>
                      <span class="detail-value"><%= product.size %></span>
                    </div>
                  <% } %>
                  <% if (product.quality) { %>
                    <div class="detail-item">
                      <span class="detail-label">Quality</span>
                      <span class="detail-value"><%= product.quality %></span>
                    </div>
                  <% } %>
                  <% if (product.made) { %>
                    <div class="detail-item">
                      <span class="detail-label">Made In</span>
                      <span class="detail-value"><%= product.made %></span>
                    </div>
                  <% } %>
                  <% if (product.manufacturer) { %>
                    <div class="detail-item">
                      <span class="detail-label">Manufacturer</span>
                      <span class="detail-value"><%= product.manufacturer %></span>
                    </div>
                  <% } %>
                </div>
              </div>

              <% if (product.description) { %>
                <div class="description-section">
                  <h3>Description</h3>
                  <div class="description-content">
                    <%= product.description %>
                  </div>
                </div>
              <% } %>
            </div>
          </div>

          <div class="product-actions">
            <a href="/products/all" class="btn btn-secondary">
              <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                <path fill="currentColor" d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
              </svg>
              Back to Products
            </a>
            <% if (product.stock > 0) { %>
              <a href="/api/cart/add?pid=<%= product.customId %>" class="btn btn-primary">
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/>
                </svg>
                Add to Cart
              </a>
            <% } else { %>
              <button class="btn btn-disabled" disabled>
                <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
                  <path fill="currentColor" d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
                </svg>
                Out of Stock
              </button>
            <% } %>
          </div>
        </div>
      </div>
    <% } %>
  </div>
</div>

<style nonce="<%= nonce %>">
  /* ==========================================================
     Unicoporate â€“ Edit Product (Mobile First / No Cutoffs)
     Dominant Purple: #7C3AED
     ========================================================== */

  .edit-product-page{
    --pg-purple:#7C3AED;
    --pg-blue:#2563EB;
    --pg-green:#22C55E;
    --pg-black:#0F172A;

    --bg:#F8FAFC;
    --card:#FFFFFF;
    --muted:#64748B;
    --line:#E2E8F0;

    --r-lg:18px;
    --r-md:14px;
    --r-sm:12px;

    --shadow:0 12px 34px rgba(2,6,23,.12);
    --shadow-soft:0 8px 22px rgba(2,6,23,.08);

    width:100%;
    max-width:980px;
    margin:0 auto;
    padding:12px 12px 16px;
  }

  /* no overflow cutoffs on phones */
  .edit-product-page,
  .edit-product-page * { box-sizing:border-box; }
  .edit-product-page img{ max-width:100%; height:auto; display:block; }

  .edit-product-page .dark-theme{
    --bg:#0B1220;
    --card:rgba(15,23,42,.82);
    --muted:#94A3B8;
    --line:rgba(148,163,184,.18);
  }

  /* Header */
  .page-header{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    padding:10px 10px 12px;
    border-radius:var(--r-lg);
    background:
      radial-gradient(900px 240px at 0% 0%, rgba(124,58,237,.16), transparent 60%),
      radial-gradient(900px 240px at 100% 0%, rgba(37,99,235,.12), transparent 60%),
      var(--card);
    border:1px solid var(--line);
    box-shadow:var(--shadow-soft);
  }

  .header-content{ display:flex; gap:10px; align-items:center; min-width:0; }
  .header-icon{
    width:44px; height:44px; border-radius:14px;
    background:linear-gradient(135deg,var(--pg-purple),var(--pg-blue));
    color:#fff; display:grid; place-items:center;
    box-shadow:0 14px 28px rgba(124,58,237,.22);
    flex:0 0 auto;
  }
  .header-text{ min-width:0; }
  .page-title{
    margin:0; font-size:1.12rem; font-weight:950; letter-spacing:-.02em;
    color:var(--pg-black);
    line-height:1.15;
    word-break:break-word;
  }
  .dark-theme .page-title{ color:#F1F5F9; }

  .page-subtitle{
    margin:4px 0 0;
    color:var(--muted);
    font-size:.92rem;
    line-height:1.25;
  }

  .back-button{
    width:100%;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    padding:10px 12px;
    border-radius:14px;
    text-decoration:none;
    font-weight:900;
    color:var(--pg-purple);
    background:rgba(124,58,237,.10);
    border:1px solid rgba(124,58,237,.18);
    transition:transform .12s ease, background .12s ease, border-color .12s ease;
  }
  .back-button:hover{ transform:translateY(-1px); background:rgba(124,58,237,.14); border-color:rgba(124,58,237,.28); }

  /* Flash */
  .flash-container{ margin:12px 0; }
  .flash{
    display:flex; gap:10px;
    padding:12px;
    border-radius:16px;
    background:var(--card);
    border:1px solid var(--line);
    box-shadow:var(--shadow-soft);
  }
  .flash-content strong{ display:block; font-weight:950; }
  .flash-content p{ margin:2px 0 0; color:var(--muted); }
  .flash-success{ border-left:5px solid var(--pg-green); }
  .flash-success .flash-icon{ color:var(--pg-green); }
  .flash-error{ border-left:5px solid #EF4444; }
  .flash-error .flash-icon{ color:#EF4444; }

  /* Main container */
  .edit-form-container{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--r-lg);
    overflow:hidden;
    box-shadow:var(--shadow);
  }

  /* Tabs: chip-scroll (no cutoff) */
  .form-tabs{
    display:flex;
    gap:8px;
    padding:10px;
    overflow:auto;
    -webkit-overflow-scrolling:touch;
    background:rgba(124,58,237,.06);
    border-bottom:1px solid rgba(124,58,237,.18);
  }
  .form-tabs::-webkit-scrollbar{ height:6px; }
  .form-tabs::-webkit-scrollbar-thumb{ background:rgba(124,58,237,.22); border-radius:999px; }

  .tab{
    flex:0 0 auto;
    padding:10px 14px;
    border-radius:999px;
    border:1px solid rgba(124,58,237,.20);
    background:#fff;
    font-weight:950;
    font-size:.92rem;
    cursor:pointer;
    white-space:nowrap;
    transition:transform .12s ease, background .12s ease;
  }
  .dark-theme .tab{ background:rgba(15,23,42,.55); color:#E2E8F0; }
  .tab:hover{ transform:translateY(-1px); }
  .tab.active{
    background:linear-gradient(135deg,var(--pg-purple),var(--pg-blue));
    color:#fff;
    border-color:rgba(255,255,255,.20);
    box-shadow:0 14px 28px rgba(124,58,237,.22);
  }

  .tab-content{ display:none; padding:12px; }
  .tab-content.active{ display:block; }

  /* Sections */
  .form-section{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--r-lg);
    padding:12px;
    box-shadow:var(--shadow-soft);
    position:relative;
    overflow:hidden;
    margin-bottom:12px;
  }
  .dark-theme .form-section{
    background:rgba(15,23,42,.58);
    border-color:rgba(148,163,184,.18);
  }

  .form-section::before{
    content:"";
    position:absolute; left:0; top:0; bottom:0;
    width:8px;
    background:var(--pg-purple);
  }
  .section-purple::before{ background:var(--pg-purple); }
  .section-blue::before{ background:var(--pg-blue); }
  .section-green::before{ background:var(--pg-green); }
  .section-black::before{ background:var(--pg-black); }

  .section-header{
    display:flex;
    gap:10px;
    align-items:flex-start;
    margin-bottom:10px;
    padding-left:4px;
  }
  .section-header h3{
    margin:0;
    font-size:1.02rem;
    font-weight:980;
    color:var(--pg-black);
    line-height:1.2;
  }
  .dark-theme .section-header h3{ color:#F1F5F9; }
  .sec-sub{
    margin:4px 0 0;
    color:var(--muted);
    font-size:.88rem;
    line-height:1.25;
  }

  .sec-badge{
    width:36px; height:36px; border-radius:14px;
    display:grid; place-items:center;
    border:1px solid rgba(124,58,237,.18);
    background:rgba(124,58,237,.10);
    color:var(--pg-purple);
    flex:0 0 auto;
  }
  .sec-blue{ background:rgba(37,99,235,.10); border-color:rgba(37,99,235,.20); color:var(--pg-blue); }
  .sec-green{ background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.22); color:var(--pg-green); }
  .sec-black{ background:rgba(15,23,42,.08); border-color:rgba(15,23,42,.18); color:var(--pg-black); }
  .dark-theme .sec-black{ background:rgba(148,163,184,.10); border-color:rgba(148,163,184,.18); color:#E2E8F0; }

  /* Grid: 1 column mobile, 2 columns tablet+ */
  .form-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  .ep-full{ grid-column:1 / -1; }

  /* Labels + fields */
  .form-label{
    display:block;
    font-size:.92rem;
    font-weight:950;
    margin-bottom:6px;
    color:var(--pg-black);
  }
  .dark-theme .form-label{ color:#E2E8F0; }
  .required{ color:#EF4444; }

  .form-input,
  .form-textarea,
  .form-select{
    width:100%;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:#fff;
    color:var(--pg-black);
    font-size:1rem;
    transition:border-color .12s ease, box-shadow .12s ease, transform .12s ease;
  }
  .dark-theme .form-input,
  .dark-theme .form-textarea,
  .dark-theme .form-select{
    background:rgba(2,6,23,.25);
    border-color:rgba(148,163,184,.22);
    color:#F1F5F9;
  }

  .form-input:focus,
  .form-textarea:focus,
  .form-select:focus{
    outline:none;
    border-color:rgba(124,58,237,.72);
    box-shadow:0 0 0 4px rgba(124,58,237,.14);
    transform:translateY(-1px);
  }

  .form-select{
    appearance:none;
    background-image:
      linear-gradient(45deg, transparent 50%, rgba(124,58,237,.85) 50%),
      linear-gradient(135deg, rgba(124,58,237,.85) 50%, transparent 50%);
    background-position:
      calc(100% - 18px) calc(50% - 3px),
      calc(100% - 12px) calc(50% - 3px);
    background-size:6px 6px, 6px 6px;
    background-repeat:no-repeat;
    padding-right:38px;
  }

  .form-textarea{ min-height:120px; resize:vertical; }
  .form-hint{ margin-top:6px; color:var(--muted); font-size:.88rem; line-height:1.25; }

  .row-split{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    flex-wrap:wrap;
    margin-top:6px;
  }

  .char-counter{ color:var(--muted); font-size:.85rem; font-weight:800; }

  .input-with-icon{ position:relative; }
  .currency-icon{
    position:absolute; left:12px; top:50%;
    transform:translateY(-50%);
    font-weight:950;
    color:rgba(15,23,42,.65);
  }
  .dark-theme .currency-icon{ color:rgba(241,245,249,.70); }
  .input-with-icon .form-input{ padding-left:26px; }

  /* Shipping layout helpers */
  .inline-2{ display:grid; grid-template-columns:1fr 130px; gap:10px; align-items:center; }
  .dims-grid{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }
  .dims-grid select{ grid-column:1 / -1; }

  .ship-head{
    display:flex;
    flex-direction:column;
    gap:6px;
    padding:10px;
    border-radius:16px;
    border:1px solid rgba(124,58,237,.18);
    background:rgba(124,58,237,.06);
  }
  .ship-pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border-radius:999px;
    background:linear-gradient(135deg, rgba(124,58,237,.14), rgba(37,99,235,.12));
    color:var(--pg-purple);
    font-weight:950;
    width:max-content;
  }
  .ship-title{ display:flex; flex-direction:column; gap:6px; }
  .ship-title strong{ font-weight:980; color:var(--pg-black); }
  .dark-theme .ship-title strong{ color:#F1F5F9; }
  .ship-note{ color:var(--muted); font-size:.88rem; }

  /* Flags */
  .flags-row{ display:flex; flex-wrap:wrap; gap:10px; }
  .flag{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border-radius:999px;
    border:1px solid rgba(124,58,237,.20);
    background:rgba(124,58,237,.06);
    font-weight:900;
    font-size:.92rem;
    color:var(--pg-black);
  }
  .dark-theme .flag{ color:#E2E8F0; border-color:rgba(148,163,184,.18); background:rgba(148,163,184,.10); }
  .flag input{ width:16px; height:16px; accent-color:var(--pg-purple); }

  /* Pills */
  .pill{
    display:inline-flex;
    padding:4px 10px;
    border-radius:999px;
    font-weight:950;
    font-size:.78rem;
    border:1px solid transparent;
  }
  .pill-blue{ background:rgba(37,99,235,.10); color:var(--pg-blue); border-color:rgba(37,99,235,.18); }
  .pill-green{ background:rgba(34,197,94,.12); color:#166534; border-color:rgba(34,197,94,.22); }

  /* Made In dropdown */
  .ep-country-dropdown{ position:relative; width:100%; }
  .ep-country-selected{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:12px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:#fff;
    min-height:46px;
    cursor:pointer;
    user-select:none;
    transition:border-color .12s ease, box-shadow .12s ease, transform .12s ease;
  }
  .dark-theme .ep-country-selected{
    background:rgba(2,6,23,.25);
    border-color:rgba(148,163,184,.22);
    color:#F1F5F9;
  }
  .ep-country-selected:focus{
    outline:none;
    border-color:rgba(124,58,237,.72);
    box-shadow:0 0 0 4px rgba(124,58,237,.14);
    transform:translateY(-1px);
  }
  .ep-country-selected-left{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }
  .ep-flag-img{
    width:18px; height:13px;
    border-radius:4px;
    object-fit:cover;
    flex:0 0 auto;
    box-shadow:0 0 0 1px rgba(148,163,184,.35);
  }
  .ep-country-name{
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .ep-country-arrow{ font-weight:950; font-size:12px; opacity:.85; }

  .ep-country-menu{
    display:none;
    position:absolute;
    top:calc(100% + 8px);
    left:0; right:0;
    z-index:60;
    border-radius:16px;
    border:1px solid rgba(148,163,184,.6);
    background:rgba(248,250,252,.98);
    overflow:hidden;
    box-shadow:0 18px 42px rgba(15,23,42,.25);
  }
  .dark-theme .ep-country-menu{
    background:rgba(2,6,23,.98);
    border-color:rgba(51,65,85,.9);
  }
  .ep-country-dropdown.open .ep-country-menu{ display:block; }

  .ep-country-search-input{
    width:100%;
    border:none;
    border-bottom:1px solid rgba(148,163,184,.5);
    padding:10px 12px;
    font-size:.95rem;
    outline:none;
    background:transparent;
    color:inherit;
  }
  .dark-theme .ep-country-search-input{ border-bottom-color:rgba(51,65,85,.9); color:#E5E7EB; }

  .ep-country-list{ max-height:240px; overflow:auto; }
  .ep-country-option{
    padding:10px 12px;
    font-size:.95rem;
    cursor:pointer;
    display:flex;
    align-items:center;
    gap:10px;
    transition:background .12s ease;
  }
  .ep-country-option:hover{ background:rgba(124,58,237,.12); }
  .dark-theme .ep-country-option:hover{ background:rgba(124,58,237,.20); }
  .ep-country-option.active{ background:rgba(124,58,237,.18); font-weight:950; }

  /* Media */
  .media-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }
  .current-image-card,
  .upload-image-card{
    background:rgba(124,58,237,.04);
    border-radius:var(--r-lg);
    padding:12px;
    border:1px solid rgba(124,58,237,.16);
  }
  .dark-theme .current-image-card,
  .dark-theme .upload-image-card{
    background:rgba(2,6,23,.18);
    border-color:rgba(148,163,184,.20);
  }

  .image-card-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .image-card-header h4{ margin:0; font-weight:980; color:var(--pg-black); }
  .dark-theme .image-card-header h4{ color:#F1F5F9; }

  .image-status{
    background:var(--pg-green);
    color:#fff;
    padding:4px 10px;
    border-radius:999px;
    font-size:.78rem;
    font-weight:950;
  }
  .image-optional{
    background:rgba(37,99,235,.12);
    color:var(--pg-blue);
    padding:4px 10px;
    border-radius:999px;
    font-size:.78rem;
    font-weight:950;
  }

  /* No fixed cut-off height: responsive aspect */
  .current-image-preview,
  .new-image-preview{
    width:100%;
    aspect-ratio: 16 / 10;
    object-fit:contain;
    border-radius:16px;
    background:#fff;
    border:1px solid rgba(15,23,42,.10);
  }
  .dark-theme .current-image-preview,
  .dark-theme .new-image-preview{
    background:rgba(2,6,23,.25);
    border-color:rgba(148,163,184,.20);
  }

  .image-info{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    margin-top:10px;
    color:var(--muted);
    font-size:.88rem;
  }
  .muted{ color:var(--muted); }

  .upload-area{
    border:2px dashed rgba(124,58,237,.35);
    border-radius:var(--r-lg);
    padding:16px 12px;
    text-align:center;
    position:relative;
    cursor:pointer;
    background:rgba(124,58,237,.05);
    transition:transform .12s ease, border-color .12s ease, background .12s ease;
    outline:none;
    min-height:120px;
    display:grid;
    place-items:center;
    gap:6px;
  }
  .upload-area:hover,
  .upload-area:focus{
    border-color:rgba(124,58,237,.70);
    background:rgba(124,58,237,.08);
    transform:translateY(-1px);
  }
  .upload-icon{ color:rgba(124,58,237,.55); }
  .upload-text{ margin:0; font-weight:980; color:var(--pg-black); }
  .dark-theme .upload-text{ color:#F1F5F9; }
  .upload-subtext{ margin:0; font-size:.88rem; color:var(--muted); }

  .file-input{ position:absolute; inset:0; opacity:0; cursor:pointer; }

  .preview-header{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin:10px 0 10px;
  }
  .preview-header h4{ margin:0; font-weight:980; color:var(--pg-black); }
  .dark-theme .preview-header h4{ color:#F1F5F9; }

  .remove-preview{
    background:rgba(239,68,68,.12);
    border:1px solid rgba(239,68,68,.20);
    width:38px; height:38px;
    border-radius:14px;
    display:grid; place-items:center;
    cursor:pointer;
    transition:transform .12s ease, background .12s ease;
  }
  .remove-preview:hover{ background:rgba(239,68,68,.18); transform:translateY(-1px); }
  .remove-preview svg{ color:#EF4444; }

  .preview-info{
    display:flex;
    justify-content:space-between;
    gap:10px;
    margin-top:8px;
    font-size:.88rem;
    color:var(--muted);
    word-break:break-word;
  }

  .media-note{
    margin-top:12px;
    padding:10px 12px;
    border-radius:16px;
    border:1px solid rgba(34,197,94,.22);
    background:rgba(34,197,94,.10);
    color:#166534;
    font-weight:850;
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
  }

  /* Actions */
  .form-actions{
    padding:12px;
    border-top:1px solid rgba(124,58,237,.16);
    background:rgba(124,58,237,.04);
  }
  .dark-theme .form-actions{
    background:rgba(2,6,23,.18);
    border-top-color:rgba(148,163,184,.18);
  }

  .action-buttons{
    display:grid;
    gap:10px;
    margin-bottom:10px;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:10px;
    padding:12px 12px;
    border-radius:16px;
    font-weight:980;
    font-size:1rem;
    border:1px solid transparent;
    cursor:pointer;
    text-decoration:none;
    transition:transform .12s ease, filter .12s ease, background .12s ease, border-color .12s ease;
    user-select:none;
  }

  .btn-primary{
    background:linear-gradient(135deg,var(--pg-purple),var(--pg-blue));
    color:#fff;
    box-shadow:0 14px 30px rgba(124,58,237,.22);
  }
  .btn-primary:hover{ transform:translateY(-1px); filter:brightness(1.02); }

  .btn-secondary{
    background:rgba(37,99,235,.10);
    color:var(--pg-blue);
    border-color:rgba(37,99,235,.22);
  }
  .btn-secondary:hover{ background:rgba(37,99,235,.14); transform:translateY(-1px); }

  .btn-danger{
    background:rgba(239,68,68,.10);
    color:#EF4444;
    border-color:rgba(239,68,68,.22);
  }
  .btn-danger:hover{ background:rgba(239,68,68,.14); transform:translateY(-1px); }

  .btn-disabled{
    background:rgba(148,163,184,.22);
    color:rgba(100,116,139,1);
    cursor:not-allowed;
    border-color:transparent;
  }

  .form-note{
    display:flex;
    align-items:flex-start;
    gap:8px;
    font-size:.9rem;
    color:var(--muted);
  }
  .form-note svg{ color:var(--pg-purple); margin-top:2px; }

  /* Buyer view */
  .view-only-container{ max-width:980px; margin:0 auto; }
  .product-view-card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--r-lg);
    box-shadow:var(--shadow);
    padding:12px;
  }
  .product-header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    border-bottom:1px solid var(--line);
    padding-bottom:10px;
    margin-bottom:10px;
  }
  .product-title{ margin:0; font-size:1.12rem; font-weight:980; color:var(--pg-black); }
  .dark-theme .product-title{ color:#F1F5F9; }
  .product-price{ display:flex; gap:4px; align-items:baseline; }
  .currency,.amount{ color:var(--pg-green); font-weight:980; }
  .amount{ font-size:1.5rem; }

  .product-content{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }

  .product-image{
    width:100%;
    aspect-ratio: 16 / 12;
    object-fit:contain;
    border-radius:16px;
    border:1px solid rgba(15,23,42,.10);
    background:#fff;
  }
  .dark-theme .product-image{ background:rgba(2,6,23,.25); border-color:rgba(148,163,184,.20); }

  .stock-status{
    margin-top:10px;
    display:flex;
    gap:8px;
    align-items:center;
    padding:10px 12px;
    border-radius:16px;
    font-weight:900;
  }
  .in-stock{ background:rgba(34,197,94,.12); color:#166534; border:1px solid rgba(34,197,94,.22); }
  .out-of-stock{ background:rgba(239,68,68,.10); color:#991B1B; border:1px solid rgba(239,68,68,.22); }

  .details-section h3,
  .description-section h3{
    margin:0 0 8px;
    font-size:1.02rem;
    font-weight:980;
    color:var(--pg-black);
  }
  .dark-theme .details-section h3,
  .dark-theme .description-section h3{ color:#F1F5F9; }

  .details-grid{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
  }
  .detail-item{
    display:flex;
    justify-content:space-between;
    gap:12px;
    padding:10px 12px;
    border-radius:16px;
    background:rgba(37,99,235,.06);
    border:1px solid rgba(37,99,235,.14);
  }
  .dark-theme .detail-item{ background:rgba(148,163,184,.10); border-color:rgba(148,163,184,.18); }
  .detail-label{ font-weight:950; color:rgba(15,23,42,.75); }
  .dark-theme .detail-label{ color:rgba(241,245,249,.70); }
  .detail-value{ font-weight:900; color:var(--pg-black); }
  .dark-theme .detail-value{ color:#F1F5F9; }

  .description-section{ margin-top:12px; padding-top:12px; border-top:1px solid var(--line); }
  .description-content{ line-height:1.6; color:var(--muted); }

  .product-actions{
    display:grid;
    gap:10px;
    margin-top:12px;
    padding-top:12px;
    border-top:1px solid var(--line);
  }

  /* Auth card */
  .auth-required-card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:var(--r-lg);
    padding:16px;
    text-align:center;
    box-shadow:var(--shadow);
    max-width:520px;
    margin:12px auto;
  }
  .auth-icon{
    width:70px;height:70px;border-radius:20px;
    margin:0 auto 12px;
    display:grid;place-items:center;
    background:linear-gradient(135deg, rgba(124,58,237,.14), rgba(37,99,235,.12));
    border:1px solid rgba(124,58,237,.18);
    color:var(--pg-purple);
  }
  .auth-required-card h3{ margin:0 0 8px; font-weight:980; color:var(--pg-black); }
  .dark-theme .auth-required-card h3{ color:#F1F5F9; }
  .auth-required-card p{ margin:0 0 12px; color:var(--muted); }
  .auth-actions{ display:grid; gap:10px; }

  /* Responsive enhancements */
  @media (min-width:520px){
    .details-grid{ grid-template-columns:repeat(2, 1fr); }
    .dims-grid{ grid-template-columns:1fr 1fr 1fr 110px; }
    .dims-grid select{ grid-column:auto; }
  }

  @media (min-width:720px){
    .page-header{ grid-template-columns:1fr auto; align-items:center; }
    .back-button{ width:auto; }
    .tab-content{ padding:16px; }
    .form-section{ padding:16px; }
    .form-grid{ grid-template-columns:repeat(2, 1fr); }
    .media-grid{ grid-template-columns:1fr 1fr; }
    .action-buttons{ grid-template-columns:1fr 1fr 1fr; }
    .product-actions{ grid-template-columns:1fr 1fr; }
    .product-content{ grid-template-columns:320px 1fr; }
  }

  @media (prefers-reduced-motion: reduce){
    .tab,.btn,.back-button,.upload-area,.form-input,.form-select,.form-textarea{ transition:none !important; }
  }
</style>

<!-- Secure Inline Script -->
<script nonce="<%= nonce %>">
  document.addEventListener("DOMContentLoaded", () => {
    console.log("âœï¸ Edit Product page loaded securely with CSP nonce âœ…");

    // =============================
    // Made In (custom searchable dropdown with flags) - EDIT PRODUCT
    // =============================
    const madeDropdown = document.getElementById('madeDropdown');
    const madeSelected = document.getElementById('madeSelected');
    const madeSelectedText = document.getElementById('madeSelectedText');
    const madeSelectedFlagImg = document.getElementById('madeSelectedFlagImg');
    const madeMenu = document.getElementById('madeMenu');
    const madeSearch = document.getElementById('madeSearch');

    const madeHidden = document.getElementById('made');       // hidden required input (submits)
    const madeCode = document.getElementById('madeCode');     // hidden ISO code (submits)

    if (madeDropdown && madeSelected && madeMenu && madeHidden) {
      const getOptions = () => Array.from(madeDropdown.querySelectorAll('.ep-country-option'));

      const open = () => {
        madeDropdown.classList.add('open');
        madeSelected.setAttribute('aria-expanded', 'true');

        if (madeSearch) {
          madeSearch.value = '';
          madeSearch.focus();
        }

        getOptions().forEach(opt => (opt.style.display = 'flex'));
      };

      const close = () => {
        madeDropdown.classList.remove('open');
        madeSelected.setAttribute('aria-expanded', 'false');
      };

      // toggle open/close
      madeSelected.addEventListener('click', () => {
        madeDropdown.classList.contains('open') ? close() : open();
      });

      // keyboard open/close
      madeSelected.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          madeDropdown.classList.contains('open') ? close() : open();
        }
        if (e.key === 'Escape') close();
      });

      // click outside closes
      document.addEventListener('click', (e) => {
        if (!madeDropdown.contains(e.target)) close();
      });

      // select option
      getOptions().forEach(opt => {
        opt.addEventListener('click', () => {
          const value = String(opt.dataset.value || '').trim();
          const code  = String(opt.dataset.code || '').trim();

          madeSelectedText.textContent = value || 'Select country';

          if (madeSelectedFlagImg) {
            if (code) madeSelectedFlagImg.src = `https://flagcdn.com/20x15/${code.toLowerCase()}.png`;
            else madeSelectedFlagImg.removeAttribute('src');
          }

          madeHidden.value = value;
          if (madeCode) madeCode.value = code;

          getOptions().forEach(o => o.classList.remove('active'));
          opt.classList.add('active');

          close();
        });
      });

      // search filter
      if (madeSearch) {
        madeSearch.addEventListener('input', () => {
          const term = String(madeSearch.value || '').toLowerCase().trim();
          getOptions().forEach(opt => {
            const hay = String(opt.dataset.search || opt.textContent || '').toLowerCase();
            opt.style.display = hay.includes(term) ? 'flex' : 'none';
          });
        });
      }

      // âœ… preselect on load (from existing product.made)
      (function initMade() {
        const currentName = String(madeHidden.value || '').trim();
        const currentCode = String(madeCode?.value || '').trim().toLowerCase();

        if (!currentName && !currentCode) return;

        if (madeSelectedFlagImg) {
          madeSelectedFlagImg.style.display = currentCode ? '' : 'none';
        }

        const match =
          getOptions().find(o => String(o.dataset.code || '').trim().toLowerCase() === currentCode) ||
          getOptions().find(o => String(o.dataset.value || '').trim().toLowerCase() === currentName.toLowerCase());

        if (match) {
          match.classList.add('active');
          const v = String(match.dataset.value || '').trim();
          const c = String(match.dataset.code || '').trim();

          madeSelectedText.textContent = v || 'Select country';
          if (madeSelectedFlagImg && c) {
            madeSelectedFlagImg.src = `https://flagcdn.com/20x15/${c.toLowerCase()}.png`;
          }

          madeHidden.value = v;
          if (madeCode) madeCode.value = c;
        } else {
          madeSelectedText.textContent = currentName || 'Select country';
          if (madeSelectedFlagImg) madeSelectedFlagImg.removeAttribute('src');
        }
      })();
    }

    // Tab functionality
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const tabId = tab.getAttribute('data-tab');

        // Update active tab
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        // aria-selected
        tabs.forEach(t => t.setAttribute('aria-selected', t.classList.contains('active') ? 'true' : 'false'));

        // Show corresponding content
        tabContents.forEach(content => {
          content.classList.remove('active');
          if (content.id === `${tabId}-tab`) {
            content.classList.add('active');
          }
        });
      });
    });

    // =============================
    // Product Type filtering by Category (uses PRODUCT_TYPES_BY_CATEGORY)
    // =============================
    const categorySelect = document.getElementById('categorySelect');
    const typeSelect = document.getElementById('typeSelect');

    // Map from server: { electronics: ['phone','laptop',...], fashion: [...], ... }
    const TYPES_BY_CAT = <%- JSON.stringify(PRODUCT_TYPES_BY_CATEGORY || {}) %>;

    // All type objects from server: [{value,label},...]
    const allTypeOptions = <%- JSON.stringify(PRODUCT_TYPES || []) %>;

    // value -> {value,label}
    const TYPE_INDEX = Object.create(null);
    (allTypeOptions || []).forEach(t => {
      const v = String(t?.value || '').trim();
      if (v) TYPE_INDEX[v] = { value: v, label: String(t?.label || v) };
    });

    function normalizeTypeList(list) {
      const out = [];
      (Array.isArray(list) ? list : []).forEach(item => {
        if (item && typeof item === 'object') {
          const v = String(item.value || '').trim();
          if (!v) return;
          out.push({ value: v, label: String(item.label || v) });
          return;
        }

        const v = String(item || '').trim();
        if (!v) return;
        const found = TYPE_INDEX[v];
        out.push(found ? found : { value: v, label: v });
      });
      return out;
    }

    function setTypeOptions(list, keepValue = '') {
      if (!typeSelect) return;

      const current = keepValue || String(typeSelect.value || '');

      typeSelect.innerHTML = '';
      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = 'Choose type';
      typeSelect.appendChild(ph);

      (Array.isArray(list) ? list : []).forEach(t => {
        const opt = document.createElement('option');
        opt.value = String(t.value || '');
        opt.textContent = String(t.label || t.value || '');
        typeSelect.appendChild(opt);
      });

      if (current) {
        const exists = Array.from(typeSelect.options).some(o => o.value === current);
        typeSelect.value = exists ? current : '';
      }
    }

    function applyTypeFilter() {
      if (!categorySelect || !typeSelect) return;

      const cat = String(categorySelect.value || '').trim().toLowerCase();

      if (cat && Array.isArray(TYPES_BY_CAT[cat]) && TYPES_BY_CAT[cat].length) {
        setTypeOptions(normalizeTypeList(TYPES_BY_CAT[cat]), String(typeSelect.value || ''));
        return;
      }

      setTypeOptions(normalizeTypeList(allTypeOptions), String(typeSelect.value || ''));
    }

    if (categorySelect && typeSelect) {
      categorySelect.addEventListener('change', () => {
        typeSelect.value = '';
        applyTypeFilter();
      });

      applyTypeFilter();
    }

    // Character counter for description
    const descriptionTextarea = document.getElementById('description');
    const charCount = document.getElementById('charCount');

    if (descriptionTextarea && charCount) {
      charCount.textContent = descriptionTextarea.value.length;

      descriptionTextarea.addEventListener('input', function() {
        charCount.textContent = this.value.length;

        if (this.value.length > 2000) {
          charCount.style.color = '#EF4444';
        } else if (this.value.length > 1500) {
          charCount.style.color = '#F59E0B';
        } else {
          charCount.style.color = '';
        }
      });
    }

    // Image upload preview
    const imageInput = document.getElementById('imageFile');
    const uploadArea = document.getElementById('uploadArea');
    const previewWrapper = document.getElementById('newImagePreviewWrapper');
    const newImagePreview = document.getElementById('newImagePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removePreviewBtn = document.getElementById('removePreview');

    if (imageInput && uploadArea) {
      uploadArea.addEventListener('click', () => {
        imageInput.click();
      });

      uploadArea.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          imageInput.click();
        }
      });

      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ['dragenter', 'dragover'].forEach(eventName => {
        uploadArea.addEventListener(eventName, highlight, false);
      });

      ['dragleave', 'drop'].forEach(eventName => {
        uploadArea.addEventListener(eventName, unhighlight, false);
      });

      function highlight() {
        uploadArea.style.borderColor = 'rgba(124, 58, 237, 0.75)';
        uploadArea.style.background = 'rgba(124, 58, 237, 0.10)';
      }

      function unhighlight() {
        uploadArea.style.borderColor = '';
        uploadArea.style.background = '';
      }

      uploadArea.addEventListener('drop', handleDrop, false);

      function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
      }

      imageInput.addEventListener('change', function() {
        if (this.files.length > 0) {
          handleFiles(this.files);
        }
      });

      function handleFiles(files) {
        const file = files[0];
        if (!file.type.startsWith('image/')) {
          alert('Please select an image file');
          return;
        }

        if (file.size > 5 * 1024 * 1024) {
          alert('File size must be less than 5MB');
          return;
        }

        const url = URL.createObjectURL(file);
        newImagePreview.src = url;
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        previewWrapper.style.display = 'block';
      }

      function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
      }
    }

    if (removePreviewBtn) {
      removePreviewBtn.addEventListener('click', () => {
        imageInput.value = '';
        previewWrapper.style.display = 'none';
        newImagePreview.src = '';
      });
    }

    // Delete product confirmation
    const deleteBtn = document.getElementById('deleteProduct');
    if (deleteBtn) {
      deleteBtn.addEventListener('click', () => {
        if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
          window.location.href = `/products/delete/<%= product.customId %>`;
        }
      });
    }

    // Form validation
    const form = document.getElementById('editProductForm');
    if (form) {
      form.addEventListener('submit', function(e) {
        const requiredFields = Array.from(this.querySelectorAll('[required]'));
        let isValid = true;

        requiredFields.forEach(field => (field.style.borderColor = ''));

        requiredFields.forEach(field => {
          if (!String(field.value || '').trim()) {
            isValid = false;
            field.style.borderColor = '#EF4444';
          }
        });

        const madeVal = String((document.getElementById('made')?.value || '')).trim();
        const madeSelectedEl = document.getElementById('madeSelected');

        if (!madeVal) {
          e.preventDefault();
          if (madeSelectedEl) madeSelectedEl.style.borderColor = '#EF4444';
          if (madeSelectedEl && madeSelectedEl.scrollIntoView) {
            madeSelectedEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
          alert('Made In is required. Please select a country.');
          return;
        }

        const w  = this.querySelector('input[name="shipWeightValue"]');
        const l  = this.querySelector('input[name="shipLength"]');
        const wi = this.querySelector('input[name="shipWidth"]');
        const h  = this.querySelector('input[name="shipHeight"]');

        const toNum = (el) => Number(String(el?.value || '').trim());
        const bad = [];

        if (!w  || !Number.isFinite(toNum(w))  || toNum(w)  <= 0) bad.push(w);
        if (!l  || !Number.isFinite(toNum(l))  || toNum(l)  <= 0) bad.push(l);
        if (!wi || !Number.isFinite(toNum(wi)) || toNum(wi) <= 0) bad.push(wi);
        if (!h  || !Number.isFinite(toNum(h))  || toNum(h)  <= 0) bad.push(h);

        bad.forEach((el) => { if (el) el.style.borderColor = '#EF4444'; });

        if (bad.length) isValid = false;

        if (!isValid) {
          e.preventDefault();

          const firstBad =
            this.querySelector('[required]:invalid') ||
            bad.find(Boolean) ||
            this.querySelector('[required]');

          if (firstBad && firstBad.scrollIntoView) {
            firstBad.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }

          alert('Shipping weight and dimensions are required and must be greater than 0.');
        }
      });
    }
  });
</script>
