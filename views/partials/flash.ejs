<!-- views/partials/flash.ejs -->
<%
const flashStyles = `
  /* ✅ Brand Colors */
  :root {
    --green: #22C55E;
    --green-dark: #16a34a;
    --green-light: #dcfce7;
    
    --blue: #2563EB;
    --blue-dark: #1d4ed8;
    --blue-light: #dbeafe;
    
    --purple: #7C3AED;
    --purple-dark: #6d28d9;
    --purple-light: #f3e8ff;
    
    --black: #0F172A;
    
    --danger: #dc2626;
    --danger-dark: #b91c1c;
    --danger-light: #fee2e2;
    
    --warning: #f59e0b;
    --warning-dark: #d97706;
    --warning-light: #fef3c7;
    
    --info: #3b82f6;
    --info-dark: #2563eb;
    --info-light: #dbeafe;
    
    --radius-sm: 0.375rem;
    --radius-md: 0.5rem;
    --radius-lg: 0.75rem;
    
    --transition: all 0.2s ease;
  }

  .dark-theme {
    --bg-success: rgba(34, 197, 94, 0.15);
    --bg-error: rgba(220, 38, 38, 0.15);
    --bg-warning: rgba(245, 158, 11, 0.15);
    --bg-info: rgba(59, 130, 246, 0.15);
    
    --text-success: #86efac;
    --text-error: #fca5a5;
    --text-warning: #fcd34d;
    --text-info: #93c5fd;
    
    --border-success: rgba(34, 197, 94, 0.3);
    --border-error: rgba(220, 38, 38, 0.3);
    --border-warning: rgba(245, 158, 11, 0.3);
    --border-info: rgba(59, 130, 246, 0.3);
  }

  :root {
    --bg-success: var(--green-light);
    --bg-error: var(--danger-light);
    --bg-warning: var(--warning-light);
    --bg-info: var(--info-light);
    
    --text-success: var(--green-dark);
    --text-error: var(--danger-dark);
    --text-warning: var(--warning-dark);
    --text-info: var(--info-dark);
    
    --border-success: rgba(34, 197, 94, 0.3);
    --border-error: rgba(220, 38, 38, 0.3);
    --border-warning: rgba(245, 158, 11, 0.3);
    --border-info: rgba(59, 130, 246, 0.3);
  }

  /* ✅ Flash Messages Container */
  .flash-container {
    max-width: 800px;
    margin: 0 auto 1rem;
    padding: 0 0.75rem;
    position: relative;
    z-index: 1000;
  }

  /* ✅ Base Flash Message */
  .flash {
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    font-weight: 500;
    line-height: 1.4;
    display: flex;
    align-items: flex-start;
    gap: 0.625rem;
    animation: slideDown 0.3s ease-out;
    border: 1px solid transparent;
    position: relative;
    overflow: hidden;
  }

  .flash::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: currentColor;
    opacity: 0.5;
  }

  /* ✅ Success Flash */
  .flash-success {
    background: var(--bg-success);
    color: var(--text-success);
    border-color: var(--border-success);
  }

  .flash-success .flash-icon {
    color: var(--green);
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  /* ✅ Error Flash */
  .flash-error {
    background: var(--bg-error);
    color: var(--text-error);
    border-color: var(--border-error);
  }

  .flash-error .flash-icon {
    color: var(--danger);
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  /* ✅ Warning Flash */
  .flash-warning {
    background: var(--bg-warning);
    color: var(--text-warning);
    border-color: var(--border-warning);
  }

  .flash-warning .flash-icon {
    color: var(--warning);
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  /* ✅ Info Flash */
  .flash-info {
    background: var(--bg-info);
    color: var(--text-info);
    border-color: var(--border-info);
  }

  .flash-info .flash-icon {
    color: var(--info);
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  /* ✅ Flash Content */
  .flash-content {
    flex: 1;
    min-width: 0; /* Prevents overflow */
  }

  .flash-title {
    font-weight: 600;
    margin-bottom: 0.125rem;
    display: flex;
    align-items: center;
    gap: 0.375rem;
  }

  .flash-message {
    font-size: 0.8125rem;
  }

  .flash-message ul {
    margin: 0.25rem 0 0 1rem;
    padding: 0;
  }

  .flash-message li {
    margin: 0.125rem 0;
  }

  /* ✅ Close Button */
  .flash-close {
    background: none;
    border: none;
    color: inherit;
    opacity: 0.6;
    cursor: pointer;
    padding: 0.125rem;
    border-radius: var(--radius-sm);
    transition: var(--transition);
    flex-shrink: 0;
    margin-left: auto;
    font-size: 0.875rem;
  }

  .flash-close:hover {
    opacity: 1;
    background: rgba(0, 0, 0, 0.05);
  }

  .dark-theme .flash-close:hover {
    background: rgba(255, 255, 255, 0.1);
  }

  /* ✅ Progress Bar Animation */
  .flash-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 2px;
    background: currentColor;
    opacity: 0.3;
    animation: progressBar 5s linear;
    width: 100%;
    transform-origin: left;
  }

  /* ✅ Animations */
  @keyframes slideDown {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes progressBar {
    from { transform: scaleX(1); }
    to { transform: scaleX(0); }
  }

  /* ✅ Mobile Optimizations */
  @media (max-width: 480px) {
    .flash-container {
      padding: 0 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .flash {
      padding: 0.625rem 0.75rem;
      font-size: 0.8125rem;
      gap: 0.5rem;
    }
    
    .flash-message {
      font-size: 0.75rem;
    }
    
    .flash-close {
      padding: 0.125rem 0.25rem;
      font-size: 0.75rem;
    }
  }

  /* ✅ Small Screen Adjustments */
  @media (max-width: 360px) {
    .flash {
      padding: 0.5rem;
      gap: 0.375rem;
    }
    
    .flash-icon {
      font-size: 0.875rem;
    }
    
    .flash-message ul {
      margin-left: 0.75rem;
    }
  }

  /* ✅ Multiple Messages Spacing */
  .flash:not(:last-child) {
    margin-bottom: 0.5rem;
  }

  /* ✅ Auto-dismiss Animation */
  .flash.auto-dismiss {
    animation: slideDown 0.3s ease-out, slideUp 0.3s ease-out 4.7s forwards;
  }

  @keyframes slideUp {
    from {
      opacity: 1;
      transform: translateY(0);
      max-height: 200px;
      margin-bottom: 0.5rem;
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
      max-height: 0;
      margin-bottom: 0;
      padding-top: 0;
      padding-bottom: 0;
      border-width: 0;
    }
  }
`;

const flashScripts = `
  document.addEventListener('DOMContentLoaded', function() {
    const flashes = document.querySelectorAll('.flash');
    
    flashes.forEach(flash => {
      // Add close button
      const closeBtn = document.createElement('button');
      closeBtn.className = 'flash-close';
      closeBtn.innerHTML = '×';
      closeBtn.setAttribute('aria-label', 'Close message');
      flash.appendChild(closeBtn);
      
      // Add progress bar for auto-dismiss
      if (!flash.classList.contains('flash-error')) {
        const progressBar = document.createElement('div');
        progressBar.className = 'flash-progress';
        flash.appendChild(progressBar);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
          flash.classList.add('auto-dismiss');
        }, 5000);
      }
      
      // Close functionality
      closeBtn.addEventListener('click', function() {
        flash.classList.add('auto-dismiss');
      });
    });
    
    // Remove dismissed elements from DOM after animation
    document.addEventListener('animationend', function(e) {
      if (e.animationName === 'slideUp') {
        e.target.remove();
      }
    });
    
    // Handle multiple messages
    const flashContainer = document.querySelector('.flash-container');
    if (flashContainer && flashContainer.children.length > 3) {
      // If too many messages, show first 3 and add show more
      const messages = Array.from(flashContainer.children);
      messages.slice(3).forEach(msg => {
        msg.style.display = 'none';
      });
      
      if (messages.length > 3) {
        const showMore = document.createElement('div');
        showMore.className = 'flash flash-info';
        showMore.innerHTML = \`
          <div class="flash-content">
            <div class="flash-message">
              Showing 3 of \${messages.length} messages. 
              <a href="#" class="show-all-flash" style="color: inherit; font-weight: 600;">Show all</a>
            </div>
          </div>
        \`;
        
        const closeBtn = document.createElement('button');
        closeBtn.className = 'flash-close';
        closeBtn.innerHTML = '×';
        closeBtn.setAttribute('aria-label', 'Close message');
        showMore.appendChild(closeBtn);
        
        flashContainer.appendChild(showMore);
        
        showMore.querySelector('.show-all-flash').addEventListener('click', function(e) {
          e.preventDefault();
          messages.forEach(msg => msg.style.display = '');
          showMore.remove();
        });
        
        closeBtn.addEventListener('click', function() {
          showMore.classList.add('auto-dismiss');
        });
      }
    }
  });
`;
%>

<!-- ✅ Inject Flash Styles -->
<style nonce="<%= nonce %>">
  <%= flashStyles %>
</style>

<!-- ✅ Flash Messages Container -->
<div class="flash-container">
  <!-- Success Messages -->
  <% if (success && success.length) { %>
    <div class="flash flash-success">
      <div class="flash-icon">✅</div>
      <div class="flash-content">
        <div class="flash-title">Success</div>
        <div class="flash-message">
          <%= Array.isArray(success) ? success.join("<br>") : success %>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Error Messages -->
  <% if (error && error.length) { %>
    <div class="flash flash-error">
      <div class="flash-icon">❌</div>
      <div class="flash-content">
        <div class="flash-title">Error</div>
        <div class="flash-message">
          <%= Array.isArray(error) ? error.join("<br>") : error %>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Info Messages -->
  <% if (info && info.length) { %>
    <div class="flash flash-info">
      <div class="flash-icon">ℹ️</div>
      <div class="flash-content">
        <div class="flash-title">Information</div>
        <div class="flash-message">
          <%= Array.isArray(info) ? info.join("<br>") : info %>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Warning Messages -->
  <% if (warning && warning.length) { %>
    <div class="flash flash-warning">
      <div class="flash-icon">⚠️</div>
      <div class="flash-content">
        <div class="flash-title">Warning</div>
        <div class="flash-message">
          <%= Array.isArray(warning) ? warning.join("<br>") : warning %>
        </div>
      </div>
    </div>
  <% } %>

  <!-- Form Errors (if provided) -->
  <% if (errors && errors.length) { %>
    <div class="flash flash-error">
      <div class="flash-icon">⚠️</div>
      <div class="flash-content">
        <div class="flash-title">Validation Errors</div>
        <div class="flash-message">
          <% if (Array.isArray(errors)) { %>
            <ul>
              <% errors.forEach(function(err) { %>
                <li><%= err %></li>
              <% }); %>
            </ul>
          <% } else if (typeof errors === 'object') { %>
            <ul>
              <% Object.values(errors).forEach(function(err) { %>
                <li><%= err %></li>
              <% }); %>
            </ul>
          <% } else { %>
            <%= errors %>
          <% } %>
        </div>
      </div>
    </div>
  <% } %>
</div>

<!-- ✅ Inject Flash Scripts -->
<script nonce="<%= nonce %>">
  <%= flashScripts %>
</script>