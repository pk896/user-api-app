<!-- views/users-profile.ejs -->
<section class="profile-page mini">
  <% const profileUser = user || locals.user || {}; %>

  <h1 class="page-title">üôç My Profile</h1>

  <% if (!profileUser.isEmailVerified && profileUser.email) { %>
    <div class="card verify-card">
      <p class="verify-title">‚ö† Email not verified</p>
      <p class="verify-text">
        We‚Äôve sent a verification email to
        <strong><%= profileUser.email %></strong>.
      </p>
      <p class="verify-text small">
        Please verify your email to unlock your dashboard, orders and other features.
        You can resend the verification email from the next page.
      </p>
      <a href="/users/verify-pending" class="btn xs warn wfull">
        üìß Verify / resend email
      </a>
    </div>
  <% } %>

  <div class="card info">
    <div class="row">
      <span class="label">Name</span>
      <span class="value">
        <%= profileUser.name || '' %>
      </span>
    </div>

    <div class="row">
      <span class="label">Username</span>
      <span class="value">
        <%= profileUser.username || '‚Äî' %>
      </span>
    </div>

    <div class="row">
      <span class="label">Email</span>
      <span
        class="value ellipsis"
        title="<%= profileUser.email || '' %>">
        <%= profileUser.email || '‚Äî' %>
      </span>
    </div>

    <div class="row">
      <span class="label">Email status</span>
      <span class="value">
        <% if (profileUser.isEmailVerified) { %>
          ‚úÖ Verified
        <% } else { %>
          ‚ö†Ô∏è Not verified
        <% } %>
      </span>
    </div>

    <div class="row">
      <span class="label">Sign-in</span>
      <span class="value">
        <% if (profileUser.provider === 'google') { %>
          Google
        <% } else if (profileUser.provider === 'both') { %>
          Email &amp; Google
        <% } else { %>
          Email / Username
        <% } %>
      </span>
    </div>

    <% if (typeof profileUser.age !== 'undefined' && profileUser.age !== null) { %>
      <div class="row">
        <span class="label">Age</span>
        <span class="value"><%= profileUser.age %></span>
      </div>
    <% } %>

    <div class="row">
      <span class="label">Joined</span>
      <span class="value">
        <%= profileUser.createdAt ? new Date(profileUser.createdAt).toLocaleString() : '' %>
      </span>
    </div>

    <% if (profileUser.lastLogin) { %>
      <div class="row">
        <span class="label">Last login</span>
        <span class="value">
          <%= new Date(profileUser.lastLogin).toLocaleString() %>
        </span>
      </div>
    <% } %>
  </div>

  <div class="card actions">
    <a href="/users/profile/edit" class="btn xs wfull">‚úèÔ∏è Edit</a>
    <a href="/users/change-password" class="btn xs wfull">üîë Password</a>

    <form action="/users/logout" method="get" class="stack">
      <button type="submit" class="btn xs subtle wfull">üö™ Log out</button>
    </form>

    <form
      action="/users/profile/delete"
      method="post"
      class="stack"
      onsubmit="return confirm('Are you sure? This will permanently delete your account and cannot be undone.');"
    >
      <button type="submit" class="btn xs danger wfull">üóëÔ∏è Delete account</button>
    </form>

    <p class="danger-note">
      Deleting your account will permanently remove your profile and access.
    </p>
  </div>
</section>

<style nonce="<%= typeof nonce !== 'undefined' ? nonce : '' %>">
  /* ===== Mobile-first, ultra-compact tokens ===== */
  :root {
    --pg-gap: .38rem;
    --pg-pad: .46rem;
    --pg-radius: 10px;
    --pg-fs-base: .82rem;      /* base body size for tiny screens */
    --pg-fs-small: .74rem;
    --pg-fs-label: .72rem;
    --pg-fs-title: 1rem;
  }

  .profile-page.mini {
    max-width: 380px;               /* slightly narrower for small phones */
    margin: .55rem auto .9rem;
    padding: 0 .44rem;
    font-size: var(--pg-fs-base);
  }

  .page-title {
    font-size: var(--pg-fs-title);
    text-align: center;
    font-weight: 800;
    margin: .1rem 0 .5rem;
    letter-spacing: .1px;
  }

  .card {
    background: var(--card-bg, #fff);
    border: 1px solid var(--card-bd, #e5e7eb);
    border-radius: var(--pg-radius);
    padding: var(--pg-pad);
    margin-bottom: .44rem;
    box-shadow: 0 1px 2px rgba(0,0,0,.05);
  }
  .dark-theme .card {
    --card-bg: #1f2937;
    --card-bd: #374151;
    color: #e5e7eb;
  }

  /* Verify banner card */
  .verify-card {
    border-color:#fcd34d;
    background:#fffbeb;
  }
  .dark-theme .verify-card {
    border-color:#facc15;
    background:#451a03;
  }
  .verify-title {
    font-weight:800;
    margin-bottom:.2rem;
    font-size:.86rem;
  }
  .verify-text {
    margin:.08rem 0;
    color:#4b5563;
  }
  .verify-text.small {
    font-size:.78rem;
    color:#6b7280;
  }
  .dark-theme .verify-text,
  .dark-theme .verify-text.small {
    color:#e5e7eb;
  }

  /* Info rows: very tight and readable on tiny screens */
  .info .row {
    display: grid;
    grid-template-columns: 80px 1fr;   /* a bit wider for new labels */
    gap: .28rem;
    align-items: center;
    padding: .22rem 0;
    border-bottom: 1px dashed rgba(0,0,0,.06);
  }
  .info .row:last-child { border-bottom: 0; }
  .dark-theme .info .row { border-color: rgba(255,255,255,.08); }

  .label {
    font-size: var(--pg-fs-label);
    font-weight: 800;
    opacity: .85;
  }

  .value {
    font-size: var(--pg-fs-base);
    line-height: 1.25;
    min-width: 0;                /* allow ellipsis */
  }

  .ellipsis {
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    display: inline-block;
    max-width: 100%;
  }

  .actions { padding: .28rem .24rem; }

  .btn {
    display: inline-block;
    width: 100%;
    padding: .34rem .46rem;      /* compact tap area */
    font-size: var(--pg-fs-small);
    border-radius: 7px;
    text-decoration: none;
    text-align: center;
    margin: .18rem 0;
    border: 1px solid #d1d5db;
    background: #f3f4f6;
    color: #111827;
    font-weight: 800;
  }
  .btn:hover { opacity: .95; }

  .dark-theme .btn {
    background: #374151;
    border-color: #4b5563;
    color: #e5e7eb;
  }

  .btn.danger {
    background: #fee2e2;
    border-color: #fecaca;
    color: #991b1b;
  }
  .dark-theme .btn.danger {
    background: #7f1d1d;
    border-color: #b91c1c;
    color: #fff;
  }

  .btn.subtle {
    background:#e5e7eb;
    border-color:#d1d5db;
    color:#111827;
  }
  .dark-theme .btn.subtle {
    background:#111827;
    border-color:#4b5563;
    color:#e5e7eb;
  }

  .btn.warn {
    background:#f97316;
    border-color:#ea580c;
    color:#fff;
  }
  .dark-theme .btn.warn {
    background:#c2410c;
    border-color:#ea580c;
    color:#fff;
  }

  .btn.xs {
    font-size: var(--pg-fs-small);
    padding: .32rem .44rem;
    border-radius: 7px;
  }

  .wfull { width: 100%; }

  .danger-note {
    margin-top: .1rem;
    font-size: .7rem;
    color: #991b1b;
    text-align: center;
  }
  .dark-theme .danger-note { color: #fecaca; }

  /* ===== Extra-tight layout for ultra-small screens (~320px) ===== */
  @media (max-width: 360px) {
    :root {
      --pg-gap: .34rem;
      --pg-pad: .42rem;
      --pg-fs-base: .8rem;
      --pg-fs-small: .7rem;
      --pg-fs-label: .68rem;
      --pg-fs-title: .98rem;
    }
    .profile-page.mini { padding: 0 .38rem; }
    .info .row { grid-template-columns: 76px 1fr; }
  }

  /* Slightly scale up for mid phones while staying compact */
  @media (min-width: 420px) {
    .profile-page.mini { max-width: 420px; }
    .info .row { grid-template-columns: 90px 1fr; }
  }

  /* Motion safety */
  @media (prefers-reduced-motion: reduce) {
    * { transition: none !important; animation: none !important; }
  }
</style>

