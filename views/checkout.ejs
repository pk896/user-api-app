<!--views/checkout.ejs-->
<%
  const CO_NONCE      = typeof nonce !== 'undefined' ? nonce : '';
  const CO_CLIENT_ID  = typeof paypalClientId !== 'undefined' ? paypalClientId : '';
  const CO_CCY        = typeof currency !== 'undefined' ? currency : 'USD';
  const CO_BRAND      = typeof brandName !== 'undefined' ? brandName : 'Unicoporate.com';
  const CO_VAT        = typeof vatRate !== 'undefined' ? Number(vatRate) : 0.15;
%>

<section class="co-page" aria-label="Checkout">
  <!-- ===== Top Compact Header (does NOT replace your layout header/nav) ===== -->
  <header class="co-hero" aria-label="Checkout header">
    <div class="co-hero-inner">
      <div class="co-breadcrumb" aria-label="Breadcrumb">
        <a href="/cart" class="co-link">Cart</a>
        <span class="co-sep">‚Ä∫</span>
        <span class="co-crumb">Checkout</span>
      </div>

      <div class="co-title-row">
        <h1 class="co-title">Secure Checkout</h1>
        <span class="co-badge">Protected</span>
      </div>

      <p class="co-subtitle">
        Fast, mobile-friendly checkout. Your payment is processed securely by PayPal.
      </p>

      <div class="co-steps" aria-label="Steps">
        <div class="co-step done"><span>1</span><em>Cart</em></div>
        <div class="co-step done"><span>2</span><em>Details</em></div>
        <div class="co-step now"><span>3</span><em>Payment</em></div>
        <div class="co-step"><span>4</span><em>Confirm</em></div>
      </div>
    </div>
  </header>

  <!-- ===== Content ===== -->
  <div class="co-grid">
    <!-- LEFT: Cart + Delivery -->
    <div class="co-col">
      <!-- Cart Summary -->
      <div class="co-card co-card-purple" aria-label="Cart summary">
        <div class="co-card-h">
          <div class="co-card-title">
            <span class="co-icon" aria-hidden="true">üõí</span>
            <h2>Shopping Cart</h2>
          </div>
          <a href="/cart" class="co-action">Edit</a>
        </div>

        <div class="co-card-b">
          <div id="cart-state" class="co-loading" aria-live="polite">
            <span class="co-spinner" aria-hidden="true"></span>
            <span>Loading your cart‚Ä¶</span>
          </div>

          <div id="cart-items" class="co-cart" style="display:none"></div>

          <div id="cart-empty" class="co-empty" style="display:none">
            <div class="co-empty-ic" aria-hidden="true">üõí</div>
            <h3>Your cart is empty</h3>
            <p>Go back and add items to continue.</p>
            <a href="/sales" class="co-btn co-btn-blue">Browse Products</a>
          </div>
        </div>
      </div>

      <!-- Delivery Options -->
      <div class="co-card co-card-blue" aria-label="Delivery options">
        <div class="co-card-h">
          <div class="co-card-title">
            <span class="co-icon" aria-hidden="true">üöö</span>
            <h2>Delivery</h2>
          </div>
          <span class="co-pill">Required</span>
        </div>

        <div class="co-card-b">

          <!-- Shipping Address (collapsible) -->
          <details id="ship-details"
            class="co-card co-card-purple co-collapse"
            aria-label="Shipping address"
            open
            style="margin-bottom:.75rem">

            <summary class="co-card-h">
              <div class="co-card-title">
                <span class="co-icon" aria-hidden="true">üìç</span>
                <div class="co-collapse-title">
                  <h2>Shipping Address</h2>
                  <div id="ship-summary" class="co-collapse-summary">Not completed yet</div>
                </div>
              </div>

              <div class="co-collapse-right">
                <span class="co-pill">Required</span>
                <span class="co-collapse-caret" aria-hidden="true">‚ñº</span>
              </div>
            </summary>

            <div class="co-card-b">
              <div class="co-mini" id="ship-hint" aria-live="polite">
                Please enter the address where you want the order delivered.
              </div>

              <label class="co-label" for="ship-name">Full name <span class="co-req">*</span></label>
              <input id="ship-name" class="co-input" autocomplete="name" placeholder="Full name" />

              <label class="co-label" for="ship-phone" style="margin-top:.6rem">Phone <span class="co-req">*</span></label>
              <input id="ship-phone" class="co-input" autocomplete="tel" placeholder="+27..." />

              <label class="co-label" for="ship-email" style="margin-top:.6rem">Email (optional)</label>
              <input id="ship-email" class="co-input" autocomplete="email" placeholder="you@example.com" />

              <label class="co-label" for="ship-line1" style="margin-top:.6rem">Address line 1 <span class="co-req">*</span></label>
              <input id="ship-line1" class="co-input" autocomplete="address-line1" placeholder="Street number and street name" />

              <label class="co-label" for="ship-line2" style="margin-top:.6rem">Address line 2 (optional)</label>
              <input id="ship-line2" class="co-input" autocomplete="address-line2" placeholder="Apartment, suite, etc." />

              <label class="co-label" for="ship-city" style="margin-top:.6rem">City <span class="co-req">*</span></label>
              <input id="ship-city" class="co-input" autocomplete="address-level2" placeholder="City" />

              <label class="co-label" for="ship-state" style="margin-top:.6rem">Province/State <span class="co-req">*</span></label>
              <input id="ship-state" class="co-input" autocomplete="address-level1" placeholder="Gauteng, WC, etc." />

              <label class="co-label" for="ship-zip" style="margin-top:.6rem">Postal code <span class="co-req">*</span></label>
              <input id="ship-zip" class="co-input" autocomplete="postal-code" placeholder="0000" />

              <label class="co-label" for="ship-country-search" style="margin-top:.6rem">Country <span class="co-req">*</span></label>
              <input id="ship-country-search" class="co-input" autocomplete="off" placeholder="Type to search your country‚Ä¶" />

              <div class="co-select" style="margin-top:.4rem">
                <select id="ship-country" class="co-select-el" aria-label="Country"></select>
                <span class="co-select-caret" aria-hidden="true">‚ñº</span>
              </div>

              <div class="co-mini">Tip: start typing (e.g. ‚ÄúSouth‚Äù, ‚ÄúUni‚Äù, ‚ÄúZA‚Äù, ‚ÄúUS‚Äù).</div>

              <div class="co-form-actions">
                <button type="button" id="ship-done" class="co-btn co-btn-blue">Done</button>
                <button type="button" id="ship-edit" class="co-btn co-btn-ghost">Keep editing</button>
              </div>
            </div>
          </details>

          <label for="delivery-select" class="co-label">
            Select shipping rate (live) <span class="co-req">*</span>
          </label>

          <div class="co-select">
            <select id="delivery-select" class="co-select-el" disabled aria-label="Delivery method">
              <option value="">Loading options‚Ä¶</option>
            </select>
            <span class="co-select-caret" aria-hidden="true">‚ñº</span>
          </div>

          <div style="margin-top:.55rem; display:flex; gap:.55rem; flex-wrap:wrap;">
            <button type="button" id="rates-retry" class="co-btn co-btn-ghost">Retry rates</button>
            <small class="co-mini" id="rates-debug" style="margin:0;">&nbsp;</small>
          </div>

          <div id="delivery-hint" class="co-hint" aria-live="polite">
            <span class="co-hint-ic" aria-hidden="true">‚è±Ô∏è</span>
            <span>Loading delivery estimates‚Ä¶</span>
          </div>

          <div id="delivery-info" class="co-info" style="display:none" aria-label="Delivery details">
            <div class="co-info-row">
              <span class="co-info-ic" aria-hidden="true">üì¶</span>
              <div>
                <small>Delivery Type</small>
                <strong id="delivery-type">‚Äî</strong>
              </div>
            </div>

            <div class="co-info-row">
              <span class="co-info-ic" aria-hidden="true">‚è±Ô∏è</span>
              <div>
                <small>Estimated Delivery</small>
                <strong id="delivery-estimate">‚Äî</strong>
              </div>
            </div>

            <div class="co-info-row">
              <span class="co-info-ic" aria-hidden="true">üìç</span>
              <div>
                <small>Delivery Area</small>
                <strong id="delivery-area">‚Äî</strong>
              </div>
            </div>
          </div>

          

          <!-- Optional note (UI only) -->
          <label for="delivery-note" class="co-label" style="margin-top:.8rem">
            Delivery note (optional)
          </label>
          <input
            id="delivery-note"
            class="co-input"
            type="text"
            placeholder="e.g. Gate code, call on arrival, leave at reception"
            autocomplete="off"
          />
          <div class="co-mini">
            Note is not required and does not affect payment.
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Summary + PayPal -->
    <div class="co-col">
      <!-- Order Summary -->
      <div class="co-card co-card-green" aria-label="Order summary">
        <div class="co-card-h">
          <div class="co-card-title">
            <span class="co-icon" aria-hidden="true">üßæ</span>
            <h2>Order Summary</h2>
          </div>
        </div>

        <div class="co-card-b">
          <div class="co-sum">
            <div class="co-sum-row">
              <span>Subtotal</span>
              <strong id="sum-subtotal">‚Äî</strong>
            </div>

            <div class="co-sum-row">
              <span>VAT (<span id="vat-rate"><%= (CO_VAT * 100).toFixed(0) %></span>%)</span>
              <strong id="sum-vat">‚Äî</strong>
            </div>

            <div class="co-sum-row">
              <span>Shipping</span>
              <strong id="sum-shipping">‚Äî</strong>
            </div>

            <div class="co-sum-rule"></div>

            <div class="co-sum-total">
              <span>Total</span>
              <strong id="sum-total">‚Äî</strong>
            </div>

            <div class="co-note">
              <span aria-hidden="true">üí°</span>
              <span>Prices include VAT where applicable.</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment -->
      <div class="co-card co-card-black" aria-label="Payment">
        <div class="co-card-h">
          <div class="co-card-title">
            <span class="co-icon" aria-hidden="true">üí≥</span>
            <h2>Pay Securely</h2>
          </div>
          <span class="co-sec">
            <span aria-hidden="true">üîí</span> Secure
          </span>
        </div>

        <div class="co-card-b">
          <div class="co-payhead">
            <div>
              <div class="co-paytitle">Pay with PayPal</div>
              <div class="co-paymuted">Debit/Credit card enabled where available</div>
            </div>
          </div>

          <div class="co-paybox">
            <div id="pay-guard" class="co-guard" aria-live="polite">
              <span class="co-spinner" aria-hidden="true"></span>
              <p>Waiting for cart & delivery options‚Ä¶</p>
            </div>

            <div id="paypal-buttons" class="co-pp"></div>
          </div>

          <div class="co-paynote">
            <div class="co-paynote-row">
              <span class="ok" aria-hidden="true">‚úì</span>
              <span>Processed securely by PayPal</span>
            </div>
            <div class="co-paynote-row">
              <span class="ok" aria-hidden="true">‚úì</span>
              <span>We never store your card details</span>
            </div>
            <div class="co-paynote-row">
              <span class="ok" aria-hidden="true">‚úì</span>
              <span>Merchant: <%= CO_BRAND %></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Compact trust row -->
      <div class="co-trust" aria-label="Trust signals">
        <div class="co-trust-item"><span aria-hidden="true">üîí</span><span>SSL</span></div>
        <div class="co-trust-item"><span aria-hidden="true">üí≥</span><span>PCI</span></div>
        <div class="co-trust-item"><span aria-hidden="true">üîÑ</span><span>Returns</span></div>
      </div>
    </div>
  </div>

  <!-- Toast (kept) -->
  <div id="toast" class="co-toast" aria-live="polite" aria-atomic="true" hidden>
    <div class="co-toast-inner">
      <span class="co-toast-icon"></span>
      <span class="co-toast-message"></span>
    </div>
  </div>

  <!-- Templates -->
  <template id="tpl-cart-row">
    <div class="co-item" data-id="">
      <div class="co-item-img">
        <img class="co-img" alt="" />
      </div>
      <div class="co-item-mid">
        <div class="co-item-top">
          <h3 class="co-item-name"></h3>
          <button type="button" class="co-x" aria-label="Remove item">√ó</button>
        </div>
        <div class="co-item-variants"></div>

        <div class="co-item-bot">
          <div class="co-qty" aria-label="Quantity">
            <button type="button" class="co-qty-btn co-dec" aria-label="Decrease quantity">‚àí</button>
            <span class="co-qty-val">1</span>
            <button type="button" class="co-qty-btn co-inc" aria-label="Increase quantity">+</button>
          </div>
          <div class="co-item-price">
            <strong class="co-price-val"></strong>
            <small>total</small>
          </div>
        </div>
      </div>
    </div>
  </template>

  <!-- JSON config -->
  <script id="checkout-config" type="application/json" nonce="<%= CO_NONCE %>">
    <%- JSON.stringify({
      VAT_RATE: Number(CO_VAT),
      CURRENCY: CO_CCY,
      BRAND_NAME: CO_BRAND
    }) %>
  </script>

  <!-- PayPal SDK (paths unchanged) -->
  <script nonce="<%= CO_NONCE %>"
    src="https://www.paypal.com/sdk/js?client-id=<%= encodeURIComponent(CO_CLIENT_ID) %>&components=buttons&currency=<%= encodeURIComponent(CO_CCY) %>&intent=capture&enable-funding=card"></script>

  <style nonce="<%= CO_NONCE %>">
    /* ===== Brand palette ===== */
    .co-page{
      --b:#2563EB;  /* Blue */
      --p:#7C3AED;  /* Purple (dominant) */
      --g:#22C55E;  /* Green */
      --k:#0F172A;  /* Black */
      --w:#ffffff;
      --mut:#64748B;
      --line:rgba(15,23,42,.12);
      --shadow:0 10px 24px rgba(15,23,42,.12);

      padding: .75rem;
      background:
        radial-gradient(900px 420px at 50% -10%, rgba(124,58,237,.25) 0%, rgba(37,99,235,.08) 55%, rgba(34,197,94,.06) 100%),
        linear-gradient(180deg, #f8fafc, #f8fafc);
      min-height: 60vh;
    }

    /* ===== Hero ===== */
    .co-hero{
      border-radius: 18px;
      padding: .9rem;
      background: linear-gradient(135deg, rgba(124,58,237,1), rgba(37,99,235,1));
      color: #fff;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .co-hero-inner{ max-width: 1100px; margin:0 auto; }
    .co-breadcrumb{ display:flex; align-items:center; gap:.45rem; font-size:.88rem; opacity:.95; }
    .co-link{ color:#fff; text-decoration:none; font-weight:800; }
    .co-link:hover{ text-decoration:underline; }
    .co-sep{ opacity:.85; }
    .co-crumb{ font-weight:700; opacity:.95; }

    .co-title-row{ display:flex; align-items:center; justify-content:space-between; gap:.6rem; margin-top:.35rem; }
    .co-title{ margin:0; font-size:1.15rem; font-weight:950; letter-spacing:.2px; }
    .co-badge{
      background: rgba(255,255,255,.18);
      border:1px solid rgba(255,255,255,.25);
      padding:.22rem .6rem;
      border-radius:999px;
      font-weight:900;
      font-size:.78rem;
      white-space:nowrap;
    }
    .co-subtitle{ margin:.35rem 0 0; font-size:.9rem; opacity:.95; }

    .co-steps{
      margin-top:.75rem;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:.35rem;
    }
    .co-step{
      background: rgba(255,255,255,.14);
      border:1px solid rgba(255,255,255,.22);
      border-radius: 12px;
      padding:.4rem .45rem;
      display:flex;
      align-items:center;
      gap:.45rem;
      justify-content:center;
      font-size:.78rem;
      font-weight:900;
      text-align:center;
      white-space:nowrap;
    }
    .co-step span{
      width: 22px; height:22px;
      border-radius:999px;
      display:inline-flex; align-items:center; justify-content:center;
      background: rgba(255,255,255,.22);
      border:1px solid rgba(255,255,255,.26);
    }
    .co-step em{ font-style:normal; opacity:.98; }
    .co-step.done{ background: rgba(34,197,94,.22); border-color: rgba(34,197,94,.35); }
    .co-step.now{ background: rgba(15,23,42,.22); border-color: rgba(15,23,42,.18); }

    /* ===== Grid ===== */
    .co-grid{
      max-width:1100px;
      margin: .75rem auto 0;
      display:grid;
      grid-template-columns: 1fr;
      gap:.75rem;
    }
    @media(min-width: 980px){
      .co-grid{ grid-template-columns: 1fr 1fr; }
    }
    .co-col{ display:flex; flex-direction:column; gap:.75rem; }

    /* ===== Cards ===== */
    .co-card{
      border-radius: 18px;
      overflow:hidden;
      box-shadow: var(--shadow);
      border:1px solid var(--line);
      background:#fff;
    }
    .co-card-h{
      display:flex; align-items:center; justify-content:space-between;
      padding:.75rem .85rem;
      border-bottom:1px solid var(--line);
    }
    .co-card-title{ display:flex; align-items:center; gap:.55rem; }
    .co-card-title h2{ margin:0; font-size:1rem; font-weight:950; color: var(--k); }
    .co-icon{ width:28px; height:28px; display:grid; place-items:center; border-radius:10px; font-size:1.05rem; }
    .co-card-b{ padding:.8rem .85rem; }

    .co-action{
      text-decoration:none;
      font-weight:900;
      font-size:.86rem;
      color: var(--b);
    }
    .co-action:hover{ text-decoration:underline; }

    .co-pill{
      background: rgba(124,58,237,.14);
      color: var(--p);
      border: 1px solid rgba(124,58,237,.25);
      padding:.2rem .55rem;
      border-radius:999px;
      font-size:.75rem;
      font-weight:950;
    }
    .co-sec{
      background: rgba(34,197,94,.14);
      color: #166534;
      border: 1px solid rgba(34,197,94,.25);
      padding:.2rem .55rem;
      border-radius:999px;
      font-size:.75rem;
      font-weight:950;
      display:flex; gap:.35rem; align-items:center;
    }

    /* colored headers (visible blocks) */
    .co-card-purple .co-card-h{ background: rgba(124,58,237,.12); }
    .co-card-purple .co-icon{ background: rgba(124,58,237,.18); }
    .co-card-blue .co-card-h{ background: rgba(37,99,235,.10); }
    .co-card-blue .co-icon{ background: rgba(37,99,235,.16); }
    .co-card-green .co-card-h{ background: rgba(34,197,94,.10); }
    .co-card-green .co-icon{ background: rgba(34,197,94,.16); }
    .co-card-black .co-card-h{ background: rgba(15,23,42,.08); }
    .co-card-black .co-icon{ background: rgba(15,23,42,.10); }

    /* ===== Loading / empty ===== */
    .co-loading{
      display:flex; align-items:center; gap:.55rem;
      padding:.7rem;
      background: rgba(124,58,237,.06);
      border:1px dashed rgba(124,58,237,.28);
      border-radius: 14px;
      color: var(--k);
      font-weight:800;
      font-size:.9rem;
    }
    .co-spinner{
      width:18px; height:18px;
      border-radius:999px;
      border:3px solid rgba(15,23,42,.12);
      border-top-color: var(--p);
      animation: coSpin 1s linear infinite;
      flex:0 0 auto;
    }
    @keyframes coSpin{ to{ transform:rotate(360deg); } }

    .co-empty{ text-align:center; padding: .9rem .4rem; }
    .co-empty-ic{ font-size:2.1rem; }
    .co-empty h3{ margin:.25rem 0 0; font-size:1.05rem; font-weight:950; color: var(--k); }
    .co-empty p{ margin:.25rem 0 .6rem; color: var(--mut); font-weight:650; }

    /* ===== Buttons ===== */
    .co-btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:.55rem .9rem;
      border-radius: 12px;
      font-weight:950;
      text-decoration:none;
      border:1px solid transparent;
      cursor:pointer;
      font-size:.92rem;
      user-select:none;
    }
    .co-btn-blue{ background: var(--b); color:#fff; border-color: var(--b); }
    .co-btn-blue:hover{ filter:brightness(.95); transform: translateY(-1px); }

    /* ===== Address actions ===== */
    .co-form-actions{
      display:flex;
      gap:.55rem;
      margin-top:.85rem;
    }
    .co-btn-ghost{
      background:#fff;
      color: var(--k);
      border:1px solid rgba(15,23,42,.18);
    }
    .co-btn-ghost:hover{
      background: rgba(15,23,42,.03);
    }

    /* ===== Delivery UI ===== */
    .co-label{
      display:block;
      font-size:.9rem;
      font-weight:950;
      color: var(--k);
      margin-bottom:.35rem;
    }
    .co-req{ color:#ef4444; }

    .co-select{ position:relative; }
    .co-select-el{
      width:100%;
      padding:.7rem 2.2rem .7rem .75rem;
      border-radius: 14px;
      border:1px solid rgba(15,23,42,.14);
      font-weight:800;
      outline:none;
      background:#fff;
      color: var(--k);
    }
    .co-select-el:focus{
      border-color: rgba(124,58,237,.55);
      box-shadow: 0 0 0 3px rgba(124,58,237,.14);
    }
    .co-select-el:disabled{ background:#f1f5f9; cursor:not-allowed; }
    .co-select-caret{
      position:absolute;
      right:.8rem;
      top:50%;
      transform: translateY(-50%);
      color: rgba(15,23,42,.55);
      pointer-events:none;
    }

    .co-hint{
      display:flex; gap:.45rem; align-items:center;
      margin-top:.45rem;
      font-weight:750;
      color: var(--mut);
      font-size:.86rem;
    }
    .co-hint-ic{ opacity:.9; }

    .co-info{
      margin-top:.7rem;
      display:flex;
      flex-direction:column;
      gap:.55rem;
      padding:.7rem;
      border-radius: 14px;
      border:1px solid rgba(37,99,235,.18);
      background: rgba(37,99,235,.06);
    }
    .co-info-row{
      display:flex;
      gap:.55rem;
      align-items:center;
    }
    .co-info-ic{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid; place-items:center;
      background:#fff;
      border:1px solid rgba(15,23,42,.10);
    }
    .co-info-row small{ display:block; color: var(--mut); font-weight:800; font-size:.78rem; }
    .co-info-row strong{ color: var(--k); font-weight:950; font-size:.92rem; }

    .co-input{
      width:100%;
      padding:.7rem .75rem;
      border-radius:14px;
      border:1px solid rgba(15,23,42,.14);
      outline:none;
      font-weight:800;
      color: var(--k);
      background:#fff;
    }
    .co-input::placeholder{ color: rgba(100,116,139,.9); font-weight:750; }
    .co-input:focus{
      border-color: rgba(124,58,237,.55);
      box-shadow: 0 0 0 3px rgba(124,58,237,.14);
    }
    .co-mini{ margin-top:.35rem; font-size:.78rem; color: var(--mut); font-weight:700; }

    /* ===== Cart items ===== */
    .co-cart{ display:flex; flex-direction:column; gap:.65rem; }
    .co-item{
      display:grid;
      grid-template-columns: 72px 1fr;
      gap:.6rem;
      padding:.6rem;
      border-radius: 16px;
      border:1px solid rgba(124,58,237,.16);
      background: rgba(124,58,237,.05);
    }
    .co-item-img{ width:72px; height:72px; border-radius:14px; overflow:hidden; background:#fff; border:1px solid rgba(15,23,42,.10); }
    .co-img{ width:100%; height:100%; object-fit:cover; display:block; }
    .co-item-top{ display:flex; align-items:flex-start; justify-content:space-between; gap:.45rem; }
    .co-item-name{ margin:0; font-size:.92rem; font-weight:950; color: var(--k); line-height:1.2; }
    .co-x{
      border:1px solid rgba(15,23,42,.12);
      background:#fff;
      color: rgba(15,23,42,.72);
      width:32px; height:32px;
      border-radius: 12px;
      cursor:pointer;
      font-size:1.15rem;
      line-height:1;
      font-weight:950;
    }
    .co-x:hover{ border-color: rgba(239,68,68,.45); color:#ef4444; background: rgba(239,68,68,.06); }

    .co-item-variants{
      margin-top:.25rem;
      font-size:.78rem;
      color: var(--mut);
      font-weight:750;
    }

    .co-item-bot{
      margin-top:.5rem;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:.6rem;
      flex-wrap:wrap;
    }
    .co-qty{
      display:flex; align-items:center; gap:.35rem;
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      padding:.25rem;
      border-radius: 14px;
    }
    .co-qty-btn{
      width:30px; height:30px;
      border-radius: 12px;
      border:0;
      background: rgba(37,99,235,.10);
      color: var(--b);
      font-weight:950;
      cursor:pointer;
    }
    .co-qty-btn:hover{ filter:brightness(.96); }
    .co-qty-val{ min-width:24px; text-align:center; font-weight:950; color: var(--k); }

    .co-item-price{ text-align:right; }
    .co-price-val{ display:block; font-weight:950; color: var(--k); }
    .co-item-price small{ color: var(--mut); font-weight:800; }

    /* ===== Summary ===== */
    .co-sum{ display:flex; flex-direction:column; gap:.55rem; }
    .co-sum-row{ display:flex; align-items:center; justify-content:space-between; gap:.75rem; color: var(--k); font-weight:850; }
    .co-sum-row span{ color: var(--mut); font-weight:850; }
    .co-sum-rule{ height:1px; background: rgba(15,23,42,.12); margin:.35rem 0; }
    .co-sum-total{
      display:flex; align-items:center; justify-content:space-between;
      padding:.6rem .65rem;
      border-radius: 16px;
      background: rgba(34,197,94,.10);
      border:1px solid rgba(34,197,94,.22);
    }
    .co-sum-total span{ font-weight:950; color: var(--k); }
    .co-sum-total strong{ font-weight:990; color: var(--g); font-size:1.05rem; }
    .co-note{ display:flex; gap:.45rem; align-items:flex-start; color: var(--mut); font-weight:800; font-size:.82rem; margin-top:.2rem; }

    /* ===== PayPal ===== */
    .co-payhead{ display:flex; align-items:center; justify-content:space-between; gap:.6rem; margin-bottom:.6rem; }
    .co-paytitle{ font-weight:990; color: var(--k); }
    .co-paymuted{ font-size:.82rem; color: var(--mut); font-weight:750; }

    .co-paybox{
      position:relative;
      border-radius: 16px;
      border:1px solid rgba(15,23,42,.12);
      background: rgba(15,23,42,.02);
      padding:.7rem;
      min-height: 170px;
      overflow:hidden;
    }

    .co-guard{
      position:absolute;
      inset:0;
      background: rgba(255,255,255,.88);
      backdrop-filter: blur(4px);
      display:flex;
      flex-direction:column;
      gap:.55rem;
      align-items:center;
      justify-content:center;
      z-index: 10;
      text-align:center;
      padding: 1rem;
      font-weight:900;
      color: var(--k);
    }
    .co-guard p{ margin:0; font-size:.9rem; }

    .co-pp{ min-height: 50px; }

    .co-paynote{
      margin-top:.7rem;
      border-radius: 16px;
      border:1px solid rgba(124,58,237,.18);
      background: rgba(124,58,237,.06);
      padding:.7rem;
      display:flex;
      flex-direction:column;
      gap:.45rem;
    }
    .co-paynote-row{
      display:flex;
      gap:.45rem;
      align-items:center;
      color: var(--k);
      font-weight:850;
      font-size:.86rem;
    }
    .co-paynote-row .ok{ color: var(--g); font-weight:990; }

    /* ===== Trust ===== */
    .co-trust{
      display:flex;
      gap:.5rem;
      flex-wrap:wrap;
      justify-content:space-between;
    }
    .co-trust-item{
      flex:1 1 90px;
      display:flex; align-items:center; justify-content:center; gap:.4rem;
      padding:.55rem .6rem;
      border-radius: 14px;
      background:#fff;
      border:1px solid rgba(15,23,42,.12);
      box-shadow: 0 6px 16px rgba(15,23,42,.07);
      font-weight:950;
      color: var(--k);
      font-size:.85rem;
    }

    /* ===== Toast ===== */
    .co-toast{
      position: fixed;
      right: 12px;
      bottom: 12px;
      z-index: 999;
      background: var(--k);
      color:#fff;
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding:.6rem .75rem;
    }
    .co-toast-inner{ display:flex; align-items:center; gap:.5rem; }
    .co-toast-icon{ font-weight:950; }
    .co-toast-message{ font-weight:850; font-size:.9rem; }

    /* ===== Mobile tweaks (Hisense friendly) ===== */
    @media(max-width: 480px){
      .co-page{ padding:.6rem; }
      .co-hero{ padding:.75rem; }
      .co-title{ font-size: 1.05rem; }
      .co-subtitle{ font-size:.86rem; }
      .co-steps{ grid-template-columns: repeat(2, 1fr); }
      .co-card-h{ padding:.7rem .75rem; }
      .co-card-b{ padding:.75rem; }
      .co-item{ grid-template-columns: 64px 1fr; }
      .co-item-img{ width:64px; height:64px; }
    }

    /* ===== Collapsible shipping card ===== */
    .co-collapse > summary{
      list-style: none;
      cursor: pointer;
      user-select: none;
    }
    .co-collapse > summary::-webkit-details-marker{ display:none; }

    .co-collapse-title h2{ margin:0; }
    .co-collapse-title{ display:flex; flex-direction:column; gap:.1rem; }
    .co-collapse-summary{
      font-size:.78rem;
      font-weight:850;
      color: rgba(15,23,42,.65);
    }

    .co-collapse-right{
      display:flex;
      align-items:center;
      gap:.55rem;
    }

    .co-collapse-caret{
      display:inline-block;
      transition: transform .18s ease;
      opacity:.85;
      font-weight:950;
    }
    .co-collapse[open] .co-collapse-caret{ transform: rotate(180deg); }
  </style>

  <script nonce="<%= CO_NONCE %>">
    (function(){
      const el = {
        cartState: document.getElementById('cart-state'),
        cartItems: document.getElementById('cart-items'),
        cartEmpty: document.getElementById('cart-empty'),

        shipDone: document.getElementById('ship-done'),
        shipEdit: document.getElementById('ship-edit'),

        deliverySelect: document.getElementById('delivery-select'),
        deliveryHint: document.getElementById('delivery-hint'),
        deliveryInfo: document.getElementById('delivery-info'),
        deliveryType: document.getElementById('delivery-type'),
        deliveryEstimate: document.getElementById('delivery-estimate'),
        deliveryArea: document.getElementById('delivery-area'),

        shipHint: document.getElementById('ship-hint'),
        shipName: document.getElementById('ship-name'),
        shipPhone: document.getElementById('ship-phone'),
        shipEmail: document.getElementById('ship-email'),
        shipLine1: document.getElementById('ship-line1'),
        shipLine2: document.getElementById('ship-line2'),
        shipCity: document.getElementById('ship-city'),
        shipState: document.getElementById('ship-state'),
        shipZip: document.getElementById('ship-zip'),
        shipDetails: document.getElementById('ship-details'),
        shipSummary: document.getElementById('ship-summary'),
        shipCountry: document.getElementById('ship-country'),
        shipCountrySearch: document.getElementById('ship-country-search'),

        ratesRetry: document.getElementById('rates-retry'),
        ratesDebug: document.getElementById('rates-debug'),

        sumSubtotal: document.getElementById('sum-subtotal'),
        sumVat: document.getElementById('sum-vat'),
        sumShipping: document.getElementById('sum-shipping'),
        sumTotal: document.getElementById('sum-total'),
        vatRate: document.getElementById('vat-rate'),

        payGuard: document.getElementById('pay-guard'),
        ppMount: document.getElementById('paypal-buttons'),

        toast: document.getElementById('toast'),
        toastIcon: document.querySelector('.co-toast-icon'),
        toastMessage: document.querySelector('.co-toast-message'),

        tplRow: document.getElementById('tpl-cart-row'),
      };

      const configEl = document.getElementById('checkout-config');
      let cfg = {};
      try { cfg = JSON.parse(configEl ? configEl.textContent : '{}'); } catch (_) { cfg = {}; }

      const VAT_RATE = Number(cfg.VAT_RATE || 0);
      const CURRENCY = String(cfg.CURRENCY || 'USD');

      // ===== Hardcoded ISO-3166-1 alpha-2 (195 countries: 193 UN members + Vatican City + Palestine) =====
      const COUNTRIES = [
        { code:'AF', name:'Afghanistan' },
        { code:'AL', name:'Albania' },
        { code:'DZ', name:'Algeria' },
        { code:'AD', name:'Andorra' },
        { code:'AO', name:'Angola' },
        { code:'AG', name:'Antigua and Barbuda' },
        { code:'AR', name:'Argentina' },
        { code:'AM', name:'Armenia' },
        { code:'AU', name:'Australia' },
        { code:'AT', name:'Austria' },
        { code:'AZ', name:'Azerbaijan' },
        { code:'BS', name:'Bahamas' },
        { code:'BH', name:'Bahrain' },
        { code:'BD', name:'Bangladesh' },
        { code:'BB', name:'Barbados' },
        { code:'BY', name:'Belarus' },
        { code:'BE', name:'Belgium' },
        { code:'BZ', name:'Belize' },
        { code:'BJ', name:'Benin' },
        { code:'BT', name:'Bhutan' },
        { code:'BO', name:'Bolivia' },
        { code:'BA', name:'Bosnia and Herzegovina' },
        { code:'BW', name:'Botswana' },
        { code:'BR', name:'Brazil' },
        { code:'BN', name:'Brunei' },
        { code:'BG', name:'Bulgaria' },
        { code:'BF', name:'Burkina Faso' },
        { code:'BI', name:'Burundi' },
        { code:'CV', name:'Cabo Verde' },
        { code:'KH', name:'Cambodia' },
        { code:'CM', name:'Cameroon' },
        { code:'CA', name:'Canada' },
        { code:'CF', name:'Central African Republic' },
        { code:'TD', name:'Chad' },
        { code:'CL', name:'Chile' },
        { code:'CN', name:'China' },
        { code:'CO', name:'Colombia' },
        { code:'KM', name:'Comoros' },
        { code:'CG', name:'Congo (Congo-Brazzaville)' },
        { code:'CD', name:'Congo (DRC)' },
        { code:'CR', name:'Costa Rica' },
        { code:'CI', name:"Cote d'Ivoire" },
        { code:'HR', name:'Croatia' },
        { code:'CU', name:'Cuba' },
        { code:'CY', name:'Cyprus' },
        { code:'CZ', name:'Czechia' },
        { code:'DK', name:'Denmark' },
        { code:'DJ', name:'Djibouti' },
        { code:'DM', name:'Dominica' },
        { code:'DO', name:'Dominican Republic' },
        { code:'EC', name:'Ecuador' },
        { code:'EG', name:'Egypt' },
        { code:'SV', name:'El Salvador' },
        { code:'GQ', name:'Equatorial Guinea' },
        { code:'ER', name:'Eritrea' },
        { code:'EE', name:'Estonia' },
        { code:'SZ', name:'Eswatini' },
        { code:'ET', name:'Ethiopia' },
        { code:'FJ', name:'Fiji' },
        { code:'FI', name:'Finland' },
        { code:'FR', name:'France' },
        { code:'GA', name:'Gabon' },
        { code:'GM', name:'Gambia' },
        { code:'GE', name:'Georgia' },
        { code:'DE', name:'Germany' },
        { code:'GH', name:'Ghana' },
        { code:'GR', name:'Greece' },
        { code:'GD', name:'Grenada' },
        { code:'GT', name:'Guatemala' },
        { code:'GN', name:'Guinea' },
        { code:'GW', name:'Guinea-Bissau' },
        { code:'GY', name:'Guyana' },
        { code:'HT', name:'Haiti' },
        { code:'HN', name:'Honduras' },
        { code:'HU', name:'Hungary' },
        { code:'IS', name:'Iceland' },
        { code:'IN', name:'India' },
        { code:'ID', name:'Indonesia' },
        { code:'IR', name:'Iran' },
        { code:'IQ', name:'Iraq' },
        { code:'IE', name:'Ireland' },
        { code:'IL', name:'Israel' },
        { code:'IT', name:'Italy' },
        { code:'JM', name:'Jamaica' },
        { code:'JP', name:'Japan' },
        { code:'JO', name:'Jordan' },
        { code:'KZ', name:'Kazakhstan' },
        { code:'KE', name:'Kenya' },
        { code:'KI', name:'Kiribati' },
        { code:'KW', name:'Kuwait' },
        { code:'KG', name:'Kyrgyzstan' },
        { code:'LA', name:'Laos' },
        { code:'LV', name:'Latvia' },
        { code:'LB', name:'Lebanon' },
        { code:'LS', name:'Lesotho' },
        { code:'LR', name:'Liberia' },
        { code:'LY', name:'Libya' },
        { code:'LI', name:'Liechtenstein' },
        { code:'LT', name:'Lithuania' },
        { code:'LU', name:'Luxembourg' },
        { code:'MG', name:'Madagascar' },
        { code:'MW', name:'Malawi' },
        { code:'MY', name:'Malaysia' },
        { code:'MV', name:'Maldives' },
        { code:'ML', name:'Mali' },
        { code:'MT', name:'Malta' },
        { code:'MH', name:'Marshall Islands' },
        { code:'MR', name:'Mauritania' },
        { code:'MU', name:'Mauritius' },
        { code:'MX', name:'Mexico' },
        { code:'FM', name:'Micronesia' },
        { code:'MD', name:'Moldova' },
        { code:'MC', name:'Monaco' },
        { code:'MN', name:'Mongolia' },
        { code:'ME', name:'Montenegro' },
        { code:'MA', name:'Morocco' },
        { code:'MZ', name:'Mozambique' },
        { code:'MM', name:'Myanmar' },
        { code:'NA', name:'Namibia' },
        { code:'NR', name:'Nauru' },
        { code:'NP', name:'Nepal' },
        { code:'NL', name:'Netherlands' },
        { code:'NZ', name:'New Zealand' },
        { code:'NI', name:'Nicaragua' },
        { code:'NE', name:'Niger' },
        { code:'NG', name:'Nigeria' },
        { code:'KP', name:'North Korea' },
        { code:'MK', name:'North Macedonia' },
        { code:'NO', name:'Norway' },
        { code:'OM', name:'Oman' },
        { code:'PK', name:'Pakistan' },
        { code:'PW', name:'Palau' },
        { code:'PS', name:'Palestine' },
        { code:'PA', name:'Panama' },
        { code:'PG', name:'Papua New Guinea' },
        { code:'PY', name:'Paraguay' },
        { code:'PE', name:'Peru' },
        { code:'PH', name:'Philippines' },
        { code:'PL', name:'Poland' },
        { code:'PT', name:'Portugal' },
        { code:'QA', name:'Qatar' },
        { code:'RO', name:'Romania' },
        { code:'RU', name:'Russia' },
        { code:'RW', name:'Rwanda' },
        { code:'KN', name:'Saint Kitts and Nevis' },
        { code:'LC', name:'Saint Lucia' },
        { code:'VC', name:'Saint Vincent and the Grenadines' },
        { code:'WS', name:'Samoa' },
        { code:'SM', name:'San Marino' },
        { code:'ST', name:'Sao Tome and Principe' },
        { code:'SA', name:'Saudi Arabia' },
        { code:'SN', name:'Senegal' },
        { code:'RS', name:'Serbia' },
        { code:'SC', name:'Seychelles' },
        { code:'SL', name:'Sierra Leone' },
        { code:'SG', name:'Singapore' },
        { code:'SK', name:'Slovakia' },
        { code:'SI', name:'Slovenia' },
        { code:'SB', name:'Solomon Islands' },
        { code:'SO', name:'Somalia' },
        { code:'ZA', name:'South Africa' },
        { code:'KR', name:'South Korea' },
        { code:'SS', name:'South Sudan' },
        { code:'ES', name:'Spain' },
        { code:'LK', name:'Sri Lanka' },
        { code:'SD', name:'Sudan' },
        { code:'SR', name:'Suriname' },
        { code:'SE', name:'Sweden' },
        { code:'CH', name:'Switzerland' },
        { code:'SY', name:'Syria' },
        { code:'TJ', name:'Tajikistan' },
        { code:'TZ', name:'Tanzania' },
        { code:'TH', name:'Thailand' },
        { code:'TL', name:'Timor-Leste' },
        { code:'TG', name:'Togo' },
        { code:'TO', name:'Tonga' },
        { code:'TT', name:'Trinidad and Tobago' },
        { code:'TN', name:'Tunisia' },
        { code:'TR', name:'Turkey' },
        { code:'TM', name:'Turkmenistan' },
        { code:'TV', name:'Tuvalu' },
        { code:'UG', name:'Uganda' },
        { code:'UA', name:'Ukraine' },
        { code:'AE', name:'United Arab Emirates' },
        { code:'GB', name:'United Kingdom' },
        { code:'US', name:'United States' },
        { code:'UY', name:'Uruguay' },
        { code:'UZ', name:'Uzbekistan' },
        { code:'VU', name:'Vanuatu' },
        { code:'VA', name:'Vatican City' },
        { code:'VE', name:'Venezuela' },
        { code:'VN', name:'Vietnam' },
        { code:'YE', name:'Yemen' },
        { code:'ZM', name:'Zambia' },
        { code:'ZW', name:'Zimbabwe' }
      ];

      function buildCountrySelect(term = '', keepCode = 'ZA'){
        if (!el.shipCountry) return;

        const q = String(term || '').trim().toLowerCase();
        const current = String(el.shipCountry.value || keepCode || 'ZA').toUpperCase();

        const matches = !q
          ? COUNTRIES
          : COUNTRIES.filter(c =>
              c.name.toLowerCase().includes(q) || c.code.toLowerCase().includes(q)
            );

        const list = matches.length ? matches : COUNTRIES;

        el.shipCountry.innerHTML = '';
        for (const c of list){
          const opt = document.createElement('option');
          opt.value = c.code;
          opt.textContent = `${c.name} (${c.code})`;
          if (c.code === current) opt.selected = true;
          el.shipCountry.appendChild(opt);
        }

        // If current code is not in filtered list, select first item
        if (!Array.from(el.shipCountry.options).some(o => o.value === current)){
          el.shipCountry.selectedIndex = 0;
        }
      }

      const state = {
        items: [],
        selectedDelivery: null,
        deliveryReady: false,     // ‚úÖ means Shippo rates loaded + selection applied
        shipTo: null,
        addressReady: false,
        cartReady: false,
        paypalMounted: false,
        shippoShipmentId: null,
        quoteInFlight: false,
      };

      function formatCurrency(amount, currency = CURRENCY){
        const symbols = { USD:'$', ZAR:'R', EUR:'‚Ç¨', GBP:'¬£', AUD:'A$', CAD:'C$' };
        const sym = symbols[String(currency||'').toUpperCase()] || (currency + ' ');
        return sym + Number(amount||0).toFixed(2);
      }

      function showToast(message, type='info'){
        const icons = { success:'‚úì', error:'!', warning:'‚ö†', info:'üí°' };
        if (el.toastIcon) el.toastIcon.textContent = icons[type] || icons.info;
        if (el.toastMessage) el.toastMessage.textContent = message || '';
        if (el.toast) el.toast.hidden = false;

        clearTimeout(el.toast && el.toast._t);
        if (el.toast){
          el.toast._t = setTimeout(()=>{ el.toast.hidden = true; }, 2800);
        }
      }

      window.addEventListener('error', (e) => {
        const msg = (e?.error?.message || e?.message || 'Script error');
        console.error('Global error:', e);
        showToast(msg, 'error');
        if (el.deliveryHint) {
          el.deliveryHint.innerHTML = `<span class="co-hint-ic">‚ùå</span><span>${msg}</span>`;
        }
      });

      window.addEventListener('unhandledrejection', (e) => {
        const msg = (e?.reason?.message || String(e?.reason || 'Promise error'));
        console.error('Unhandled rejection:', e);
        showToast(msg, 'error');
        if (el.deliveryHint) {
          el.deliveryHint.innerHTML = `<span class="co-hint-ic">‚ùå</span><span>${msg}</span>`;
        }
      });

      function readShipTo(){
        const v = (x) => String(x || '').trim();

        return {
          name: v(el.shipName && el.shipName.value),
          phone: v(el.shipPhone && el.shipPhone.value),
          email: v(el.shipEmail && el.shipEmail.value),
          street1: v(el.shipLine1 && el.shipLine1.value),
          street2: v(el.shipLine2 && el.shipLine2.value),
          city: v(el.shipCity && el.shipCity.value),
          state: v(el.shipState && el.shipState.value),
          zip: v(el.shipZip && el.shipZip.value),
          country: v(el.shipCountry && el.shipCountry.value) || 'ZA',
          is_residential: true
        };
      }

      function validateShipTo(to){
        if (!to.name) return { ok:false, message:'Enter full name.' };
        if (!to.phone) return { ok:false, message:'Enter phone number.' };
        if (!to.street1) return { ok:false, message:'Enter address line 1.' };
        if (!to.city) return { ok:false, message:'Enter city.' };
        if (!to.state) return { ok:false, message:'Enter province/state.' };
        if (!to.zip) return { ok:false, message:'Enter postal code.' };
        if (!to.country) return { ok:false, message:'Select country.' };
        return { ok:true, message:'Shipping address OK.' };
      }

      function onAddressChange(){
        const to = readShipTo();
        const v = validateShipTo(to);

        state.shipTo = to;
        state.addressReady = v.ok;

        // Update collapsible header summary + auto-collapse when valid
        if (el.shipSummary){
          if (v.ok){
            const short = `${to.name} ‚Äî ${to.city}, ${to.country}`;
            el.shipSummary.textContent = short;
          } else {
            el.shipSummary.textContent = 'Not completed yet';
          }
        }

        if (el.shipHint){
          el.shipHint.textContent = v.ok ? '‚úÖ Shipping address OK.' : ('‚ö†Ô∏è ' + v.message);
        }

        // ‚úÖ Re-quote Shippo rates after user edits address (debounced)
        clearTimeout(_shippoQuoteTimer);
        _shippoQuoteTimer = setTimeout(() => {
          if (state.addressReady && state.cartReady && state.items.length) loadDeliveryOptions();
        }, 650);

        maybeEnablePayment();
      }

      function calculateTotals(){
        // ‚úÖ item.price is VAT-INCLUSIVE (gross) from the cart
        const itemsGross = state.items.reduce(
          (sum, it) => sum + (Number(it.price) * Number(it.quantity)),
          0
        );

        // Extract VAT portion from the gross total (NOT added on top)
        const itemsNet = (VAT_RATE > 0) ? (itemsGross / (1 + VAT_RATE)) : itemsGross;
        const vat = itemsGross - itemsNet;

        // ‚úÖ Shippo-only: no fallback shipping
        const shipping = state.selectedDelivery
          ? Number(state.selectedDelivery.price || 0)
          : 0;

        // ‚úÖ total payable = gross items + shipping (VAT already included)
        const total = itemsGross + shipping;

        return { subtotal: itemsGross, vat, shipping, total };
      }

      function updateSummary(){
        const t = calculateTotals();
        el.sumSubtotal.textContent = formatCurrency(t.subtotal);
        el.sumVat.textContent = formatCurrency(t.vat);
        const shipCcy = state.selectedDelivery?.currency || CURRENCY;
        el.sumShipping.textContent = formatCurrency(t.shipping, shipCcy);
        el.sumTotal.textContent = formatCurrency(t.total);
        el.vatRate.textContent = (VAT_RATE * 100).toFixed(0);
      }

      function blockPayment(message){
        if (!el.payGuard) return;
        el.payGuard.style.display = 'flex';
        const p = el.payGuard.querySelector('p');
        if (p) p.textContent = message || 'Waiting for cart & Shippo rates‚Ä¶';
      }
      function allowPayment(){
        if (!el.payGuard) return;
        el.payGuard.style.display = 'none';
      }

      let _ppRetryTimer = null;

      function maybeEnablePayment(){
        const ready =
          state.cartReady &&
          state.deliveryReady &&
          state.addressReady &&
          state.items.length > 0;

        if (!ready){
          const msg =
            !state.items.length ? 'Your cart is empty.' :
            !state.cartReady ? 'Loading cart‚Ä¶' :
            !state.addressReady ? 'Please enter your shipping address.' :
            !state.deliveryReady ? 'Loading Shippo rates‚Ä¶' :
            'Waiting‚Ä¶';

          blockPayment(msg);
          return;
        }

        // ‚úÖ Don‚Äôt drop the guard until PayPal SDK exists
        if (!window.paypal){
          blockPayment('Loading PayPal‚Ä¶');

          if (!_ppRetryTimer){
            _ppRetryTimer = setInterval(() => {
              if (window.paypal){
                clearInterval(_ppRetryTimer);
                _ppRetryTimer = null;
                maybeEnablePayment(); // re-run now that SDK is ready
              }
            }, 300);

            // safety stop after 10s
            setTimeout(() => {
              if (_ppRetryTimer){
                clearInterval(_ppRetryTimer);
                _ppRetryTimer = null;
                blockPayment('PayPal failed to load. Please refresh the page.');
              }
            }, 10000);
          }
          return;
        }

        allowPayment();
        maybeMountPayPal();
      }

      let _shippoQuoteTimer = null;

      async function loadDeliveryOptions(){
        // ‚úÖ prevent duplicate overlapping calls
        if (state.quoteInFlight) return;
        state.quoteInFlight = true;
        state.deliveryReady = false;

        // UI: start loading
        el.deliverySelect.disabled = true;
        el.deliverySelect.innerHTML = '<option value="">Loading options‚Ä¶</option>';
        el.deliveryHint.innerHTML = '<span class="co-hint-ic">‚è±Ô∏è</span><span>Loading live Shippo rates‚Ä¶</span>';
        el.deliveryInfo.style.display = 'none';
        if (el.ratesDebug) el.ratesDebug.textContent = 'Requesting Shippo‚Ä¶';

        // ‚úÖ Hard timeout guard (works even if AbortController fails)
        const HARD_TIMEOUT_MS = 20000;

        function hardTimeout(promise, ms){
          let t;
          const timeout = new Promise((_, rej) => {
            t = setTimeout(() => rej(new Error('TIMEOUT')), ms);
          });
          return Promise.race([promise, timeout]).finally(() => clearTimeout(t));
        }

        try {
          if (!state.addressReady) {
            el.deliveryHint.innerHTML = '<span class="co-hint-ic">üìç</span><span>Enter your shipping address to load rates.</span>';
            if (el.ratesDebug) el.ratesDebug.textContent = 'Address incomplete';
            blockPayment('Please enter your shipping address.');
            return;
          }

          if (!state.cartReady || !state.items.length) {
            el.deliveryHint.innerHTML = '<span class="co-hint-ic">üõí</span><span>Loading your cart‚Ä¶</span>';
            if (el.ratesDebug) el.ratesDebug.textContent = 'Cart not ready';
            blockPayment('Loading cart‚Ä¶');
            return;
          }

          // Always send the latest shipTo values
          const body = { shipTo: readShipTo() };

          // AbortController (nice-to-have) + hard timeout (must-have)
          const ac = ('AbortController' in window) ? new AbortController() : null;
          const abortTimer = ac ? setTimeout(() => { try { ac.abort(); } catch {} }, HARD_TIMEOUT_MS) : null;

          const doFetch = async () => {
            const r = await fetch('/payment/shippo/quote', {
              method:'POST',
              headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
              credentials:'same-origin',
              body: JSON.stringify(body),
              signal: ac ? ac.signal : undefined
            });

            // Read as text first (prevents ‚Äústuck‚Äù json parsing on weird responses)
            const text = await r.text();
            let data = {};
            try { data = text ? JSON.parse(text) : {}; } catch { data = { ok:false, message:'Invalid JSON from server', _raw:text }; }

            return { r, data };
          };

          const { r, data } = await hardTimeout(doFetch(), HARD_TIMEOUT_MS + 500);

          if (abortTimer) clearTimeout(abortTimer);

          if (!r.ok || !data.ok || !data.shipmentId || !Array.isArray(data.rates)) {
            throw new Error(data.message || `Failed to load Shippo rates (HTTP ${r.status})`);
          }

          state.shippoShipmentId = String(data.shipmentId);
          const rates = data.rates;

          if (!rates.length){
            el.deliveryHint.innerHTML = '<span class="co-hint-ic">‚ö†Ô∏è</span><span>No shipping rates available</span>';
            if (el.ratesDebug) el.ratesDebug.textContent = 'No rates returned';
            state.deliveryReady = false;
            blockPayment('No shipping rates available.');
            return;
          }

          el.deliverySelect.innerHTML = '';

          rates.forEach((rt) => {
            const price = Number(rt.amount || 0);
            const days = (rt.days == null) ? 0 : Number(rt.days);
            const provider = rt.provider || 'Carrier';
            const service = rt.service || 'Service';
            const rateCcy = String(rt.currency || CURRENCY).toUpperCase();

            const op = document.createElement('option');
            op.value = String(rt.rateId);

            op.dataset.price = String(price);
            op.dataset.days = String(days);
            op.dataset.type = `${provider} ${service}`.trim();
            op.dataset.area = `Shippo (${rateCcy})`;
            op.dataset.currency = rateCcy;
            op.dataset.shipmentId = state.shippoShipmentId;

            op.textContent = `${provider} ${service} ‚Äî ${formatCurrency(price, rateCcy)}${days ? ` (~${days}d)` : ''}`;

            el.deliverySelect.appendChild(op);
          });

          el.deliverySelect.disabled = false;
          el.deliverySelect.selectedIndex = 0;

          state.deliveryReady = true;
          applyDeliverySelection();
          if (el.ratesDebug) el.ratesDebug.textContent = data.cached ? 'Loaded (cached)' : 'Loaded';
          maybeEnablePayment();

        } catch (err) {
          console.error(err);

          const msg =
            (err?.message === 'TIMEOUT')
              ? 'Shipping quote timed out. Please retry.'
              : (err?.name === 'AbortError')
                ? 'Shipping quote timed out. Please retry.'
                : (err?.message || 'Could not load live Shippo rates');

          el.deliveryHint.innerHTML = `<span class="co-hint-ic">‚ùå</span><span>${msg}</span>`;
          if (el.ratesDebug) el.ratesDebug.textContent = 'Failed';
          state.deliveryReady = false;
          blockPayment(msg);

        } finally {
          state.quoteInFlight = false;
        }
      }

      function applyDeliverySelection(){
        const opt = el.deliverySelect.options[el.deliverySelect.selectedIndex];
        if (!opt) return;

        state.selectedDelivery = {
          // ‚úÖ For Shippo: opt.value = rateId
          id: opt.value,
          price: Number(opt.dataset.price || 0),
          days: Number(opt.dataset.days || 0),
          type: opt.dataset.type || 'Standard',
          area: opt.dataset.area || 'Nationwide',

          // ‚úÖ NEW: keep currency on the selected delivery
          currency: String(opt.dataset.currency || CURRENCY).toUpperCase(),

          // ‚úÖ Shippo linkage
          shippoRateId: opt.value,
          shippoShipmentId: opt.dataset.shipmentId || state.shippoShipmentId || null
        };

        el.deliveryType.textContent = state.selectedDelivery.type;
        el.deliveryEstimate.textContent = state.selectedDelivery.days
          ? `~${state.selectedDelivery.days} day${state.selectedDelivery.days === 1 ? '' : 's'}`
          : 'Contact for estimate';
        el.deliveryArea.textContent = state.selectedDelivery.area;

        el.deliveryInfo.style.display = 'flex';
        el.deliveryHint.innerHTML = '<span class="co-hint-ic">üì¶</span><span>Delivery selected</span>';

        updateSummary();
        maybeEnablePayment();
      }

      async function loadCart(){
        try{
          const r = await fetch('/api/cart', {
            headers: { 'Accept':'application/json' },
            credentials: 'same-origin'
          });

          const data = await r.json();
          const items = Array.isArray(data.items) ? data.items : [];

          state.items = items.map(item=>{
            const variantsObj = (item.variants && typeof item.variants === 'object') ? item.variants : {};
            const size  = item.size  || item.variantSize  || variantsObj.size  || '';
            const color = item.color || item.variantColor || variantsObj.color || '';

            const label = [
              size  ? `Size: ${size}`   : '',
              color ? `Color: ${color}` : ''
            ].filter(Boolean).join(' ‚Ä¢ ');

            return {
              id: String(item.productId || item._id || item.id),
              productId: String(item.productId || item._id || item.id),
              name: item.name || item.title || 'Product',
              price: Number(item.price || 0),
              quantity: Number(item.quantity || item.qty || 1),
              imageUrl: item.imageUrl || item.image || '',
              variants: { size, color, label }
            };
          });

          renderCart();
          state.cartReady = true;
          maybeEnablePayment();

          // ‚úÖ If address is already valid (autofill / user already typed), quote now
          if (state.addressReady && state.items.length) {
            loadDeliveryOptions();
          } else {
            // keep UI honest
            el.deliveryHint.innerHTML = '<span class="co-hint-ic">üìç</span><span>Enter your shipping address to load rates.</span>';
          }
        } catch (err){
          console.error(err);
          el.cartState.innerHTML = '<span>‚ö†Ô∏è Could not load your cart. Refresh the page.</span>';
          state.cartReady = false;
          blockPayment('Could not load cart.');
        }
      }

      function renderCart(){
        if (!state.items.length){
          el.cartState.style.display = 'none';
          el.cartItems.style.display = 'none';
          el.cartEmpty.style.display = 'block';
          updateSummary();
          return;
        }

        el.cartState.style.display = 'none';
        el.cartEmpty.style.display = 'none';
        el.cartItems.style.display = 'flex';
        el.cartItems.innerHTML = '';

        state.items.forEach(item=>{
          const row = createCartRow(item);
          el.cartItems.appendChild(row);
        });

        updateSummary();
      }

      function createCartRow(item){
        const tpl = el.tplRow.content.cloneNode(true);
        const root = tpl.querySelector('.co-item');
        root.dataset.id = item.id;

        const img = root.querySelector('.co-img');
        img.src = item.imageUrl || '/img/placeholder.png';
        img.alt = item.name;

        root.querySelector('.co-item-name').textContent = item.name;

        const variantsEl = root.querySelector('.co-item-variants');
        variantsEl.textContent = (item.variants && item.variants.label) ? item.variants.label : '';

        root.querySelector('.co-qty-val').textContent = String(item.quantity);

        // ‚úÖ Show row TOTAL because UI says "total"
        const rowTotal = Number(item.price || 0) * Number(item.quantity || 0);
        root.querySelector('.co-price-val').textContent = formatCurrency(rowTotal);

        const dec = root.querySelector('.co-dec');
        const inc = root.querySelector('.co-inc');
        const rm  = root.querySelector('.co-x');

        dec.addEventListener('click', ()=> updateQuantity(item.id, item.quantity - 1));
        inc.addEventListener('click', ()=> updateQuantity(item.id, item.quantity + 1));
        rm.addEventListener('click',  ()=> removeItem(item.id));

        return root;
      }

      async function updateQuantity(productId, quantity){
        if (quantity < 1){
          await removeItem(productId);
          return;
        }
        try{
          const r = await fetch(`/api/cart/item/${encodeURIComponent(productId)}`, {
            method:'PATCH',
            headers:{ 'Content-Type':'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ quantity })
          });
          if (!r.ok) throw new Error('Failed to update quantity');
          await loadCart();
          showToast('Quantity updated', 'success');
        } catch (err){
          console.error(err);
          showToast('Failed to update quantity', 'error');
        }
      }

      async function removeItem(productId){
        try{
          const r = await fetch(`/api/cart/item/${encodeURIComponent(productId)}`, {
            method:'DELETE',
            credentials: 'same-origin'
          });
          if (!r.ok) throw new Error('Failed to remove item');
          await loadCart();
          showToast('Item removed', 'success');
        } catch (err){
          console.error(err);
          showToast('Failed to remove item', 'error');
        }
      }

      function maybeMountPayPal(){
        if (state.paypalMounted) return;
        if (!window.paypal || !el.ppMount) return;
        if (!state.items.length || !state.selectedDelivery) return;

        state.paypalMounted = true;

        paypal.Buttons({
          style: {
            layout: 'vertical',
            shape: 'rect',
            label: 'paypal',
            color: 'blue',
            height: 48
          },

          createOrder: async function(){
            try{
              const shippoRateId = state.selectedDelivery?.shippoRateId || null;
              const shippoShipmentId = state.selectedDelivery?.shippoShipmentId || null;

              if (!shippoRateId || !shippoShipmentId) {
                showToast('Please select a delivery rate again (rates expired).', 'warning');
                await loadDeliveryOptions();
                throw new Error('Missing Shippo rate/shipment.');
              }

              // Always re-read the latest address values right before creating the order
              const shipToNow = readShipTo();
              const v = validateShipTo(shipToNow);
              if (!v.ok){
                showToast(v.message || 'Please complete your shipping address.', 'warning');
                if (el.shipDetails) el.shipDetails.open = true;
                throw new Error('Shipping address invalid.');
              }

              const body = {
                // ‚úÖ Tell backend this is the Shippo flow
                delivery: 'shippo',

                // ‚úÖ Shippo linkage (server validates this pair)
                shippoRateId,
                shippoShipmentId,

                // ‚úÖ Shipping address (server re-validates)
                shipTo: shipToNow,
                deliveryNote: (document.getElementById('delivery-note')?.value || '').trim(),

                // Optional: keep if your backend still needs it right now
                items: state.items.map(i => ({
                  productId: i.productId,
                  name: i.name,
                  quantity: i.quantity,
                  price: i.price,
                  variants: { size: i.variants?.size || '', color: i.variants?.color || '' }
                }))
              };

              const r = await fetch('/payment/create-order', {
                method:'POST',
                headers:{ 'Content-Type':'application/json', 'Accept':'application/json' },
                credentials:'same-origin',
                body: JSON.stringify(body)
              });

              const data = await r.json().catch(()=>({}));
              if (!r.ok || !data.id){
                throw new Error(data.message || `Failed to create order (HTTP ${r.status})`);
              }
              return data.id;

            } catch (err){
              showToast('Failed to create order: ' + (err?.message || 'Error'), 'error');
              throw err;
            }
          },

          onApprove: async function(data){
            try{
              const r = await fetch('/payment/capture-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({ orderID: data.orderID })
              });

              const result = await r.json().catch(()=>({}));
              if (!r.ok){
                throw new Error(result.message || `Failed to capture payment (HTTP ${r.status})`);
              }

              const orderId = result.orderId || data.orderID;
              window.location.href = `/payment/thank-you?orderId=${encodeURIComponent(orderId)}`;
            } catch (err){
              showToast('Payment error: ' + (err?.message || 'Error'), 'error');
            }
          },

          onCancel: function(){
            showToast('Payment was cancelled', 'warning');
          },

          onError: function(err){
            console.error('PayPal error:', err);
            showToast('Payment processing error. Please try again.', 'error');
          }
        }).render('#paypal-buttons');
      }
      
      function init(){
        // Build countries once at startup (default ZA)
        buildCountrySelect('', 'ZA');

        // events
        el.deliverySelect.addEventListener('change', applyDeliverySelection);
        if (el.ratesRetry){
          el.ratesRetry.addEventListener('click', async () => {
            showToast('Retrying shipping rates‚Ä¶', 'info');
            // force refresh
            state.shippoShipmentId = null;
            state.deliveryReady = false;
            state.selectedDelivery = null;
            updateSummary();
            await loadDeliveryOptions();
          });
        }

        ['input','change'].forEach(evt => {
          [el.shipName, el.shipPhone, el.shipEmail, el.shipLine1, el.shipLine2, el.shipCity, el.shipState, el.shipZip, el.shipCountry, el.shipCountrySearch]
            .filter(Boolean)
            .forEach(node => node.addEventListener(evt, onAddressChange));
        });

        if (el.shipCountrySearch){
          el.shipCountrySearch.addEventListener('input', () => {
            buildCountrySelect(el.shipCountrySearch.value, el.shipCountry?.value || 'ZA');
          });
        }

        if (el.shipDone) el.shipDone.addEventListener('click', closeAddressIfValid);

        if (el.shipEdit) {
          el.shipEdit.addEventListener('click', () => {
            if (el.shipDetails) el.shipDetails.open = true;
          });
        }

        // run once at start
        onAddressChange();

        function closeAddressIfValid(){
          // make sure latest values are read/validated
          onAddressChange();

          if (!state.addressReady){
            // keep it open so user can fix
            if (el.shipDetails) el.shipDetails.open = true;
            showToast('Please complete the required address fields.', 'warning');
            return;
          }

          // ‚úÖ valid: collapse only when user clicks Done
          if (el.shipDetails) el.shipDetails.open = false;
          showToast('Address saved.', 'success');

          // ‚úÖ load rates immediately after "Done" (clean UX)
          if (state.cartReady && state.items.length) loadDeliveryOptions();
        }

        // start
        blockPayment();
        loadCart(); // ‚úÖ cart first; address events will quote when ready
      }

      // Your page already runs scripts after load, but safe:
      if (document.readyState === 'loading'){
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

      // debug
      window.checkoutApp = { state, loadCart, loadDeliveryOptions, updateQuantity, removeItem };
    })();
  </script>
</section>
