<%
  const CO_NONCE     = typeof nonce !== 'undefined' ? nonce : '';
  const CO_CLIENT_ID = typeof paypalClientId !== 'undefined' ? paypalClientId : '';
  const CO_CCY       = typeof currency !== 'undefined' ? currency : 'USD';
  const CO_BRAND     = typeof brandName !== 'undefined' ? brandName : 'Unicoporate.com';
  const CO_VAT       = typeof vatRate !== 'undefined' ? Number(vatRate) : 0.15;
  const SHIPPING_FLAT = typeof shippingFlat !== 'undefined' ? Number(shippingFlat) : 0;
%>

<section class="checkout-page">
  <!-- Header -->
  <div class="checkout-header">
    <div class="header-content">
      <div class="breadcrumb">
        <a href="/cart" class="breadcrumb-link">Cart</a>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">Checkout</span>
      </div>
      <h1 class="checkout-title">Secure Checkout</h1>
      <p class="checkout-subtitle">Complete your purchase with confidence</p>
    </div>
    
    <div class="checkout-steps">
      <div class="step active">
        <span class="step-number">1</span>
        <span class="step-label">Cart</span>
      </div>
      <div class="step active">
        <span class="step-number">2</span>
        <span class="step-label">Details</span>
      </div>
      <div class="step current">
        <span class="step-number">3</span>
        <span class="step-label">Payment</span>
      </div>
      <div class="step">
        <span class="step-number">4</span>
        <span class="step-label">Confirmation</span>
      </div>
    </div>
  </div>

  <!-- Notifications -->
  <div class="notifications-container" id="notifications">
    <% (success || []).forEach(msg => { %>
      <div class="notification notification-success">
        <span class="notification-icon">‚úì</span>
        <span class="notification-text"><%= msg %></span>
        <button class="notification-close">&times;</button>
      </div>
    <% }) %>
    <% (error || []).forEach(msg => { %>
      <div class="notification notification-error">
        <span class="notification-icon">!</span>
        <span class="notification-text"><%= msg %></span>
        <button class="notification-close">&times;</button>
      </div>
    <% }) %>
  </div>

  <!-- Main Content -->
  <div class="checkout-content">
    <!-- Left Column - Cart & Delivery -->
    <div class="checkout-column left-column">
      <!-- Cart Summary -->
      <div class="card cart-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="card-icon">üõí</span>
            Shopping Cart
          </h2>
          <a href="/cart" class="card-action">Edit Cart</a>
        </div>
        
        <div class="card-body">
          <div id="cart-state" class="loading-state">
            <div class="loading-spinner"></div>
            <span>Loading your cart‚Ä¶</span>
          </div>

          <div id="cart-items" class="cart-items" style="display: none;">
            <!-- Cart items will be populated here -->
          </div>

          <div class="cart-empty" id="cart-empty" style="display: none;">
            <div class="empty-content">
              <span class="empty-icon">üõí</span>
              <h3>Your cart is empty</h3>
              <p>Add items to your cart to continue</p>
              <a href="/sales" class="btn btn-primary">Browse Products</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Delivery Options -->
      <div class="card delivery-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="card-icon">üöö</span>
            Delivery Options
          </h2>
          <span class="card-badge">Required</span>
        </div>
        
        <div class="card-body">
          <div class="form-group">
            <label for="delivery-select" class="form-label">
              Select delivery method
              <span class="form-required">*</span>
            </label>
            <div class="select-wrapper">
              <select id="delivery-select" class="form-select" disabled>
                <option value="">Loading options‚Ä¶</option>
              </select>
              <span class="select-arrow">‚ñº</span>
            </div>
            <div class="form-hint" id="delivery-hint">
              <span class="hint-icon">‚è±Ô∏è</span>
              <span>Loading delivery estimates‚Ä¶</span>
            </div>
          </div>

          <div class="delivery-info" id="delivery-info" style="display: none;">
            <div class="info-item">
              <span class="info-icon">üì¶</span>
              <div class="info-content">
                <span class="info-label">Delivery Type</span>
                <span class="info-value" id="delivery-type">‚Äî</span>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">‚è±Ô∏è</span>
              <div class="info-content">
                <span class="info-label">Estimated Delivery</span>
                <span class="info-value" id="delivery-estimate">‚Äî</span>
              </div>
            </div>
            <div class="info-item">
              <span class="info-icon">üìç</span>
              <div class="info-content">
                <span class="info-label">Delivery Area</span>
                <span class="info-value" id="delivery-area">‚Äî</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Order Summary & Payment -->
    <div class="checkout-column right-column">
      <!-- Order Summary -->
      <div class="card summary-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="card-icon">üßæ</span>
            Order Summary
          </h2>
        </div>
        
        <div class="card-body">
          <div class="summary-items">
            <div class="summary-item">
              <span class="item-label">Subtotal</span>
              <span class="item-value" id="sum-subtotal">‚Äî</span>
            </div>
            <div class="summary-item">
              <span class="item-label">VAT (<span id="vat-rate"><%= (CO_VAT * 100).toFixed(0) %></span>%)</span>
              <span class="item-value" id="sum-vat">‚Äî</span>
            </div>
            <div class="summary-item">
              <span class="item-label">Shipping</span>
              <span class="item-value" id="sum-shipping">‚Äî</span>
            </div>
            <div class="summary-divider"></div>
            <div class="summary-total">
              <span class="total-label">Total Amount</span>
              <span class="total-value" id="sum-total">‚Äî</span>
            </div>
            <div class="summary-note">
              <span class="note-icon">üí°</span>
              <span>All prices include VAT where applicable</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Section -->
      <div class="card payment-card">
        <div class="card-header">
          <h2 class="card-title">
            <span class="card-icon">üí≥</span>
            Secure Payment
          </h2>
          <div class="security-badge">
            <span class="security-icon">üîí</span>
            <span>Secure Payment</span>
          </div>
        </div>
        
        <div class="card-body">
          <div class="payment-methods">
            <div class="method-header">
              <h3 class="method-title">Pay with PayPal</h3>
              <div class="method-icons">
                <span class="method-icon" title="PayPal">üí≥</span>
                <span class="method-icon" title="Visa">üí≥</span>
                <span class="method-icon" title="Mastercard">üí≥</span>
                <span class="method-icon" title="American Express">üí≥</span>
              </div>
            </div>
            
            <div class="payment-content">
              <div id="pay-guard" class="payment-guard">
                <div class="guard-content">
                  <div class="loading-spinner"></div>
                  <p>Waiting for cart & delivery options‚Ä¶</p>
                </div>
              </div>
              
              <div id="paypal-buttons" class="paypal-container"></div>
              
              <div class="payment-note">
                <div class="note-item">
                  <span class="note-icon">‚úì</span>
                  <span>Secure payment processed by PayPal</span>
                </div>
                <div class="note-item">
                  <span class="note-icon">‚úì</span>
                  <span>Your financial details are protected</span>
                </div>
                <div class="note-item">
                  <span class="note-icon">‚úì</span>
                  <span>Merchant: <%= CO_BRAND %></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Trust Signals -->
      <div class="trust-signals">
        <div class="signal-item">
          <span class="signal-icon">üîí</span>
          <span class="signal-text">SSL Secure Checkout</span>
        </div>
        <div class="signal-item">
          <span class="signal-icon">üí≥</span>
          <span class="signal-text">PCI DSS Compliant</span>
        </div>
        <div class="signal-item">
          <span class="signal-icon">üîÑ</span>
          <span class="signal-text">30-Day Returns</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="checkout-footer">
    <div class="footer-content">
      <div class="footer-section">
        <h4>Need Help?</h4>
        <a href="/contact" class="footer-link">Contact Support</a>
        <a href="/help/checkout" class="footer-link">Checkout FAQs</a>
        <a href="/help/shipping" class="footer-link">Shipping Information</a>
      </div>
      
      <div class="footer-section">
        <h4>Payment Security</h4>
        <div class="security-info">
          <span class="security-icon">üîí</span>
          <span>Your payment information is encrypted</span>
        </div>
        <div class="security-info">
          <span class="security-icon">üõ°Ô∏è</span>
          <span>We never store your card details</span>
        </div>
      </div>
      
      <div class="footer-section">
        <h4>Return to</h4>
        <a href="/cart" class="btn btn-outline btn-sm">‚Üê Back to Cart</a>
        <a href="/sales" class="btn btn-outline btn-sm">Continue Shopping</a>
        <div class="cart-info">
          <span class="info-icon">‚è∞</span>
          <span>Your cart is saved for 30 minutes</span>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Toast Notification -->
<div id="toast" class="toast" aria-live="polite" aria-atomic="true" hidden>
  <div class="toast-content">
    <span class="toast-icon"></span>
    <span class="toast-message"></span>
  </div>
</div>

<!-- Templates -->
<template id="tpl-cart-row">
  <div class="cart-item" data-id="">
    <div class="item-image">
      <img class="product-image" alt="" />
    </div>
    <div class="item-details">
      <div class="item-header">
        <h3 class="item-name"></h3>
        <button type="button" class="item-remove" aria-label="Remove item">
          <span class="remove-icon">√ó</span>
        </button>
      </div>
      <div class="item-meta">
        <span class="item-variants"></span>
      </div>
      <div class="item-controls">
        <div class="quantity-control">
          <button type="button" class="qty-btn qty-decrease" aria-label="Decrease quantity">
            <span class="btn-icon">‚àí</span>
          </button>
          <span class="quantity-value">1</span>
          <button type="button" class="qty-btn qty-increase" aria-label="Increase quantity">
            <span class="btn-icon">+</span>
          </button>
        </div>
        <div class="item-price">
          <span class="price-value"></span>
          <span class="price-unit">each</span>
        </div>
      </div>
    </div>
  </div>
</template>

<!-- JSON config -->
<script id="checkout-config" type="application/json" nonce="<%= CO_NONCE %>">
  <%- JSON.stringify({
    VAT_RATE: Number(CO_VAT),
    CURRENCY: CO_CCY,
    SHIPPING_FLAT: Number(SHIPPING_FLAT),
    BRAND_NAME: CO_BRAND
  }) %>
</script>

<!-- PayPal SDK -->
<script nonce="<%= CO_NONCE %>" 
        src="https://www.paypal.com/sdk/js?client-id=<%= encodeURIComponent(CO_CLIENT_ID) %>&components=buttons&currency=<%= encodeURIComponent(CO_CCY) %>&intent=capture&enable-funding=card"></script>

<style nonce="<%= CO_NONCE %>">
  /* ===== VARIABLES ===== */
  .checkout-page {
    --primary-blue: #2563EB;
    --primary-purple: #7C3AED;
    --primary-green: #22C55E;
    --primary-black: #0F172A;
    --gray-50: #F8FAFC;
    --gray-100: #F1F5F9;
    --gray-200: #E2E8F0;
    --gray-300: #CBD5E1;
    --gray-400: #94A3B8;
    --gray-500: #64748B;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1E293B;
    --gray-900: #0F172A;
    --radius-lg: 16px;
    --radius-md: 12px;
    --radius-sm: 8px;
    --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
    --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    padding: 1rem;
    background: var(--primary-green);
    min-height: 100vh;
  }

  /* ===== HEADER ===== */
  .checkout-header {
    background: white;
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow-md);
  }

  .header-content {
    margin-bottom: 1.5rem;
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.875rem;
  }

  .breadcrumb-link {
    color: var(--primary-blue);
    text-decoration: none;
    font-weight: 500;
  }

  .breadcrumb-link:hover {
    text-decoration: underline;
  }

  .breadcrumb-separator {
    color: var(--gray-400);
  }

  .breadcrumb-current {
    color: var(--gray-600);
    font-weight: 500;
  }

  .checkout-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-black);
    margin: 0 0 0.5rem 0;
    background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .checkout-subtitle {
    font-size: 1rem;
    color: var(--gray-600);
    margin: 0;
  }

  .checkout-steps {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding: 0.5rem 0;
  }

  .step {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    background: var(--gray-100);
    color: var(--gray-500);
    flex-shrink: 0;
  }

  .step.active {
    background: rgba(37, 99, 235, 0.1);
    color: var(--primary-blue);
  }

  .step.current {
    background: var(--primary-blue);
    color: white;
  }

  .step-number {
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .step.current .step-number {
    background: white;
    color: var(--primary-blue);
  }

  .step-label {
    font-size: 0.875rem;
    font-weight: 500;
  }

  /* ===== NOTIFICATIONS ===== */
  .notifications-container {
    margin-bottom: 1.5rem;
  }

  .notification {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    animation: slideIn 0.3s ease-out;
    border-left: 4px solid transparent;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .notification-success {
    background: rgba(34, 197, 94, 0.1);
    color: #166534;
    border-left-color: var(--primary-green);
  }

  .notification-error {
    background: rgba(239, 68, 68, 0.1);
    color: #b91c1c;
    border-left-color: #EF4444;
  }

  .notification-icon {
    font-weight: bold;
    font-size: 1rem;
  }

  .notification-close {
    margin-left: auto;
    background: none;
    border: none;
    cursor: pointer;
    color: inherit;
    opacity: 0.7;
    font-size: 1.25rem;
    line-height: 1;
  }

  .notification-close:hover {
    opacity: 1;
  }

  /* ===== CHECKOUT CONTENT ===== */
  .checkout-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
  }

  @media (min-width: 1024px) {
    .checkout-content {
      grid-template-columns: 1fr 1fr;
    }
  }

  .checkout-column {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  /* ===== CARDS ===== */
  .card {
    background: white;
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-md);
    overflow: hidden;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--gray-200);
  }

  .card-title {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--primary-black);
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .card-icon {
    font-size: 1.25rem;
  }

  .card-action {
    font-size: 0.875rem;
    color: var(--primary-blue);
    text-decoration: none;
    font-weight: 500;
  }

  .card-action:hover {
    text-decoration: underline;
  }

  .card-badge {
    background: var(--primary-purple);
    color: white;
    padding: 0.25rem 0.75rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .card-body {
    padding: 1.5rem;
  }

  /* ===== CART CARD ===== */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    padding: 2rem;
    color: var(--gray-500);
  }

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--gray-200);
    border-top-color: var(--primary-blue);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .cart-items {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .cart-item {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
    transition: all 0.2s ease;
  }

  .cart-item:hover {
    border-color: var(--primary-blue);
    box-shadow: var(--shadow-sm);
  }

  .item-image {
    flex-shrink: 0;
  }

  .product-image {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-sm);
    object-fit: cover;
    border: 1px solid var(--gray-200);
  }

  .item-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .item-name {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--primary-black);
    margin: 0;
    line-height: 1.4;
  }

  .item-remove {
    background: none;
    border: none;
    color: var(--gray-400);
    cursor: pointer;
    font-size: 1.25rem;
    line-height: 1;
    padding: 0.25rem;
    border-radius: var(--radius-sm);
    transition: all 0.2s ease;
  }

  .item-remove:hover {
    color: #EF4444;
    background: rgba(239, 68, 68, 0.1);
  }

  .item-meta {
    font-size: 0.75rem;
    color: var(--gray-500);
  }

  .item-variants {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
  }

  .item-variants{
  font-size: 0.78rem;
  color: var(--gray-500);
}

  .item-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .quantity-control {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    padding: 0.25rem;
  }

  .qty-btn {
    width: 1.5rem;
    height: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: none;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--gray-600);
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
    transition: all 0.2s ease;
  }

  .qty-btn:hover {
    background: var(--gray-100);
    color: var(--primary-black);
  }

  .quantity-value {
    min-width: 1.5rem;
    text-align: center;
    font-weight: 600;
    color: var(--primary-black);
    font-size: 0.875rem;
  }

  .item-price {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
  }

  .price-value {
    font-weight: 700;
    color: var(--primary-black);
    font-size: 0.875rem;
  }

  .price-unit {
    font-size: 0.75rem;
    color: var(--gray-500);
  }

  .cart-empty {
    padding: 3rem;
    text-align: center;
  }

  .empty-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    color: var(--gray-500);
  }

  .empty-icon {
    font-size: 3rem;
    opacity: 0.5;
  }

  .empty-content h3 {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--gray-700);
    margin: 0;
  }

  .empty-content p {
    margin: 0;
    max-width: 400px;
  }

  /* ===== DELIVERY CARD ===== */
  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--primary-black);
    margin-bottom: 0.5rem;
  }

  .form-required {
    color: #EF4444;
  }

  .select-wrapper {
    position: relative;
  }

  .form-select {
    width: 100%;
    padding: 0.75rem 2.5rem 0.75rem 1rem;
    border: 1px solid var(--gray-300);
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    color: var(--gray-700);
    background: white;
    appearance: none;
    cursor: pointer;
  }

  .form-select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-select:disabled {
    background: var(--gray-100);
    cursor: not-allowed;
  }

  .select-arrow {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
    pointer-events: none;
  }

  .form-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    font-size: 0.875rem;
    color: var(--gray-500);
  }

  .hint-icon {
    font-size: 1rem;
  }

  .delivery-info {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    margin-top: 1.5rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
  }

  .info-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .info-icon {
    font-size: 1rem;
    width: 2rem;
    height: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    background: white;
    border-radius: var(--radius-sm);
    flex-shrink: 0;
  }

  .info-content {
    flex: 1;
  }

  .info-label {
    display: block;
    font-size: 0.75rem;
    color: var(--gray-500);
    margin-bottom: 0.125rem;
  }

  .info-value {
    display: block;
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--primary-black);
  }

  /* ===== SUMMARY CARD ===== */
  .summary-items {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .item-label {
    font-size: 0.875rem;
    color: var(--gray-600);
  }

  .item-value {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--primary-black);
  }

  .summary-divider {
    height: 1px;
    background: var(--gray-200);
    margin: 0.75rem 0;
  }

  .summary-total {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-top: 2px solid var(--gray-300);
    border-bottom: 2px solid var(--gray-300);
  }

  .total-label {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary-black);
  }

  .total-value {
    font-size: 1.25rem;
    font-weight: 800;
    color: var(--primary-green);
  }

  .summary-note {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    font-size: 0.75rem;
    color: var(--gray-500);
  }

  .note-icon {
    font-size: 0.875rem;
  }

  /* ===== PAYMENT CARD ===== */
  .payment-card {
    position: relative;
  }

  .security-badge {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: rgba(34, 197, 94, 0.1);
    color: #166534;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .security-icon {
    font-size: 0.875rem;
  }

  .payment-methods {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .method-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .method-title {
    font-size: 1rem;
    font-weight: 600;
    color: var(--primary-black);
    margin: 0;
  }

  .method-icons {
    display: flex;
    gap: 0.25rem;
  }

  .method-icon {
    font-size: 1.25rem;
    opacity: 0.7;
  }

  .payment-content {
    position: relative;
    min-height: 200px;
  }

  .payment-guard {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
    z-index: 10;
  }

  .guard-content {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1rem;
    text-align: center;
    padding: 2rem;
    color: var(--gray-500);
  }

  .paypal-container {
    min-height: 50px;
  }

  .payment-note {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    margin-top: 1rem;
    padding: 1rem;
    background: var(--gray-50);
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
  }

  .note-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--gray-600);
  }

  .note-icon {
    font-size: 0.875rem;
    color: var(--primary-green);
  }

  /* ===== TRUST SIGNALS ===== */
  .trust-signals {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .signal-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: white;
    border-radius: var(--radius-md);
    border: 1px solid var(--gray-200);
    font-size: 0.75rem;
    color: var(--gray-600);
  }

  .signal-icon {
    font-size: 0.875rem;
  }

  /* ===== BUTTONS ===== */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: var(--radius-md);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    cursor: pointer;
    border: 1px solid transparent;
    transition: all 0.2s ease;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
  }

  .btn-primary {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
  }

  .btn-primary:hover {
    background: #1D4ED8;
    border-color: #1D4ED8;
    transform: translateY(-1px);
  }

  .btn-outline {
    background: transparent;
    color: var(--gray-700);
    border-color: var(--gray-300);
  }

  .btn-outline:hover {
    background: var(--gray-50);
    border-color: var(--gray-400);
  }

  /* ===== TOAST ===== */
  .toast {
    position: fixed;
    bottom: 1rem;
    right: 1rem;
    background: var(--primary-black);
    color: white;
    padding: 0.75rem 1rem;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    z-index: 1000;
    animation: toastSlideIn 0.3s ease;
  }

  @keyframes toastSlideIn {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .toast-content {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .toast-icon {
    font-size: 1rem;
  }

  .toast-message {
    font-size: 0.875rem;
  }

  /* ===== CHECKOUT FOOTER ===== */
  .checkout-footer {
    background: white;
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin-top: 2rem;
    box-shadow: var(--shadow-md);
  }

  .footer-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
  }

  .footer-section h4 {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--primary-black);
    margin: 0 0 1rem 0;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .footer-link {
    display: block;
    padding: 0.5rem 0;
    color: var(--gray-600);
    text-decoration: none;
    font-size: 0.875rem;
    transition: color 0.2s ease;
  }

  .footer-link:hover {
    color: var(--primary-blue);
  }

  .security-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    font-size: 0.875rem;
    color: var(--gray-600);
  }

  .cart-info {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 1rem;
    font-size: 0.75rem;
    color: var(--gray-500);
  }

  .info-icon {
    font-size: 0.875rem;
  }

  /* ===== MOBILE OPTIMIZATIONS ===== */
  @media (max-width: 768px) {
    .checkout-page {
      padding: 0.75rem;
    }

    .checkout-header,
    .checkout-footer {
      padding: 1rem;
    }

    .checkout-title {
      font-size: 1.5rem;
    }

    .card-header,
    .card-body {
      padding: 1rem;
    }

    .cart-item {
      flex-direction: column;
    }

    .item-image {
      align-self: center;
    }

    .product-image {
      width: 120px;
      height: 120px;
    }

    .trust-signals {
      justify-content: center;
    }

    .footer-content {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    .checkout-steps {
      flex-direction: column;
      gap: 0.5rem;
    }

    .step {
      width: 100%;
    }

    .cart-item {
      padding: 0.75rem;
    }

    .item-controls {
      flex-direction: column;
      align-items: stretch;
      gap: 0.75rem;
    }

    .item-price {
      align-items: flex-start;
    }

    .payment-note {
      padding: 0.75rem;
    }
  }

  /* ===== DARK THEME SUPPORT ===== */
  @media (prefers-color-scheme: dark) {
    .checkout-page {
      background: var(--gray-900);
    }

    .checkout-header,
    .card,
    .checkout-footer {
      background: var(--gray-800);
    }

    .checkout-title,
    .card-title,
    .item-name,
    .item-label,
    .total-label,
    .method-title,
    .footer-section h4 {
      color: var(--gray-100);
    }

    .checkout-subtitle,
    .breadcrumb-current,
    .item-meta,
    .price-unit,
    .form-hint,
    .info-label,
    .summary-note,
    .note-item,
    .signal-text,
    .footer-link,
    .security-info,
    .cart-info {
      color: var(--gray-400);
    }

    .breadcrumb-link {
      color: var(--primary-blue);
    }

    .step {
      background: var(--gray-700);
    }

    .step.active {
      background: rgba(37, 99, 235, 0.2);
    }

    .step.current .step-number {
      background: var(--gray-800);
    }

    .cart-item,
    .delivery-info,
    .payment-note {
      background: var(--gray-700);
      border-color: var(--gray-600);
    }

    .product-image {
      border-color: var(--gray-600);
    }

    .quantity-control {
      background: var(--gray-800);
      border-color: var(--gray-600);
    }

    .form-select {
      background: var(--gray-700);
      border-color: var(--gray-600);
      color: var(--gray-300);
    }

    .loading-spinner {
      border-color: var(--gray-700);
      border-top-color: var(--primary-blue);
    }

    .payment-guard {
      background: rgba(30, 41, 59, 0.9);
    }

    .trust-signals .signal-item {
      background: var(--gray-700);
      border-color: var(--gray-600);
    }

    .btn-outline {
      color: var(--gray-300);
      border-color: var(--gray-600);
    }

    .btn-outline:hover {
      background: var(--gray-700);
      border-color: var(--gray-500);
    }
  }
</style>

<script nonce="<%= CO_NONCE %>">
  (function(){
    // DOM Elements
    const elements = {
      cartState: document.getElementById('cart-state'),
      cartItems: document.getElementById('cart-items'),
      cartEmpty: document.getElementById('cart-empty'),
      deliverySelect: document.getElementById('delivery-select'),
      deliveryHint: document.getElementById('delivery-hint'),
      deliveryInfo: document.getElementById('delivery-info'),
      deliveryType: document.getElementById('delivery-type'),
      deliveryEstimate: document.getElementById('delivery-estimate'),
      deliveryArea: document.getElementById('delivery-area'),
      sumSubtotal: document.getElementById('sum-subtotal'),
      sumVat: document.getElementById('sum-vat'),
      sumShipping: document.getElementById('sum-shipping'),
      sumTotal: document.getElementById('sum-total'),
      payGuard: document.getElementById('pay-guard'),
      ppMount: document.getElementById('paypal-buttons'),
      toast: document.getElementById('toast'),
      toastIcon: document.querySelector('.toast-icon'),
      toastMessage: document.querySelector('.toast-message'),
      vatRate: document.getElementById('vat-rate')
    };

    // Templates
    const cartRowTemplate = document.getElementById('tpl-cart-row');

    // Read configuration
    const configEl = document.getElementById('checkout-config');
    let config = {};
    try { config = JSON.parse(configEl ? configEl.textContent : '{}'); } catch (_) { config = {}; }
    const VAT_RATE = Number(config.VAT_RATE || 0);
    const CURRENCY = String(config.CURRENCY || 'USD');
    const SHIPPING_FLAT = Number(config.SHIPPING_FLAT || 0);
    const BRAND_NAME = String(config.BRAND_NAME || '');

    // Application state
    const state = {
      items: [],
      deliveryOptions: [],
      selectedDelivery: null,
      deliveryReady: false,
      cartReady: false,
      paypalMounted: false
    };

    // Utility Functions
    function formatCurrency(amount, currency = CURRENCY) {
      const symbols = { USD: '$', ZAR: 'R', EUR: '‚Ç¨', GBP: '¬£', AUD: 'A$', CAD: 'C$' };
      const symbol = symbols[currency.toUpperCase()] || currency + ' ';
      return symbol + Number(amount || 0).toFixed(2);
    }

    function showToast(message, type = 'info') {
      const icons = {
        success: '‚úì',
        error: '!',
        warning: '‚ö†',
        info: 'üí°'
      };
      
      elements.toastIcon.textContent = icons[type] || icons.info;
      elements.toastMessage.textContent = message;
      elements.toast.hidden = false;
      
      clearTimeout(elements.toast._timeout);
      elements.toast._timeout = setTimeout(() => {
        elements.toast.hidden = true;
      }, 3000);
    }

    function calculateTotals() {
      const subtotal = state.items.reduce((sum, item) => 
        sum + (Number(item.price) * Number(item.quantity)), 0);
      const vat = subtotal * VAT_RATE;
      const shipping = state.selectedDelivery ? 
        Number(state.selectedDelivery.price) : SHIPPING_FLAT;
      const total = subtotal + vat + shipping;
      
      return { subtotal, vat, shipping, total };
    }

    // Notification Management
    function setupNotifications() {
      document.querySelectorAll('.notification-close').forEach(button => {
        button.addEventListener('click', (e) => {
          const notification = e.target.closest('.notification');
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 300);
        });
      });

      // Auto-hide success notifications
      setTimeout(() => {
        document.querySelectorAll('.notification-success').forEach(notification => {
          notification.style.opacity = '0';
          notification.style.transform = 'translateY(-10px)';
          setTimeout(() => notification.remove(), 300);
        });
      }, 5000);
    }

    // Delivery Options
    async function loadDeliveryOptions() {
      elements.deliverySelect.disabled = true;
      elements.deliveryHint.innerHTML = `
        <span class="hint-icon">‚è±Ô∏è</span>
        <span>Loading delivery options‚Ä¶</span>
      `;

      try {
        const response = await fetch("/api/delivery-options?active=1&sort=price&order=asc", {
          headers: { "Accept": "application/json" }
        });

        if (!response.ok) throw new Error('Failed to load delivery options');

        const data = await response.json();
        const options = Array.isArray(data.options) ? data.options : [];

        if (!options.length) {
          elements.deliveryHint.innerHTML = `
            <span class="hint-icon">‚ö†Ô∏è</span>
            <span>No delivery options available</span>
          `;
          state.deliveryReady = false;
          blockPayment();
          return;
        }

        // Populate select options
        elements.deliverySelect.innerHTML = '';
        options.forEach(option => {
          const optionEl = document.createElement('option');
          optionEl.value = String(option.id);
          optionEl.dataset.price = String((option.priceCents || 0) / 100);
          optionEl.dataset.days = String(option.deliveryDays || 0);
          optionEl.dataset.type = String(option.type || 'Standard');
          optionEl.dataset.area = String(option.area || 'Nationwide');
          optionEl.textContent = `${option.name} ‚Äî ${formatCurrency((option.priceCents || 0) / 100)}`;
          elements.deliverySelect.appendChild(optionEl);
        });

        elements.deliverySelect.disabled = false;
        elements.deliverySelect.selectedIndex = 0;
        applyDeliverySelection();
        
        state.deliveryOptions = options;
        state.deliveryReady = true;
        maybeEnablePayment();

      } catch (error) {
        console.error('Error loading delivery options:', error);
        elements.deliveryHint.innerHTML = `
          <span class="hint-icon">‚ùå</span>
          <span>Could not load delivery options</span>
        `;
        state.deliveryReady = false;
        blockPayment();
      }
    }

    function applyDeliverySelection() {
      const selectedOption = elements.deliverySelect.options[elements.deliverySelect.selectedIndex];
      
      if (selectedOption) {
        state.selectedDelivery = {
          id: selectedOption.value,
          price: Number(selectedOption.dataset.price),
          days: Number(selectedOption.dataset.days),
          type: selectedOption.dataset.type,
          area: selectedOption.dataset.area
        };

        // Update delivery info
        elements.deliveryType.textContent = state.selectedDelivery.type;
        elements.deliveryEstimate.textContent = state.selectedDelivery.days ? 
          `~${state.selectedDelivery.days} day${state.selectedDelivery.days === 1 ? '' : 's'}` : 
          'Contact for estimate';
        elements.deliveryArea.textContent = state.selectedDelivery.area;
        elements.deliveryInfo.style.display = 'flex';
        
        // Update delivery hint
        elements.deliveryHint.innerHTML = `
          <span class="hint-icon">üì¶</span>
          <span>${state.selectedDelivery.type} delivery selected</span>
        `;

        updateSummary();
        maybeEnablePayment();
      }
    }

    // Cart Management
    async function loadCart() {
      try {
        const response = await fetch('/api/cart', {
          headers: { 'Accept': 'application/json' }
        });

        const data = await response.json();

        state.items = Array.isArray(data.items)
          ? data.items.map(item => {
              // Try to pull size + color from different possible shapes
              const variantsObj = (item.variants && typeof item.variants === 'object')
                ? item.variants
                : {};

              const size  = item.size  || item.variantSize  || variantsObj.size  || '';
              const color = item.color || item.variantColor || variantsObj.color || '';

              const variantLabel = [
                size  ? `Size: ${size}`   : '',
                color ? `Color: ${color}` : ''
              ].filter(Boolean).join(' ‚Ä¢ ');

              return {
                id: String(item.productId || item._id || item.id),
                productId: String(item.productId || item._id || item.id),
                name: item.name || item.title || 'Product',
                price: Number(item.price || 0),
                quantity: Number(item.quantity || item.qty || 1),
                imageUrl: item.imageUrl || item.image || '',
                // keep structured variants so we can use them later
                variants: {
                  size,
                  color,
                  label: variantLabel
                }
              };
            })
          : [];

        renderCart();
        state.cartReady = true;
        maybeEnablePayment();

      } catch (error) {
        console.error('Error loading cart:', error);
        elements.cartState.innerHTML = `
          <div class="loading-state">
            <span class="empty-icon">‚ö†Ô∏è</span>
            <p>Could not load your cart</p>
            <button onclick="location.reload()" class="btn btn-primary">Retry</button>
          </div>
        `;
        state.cartReady = false;
        blockPayment();
      }
    }

    function renderCart() {
      if (state.items.length === 0) {
        elements.cartState.style.display = 'none';
        elements.cartItems.style.display = 'none';
        elements.cartEmpty.style.display = 'block';
        return;
      }

      elements.cartState.style.display = 'none';
      elements.cartEmpty.style.display = 'none';
      elements.cartItems.style.display = 'flex';
      elements.cartItems.innerHTML = '';

      state.items.forEach(item => {
        const cartItem = createCartItem(item);
        elements.cartItems.appendChild(cartItem);
      });

      updateSummary();
    }

    function createCartItem(item) {
      const template = cartRowTemplate.content.cloneNode(true);
      const cartItem = template.querySelector('.cart-item');
      
      cartItem.dataset.id = item.id;
      
      // Set item details
      const image = cartItem.querySelector('.product-image');
      image.src = item.imageUrl || '/img/placeholder.png';
      image.alt = item.name;
      
      cartItem.querySelector('.item-name').textContent = item.name;

      // üîπ Show size + color nicely
      const variantsEl = cartItem.querySelector('.item-variants');
      let variantsText = '';

      if (item.variants && typeof item.variants === 'object') {
        // From the structured object we created in loadCart
        variantsText = item.variants.label
          || [
              item.variants.size  ? `Size: ${item.variants.size}`   : '',
              item.variants.color ? `Color: ${item.variants.color}` : ''
            ].filter(Boolean).join(' ‚Ä¢ ');
      } else if (typeof item.variants === 'string') {
        // Fallback if backend only stored a string
        variantsText = item.variants;
      }

      variantsEl.textContent = variantsText || '';

      // Quantity & price
      cartItem.querySelector('.quantity-value').textContent = item.quantity;
      cartItem.querySelector('.price-value').textContent = formatCurrency(item.price * item.quantity);
      
      // Add event listeners
      const decreaseBtn = cartItem.querySelector('.qty-decrease');
      const increaseBtn = cartItem.querySelector('.qty-increase');
      const removeBtn   = cartItem.querySelector('.item-remove');
      
      decreaseBtn.addEventListener('click', () => updateQuantity(item.id, item.quantity - 1));
      increaseBtn.addEventListener('click', () => updateQuantity(item.id, item.quantity + 1));
      removeBtn.addEventListener('click', () => removeItem(item.id));
      
      return cartItem;
    }

    async function updateQuantity(productId, quantity) {
      if (quantity < 1) {
        await removeItem(productId);
        return;
      }

      try {
        const response = await fetch(`/api/cart/item/${encodeURIComponent(productId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity })
        });

        if (!response.ok) throw new Error('Failed to update quantity');
        
        await loadCart();
        showToast('Quantity updated', 'success');

      } catch (error) {
        console.error('Error updating quantity:', error);
        showToast('Failed to update quantity', 'error');
      }
    }

    async function removeItem(productId) {
      try {
        const response = await fetch(`/api/cart/item/${encodeURIComponent(productId)}`, {
          method: 'DELETE'
        });

        if (!response.ok) throw new Error('Failed to remove item');
        
        await loadCart();
        showToast('Item removed from cart', 'success');

      } catch (error) {
        console.error('Error removing item:', error);
        showToast('Failed to remove item', 'error');
      }
    }

    // Summary Updates
    function updateSummary() {
      const totals = calculateTotals();
      
      elements.sumSubtotal.textContent = formatCurrency(totals.subtotal);
      elements.sumVat.textContent = formatCurrency(totals.vat);
      elements.sumShipping.textContent = formatCurrency(totals.shipping);
      elements.sumTotal.textContent = formatCurrency(totals.total);
      
      elements.vatRate.textContent = (VAT_RATE * 100).toFixed(0);
    }

    // Payment Management
    function blockPayment(message = 'Waiting for cart & delivery options‚Ä¶') {
      elements.payGuard.style.display = 'flex';
      elements.payGuard.querySelector('p').textContent = message;
    }

    function allowPayment() {
      elements.payGuard.style.display = 'none';
    }

    function maybeEnablePayment() {
      if (state.cartReady && state.deliveryReady && state.items.length > 0) {
        allowPayment();
        maybeMountPayPal();
      } else {
        blockPayment();
      }
    }

    function maybeMountPayPal() {
      if (state.paypalMounted) return;
      if (!window.paypal || !elements.ppMount) return;
      if (!state.items.length || !state.selectedDelivery) return;

      state.paypalMounted = true;

      paypal.Buttons({
        style: {
          layout: 'vertical',
          shape: 'rect',
          label: 'paypal',
          color: 'blue',
          height: 48
        },

        createOrder: async function() {
          try {
            const body = { deliveryOptionId: state.selectedDelivery.id };
            const response = await fetch('/payment/create-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });

            const data = await response.json();
            
            if (!response.ok || !data.id) {
              throw new Error(data.message || 'Failed to create order');
            }

            return data.id;

          } catch (error) {
            showToast('Failed to create order: ' + error.message, 'error');
            throw error;
          }
        },

        onApprove: async function(data) {
          try {
            const response = await fetch(`/payment/capture-order?orderId=${encodeURIComponent(data.orderID)}`, {
              method: 'POST'
            });

            const result = await response.json();
            
            if (!response.ok) {
              throw new Error(result.message || 'Failed to capture payment');
            }

            const orderId = result.orderId || data.orderID;
            window.location.href = `/payment/thank-you?orderId=${encodeURIComponent(orderId)}`;

          } catch (error) {
            showToast('Payment error: ' + error.message, 'error');
          }
        },

        onError: function(err) {
          console.error('PayPal error:', err);
          showToast('Payment processing error. Please try again.', 'error');
        },

        onCancel: function() {
          showToast('Payment was cancelled', 'warning');
        }

      }).render('#paypal-buttons');
    }

    // Event Listeners
    function setupEventListeners() {
      // Delivery option change
      elements.deliverySelect.addEventListener('change', applyDeliverySelection);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setupNotifications();
      setupEventListeners();
      
      // Load data
      Promise.all([
        loadDeliveryOptions(),
        loadCart()
      ]).catch(error => {
        console.error('Initialization error:', error);
        showToast('Failed to initialize checkout', 'error');
      });
    });

    // Expose functions for debugging
    window.checkoutApp = {
      loadCart,
      loadDeliveryOptions,
      updateQuantity,
      removeItem,
      state
    };

  })();
</script>

