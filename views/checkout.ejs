<%
  const CO_NONCE     = typeof NONCE !== 'undefined' ? NONCE : '';
  const CO_CLIENT_ID = typeof paypalClientId !== 'undefined' ? paypalClientId : '';
  const CO_CCY       = typeof currency !== 'undefined' ? currency : 'USD';
  const CO_BRAND     = typeof brandName !== 'undefined' ? brandName : 'Unicoporate.com';
  const CO_VAT       = typeof vatRate !== 'undefined' ? Number(vatRate) : 0.15;
%>

<section class="checkout-page">
  <h1 class="title">üßæ Checkout</h1>

  <% (success || []).forEach(msg => { %>
    <div class="flash flash-success">‚úÖ <%= msg %></div>
  <% }) %>
  <% (error || []).forEach(msg => { %>
    <div class="flash flash-error">‚ùå <%= msg %></div>
  <% }) %>

  <div class="co-grid">
    <!-- LEFT -->
    <div class="co-left card">
      <h2 class="card-title">Your Cart</h2>

      <!-- Simple state text (no spinner) -->
      <div id="cart-state" class="state-msg">Loading your cart‚Ä¶</div>

      <!-- Cart Items -->
      <div id="cart-items" class="cart-list" hidden></div>

      <!-- Delivery from DB -->
      <div class="card-sub">
        <label for="delivery-select" class="lbl">Delivery option</label>
        <select id="delivery-select" class="select" disabled></select>
        <div class="del-hint" id="delivery-hint"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="co-right">
      <div class="card">
        <h2 class="card-title">Order Summary</h2>
        <div class="summary-line"><span>Subtotal</span><span id="sum-subtotal">‚Äî</span></div>
        <div class="summary-line">
          <span>VAT (<span id="sum-vat-rate"><%= (CO_VAT * 100).toFixed(0) %></span>%)</span>
          <span id="sum-vat">‚Äî</span>
        </div>
        <div class="summary-line"><span>Shipping</span><span id="sum-shipping">‚Äî</span></div>
        <div class="summary-total"><span>Total</span><span id="sum-total">‚Äî</span></div>
      </div>

      <div class="card pay-card">
        <h3 class="card-title">Pay securely</h3>
        <div id="pay-guard" class="pay-guard">Waiting for cart & delivery options‚Ä¶</div>
        <div id="paypal-buttons"></div>
        <small class="muted">Payments processed by PayPal. Merchant: <%= CO_BRAND %>.</small>
      </div>
    </div>
  </div>
</section>

<style nonce="<%= CO_NONCE %>">
  .checkout-page { max-width: 1100px; margin: 0 auto; padding: 1rem; }
  .title { font-size: 1.6rem; margin: 0 0 1rem 0; }
  .co-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 1rem; }
  .card { background: var(--card-bg,#fff); border: 1px solid #e5e7eb; border-radius: 14px; padding: 1rem; box-shadow: 0 1px 4px rgba(0,0,0,.05); }
  .card-title { margin: 0 0 .75rem 0; font-size: 1.1rem; }
  .card-sub { margin-top: 1rem; padding-top: 1rem; border-top: 1px dashed #e5e7eb; }
  .cart-list { display: grid; gap: .75rem; }
  .cart-row { display: grid; grid-template-columns: 64px 1fr auto; gap: .75rem; align-items: center; }
  .cart-img { width: 64px; height: 64px; object-fit: cover; border-radius: 10px; border: 1px solid #eee; }
  .cart-title { font-weight: 600; margin: 0 0 .25rem 0; }
  .cart-meta { font-size: .85rem; color: #6b7280; display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
  .qty { display: inline-flex; align-items: center; gap: .4rem; border: 1px solid #e5e7eb; border-radius: 10px; padding: .15rem .45rem; }
  .qty button { border: 0; background: transparent; font-size: 1.1rem; line-height: 1; cursor: pointer; }
  .cart-price { font-weight: 700; }
  .lbl { display:block; font-weight:600; margin-bottom:.25rem; }
  .select { width: 100%; padding:.55rem .6rem; border:1px solid #e5e7eb; border-radius:10px; background:#fff; }
  .del-hint { font-size:.85rem; color:#6b7280; margin-top:.35rem; min-height:1.2em; }
  .summary-line { display:flex; justify-content:space-between; margin:.35rem 0; }
  .summary-total { display:flex; justify-content:space-between; margin-top:.6rem; font-weight:800; font-size:1.1rem; }
  .pay-card { position: relative; }
  .pay-guard { position:absolute; inset:0; background:rgba(255,255,255,.75); display:grid; place-items:center; border-radius:14px; font-weight:600; text-align:center; padding:1rem; }
  .flash { margin:.5rem 0; padding:.6rem .8rem; border-radius:10px; }
  .flash-success { background:#ecfdf5; color:#065f46; border:1px solid #a7f3d0; }
  .flash-error { background:#fef2f2; color:#991b1b; border:1px solid #fecaca; }
  .state-msg { font-size:.95rem; color:#6b7280; padding:.5rem 0; min-height:1.2em; }
  .muted { color:#6b7280; font-size:.85rem; display:block; margin-top:.5rem; }
  @media (max-width: 720px){
    .co-grid { grid-template-columns: 1fr; }
    .cart-row { grid-template-columns: 56px 1fr auto; }
  }
</style>

<template id="tpl-cart-row">
  <div class="cart-row" data-id="">
    <img class="cart-img" alt="" />
    <div>
      <div class="cart-title"></div>
      <div class="cart-meta">
        <span class="meta-opts"></span>
        <span class="qty">
          <button type="button" class="btn-dec" aria-label="Decrease">‚àí</button>
          <span class="qty-val">1</span>
          <button type="button" class="btn-inc" aria-label="Increase">+</button>
        </span>
        <button type="button" class="btn-rem" style="margin-left:.4rem;color:#991b1b;background:transparent;border:0;cursor:pointer">Remove</button>
      </div>
    </div>
    <div class="cart-price"></div>
  </div>
</template>

<div id="toast" hidden style="position:fixed;right:10px;bottom:10px;z-index:50;background:#111;color:#fff;padding:.6rem .8rem;border-radius:10px;"></div>

<!-- ‚úÖ JSON config (no EJS inside script logic) -->
<script id="checkout-config" type="application/json" nonce="<%= CO_NONCE %>">
  <%- JSON.stringify({
    VAT_RATE: Number(CO_VAT),
    CURRENCY: CO_CCY
  }) %>
</script>

<!-- PayPal SDK (EJS in attribute is fine) -->
<script nonce="<%= CO_NONCE %>" src="https://www.paypal.com/sdk/js?client-id=<%= encodeURIComponent(CO_CLIENT_ID) %>&components=buttons&currency=<%= encodeURIComponent(CO_CCY) %>&intent=capture&enable-funding=card"></script>

<script nonce="<%= CO_NONCE %>">
(function(){
  // Read config safely (avoids EJS inside JS expressions)
  var _cfgEl = document.getElementById('checkout-config');
  var _cfg = {};
  try { _cfg = JSON.parse(_cfgEl ? _cfgEl.textContent : '{}'); } catch (_) { _cfg = {}; }
  var VAT_RATE = Number(_cfg.VAT_RATE || 0);
  var CURRENCY = String(_cfg.CURRENCY || 'USD');

  var els = {
    state:     document.getElementById('cart-state'),
    items:     document.getElementById('cart-items'),
    sumSub:    document.getElementById('sum-subtotal'),
    sumVat:    document.getElementById('sum-vat'),
    sumShip:   document.getElementById('sum-shipping'),
    sumTotal:  document.getElementById('sum-total'),
    payGuard:  document.getElementById('pay-guard'),
    ppMount:   document.getElementById('paypal-buttons'),
    toast:     document.getElementById('toast'),
    delSelect: document.getElementById('delivery-select'),
    delHint:   document.getElementById('delivery-hint'),
  };
  var TPL = document.getElementById('tpl-cart-row');

  var state = {
    items: [],
    shipping: 0,
    deliveryOptionId: null,
    deliveryReady: false,
    cartReady: false,
    paypalMounted: false,
  };

  var fmt = function(n){ return CURRENCY + ' ' + Number(n || 0).toFixed(2); };
  function toast(msg, ms){
    if (ms == null) ms = 2400;
    els.toast.textContent = msg;
    els.toast.hidden = false;
    clearTimeout(els.toast._t);
    els.toast._t = setTimeout(function(){ els.toast.hidden = true; }, ms);
  }

  /* -------------------- Delivery options (from your DB API) ------------------- */
  async function loadDeliveryOptions(){
    els.delSelect.disabled = true;
    els.delSelect.innerHTML = "";
    els.delHint.textContent = "Loading delivery options‚Ä¶";

    var r = await fetch("/api/delivery-options?active=1&sort=price&order=asc", { headers:{ "Accept":"application/json" }});
    if(!r.ok){
      els.delHint.textContent = "Could not load delivery options.";
      state.deliveryReady = false;
      blockPay();
      return;
    }
    var data = {};
    try { data = await r.json(); } catch (_) { data = {}; }
    var list = Array.isArray(data.options) ? data.options : [];

    if(!list.length){
      els.delHint.textContent = "No delivery options are enabled.";
      state.deliveryReady = false;
      blockPay();
      return;
    }

    // Fill dropdown with DB options
    for (var i=0;i<list.length;i++){
      var o = list[i];
      var opt = document.createElement("option");
      opt.value = String(o.id);
      opt.dataset.price = String((o.priceCents || 0) / 100);
      opt.dataset.days  = String(o.deliveryDays || 0);
      opt.textContent   = o.name + " ‚Äî " + fmt((o.priceCents||0)/100);
      els.delSelect.appendChild(opt);
    }

    els.delSelect.disabled = false;
    els.delSelect.selectedIndex = 0;
    applyDeliverySelection();
    state.deliveryReady = true;
    maybeEnablePay();
  }

  function applyDeliverySelection(){
    var opt  = els.delSelect.options[els.delSelect.selectedIndex];
    var id   = opt ? opt.value : null;
    var ship = Number(opt && opt.dataset ? opt.dataset.price : 0);
    var days = Number(opt && opt.dataset ? opt.dataset.days  : 0);
    state.deliveryOptionId = id;
    state.shipping = ship;
    els.delHint.textContent = days ? ("Estimated delivery: ~" + days + " day" + (Number(days)===1 ? "" : "s")) : "";
    renderSummary();
  }

  /* ------------------------------ Cart logic ------------------------------ */
  function totals(){
    var subtotal = state.items.reduce(function(s,it){ return s + (Number(it.price) * Number(it.quantity)); }, 0);
    var vat = subtotal * VAT_RATE;
    var total = subtotal + vat + state.shipping;
    return { subtotal: subtotal, vat: vat, total: total };
  }

  function renderSummary(){
    var t = totals();
    els.sumSub.textContent = fmt(t.subtotal);
    els.sumVat.textContent = fmt(t.vat);
    els.sumShip.textContent = fmt(state.shipping);
    els.sumTotal.textContent = fmt(t.total);
  }

  function rowDOM(item){
    var node = TPL.content.firstElementChild.cloneNode(true);
    var pid = String(item.productId || item.id || '');
    node.dataset.id = pid;

    node.querySelector('.cart-img').src = item.imageUrl || '/img/placeholder.png';
    node.querySelector('.cart-img').alt = item.name || 'Product';
    node.querySelector('.cart-title').textContent = item.name || 'Product';
    node.querySelector('.meta-opts').textContent = [item.color, item.size, item.type].filter(Boolean).join(' ‚Ä¢ ');
    node.querySelector('.qty-val').textContent = item.quantity;
    node.querySelector('.cart-price').textContent = fmt(item.price * item.quantity);

    var btnInc = node.querySelector('.btn-inc');
    var btnDec = node.querySelector('.btn-dec');
    var btnRem = node.querySelector('.btn-rem');

    btnInc.addEventListener('click', async function(){
      btnInc.disabled = true; btnDec.disabled = true;
      try { await setQty(pid, item.quantity + 1); }
      finally { btnInc.disabled = false; btnDec.disabled = false; }
    });

    btnDec.addEventListener('click', async function(){
      btnInc.disabled = true; btnDec.disabled = true;
      try { await setQty(pid, Math.max(1, item.quantity - 1)); }
      finally { btnInc.disabled = false; btnDec.disabled = false; }
    });

    btnRem.addEventListener('click', async function(){
      btnRem.disabled = true;
      try { await removeItem(pid); }
      finally { btnRem.disabled = false; }
    });

    return node;
  }

  async function loadCart(){
    els.state.textContent = 'Loading your cart‚Ä¶';
    els.items.hidden = true;

    try{
      var r = await fetch('/api/cart', { headers:{ 'Accept':'application/json' }});
      var data = await r.json();
      state.items = Array.isArray(data.items) ? data.items.map(function(it){
        return {
          id: String(it.productId || it._id || it.id),
          productId: String(it.productId || it._id || it.id),
          name: it.name || it.title || 'Product',
          price: Number(it.price || 0),
          quantity: Number(it.quantity || it.qty || 1),
          imageUrl: it.imageUrl || it.image || ''
        };
      }) : [];

      if (!state.items.length){
        els.state.innerHTML = 'Your cart is empty. <a href="/sales">Browse products</a>.';
        blockPay();
        renderSummary();
        return;
      }

      els.items.innerHTML = '';
      state.items.forEach(function(it){ els.items.appendChild(rowDOM(it)); });
      els.items.hidden = false;
      els.state.textContent = '';
      renderSummary();

      state.cartReady = true;
      maybeEnablePay();
    }catch(e){
      els.state.textContent = 'Could not load cart.';
      blockPay('Unable to pay until cart loads');
    }
  }

  /* ------------------------- Qty & Remove (server API) ------------------------ */
  async function setQty(productId, quantity){
    if(!productId) return toast('Missing product id');

    var r = await fetch('/api/cart/item/' + encodeURIComponent(productId), {
      method: 'PATCH',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({ quantity: quantity })
    });
    if(!r.ok){
      if(quantity <= 0){
        r = await fetch('/api/cart/item/' + encodeURIComponent(productId), { method:'DELETE' });
      } else {
        var current = state.items.find(function(i){ return String(i.productId) === String(productId); });
        var curQty = current ? Number(current.quantity || 1) : 0;
        var delta = quantity - curQty;
        if (delta > 0) {
          r = await fetch('/api/cart/increase', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ pid: productId })
          });
        } else if (delta < 0) {
          r = await fetch('/api/cart/decrease', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ pid: productId })
          });
        }
      }
    }
    await loadCart();
  }

  async function removeItem(productId){
    if(!productId) return toast('Missing product id');
    var r = await fetch('/api/cart/item/' + encodeURIComponent(productId), { method:'DELETE' });
    if(!r.ok){
      r = await fetch('/api/cart/remove', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ pid: productId })
      });
    }
    await loadCart();
  }

  /* --------------------------- Pay guard & PayPal ---------------------------- */
  function blockPay(msg){
    els.payGuard.textContent = msg || 'Waiting for cart & delivery options‚Ä¶';
    els.payGuard.style.display = 'grid';
  }
  function allowPay(){
    els.payGuard.style.display = 'none';
  }
  function maybeEnablePay(){
    if(state.cartReady && state.deliveryReady){
      allowPay();
      maybeMountPaypal();
    } else {
      blockPay();
    }
  }

  function maybeMountPaypal(){
    if(state.paypalMounted) return;
    if(!window.paypal || !els.ppMount) return;
    if(!state.items.length || !state.deliveryOptionId) return;

    state.paypalMounted = true;
    paypal.Buttons({
      style: { layout:'vertical', shape:'rect', label:'paypal' },

      createOrder: async function(){
        var body = { deliveryOptionId: state.deliveryOptionId };
        var res = await fetch('/payment/create-order', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(body)
        });
        var data = await res.json();
        if(!res.ok || !data.id) throw new Error(data.message || 'Failed to create order');
        return data.id;
      },

      onApprove: async function(data){
        var res = await fetch('/payment/capture-order?orderId=' + encodeURIComponent(data.orderID), { method:'POST' });
        var out = await res.json();
        if(!res.ok) throw new Error(out.message || 'Failed to capture order');
        var orderId = out.orderId || data.orderID;
        window.location.href = '/payment/thank-you?orderId=' + encodeURIComponent(orderId);
      },

      onError: function(err){ toast('Payment error: ' + (err && err.message ? err.message : err)); }
    }).render('#paypal-buttons');
  }

  /* -------------------------------- Events/init ------------------------------ */
  document.getElementById('delivery-select').addEventListener('change', function(){
    applyDeliverySelection();
    maybeEnablePay();
  });

  (async function init(){
    await loadDeliveryOptions(); // DB only
    await loadCart();            // session cart
  })();

})();
</script>
