<!-- views/shipments/track-shipment.ejs -->
<section class="dashboard-home track-shipment">
  <h1 class="page-title">üì¶ <%= title || 'Track Your Shipment' %></h1>
  <p class="subtitle">Enter your Order ID or Tracking Number to view shipment progress.</p>

  <!-- üîé Search Form -->
  <form action="/shipments/track" method="POST" class="track-form" id="trkForm" data-prefill="<%= prefill || '' %>">
    <label for="trkQuery" class="sr-only">Order ID or Tracking Number</label>
    <input
      type="text"
      name="query"
      id="trkQuery"
      placeholder="Enter Order ID or Tracking Number"
      required
      inputmode="text"
      autocomplete="off"
    />
    <button type="submit" class="btn btn-primary">üîç Track</button>
  </form>

  <!-- ‚úÖ Flash Messages -->
  <% if (error && error.length > 0) { %>
    <div class="flash flash-error" id="flashMessage" role="alert" aria-live="assertive">‚ùå <%= error %></div>
  <% } %>
  <% if (success && success.length > 0) { %>
    <div class="flash flash-success" id="flashMessage" role="status" aria-live="polite">‚úÖ <%= success %></div>
  <% } %>

  <!-- üì¶ Product-level list (business/admin only route) -->
  <% if (typeof shipmentsByProduct !== 'undefined') { %>
    <div class="shipment-details">
      <h2 class="h-sub">Shipments for <%= (productForList && productForList.name) || 'Product' %></h2>

      <% if (!shipmentsByProduct || shipmentsByProduct.length === 0) { %>
        <p class="no-progress">No shipments for this product yet.</p>
      <% } else { %>
        <div class="table-container">
          <table class="shipments-table responsive-table">
            <thead>
              <tr>
                <th>Status</th>
                <th>Carrier</th>
                <th>Tracking #</th>
                <th>Order ID</th>
                <th>Updated</th>
              </tr>
            </thead>
            <tbody>
              <% shipmentsByProduct.forEach(s => { %>
                <tr>
                  <td data-label="Status">
                    <span class="badge <%= (s.status || '').toLowerCase().replace(/\s+/g,'-') %>"><%= s.status %></span>
                  </td>
                  <td data-label="Carrier"><div class="cell"><%= s.carrier || '‚Äî' %></div></td>
                  <td data-label="Tracking #"><span class="mono wrap"><%= s.trackingNumber || '‚Äî' %></span></td>
                  <td data-label="Order ID"><div class="cell"><%= s.orderId || '‚Äî' %></div></td>
                  <td data-label="Updated"><span class="muted"><%= new Date(s.updatedAt).toLocaleString() %></span></td>
                </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
      <% } %>
    </div>
  <% } %>

  <!-- üì¶ Single shipment details (from search) -->
  <% if (shipment) { %>
    <div class="shipment-details"
         id="shipRow"
         data-id="<%= shipment._id %>"
         data-status="<%= shipment.status || '' %>"
         data-carrier="<%= shipment.carrier || '' %>"
         data-trk="<%= shipment.trackingNumber || '' %>">
      <h2 class="h-sub">Shipment Details</h2>

      <div class="info-grid">
        <p data-label="Order ID"><strong>Order ID:</strong> <span class="mono"><%= shipment.orderId || '‚Äî' %></span></p>
        <p data-label="Product"><strong>Product:</strong> <%= shipment.product ? shipment.product.name : '‚Äî' %></p>
        <p data-label="Status">
          <strong>Status:</strong>
          <span class="badge <%= (shipment.status || '').toLowerCase().replace(/\s+/g,'-') %>"><%= shipment.status %></span>
        </p>
        <p data-label="Carrier"><strong>Carrier:</strong> <%= shipment.carrier || '‚Äî' %></p>
        <p data-label="Tracking #"><strong>Tracking #:</strong> <span class="mono wrap"><%= shipment.trackingNumber || '‚Äî' %></span></p>
        <p data-label="Supplier"><strong>Supplier:</strong> <%= shipment.business ? shipment.business.name : '‚Äî' %></p>
        <p data-label="Last Updated"><strong>Last Updated:</strong> <span class="muted"><%= new Date(shipment.updatedAt).toLocaleString() %></span></p>
      </div>

      <% if (canManage) { %>
        <!-- ‚ö° Quick Actions -->
        <div class="qa">
          <form method="POST" action="/shipments/update/<%= shipment._id %>" class="hidden quick-form" aria-hidden="true">
            <input type="hidden" name="status" value="">
            <input type="hidden" name="carrier" value="">
            <input type="hidden" name="trackingNumber" value="">
            <input type="hidden" name="note" value="">
          </form>

          <div class="qa-buttons" role="group" aria-label="Quick status actions">
            <button class="btn qa-btn qa-proc" data-act="Processing" type="button">Processing</button>
            <button class="btn qa-btn qa-transit" data-act="In Transit" type="button">In Transit</button>
            <button class="btn qa-btn qa-deliv" data-act="Delivered" type="button">Delivered</button>
            <button class="btn qa-btn qa-cancel" data-act="Canceled" type="button">Canceled</button>
          </div>
          <small class="muted">These actions are visible only to admins or business users.</small>
        </div>
      <% } %>

      <% if (shipment.history && shipment.history.length > 0) { %>
        <h3 class="h-sub">Progress History</h3>
        <ul class="history">
          <% shipment.history.forEach(h => { %>
            <li>
              <span class="status <%= (h.status || '').toLowerCase().replace(/\s+/g,'-') %>"><%= h.status %></span>
              <p class="note"><%= h.note || '' %></p>
              <small><%= new Date(h.at || h.timestamp).toLocaleString() %></small>
            </li>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="no-progress">No tracking updates yet.</p>
      <% } %>
    </div>
  <% } %>
</section>

<!-- üåà Scoped, MOBILE-FIRST Styles -->
<style nonce="<%= nonce %>">
  :root{
    --radius:12px;
    --gap:clamp(.55rem, 2.8vw, .8rem);
    --muted:#6b7280;
    --border:#e5e7eb;
  }

  .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;}

  .dashboard-home { padding: clamp(.75rem, 3vw, 1rem); max-width: 900px; margin: 0 auto; }
  .page-title { text-align: center; font-size: clamp(1.1rem, 4.2vw, 1.4rem); font-weight: 800; margin-bottom: .35rem; }
  .subtitle { text-align: center; color: var(--muted); margin-bottom: .9rem; font-size: clamp(.9rem, 3.5vw, .95rem); }

  /* Search form */
  .track-form {
    display: grid; grid-template-columns: minmax(0,1fr) max-content; gap: .5rem;
    max-width: 640px; margin: 0 auto .9rem;
  }
  .track-form input {
    padding: clamp(.55rem, 2.8vw, .7rem) clamp(.6rem, 2.8vw, .75rem);
    border-radius: 10px; border: 1px solid #d1d5db; font-size: clamp(.95rem, 3.6vw, 1rem);
    min-width: 0;
  }
  .btn.btn-primary {
    background: #2563eb; color: #fff; border: 1px solid #2563eb; border-radius: 10px;
    padding: clamp(.55rem, 2.8vw, .7rem) clamp(.8rem, 3.6vw, 1rem); font-weight: 700;
  }
  .btn.btn-primary:hover { filter: brightness(0.97); }

  /* Flash */
  .flash { max-width: 640px; margin: .7rem auto; padding: .65rem .85rem; border-radius: 10px; font-weight: 600; font-size: .95rem; text-align:center; }
  .flash-success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
  .flash-error { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }
  .flash.fade-out { opacity: 0; transform: translateY(-10px); transition: opacity .6s, transform .6s; }

  /* Cards */
  .shipment-details {
    background: #f9fafb; padding: clamp(.8rem, 3vw, 1rem); border-radius: 12px;
    max-width: 900px; margin: .7rem auto; box-shadow: 0 2px 6px rgba(0,0,0,.06);
    overflow-wrap:anywhere;
  }
  .h-sub { margin: 0 0 .5rem; font-size: clamp(1rem, 3.8vw, 1.15rem); font-weight: 700; }
  .info-grid {
    display: grid; grid-template-columns: minmax(0,1fr) minmax(0,1fr);
    gap: .6rem .8rem; margin-bottom: .6rem;
  }
  .no-progress { text-align: center; color: #9ca3af; font-style: italic; }

  /* Badges */
  .badge { padding: .25rem .5rem; border-radius: .6rem; color: #fff; font-weight: 700; text-transform: capitalize; font-size: .8rem; display: inline-block; }
  .badge.processing { background: #8b5cf6; }
  .badge.pending { background: #fbbf24; }
  .badge.in-transit { background: #3b82f6; }
  .badge.delivered { background: #16a34a; }
  .badge.canceled, .badge.cancelled { background: #dc2626; }

  .status { font-weight: 700; color: #2563eb; }
  .status.delivered { color: #16a34a; }
  .status.in-transit { color: #3b82f6; }
  .status.pending { color: #f59e0b; }
  .status.canceled, .status.cancelled { color: #dc2626; }

  .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
  .wrap { word-break: break-word; overflow-wrap: anywhere; }
  .muted { color: #6b7280; }

  /* Product-level list table */
  .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-top: .6rem; }
  .shipments-table { width: 100%; border-collapse: collapse; background: var(--table-bg, #fff); border-radius: .75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.08); }
  .shipments-table th, .shipments-table td { padding: .6rem .7rem; border-bottom: 1px solid #e5e7eb; text-align: left; vertical-align: top; }
  .shipments-table th { background: #f3f4f6; font-weight: 600; }
  .cell{ overflow-wrap:anywhere; }

  /* Quick actions */
  .qa { margin-top: .5rem; }
  .qa-buttons { display: flex; flex-wrap: wrap; gap: .35rem; }
  .qa-btn {
    padding: .45rem .65rem; border-radius: 10px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; font-weight: 700;
    font-size: clamp(.9rem, 3.4vw, .95rem);
  }
  .qa-proc { border-color: #a78bfa; }
  .qa-transit { border-color: #60a5fa; }
  .qa-deliv { border-color: #34d399; }
  .qa-cancel { border-color: #f87171; }

  /* Dark mode */
  .dark-theme .shipment-details { background: #1f2937; color: #f3f4f6; }
  .dark-theme .shipments-table { background: #1f2937; color: #f3f4f6; }
  .dark-theme .shipments-table th { background: #374151; }
  .dark-theme .qa-btn { background:#111827; color:#e5e7eb; border-color:#374151; }
  .dark-theme .flash-success { background: #064e3b; color: #d1fae5; }
  .dark-theme .flash-error { background: #7f1d1d; color: #fee2e2; }

  /* ======= MOBILE OPTIMIZATIONS (Hisense U50 Lite) ======= */
  /* earlier collapse & tighter paddings */
  @media (max-width: 600px) {
    .dashboard-home { padding: .75rem; width: 100%; }
    .track-form { grid-template-columns: minmax(0,1fr); }
    .btn.btn-primary { width: 100%; }

    .info-grid { grid-template-columns: minmax(0,1fr); }

    /* Responsive table ‚Üí cards */
    .responsive-table thead { display: none; }
    .responsive-table, .responsive-table tbody, .responsive-table tr, .responsive-table td { display: block; width: 100%; }
    .responsive-table tr {
      background: var(--table-bg, #fff); border: 1px solid var(--border); border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06); padding: .6rem .65rem; margin-bottom: .6rem;
    }
    .responsive-table td { border: none; padding: .35rem 0; }
    .responsive-table td[data-label]::before {
      content: attr(data-label); display: block; font-size: .78rem; color: #6b7280; margin-bottom: .1rem;
    }
  }

  /* Ultra-small (‚âà320‚Äì360px) */
  @media (max-width: 360px) {
    .page-title { font-size: 1.08rem; }
    .track-form input { font-size: .95rem; padding: .55rem .6rem; }
    .btn, .qa-btn { padding: .5rem .6rem; font-size: .92rem; }
    .qa-buttons { gap: .4rem; }
    .qa-btn { flex: 1 1 100%; }
  }
</style>

<!-- ‚úÖ CSP-Safe Inline Script -->
<script nonce="<%= nonce %>">
document.addEventListener("DOMContentLoaded", () => {
  // Flash fade
  const flash = document.getElementById("flashMessage");
  if (flash) {
    setTimeout(() => {
      flash.classList.add("fade-out");
      setTimeout(() => flash.remove(), 600);
    }, 5000);
  }

  // Prefill track query if provided
  const trkForm = document.getElementById('trkForm');
  if (trkForm) {
    const prefill = trkForm.getAttribute('data-prefill') || '';
    if (prefill) document.getElementById('trkQuery').value = prefill;
  }

  // Quick actions (admins/business only)
  const container = document.getElementById('shipRow');
  if (!container) return;

  container.addEventListener('click', (ev) => {
    const btn = ev.target.closest('.qa-btn');
    if (!btn) return;

    const act = btn.getAttribute('data-act');
    const qf = container.querySelector('form.quick-form');
    if (!qf) return;

    const inStatus = qf.querySelector('input[name="status"]');
    const inCarrier = qf.querySelector('input[name="carrier"]');
    const inTrk = qf.querySelector('input[name="trackingNumber"]');
    const inNote = qf.querySelector('input[name="note"]');

    let carrier = container.getAttribute('data-carrier') || '';
    let trk = container.getAttribute('data-trk') || '';

    if (act === 'In Transit') {
      if (!carrier) carrier = prompt('Enter carrier (e.g., DHL, FedEx, USPS):', carrier || '') || '';
      if (!trk) trk = prompt('Enter tracking number:', trk || '') || '';
    }

    let note = '';
    if (act === 'Processing') note = 'Marked Processing';
    if (act === 'In Transit') note = 'Marked In Transit';
    if (act === 'Delivered') note = 'Marked Delivered';
    if (act === 'Canceled') note = 'Shipment canceled';

    inStatus.value = act;
    inCarrier.value = carrier;
    inTrk.value = trk;
    inNote.value = note;

    qf.submit();
  });
});
</script>
