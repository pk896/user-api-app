<!-- views/business-change-password.ejs-->
<!-- views/business-change-password.ejs -->
<section class="change-password-container">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-back">
      <a href="/business/profile" class="back-btn" aria-label="Back to profile">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M19 12H5M5 12L12 19M5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </a>
    </div>
    <div class="header-content">
      <h1 class="page-title">
        <span class="icon-wrapper">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 7H16C17.3261 7 18.5979 7.52678 19.5355 8.46447C20.4732 9.40215 21 10.6739 21 12C21 13.3261 20.4732 14.5979 19.5355 15.5355C18.5979 16.4732 17.3261 17 16 17H15" stroke="#7C3AED" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9 17H8C6.67392 17 5.40215 16.4732 4.46447 15.5355C3.52678 14.5979 3 13.3261 3 12C3 10.6739 3.52678 9.40215 4.46447 8.46447C5.40215 7.52678 6.67392 7 8 7H9" stroke="#7C3AED" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M9 12H15" stroke="#7C3AED" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
        Change Password
      </h1>
      <p class="page-subtitle">Update your account security settings</p>
    </div>
  </div>

  <!-- Flash Messages -->
  <div class="flash-messages">
    <% (success || []).forEach(msg => { %>
      <div class="flash-message success">
        <div class="flash-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.85999" stroke="#22C55E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 4L12 14.01L9 11.01" stroke="#22C55E" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="flash-content">
          <strong>Success!</strong> <%= msg %>
        </div>
      </div>
    <% }) %>
    
    <% (error || []).forEach(msg => { %>
      <div class="flash-message error">
        <div class="flash-icon">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 9V11M12 15H12.01M21 12C21 13.1819 20.7672 14.3522 20.3149 15.4442C19.8626 16.5361 19.1997 17.5282 18.364 18.364C17.5282 19.1997 16.5361 19.8626 15.4442 20.3149C14.3522 20.7672 13.1819 21 12 21C10.8181 21 9.64778 20.7672 8.55585 20.3149C7.46392 19.8626 6.47177 19.1997 5.63604 18.364C4.80031 17.5282 4.13738 16.5361 3.68508 15.4442C3.23279 14.3522 3 13.1819 3 12C3 9.61305 3.94821 7.32387 5.63604 5.63604C7.32387 3.94821 9.61305 3 12 3C14.3869 3 16.6761 3.94821 18.364 5.63604C20.0518 7.32387 21 9.61305 21 12Z" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="flash-content">
          <strong>Attention needed:</strong> <%= msg %>
        </div>
      </div>
    <% }) %>
  </div>

  <!-- Password Requirements -->
  <div class="requirements-card">
    <h3 class="requirements-title">Password Requirements</h3>
    <ul class="requirements-list">
      <li class="requirement-item">
        <span class="requirement-icon">‚úì</span>
        <span>At least 6 characters long</span>
      </li>
      <li class="requirement-item">
        <span class="requirement-icon">‚úì</span>
        <span>Include letters and numbers</span>
      </li>
      <li class="requirement-item">
        <span class="requirement-icon">‚úì</span>
        <span>Avoid common passwords</span>
      </li>
    </ul>
  </div>

  <!-- Change Password Form -->
  <form action="/business/change-password" method="post" class="change-password-form">
    <!-- Current Password -->
    <div class="form-group">
      <label class="form-label">
        <span class="label-text">Current Password</span>
        <div class="password-input-group">
          <input
            id="current-password"
            type="password"
            name="current"
            required
            autocomplete="current-password"
            placeholder="Enter your current password"
            class="form-input"
          />
          <button
            type="button"
            class="password-toggle"
            data-target="current-password"
            aria-label="Toggle password visibility"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="input-hint">Enter the password you're currently using</div>
      </label>
    </div>

    <!-- New Password -->
    <div class="form-group">
      <label class="form-label">
        <span class="label-text">New Password</span>
        <div class="password-input-group">
          <input
            id="new-password"
            type="password"
            name="next"
            required
            minlength="6"
            autocomplete="new-password"
            placeholder="Create a strong password"
            class="form-input"
          />
          <button
            type="button"
            class="password-toggle"
            data-target="new-password"
            aria-label="Toggle password visibility"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="password-strength">
          <div class="strength-meter">
            <div class="strength-fill" id="strength-fill"></div>
          </div>
          <span class="strength-text" id="strength-text">Password strength</span>
        </div>
      </label>
    </div>

    <!-- Confirm Password -->
    <div class="form-group">
      <label class="form-label">
        <span class="label-text">Confirm New Password</span>
        <div class="password-input-group">
          <input
            id="confirm-password"
            type="password"
            name="confirm"
            required
            minlength="6"
            autocomplete="new-password"
            placeholder="Re-enter your new password"
            class="form-input"
          />
          <button
            type="button"
            class="password-toggle"
            data-target="confirm-password"
            aria-label="Toggle password visibility"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </div>
        <div class="input-hint" id="match-hint">Passwords must match</div>
      </label>
    </div>

    <!-- Action Buttons -->
    <div class="form-actions">
      <button type="button" class="btn btn-secondary" onclick="window.history.back()">
        Cancel
      </button>
      <button type="submit" class="btn btn-primary" id="submit-btn" disabled>
        <span class="btn-text">Update Password</span>
        <span class="btn-loader" id="btn-loader">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2V6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 18V22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M4.93 4.93L7.76 7.76" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16.24 16.24L19.07 19.07" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M2 12H6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M18 12H22" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M4.93 19.07L7.76 16.24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16.24 7.76L19.07 4.93" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </span>
      </button>
    </div>
  </form>

  <!-- Security Tips -->
  <div class="security-tips">
    <h3 class="tips-title">üîê Security Tips</h3>
    <div class="tips-grid">
      <div class="tip-card">
        <div class="tip-icon">üîÑ</div>
        <div class="tip-content">
          <strong>Regular Updates</strong>
          <p>Change your password every 90 days</p>
        </div>
      </div>
      <div class="tip-card">
        <div class="tip-icon">üö´</div>
        <div class="tip-content">
          <strong>Avoid Reuse</strong>
          <p>Don't use the same password across sites</p>
        </div>
      </div>
      <div class="tip-card">
        <div class="tip-icon">üîë</div>
        <div class="tip-content">
          <strong>Password Manager</strong>
          <p>Consider using a password manager</p>
        </div>
      </div>
    </div>
  </div>
</section>

<style nonce="<%= nonce %>">
  /* Base Styles */
  .change-password-container {
    max-width: 440px;
    margin: 0 auto;
    padding: 16px 20px 40px;
    background: #ffffff;
    min-height: 100vh;
  }

  /* Header */
  .page-header {
    margin-bottom: 24px;
    position: relative;
  }

  .header-back {
    position: absolute;
    left: 0;
    top: 0;
  }

  .back-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: #f1f5f9;
    color: #0F172A;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .back-btn:hover {
    background: #e2e8f0;
    transform: translateX(-2px);
  }

  .header-content {
    text-align: center;
    padding: 0 40px;
  }

  .icon-wrapper {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #2563EB20, #7C3AED20);
    border-radius: 12px;
    margin-right: 12px;
    vertical-align: middle;
  }

  .page-title {
    font-size: 24px;
    font-weight: 700;
    color: #0F172A;
    margin: 0 0 8px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .page-subtitle {
    font-size: 14px;
    color: #64748b;
    margin: 0;
  }

  /* Flash Messages */
  .flash-messages {
    margin-bottom: 24px;
  }

  .flash-message {
    padding: 16px;
    border-radius: 12px;
    margin-bottom: 12px;
    display: flex;
    align-items: flex-start;
    gap: 12px;
    animation: slideIn 0.3s ease;
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .flash-message.success {
    background: #22C55E10;
    border: 1px solid #22C55E30;
  }

  .flash-message.error {
    background: #ef444410;
    border: 1px solid #ef444430;
  }

  .flash-icon {
    flex-shrink: 0;
    margin-top: 2px;
  }

  .flash-content {
    flex: 1;
    font-size: 14px;
  }

  .flash-content strong {
    display: block;
    margin-bottom: 4px;
  }

  /* Requirements Card */
  .requirements-card {
    background: #2563EB08;
    border: 1px solid #2563EB20;
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 24px;
  }

  .requirements-title {
    font-size: 16px;
    font-weight: 600;
    color: #2563EB;
    margin: 0 0 16px;
  }

  .requirements-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: grid;
    gap: 12px;
  }

  .requirement-item {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    color: #475569;
  }

  .requirement-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: #22C55E;
    color: white;
    border-radius: 50%;
    font-size: 12px;
    font-weight: bold;
  }

  /* Form */
  .change-password-form {
    background: #ffffff;
    border: 1px solid #e2e8f0;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 32px;
    box-shadow: 0 4px 12px rgba(15, 23, 42, 0.04);
  }

  .form-group {
    margin-bottom: 24px;
  }

  .form-label {
    display: block;
  }

  .label-text {
    display: block;
    font-size: 14px;
    font-weight: 600;
    color: #0F172A;
    margin-bottom: 8px;
  }

  .password-input-group {
    position: relative;
  }

  .form-input {
    width: 100%;
    padding: 14px 48px 14px 16px;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-size: 16px;
    color: #0F172A;
    background: #ffffff;
    transition: all 0.2s ease;
  }

  .form-input:focus {
    outline: none;
    border-color: #2563EB;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
  }

  .form-input::placeholder {
    color: #94a3b8;
  }

  .password-toggle {
    position: absolute;
    right: 14px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    padding: 4px;
    cursor: pointer;
    color: #2563EB;
    transition: color 0.2s ease;
  }

  .password-toggle:hover {
    color: #1d4ed8;
  }

  .input-hint {
    font-size: 12px;
    color: #64748b;
    margin-top: 8px;
    min-height: 18px;
  }

  /* Password Strength */
  .password-strength {
    margin-top: 12px;
  }

  .strength-meter {
    height: 6px;
    background: #e2e8f0;
    border-radius: 3px;
    overflow: hidden;
    margin-bottom: 8px;
  }

  .strength-fill {
    height: 100%;
    width: 0%;
    background: #e2e8f0;
    border-radius: 3px;
    transition: all 0.3s ease;
  }

  .strength-text {
    font-size: 12px;
    color: #64748b;
  }

  /* Form Actions */
  .form-actions {
    display: flex;
    gap: 12px;
    margin-top: 32px;
  }

  .btn {
    flex: 1;
    padding: 16px 24px;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .btn-primary {
    background: linear-gradient(135deg, #2563EB, #7C3AED);
    color: white;
  }

  .btn-primary:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
  }

  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  .btn-secondary {
    background: #f1f5f9;
    color: #475569;
  }

  .btn-secondary:hover {
    background: #e2e8f0;
  }

  .btn-loader {
    display: none;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    100% {
      transform: rotate(360deg);
    }
  }

  .btn.loading .btn-text {
    opacity: 0.7;
  }

  .btn.loading .btn-loader {
    display: block;
  }

  /* Security Tips */
  .security-tips {
    background: #22C55E08;
    border: 1px solid #22C55E20;
    border-radius: 16px;
    padding: 24px;
  }

  .tips-title {
    font-size: 18px;
    font-weight: 700;
    color: #0F172A;
    margin: 0 0 20px;
    text-align: center;
  }

  .tips-grid {
    display: grid;
    gap: 16px;
  }

  .tip-card {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 16px;
    background: white;
    border-radius: 12px;
    border: 1px solid #e2e8f0;
  }

  .tip-icon {
    font-size: 20px;
    flex-shrink: 0;
  }

  .tip-content {
    flex: 1;
  }

  .tip-content strong {
    display: block;
    font-size: 14px;
    color: #0F172A;
    margin-bottom: 4px;
  }

  .tip-content p {
    font-size: 12px;
    color: #64748b;
    margin: 0;
  }

  /* Responsive Design */
  @media (max-width: 480px) {
    .change-password-container {
      padding: 16px;
    }
    
    .page-title {
      font-size: 20px;
    }
    
    .change-password-form {
      padding: 20px;
    }
    
    .form-actions {
      flex-direction: column;
    }
    
    .btn {
      width: 100%;
    }
    
    .tips-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Hisense U50 Lite specific optimization (390px width) */
  @media (max-width: 390px) {
    .change-password-container {
      padding: 12px;
    }
    
    .page-title {
      font-size: 18px;
      flex-direction: column;
      gap: 8px;
    }
    
    .icon-wrapper {
      margin-right: 0;
    }
    
    .form-input {
      font-size: 14px;
      padding: 12px 44px 12px 12px;
    }
    
    .btn {
      padding: 14px 20px;
      font-size: 14px;
    }
  }
</style>

<script nonce="<%= nonce %>">
  document.addEventListener('DOMContentLoaded', function() {
    // Password toggle functionality
    const toggleButtons = document.querySelectorAll('.password-toggle');
    toggleButtons.forEach(button => {
      button.addEventListener('click', function() {
        const targetId = this.getAttribute('data-target');
        const input = document.getElementById(targetId);
        const icon = this.querySelector('svg');
        
        if (input.type === 'password') {
          input.type = 'text';
          icon.innerHTML = `
            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M1 1l22 22" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          `;
        } else {
          input.type = 'password';
          icon.innerHTML = `
            <path d="M1 12C1 12 5 4 12 4C19 4 23 12 23 12C23 12 19 20 12 20C5 20 1 12 1 12Z" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          `;
        }
      });
    });

    // Password strength checker
    const newPasswordInput = document.getElementById('new-password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const strengthFill = document.getElementById('strength-fill');
    const strengthText = document.getElementById('strength-text');
    const matchHint = document.getElementById('match-hint');
    const submitBtn = document.getElementById('submit-btn');

    function checkPasswordStrength(password) {
      let strength = 0;
      
      // Length check
      if (password.length >= 8) strength += 25;
      if (password.length >= 12) strength += 10;
      
      // Complexity checks
      if (/[A-Z]/.test(password)) strength += 20;
      if (/[a-z]/.test(password)) strength += 10;
      if (/[0-9]/.test(password)) strength += 20;
      if (/[^A-Za-z0-9]/.test(password)) strength += 25;
      
      // Update UI
      strengthFill.style.width = `${Math.min(strength, 100)}%`;
      
      if (strength < 40) {
        strengthFill.style.background = '#ef4444';
        strengthText.textContent = 'Weak password';
      } else if (strength < 70) {
        strengthFill.style.background = '#f59e0b';
        strengthText.textContent = 'Fair password';
      } else if (strength < 90) {
        strengthFill.style.background = '#2563EB';
        strengthText.textContent = 'Good password';
      } else {
        strengthFill.style.background = '#22C55E';
        strengthText.textContent = 'Strong password';
      }
    }

    function validatePasswords() {
      const newPassword = newPasswordInput.value;
      const confirmPassword = confirmPasswordInput.value;
      
      // Check if passwords match
      if (newPassword && confirmPassword) {
        if (newPassword === confirmPassword) {
          matchHint.textContent = 'Passwords match ‚úì';
          matchHint.style.color = '#22C55E';
        } else {
          matchHint.textContent = 'Passwords do not match ‚úó';
          matchHint.style.color = '#ef4444';
        }
      } else {
        matchHint.textContent = 'Passwords must match';
        matchHint.style.color = '#64748b';
      }
      
      // Enable/disable submit button
      const isValid = newPassword.length >= 6 && 
                     confirmPassword.length >= 6 && 
                     newPassword === confirmPassword;
      
      submitBtn.disabled = !isValid;
    }

    newPasswordInput.addEventListener('input', function() {
      checkPasswordStrength(this.value);
      validatePasswords();
    });

    confirmPasswordInput.addEventListener('input', validatePasswords);

    // Form submission handler
    const form = document.querySelector('.change-password-form');
    form.addEventListener('submit', function(e) {
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = newPasswordInput.value;
      
      if (newPassword === currentPassword) {
        e.preventDefault();
        alert('New password must be different from current password');
        return;
      }
      
      // Show loading state
      submitBtn.classList.add('loading');
      submitBtn.disabled = true;
      
      // Form will submit normally
    });

    // Initialize
    validatePasswords();
  });
</script>
