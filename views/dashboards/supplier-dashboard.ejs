 <!-- views/dashboards/supplier-dashboard.ejs -->
<section class="dashboard supplier">
  <h1 class="page-title">
    üëã Welcome, <%= (business && business.name) || 'Supplier' %>!
    <span class="role-badge supplier">SUPPLIER</span>
  </h1>
  <p class="subtitle">
    Manage your catalog efficiently. Delivery and refunds are managed centrally by company operations.
  </p>

  <% (success || []).forEach(msg => { %>
    <div class="flash flash-success">‚úÖ <%= msg %></div>
  <% }) %>
  <% (error || []).forEach(msg => { %>
    <div class="flash flash-error">‚ùå <%= msg %></div>
  <% }) %>

  <%
    // ---- Helpers & safe fallbacks ----
    function fmtDate(d) {
      try {
        if (!d) return '';
        const dd = (d instanceof Date) ? d : new Date(d);
        return dd.toLocaleString('en-ZA', {
          timeZone: 'Africa/Johannesburg',
          dateStyle: 'medium',
          timeStyle: 'short'
        });
      } catch { return String(d); }
    }

    const computedInStock =
      Array.isArray(products)
        ? products.filter(p => Number(p && p.stock || 0) > 0).length
        : 0;

    const supplierTotals = totals || {};
    const supplierKpis = kpis || {};

    const perProduct = (supplierKpis && Array.isArray(supplierKpis.perProduct))
      ? supplierKpis.perProduct
      : [];

    // Best-selling categories from per-product stats
    const categoryStats = {};
    perProduct.forEach(p => {
      const cat = p.category || 'Uncategorised';
      if (!categoryStats[cat]) {
        categoryStats[cat] = { qty: 0, revenue: 0 };
      }
      categoryStats[cat].qty += Number(p.qty || 0);
      categoryStats[cat].revenue += Number(p.estRevenue || 0);
    });
    const categoryEntries = Object.entries(categoryStats)
      .sort((a, b) => b[1].qty - a[1].qty);

    const recentProducts = Array.isArray(products) ? products.slice(0, 5) : [];
    const recentOrders = (orders && Array.isArray(orders.recent))
      ? orders.recent
      : [];
  %>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <span class="pill pill-mail">
        üìß Mail
        <span class="status-dot <%= mailerOk ? 'ok' : 'down' %>"></span>
        <span class="status-text"><%= mailerOk ? 'OK' : 'Down' %></span>
      </span>
      <span class="muted small hide-sm">
        Logged in as <strong><%= (business && business.email) || '-' %></strong>
      </span>
    </div>
    <div class="toolbar-right">
      <a class="btn xs light" href="/contact">üì® Contact Support</a>
      <a class="btn xs light" href="/products/all">üìã All Products</a>
      <form action="/business/logout" method="post" class="logout-form">
        <button type="submit" class="btn xs danger">üö™ Logout</button>
      </form>
    </div>
  </div>

  <!-- KPIs -->
  <section class="kpi-grid">
    <div class="kpi-card">
      <h2>üõçÔ∏è Total Products</h2>
      <p class="kpi-num" data-kpi="totalProducts">
        <%= supplierTotals.totalProducts || 0 %>
      </p>
    </div>

    <div class="kpi-card">
      <h2>üì¶ Total Stock</h2>
      <p class="kpi-num" data-kpi="totalStock">
        <%= supplierTotals.totalStock || 0 %>
      </p>
    </div>

    <div class="kpi-card">
      <h2>‚úÖ In Stock</h2>
      <p class="kpi-num" data-kpi="inStock">
        <%= (supplierTotals.inStock != null ? supplierTotals.inStock : computedInStock) %>
      </p>
    </div>

    <div class="kpi-card">
      <h2>‚ö†Ô∏è Low Stock (‚â§10)</h2>
      <p class="kpi-num warn" data-kpi="lowStock">
        <%= supplierTotals.lowStock || 0 %>
      </p>
    </div>

    <div class="kpi-card">
      <h2>‚ùå Out of Stock</h2>
      <p class="kpi-num danger" data-kpi="outOfStock">
        <%= supplierTotals.outOfStock || 0 %>
      </p>
    </div>

    <div class="kpi-card">
      <h2>üßæ Sold (30d)</h2>
      <p class="kpi-num" data-kpi="soldLast30">
        <%= supplierKpis.soldLast30 || supplierKpis.last30Items || 0 %>
      </p>
    </div>

    <div class="kpi-card">
      <h2>üí∞ Revenue (30d)</h2>
      <p class="kpi-num revenue" data-kpi="revenueLast30">
        R <%= Number(supplierKpis.revenueLast30 || supplierKpis.last30Revenue || 0).toFixed(2) %>
      </p>
    </div>
  </section>

  <!-- Quick actions -->
  <div class="actions-row">
    <a class="btn primary" href="/products/add">‚ûï Add Product</a>
    <a class="btn light" href="/orders">üìö My Orders</a>
    <a class="btn light" href="/shipments">üöö Shipments</a>
  </div>

  <!-- Top products (30d) + best-selling categories -->
  <section class="layout-grid">
    <div class="block">
      <div class="block-head">
        <h3>üìà Top Products (30 days)</h3>
        <span class="chip chip-soft">sales snapshot</span>
      </div>

      <div class="mini-kpis">
        <div class="mini-card">
          <div class="mini-title">üßÆ Total Qty Sold</div>
          <div class="mini-num" data-kpi="soldLast30">
            <%= supplierKpis.soldLast30 || supplierKpis.last30Items || 0 %>
          </div>
        </div>
        <div class="mini-card">
          <div class="mini-title">üí∏ Est. Revenue</div>
          <div class="mini-num" data-kpi="revenueLast30">
            R <%= Number(supplierKpis.revenueLast30 || supplierKpis.last30Revenue || 0).toFixed(2) %>
          </div>
        </div>
      </div>

      <div class="table-wrap">
        <table class="nice-table compact">
          <thead>
            <tr>
              <th>Product</th>
              <th class="right">Qty</th>
              <th class="right">Est. Revenue (R)</th>
            </tr>
          </thead>
          <tbody>
            <% if (perProduct.length) { %>
              <% perProduct.forEach(p => { %>
                <tr>
                  <td class="cell-product">
                    <% if (p.imageUrl) { %>
                      <img src="<%= p.imageUrl %>" alt="" class="thumb">
                    <% } %>
                    <div class="prod-meta">
                      <div class="name"><%= p.name %></div>
                      <% if (p.category) { %>
                        <div class="cat"><%= p.category %></div>
                      <% } %>
                    </div>
                  </td>
                  <td class="right"><%= p.qty %></td>
                  <td class="right"><%= Number(p.estRevenue || 0).toFixed(2) %></td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="3" class="muted center">
                  No sales recorded in the last 30 days yet.
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <div class="block">
      <div class="block-head">
        <h3>üè∑Ô∏è Best-selling Categories</h3>
        <span class="chip chip-soft orange">last 30 days</span>
      </div>

      <div class="chips-list">
        <% if (categoryEntries.length) { %>
          <% categoryEntries.forEach(([cat, stats]) => { %>
            <span class="chip pill-cat">
              <strong><%= cat %></strong>
              ‚Ä¢ <%= stats.qty %> sold
              ‚Ä¢ R <%= Number(stats.revenue || 0).toFixed(2) %>
            </span>
          <% }) %>
        <% } else { %>
          <p class="muted small">
            Once you start selling, your best categories will appear here.
          </p>
        <% } %>
      </div>

      <hr class="divider">

      <div class="block-head small-head">
        <h3>üßæ Recent Orders</h3>
        <span class="tag">
          Total: <strong><%= (orders && orders.total) || 0 %></strong>
        </span>
      </div>

      <div class="table-wrap small">
        <table class="nice-table compact responsive">
          <thead>
            <tr>
              <th>Order ID</th>
              <th class="right">Amount (R)</th>
              <th>Status</th>
              <th class="right">Created</th>
            </tr>
          </thead>
          <tbody>
            <% if (recentOrders.length) { %>
              <% recentOrders.forEach(o => { %>
                <tr>
                  <td data-label="Order ID">
                    <%= o.orderId || o._id %>
                  </td>

                  <td class="right" data-label="Amount (R)">
                    <%= Number(o.amount && o.amount.value || 0).toFixed(2) %>
                  </td>

                  <td data-label="Status">
                    <span class="status-pill status-<%= (o.status || 'Unknown').toLowerCase().replace(/\s+/g,'-') %>">
                      <%= o.status || 'Unknown' %>
                    </span>
                  </td>

                  <td class="right" data-label="Created">
                    <%= fmtDate(o.createdAt) %>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="4" class="muted center">
                  No recent orders yet.
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Recent products list -->
  <section class="block">
    <div class="block-head">
      <h3>üßæ Recent Products</h3>
      <div class="block-actions">
        <a href="/products/add" class="btn xs primary">‚ûï Add</a>
        <a href="/products/all" class="btn xs light">üìã View All</a>
      </div>
    </div>

    <% if (recentProducts.length) { %>
    <div class="table-wrap small">
      <table class="nice-table compact responsive">
        <thead>
          <tr>
            <th>Product</th>
            <th class="right">Price (R)</th>
            <th class="right">Stock</th>
            <th>Category</th>
            <th class="right">Updated</th>
          </tr>
        </thead>
        <tbody>
          <% recentProducts.forEach(p => { const s = Number(p.stock || 0); %>
            <tr>
              <td class="cell-product" data-label="Product">
                <% if (p.imageUrl) { %>
                  <img src="<%= p.imageUrl %>" alt="" class="thumb">
                <% } %>
                <div class="prod-meta">
                  <div class="name"><%= p.name %></div>
                  <div class="cat small-muted">ID: <%= p.customId %></div>
                </div>
              </td>

              <td class="right" data-label="Price (R)">
                R <%= Number(p.price || 0).toFixed(2) %>
              </td>

              <td class="right" data-label="Stock">
                <span class="stock-badge <%= s<=0 ? 'empty' : (s<=10 ? 'low' : 'ok') %>">
                  <%= s %>
                </span>
              </td>

              <td data-label="Category">
                <%= p.category || '‚Äî' %>
              </td>

              <td class="right" data-label="Updated">
                <%= fmtDate(p.updatedAt || p.createdAt) %>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
    <% } else { %>
      <p class="muted small">
        No products yet. Start by adding your first one.
      </p>
    <% } %>
  </section>
</section>

<style nonce="<%= nonce %>">
  .dashboard.supplier {
    padding: 1rem;
    max-width: 1100px;
    margin: 0 auto 2rem;
  }
  .page-title {
    margin-top: .4rem;
    font-size: 1.6rem;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: .5rem;
    justify-content: center;
  }
  .subtitle {
    text-align: center;
    margin: .2rem 0 1rem;
    color: #6b7280;
  }
  .dark-theme .subtitle { color: #cbd5e1; }

  .role-badge.supplier {
    padding: .2rem .6rem;
    border-radius: 999px;
    font-size: .75rem;
    font-weight: 700;
    background: #dcfce7;
    color: #166534;
    border: 1px solid #86efac;
  }

  .flash {
    padding: .6rem .9rem;
    border-radius: .6rem;
    margin: .4rem auto;
    max-width: 700px;
    font-weight: 600;
  }
  .flash-success {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #86efac;
  }
  .flash-error {
    background: #fee2e2;
    color: #b91c1c;
    border: 1px solid #fecaca;
  }

  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: .7rem;
    margin: .4rem 0 1rem;
    flex-wrap: wrap;
  }
  .toolbar-left, .toolbar-right {
    display: flex;
    align-items: center;
    gap: .5rem;
    flex-wrap: wrap;
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    padding: .25rem .6rem;
    border-radius: 999px;
    font-size: .8rem;
    font-weight: 600;
    background: #eef2ff;
    color: #3730a3;
    border: 1px solid #c7d2fe;
  }
  .status-dot {
    width: .45rem;
    height: .45rem;
    border-radius: 999px;
  }
  .status-dot.ok { background: #22c55e; }
  .status-dot.down { background: #ef4444; }
  .status-text { font-weight: 700; font-size: .78rem; }
  .muted { color: #6b7280; }
  .muted.small { font-size: .82rem; }
  .small-muted { font-size: .78rem; color: #94a3b8; }
  .dark-theme .muted { color: #9ca3af; }

  .logout-form { margin: 0; }

  /* KPIs */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: .8rem;
    margin: .8rem 0 1rem;
  }
  .kpi-card {
    background: #ffffff;
    border-radius: .75rem;
    padding: .8rem;
    border: 1px solid rgba(148, 163, 184, .25);
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
    text-align: center;
  }
  .dark-theme .kpi-card {
    background: #020617;
    border-color: #1f2937;
  }
  .kpi-card h2 {
    font-size: .9rem;
    margin-bottom: .25rem;
    color: #0f172a;
  }
  .dark-theme .kpi-card h2 { color: #e5e7eb; }
  .kpi-num {
    font-size: 1.4rem;
    font-weight: 800;
    color: #2563eb;
  }
  .kpi-num.warn { color: #ea580c; }
  .kpi-num.danger { color: #b91c1c; }
  .kpi-num.revenue { color: #16a34a; }

  .actions-row {
    display: flex;
    flex-wrap: wrap;
    gap: .6rem;
    margin-bottom: 1rem;
    justify-content: center;
  }

  /* Blocks & layout */
  .layout-grid {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 2fr);
    gap: 1rem;
    margin-bottom: 1.1rem;
  }
  @media (max-width: 800px) {
    .layout-grid { grid-template-columns: minmax(0,1fr); }
    .toolbar { flex-direction: column; align-items: flex-start; }
    .hide-sm { display: none; }
  }

  .block {
    background: #ffffff;
    border-radius: .9rem;
    padding: .9rem;
    border: 1px solid rgba(148, 163, 184, .2);
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
    margin-bottom: 1rem;
  }
  .dark-theme .block {
    background: #020617;
    border-color: #1f2937;
  }
  .block-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .6rem;
    margin-bottom: .5rem;
  }
  .block-head h3 {
    font-size: 1.02rem;
    font-weight: 700;
  }
  .block-actions {
    display: flex;
    gap: .4rem;
    flex-wrap: wrap;
  }
  .small-head h3 { font-size: .95rem; }
  .divider {
    border: none;
    border-top: 1px dashed rgba(148, 163, 184, .5);
    margin: .7rem 0;
  }

  .mini-kpis {
    display: flex;
    gap: .6rem;
    flex-wrap: wrap;
    margin-bottom: .6rem;
  }
  .mini-card {
    flex: 0 0 auto;
    min-width: 140px;
    padding: .55rem .7rem;
    border-radius: .7rem;
    background: #f1f5f9;
    border: 1px solid rgba(148, 163, 184, .4);
  }
  .dark-theme .mini-card {
    background: #020617;
    border-color: #1f2937;
  }
  .mini-title {
    font-size: .8rem;
    color: #64748b;
  }
  .mini-num {
    margin-top: .1rem;
    font-weight: 700;
    font-size: 1.1rem;
  }

  .table-wrap {
    overflow-x: auto;
    border-radius: .75rem;
    border: 1px solid rgba(148, 163, 184, .3);
    background: #ffffff;
  }
  .table-wrap.small { border-radius: .7rem; }
  .dark-theme .table-wrap {
    background: #020617;
    border-color: #1f2937;
  }

  .nice-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .9rem;
  }
  .nice-table thead th {
    padding: .55rem .6rem;
    background: #f8fafc;
    text-align: left;
    border-bottom: 1px solid rgba(148, 163, 184, .3);
    white-space: nowrap;
  }
  .dark-theme .nice-table thead th {
    background: #020617;
    border-bottom-color: #1f2937;
  }
  .nice-table td {
    padding: .5rem .6rem;
    border-bottom: 1px solid rgba(148, 163, 184, .2);
  }
  .nice-table tbody tr:last-child td {
    border-bottom: none;
  }
  .center { text-align: center; }
  .right { text-align: right; }

  .cell-product {
    display: flex;
    align-items: center;
    gap: .55rem;
    min-width: 0;
  }
  .thumb {
    width: 36px;
    height: 36px;
    border-radius: .45rem;
    object-fit: cover;
    flex-shrink: 0;
    border: 1px solid rgba(148, 163, 184, .4);
  }
  .prod-meta .name {
    font-weight: 600;
    font-size: .9rem;
  }
  .prod-meta .cat {
    font-size: .8rem;
    color: #6b7280;
  }

  .chips-list {
    display: flex;
    flex-wrap: wrap;
    gap: .4rem;
  }
  .chip {
    display: inline-flex;
    align-items: center;
    gap: .25rem;
    padding: .2rem .6rem;
    border-radius: 999px;
    font-size: .78rem;
    border: 1px solid rgba(148, 163, 184, .4);
    background: #f9fafb;
    color: #111827;
  }
  .chip-soft {
    background: #e0f2fe;
    color: #075985;
    border-color: #bae6fd;
  }
  .chip-soft.orange {
    background: #fef3c7;
    color: #92400e;
    border-color: #fde68a;
  }
  .pill-cat {
    background: #eef2ff;
    color: #3730a3;
    border-color: #c7d2fe;
  }

  .tag {
    font-size: .8rem;
    padding: .15rem .45rem;
    border-radius: 999px;
    background: #eff6ff;
    color: #1d4ed8;
  }

  .stock-badge {
    font-size: .8rem;
    font-weight: 700;
    padding: .18rem .5rem;
    border-radius: .6rem;
  }
  .stock-badge.ok {
    background: #dcfce7;
    color: #166534;
  }
  .stock-badge.low {
    background: #fef9c3;
    color: #92400e;
  }
  .stock-badge.empty {
    background: #fee2e2;
    color: #b91c1c;
  }

  .status-pill {
    display: inline-flex;
    align-items: center;
    padding: .16rem .45rem;
    border-radius: 999px;
    font-size: .78rem;
    font-weight: 600;
    background: #e5e7eb;
    color: #111827;
  }
  .status-completed { background: #dcfce7; color: #166534; }
  .status-pending { background: #fef9c3; color: #92400e; }
  .status-cancelled,
  .status-refunded { background: #fee2e2; color: #b91c1c; }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: .3rem;
    padding: .45rem .9rem;
    border-radius: .7rem;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #111827;
    font-weight: 700;
    font-size: .86rem;
    text-decoration: none;
    cursor: pointer;
  }
  .btn.primary {
    background: #2563eb;
    border-color: #1d4ed8;
    color: #fff;
  }
  .btn.light {
    background: #f3f4f6;
    border-color: #e5e7eb;
  }
  .btn.danger {
    background: #fee2e2;
    border-color: #fecaca;
    color: #b91c1c;
  }
  .btn.xs {
    padding: .34rem .6rem;
    font-size: .8rem;
  }

  /* Responsive cards for tables on small screens */
@media (max-width: 640px) {
  .table-wrap {
    border-radius: 0;
    border: none;
    background: transparent;
  }

  .table-wrap.small {
    padding: 0;
  }

  .nice-table.responsive {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
  }

  .nice-table.responsive thead {
    display: none; /* hide header on mobile */
  }

  .nice-table.responsive tbody tr {
    display: block;
    background: #ffffff;
    border-radius: .9rem;
    margin-bottom: .8rem;
    padding: .45rem .65rem;
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.08);
    border: 1px solid rgba(148, 163, 184, .25);
  }

  .dark-theme .nice-table.responsive tbody tr {
    background: #020617;
    border-color: #1f2937;
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.7);
  }

  .nice-table.responsive td {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    padding: .25rem 0;
    border-bottom: none;
    text-align: left;
    font-size: .85rem;
  }

  .nice-table.responsive td::before {
    content: attr(data-label);
    font-weight: 600;
    font-size: .8rem;
    margin-right: .75rem;
    flex: 0 0 auto;
    max-width: 45%;
    white-space: nowrap;
  }

  .nice-table.responsive td.cell-product {
    flex-direction: row;
    align-items: center;
  }

  .nice-table.responsive td.cell-product::before {
    margin-right: .5rem;
  }

  .nice-table.responsive td.right {
    text-align: right;
    justify-content: space-between;
  }

  /* ----- Per-property colours (label + value match) ----- */
  /* 1) Product */
  .nice-table.responsive tbody tr td:nth-of-type(1),
  .nice-table.responsive tbody tr td:nth-of-type(1)::before {
    color: #2563eb; /* blue */
  }

  /* 2) Price (R) */
  .nice-table.responsive tbody tr td:nth-of-type(2),
  .nice-table.responsive tbody tr td:nth-of-type(2)::before {
    color: #16a34a; /* green */
  }

  /* 3) Stock */
  .nice-table.responsive tbody tr td:nth-of-type(3),
  .nice-table.responsive tbody tr td:nth-of-type(3)::before {
    color: #ea580c; /* orange */
  }

  /* 4) Category */
  .nice-table.responsive tbody tr td:nth-of-type(4),
  .nice-table.responsive tbody tr td:nth-of-type(4)::before {
    color: #7c3aed; /* purple */
  }

  /* 5) Updated */
  .nice-table.responsive tbody tr td:nth-of-type(5),
  .nice-table.responsive tbody tr td:nth-of-type(5)::before {
    color: #0e7490; /* teal */
  }
}
</style>

<script nonce="<%= nonce %>">
  (async function setupSupplierKpiAutoRefresh() {
    async function refreshKPIs() {
      try {
        const res = await fetch('/business/api/supplier/kpis', {
          credentials: 'same-origin'
        });
        if (!res.ok) return;

        const data = await res.json().catch(() => ({}));
        if (!data || data.ok === false) return;

        const set = (key, val, fmt) => {
          const nodes = document.querySelectorAll('[data-kpi="' + key + '"]');
          nodes.forEach((el) => {
            el.textContent = fmt ? fmt(val) : (val ?? 0);
          });
        };

        set('totalProducts',  data.totalProducts);
        set('totalStock',     data.totalStock);
        set('inStock',        data.inStock);
        set('lowStock',       data.lowStock);
        set('outOfStock',     data.outOfStock);
        set('soldLast30',     data.soldLast30);
        set('revenueLast30',  data.revenueLast30, (v) => 'R ' + Number(v || 0).toFixed(2));
        // console.log('üîÑ Supplier KPIs refreshed', new Date().toLocaleTimeString());
      } catch (_) {
        // Silent fail ‚Äì UI must never break because of KPI polling
      }
    }

    await refreshKPIs();
    setInterval(refreshKPIs, 30000);
  })();
</script>

