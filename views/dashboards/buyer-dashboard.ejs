<!-- views/dashboards/buyer-dashboard.ejs -->
<% const NONCE = typeof nonce !== 'undefined' ? nonce : '' %>

<section class="dashboard buyer">
  <!-- Header Section -->
  <div class="dashboard-header" style="background: linear-gradient(135deg, #7C3AED 0%, #2563EB 100%);">
    <div class="header-content">
      <div class="user-greeting">
        <div class="avatar-container">
          <div class="avatar" style="background-color: #22C55E; color: white;">
            <%= (business && business.name) ? business.name.charAt(0).toUpperCase() : 'B' %>
          </div>
          <div>
            <h1 class="page-title">
              Welcome back, <span class="user-name" style="color: white;"><%= (business && business.name) || 'Buyer' %></span>
            </h1>
            <div class="role-status">
              <span class="role-badge buyer" style="background-color: #0F172A; color: white;">BUYER ACCOUNT</span>
              <span class="status-indicator" style="color: rgba(255,255,255,0.9);">
                <span class="status-dot online" style="background-color: #22C55E;"></span>
                Active Buyer
              </span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="header-actions">
        <div class="quick-stats">
          <div class="stat-card" style="background-color: rgba(255,255,255,0.15); color: white;">
            <span class="stat-label">Today</span>
            <span class="stat-value" id="current-date"><%= new Date().toLocaleDateString('en-ZA', { weekday: 'short', month: 'short', day: 'numeric' }) %></span>
          </div>
          <div class="stat-card" style="background-color: rgba(255,255,255,0.15); color: white;">
            <span class="stat-label">Session</span>
            <span class="stat-value" id="session-time">00:00:00</span>
          </div>
          <div class="stat-card performance" style="background-color: rgba(255,255,255,0.15); color: white; border-left: 3px solid #22C55E;">
            <span class="stat-label">Member Since</span>
            <span class="stat-value"><%= new Date((business && business.createdAt) || Date.now()).toLocaleDateString('en-ZA', { month: 'short', year: 'numeric' }) %></span>
          </div>
        </div>
      </div>
    </div>

    <!-- Global Notifications -->
    <div class="notifications-container">
      <% (success || []).forEach(msg => { %>
        <div class="notification notification-success" style="background-color: #22C55E; color: white;">
          <span class="notification-icon">‚úì</span>
          <span class="notification-text"><%= msg %></span>
          <button class="notification-close" type="button">&times;</button>
        </div>
      <% }) %>

      <% (error || []).forEach(msg => { %>
        <div class="notification notification-error" style="background-color: #EF4444; color: white;">
          <span class="notification-icon">!</span>
          <span class="notification-text"><%= msg %></span>
          <button class="notification-close" type="button">&times;</button>
        </div>
      <% }) %>
    </div>
  </div>

  <!-- Main Dashboard Content -->
  <div class="dashboard-content">
    <!-- Left Column - Orders & Stats -->
    <div class="dashboard-column left-column">
      <!-- Order KPIs -->
      <div class="card performance-card" style="border-top: 4px solid #7C3AED;">
        <div class="card-header">
          <h3 class="card-title" style="color: #0F172A;">Order Overview</h3>
          <span class="card-subtitle" style="color: #64748B;">Your purchasing activity</span>
        </div>
        <div class="card-body">
          <div class="kpi-grid">
            <div class="kpi-card primary" style="background-color: #2563EB; color: white;">
              <div class="kpi-icon">üì¶</div>
              <div class="kpi-content">
                <h4>Total Orders</h4>
                <p class="kpi-value"><%= totalOrders || 0 %></p>
                <span class="kpi-trend">All time (non-refunded)</span>
              </div>
            </div>

            <div class="kpi-card success" style="background-color: #22C55E; color: white;">
              <div class="kpi-icon">‚úÖ</div>
              <div class="kpi-content">
                <h4>Completed</h4>
                <p class="kpi-value"><%= completedOrders || 0 %></p>
                <span class="kpi-trend">Successfully delivered</span>
              </div>
            </div>

            <div class="kpi-card warning" style="background-color: #F59E0B; color: white;">
              <div class="kpi-icon">‚è≥</div>
              <div class="kpi-content">
                <h4>Pending</h4>
                <p class="kpi-value"><%= pendingOrders || 0 %></p>
                <span class="kpi-trend">In process</span>
              </div>
            </div>

            <div class="kpi-card info" style="background-color: #0F172A; color: white;">
              <div class="kpi-icon">üöö</div>
              <div class="kpi-content">
                <h4>In Transit</h4>
                <p class="kpi-value"><%= (shipStats && shipStats.inTransit) || 0 %></p>
                <span class="kpi-trend">On the way</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card actions-card" style="border-top: 4px solid #22C55E;">
        <div class="card-header">
          <h3 class="card-title" style="color: #0F172A;">Quick Actions</h3>
          <span class="card-subtitle" style="color: #64748B;">Common tasks</span>
        </div>
        <div class="card-body">
          <div class="actions-grid">
            <a href="/demands/add" class="action-btn primary-action" style="background-color: #7C3AED; color: white;">
              <span class="action-icon">üìù</span>
              <span class="action-text">Add Demand</span>
              <span class="action-hint">Request products</span>
            </a>
            
            <a href="/matches/buyer" class="action-btn secondary-action" style="background-color: #2563EB; color: white;">
              <span class="action-icon">üîî</span>
              <span class="action-text">View Matches</span>
              <span class="action-hint">Find suppliers</span>
            </a>
            
            <a href="/shipments/track" class="action-btn secondary-action" style="background-color: #0F172A; color: white;">
              <span class="action-icon">üöö</span>
              <span class="action-text">Track Shipments</span>
              <span class="action-hint">Monitor delivery</span>
            </a>
            
            <a href="/contact" class="action-btn secondary-action" style="background-color: #22C55E; color: white;">
              <span class="action-icon">üì®</span>
              <span class="action-text">Contact Support</span>
              <span class="action-hint">Get help</span>
            </a>
          </div>
        </div>
      </div>

      <!-- Purchased Products -->
      <div class="card products-card" style="border-top: 4px solid #0F172A;">
        <div class="card-header">
          <h3 class="card-title" style="color: #0F172A;">Recent Purchases</h3>
          <span class="card-subtitle" style="color: #64748B;">Your purchased items</span>
        </div>
        <div class="card-body">
          <div class="products-list">
            <% if (orderedProducts && orderedProducts.length) { %>
              <% orderedProducts.slice(0, 4).forEach(p => { %>
                <div class="product-item" style="border-left: 3px solid #7C3AED;">
                  <div class="product-preview">
                    <% if (p.imageUrl) { %>
                      <img src="<%= p.imageUrl %>" alt="<%= p.name %>" class="product-img">
                    <% } else { %>
                      <div class="product-img placeholder" style="background-color: #E2E8F0;">
                        <span class="placeholder-text" style="color: #64748B;">No Image</span>
                      </div>
                    <% } %>
                  </div>
                  <div class="product-info">
                    <span class="product-name" style="color: #0F172A;"><%= p.name %></span>
                    <div class="product-meta">
                      <span class="product-price" style="color: #22C55E; font-weight: 600;">R <%= Number(p.price || 0).toFixed(2) %></span>
                      <% if (p.category) { %>
                        <span class="product-category" style="color: #64748B;"><%= p.category %></span>
                      <% } %>
                    </div>
                  </div>
                </div>
              <% }) %>
              <a href="/orders" class="view-all-link" style="color: #7C3AED;">View All Purchases ‚Üí</a>
            <% } else { %>
              <div class="empty-products">
                <span class="empty-icon">üõçÔ∏è</span>
                <p style="color: #0F172A;">No purchases yet</p>
                <a href="/sales" class="btn btn-sm btn-primary" style="background-color: #7C3AED; color: white;">Browse Products</a>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>

    <!-- Middle Column - Recent Orders -->
    <div class="dashboard-column middle-column">
      <!-- Recent Orders Table -->
      <div class="card orders-card" style="border-top: 4px solid #2563EB;">
        <div class="card-header">
          <div>
            <h3 class="card-title" style="color: #0F172A;">Recent Orders</h3>
            <span class="card-subtitle" style="color: #64748B;">Latest order activity</span>
          </div>
          <div class="card-actions">
            <a href="/orders" class="btn btn-sm btn-outline" style="color: #7C3AED; border-color: #7C3AED;">View All</a>
          </div>
        </div>

        <div class="card-body">
          <div class="orders-table">
            <table class="modern-table">
              <thead>
                <tr style="background-color: #F8FAFC;">
                  <th style="color: #0F172A; border-bottom: 2px solid #7C3AED;">Order ID</th>
                  <th style="color: #0F172A; border-bottom: 2px solid #7C3AED;">Status</th>
                  <th style="color: #0F172A; border-bottom: 2px solid #7C3AED;">Amount</th>
                  <th style="color: #0F172A; border-bottom: 2px solid #7C3AED;">Date</th>
                  <th style="color: #0F172A; border-bottom: 2px solid #7C3AED;">Action</th>
                </tr>
              </thead>

              <tbody>
                <% if (orders && orders.length) { %>
                  <% orders.slice(0, 6).forEach(o => { %>
                    <tr>
                      <td class="order-id-cell">
                        <span class="order-id" style="color: #7C3AED;">#<%= (o.orderId || o._id).toString().slice(-8) %></span>
                      </td>

                      <td>
                        <%
                          const shownLabel = o.uiStatus || (o.status || 'Unknown');
                          const shownClass = o.uiStatusKey || String(shownLabel).toLowerCase().replace(/\s+/g,'-');
                        %>

                        <span class="status-badge status-<%= shownClass %>" 
                              style="<%= shownClass.includes('delivered') ? 'background-color: #22C55E;' : 
                                      shownClass.includes('pending') ? 'background-color: #F59E0B;' :
                                      shownClass.includes('transit') ? 'background-color: #2563EB;' :
                                      shownClass.includes('cancelled') ? 'background-color: #EF4444;' :
                                      'background-color: #64748B;' %> color: white;">
                          <%= String(shownLabel).toUpperCase() %>
                        </span>

                        <% if (o._isRefunded) { %>
                          <div class="status-subnote" style="color: #EF4444;">
                            Refunded
                            <%= o.refundedAt ? ('on ' + new Date(o.refundedAt).toLocaleDateString('en-ZA', { month:'short', day:'numeric' })) : '' %>
                          </div>
                        <% } %>
                      </td>

                      <td class="amount-cell">
                        <span class="order-amount" style="color: #22C55E; font-weight: 600;">R <%= Number((o.amount && o.amount.value) || 0).toFixed(2) %></span>
                      </td>

                      <td>
                        <span class="order-date" style="color: #64748B;">
                          <% if (o.createdAt) { %>
                            <%= new Date(o.createdAt).toLocaleDateString('en-ZA', { month: 'short', day: 'numeric' }) %>
                          <% } else { %>
                            N/A
                          <% } %>
                        </span>
                      </td>

                      <td>
                        <a href="/orders/<%= o.orderId || o._id %>" class="btn btn-xs btn-outline" style="color: #7C3AED; border-color: #7C3AED;">View</a>
                      </td>
                    </tr>
                  <% }) %>
                <% } else { %>
                  <tr class="empty-state">
                    <td colspan="5">
                      <div class="empty-message">
                        <span class="empty-icon">üì¶</span>
                        <p style="color: #0F172A;">No orders yet</p>
                        <a href="/sales" class="btn btn-sm btn-primary" style="background-color: #7C3AED; color: white;">Start Shopping</a>
                      </div>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Shipping Status -->
      <div class="card shipping-card" style="border-top: 4px solid #22C55E;">
        <div class="card-header">
          <h3 class="card-title" style="color: #0F172A;">Shipping Status</h3>
          <span class="card-subtitle" style="color: #64748B;">Delivery tracking</span>
        </div>
        <div class="card-body">
          <div class="shipping-stats">
            <div class="shipping-item" style="background-color: #F0FDF4;">
              <div class="shipping-icon delivered" style="background-color: #22C55E; color: white;">üì¨</div>
              <div class="shipping-details">
                <span class="shipping-label" style="color: #0F172A;">Delivered</span>
                <span class="shipping-value" style="color: #22C55E;"><%= (shipStats && shipStats.delivered) || 0 %></span>
              </div>
            </div>

            <div class="shipping-item" style="background-color: #EFF6FF;">
              <div class="shipping-icon transit" style="background-color: #2563EB; color: white;">üöö</div>
              <div class="shipping-details">
                <span class="shipping-label" style="color: #0F172A;">In Transit</span>
                <span class="shipping-value" style="color: #2563EB;"><%= (shipStats && shipStats.inTransit) || 0 %></span>
              </div>
            </div>

            <div class="shipping-item" style="background-color: #FAF5FF;">
              <div class="shipping-icon processing" style="background-color: #7C3AED; color: white;">üè≠</div>
              <div class="shipping-details">
                <span class="shipping-label" style="color: #0F172A;">Processing</span>
                <span class="shipping-value" style="color: #7C3AED;"><%= (shipStats && shipStats.processing) || 0 %></span>
              </div>
            </div>

            <div class="shipping-item" style="background-color: #FFFBEB;">
              <div class="shipping-icon pending" style="background-color: #F59E0B; color: white;">‚è≥</div>
              <div class="shipping-details">
                <span class="shipping-label" style="color: #0F172A;">Pending</span>
                <span class="shipping-value" style="color: #F59E0B;"><%= pendingOrders || 0 %></span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Right Column - Demands & Matches -->
    <div class="dashboard-column right-column">
      <!-- Demands Overview -->
      <div class="card demands-card" style="border-top: 4px solid #7C3AED;">
        <div class="card-header">
          <h3 class="card-title" style="color: #0F172A;">My Demands</h3>
          <a href="/demands/mine" class="btn btn-sm btn-outline" style="color: #7C3AED; border-color: #7C3AED;">Manage</a>
        </div>
        <div class="card-body">
          <div class="demands-summary">
            <div class="summary-item" style="border-bottom: 1px solid #E2E8F0;">
              <span class="summary-label" style="color: #64748B;">Active Demands</span>
              <span class="summary-value" style="color: #7C3AED;"><%= (demands && demands.active) || 0 %></span>
            </div>
            <div class="summary-item">
              <span class="summary-label" style="color: #64748B;">Pending Matches</span>
              <span class="summary-value" style="color: #2563EB;"><%= (demands && demands.pendingMatches) || 0 %></span>
            </div>
          </div>
          
          <div class="demands-actions">
            <a href="/demands/add" class="btn btn-primary" style="background-color: #7C3AED; color: white;">
              <span class="btn-icon">üìù</span>
              Create Demand
            </a>
            <a href="/matches/buyer" class="btn btn-outline" style="color: #7C3AED; border-color: #7C3AED;">
              <span class="btn-icon">üîî</span>
              View Matches
            </a>
          </div>
        </div>
      </div>

      <!-- Matches Overview -->
      <div class="card matches-card" style="border-top: 4px solid #22C55E;">
        <div class="card-header">
          <h3 class="card-title" style="color: #0F172A;">Product Matches</h3>
          <span class="card-subtitle" style="color: #64748B;">Recommended for you</span>
        </div>
        <div class="card-body">
          <% if (matches && matches.length) { %>
            <div class="matches-list">
              <% matches.slice(0, 3).forEach(match => { %>
                <div class="match-item" style="border-left: 3px solid #7C3AED;">
                  <div class="match-info">
                    <span class="match-name" style="color: #0F172A;"><%= match.productName || 'Product Match' %></span>
                    <div class="match-meta">
                      <span class="match-supplier" style="color: #64748B;">by <%= match.supplierName || 'Supplier' %></span>
                      <span class="match-price" style="color: #22C55E; font-weight: 600;">R <%= Number(match.price || 0).toFixed(2) %></span>
                    </div>
                  </div>
                  <div class="match-actions">
                    <a href="/matches/view/<%= match._id %>" class="btn btn-xs btn-outline" style="color: #7C3AED; border-color: #7C3AED;">View</a>
                  </div>
                </div>
              <% }) %>
              <a href="/matches/buyer" class="view-all-link" style="color: #7C3AED;">View All Matches ‚Üí</a>
            </div>
          <% } else { %>
            <div class="empty-matches">
              <span class="empty-icon">üîî</span>
              <p style="color: #0F172A;">No matches yet</p>
              <p class="small-text" style="color: #64748B;">Create demands to get product matches</p>
              <a href="/demands/add" class="btn btn-sm btn-primary" style="background-color: #7C3AED; color: white;">Create Demand</a>
            </div>
          <% } %>
        </div>
      </div>

      <!-- System Status -->
      <div class="card status-card" style="border-top: 4px solid #0F172A;">
        <div class="card-header">
          <h3 class="card-title" style="color: #0F172A;">System Status</h3>
          <span class="status-indicator <%= mailerOk ? 'online' : 'offline' %>" 
                style="<%= mailerOk ? 'background-color: #22C55E;' : 'background-color: #EF4444;' %> color: white;">
            <%= mailerOk ? 'Online' : 'Offline' %>
          </span>
        </div>
        <div class="card-body">
          <div class="status-list">
            <div class="status-item">
              <span class="status-dot online" style="background-color: #22C55E;"></span>
              <span class="status-text" style="color: #0F172A;">Order System</span>
              <span class="status-value" style="color: #22C55E;">Operational</span>
            </div>
            
            <div class="status-item">
              <span class="status-dot <%= mailerOk ? 'online' : 'offline' %>" 
                    style="<%= mailerOk ? 'background-color: #22C55E;' : 'background-color: #EF4444;' %>"></span>
              <span class="status-text" style="color: #0F172A;">Email Notifications</span>
              <span class="status-value" style="<%= mailerOk ? 'color: #22C55E;' : 'color: #EF4444;' %>"><%= mailerOk ? 'Active' : 'Inactive' %></span>
            </div>
            
            <div class="status-item">
              <span class="status-dot online" style="background-color: #22C55E;"></span>
              <span class="status-text" style="color: #0F172A;">Payment Gateway</span>
              <span class="status-value" style="color: #22C55E;">Online</span>
            </div>
            
            <div class="status-item">
              <span class="status-dot online" style="background-color: #22C55E;"></span>
              <span class="status-text" style="color: #0F172A;">Support System</span>
              <span class="status-value" style="color: #22C55E;">Available</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Footer -->
  <div class="dashboard-footer" style="background-color: #0F172A; color: white;">
    <div class="footer-content">
      <div class="footer-section">
        <h4 style="color: white;">Quick Links</h4>
        <a href="/contact" class="footer-link" style="color: #E2E8F0;">üì® Contact Support</a>
        <a href="/demands/mine" class="footer-link" style="color: #E2E8F0;">üìã My Demands</a>
        <a href="/matches/buyer" class="footer-link" style="color: #E2E8F0;">üîî Product Matches</a>
        <a href="/shipments/track" class="footer-link" style="color: #E2E8F0;">üöö Track Shipments</a>
      </div>
      
      <div class="footer-section">
        <h4 style="color: white;">Account</h4>
        <div class="account-info">
          <span class="account-label" style="color: #94A3B8;">Logged in as</span>
          <span class="account-email" style="color: white;"><%= (business && business.email) || '-' %></span>
        </div>
        <div class="account-info">
          <span class="account-label" style="color: #94A3B8;">Member since</span>
          <span class="account-date" style="color: white;"><%= new Date((business && business.createdAt) || Date.now()).toLocaleDateString('en-ZA', { month: 'long', year: 'numeric' }) %></span>
        </div>
        <form action="/business/logout" method="post" class="logout-form">
          <button type="submit" class="footer-link logout-btn" style="color: #E2E8F0;">üö™ Logout</button>
        </form>
      </div>
      
      <div class="footer-section">
        <h4 style="color: white;">Support</h4>
        <div class="support-info">
          <span style="color: #94A3B8;">Need help with your orders?</span>
          <a href="/contact" class="support-link" style="color: #7C3AED;">Contact our team ‚Üí</a>
        </div>
        <div class="support-info">
          <span style="color: #94A3B8;">Have product demands?</span>
          <a href="/demands/add" class="support-link" style="color: #7C3AED;">Create demand ‚Üí</a>
        </div>
        <div class="support-info">
          <span style="color: #94A3B8;">Payment issues?</span>
          <a href="/contact" class="support-link" style="color: #7C3AED;">Get support ‚Üí</a>
        </div>
      </div>
    </div>
  </div>
</section>

<style nonce="<%= NONCE %>">
  /* Base Styles */
  .dashboard.buyer {
    min-height: 100vh;
    background-color: #F8FAFC;
  }

  /* Header */
  .dashboard-header {
    padding: 1.5rem 1rem;
    border-radius: 0 0 12px 12px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-bottom: 1.5rem;
  }

  .header-content {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: center;
    gap: 1rem;
  }

  .avatar-container {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: bold;
    flex-shrink: 0;
  }

  .page-title {
    font-size: 1.5rem;
    margin: 0;
    color: white;
  }

  .role-status {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-top: 0.5rem;
  }

  .role-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.5px;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
  }

  .status-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
  }

  .quick-stats {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .stat-card {
    padding: 0.75rem 1rem;
    border-radius: 8px;
    min-width: 120px;
  }

  .stat-label {
    display: block;
    font-size: 0.875rem;
    opacity: 0.9;
    margin-bottom: 0.25rem;
  }

  .stat-value {
    font-size: 1.25rem;
    font-weight: 600;
    display: block;
  }

  /* Notifications */
  .notifications-container {
    margin-top: 1rem;
  }

  .notification {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.3s ease;
  }

  .notification-close {
    margin-left: auto;
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.7;
  }

  /* Dashboard Layout */
  .dashboard-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    padding: 0 1rem;
    margin-bottom: 2rem;
  }

  @media (min-width: 768px) {
    .dashboard-content {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (min-width: 1024px) {
    .dashboard-content {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  /* Cards */
  .card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    margin-bottom: 1.5rem;
  }

  .card-header {
    padding: 1.25rem 1.5rem 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .card-title {
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
  }

  .card-subtitle {
    font-size: 0.875rem;
    display: block;
    margin-top: 0.25rem;
  }

  .card-body {
    padding: 0 1.5rem 1.5rem;
  }

  /* KPI Grid */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .kpi-card {
    padding: 1rem;
    border-radius: 8px;
  }

  .kpi-icon {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .kpi-content h4 {
    font-size: 0.875rem;
    font-weight: 500;
    margin: 0 0 0.25rem;
    opacity: 0.9;
  }

  .kpi-value {
    font-size: 1.75rem;
    font-weight: 700;
    margin: 0;
    line-height: 1;
  }

  .kpi-trend {
    font-size: 0.75rem;
    opacity: 0.8;
    display: block;
    margin-top: 0.25rem;
  }

  /* Actions Grid */
  .actions-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .action-btn {
    padding: 1rem;
    border-radius: 8px;
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    transition: transform 0.2s ease;
  }

  .action-btn:hover {
    transform: translateY(-2px);
  }

  .action-icon {
    font-size: 1.5rem;
    margin-bottom: 0.5rem;
  }

  .action-text {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .action-hint {
    font-size: 0.75rem;
    opacity: 0.8;
  }

  /* Products List */
  .products-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .product-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.75rem;
    border-radius: 8px;
    background-color: #F8FAFC;
  }

  .product-img {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    object-fit: cover;
  }

  .product-img.placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .product-info {
    flex: 1;
  }

  .product-name {
    font-weight: 500;
    display: block;
    margin-bottom: 0.25rem;
  }

  .product-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.875rem;
  }

  .view-all-link {
    display: block;
    text-align: center;
    padding: 0.75rem;
    font-weight: 500;
    text-decoration: none;
  }

  /* Table */
  .modern-table {
    width: 100%;
    border-collapse: collapse;
  }

  .modern-table th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-weight: 600;
  }

  .modern-table td {
    padding: 1rem;
    border-bottom: 1px solid #E2E8F0;
  }

  .status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-block;
  }

  /* Shipping Stats */
  .shipping-stats {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }

  .shipping-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    border-radius: 8px;
  }

  .shipping-icon {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    flex-shrink: 0;
  }

  .shipping-label {
    display: block;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
  }

  .shipping-value {
    font-size: 1.5rem;
    font-weight: 700;
  }

  /* Demands & Matches */
  .demands-summary {
    margin-bottom: 1.5rem;
  }

  .summary-item {
    padding: 0.75rem 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .summary-label {
    font-size: 0.875rem;
  }

  .summary-value {
    font-size: 1.25rem;
    font-weight: 700;
  }

  .demands-actions {
    display: flex;
    gap: 0.75rem;
  }

  .btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.875rem;
    border: 2px solid transparent;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    transition: all 0.2s ease;
  }

  .btn:hover {
    opacity: 0.9;
  }

  .btn-primary {
    background-color: #7C3AED;
    color: white;
  }

  .btn-outline {
    background-color: transparent;
    color: #7C3AED;
    border-color: #7C3AED;
  }

  .btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
  }

  .btn-xs {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
  }

  .matches-list {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .match-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem;
    background-color: #F8FAFC;
    border-radius: 8px;
  }

  .match-name {
    font-weight: 500;
    display: block;
    margin-bottom: 0.25rem;
  }

  .match-meta {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
  }

  /* Status List */
  .status-list {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .status-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .status-text {
    flex: 1;
    font-size: 0.875rem;
  }

  .status-value {
    font-size: 0.875rem;
    font-weight: 600;
  }

  /* Empty States */
  .empty-products,
  .empty-matches,
  .empty-message {
    text-align: center;
    padding: 2rem 1rem;
  }

  .empty-icon {
    font-size: 3rem;
    display: block;
    margin-bottom: 1rem;
    opacity: 0.5;
  }

  .small-text {
    font-size: 0.875rem;
    margin-bottom: 1rem;
  }

  /* Footer */
  .dashboard-footer {
    padding: 2rem 1rem;
  }

  .footer-content {
    display: grid;
    grid-template-columns: 1fr;
    gap: 2rem;
    max-width: 1200px;
    margin: 0 auto;
  }

  @media (min-width: 768px) {
    .footer-content {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  .footer-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .footer-section h4 {
    font-size: 1rem;
    margin: 0 0 0.5rem;
  }

  .footer-link {
    color: #E2E8F0;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0;
  }

  .footer-link:hover {
    color: white;
  }

  .account-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .logout-form {
    margin-top: 0.5rem;
  }

  .logout-btn {
    background: none;
    border: none;
    padding: 0;
    font: inherit;
    cursor: pointer;
  }

  .support-info {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .support-link {
    color: #7C3AED;
    text-decoration: none;
    font-weight: 500;
  }

  /* Mobile Optimizations */
  @media (max-width: 640px) {
    .dashboard-header {
      padding: 1rem;
    }

    .header-content {
      flex-direction: column;
      align-items: stretch;
    }

    .quick-stats {
      justify-content: center;
    }

    .stat-card {
      min-width: 100px;
      flex: 1;
    }

    .kpi-grid,
    .actions-grid,
    .shipping-stats {
      grid-template-columns: 1fr;
    }

    .demands-actions {
      flex-direction: column;
    }

    .btn {
      justify-content: center;
    }

    .modern-table {
      display: block;
      overflow-x: auto;
    }

    .product-item,
    .match-item {
      flex-direction: column;
      text-align: center;
    }

    .product-meta,
    .match-meta {
      flex-direction: column;
      gap: 0.25rem;
    }
  }

  /* Animation for updated values */
  @keyframes valueUpdate {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
  }

  .value-updated {
    animation: valueUpdate 0.5s ease;
    color: #22C55E !important;
  }
</style>

<script nonce="<%= NONCE %>">
  // Session timer
  function startSessionTimer() {
    const timerElement = document.getElementById('session-time');
    let seconds = 0;

    const updateTimer = () => {
      seconds++;
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;

      timerElement.textContent =
        `${hours.toString().padStart(2, '0')}:` +
        `${minutes.toString().padStart(2, '0')}:` +
        `${secs.toString().padStart(2, '0')}`;
    };

    setInterval(updateTimer, 1000);
  }

  // Close notifications
  function setupNotifications() {
    document.querySelectorAll('.notification-close').forEach(button => {
      button.addEventListener('click', (e) => {
        const notification = e.target.closest('.notification');
        if (!notification) return;
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-10px)';
        setTimeout(() => notification.remove(), 300);
      });
    });

    // Auto-hide success notifications after 5 seconds
    setTimeout(() => {
      document.querySelectorAll('.notification-success').forEach(notification => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-10px)';
        setTimeout(() => notification.remove(), 300);
      });
    }, 5000);
  }

  // Auto-refresh dashboard data
  async function refreshDashboardData() {
    try {
      const res = await fetch('/business/api/buyer/stats', {
        credentials: 'same-origin',
        headers: { 'Cache-Control': 'no-cache' }
      });

      if (!res.ok) return;

      const data = await res.json().catch(() => ({}));
      if (!data || data.ok === false) return;

      const updateElement = (selector, value) => {
        const element = document.querySelector(selector);
        if (!element || value === undefined) return;

        const currentValue = parseInt(element.textContent) || 0;
        if (currentValue !== value) {
          element.textContent = value;
          element.classList.add('value-updated');
          setTimeout(() => element.classList.remove('value-updated'), 500);
        }
      };

      updateElement('.kpi-grid .kpi-card:nth-child(1) .kpi-value', data.totalOrders);
      updateElement('.kpi-grid .kpi-card:nth-child(2) .kpi-value', data.completedOrders);
      updateElement('.kpi-grid .kpi-card:nth-child(3) .kpi-value', data.pendingOrders);
      updateElement('.kpi-grid .kpi-card:nth-child(4) .kpi-value', data.inTransit);

      updateElement('.shipping-item:nth-child(1) .shipping-value', data.delivered);
      updateElement('.shipping-item:nth-child(2) .shipping-value', data.inTransit);
      updateElement('.shipping-item:nth-child(3) .shipping-value', data.processing);

      console.log('üîÑ Buyer dashboard refreshed at', new Date().toLocaleTimeString());
    } catch (error) {
      console.warn('Dashboard refresh failed:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    startSessionTimer();
    setupNotifications();

    refreshDashboardData();
    setInterval(refreshDashboardData, 30000);

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) refreshDashboardData();
    });
  });
</script>