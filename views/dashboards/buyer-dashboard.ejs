<!-- views/dashboards/buyer-dashboard.ejs -->
<% const NONCE = typeof nonce !== 'undefined' ? nonce : '' %>

<section class="pg-buyer-dashboard">
  <!-- Header -->
  <header class="bd-header">
    <div class="bd-header__inner">
      <div class="bd-welcome">
        <div class="bd-avatar" aria-hidden="true">
          <%= (business && business.name) ? business.name.charAt(0).toUpperCase() : 'B' %>
        </div>

        <div class="bd-welcome__text">
          <h1 class="bd-title">
            Welcome back,
            <span class="bd-title__name"><%= (business && business.name) || 'Buyer' %></span>
          </h1>

          <div class="bd-meta">
            <span class="bd-badge">BUYER ACCOUNT</span>
            <span class="bd-live">
              <span class="bd-dot bd-dot--online"></span>
              Active Buyer
            </span>
          </div>
        </div>
      </div>

      <div class="bd-stats">
        <div class="bd-stat">
          <span class="bd-stat__label">Today</span>
          <span class="bd-stat__value" id="current-date">
            <%= new Date().toLocaleDateString('en-ZA', { weekday: 'short', month: 'short', day: 'numeric' }) %>
          </span>
        </div>

        <div class="bd-stat">
          <span class="bd-stat__label">Session</span>
          <span class="bd-stat__value" id="session-time">00:00:00</span>
        </div>

        <div class="bd-stat bd-stat--accent">
          <span class="bd-stat__label">Member Since</span>
          <span class="bd-stat__value">
            <%= new Date((business && business.createdAt) || Date.now()).toLocaleDateString('en-ZA', { month: 'short', year: 'numeric' }) %>
          </span>
        </div>
      </div>
    </div>

    <!-- Notifications -->
    <div class="bd-notifs" aria-live="polite">
      <% (success || []).forEach(msg => { %>
        <div class="bd-notif bd-notif--success">
          <span class="bd-notif__icon" aria-hidden="true">âœ“</span>
          <span class="bd-notif__text"><%= msg %></span>
          <button class="bd-notif__close" type="button" aria-label="Close notification">&times;</button>
        </div>
      <% }) %>

      <% (error || []).forEach(msg => { %>
        <div class="bd-notif bd-notif--error">
          <span class="bd-notif__icon" aria-hidden="true">!</span>
          <span class="bd-notif__text"><%= msg %></span>
          <button class="bd-notif__close" type="button" aria-label="Close notification">&times;</button>
        </div>
      <% }) %>
    </div>
  </header>

  <!-- Content -->
  <main class="bd-content">
    <!-- Left -->
    <section class="bd-col">
      <!-- KPIs -->
      <section class="bd-card bd-card--top-purple">
        <header class="bd-card__head">
          <div>
            <h3 class="bd-card__title">Order Overview</h3>
            <p class="bd-card__sub">Your purchasing activity</p>
          </div>
        </header>

        <div class="bd-card__body">
          <div class="bd-kpis">
            <div class="bd-kpi bd-kpi--blue">
              <div class="bd-kpi__icon" aria-hidden="true">ğŸ“¦</div>
              <div class="bd-kpi__txt">
                <div class="bd-kpi__label">Total Orders</div>
                <div class="bd-kpi__value" data-kpi="totalOrders"><%= totalOrders || 0 %></div>
                <div class="bd-kpi__hint">All time (non-refunded)</div>
              </div>
            </div>

            <div class="bd-kpi bd-kpi--green">
              <div class="bd-kpi__icon" aria-hidden="true">âœ…</div>
              <div class="bd-kpi__txt">
                <div class="bd-kpi__label">Completed</div>
                <div class="bd-kpi__value" data-kpi="completedOrders"><%= completedOrders || 0 %></div>
                <div class="bd-kpi__hint">Successfully delivered</div>
              </div>
            </div>

            <div class="bd-kpi bd-kpi--amber">
              <div class="bd-kpi__icon" aria-hidden="true">â³</div>
              <div class="bd-kpi__txt">
                <div class="bd-kpi__label">Pending</div>
                <div class="bd-kpi__value" data-kpi="pendingOrders"><%= pendingOrders || 0 %></div>
                <div class="bd-kpi__hint">In process</div>
              </div>
            </div>

            <div class="bd-kpi bd-kpi--black">
              <div class="bd-kpi__icon" aria-hidden="true">ğŸšš</div>
              <div class="bd-kpi__txt">
                <div class="bd-kpi__label">In Transit</div>
                <div class="bd-kpi__value" data-kpi="inTransit"><%= (shipStats && shipStats.inTransit) || 0 %></div>
                <div class="bd-kpi__hint">On the way</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Quick Actions -->
      <section class="bd-card bd-card--top-green">
        <header class="bd-card__head">
          <div>
            <h3 class="bd-card__title">Quick Actions</h3>
            <p class="bd-card__sub">Common tasks</p>
          </div>
        </header>

        <div class="bd-card__body">
          <div class="bd-actions">
            <a href="/demands/add" class="bd-action bd-action--purple">
              <span class="bd-action__icon" aria-hidden="true">ğŸ“</span>
              <span class="bd-action__text">Add Demand</span>
              <span class="bd-action__hint">Request products</span>
            </a>

            <a href="/matches/buyer" class="bd-action bd-action--blue">
              <span class="bd-action__icon" aria-hidden="true">ğŸ””</span>
              <span class="bd-action__text">View Matches</span>
              <span class="bd-action__hint">Find suppliers</span>
            </a>

            <a href="/shipments/track" class="bd-action bd-action--black">
              <span class="bd-action__icon" aria-hidden="true">ğŸšš</span>
              <span class="bd-action__text">Track Shipments</span>
              <span class="bd-action__hint">Monitor delivery</span>
            </a>

            <a href="/contact" class="bd-action bd-action--green">
              <span class="bd-action__icon" aria-hidden="true">ğŸ“¨</span>
              <span class="bd-action__text">Contact Support</span>
              <span class="bd-action__hint">Get help</span>
            </a>
          </div>
        </div>
      </section>

      <!-- Recent Purchases -->
      <section class="bd-card bd-card--top-black">
        <header class="bd-card__head">
          <div>
            <h3 class="bd-card__title">Recent Purchases</h3>
            <p class="bd-card__sub">Your purchased items</p>
          </div>
        </header>

        <div class="bd-card__body">
          <% if (orderedProducts && orderedProducts.length) { %>
            <div class="bd-products">
              <% orderedProducts.slice(0, 4).forEach(p => { %>
                <div class="bd-product">
                  <div class="bd-product__img">
                    <% if (p.imageUrl) { %>
                      <img src="<%= p.imageUrl %>" alt="<%= p.name %>">
                    <% } else { %>
                      <div class="bd-product__ph" aria-hidden="true">No Image</div>
                    <% } %>
                  </div>

                  <div class="bd-product__info">
                    <div class="bd-product__name"><%= p.name %></div>
                    <div class="bd-product__meta">
                      <span class="bd-price">R <%= Number(p.price || 0).toFixed(2) %></span>
                      <% if (p.category) { %>
                        <span class="bd-muted"><%= p.category %></span>
                      <% } %>
                    </div>
                  </div>
                </div>
              <% }) %>

              <a href="/orders" class="bd-link">View All Purchases â†’</a>
            </div>
          <% } else { %>
            <div class="bd-empty">
              <div class="bd-empty__icon" aria-hidden="true">ğŸ›ï¸</div>
              <div class="bd-empty__title">No purchases yet</div>
              <div class="bd-empty__sub">Browse products and place your first order.</div>
              <a href="/sales" class="bd-btn bd-btn--primary">Browse Products</a>
            </div>
          <% } %>
        </div>
      </section>
    </section>

    <!-- Middle -->
    <section class="bd-col">
      <!-- Recent Orders -->
      <section class="bd-card bd-card--top-blue" id="orders-card">
        <header class="bd-card__head bd-card__head--row">
          <div>
            <h3 class="bd-card__title">Recent Orders</h3>
            <p class="bd-card__sub">Latest order activity</p>
          </div>

          <div class="bd-head-actions">
            <a href="/orders" class="bd-btn bd-btn--outline">View All</a>
          </div>
        </header>

        <div class="bd-card__body">
          <!-- NEW: Local filter controls (no route changes) -->
          <div class="bd-filters">
            <div class="bd-field">
              <label class="bd-label" for="orderSearch">Search</label>
              <input
                id="orderSearch"
                class="bd-input"
                type="search"
                placeholder="Search by Order ID or statusâ€¦"
                autocomplete="off"
              >
            </div>

            <div class="bd-field">
              <label class="bd-label" for="orderStatus">Status</label>
              <select id="orderStatus" class="bd-select">
                <option value="">All statuses</option>
                <option value="delivered">Delivered</option>
                <option value="completed">Completed</option>
                <option value="in-transit">In Transit</option>
                <option value="transit">Transit</option>
                <option value="shipped">Shipped</option>
                <option value="processing">Processing</option>
                <option value="pending">Pending</option>
                <option value="cancelled">Cancelled</option>
                <option value="refunded">Refunded</option>
              </select>
            </div>
          </div>

          <div class="bd-tablewrap">
            <table class="bd-table" id="ordersTable">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Status</th>
                  <th>Amount</th>
                  <th>Date</th>
                  <th class="bd-ta-right">Action</th>
                </tr>
              </thead>

              <tbody>
                <% if (orders && orders.length) { %>
                  <% orders.slice(0, 6).forEach(o => { %>
                    <%
                      const shownLabel = o.uiStatus || (o.status || 'Unknown');
                      const shownKey = o.uiStatusKey || String(shownLabel).toLowerCase().replace(/\s+/g,'-');
                      const oid = (o.orderId || o._id).toString().slice(-8);
                      const amountVal = Number((o.amount && o.amount.value) || 0).toFixed(2);
                      const dateVal = o.createdAt ? new Date(o.createdAt).toLocaleDateString('en-ZA', { month:'short', day:'numeric' }) : 'N/A';
                      const isRefunded = !!o._isRefunded;
                      const refundedNote = isRefunded
                        ? ('Refunded' + (o.refundedAt ? (' on ' + new Date(o.refundedAt).toLocaleDateString('en-ZA', { month:'short', day:'numeric' })) : ''))
                        : '';
                    %>

                    <tr class="bd-row"
                        data-order-id="<%= oid %>"
                        data-status="<%= shownKey %>"
                        data-search="<%= (oid + ' ' + shownKey + ' ' + String(shownLabel)).toLowerCase() %>">
                      <td>
                        <span class="bd-oid">#<%= oid %></span>
                      </td>

                      <td>
                        <span class="bd-status bd-status--<%= shownKey %>"><%= String(shownLabel).toUpperCase() %></span>
                        <% if (isRefunded) { %>
                          <div class="bd-subnote bd-subnote--danger"><%= refundedNote %></div>
                        <% } %>
                      </td>

                      <td>
                        <span class="bd-money">R <%= amountVal %></span>
                      </td>

                      <td>
                        <span class="bd-muted"><%= dateVal %></span>
                      </td>

                      <td class="bd-ta-right">
                        <a href="/orders/<%= o.orderId || o._id %>" class="bd-btn bd-btn--xs bd-btn--outline">View</a>
                      </td>
                    </tr>
                  <% }) %>

                  <tr class="bd-empty-row" id="ordersEmptyRow" style="display:none;">
                    <td colspan="5">
                      <div class="bd-empty bd-empty--compact">
                        <div class="bd-empty__icon" aria-hidden="true">ğŸ”</div>
                        <div class="bd-empty__title">No matching orders</div>
                        <div class="bd-empty__sub">Try a different search or status filter.</div>
                      </div>
                    </td>
                  </tr>
                <% } else { %>
                  <tr>
                    <td colspan="5">
                      <div class="bd-empty bd-empty--compact">
                        <div class="bd-empty__icon" aria-hidden="true">ğŸ“¦</div>
                        <div class="bd-empty__title">No orders yet</div>
                        <div class="bd-empty__sub">Start shopping to see your orders here.</div>
                        <a href="/sales" class="bd-btn bd-btn--primary bd-btn--sm">Start Shopping</a>
                      </div>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Shipping Status -->
      <section class="bd-card bd-card--top-green">
        <header class="bd-card__head">
          <div>
            <h3 class="bd-card__title">Shipping Status</h3>
            <p class="bd-card__sub">Delivery tracking</p>
          </div>
        </header>

        <div class="bd-card__body">
          <div class="bd-ship">
            <div class="bd-ship__item bd-ship__item--green">
              <div class="bd-ship__icon" aria-hidden="true">ğŸ“¬</div>
              <div>
                <div class="bd-ship__label">Delivered</div>
                <div class="bd-ship__value" data-kpi="delivered"><%= (shipStats && shipStats.delivered) || 0 %></div>
              </div>
            </div>

            <div class="bd-ship__item bd-ship__item--blue">
              <div class="bd-ship__icon" aria-hidden="true">ğŸšš</div>
              <div>
                <div class="bd-ship__label">In Transit</div>
                <div class="bd-ship__value" data-kpi="inTransit"><%= (shipStats && shipStats.inTransit) || 0 %></div>
              </div>
            </div>

            <div class="bd-ship__item bd-ship__item--purple">
              <div class="bd-ship__icon" aria-hidden="true">ğŸ­</div>
              <div>
                <div class="bd-ship__label">Processing</div>
                <div class="bd-ship__value" data-kpi="processing"><%= (shipStats && shipStats.processing) || 0 %></div>
              </div>
            </div>

            <div class="bd-ship__item bd-ship__item--amber">
              <div class="bd-ship__icon" aria-hidden="true">â³</div>
              <div>
                <div class="bd-ship__label">Pending</div>
                <div class="bd-ship__value" data-kpi="pendingOrders"><%= pendingOrders || 0 %></div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </section>

    <!-- Right -->
    <section class="bd-col">
      <!-- Demands -->
      <section class="bd-card bd-card--top-purple">
        <header class="bd-card__head bd-card__head--row">
          <div>
            <h3 class="bd-card__title">My Demands</h3>
            <p class="bd-card__sub">Track requests & matching</p>
          </div>

          <a href="/demands/mine" class="bd-btn bd-btn--outline bd-btn--sm">Manage</a>
        </header>

        <div class="bd-card__body">
          <div class="bd-summary">
            <div class="bd-summary__row">
              <span class="bd-muted">Active Demands</span>
              <span class="bd-pill bd-pill--purple"><%= (demands && demands.active) || 0 %></span>
            </div>
            <div class="bd-summary__row">
              <span class="bd-muted">Pending Matches</span>
              <span class="bd-pill bd-pill--blue"><%= (demands && demands.pendingMatches) || 0 %></span>
            </div>
          </div>

          <div class="bd-cta">
            <a href="/demands/add" class="bd-btn bd-btn--primary">
              <span aria-hidden="true">ğŸ“</span> Create Demand
            </a>
            <a href="/matches/buyer" class="bd-btn bd-btn--outline">
              <span aria-hidden="true">ğŸ””</span> View Matches
            </a>
          </div>
        </div>
      </section>

      <!-- Matches -->
      <section class="bd-card bd-card--top-green">
        <header class="bd-card__head">
          <div>
            <h3 class="bd-card__title">Product Matches</h3>
            <p class="bd-card__sub">Recommended for you</p>
          </div>
        </header>

        <div class="bd-card__body">
          <% if (matches && matches.length) { %>
            <div class="bd-matches">
              <% matches.slice(0, 3).forEach(match => { %>
                <div class="bd-match">
                  <div class="bd-match__info">
                    <div class="bd-match__name"><%= match.productName || 'Product Match' %></div>
                    <div class="bd-match__meta">
                      <span class="bd-muted">by <%= match.supplierName || 'Supplier' %></span>
                      <span class="bd-price">R <%= Number(match.price || 0).toFixed(2) %></span>
                    </div>
                  </div>
                  <div>
                    <a href="/matches/view/<%= match._id %>" class="bd-btn bd-btn--xs bd-btn--outline">View</a>
                  </div>
                </div>
              <% }) %>

              <a href="/matches/buyer" class="bd-link">View All Matches â†’</a>
            </div>
          <% } else { %>
            <div class="bd-empty bd-empty--compact">
              <div class="bd-empty__icon" aria-hidden="true">ğŸ””</div>
              <div class="bd-empty__title">No matches yet</div>
              <div class="bd-empty__sub">Create demands to get product matches.</div>
              <a href="/demands/add" class="bd-btn bd-btn--primary bd-btn--sm">Create Demand</a>
            </div>
          <% } %>
        </div>
      </section>

      <!-- System Status -->
      <section class="bd-card bd-card--top-black">
        <header class="bd-card__head bd-card__head--row">
          <div>
            <h3 class="bd-card__title">System Status</h3>
            <p class="bd-card__sub">Platform availability</p>
          </div>

          <span class="bd-chip <%= mailerOk ? 'bd-chip--ok' : 'bd-chip--bad' %>">
            <%= mailerOk ? 'Online' : 'Offline' %>
          </span>
        </header>

        <div class="bd-card__body">
          <div class="bd-status">
            <div class="bd-status__row">
              <span class="bd-dot bd-dot--online"></span>
              <span class="bd-status__name">Order System</span>
              <span class="bd-status__val bd-status__val--ok">Operational</span>
            </div>

            <div class="bd-status__row">
              <span class="bd-dot <%= mailerOk ? 'bd-dot--online' : 'bd-dot--offline' %>"></span>
              <span class="bd-status__name">Email Notifications</span>
              <span class="bd-status__val <%= mailerOk ? 'bd-status__val--ok' : 'bd-status__val--bad' %>">
                <%= mailerOk ? 'Active' : 'Inactive' %>
              </span>
            </div>

            <div class="bd-status__row">
              <span class="bd-dot bd-dot--online"></span>
              <span class="bd-status__name">Payment Gateway</span>
              <span class="bd-status__val bd-status__val--ok">Online</span>
            </div>

            <div class="bd-status__row">
              <span class="bd-dot bd-dot--online"></span>
              <span class="bd-status__name">Support System</span>
              <span class="bd-status__val bd-status__val--ok">Available</span>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <!-- Footer -->
  <footer class="bd-footer">
    <div class="bd-footer__grid">
      <div class="bd-footer__col">
        <h4 class="bd-footer__title">Quick Links</h4>
        <a href="/contact" class="bd-footer__link">ğŸ“¨ Contact Support</a>
        <a href="/demands/mine" class="bd-footer__link">ğŸ“‹ My Demands</a>
        <a href="/matches/buyer" class="bd-footer__link">ğŸ”” Product Matches</a>
        <a href="/shipments/track" class="bd-footer__link">ğŸšš Track Shipments</a>
      </div>

      <div class="bd-footer__col">
        <h4 class="bd-footer__title">Account</h4>
        <div class="bd-footer__info">
          <span class="bd-footer__label">Logged in as</span>
          <span class="bd-footer__value"><%= (business && business.email) || '-' %></span>
        </div>
        <div class="bd-footer__info">
          <span class="bd-footer__label">Member since</span>
          <span class="bd-footer__value">
            <%= new Date((business && business.createdAt) || Date.now()).toLocaleDateString('en-ZA', { month: 'long', year: 'numeric' }) %>
          </span>
        </div>

        <form action="/business/logout" method="post" class="bd-footer__logout">
          <button type="submit" class="bd-footer__link bd-footer__btn">ğŸšª Logout</button>
        </form>
      </div>

      <div class="bd-footer__col">
        <h4 class="bd-footer__title">Support</h4>
        <div class="bd-footer__info">
          <span class="bd-footer__label">Need help with your orders?</span>
          <a href="/contact" class="bd-footer__accent">Contact our team â†’</a>
        </div>
        <div class="bd-footer__info">
          <span class="bd-footer__label">Have product demands?</span>
          <a href="/demands/add" class="bd-footer__accent">Create demand â†’</a>
        </div>
        <div class="bd-footer__info">
          <span class="bd-footer__label">Payment issues?</span>
          <a href="/contact" class="bd-footer__accent">Get support â†’</a>
        </div>
      </div>
    </div>

    <div class="bd-footer__bottom">
      <small>Â© <%= new Date().getFullYear() %> <%= (business && business.name) ? business.name : 'Your Business' %></small>
    </div>
  </footer>
</section>

<style nonce="<%= NONCE %>">
  :root{
    --brand-purple:#7C3AED;
    --brand-blue:#2563EB;
    --brand-green:#22C55E;
    --brand-black:#0F172A;

    --bg:#F8FAFC;
    --card:#FFFFFF;
    --muted:#64748B;
    --line:#E2E8F0;

    --danger:#EF4444;
    --amber:#F59E0B;
  }

  .pg-buyer-dashboard{
    min-height:100vh;
    background:var(--bg);
  }

  /* Header */
  .bd-header{
    background:linear-gradient(135deg, var(--brand-purple) 0%, var(--brand-blue) 100%);
    color:#fff;
    border-radius:0 0 16px 16px;
    box-shadow:0 10px 30px rgba(15,23,42,.18);
    padding:14px 14px 10px;
    margin-bottom:16px;
  }
  .bd-header__inner{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    max-width:1200px;
    margin:0 auto;
  }
  .bd-welcome{ display:flex; align-items:center; gap:12px; min-width:260px; }
  .bd-avatar{
    width:54px; height:54px; border-radius:999px;
    background:var(--brand-green);
    display:flex; align-items:center; justify-content:center;
    font-weight:800; font-size:22px;
    box-shadow:0 10px 18px rgba(34,197,94,.22);
    flex:0 0 auto;
  }
  .bd-title{ margin:0; font-size:18px; line-height:1.15; font-weight:800; letter-spacing:.2px; }
  .bd-title__name{ font-weight:900; }
  .bd-meta{ display:flex; align-items:center; gap:10px; margin-top:6px; flex-wrap:wrap; }
  .bd-badge{
    background:rgba(15,23,42,.9);
    border:1px solid rgba(255,255,255,.14);
    padding:6px 10px;
    border-radius:999px;
    font-size:11px;
    font-weight:800;
    letter-spacing:.6px;
  }
  .bd-live{ display:flex; align-items:center; gap:8px; font-size:13px; color:rgba(255,255,255,.92); }
  .bd-dot{ width:8px; height:8px; border-radius:999px; display:inline-block; }
  .bd-dot--online{ background:var(--brand-green); box-shadow:0 0 0 4px rgba(34,197,94,.2); }
  .bd-dot--offline{ background:var(--danger); box-shadow:0 0 0 4px rgba(239,68,68,.18); }

  .bd-stats{
    display:grid;
    grid-template-columns:repeat(3, minmax(110px, 1fr));
    gap:10px;
    width:min(520px, 100%);
  }
  .bd-stat{
    background:rgba(255,255,255,.14);
    border:1px solid rgba(255,255,255,.18);
    border-radius:12px;
    padding:10px 10px;
    backdrop-filter: blur(6px);
  }
  .bd-stat--accent{ border-left:3px solid var(--brand-green); }
  .bd-stat__label{ display:block; font-size:12px; opacity:.9; margin-bottom:2px; }
  .bd-stat__value{ display:block; font-size:14px; font-weight:800; letter-spacing:.2px; }

  /* Notifications */
  .bd-notifs{ max-width:1200px; margin:10px auto 0; }
  .bd-notif{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px;
    border-radius:12px;
    margin-bottom:8px;
    box-shadow:0 10px 20px rgba(15,23,42,.12);
    border:1px solid rgba(255,255,255,.14);
    transition:transform .2s ease, opacity .2s ease;
  }
  .bd-notif--success{ background:rgba(34,197,94,.96); }
  .bd-notif--error{ background:rgba(239,68,68,.96); }
  .bd-notif__icon{ width:22px; height:22px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:rgba(15,23,42,.15); font-weight:900; }
  .bd-notif__text{ font-weight:700; font-size:13px; }
  .bd-notif__close{
    margin-left:auto;
    background:transparent;
    border:none;
    color:#fff;
    font-size:22px;
    cursor:pointer;
    opacity:.85;
    padding:0 6px;
    line-height:1;
  }

  /* Layout */
  .bd-content{
    max-width:1200px;
    margin:0 auto 18px;
    padding:0 14px;
    display:grid;
    grid-template-columns:1fr;
    gap:14px;
  }
  .bd-col{ display:flex; flex-direction:column; gap:14px; }

  @media (min-width: 1024px){
    .bd-content{ grid-template-columns: 1.05fr 1.25fr 1fr; }
  }

  /* Cards */
  .bd-card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    box-shadow:0 8px 22px rgba(15,23,42,.06);
    overflow:hidden;
  }
  .bd-card--top-purple{ border-top:4px solid var(--brand-purple); }
  .bd-card--top-blue{ border-top:4px solid var(--brand-blue); }
  .bd-card--top-green{ border-top:4px solid var(--brand-green); }
  .bd-card--top-black{ border-top:4px solid var(--brand-black); }

  .bd-card__head{
    padding:14px 14px 8px;
  }
  .bd-card__head--row{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .bd-card__title{
    margin:0;
    color:var(--brand-black);
    font-size:15px;
    font-weight:900;
    letter-spacing:.2px;
  }
  .bd-card__sub{
    margin:4px 0 0;
    color:var(--muted);
    font-size:12px;
  }
  .bd-card__body{ padding:0 14px 14px; }

  /* Buttons */
  .bd-btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    border-radius:12px;
    padding:10px 12px;
    font-weight:800;
    font-size:13px;
    text-decoration:none;
    cursor:pointer;
    border:2px solid transparent;
    transition:transform .15s ease, opacity .15s ease, box-shadow .15s ease;
    user-select:none;
  }
  .bd-btn:hover{ opacity:.95; transform:translateY(-1px); }
  .bd-btn--primary{ background:var(--brand-purple); color:#fff; box-shadow:0 10px 20px rgba(124,58,237,.18); }
  .bd-btn--outline{ background:#fff; color:var(--brand-purple); border-color:rgba(124,58,237,.35); }
  .bd-btn--sm{ padding:8px 10px; font-size:12px; border-radius:10px; }
  .bd-btn--xs{ padding:7px 10px; font-size:12px; border-radius:10px; }

  /* KPIs */
  .bd-kpis{
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:10px;
  }
  .bd-kpi{
    border-radius:14px;
    padding:12px;
    color:#fff;
    display:flex;
    gap:10px;
    align-items:flex-start;
    box-shadow:0 10px 22px rgba(15,23,42,.10);
  }
  .bd-kpi--blue{ background:linear-gradient(135deg, var(--brand-blue), rgba(37,99,235,.82)); }
  .bd-kpi--green{ background:linear-gradient(135deg, var(--brand-green), rgba(34,197,94,.82)); }
  .bd-kpi--amber{ background:linear-gradient(135deg, var(--amber), rgba(245,158,11,.82)); }
  .bd-kpi--black{ background:linear-gradient(135deg, var(--brand-black), rgba(15,23,42,.86)); }
  .bd-kpi__icon{ font-size:22px; width:38px; height:38px; border-radius:12px; background:rgba(255,255,255,.14); display:flex; align-items:center; justify-content:center; }
  .bd-kpi__label{ font-size:12px; opacity:.92; font-weight:800; }
  .bd-kpi__value{ font-size:24px; font-weight:900; line-height:1; margin-top:4px; }
  .bd-kpi__hint{ font-size:11px; opacity:.9; margin-top:6px; }

  /* Actions */
  .bd-actions{
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:10px;
  }
  .bd-action{
    border-radius:16px;
    padding:12px 12px;
    text-decoration:none;
    color:#fff;
    display:flex;
    flex-direction:column;
    align-items:center;
    text-align:center;
    gap:6px;
    box-shadow:0 12px 24px rgba(15,23,42,.10);
    transition:transform .15s ease, opacity .15s ease;
  }
  .bd-action:hover{ transform:translateY(-2px); opacity:.98; }
  .bd-action__icon{ font-size:20px; }
  .bd-action__text{ font-weight:900; font-size:13px; }
  .bd-action__hint{ font-size:11px; opacity:.92; }
  .bd-action--purple{ background:linear-gradient(135deg, var(--brand-purple), rgba(124,58,237,.82)); }
  .bd-action--blue{ background:linear-gradient(135deg, var(--brand-blue), rgba(37,99,235,.82)); }
  .bd-action--black{ background:linear-gradient(135deg, var(--brand-black), rgba(15,23,42,.86)); }
  .bd-action--green{ background:linear-gradient(135deg, var(--brand-green), rgba(34,197,94,.82)); }

  /* Products */
  .bd-products{ display:flex; flex-direction:column; gap:10px; }
  .bd-product{
    display:flex; align-items:center; gap:10px;
    background:rgba(124,58,237,.06);
    border:1px solid rgba(124,58,237,.16);
    border-left:4px solid var(--brand-purple);
    border-radius:14px;
    padding:10px;
  }
  .bd-product__img img{
    width:48px; height:48px; border-radius:12px; object-fit:cover;
    border:1px solid var(--line);
    display:block;
  }
  .bd-product__ph{
    width:48px; height:48px; border-radius:12px;
    background:#E2E8F0;
    display:flex; align-items:center; justify-content:center;
    color:var(--muted);
    font-size:11px;
    border:1px solid var(--line);
  }
  .bd-product__name{ font-weight:900; color:var(--brand-black); font-size:13px; }
  .bd-product__meta{ display:flex; gap:10px; flex-wrap:wrap; margin-top:4px; font-size:12px; }

  /* Links / text helpers */
  .bd-link{
    display:block;
    text-align:center;
    margin-top:6px;
    font-weight:900;
    text-decoration:none;
    color:var(--brand-purple);
  }
  .bd-link:hover{ opacity:.9; }
  .bd-muted{ color:var(--muted); }
  .bd-price{ color:var(--brand-green); font-weight:900; }
  .bd-money{ color:var(--brand-green); font-weight:900; }
  .bd-oid{ color:var(--brand-purple); font-weight:900; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

  /* Filters */
  .bd-filters{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    margin-bottom:12px;
    padding:10px;
    border:1px dashed rgba(124,58,237,.25);
    background:rgba(124,58,237,.04);
    border-radius:14px;
  }
  @media (min-width: 640px){
    .bd-filters{ grid-template-columns: 1.2fr .8fr; align-items:end; }
  }
  .bd-field{ display:flex; flex-direction:column; gap:6px; }
  .bd-label{ font-size:12px; font-weight:900; color:var(--brand-black); }
  .bd-input, .bd-select{
    width:100%;
    border-radius:12px;
    border:1px solid rgba(15,23,42,.14);
    background:#fff;
    padding:10px 12px;
    font-size:13px;
    outline:none;
    transition:border-color .15s ease, box-shadow .15s ease;
  }
  .bd-input::placeholder{ color:#94A3B8; }
  .bd-input:focus, .bd-select:focus{
    border-color:rgba(124,58,237,.55);
    box-shadow:0 0 0 4px rgba(124,58,237,.16);
  }

  /* Table */
  .bd-tablewrap{
    width:100%;
    overflow:auto;
    border-radius:14px;
    border:1px solid var(--line);
  }
  .bd-table{
    width:100%;
    border-collapse:collapse;
    min-width:560px;
    background:#fff;
  }
  .bd-table thead th{
    text-align:left;
    padding:10px 12px;
    font-size:12px;
    font-weight:900;
    color:var(--brand-black);
    background:rgba(37,99,235,.06);
    border-bottom:2px solid rgba(124,58,237,.35);
    position:sticky;
    top:0;
    z-index:1;
  }
  .bd-table tbody td{
    padding:12px;
    border-bottom:1px solid var(--line);
    vertical-align:top;
    font-size:13px;
  }
  .bd-table tbody tr:hover{ background:rgba(15,23,42,.02); }
  .bd-ta-right{ text-align:right; }

  .bd-status{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .bd-status__row{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 10px;
    background:rgba(15,23,42,.02);
    border:1px solid rgba(15,23,42,.06);
    border-radius:14px;
  }
  .bd-status__name{ flex:1; font-weight:900; color:var(--brand-black); font-size:13px; }
  .bd-status__val{ font-weight:900; font-size:13px; }
  .bd-status__val--ok{ color:var(--brand-green); }
  .bd-status__val--bad{ color:var(--danger); }

  .bd-chip{
    padding:8px 10px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    color:#fff;
    border:1px solid rgba(15,23,42,.08);
  }
  .bd-chip--ok{ background:var(--brand-green); }
  .bd-chip--bad{ background:var(--danger); }

  /* Status badge mapping (table) */
  .bd-status{
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .bd-status__row{ /* already defined above */ }

  .bd-status{
    /* keep */
  }

  .bd-status-row{
    /* unused, safe */
  }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  .bd-status{ /* keep */ }

  /* Status badges */
  .bd-status{
    /* not table badge; table badge below */
  }
  .bd-status{
    /* keep */
  }
  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  /* Table status badge */
  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  /* real mapping */
  .bd-status{
    /* keep */
  }
  .bd-status{
    /* keep */
  }
  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  /* status badge itself */
  .bd-status{
    /* keep */
  }
  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  /* actual class */
  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  /* This is the table badge class */
  .bd-status{
    /* keep */
  }
  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  /* final: badge */
  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  /* ok enough - define badge styles */
  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  /* Badge styles (this one matters) */
  .bd-status{
    /* keep */
  }
  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  /* Real */
  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  .bd-status{
    /* keep */
  }

  /* The badge we use in the table is .bd-status */
  .bd-status{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 10px;
    border-radius:999px;
    font-size:11px;
    font-weight:900;
    color:#fff;
    letter-spacing:.5px;
    background:#64748B;
  }
  .bd-status--delivered,
  .bd-status--completed,
  .bd-status--shipped{ background:var(--brand-green); }
  .bd-status--pending,
  .bd-status--processing{ background:var(--amber); }
  .bd-status--in-transit,
  .bd-status--transit{ background:var(--brand-blue); }
  .bd-status--cancelled,
  .bd-status--refunded{ background:var(--danger); }

  .bd-subnote{ margin-top:6px; font-size:12px; font-weight:900; }
  .bd-subnote--danger{ color:var(--danger); }

  /* Summary / pills */
  .bd-summary{
    display:flex;
    flex-direction:column;
    gap:10px;
    margin-bottom:12px;
  }
  .bd-summary__row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:10px 10px;
    border-radius:14px;
    background:rgba(15,23,42,.02);
    border:1px solid rgba(15,23,42,.06);
  }
  .bd-pill{
    min-width:40px;
    text-align:center;
    padding:6px 10px;
    border-radius:999px;
    font-weight:900;
    font-size:12px;
    color:#fff;
  }
  .bd-pill--purple{ background:var(--brand-purple); }
  .bd-pill--blue{ background:var(--brand-blue); }

  .bd-cta{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }

  /* Matches */
  .bd-matches{ display:flex; flex-direction:column; gap:10px; }
  .bd-match{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    padding:10px;
    border-radius:14px;
    background:rgba(34,197,94,.05);
    border:1px solid rgba(34,197,94,.14);
    border-left:4px solid var(--brand-purple);
  }
  .bd-match__name{ font-weight:900; color:var(--brand-black); font-size:13px; }
  .bd-match__meta{ margin-top:4px; display:flex; gap:10px; flex-wrap:wrap; font-size:12px; }

  /* Shipping */
  .bd-ship{
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:10px;
  }
  .bd-ship__item{
    display:flex; gap:10px; align-items:center;
    padding:10px;
    border-radius:14px;
    border:1px solid var(--line);
    background:#fff;
  }
  .bd-ship__icon{
    width:40px; height:40px; border-radius:14px;
    display:flex; align-items:center; justify-content:center;
    color:#fff; font-size:18px; font-weight:900;
  }
  .bd-ship__label{ font-size:12px; font-weight:900; color:var(--brand-black); opacity:.9; }
  .bd-ship__value{ font-size:20px; font-weight:900; }

  .bd-ship__item--green .bd-ship__icon{ background:var(--brand-green); }
  .bd-ship__item--green .bd-ship__value{ color:var(--brand-green); }

  .bd-ship__item--blue .bd-ship__icon{ background:var(--brand-blue); }
  .bd-ship__item--blue .bd-ship__value{ color:var(--brand-blue); }

  .bd-ship__item--purple .bd-ship__icon{ background:var(--brand-purple); }
  .bd-ship__item--purple .bd-ship__value{ color:var(--brand-purple); }

  .bd-ship__item--amber .bd-ship__icon{ background:var(--amber); }
  .bd-ship__item--amber .bd-ship__value{ color:var(--amber); }

  /* Empty */
  .bd-empty{
    text-align:center;
    padding:16px 10px;
    border-radius:16px;
    border:1px dashed rgba(124,58,237,.25);
    background:rgba(124,58,237,.04);
  }
  .bd-empty--compact{ padding:14px 10px; }
  .bd-empty__icon{ font-size:34px; opacity:.6; }
  .bd-empty__title{ margin-top:6px; font-weight:900; color:var(--brand-black); }
  .bd-empty__sub{ margin-top:4px; color:var(--muted); font-size:12px; }

  /* Footer */
  .bd-footer{
    background:var(--brand-black);
    color:#fff;
    margin-top:16px;
    padding:18px 14px;
  }
  .bd-footer__grid{
    max-width:1200px;
    margin:0 auto;
    display:grid;
    grid-template-columns:1fr;
    gap:16px;
  }
  @media (min-width: 768px){
    .bd-footer__grid{ grid-template-columns:repeat(3, 1fr); }
  }
  .bd-footer__title{
    margin:0 0 10px;
    font-size:14px;
    font-weight:900;
  }
  .bd-footer__link{
    display:flex;
    gap:10px;
    align-items:center;
    text-decoration:none;
    color:#E2E8F0;
    padding:6px 0;
    font-weight:800;
    font-size:13px;
  }
  .bd-footer__link:hover{ color:#fff; }
  .bd-footer__info{ display:flex; flex-direction:column; gap:2px; margin-bottom:10px; }
  .bd-footer__label{ color:#94A3B8; font-weight:800; font-size:12px; }
  .bd-footer__value{ color:#fff; font-weight:800; font-size:13px; word-break:break-word; }
  .bd-footer__accent{ color:var(--brand-purple); font-weight:900; text-decoration:none; }
  .bd-footer__accent:hover{ opacity:.9; }
  .bd-footer__logout{ margin-top:8px; }
  .bd-footer__btn{
    background:rgba(255,255,255,.08);
    border:1px solid rgba(255,255,255,.12);
    padding:10px 12px;
    border-radius:12px;
    cursor:pointer;
  }
  .bd-footer__bottom{
    max-width:1200px;
    margin:14px auto 0;
    border-top:1px solid rgba(255,255,255,.10);
    padding-top:12px;
    color:#94A3B8;
    text-align:center;
    font-weight:800;
  }

  /* Mobile-first tweaks (Hisense U50 Lite) */
  @media (max-width: 640px){
    .bd-stats{ grid-template-columns:1fr; }
    .bd-kpis{ grid-template-columns:1fr; }
    .bd-actions{ grid-template-columns:1fr; }
    .bd-ship{ grid-template-columns:1fr; }
    .bd-table{ min-width:520px; }
  }

  /* Value update animation */
  @keyframes valueUpdate { 0%{transform:scale(1)} 50%{transform:scale(1.06)} 100%{transform:scale(1)} }
  .value-updated{ animation:valueUpdate .45s ease; color:var(--brand-green) !important; }
</style>

<script nonce="<%= NONCE %>">
  // Session timer
  function startSessionTimer() {
    const timerElement = document.getElementById('session-time');
    if (!timerElement) return;

    let seconds = 0;
    setInterval(() => {
      seconds++;
      const hours = Math.floor(seconds / 3600);
      const minutes = Math.floor((seconds % 3600) / 60);
      const secs = seconds % 60;

      timerElement.textContent =
        String(hours).padStart(2, '0') + ':' +
        String(minutes).padStart(2, '0') + ':' +
        String(secs).padStart(2, '0');
    }, 1000);
  }

  // Close notifications
  function setupNotifications() {
    document.querySelectorAll('.bd-notif__close').forEach(button => {
      button.addEventListener('click', (e) => {
        const notif = e.target.closest('.bd-notif');
        if (!notif) return;
        notif.style.opacity = '0';
        notif.style.transform = 'translateY(-8px)';
        setTimeout(() => notif.remove(), 220);
      });
    });

    // Auto-hide success notifications after 5s
    setTimeout(() => {
      document.querySelectorAll('.bd-notif--success').forEach(notif => {
        notif.style.opacity = '0';
        notif.style.transform = 'translateY(-8px)';
        setTimeout(() => notif.remove(), 220);
      });
    }, 5000);
  }

  // Local table filter (no route changes)
  function setupOrderFilters() {
    const searchEl = document.getElementById('orderSearch');
    const statusEl = document.getElementById('orderStatus');
    const table = document.getElementById('ordersTable');
    const emptyRow = document.getElementById('ordersEmptyRow');

    if (!searchEl || !statusEl || !table) return;

    const rows = Array.from(table.querySelectorAll('tbody tr.bd-row'));

    function applyFilters() {
      const q = String(searchEl.value || '').trim().toLowerCase();
      const status = String(statusEl.value || '').trim().toLowerCase();

      let shown = 0;
      rows.forEach(r => {
        const hay = String(r.getAttribute('data-search') || '');
        const st = String(r.getAttribute('data-status') || '');

        const matchQ = !q || hay.includes(q);
        const matchS = !status || st.includes(status);

        const ok = matchQ && matchS;
        r.style.display = ok ? '' : 'none';
        if (ok) shown++;
      });

      if (emptyRow) emptyRow.style.display = shown === 0 ? '' : 'none';
    }

    searchEl.addEventListener('input', applyFilters);
    statusEl.addEventListener('change', applyFilters);

    applyFilters();
  }

  // Auto-refresh dashboard data (keeps your route exactly)
  async function refreshDashboardData() {
    try {
      const res = await fetch('/business/api/buyer/stats', {
        credentials: 'same-origin',
        headers: { 'Cache-Control': 'no-cache' }
      });
      if (!res.ok) return;

      const data = await res.json().catch(() => ({}));
      if (!data || data.ok === false) return;

      const paint = (el, value) => {
        if (!el || value === undefined) return;
        const next = String(value);
        if (el.textContent !== next) {
          el.textContent = next;
          el.classList.add('value-updated');
          setTimeout(() => el.classList.remove('value-updated'), 500);
        }
      };

      paint(document.querySelector('[data-kpi="totalOrders"]'), data.totalOrders);
      paint(document.querySelector('[data-kpi="completedOrders"]'), data.completedOrders);
      paint(document.querySelectorAll('[data-kpi="pendingOrders"]')[0], data.pendingOrders);
      paint(document.querySelectorAll('[data-kpi="pendingOrders"]')[1], data.pendingOrders);
      paint(document.querySelectorAll('[data-kpi="inTransit"]')[0], data.inTransit);
      paint(document.querySelectorAll('[data-kpi="inTransit"]')[1], data.inTransit);

      paint(document.querySelector('[data-kpi="delivered"]'), data.delivered);
      paint(document.querySelector('[data-kpi="processing"]'), data.processing);

      console.log('ğŸ”„ Buyer dashboard refreshed at', new Date().toLocaleTimeString());
    } catch (err) {
      console.warn('Dashboard refresh failed:', err);
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    startSessionTimer();
    setupNotifications();
    setupOrderFilters();

    refreshDashboardData();
    setInterval(refreshDashboardData, 30000);

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) refreshDashboardData();
    });
  });
</script>
