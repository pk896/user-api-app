<!-- views/dashboards/buyer-dashboard.ejs -->
<div class="pill in-transit">
  🚚 In transit: <strong><%= (shipStats && shipStats.inTransit) || 0 %></strong>
</div>
<div class="pill delivered">
  ✅ Delivered: <strong><%= (shipStats && shipStats.delivered) || 0 %></strong>
</div>

<section class="dashboard-home">
  <h1 class="page-title">🛒 Welcome, <%= business.name %>! (buyer D)</h1>
  <p class="subtitle">Track your orders, demands, and new supplier matches.</p>

  <% if (success && success.length > 0) { %>
    <div class="flash flash-success" id="flashMessage">✅ <%= success %></div>
  <% } %>
  <% if (error && error.length > 0) { %>
    <div class="flash flash-error" id="flashMessage">❌ <%= error %></div>
  <% } %>

  <!-- ============================
       🔔 Matches Overview (NEW)
       ============================ -->
  <section class="buyer-stats-wrap">
    <h2 class="section-title">🔔 Matches Overview</h2>

    <!-- Stats -->
    <div class="buyer-stats-grid" id="buyerStatsGrid">
      <div class="bstat-card">
        <div class="bstat-label">Total matches</div>
        <div class="bstat-value" id="stTotal">—</div>
      </div>
      <div class="bstat-card">
        <div class="bstat-label">Pending</div>
        <div class="bstat-value" id="stPending">—</div>
      </div>
      <div class="bstat-card">
        <div class="bstat-label">Accepted</div>
        <div class="bstat-value" id="stAccepted">—</div>
      </div>
      <div class="bstat-card">
        <div class="bstat-label">Rejected</div>
        <div class="bstat-value" id="stRejected">—</div>
      </div>
      <div class="bstat-card new">
        <div class="bstat-label">New since last visit</div>
        <div class="bstat-value" id="stNew">0</div>
      </div>
    </div>

    <!-- Per-demand chips -->
    <h3 class="subhead">By demand</h3>
    <div id="perDemand" class="demand-chip-list"></div>

    <!-- Actions -->
    <div class="buyer-stats-actions">
      <form id="markSeenForm" method="POST" action="/matches/buyer/mark-seen">
        <button class="btn btn-secondary" type="submit">Mark as seen</button>
      </form>
      <a class="btn btn-primary" href="/matches/buyer">Open matched products</a>
      <a class="btn btn-light" href="/buyer/demands">📋 My Demands</a>
      <a class="btn btn-light" href="/buyer/demands/add">📝 Add Demand</a>
    </div>

    <!-- Compact notifications list -->
    <div class="buyer-notifs">
      <div class="notif-head">
        <h3>Recent Matches</h3>
        <span id="notifBadge" class="badge">0</span>
      </div>
      <div id="notifList" class="notif-list">Loading…</div>
    </div>
  </section>

  <!-- ============================
       📊 Order Stats (existing)
       ============================ -->
  <section class="stats-grid">
    <div class="stat-card"><h2>💼 Total Orders</h2><p class="stat-number"><%= totalOrders || 0 %></p></div>
    <div class="stat-card"><h2>✅ Completed</h2><p class="stat-number"><%= completedOrders || 0 %></p></div>
    <div class="stat-card"><h2>⏳ Pending</h2><p class="stat-number"><%= pendingOrders || 0 %></p></div>
    <a href="/shipments/track" class="btn btn-primary">🚚 Track Shipment</a>
    <a href="/buyer/demands/add" class="btn btn-secondary">📝 Add Demand</a>
    <a href="/buyer/demands" class="btn btn-secondary">📋 My Demands</a>
  </section>

  <!-- ============================
       🧾 Products you ordered
       ============================ -->
  <section class="recent-section">
    <h2>🧾 Products You Purchased</h2>
    <% if (orderedProducts && orderedProducts.length) { %>
      <ul class="order-list">
        <% orderedProducts.forEach(p => { %>
          <li>
            <% if (p.imageUrl) { %><img class="thumb" src="<%= p.imageUrl %>" alt=""><% } %>
            <strong><a href="/products/view/<%= p.customId %>"><%= p.name %></a></strong>
            — $<%= Number(p.price || 0).toFixed(2) %>
            <% if (p.category) { %> | <span class="muted">Category: <%= p.category %></span> <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p>No purchased products yet.</p>
    <% } %>
  </section>

  <!-- ============================
       🧾 Recent Orders
       ============================ -->
  <section class="recent-section">
    <h2>🧾 Your Recent Orders</h2>
    <% if (orders && orders.length > 0) { %>
      <ul class="order-list">
        <% orders.forEach(o => { %>
          <li>
            <strong>Order ID:</strong> <%= o.orderId || o._id %> |
            <strong>Status:</strong> <%= o.status || 'N/A' %> |
            <strong>Total:</strong> <%= o.amount && o.amount.value ? ('$' + o.amount.value) : '—' %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p>You haven’t placed any orders yet.</p>
    <% } %>
  </section>
</section>

<!-- ============================
     Scripts
     ============================ -->
<script nonce="<%= nonce %>">
document.addEventListener("DOMContentLoaded", () => {
  // Animate existing order stats
  document.querySelectorAll(".stat-number").forEach(n => {
    const target = +n.textContent || 0;
    let c = 0, step = Math.ceil(Math.max(1, target/40));
    const id = setInterval(()=>{ c+=step; if(c>=target){c=target; clearInterval(id);} n.textContent=c; }, 25);
  });

  // Flash close
  const flash = document.getElementById("flashMessage");
  if (flash) {
    setTimeout(()=>{ flash.classList.add("fade-out"); setTimeout(()=>flash.remove(),600); }, 5000);
    flash.addEventListener("click", ()=>{ flash.classList.add("fade-out"); setTimeout(()=>flash.remove(),600); });
  }
});

// --- Matches widgets (fetch summary) ---
(async function(){
  async function fetchJSON(url, opts){ const r = await fetch(url, opts); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

  try {
    const data = await fetchJSON('/matches/buyer/summary');
    if (!data.ok) throw new Error('Failed');

    const c = data.counters || {};
    const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = (v ?? 0); };
    setText('stTotal', c.total);
    setText('stPending', c.pending);
    setText('stAccepted', c.accepted);
    setText('stRejected', c.rejected);
    setText('stNew', c.newSince);

    // Per-demand chips
    const wrap = document.getElementById('perDemand');
    if (wrap) {
      wrap.innerHTML = '';
      (data.perDemand || []).forEach(item => {
        const a = document.createElement('a');
        a.className = 'demand-chip';
        a.href = '/matches/buyer?demand=' + item.demandId;
        a.innerHTML = `
          <span class="title">${item.title}</span>
          <span class="counts">T:${item.total} • P:${item.pending || 0} • A:${item.accepted || 0} • R:${item.rejected || 0}</span>
        `;
        wrap.appendChild(a);
      });
    }

    // Notifications list (top 6)
    const badge = document.getElementById('notifBadge');
    if (badge) badge.textContent = c.newSince ?? 0;

    const box = document.getElementById('notifList');
    if (box) {
      box.innerHTML = '';
      (data.perDemand || []).slice(0, 6).forEach(x => {
        const item = document.createElement('a');
        item.className = 'notif-item';
        item.href = '/matches/buyer?demand=' + x.demandId;
        item.innerHTML = `<span class="title">${x.title}</span><span class="meta">T:${x.total} • P:${x.pending||0} • A:${x.accepted||0}</span>`;
        box.appendChild(item);
      });
      if (!box.children.length) box.textContent = 'No matches yet.';
    }

    // Mark as seen
    const form = document.getElementById('markSeenForm');
    if (form) {
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        try {
          await fetchJSON('/matches/buyer/mark-seen', { method:'POST', headers:{'Content-Type':'application/json'}, body: '{}' });
          setText('stNew', 0);
          const badge = document.getElementById('notifBadge'); if (badge) badge.textContent = '0';
        } catch(_) {}
      });
    }
  } catch (err) {
    console.error('buyer-stats load failed', err);
  }
})();
</script>

<!-- ============================
     Styles (mobile-first; tuned for U50 Lite)
     ============================ -->
<style>
  /* Pills */
  .pill { display:inline-block; margin:.25rem .5rem; padding:.35rem .6rem; border-radius:999px; font-weight:700; }
  .pill.in-transit { background:#eef2ff; color:#3730a3; }
  .pill.delivered  { background:#dcfce7; color:#166534; }
  .thumb { width:40px; height:40px; object-fit:cover; border-radius:.4rem; margin-right:.35rem; vertical-align:middle; }
  .btn.btn-secondary { background:#f3f4f6; color:#111; margin-left:.5rem; }
  .btn.btn-secondary:hover { background:#e5e7eb; }

  /* Section titles */
  .section-title { font-size:1.05rem; margin:.4rem 0 .3rem; }

  /* ===== Matches Overview ===== */
  .buyer-stats-wrap { margin:.6rem 0 1rem; padding:.6rem; border:1px solid var(--border, #e5e7eb); border-radius:.8rem; background:var(--card-bg, #fff); }
  .buyer-stats-grid {
    display:grid; gap:.5rem;
    grid-template-columns: repeat(2, minmax(0,1fr)); /* phones first */
  }
  .bstat-card { padding:.6rem; border:1px solid var(--border,#e5e7eb); border-radius:.6rem; background:var(--card-bg,#fff); }
  .bstat-card.new { border-style:dashed; }
  .bstat-label { font-size:.85rem; color:#6b7280; }
  .bstat-value { font-size:1.25rem; font-weight:800; letter-spacing:.2px; }

  /* Chips */
  .demand-chip-list { display:flex; flex-wrap:wrap; gap:.4rem; margin:.5rem 0 .4rem; }
  .demand-chip {
    display:inline-flex; align-items:center; gap:.45rem;
    padding:.35rem .55rem; border:1px solid var(--border,#e5e7eb);
    border-radius:999px; text-decoration:none; background:var(--card-bg,#fff); color:inherit;
  }
  .demand-chip .title { font-weight:600; }
  .demand-chip .counts { color:#6b7280; font-size:.85rem; }

  /* Actions */
  .buyer-stats-actions { display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.4rem; }
  .btn { padding:.55rem .8rem; border-radius:.55rem; border:0; cursor:pointer; display:inline-block; text-decoration:none; }
  .btn-primary { background:#2563eb; color:#fff; }
  .btn-secondary { background:#f3f4f6; color:#111; }
  .btn-light { background:#ffffff; color:#111; border:1px solid var(--border,#e5e7eb); }

  /* Notifications */
  .buyer-notifs { margin-top:.6rem; }
  .buyer-notifs .notif-head { display:flex; align-items:center; gap:.5rem; }
  .buyer-notifs .badge { background:#ef4444; color:#fff; border-radius:999px; padding:.1rem .5rem; font-weight:700; min-width:20px; text-align:center; }
  .notif-list { display:flex; flex-direction:column; gap:.4rem; margin-top:.4rem; }
  .notif-item {
    display:flex; justify-content:space-between; gap:.6rem;
    padding:.5rem .6rem; border:1px solid var(--border,#e5e7eb); border-radius:.6rem;
    text-decoration:none; color:inherit; background:var(--card-bg,#fff);
  }
  .notif-item .title { font-weight:600; }
  .notif-item .meta { color:#6b7280; font-size:.9rem; }

  /* ===== Existing sections (minimal tweaks) ===== */
  .stats-grid { display:grid; gap:.6rem; grid-template-columns:repeat(2, minmax(0,1fr)); margin-top:.6rem; align-items:start; }
  .stats-grid .stat-card { padding:.7rem; border:1px solid var(--border,#e5e7eb); border-radius:.7rem; background:var(--card-bg,#fff); }
  .stats-grid .btn { text-align:center; }

  .recent-section { margin-top:1rem; }
  .recent-section h2 { font-size:1.05rem; margin-bottom:.4rem; }
  .order-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:.4rem; }
  .order-list li { padding:.55rem .6rem; border:1px solid var(--border,#e5e7eb); border-radius:.6rem; background:var(--card-bg,#fff); }
  .order-list .muted { color:#6b7280; }

  /* ===== Responsive breakpoints (optimize for small phones like Hisense U50 Lite) ===== */
  @media (min-width: 540px){
    .buyer-stats-grid { grid-template-columns: repeat(3, 1fr); }
    .stats-grid { grid-template-columns: repeat(3, minmax(0,1fr)); }
  }
  @media (min-width: 900px){
    .buyer-stats-grid { grid-template-columns: repeat(5, 1fr); }
    .stats-grid { grid-template-columns: repeat(6, minmax(0,1fr)); }
  }

  /* Ultra-small phones: compress paddings/fonts slightly */
  @media (max-width: 360px){
    .btn{ padding:.5rem .7rem; font-size:.95rem; }
    .bstat-value{ font-size:1.15rem; }
    .notif-item .meta{ font-size:.85rem; }
  }
</style>
