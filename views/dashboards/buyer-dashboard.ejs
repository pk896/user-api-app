<!-- views/dashboards/buyer-dashboard.ejs -->
<section class="dashboard buyer">
  <h1 class="page-title">
    üëã Welcome, <%= (business && business.name) || 'Buyer' %>!
    <span class="role-badge buyer">BUYER</span>
  </h1>
  <p class="subtitle">
    Track your orders, shipments, and product matches in one place.
  </p>

  <% (success || []).forEach(msg => { %>
    <div class="flash flash-success">‚úÖ <%= msg %></div>
  <% }) %>
  <% (error || []).forEach(msg => { %>
    <div class="flash flash-error">‚ùå <%= msg %></div>
  <% }) %>

  <!-- Toolbar -->
  <div class="toolbar">
    <div class="toolbar-left">
      <span class="pill pill-mail">
        üìß Mail
        <span class="status-dot <%= mailerOk ? 'ok' : 'down' %>"></span>
        <span class="status-text"><%= mailerOk ? 'OK' : 'Down' %></span>
      </span>
      <span class="muted small hide-sm">
        Logged in as <strong><%= (business && business.email) || '-' %></strong>
      </span>
    </div>
    <div class="toolbar-right">
      <a class="btn xs light" href="/contact">üì® Contact</a>
      <a class="btn xs light" href="/demands/mine">üìã Demands</a>
      <form action="/business/logout" method="post" class="logout-form">
        <button type="submit" class="btn xs danger">üö™ Logout</button>
      </form>
    </div>
  </div>

  <!-- KPIs -->
  <section class="kpi-grid">
    <div class="kpi-card">
      <h2>üì¶ Total Orders</h2>
      <p class="kpi-num"><%= totalOrders || 0 %></p>
    </div>

    <div class="kpi-card">
      <h2>‚úÖ Completed</h2>
      <p class="kpi-num"><%= completedOrders || 0 %></p>
    </div>

    <div class="kpi-card">
      <h2>‚è≥ Pending</h2>
      <p class="kpi-num"><%= pendingOrders || 0 %></p>
    </div>

    <div class="kpi-card">
      <h2>üöö In Transit</h2>
      <p class="kpi-num"><%= (shipStats && shipStats.inTransit) || 0 %></p>
    </div>

    <div class="kpi-card">
      <h2>üì¨ Delivered</h2>
      <p class="kpi-num"><%= (shipStats && shipStats.delivered) || 0 %></p>
    </div>
  </section>

  <!-- Quick Actions -->
  <div class="actions-row">
    <a class="btn primary" href="/demands/add">üìù Add Demand</a>
    <a class="btn light" href="/matches/buyer">üîî View Matches</a>
    <a class="btn light" href="/shipments/track">üöö Track Shipment</a>
  </div>

  <!-- Two Column Layout -->
  <section class="layout-grid">
    <!-- Recent Orders -->
    <div class="block">
      <div class="block-head">
        <h3>üßæ Recent Orders</h3>
        <span class="chip chip-soft">latest 5</span>
      </div>

      <div class="table-wrap small">
        <table class="nice-table compact">
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Status</th>
              <th class="right">Amount</th>
            </tr>
          </thead>
          <tbody>
            <% if (orders && orders.length) { %>
              <% orders.forEach(o => { %>
                <tr>
                  <td class="truncate">
                    <a href="/orders/<%= o.orderId || o._id %>" class="order-link">
                      <%= (o.orderId || o._id).toString().substring(0, 12) %>...
                    </a>
                  </td>
                  <td>
                    <span class="status-pill status-<%= (o.status || 'Unknown').toLowerCase().replace(/\s+/g,'-') %>">
                      <%= o.status || 'Unknown' %>
                    </span>
                  </td>
                  <td class="right">
                    R <%= Number(o.amount && o.amount.value || 0).toFixed(2) %>
                  </td>
                </tr>
              <% }) %>
            <% } else { %>
              <tr>
                <td colspan="3" class="muted center">
                  No orders yet.
                </td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Purchased Products -->
    <div class="block">
      <div class="block-head">
        <h3>üõçÔ∏è Purchased Products</h3>
        <span class="chip chip-soft orange">your items</span>
      </div>

      <div class="products-list">
        <% if (orderedProducts && orderedProducts.length) { %>
          <% orderedProducts.slice(0, 6).forEach(p => { %>
            <div class="product-item">
              <% if (p.imageUrl) { %>
                <img src="<%= p.imageUrl %>" alt="" class="thumb">
              <% } %>
              <div class="product-info">
                <div class="product-name"><%= p.name %></div>
                <div class="product-meta">
                  <span class="price">R <%= Number(p.price || 0).toFixed(2) %></span>
                  <% if (p.category) { %>
                    <span class="category"><%= p.category %></span>
                  <% } %>
                </div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <p class="muted small center">
            No purchased products yet.
          </p>
        <% } %>
      </div>

      <hr class="divider">

      <!-- Quick Stats -->
      <div class="mini-kpis">
        <div class="mini-card">
          <div class="mini-title">Total Orders</div>
          <div class="mini-num"><%= totalOrders || 0 %></div>
        </div>
        <div class="mini-card">
          <div class="mini-title">Completed</div>
          <div class="mini-num"><%= completedOrders || 0 %></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Matches Overview -->
  <section class="block">
    <div class="block-head">
      <h3>üîî Matches Overview</h3>
      <div class="block-actions">
        <a href="/matches/buyer" class="btn xs primary">View All</a>
        <a href="/demands/add" class="btn xs light">Add Demand</a>
      </div>
    </div>

    <div class="matches-placeholder">
      <p class="muted small">
        Product matching features will appear here when you create demands.
      </p>
      <div class="actions-row">
        <a class="btn light" href="/demands/add">üìù Create Your First Demand</a>
      </div>
    </div>
  </section>
</section>

<style nonce="<%= nonce %>">
  .dashboard.buyer {
    padding: 1rem;
    max-width: 1100px;
    margin: 0 auto 2rem;
  }
  .page-title {
    margin-top: .4rem;
    font-size: 1.6rem;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: .5rem;
    justify-content: center;
  }
  .subtitle {
    text-align: center;
    margin: .2rem 0 1rem;
    color: #6b7280;
  }
  .dark-theme .subtitle { color: #cbd5e1; }

  .role-badge.buyer {
    padding: .2rem .6rem;
    border-radius: 999px;
    font-size: .75rem;
    font-weight: 700;
    background: #fef3c7;
    color: #92400e;
    border: 1px solid #fde68a;
  }

  .flash {
    padding: .6rem .9rem;
    border-radius: .6rem;
    margin: .4rem auto;
    max-width: 700px;
    font-weight: 600;
  }
  .flash-success {
    background: #dcfce7;
    color: #166534;
    border: 1px solid #86efac;
  }
  .flash-error {
    background: #fee2e2;
    color: #b91c1c;
    border: 1px solid #fecaca;
  }

  .toolbar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: .7rem;
    margin: .4rem 0 1rem;
    flex-wrap: wrap;
  }
  .toolbar-left, .toolbar-right {
    display: flex;
    align-items: center;
    gap: .5rem;
    flex-wrap: wrap;
  }
  .pill {
    display: inline-flex;
    align-items: center;
    gap: .35rem;
    padding: .25rem .6rem;
    border-radius: 999px;
    font-size: .8rem;
    font-weight: 600;
    background: #eef2ff;
    color: #3730a3;
    border: 1px solid #c7d2fe;
  }
  .status-dot {
    width: .45rem;
    height: .45rem;
    border-radius: 999px;
  }
  .status-dot.ok { background: #22c55e; }
  .status-dot.down { background: #ef4444; }
  .status-text { font-weight: 700; font-size: .78rem; }
  .muted { color: #6b7280; }
  .muted.small { font-size: .82rem; }
  .dark-theme .muted { color: #9ca3af; }

  .logout-form { margin: 0; }

  /* KPIs */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: .8rem;
    margin: .8rem 0 1rem;
  }
  .kpi-card {
    background: #ffffff;
    border-radius: .75rem;
    padding: .8rem;
    border: 1px solid rgba(148, 163, 184, .25);
    box-shadow: 0 1px 3px rgba(15, 23, 42, 0.06);
    text-align: center;
  }
  .dark-theme .kpi-card {
    background: #020617;
    border-color: #1f2937;
  }
  .kpi-card h2 {
    font-size: .9rem;
    margin-bottom: .25rem;
    color: #0f172a;
  }
  .dark-theme .kpi-card h2 { color: #e5e7eb; }
  .kpi-num {
    font-size: 1.4rem;
    font-weight: 800;
    color: #2563eb;
  }

  .actions-row {
    display: flex;
    flex-wrap: wrap;
    gap: .6rem;
    margin-bottom: 1rem;
    justify-content: center;
  }

  /* Blocks & layout */
  .layout-grid {
    display: grid;
    grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr);
    gap: 1rem;
    margin-bottom: 1.1rem;
  }
  @media (max-width: 800px) {
    .layout-grid { grid-template-columns: minmax(0,1fr); }
    .toolbar { flex-direction: column; align-items: flex-start; }
    .hide-sm { display: none; }
  }

  .block {
    background: #ffffff;
    border-radius: .9rem;
    padding: .9rem;
    border: 1px solid rgba(148, 163, 184, .2);
    box-shadow: 0 1px 4px rgba(15, 23, 42, 0.06);
    margin-bottom: 1rem;
  }
  .dark-theme .block {
    background: #020617;
    border-color: #1f2937;
  }
  .block-head {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: .6rem;
    margin-bottom: .5rem;
  }
  .block-head h3 {
    font-size: 1.02rem;
    font-weight: 700;
  }
  .block-actions {
    display: flex;
    gap: .4rem;
    flex-wrap: wrap;
  }
  .divider {
    border: none;
    border-top: 1px dashed rgba(148, 163, 184, .5);
    margin: .7rem 0;
  }

  .table-wrap {
    overflow-x: auto;
    border-radius: .75rem;
    border: 1px solid rgba(148, 163, 184, .3);
    background: #ffffff;
  }
  .table-wrap.small { border-radius: .7rem; }
  .dark-theme .table-wrap {
    background: #020617;
    border-color: #1f2937;
  }

  .nice-table {
    width: 100%;
    border-collapse: collapse;
    font-size: .9rem;
  }
  .nice-table thead th {
    padding: .55rem .6rem;
    background: #f8fafc;
    text-align: left;
    border-bottom: 1px solid rgba(148, 163, 184, .3);
    white-space: nowrap;
  }
  .dark-theme .nice-table thead th {
    background: #020617;
    border-bottom-color: #1f2937;
  }
  .nice-table td {
    padding: .5rem .6rem;
    border-bottom: 1px solid rgba(148, 163, 184, .2);
  }
  .nice-table tbody tr:last-child td {
    border-bottom: none;
  }
  .center { text-align: center; }
  .right { text-align: right; }

  .truncate {
    max-width: 120px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .order-link {
    color: #2563eb;
    text-decoration: none;
    font-weight: 600;
  }
  .order-link:hover {
    text-decoration: underline;
  }

  .status-pill {
    display: inline-flex;
    align-items: center;
    padding: .16rem .45rem;
    border-radius: 999px;
    font-size: .78rem;
    font-weight: 600;
    background: #e5e7eb;
    color: #111827;
  }
  .status-completed, 
  .status-delivered { background: #dcfce7; color: #166534; }
  .status-pending, 
  .status-processing { background: #fef9c3; color: #92400e; }
  .status-shipped,
  .status-in-transit { background: #dbeafe; color: #1e40af; }
  .status-cancelled,
  .status-refunded { background: #fee2e2; color: #b91c1c; }

  /* Products List */
  .products-list {
    display: flex;
    flex-direction: column;
    gap: .6rem;
  }
  .product-item {
    display: flex;
    align-items: center;
    gap: .6rem;
    padding: .5rem;
    border-radius: .6rem;
    background: #f8fafc;
    border: 1px solid rgba(148, 163, 184, .2);
  }
  .dark-theme .product-item {
    background: #1f2937;
    border-color: #374151;
  }
  .thumb {
    width: 40px;
    height: 40px;
    border-radius: .4rem;
    object-fit: cover;
    flex-shrink: 0;
  }
  .product-info {
    flex: 1;
    min-width: 0;
  }
  .product-name {
    font-weight: 600;
    font-size: .9rem;
    margin-bottom: .1rem;
  }
  .product-meta {
    display: flex;
    gap: .6rem;
    font-size: .8rem;
  }
  .price {
    font-weight: 700;
    color: #16a34a;
  }
  .category {
    color: #6b7280;
  }

  .mini-kpis {
    display: flex;
    gap: .6rem;
    flex-wrap: wrap;
  }
  .mini-card {
    flex: 1;
    min-width: 100px;
    padding: .55rem .7rem;
    border-radius: .7rem;
    background: #f1f5f9;
    border: 1px solid rgba(148, 163, 184, .4);
    text-align: center;
  }
  .dark-theme .mini-card {
    background: #020617;
    border-color: #1f2937;
  }
  .mini-title {
    font-size: .8rem;
    color: #64748b;
  }
  .mini-num {
    margin-top: .1rem;
    font-weight: 700;
    font-size: 1.1rem;
  }

  .chip {
    display: inline-flex;
    align-items: center;
    gap: .25rem;
    padding: .2rem .6rem;
    border-radius: 999px;
    font-size: .78rem;
    border: 1px solid rgba(148, 163, 184, .4);
    background: #f9fafb;
    color: #111827;
  }
  .chip-soft {
    background: #e0f2fe;
    color: #075985;
    border-color: #bae6fd;
  }
  .chip-soft.orange {
    background: #fef3c7;
    color: #92400e;
    border-color: #fde68a;
  }

  .matches-placeholder {
    text-align: center;
    padding: 1rem;
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: .3rem;
    padding: .45rem .9rem;
    border-radius: .7rem;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #111827;
    font-weight: 700;
    font-size: .86rem;
    text-decoration: none;
    cursor: pointer;
  }
  .btn.primary {
    background: #2563eb;
    border-color: #1d4ed8;
    color: #fff;
  }
  .btn.light {
    background: #f3f4f6;
    border-color: #e5e7eb;
  }
  .btn.danger {
    background: #fee2e2;
    border-color: #fecaca;
    color: #b91c1c;
  }
  .btn.xs {
    padding: .34rem .6rem;
    font-size: .8rem;
  }
</style>

<script nonce="<%= nonce %>">
// Simple auto-refresh for orders count (optional)
(async function setupBuyerAutoRefresh() {
  async function refreshStats() {
    try {
      // You can add API endpoints later for live updates
      console.log('üîÑ Buyer stats refresh placeholder');
    } catch (_) {
      // Silent fail
    }
  }

  // Refresh every 30 seconds
  setInterval(refreshStats, 30000);
})();
</script>