<div class="pill in-transit">
  ğŸšš In transit: <strong><%= (shipStats && shipStats.inTransit) || 0 %></strong>
</div>
<div class="pill delivered">
  âœ… Delivered: <strong><%= (shipStats && shipStats.delivered) || 0 %></strong>
</div>

<section class="dashboard-home">
  <h1 class="page-title">ğŸ›’ Welcome, <%= business.name %>! (buyer D)</h1>
  <p class="subtitle">Track your orders and the products you purchased.</p>

  <% if (success && success.length > 0) { %>
    <div class="flash flash-success" id="flashMessage">âœ… <%= success %></div>
  <% } %>
  <% if (error && error.length > 0) { %>
    <div class="flash flash-error" id="flashMessage">âŒ <%= error %></div>
  <% } %>

  <!-- ğŸ“Š Order Stats -->
  <section class="stats-grid">
    <div class="stat-card"><h2>ğŸ’¼ Total Orders</h2><p class="stat-number"><%= totalOrders || 0 %></p></div>
    <div class="stat-card"><h2>âœ… Completed</h2><p class="stat-number"><%= completedOrders || 0 %></p></div>
    <div class="stat-card"><h2>â³ Pending</h2><p class="stat-number"><%= pendingOrders || 0 %></p></div>
    <a href="/shipments/track" class="btn btn-primary">ğŸšš Track Shipment</a>
    <a href="/buyer/demands/add" class="btn btn-secondary">ğŸ“ Add Demand</a>
    <a href="/buyer/demands" class="btn btn-secondary">ğŸ“‹ My Demands</a>
  </section>

  <!-- ğŸ§¾ Products you ordered -->
  <section class="recent-section">
    <h2>ğŸ§¾ Products You Purchased</h2>
    <% if (orderedProducts && orderedProducts.length) { %>
      <ul class="order-list">
        <% orderedProducts.forEach(p => { %>
          <li>
            <% if (p.imageUrl) { %><img class="thumb" src="<%= p.imageUrl %>" alt=""><% } %>
            <strong><a href="/products/view/<%= p.customId %>"><%= p.name %></a></strong>
            â€” $<%= Number(p.price || 0).toFixed(2) %>
            <% if (p.category) { %> | <span class="muted">Category: <%= p.category %></span> <% } %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p>No purchased products yet.</p>
    <% } %>
  </section>

  <!-- ğŸ§¾ Recent Orders -->
  <section class="recent-section">
    <h2>ğŸ§¾ Your Recent Orders</h2>
    <% if (orders && orders.length > 0) { %>
      <ul class="order-list">
        <% orders.forEach(o => { %>
          <li>
            <strong>Order ID:</strong> <%= o.orderId || o._id %> |
            <strong>Status:</strong> <%= o.status || 'N/A' %> |
            <strong>Total:</strong> <%= o.amount && o.amount.value ? ('$' + o.amount.value) : 'â€”' %>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p>You havenâ€™t placed any orders yet.</p>
    <% } %>
  </section>
</section>

<!-- styles (reuse your existing styles and add small bits) -->
<style>
  .pill { display:inline-block; margin:.25rem .5rem; padding:.35rem .6rem; border-radius:999px; font-weight:700; }
  .pill.in-transit { background:#eef2ff; color:#3730a3; }
  .pill.delivered { background:#dcfce7; color:#166534; }
  .thumb { width:40px; height:40px; object-fit:cover; border-radius:.4rem; margin-right:.35rem; vertical-align:middle; }
  .btn.btn-secondary { background:#f3f4f6; color:#111; margin-left:.5rem; }
  .btn.btn-secondary:hover { background:#e5e7eb; }
</style>

<script nonce="<%= nonce %>">
document.addEventListener("DOMContentLoaded", () => {
  document.querySelectorAll(".stat-number").forEach(n => {
    const target = +n.textContent || 0;
    let c = 0, step = Math.ceil(Math.max(1, target/40));
    const id = setInterval(()=>{ c+=step; if(c>=target){c=target; clearInterval(id);} n.textContent=c; }, 25);
  });
  const flash = document.getElementById("flashMessage");
  if (flash) {
    setTimeout(()=>{ flash.classList.add("fade-out"); setTimeout(()=>flash.remove(),600); }, 5000);
    flash.addEventListener("click", ()=>{ flash.classList.add("fade-out"); setTimeout(()=>flash.remove(),600); });
  }
});
</script>
