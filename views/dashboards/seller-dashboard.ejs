<!-- views/dashboards/seller-dashboard.ejs -->
<section class="dashboard-home">
  <h1 class="page-title">
    üëã Welcome, <%= business.name %>! (seller D)
    <span class="role-badge <%= business.role %>">
      <%= (business.role || 'unknown').toUpperCase() %>
    </span>
  </h1>
  <p class="subtitle">
    Manage your inventory, orders, and shipping ‚Äî all in one place.
    <% if (business.role !== 'seller') { %>
      <span class="warn">Note: your role is <strong><%= business.role %></strong>, not seller.</span>
    <% } %>
  </p>

  <% if (success && success.length > 0) { %>
    <div class="flash flash-success" id="flashMessage">‚úÖ <%= success %></div>
  <% } %>
  <% if (error && error.length > 0) { %>
    <div class="flash flash-error" id="flashMessage">‚ùå <%= error %></div>
  <% } %>

  <!-- üìä Top Stats -->
  <section class="stats-grid">
    <div class="stat-card">
      <h2>üõçÔ∏è Total Products</h2>
      <p class="stat-number"><%= totals.totalProducts || 0 %></p>
    </div>

    <div class="stat-card">
      <h2>üì¶ Total Stock</h2>
      <p class="stat-number"><%= totals.totalStock || 0 %></p>
    </div>

    <div class="stat-card">
      <h2>‚ö†Ô∏è Low Stock (‚â§5)</h2>
      <p class="stat-number"><%= totals.lowStock || 0 %></p>
    </div>

    <div class="stat-card">
      <h2>‚ùå Out of Stock</h2>
      <p class="stat-number"><%= totals.outOfStock || 0 %></p>
    </div>

    <div class="stat-card">
      <h2>üßæ Orders</h2>
      <p class="stat-number"><%= orders.total || 0 %></p>
      <p class="muted">
        <small>
          <% Object.keys(orders.byStatus || {}).forEach(s => { %>
            <span class="chip"><%= s %>: <%= orders.byStatus[s] %></span>
          <% }) %>
        </small>
      </p>
    </div>

    <div class="stat-card">
      <h2>üöö Shipments</h2>
      <p class="stat-number"><%= shipments.total || 0 %></p>
      <p class="muted">
        <small>
          <% ['Pending','Processing','In Transit','Delivered','Canceled','Cancelled'].forEach(s => { %>
            <span class="chip"><%= s %>: <%= (shipments.byStatus && shipments.byStatus[s]) || 0 %></span>
          <% }) %>
        </small>
      </p>
    </div>
  </section>

  <!-- üßæ Per-product stock (with totals) -->
  <section class="recent-section">
    <h2>üßæ Your Products & Stock</h2>
    <% if (products && products.length) { %>
      <div class="table-wrap">
        <table class="nice-table">
          <thead>
            <tr>
              <th>Product</th>
              <th>Price</th>
              <th>Stock</th>
              <th>Sold (Units)</th>
              <th>Orders</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
          <% products.forEach(p => { %>
            <tr>
              <td class="pname">
                <% if (p.imageUrl) { %><img class="thumb" src="<%= p.imageUrl %>" alt=""><% } %>
                <div>
                  <strong><%= p.name %></strong>
                  <div class="muted">ID: <%= p.customId %></div>
                  <% if (p.category) { %><div class="muted">Category: <%= p.category %></div><% } %>
                </div>
              </td>
              <td>$<%= Number(p.price || 0).toFixed(2) %></td>
              <td>
                <% const s = Number(p.stock || 0); %>
                <span class="stock-badge <%= s<=0 ? 'empty' : (s<=5 ? 'low' : 'ok') %>">
                  <%= s %>
                </span>
              </td>
              <td><%= Number(p.soldCount || 0) %></td>
              <td><%= Number(p.soldOrders || 0) %></td>
              <td class="row-actions">
                <a class="btn small" href="/products/edit/<%= p.customId %>">‚úèÔ∏è Edit</a>
                <a class="btn small" href="/shipments/by-product/<%= p._id %>">üöö Shipments</a>
                <a class="btn small" href="/products/delete/<%= p.customId %>" onclick="return confirm('Delete this product?')">üóëÔ∏è Delete</a>
              </td>
            </tr>
          <% }) %>
          </tbody>
          <tfoot>
            <tr>
              <th colspan="2" class="right">Totals:</th>
              <th><%= totals.totalStock || 0 %></th>
              <th><%= products.reduce((a,p)=>a+(Number(p.soldCount||0)),0) %></th>
              <th><%= products.reduce((a,p)=>a+(Number(p.soldOrders||0)),0) %></th>
              <th></th>
            </tr>
          </tfoot>
        </table>
      </div>
    <% } else { %>
      <p>No products yet. Start by adding your first one.</p>
    <% } %>
  </section>

  <!-- üßæ Recent Orders (preview) -->
  <section class="recent-section">
    <h2>üßæ Recent Orders</h2>
    <% if (orders.recent && orders.recent.length) { %>
      <ul class="orders-list">
        <% orders.recent.forEach(o => { %>
          <li>
            <strong>#<%= o.orderId || o._id %></strong>
            ‚Äî Status: <%= o.status || 'N/A' %>
            ‚Äî Amount: <%= o.amount && o.amount.value ? ('$' + o.amount.value) : '‚Äî' %>
            <span class="muted"> <%= new Date(o.createdAt).toLocaleString() %></span>
          </li>
        <% }) %>
      </ul>
    <% } else { %>
      <p>No orders yet.</p>
    <% } %>
  </section>

  <!-- ‚öôÔ∏è Quick Actions -->
  <div class="actions">
    <a href="/products/add" class="btn btn-primary">‚ûï Add Product</a>
    <a href="/products/all" class="btn btn-secondary">üìã View All Products</a>
    <a href="/shipments" class="btn btn-secondary">üöö Manage Shipments</a>
  </div>
</section>

<style>
  .dashboard-home { padding:1rem; }
  .page-title { margin-top:1rem; font-size:2rem; font-weight:700; text-align:center; }
  .subtitle { color:#6b7280; margin-bottom:1.3rem; text-align:center; }
  .warn { color:#b45309; margin-left:.5rem; }

  .role-badge { margin-left:.5rem; padding:.2rem .55rem; font-size:.75rem; border-radius:999px; font-weight:700; }
  .role-badge.seller { background:#dbeafe; color:#1d4ed8; }
  .role-badge.supplier { background:#dcfce7; color:#166534; }
  .role-badge.buyer { background:#fde68a; color:#92400e; }

  .flash { margin-bottom:1rem; padding:.8rem 1rem; border-radius:.5rem; font-weight:500; animation:fadeIn .3s ease; cursor:pointer; transition:opacity .6s,transform .6s; }
  .flash-success { background:#dcfce7; color:#166534; border:1px solid #bbf7d0; }
  .flash-error { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }
  .flash.fade-out { opacity:0; transform:translateY(-10px); }
  @keyframes fadeIn { from{opacity:0; transform:translateY(-5px);} to{opacity:1; transform:translateY(0);} }

  .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem; margin-bottom:1.25rem; }
  .stat-card { background:#f3f4f6; padding:1.1rem; border-radius:.75rem; box-shadow:0 2px 5px rgba(0,0,0,0.08); text-align:center; transition:transform .2s,box-shadow .2s; }
  .stat-card:hover { transform:translateY(-3px); box-shadow:0 4px 8px rgba(0,0,0,0.1); }
  .dark-theme .stat-card { background:#1f2937; color:#f9fafb; }
  .stat-number { font-size:1.7rem; font-weight:bold; color:#2563eb; }
  .chip { display:inline-block; background:#eef2ff; color:#3730a3; border-radius:999px; padding:.05rem .5rem; margin:.05rem; }

  .table-wrap { overflow-x:auto; }
  .nice-table { width:100%; border-collapse:collapse; background:#fff; border-radius:.75rem; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.06); }
  .dark-theme .nice-table { background:#0b1220; color:#e5e7eb; }
  .nice-table th, .nice-table td { padding:.75rem .7rem; border-bottom:1px solid #e5e7eb; vertical-align:middle; }
  .nice-table thead th { background:#f8fafc; text-align:left; }
  .dark-theme .nice-table thead th { background:#111827; }
  .nice-table tfoot th { background:#f1f5f9; }
  .dark-theme .nice-table tfoot th { background:#0f172a; }
  .pname { display:flex; gap:.7rem; align-items:center; }
  .thumb { width:40px; height:40px; object-fit:cover; border-radius:.4rem; }
  .muted { color:#6b7280; font-size:.85rem; }
  .stock-badge { font-weight:700; padding:.1rem .45rem; border-radius:.4rem; }
  .stock-badge.ok { background:#dcfce7; color:#166534; }
  .stock-badge.low { background:#fef9c3; color:#92400e; }
  .stock-badge.empty { background:#fee2e2; color:#991b1b; }
  .row-actions .btn.small { margin-right:.4rem; }

  .orders-list { list-style:none; padding:0; margin:0; }
  .orders-list li { padding:.55rem .7rem; margin-bottom:.4rem; border-radius:.5rem; background:#f9fafb; box-shadow:0 1px 3px rgba(0,0,0,0.05); }
  .dark-theme .orders-list li { background:#111827; color:#e5e7eb; }

  .actions { display:flex; gap:.8rem; margin-top:1.1rem; justify-content:center; }
  .btn { display:inline-block; padding:.55rem .95rem; border-radius:.55rem; text-decoration:none; font-weight:600; transition:background .2s ease; }
  .btn.btn-primary { background:#2563eb; color:#fff; }
  .btn.btn-primary:hover { background:#1d4ed8; }
  .btn.btn-secondary { background:#f3f4f6; color:#111; }
  .dark-theme .btn.btn-secondary { background:#374151; color:#f9fafb; }
  .btn.small { font-size:.85rem; padding:.4rem .6rem; }
</style>

<script nonce="<%= nonce %>">
document.addEventListener("DOMContentLoaded", () => {
  // Animate stat numbers
  document.querySelectorAll(".stat-number").forEach(n => {
    const target = +n.textContent || 0;
    let count = 0, step = Math.ceil(Math.max(1, target / 40));
    const id = setInterval(() => {
      count += step;
      if (count >= target) { count = target; clearInterval(id); }
      n.textContent = count;
    }, 25);
  });

  // Auto-hide flash
  const flash = document.getElementById("flashMessage");
  if (flash) {
    setTimeout(() => { flash.classList.add("fade-out"); setTimeout(()=>flash.remove(), 600); }, 5000);
    flash.addEventListener("click", ()=>{ flash.classList.add("fade-out"); setTimeout(()=>flash.remove(), 600); });
  }
});
</script>
