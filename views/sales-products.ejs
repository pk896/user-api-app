<% /* ------------------------------------------------------------
   Amazon-style Shop (mobile-first, Hisense U50 Lite friendly)
   Uses your real Delivery Options API for live shipping summary.
   Endpoints used:
     ‚Ä¢ GET /api/cart  (fallback /cart/items)
     ‚Ä¢ GET /api/cart/add?pid=:customId&json=1[&size=][&color=]
     ‚Ä¢ GET /api/delivery-options[?region=&sort=&order=&limit=]
     ‚Ä¢ Product details: /products/view/:customId
   Expects locals: products, success, error, nonce, themeCss
------------------------------------------------------------- */ %>

<!-- ‚úÖ Flash Messages -->
<% if (success && success.length) { %>
  <div class="flash flash-success">‚úÖ <%= success %></div>
<% } %>
<% if (error && error.length) { %>
  <div class="flash flash-error">‚ùå <%= error %></div>
<% } %>

<main id="shopRoot" class="amz-wrap <%= (themeCss||'').includes('dark') ? 'dark-theme' : 'light-theme' %>">
  <!-- ====== Top Nav (Amazon-like) ====== -->
  <header class="amz-top">
    <a href="/home" class="brand">üåç Unicoporate.com</a>

    <form id="searchForm" class="amz-search" role="search" action="javascript:void(0)">
      <select id="catSelect" aria-label="Category">
        <option value="">All</option>
        <option value="electronics">Electronics</option>
        <option value="fashion">Fashion</option>
        <option value="home">Home</option>
        <option value="beauty">Beauty</option>
        <option value="groceries">Groceries</option>
        <option value="clothes">Clothes</option>
        <option value="second-hand-clothes">Second Hand Clothes</option>
        <option value="uncategorized-second-hand-things">Uncategorized Second Hand Things</option>
      </select>
      <input id="searchInput" type="search" placeholder="Search Phakisi" aria-label="Search products" autocomplete="off" />
      <button id="searchBtn" type="submit" class="amz-search-btn">üîç</button>
    </form>

    <nav class="amz-quick">
      <a href="/payment/orders" class="amz-link">Orders</a>
      <button id="cartBtn" class="amz-cart-btn" type="button">üõí <span class="cart-count-top" id="cartCountTop">0</span></button>
    </nav>
  </header>

  <!-- ====== Below-Nav tools ====== -->
  <div class="amz-subnav">
    <div class="left">
      <button id="filterToggle" class="subnav-btn" type="button">‚ò∞ Filters</button>
      <button id="viewToggle" class="subnav-btn" type="button" aria-pressed="true">‚ò∞ List</button>
    </div>

    <div class="subnav-meta">
      <span id="resultMeta"><%= (products && products.length) || 0 %> results</span>
      <label class="sort-wrap">
        <span>Sort:</span>
        <select id="sortSelect" aria-label="Sort">
          <option value="relevance">Relevance</option>
          <option value="price-asc">Price: Low ‚Üí High</option>
          <option value="price-desc">Price: High ‚Üí Low</option>
          <option value="new">Newest</option>
          <option value="name">Name A‚ÄìZ</option>
        </select>
      </label>
    </div>
  </div>

  <div class="amz-body">
    <!-- ====== Sidebar Filters ====== -->
    <aside id="sidebar" class="amz-side" aria-label="Filters">
      <section class="filter-block">
        <h3>Delivery</h3>
        <label class="chk"><input type="checkbox" id="inStockOnly" /> In stock only</label>
        <div class="region-row">
          <label for="regionSelect">Region</label>
          <select id="regionSelect">
            <option value="">All regions</option>
          </select>
        </div>
        <div class="tiny" id="shipSummary">Loading delivery options‚Ä¶</div>
      </section>

      <section class="filter-block">
        <h3>Price</h3>
        <div class="price-row">
          <input id="minPrice" type="number" inputmode="decimal" placeholder="Min" />
          <span>‚Äì</span>
          <input id="maxPrice" type="number" inputmode="decimal" placeholder="Max" />
        </div>
        <button id="applyPrice" class="btn sm" type="button">Apply</button>
      </section>

      <section class="filter-block">
        <h3>Attributes</h3>
        <label class="chk"><input type="checkbox" data-attr="popular" /> Popular</label>
        <label class="chk"><input type="checkbox" data-attr="sale" /> On sale</label>
        <label class="chk"><input type="checkbox" data-attr="isNew" /> New</label>
      </section>

      <section class="filter-block">
        <h3>Type</h3>
        <input id="typeFilter" type="text" placeholder="e.g. wireless" />
      </section>
    </aside>

    <!-- ====== Results Column ====== -->
    <section class="amz-results" id="results">
      <% if (products && products.length) { %>
        <!-- Default GRID mode -->
        <ul id="list" class="amz-list grid-mode">
          <% products.forEach(p => {
            const price     = Number(p.price || 0);
            const inStock   = Number(p.stock || 0) > 0;
            const name      = String(p.name || '');
            const cat       = (p.category || '').toLowerCase();
            const type      = (p.type || '').toLowerCase();
            const role      = (p.role || '').toLowerCase();
            const isClothes = role === 'clothes' || type === 'clothes';
            const isShoes   = role === 'shoes'   || type === 'shoes';

            const flags     = { isNew: !!p.isNew, sale: !!p.sale, popular: !!p.popular };

            // Size options
            let sizeOptions = [];
            if (isClothes || isShoes) {
              if (Array.isArray(p.sizes) && p.sizes.length) {
                // Use sizes from DB if present
                sizeOptions = p.sizes;
              } else if (isClothes) {
                // Default clothes sizes
                sizeOptions = ['XS', 'S', 'M', 'L', 'XL'];
              } else if (isShoes) {
                // Default shoe sizes (you can tweak for SA sizes)
                sizeOptions = ['3', '4', '5', '6', '7', '8', '9', '10'];
              }
            }

            // ‚úÖ Color options ‚Äì for BOTH clothes and shoes
            let colorOptions = [];
            if (isClothes || isShoes) {
              if (Array.isArray(p.colors) && p.colors.length) {
                // Use colors from DB if present
                colorOptions = p.colors;
              } else if (isClothes) {
                // Default clothes colors
                colorOptions = ['Black', 'White', 'Blue', 'Red'];
              } else if (isShoes) {
                // Default shoe colors
                colorOptions = ['Black', 'White', 'Brown', 'Navy'];
              }
            }
          %>
          <li class="amz-item"
              data-name="<%- name %>"
              data-price="<%= price %>"
              data-stock="<%= inStock ? '1':'0' %>"
              data-category="<%- cat %>"
              data-type="<%- type %>"
              data-role="<%- role %>"
              data-flags='<%- JSON.stringify(flags) %>'>
            <a class="imgbox" href="/products/view/<%= p.customId %>" aria-label="Open <%= name %>">
              <img src="<%= p.imageUrl %>" alt="<%= name %>" loading="lazy" decoding="async" />
              <% if (p.isNew)   { %><span class="tag new">New</span><% } %>
              <% if (p.sale)    { %><span class="tag sale">Deal</span><% } %>
              <% if (p.popular) { %><span class="tag hot">Top</span><% } %>
            </a>

            <div class="info">
              <a class="title" href="/products/view/<%= p.customId %>"><%= name %></a>

              <div class="rating">
                <span class="stars" aria-hidden="true">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                <span class="count">(<%= Math.floor(Math.random()*90)+10 %>)</span>
              </div>

              <div class="price-row">
                <span class="price">R <%= price.toFixed(2) %></span>
                <span class="<%= inStock ? 'stock in' : 'stock out' %>">
                  <%= inStock ? 'In Stock' : 'Out of Stock' %>
                </span>
              </div>

              <% if (isClothes || isShoes) { %>
                <div class="variants">
                  <!-- Size (clothes + shoes) -->
                  <label>
                    <span class="v-label"><%= isShoes ? 'Shoe size' : 'Size' %></span>
                    <select class="variant-size" data-pid="<%= p.customId %>">
                      <option value="">Choose size</option>
                      <% sizeOptions.forEach(sz => { %>
                        <option value="<%= sz %>"><%= sz %></option>
                      <% }) %>
                    </select>
                  </label>

                  <!-- ‚úÖ Color (clothes + shoes) -->
                  <% if (colorOptions.length) { %>
                  <label>
                    <span class="v-label">Color</span>
                    <select class="variant-color" data-pid="<%= p.customId %>">
                      <option value="">Choose color</option>
                      <% colorOptions.forEach(c => { %>
                        <option value="<%= c %>"><%= c %></option>
                      <% }) %>
                    </select>
                  </label>
                  <% } %>
                </div>
              <% } %>

              <!-- Add to cart -->
              <div class="act">
                <a class="btn add"
                  href="/api/cart/add?pid=<%= p.customId %>"
                  data-pid="<%= p.customId %>"
                  <%= inStock ? '' : 'aria-disabled="true"' %>>
                  Add to Cart
                </a>
                <a class="btn ghost" href="/products/view/<%= p.customId %>">Details</a>
              </div>
            </div>
          </li>
          <% }) %>
        </ul>

        <!-- Pager (client-side simple) -->
        <div class="pager" id="pager" hidden>
          <button class="pg-btn" data-dir="-1" type="button">‚Äπ Prev</button>
          <span class="pg-meta"><span id="pgNow">1</span> / <span id="pgTotal">1</span></span>
          <button class="pg-btn" data-dir="1" type="button">Next ‚Ä∫</button>
        </div>
      <% } else { %>
        <div class="empty">
          <div>ü™Ñ</div>
          <h3>No products yet</h3>
          <p class="muted">Please check back later.</p>
        </div>
      <% } %>
    </section>
  </div>

  <!-- ===== Mini Checkout Bar ===== -->
  <div class="mini-co" id="miniCheckout" hidden>
    <div class="co-left">
      <strong id="miniSubtotal">R 0.00</strong>
      <span class="muted"> ¬∑ <span id="miniCount">0</span> item(s)</span>
    </div>
    <a href="/payment/checkout" class="co-btn">Checkout</a>
  </div>

   <!-- ===== Variant warning toast ===== -->
  <div id="variantToast" class="variant-toast" aria-live="polite" hidden>
    <div class="variant-toast-inner">
      <span class="variant-toast-icon">‚ö†Ô∏è</span>
      <span class="variant-toast-text" id="variantToastText">
        Please choose size and color before adding to cart.
      </span>
      <button type="button" class="variant-toast-close" id="variantToastClose" aria-label="Dismiss">
        ‚úï
      </button>
    </div>
  </div>
</main>

<!-- ===== Cart Drawer ===== -->
<div class="drawer-overlay" id="drawerOverlay"></div>
<aside class="drawer" id="cartDrawer" aria-label="Cart">
  <div class="drawer-head">
    <strong>Your Cart</strong>
    <button class="close-x" id="drawerClose" aria-label="Close cart">‚úñ</button>
  </div>
  <div class="drawer-body" id="cartList">
    <p class="muted">Loading cart‚Ä¶</p>
  </div>
  <div class="drawer-foot">
    <div class="total-row">
      <span>Subtotal</span>
      <span id="cartSubtotal">R 0.00</span>
    </div>
    <a href="/payment/checkout" class="btn-checkout">Proceed Making Payments</a>
  </div>
</aside>

<!-- ===== Styles (CSP-safe) ===== -->
<style nonce="<%= nonce %>">
  :root{
    --brand:#232f3e; --brand2:#37475a; --accent:#ff9900; --card:#fff; --ink:#111827; --muted:#6b7280; --line:#e5e7eb;
    --shadow:0 6px 24px rgba(0,0,0,.08);
  }
  .dark-theme{ --card:#0f172a; --ink:#e5e7eb; --muted:#9ca3af; --line:#334155; --brand:#111827; --brand2:#1f2937; }

  /* === Cinematic Navy Backdrop (keeps your Amazon layout) === */
  .amz-wrap{
    --brand:  #0f1f35;   /* top bar */
    --brand2: #1b2a41;   /* secondary */
    --accent: #ffb703;   /* warm amber */
    background:
      radial-gradient(1000px 480px at 50% -10%, #1c2c4d 0%, rgba(12,22,38,.9) 48%, #0b1220 100%),
      linear-gradient(180deg, #0b1220, #0b1220);
    min-height: 100dvh;
    color: var(--ink);
  }

  .amz-top{
    display:grid;
    grid-template-columns: 140px 1fr auto;
    gap:.6rem;
    align-items:center;
    padding:.5rem .6rem;
    background:var(--brand);
    color:#fff;
    position:sticky;
    top:0;
    z-index:60;
  }

  .brand{
    display:inline-flex;
    align-items:center;
    gap:4px;
    font-weight:900;
    color:#fff;
    text-decoration:none;
    white-space:nowrap;
    font-size:0.85rem;   /* smaller text */
    max-width:120px;     /* limit how wide it can be */
    overflow:hidden;
    text-overflow:ellipsis; /* show ‚ÄúUnicoporate‚Ä¶‚Äù if too long */
  }

  .amz-search{
    display:grid;
    grid-template-columns: 96px 1fr 40px;
    background:#fff;
    border-radius:999px;
    overflow:hidden;
  }
  .amz-search select, .amz-search input{
    border:0;
    padding:.5rem .55rem;
    font:inherit;
    outline:none;
  }
  .amz-search input{ min-width:0; font-size:.95rem }
  .amz-search-btn{ border:0; background:var(--accent); color:#111; font-weight:900; cursor:pointer }
  .amz-quick{ display:flex; gap:.6rem; align-items:center }
  .amz-link{ color:#fff; text-decoration:none; font-size:.92rem }
  .amz-cart-btn{ background:#f3f4f6; border:0; border-radius:999px; padding:.3rem .6rem; cursor:pointer; font-weight:800 }

  .amz-subnav{
    display:flex; justify-content:space-between; align-items:center; gap:.5rem;
    background: rgba(255,255,255,0.05);
    border-bottom:1px solid rgba(255,255,255,0.12);
    backdrop-filter: saturate(120%) blur(6px);
    padding:.45rem .6rem;
  }
  .left{ display:flex; gap:.45rem; align-items:center }
  .subnav-btn{
    border:1px solid var(--line);
    background:#fff;
    border-radius:8px;
    padding:.35rem .5rem;
    cursor:pointer;
    font-weight:700;
    font-size:.9rem;
  }
  .subnav-meta{ display:flex; gap:.6rem; align-items:center; flex-wrap:wrap; font-size:.92rem }
  .sort-wrap{ display:flex; gap:.3rem; align-items:center }
  .sort-wrap select{
    padding:.3rem .5rem;
    border:1px solid var(--line);
    border-radius:8px;
    background:var(--card);
    color:var(--ink);
  }

  .amz-body{
    display:grid;
    grid-template-columns: 220px 1fr;
    gap:.7rem;
    padding:.6rem;
    align-items:start;
  }
  .amz-side{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:10px;
    box-shadow:var(--shadow);
    padding:.6rem;
  }
  .filter-block + .filter-block{ margin-top:.7rem }
  .filter-block h3{ margin:.05rem 0 .35rem; font-size:.95rem }
  .chk{ display:block; margin:.2rem 0; color:var(--ink); font-size:.95rem }
  .region-row{ display:grid; gap:.35rem; margin-top:.35rem }
  .region-row select{
    border:1px solid var(--line);
    background:var(--card);
    color:var(--ink);
    border-radius:8px;
    padding:.4rem .5rem;
  }
  .tiny{ color:var(--muted); font-size:.82rem; margin-top:.25rem }

  .price-row{
    display:grid;
    grid-template-columns: 1fr auto 1fr;
    gap:.35rem;
    align-items:center;
  }

  .btn{
    border:1px solid var(--line);
    background:var(--card);
    color:var(--ink);
    border-radius:8px;
    padding:.4rem .6rem;
    cursor:pointer;
    font-weight:700;
  }
  .btn.sm{ font-size:.9rem }

  .amz-results{ min-height:40vh }

  /* --- GRID is the default on all screens --- */
  .amz-list{ list-style:none; padding:0; margin:0; display:grid; gap:.6rem; }
  .amz-list.grid-mode{
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
  }
  @media (min-width: 768px){
    .amz-list.grid-mode{ grid-template-columns: repeat(3, minmax(0,1fr)); }
  }
  @media (min-width: 1024px){
    .amz-list.grid-mode{ grid-template-columns: repeat(4, minmax(0,1fr)); }
  }

  /* Grid cards stack image on top */
  .amz-list.grid-mode .amz-item{ grid-template-columns: 1fr; }

  .amz-item{
    display:grid;
    grid-template-columns: 150px 1fr;
    gap:.55rem;
    padding:.55rem;
    border:1px solid var(--line);
    border-radius:10px;
    background:var(--card);
    box-shadow:0 10px 28px rgba(0,0,0,.12);
  }

  /* Image box: square, keeps full image on small screens */
  .imgbox{
    position:relative;
    background:#f3f4f6;
    border-radius:10px;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
    aspect-ratio: 1 / 1;
  }
  .imgbox img{
    width:100%;
    height:100%;
    object-fit: cover;
    transition: transform .3s ease;
  }
  .imgbox:hover img{ transform: scale(1.04) }
  .tag{
    position:absolute;
    top:6px;
    left:6px;
    padding:.16rem .44rem;
    border-radius:999px;
    font-size:.72rem;
    font-weight:800;
    color:#111;
    background:#fde68a;
  }
  .tag.new{ background:#a7f3d0; }
  .tag.sale{ background:#fda4af; }
  .tag.hot{ background:#93c5fd; }

  .info{ display:grid; gap:.28rem }
  .title{
    font-weight:800;
    color:inherit;
    text-decoration:none;
    font-size:.98rem;
    line-height:1.2;
    max-height: 2.6em;
    overflow:hidden;
    display:-webkit-box;
    -webkit-line-clamp:2;
    -webkit-box-orient:vertical;
  }
  .rating{ display:flex; align-items:center; gap:.28rem; color:#6b7280; font-size:.86rem }
  .stars{ letter-spacing:.12ch }

  /* Override price-row inside card to flex layout */
  .info .price-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:.5rem;
  }

  .price{ color:#B12704; font-weight:900; font-size:1.02rem }
  .stock.in{ color:#16a34a; font-weight:700 }
  .stock.out{ color:#ef4444; font-weight:700 }
  .act{ display:flex; gap:.45rem; flex-wrap:wrap; margin-top:.15rem }
  .btn.add{ background:#ffd814; border-color:#facc15 }
  .btn.ghost{ background:transparent }

  .pager{
    display:flex;
    gap:.6rem;
    align-items:center;
    justify-content:center;
    padding:.6rem 0;
  }

  /* Default state: white button, dark text (always visible) */
  .pg-btn{
    border:1px solid var(--line);
    background:#ffffff;
    border-radius:8px;
    padding:.35rem .7rem;
    cursor:pointer;
    font-weight:700;
    color:#0f172a;          /* text always visible on white */
  }

  /* Hover / focus: blue button with white text (still visible) */
  .pg-btn:hover,
  .pg-btn:focus-visible{
    background:#1d4ed8;     /* blue */
    border-color:#1d4ed8;
    color:#ffffff;          /* white text on blue */
  }

  .pg-meta{
    color:var(--muted);
  }

  .empty{ text-align:center; padding:1.6rem 1rem; }
  .muted{ color:var(--muted) }

  /* Mini checkout bar ‚Äì almost invisible */
  .mini-co{
    position: fixed;
    left:50%;
    transform:translateX(-50%);
    bottom: 72px;
    z-index:55;

    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:.6rem;

    /* üîπ Barely there */
    background: rgba(15, 23, 42, 0.03);          /* almost fully transparent */
    border: 1px solid rgba(148, 163, 184, 0.10); /* very faint border */
    backdrop-filter: blur(2px);                  /* tiny blur, almost none */
    box-shadow: none;                            /* no heavy shadow */

    color:#16a34a;
    border-radius:999px;
    padding:.5rem .7rem;
    width:min(725px, 94vw);
  }

  .co-btn{
    text-decoration:none;
    background:#16a34a;
    color:#fff;
    font-weight:900;
    padding:.45rem .8rem;
    border-radius:999px;
  }

  

  /* Mini checkout bar */
  /*.mini-co{
    position: fixed; left:50%; transform:translateX(-50%);
    bottom: 72px; z-index:55;
    display:flex; justify-content:space-between; align-items:center; gap:.6rem;
    background: rgba(255,255,255,0.92); color:inherit; border:1px solid rgba(17,24,39,.12);
    border-radius:999px; padding:.5rem .7rem; box-shadow:var(--shadow);
    width:min(740px,94vw);
  }
  .co-btn{
    text-decoration:none;
    background:#16a34a;
    color:#fff;
    font-weight:900;
    padding:.45rem .8rem;
    border-radius:999px;
  }*/

  /* Drawer */
  .drawer-overlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.5);
    display:none;
    z-index:70;
  }
  .drawer{
    position:fixed;
    right:0;
    top:0;
    bottom:0;
    width:min(420px,92vw);
    background:var(--card);
    box-shadow:-10px 0 24px rgba(0,0,0,.25);
    transform:translateX(100%);
    transition:transform .28s ease;
    z-index:80;
    display:flex;
    flex-direction:column;
    border-left:1px solid var(--line);
  }
  .drawer.open{ transform: translateX(0) }
  .drawer-head{
    padding:.8rem;
    display:flex;
    justify-content:space-between;
    align-items:center;
    border-bottom:1px solid var(--line);
  }
  .drawer-body{
    padding:.6rem .8rem;
    overflow:auto;
    flex:1;
    display:flex;
    flex-direction:column;
    gap:.6rem;
  }
  .drawer-item{
    display:grid;
    grid-template-columns:64px 1fr auto;
    gap:.55rem;
    align-items:center;
    background:rgba(0,0,0,.02);
    border-radius:.7rem;
    padding:.45rem;
  }
  .drawer-item img{
    width:64px;
    height:64px;
    object-fit:cover;
    border-radius:.6rem;
  }
  .drawer-foot{
    padding:.8rem;
    border-top:1px solid var(--line);
    display:grid;
    gap:.5rem;
  }
  .total-row{ display:flex; justify-content:space-between; font-weight:900 }
  .btn-checkout{
    border:0;
    border-radius:.7rem;
    padding:.6rem .9rem;
    font-weight:900;
    background:#16a34a;
    color:#fff;
    cursor:pointer;
  }

  .close-x{ background:transparent; border:0; font-size:1.05rem; cursor:pointer }

  /* ===== Mobile (Hisense U50 Lite ~360x720) ===== */
  @media (max-width: 480px){
    .amz-top{ grid-template-columns: 1fr; gap:.45rem }
    .amz-search{ grid-template-columns: 80px 1fr 38px }
    .amz-subnav{ padding:.4rem .5rem }
    .subnav-btn{ padding:.3rem .45rem; font-size:.88rem }
    .amz-body{ grid-template-columns: 1fr; gap:.5rem; padding:.5rem }
    .amz-side{ display:none } /* toggled via JS */

    /* Grid stays grid, but tighter */
    .amz-list.grid-mode{ grid-template-columns: repeat(2, minmax(0,1fr)); gap:.5rem }

    /* Mobile image: show full image without cropping */
    .imgbox{ aspect-ratio: 1 / 1; }
    .imgbox img{
      object-fit: contain;
      padding: 6px;
      background: #fff;
      transform: none;
    }

    .amz-item{ grid-template-columns: 1fr; padding:.5rem; gap:.45rem }
    .title{ font-size:.92rem }
    .price{ font-size:.98rem }
    .mini-co{ bottom:64px; width:94vw }

   .mini-co{
      bottom:64px;
      width: calc(94vw - 15px);

      background: rgba(15, 23, 42, 0.03);
      border: 1px solid rgba(148, 163, 184, 0.10);
      backdrop-filter: blur(2px);
      box-shadow: none;
    } 
  }

  /* Cart count: navy by default, white on hover */
  .cart-count-top{
    color: #0f1f35 !important;   /* deep navy */
    font-weight: 900;
    transition: color .15s ease;
  }

  .amz-cart-btn:hover .cart-count-top,
  .amz-cart-btn:focus-visible .cart-count-top{
    color: #ffffff !important;   /* turn white on hover/focus */
  }

  .dark-theme .cart-count-top{
    color: #c7d2fe;
  }

  /* Make subnav buttons readable */
  .subnav-btn {
    background: #ffffff;
    color: #0f172a;
  }

  .subnav-btn:hover,
  .subnav-btn:focus-visible,
  .subnav-btn[aria-pressed="true"] {
    background: #ffffff;
    border-color: #1d4ed8;
    color: #0f172a;
  }

  .drawer-head {
    visibility: hidden; /* keeps height, hides content */
  }

  .amz-top .brand {
    font-size: 0.8rem !important;
    max-width: 80px !important;
    white-space: nowrap !important;
    overflow: hidden !important;
    text-overflow: ellipsis !important;
    display: inline-block !important;
  }

  /* Variants (size + color) ‚Äì hidden by default */
  .variants{
    display:none;
    flex-wrap:wrap;
    gap:.35rem;
    margin-top:.1rem;
    font-size:.85rem;
  }

  /* Show variants when card is in "choose mode" */
  .amz-item.show-variants .variants{
    display:flex;
  }

  /* Variants (size + color) */
  /*.variants{
    display:flex;
    flex-wrap:wrap;
    gap:.35rem;
    margin-top:.1rem;
    font-size:.85rem;
  }*/
  .variants label{
    display:flex;
    flex-direction:column;
    gap:.12rem;
  }
  .v-label{
    font-weight:600;
    color:var(--muted);
    font-size:.78rem;
    text-transform:uppercase;
    letter-spacing:.04em;
  }
  .variants select{
    border:1px solid var(--line);
    border-radius:999px;
    padding:.25rem .6rem;
    font-size:.85rem;
    background:var(--card);
    color:var(--ink);
  }

  @media (max-width:480px){
    .variants{
      gap:.25rem;
    }
  }

    /* ===== Variant warning toast ===== */
  .variant-toast{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%) translateY(16px);
    z-index: 95;
    opacity: 0;
    visibility: hidden;
    transition: opacity .2s ease, transform .2s ease, visibility .2s ease;
    pointer-events: none;
  }
  .variant-toast.show{
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
    pointer-events: auto;
  }
  .variant-toast-inner{
    display: inline-flex;
    align-items: center;
    gap: .4rem;
    padding: .5rem .8rem;
    border-radius: 999px;
    background: #111827;
    color: #f9fafb;
    box-shadow: var(--shadow);
    font-size: .86rem;
  }
  .variant-toast-icon{
    font-size: 1rem;
  }
  .variant-toast-close{
    border: 0;
    background: transparent;
    color: inherit;
    cursor: pointer;
    font-size: .9rem;
    padding: 0 .1rem;
  }
  .dark-theme .variant-toast-inner{
    background: #0b1120;
  }
</style>

<!-- ===== Page Script (CSP-safe) ===== -->
<script nonce="<%= nonce %>">
(function(){
  const $  = (s,c=document)=>c.querySelector(s);
  const $$ = (s,c=document)=>Array.from(c.querySelectorAll(s));

  /* Elements */
  const list          = $('#list');
  const resultMeta    = $('#resultMeta');
  const sortSelect    = $('#sortSelect');
  const filterToggle  = $('#filterToggle');
  const viewToggle    = $('#viewToggle');
  const sidebar       = $('#sidebar');

  const searchForm    = $('#searchForm');
  const searchInput   = $('#searchInput');
  const catSelect     = $('#catSelect');
  const regionSelect  = $('#regionSelect');
  const shipSummary   = $('#shipSummary');

  const inStockOnly   = $('#inStockOnly');
  const minPrice      = $('#minPrice');
  const maxPrice      = $('#maxPrice');
  const applyPriceBtn = $('#applyPrice');
  const typeFilter    = $('#typeFilter');

  const pager         = $('#pager');
  const pgNow         = $('#pgNow');
  const pgTotal       = $('#pgTotal');

  const drawer        = $('#cartDrawer');
  const overlay       = $('#drawerOverlay');
  const drawerClose   = $('#drawerClose');
  const cartBtn       = $('#cartBtn');
  const cartList      = $('#cartList');
  const cartSubtotal  = $('#cartSubtotal');
  const cartCountTop  = $('#cartCountTop');

  const miniBar       = $('#miniCheckout');
  const miniSubtotal  = $('#miniSubtotal');
  const miniCount     = $('#miniCount');

    const variantToast      = $('#variantToast');
  const variantToastText  = $('#variantToastText');
  const variantToastClose = $('#variantToastClose');
  let   variantToastTimer = null;

  function hideVariantToast(){
    if (!variantToast) return;
    variantToast.classList.remove('show');
    // after transition, hide completely
    setTimeout(()=>{
      variantToast.setAttribute('hidden', 'true');
    }, 220);
  }

  function showVariantToast(message){
    if (!variantToast || !variantToastText){
      // fallback (should rarely happen)
      alert(message);
      return;
    }
    variantToastText.textContent = message || 'Please choose size and color before adding to cart.';
    variantToast.removeAttribute('hidden');
    variantToast.classList.add('show');

    if (variantToastTimer) clearTimeout(variantToastTimer);
    variantToastTimer = setTimeout(hideVariantToast, 2500);
  }

  if (variantToastClose){
    variantToastClose.addEventListener('click',()=>{
      if (variantToastTimer) clearTimeout(variantToastTimer);
      hideVariantToast();
    });
  }

  const PAGE = { size: 12, page: 1, pages: 1 };
  const CARD = () => list ? Array.from(list.children) : [];

  /* Sidebar toggle (mobile) */
  if (filterToggle) {
    filterToggle.addEventListener('click', () => {
      const showing = getComputedStyle(sidebar).display !== 'none';
      sidebar.style.display = showing ? 'none' : 'block';
      sidebar.style.position = showing ? '' : 'fixed';
      if (!showing){
        sidebar.style.top = '64px';
        sidebar.style.left = '10px';
        sidebar.style.right = '10px';
        sidebar.style.zIndex = '65';
        sidebar.style.maxHeight = '70vh';
        sidebar.style.overflow = 'auto';
        overlay.style.display = 'block';
        overlay.addEventListener('click', hideFiltersOnce, { once:true });
      }
    });
  }
  function hideFiltersOnce(){ sidebar.style.display='none'; overlay.style.display='none'; }

  /* List/Grid toggle (default is GRID, button offers List) */
  if (viewToggle){
    viewToggle.textContent = '‚ò∞ List';
    viewToggle.setAttribute('aria-pressed', 'true'); // we are in grid by default
    viewToggle.addEventListener('click', ()=>{
      const grid = !list.classList.contains('grid-mode'); // toggle desired
      list.classList.toggle('grid-mode', grid);
      list.classList.toggle('list-mode', !grid);
      viewToggle.textContent = grid ? '‚ò∞ List' : '‚ñ¶ Grid';
      viewToggle.setAttribute('aria-pressed', grid ? 'true' : 'false');
    });
  }

  /* Drawer controls */
  function openDrawer(){ overlay.style.display='block'; requestAnimationFrame(()=>drawer.classList.add('open')); refreshCart(); }
  function closeDrawer(){ drawer.classList.remove('open'); setTimeout(()=>overlay.style.display='none', 280); }
  if (cartBtn) cartBtn.addEventListener('click', openDrawer);
  overlay.addEventListener('click', closeDrawer);
  drawerClose.addEventListener('click', closeDrawer);

  /* Fetch helpers */
  async function getJSON(url){
    try{
      const r = await fetch(url, { credentials:'same-origin' });
      if(!r.ok) return {};
      const ct=r.headers.get('content-type')||'';
      if(!ct.includes('application/json')) return {};
      return await r.json();
    }catch{
      return {};
    }
  }
  async function fetchCart(){
    let data = await getJSON('/api/cart');
    if (!data || (!data.items && !Array.isArray(data))) data = await getJSON('/cart/items');
    if (Array.isArray(data)) return { items: data };
    return data || { items: [] };
  }

  function renderCart(items){
    if (!items || !items.length){
      cartList.innerHTML = '<p class="muted">Your cart is empty.</p>';
      cartSubtotal.textContent = 'R 0.00';
      cartCountTop.textContent = '0';
      miniBar.hidden = true;
      return;
    }

    let subtotal = 0;
    let count    = 0;

    cartList.innerHTML = items.map(it=>{
      const qty   = Number(it.quantity || it.qty || 1);
      const price = Number(it.price || it.product?.price || 0);
      const name  = it.name || it.product?.name || 'Item';
      const image = it.imageUrl || it.product?.imageUrl || '';

      const variants = it.variants || {};
      const size  = variants.size  || it.size  || it.variantSize  || '';
      const color = variants.color || it.color || it.variantColor || '';

      subtotal += price * qty;
      count    += qty;

      const metaParts = [];
      metaParts.push(`R ${price.toFixed(2)} √ó ${qty}`);
      if (size)  metaParts.push(`Size: ${size}`);
      if (color) metaParts.push(`Color: ${color}`);
      const meta = metaParts.join(' ‚Ä¢ ');

      return `
        <div class="drawer-item">
          <img src="${image}" alt="${name}">
          <div>
            <div style="font-weight:800">${name}</div>
            <div class="muted">${meta}</div>
          </div>
          <span></span>
        </div>
      `;
    }).join('');

    cartSubtotal.textContent = 'R ' + subtotal.toFixed(2);
    cartCountTop.textContent = String(count);
    miniSubtotal.textContent = 'R ' + subtotal.toFixed(2);
    miniCount.textContent = String(count);
    miniBar.hidden = false;
  }

  async function refreshCart(){
    const data = await fetchCart();
    renderCart(data.items||[]);
  }

  /* Add to cart inline (handles clothes + shoes variants) */
  function wireAddButtons(){
    $$('.btn.add').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        e.preventDefault();
        if (btn.hasAttribute('aria-disabled')) return;

        const pid      = btn.getAttribute('data-pid');
        const original = btn.textContent;

        // Find the card
        const card = btn.closest('.amz-item');
        let size = '';
        let color = '';

        if (card) {
          const type = (card.getAttribute('data-type') || '').toLowerCase();
          const role = (card.getAttribute('data-role') || '').toLowerCase();
          const isClothes = type === 'clothes' || role === 'clothes';
          const isShoes   = type === 'shoes'   || role === 'shoes';

          if (isClothes || isShoes) {
            // üëâ FIRST click: just reveal the selectors and focus, do NOT add yet
            if (!card.classList.contains('show-variants')) {
              card.classList.add('show-variants');

              const sizeSelFirst = card.querySelector('.variant-size');
              if (sizeSelFirst) sizeSelFirst.focus();

              // stop here ‚Äì user must choose options, then click Add again
              return;
            }

            // üëâ After variants are visible, now we validate
            const sizeSel  = card.querySelector('.variant-size');
            const colorSel = card.querySelector('.variant-color');

            size  = sizeSel  ? sizeSel.value.trim()  : '';
            color = colorSel ? colorSel.value.trim() : '';

            // Require BOTH size and color for clothes + shoes
            if (!size || !color) {
              showVariantToast('Please choose size and color before adding to cart.');
              return;
            }
          }
        }

        try{
          btn.textContent = '‚è≥ Adding‚Ä¶';
          btn.setAttribute('aria-disabled','true');

          const params = new URLSearchParams();
          params.set('pid', pid);
          params.set('json', '1');
          if (size)  params.set('size', size);
          if (color) params.set('color', color);

          const r = await fetch(`/api/cart/add?${params.toString()}`, { credentials:'same-origin' });
          if(!r.ok){
            let m='Add failed';
            try{
              const j=await r.json();
              if(j?.message) m=j.message;
            }catch{}
            throw new Error(m);
          }

          // ‚úÖ Added successfully
          btn.textContent = '‚úÖ Added';

          // üîÅ Reset and hide variants back to default
          const cardAfter = btn.closest('.amz-item');
          if (cardAfter) {
            const typeA = (cardAfter.getAttribute('data-type') || '').toLowerCase();
            const roleA = (cardAfter.getAttribute('data-role') || '').toLowerCase();
            const isClothesA = typeA === 'clothes' || roleA === 'clothes';
            const isShoesA   = typeA === 'shoes'   || roleA === 'shoes';

            if (isClothesA || isShoesA) {
              const sizeSelA  = cardAfter.querySelector('.variant-size');
              const colorSelA = cardAfter.querySelector('.variant-color');

              if (sizeSelA)  sizeSelA.value  = '';
              if (colorSelA) colorSelA.value = '';

              // hide the block again
              cardAfter.classList.remove('show-variants');
            }
          }

          setTimeout(()=>{
            btn.textContent = original;
            btn.removeAttribute('aria-disabled');
          }, 900);

          refreshCart();
        }catch(err){
          btn.textContent = original;
          btn.removeAttribute('aria-disabled');
          alert(err.message||'Could not add to cart.');
        }
      });
    });
  }

  /* ===== Delivery Options (live) ===== */
  async function loadDeliveryOptions(region=''){
    const qs = new URLSearchParams();
    if (region) qs.set('region', region);
    qs.set('sort','price'); qs.set('order','asc'); qs.set('limit','100');
    const data = await getJSON(`/api/delivery-options?${qs.toString()}`);
    const items = Array.isArray(data.options) ? data.options : [];

    // Build regions list
    const regions = Array.from(new Set(items.map(it=>it.region).filter(Boolean))).sort();
    const current = regionSelect.value;
    regionSelect.innerHTML = `<option value="">All regions</option>` +
      regions.map(r=>`<option ${r===current?'selected':''} value="${r}">${r}</option>`).join('');

    // Sidebar summary only (no per-card text)
    if (items.length){
      const cheapest = items.reduce((a,b)=> a.price < b.price ? a : b);
      const fastest  = items.reduce((a,b)=> a.deliveryDays < b.deliveryDays ? a : b);
      shipSummary.textContent = `From R ${cheapest.price.toFixed(2)} ‚Ä¢ as fast as ${fastest.deliveryDays} day(s)`;
    } else {
      shipSummary.textContent = 'No delivery options available';
    }
  }

  /* Search + Filters + Sort */
  function normalize(s){ return String(s||'').toLowerCase().trim(); }
  function flagsMatch(card, req){
    try{
      const f = JSON.parse(card.getAttribute('data-flags')||'{}');
      if (req.isNew && !f.isNew) return false;
      if (req.sale && !f.sale) return false;
      if (req.popular && !f.popular) return false;
      return true;
    }catch{
      return true;
    }
  }

  function applyFilters(){
    const q     = normalize(searchInput.value);
    const cat   = normalize(catSelect.value);
    const tAttr = normalize(typeFilter.value);
    const only  = !!inStockOnly?.checked;
    const minP  = minPrice.value ? Number(minPrice.value) : -Infinity;
    const maxP  = maxPrice.value ? Number(maxPrice.value) : Infinity;

    const reqFlags = {
      isNew:  !!$$('input[data-attr="isNew"]', sidebar).find(i=>i.checked),
      sale:   !!$$('input[data-attr="sale"]', sidebar).find(i=>i.checked),
      popular:!!$$('input[data-attr="popular"]', sidebar).find(i=>i.checked),
    };

    let visible = 0;
    CARD().forEach(li=>{
      const name  = normalize(li.getAttribute('data-name'));
      const price = Number(li.getAttribute('data-price')||0);
      const stock = li.getAttribute('data-stock') === '1';
      const ccat  = normalize(li.getAttribute('data-category'));
      const type  = normalize(li.getAttribute('data-type'));

      let show = true;
      if (q && !name.includes(q)) show = false;
      if (cat && ccat !== cat) show = false;
      if (tAttr && !type.includes(tAttr)) show = false;
      if (only && !stock) show = false;
      if (!(price >= minP && price <= maxP)) show = false;
      if (!flagsMatch(li, reqFlags)) show = false;

      li.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    // sort visible
    const sort = sortSelect.value;
    const items = CARD().filter(li=>li.style.display!=='none');
    if (sort !== 'relevance'){
      items.sort((a,b)=>{
        const pa = Number(a.getAttribute('data-price')||0);
        const pb = Number(b.getAttribute('data-price')||0);
        const na = a.getAttribute('data-name')||'';
        const nb = b.getAttribute('data-name')||'';
        if (sort==='price-asc')  return pa - pb;
        if (sort==='price-desc') return pb - pa;
        if (sort==='name')       return na.localeCompare(nb);
        if (sort==='new')        return 0; // server would handle createdAt
        return 0;
      });
      const frag = document.createDocumentFragment();
      items.forEach(el=>frag.appendChild(el));
      list.appendChild(frag);
    }

    // pagination (client)
    PAGE.pages = Math.max(1, Math.ceil(visible / PAGE.size));
    PAGE.page = Math.min(PAGE.page, PAGE.pages);
    pager.hidden = PAGE.pages <= 1;

    renderPage();
    resultMeta.textContent = `${visible} results`;
  }

  function renderPage(){
    const visible = CARD().filter(li=>li.style.display!=='none');
    visible.forEach((li,i)=>{
      const start = (PAGE.page-1)*PAGE.size;
      const end   = start + PAGE.size - 1;
      const ok = (i>=start && i<=end);
      li.style.visibility = ok ? 'visible' : 'hidden';
      li.style.position   = ok ? '' : 'absolute';
      li.style.pointerEvents = ok ? '' : 'none';
    });
    pgNow && (pgNow.textContent = String(PAGE.page));
    pgTotal && (pgTotal.textContent = String(PAGE.pages));
  }

  pager && pager.addEventListener('click', (e)=>{
    const btn = e.target.closest('.pg-btn'); 
    if (!btn) return;

    const dir  = Number(btn.getAttribute('data-dir') || 0);
    const next = PAGE.page + dir;

    if (next >= 1 && next <= PAGE.pages){
      PAGE.page = next;
      renderPage();
      // ‚ùå no more window.scrollTo here ‚Äì stay where the user is
    }
  });


  // events
  searchForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    PAGE.page=1;
    applyFilters();
  });

  [searchInput, catSelect, sortSelect, inStockOnly, typeFilter].forEach(el=>{
    el?.addEventListener('input', ()=>{
      PAGE.page=1;
      applyFilters();
    });
    if (el && el.tagName==='SELECT') el.addEventListener('change', ()=>{
      PAGE.page=1;
      applyFilters();
    });
  });

  applyPriceBtn.addEventListener('click', ()=>{
    PAGE.page=1;
    applyFilters();
  });

  $$('input[data-attr]', sidebar).forEach(chk=>
    chk.addEventListener('change', ()=>{
      PAGE.page=1;
      applyFilters();
    })
  );

  // Region change ‚Üí refresh summary only
  regionSelect.addEventListener('change', ()=>{
    loadDeliveryOptions(regionSelect.value);
  });

  // Prefill from URL ?q= & ?cat=
  try{
    const usp = new URLSearchParams(location.search);
    const q0=usp.get('q');
    const c0=usp.get('cat');
    if (q0) searchInput.value=q0;
    if (c0) catSelect.value=c0;
  }catch{}

  // Wire buttons & init
  wireAddButtons();
  applyFilters();
  refreshCart();
  loadDeliveryOptions('');
})();
</script>


