<section class="shop-page">
  <header class="shop-header">
    <h1>üõí Shop Products</h1>

    <div class="shop-tools">
      <input id="filterInput" type="search" placeholder="Search products‚Ä¶" />
      <select id="sortSelect">
        <option value="new">Newest</option>
        <option value="low">Price: Low ‚Üí High</option>
        <option value="high">Price: High ‚Üí Low</option>
        <option value="name">Name A ‚Üí Z</option>
      </select>
    </div>
  </header>

  <% if (success && success.length > 0) { %>
    <div class="flash flash-success">‚úÖ <%= success %></div>
  <% } %>
  <% if (error && error.length > 0) { %>
    <div class="flash flash-error">‚ùå <%= error %></div>
  <% } %>

  <div id="productGrid" class="product-grid">
    <% if (products && products.length) { %>
      <% products.forEach(p => { %>
        <article class="product-card">
          <div class="product-main">
            <div class="image-wrap">
              <img src="<%= p.imageUrl %>" alt="<%= p.name %>" loading="lazy" />
              <% if (!p.stock || p.stock <= 0) { %>
                <span class="badge soldout">Sold Out</span>
              <% } %>
            </div>

            <div class="meta">
              <h3 class="title"><%= p.name %></h3>
              <div class="price-row">
                <span class="price">$<%= Number(p.price || 0).toFixed(2) %></span>
                <span class="stock <%= p.stock > 0 ? 'in' : 'out' %>">
                  <%= p.stock > 0 ? 'In stock' : 'Out of stock' %>
                </span>
              </div>
              <button class="btn add-to-cart" data-product-id="<%= p._id %>" <%= p.stock > 0 ? '' : 'disabled' %>>
                <%= p.stock > 0 ? '‚ûï Add to Cart' : 'Out of Stock' %>
              </button>
            </div>
          </div>

          <!-- Details under the product -->
          <div class="hover-details">
            <p><%= p.description || "No description available." %></p>
            <ul>
              <% if (p.category) { %><li><b>Category:</b> <%= p.category %></li><% } %>
              <% if (p.made) { %><li><b>Made in:</b> <%= p.made %></li><% } %>
              <% if (p.manufacturer) { %><li><b>Manufacturer:</b> <%= p.manufacturer %></li><% } %>
            </ul>
          </div>
        </article>
      <% }) %>
    <% } else { %>
      <p class="empty">No products available yet.</p>
    <% } %>
  </div>
</section>

<!-- üõí Floating Cart Bubble (moved to bottom-right) -->
<div id="cartBubble" class="cart-bubble">üõí <span id="cartCount">0</span></div>

<style>
/* --- Header --- */
.shop-header { display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; margin:1rem 0; }
.shop-tools { display:flex; gap:.5rem; }
.shop-tools input, .shop-tools select { padding:.45rem .6rem; border:1px solid #ccc; border-radius:.5rem; font:inherit; }

/* --- Grid --- */
.product-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill, minmax(180px, 1fr));
  gap:1rem;
}

/* Show 8 per row on big screens */
@media(min-width:1600px){
  .product-grid{ grid-template-columns:repeat(8, 1fr); }
}

/* 5 per row on tablets / medium */
@media(min-width:900px) and (max-width:1599px){
  .product-grid{ grid-template-columns:repeat(5, 1fr); }
}

/* 3 per row on mobile */
@media(max-width:899px){
  .product-grid{ grid-template-columns:repeat(3, 1fr); }
}

/* --- Product Card --- */
.product-card {
  display:flex;
  flex-direction:column;
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:.8rem;
  overflow:hidden;
  position:relative;
  transition:transform .2s, box-shadow .2s;
}
.product-card:hover {
  transform:translateY(-3px);
  box-shadow:0 6px 14px rgba(0,0,0,.1);
}
.dark-theme .product-card { background:#0b1220; border-color:#1f2937; }

/* --- Image --- */
.image-wrap { position:relative; width:100%; aspect-ratio:1/1; overflow:hidden; }
.image-wrap img {
  width:100%; height:100%; object-fit:cover; display:block; transition:transform .3s;
}
.product-card:hover .image-wrap img { transform:scale(1.04); }

.badge.soldout {
  position:absolute; top:8px; left:8px;
  background:#ef4444; color:#fff;
  padding:.2rem .4rem;
  border-radius:.3rem;
  font-size:.75rem; font-weight:700;
}

/* --- Meta --- */
.meta { padding:.6rem .8rem; }
.title { font-weight:700; font-size:.95rem; margin:0 0 .2rem; }
.price-row { display:flex; justify-content:space-between; align-items:center; }
.price { font-weight:700; color:#111; }
.stock.in { color:#16a34a; font-weight:600; }
.stock.out { color:#ef4444; font-weight:600; }

/* --- Add to Cart --- */
.btn {
  display:block; width:100%; margin-top:.5rem;
  padding:.5rem; border:none; border-radius:.5rem;
  background:#2563eb; color:#fff; font-weight:700;
  cursor:pointer; transition:background .2s, transform .1s;
}
.btn:hover { background:#1d4ed8; transform:scale(1.03); }
.btn:disabled { background:#9ca3af; cursor:not-allowed; }

/* --- Details (below) --- */
.hover-details {
  background:rgba(255,255,255,0.95);
  color:#111;
  padding:.6rem .8rem;
  border-top:1px solid #e5e7eb;
  font-size:.8rem;
  line-height:1.3;
  display:none;
}
.product-card:hover .hover-details { display:block; animation:fadeIn .25s ease-in; }
.dark-theme .hover-details { background:rgba(2,6,23,0.95); color:#e5e7eb; border-color:#1f2937; }

@keyframes fadeIn {
  from{opacity:0; transform:translateY(-5px);}
  to{opacity:1; transform:translateY(0);}
}

/* --- Cart Bubble --- */
.cart-bubble {
  position:fixed;
  bottom:20px; right:20px;  /* ‚úÖ moved to bottom-right */
  background:#2563eb; color:#fff;
  border-radius:50px;
  padding:.6rem 1rem;
  font-weight:700; font-size:1rem;
  display:flex; align-items:center; gap:.3rem;
  box-shadow:0 4px 10px rgba(0,0,0,.15);
  cursor:pointer; z-index:2000;
  transition:transform .3s, box-shadow .3s;
}
.cart-bubble:hover { transform:scale(1.05); box-shadow:0 0 12px rgba(37,99,235,.4); }
.cart-bubble.pulse { animation:cartPulse .6s ease-out; background:#16a34a; }
@keyframes cartPulse {
  0%{transform:scale(1);} 20%{transform:scale(1.15);} 40%{transform:scale(1.1);} 100%{transform:scale(1);}
}
.dark-theme .cart-bubble { background:#facc15; color:#111; }

/* --- Misc --- */
.empty { text-align:center; opacity:.7; margin:2rem 0; }
</style>

<script nonce="<%= nonce %>">
document.addEventListener("DOMContentLoaded", () => {
  const cartBubble = document.getElementById('cartBubble');
  const cartCountEl = document.getElementById('cartCount');
  let cartCount = 0;

  function pulse() {
    cartBubble.classList.add('pulse');
    setTimeout(() => cartBubble.classList.remove('pulse'), 650);
  }

  async function addToCart(productId, qty=1){
    await fetch('/api/cart/add', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({ productId, quantity:qty })
    });
    cartCount++;
    cartCountEl.textContent = cartCount;
    pulse();
  }

  document.querySelectorAll('.add-to-cart').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.dataset.productId;
      const old = btn.textContent;
      btn.textContent = "‚úÖ Added!";
      btn.style.background = "#16a34a";
      await addToCart(id, 1);
      setTimeout(()=> {
        btn.textContent = old;
        btn.style.background = "#2563eb";
      }, 1000);
    });
  });

  cartBubble.addEventListener('click', ()=> window.location.href='/cart');
});
</script>
