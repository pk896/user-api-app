<!-- views/admin/orders-management.ejs -->
<%
  const PAGE_NONCE = (typeof nonce !== 'undefined' ? nonce : '');
%>

<section class="admin-orders-page">
  <header class="page-head">
    <div class="title-wrap">
      <div class="badge" aria-hidden="true">üßæ</div>
      <div class="title-text">
        <h1>Orders Management</h1>
        <p>Admin: Full refunds only (records refund in DB + debits sellers + restores inventory on full refund).</p>
      </div>
    </div>

    <div class="head-actions">
      <a class="btn ghost" href="/admin">‚Üê Back to Dashboard</a>
      <button class="btn purple" id="reloadBtn" type="button">Reload</button>
    </div>
  </header>

  <div class="toolbar">
    <div class="search">
      <span class="icon" aria-hidden="true">üîé</span>
      <input
        id="searchInput"
        type="text"
        placeholder="Search by Order ID, Capture ID, payer email, payer name‚Ä¶"
        autocomplete="off"
        inputmode="search"
      />
    </div>

    <div class="controls">
      <label class="field">
        <span class="field__label">Limit</span>
        <select id="limitSelect">
          <option value="50">50</option>
          <option value="100" selected>100</option>
          <option value="150">150</option>
          <option value="200">200</option>
        </select>
      </label>

      <label class="field">
        <span class="field__label">Allow refund when unpaid</span>
        <select id="allowUnpaidSelect">
          <option value="true" selected>true</option>
          <option value="false">false</option>
        </select>
      </label>
    </div>
  </div>

  <!-- Flash/Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true" hidden></div>

  <div class="card">
    <div class="table-wrap" role="region" aria-label="Orders list">
      <table class="orders-table">
        <thead>
          <tr>
            <th>Created</th>
            <th>Order</th>
            <th>Status</th>
            <th>Payer</th>
            <th>Amount</th>
            <th>Capture</th>
            <th>Refunds</th>
            <th class="actions-col">Action</th>
          </tr>
        </thead>
        <tbody id="ordersTbody">
          <tr>
            <td colspan="8" class="muted">Loading‚Ä¶</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="footnote muted">
      Full refund action will: add a refund record on the order, debit sellers via your util, and restore inventory only on full refund.
    </div>
  </div>
</section>

<style nonce="<%= PAGE_NONCE %>">
  .admin-orders-page { padding: 18px; max-width: 1200px; margin: 0 auto; }
  .page-head { display:flex; align-items:flex-start; justify-content:space-between; gap:14px; margin-bottom:14px; }
  .title-wrap { display:flex; gap:12px; align-items:flex-start; }
  .badge { width:40px; height:40px; border-radius:12px; display:grid; place-items:center; background: rgba(124,58,237,.12); }
  .title-text h1 { margin:0; font-size: 22px; }
  .title-text p { margin:6px 0 0; }
  .head-actions { display:flex; gap:10px; align-items:center; }

  .toolbar { display:flex; gap:12px; align-items:end; justify-content:space-between; flex-wrap:wrap; margin: 10px 0 14px; }
  .search { flex:1; min-width: 260px; display:flex; align-items:center; gap:10px; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(148,163,184,.35); background: rgba(15,23,42,.03); }
  .search input { width:100%; border:none; outline:none; background:transparent; font-size:14px; }
  .controls { display:flex; gap:10px; flex-wrap:wrap; }
  .field { display:flex; flex-direction:column; gap:6px; }
  .field__label { font-size: 12px; color: rgba(100,116,139,1); }
  select { padding: 9px 10px; border-radius: 12px; border: 1px solid rgba(148,163,184,.35); background: white; }

  .card { border: 1px solid rgba(148,163,184,.25); border-radius: 16px; padding: 10px; background: #fff; box-shadow: 0 8px 24px rgba(2,6,23,.06); }
  .table-wrap { overflow:auto; border-radius: 12px; border: 1px solid rgba(148,163,184,.18); }
  .orders-table { width:100%; border-collapse: collapse; min-width: 980px; }
  .orders-table th, .orders-table td { padding: 10px 10px; border-bottom: 1px solid rgba(148,163,184,.18); text-align:left; vertical-align: top; }
  .orders-table th { font-size: 12px; letter-spacing:.02em; color: rgba(51,65,85,1); background: rgba(15,23,42,.03); position: sticky; top: 0; z-index: 1; }
  .muted { color: rgba(100,116,139,1); }
  .actions-col { width: 190px; }

  .btn { border: 1px solid rgba(148,163,184,.35); padding: 9px 12px; border-radius: 12px; cursor:pointer; background: white; font-weight: 600; }
  .btn.ghost { background: transparent; }
  .btn.purple { background: #7C3AED; border-color: #7C3AED; color: white; }
  .btn.danger { background: #ef4444; border-color: #ef4444; color: white; }
  .btn:disabled { opacity: .55; cursor:not-allowed; }

  .pill { display:inline-flex; align-items:center; gap:6px; padding: 4px 10px; border-radius: 999px; font-size: 12px; border: 1px solid rgba(148,163,184,.35); background: rgba(15,23,42,.03); }
  .pill.ok { border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); }
  .pill.warn { border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
  .pill.bad { border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

  .toast { margin: 10px 0 0; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(148,163,184,.35); background: rgba(15,23,42,.03); }
  .toast.good { border-color: rgba(34,197,94,.35); background: rgba(34,197,94,.08); }
  .toast.bad { border-color: rgba(239,68,68,.35); background: rgba(239,68,68,.10); }

  .footnote { padding: 10px 2px 0; font-size: 12px; }

  @media (max-width: 520px) {
    .admin-orders-page { padding: 12px; }
    .title-text h1 { font-size: 18px; }
    .badge { width:36px; height:36px; border-radius: 12px; }
    .btn { padding: 9px 10px; }
  }
</style>

<script nonce="<%= PAGE_NONCE %>">
  (function () {
    const tbody = document.getElementById('ordersTbody');
    const reloadBtn = document.getElementById('reloadBtn');
    const searchInput = document.getElementById('searchInput');
    const limitSelect = document.getElementById('limitSelect');
    const allowUnpaidSelect = document.getElementById('allowUnpaidSelect');
    const toast = document.getElementById('toast');

    let allOrders = [];

    function showToast(msg, type) {
      toast.textContent = msg || '';
      toast.classList.remove('good', 'bad');
      if (type) toast.classList.add(type);
      toast.hidden = !msg;
      if (msg) setTimeout(() => { toast.hidden = true; }, 5000);
    }

    function fmtDate(d) {
      try {
        const dt = new Date(d);
        if (Number.isNaN(dt.getTime())) return '';
        return dt.toLocaleString();
      } catch { return ''; }
    }

    function safe(v) { return (v == null ? '' : String(v)); }

    function statusPill(status) {
      const s = safe(status).toUpperCase();
      let cls = 'pill';
      if (s === 'COMPLETED' || s === 'PAID') cls += ' ok';
      if (s === 'REFUNDED') cls += ' bad';
      if (s === 'PARTIALLY_REFUNDED' || s === 'REFUND_SUBMITTED') cls += ' warn';
      if (s === 'CANCELLED') cls += ' warn';
      return '<span class="' + cls + '">' + s + '</span>';
    }

    function canRefundFull(order) {
      const s = safe(order.status).toUpperCase();

      if (s === 'REFUNDED') return false;
      if (s === 'PARTIALLY_REFUNDED') return false;
      if (s === 'REFUND_SUBMITTED') return false;

      // extra safety: if refundedTotal already equals/exceeds amount, disable
      const amt = Number(order.amount || 0);
      const rt = Number(order.refundedTotal || 0);
      if (Number.isFinite(amt) && amt > 0 && Number.isFinite(rt) && rt >= amt - 0.00001) return false;

      return true;
    }

    function filterOrders(q) {
      const t = (q || '').trim().toLowerCase();
      if (!t) return allOrders;

      return allOrders.filter(o => {
        const hay = [
          o.orderId,
          o.captureId,
          o.payerEmail,
          o.payerName,
          o.status,
          o.currency,
          o.refundsCount,
          o.refundedTotal
        ].map(safe).join(' ').toLowerCase();
        return hay.includes(t);
      });
    }

    function render(orders) {
      if (!orders.length) {
        tbody.innerHTML = '<tr><td colspan="8" class="muted">No orders found.</td></tr>';
        return;
      }

      tbody.innerHTML = orders.map(o => {
        const orderId = safe(o.orderId);
        const captureId = safe(o.captureId);
        const payer = [safe(o.payerName), safe(o.payerEmail)].filter(Boolean).join(' ¬∑ ');
        const amount = (Number(o.amount || 0)).toFixed(2) + ' ' + safe(o.currency || '');
        const refunds = 'count: ' + safe(o.refundsCount || 0) + (o.refundedTotal != null ? (' ¬∑ total: ' + safe(o.refundedTotal)) : '');

        const disabled = !canRefundFull(o);
        const btn = disabled
          ? '<button class="btn danger" type="button" disabled>Full Refund</button>'
          : '<button class="btn danger" type="button" data-action="full-refund" data-orderid="' + orderId + '">Full Refund</button>';

        return `
          <tr>
            <td>${fmtDate(o.createdAt)}</td>
            <td><div><strong>${orderId}</strong></div></td>
            <td>${statusPill(o.status)}</td>
            <td>${safe(payer) || '<span class="muted">‚Äî</span>'}</td>
            <td>${safe(amount)}</td>
            <td>${captureId ? '<code>' + captureId + '</code>' : '<span class="muted">‚Äî</span>'}</td>
            <td>${safe(refunds)}</td>
            <td>${btn}</td>
          </tr>
        `;
      }).join('');
    }

    function makeRefundId() {
      // unique idempotency key per click
      if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
      // fallback
      return 'refund_' + Date.now() + '_' + Math.random().toString(16).slice(2);
    }

    async function load() {
      const limit = Number(limitSelect.value || 100);
      tbody.innerHTML = '<tr><td colspan="8" class="muted">Loading‚Ä¶</td></tr>';

      try {
        const r = await fetch('/api/admin/orders?limit=' + encodeURIComponent(limit), {
          method: 'GET',
          credentials: 'include',
          headers: { 'Accept': 'application/json' }
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data.ok) throw new Error(data.message || 'Failed to load orders.');

        allOrders = Array.isArray(data.orders) ? data.orders : [];
        render(filterOrders(searchInput.value));
      } catch (e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="8" class="muted">Failed to load orders.</td></tr>';
        showToast(e.message || 'Failed to load orders.', 'bad');
      }
    }

    async function fullRefund(orderId) {
      const allowWhenUnpaid = (String(allowUnpaidSelect.value) === 'true');
      const refundId = makeRefundId();

      const ok = window.confirm(
        'FULL REFUND ONLY:\n\nThis will record a full refund in your DB, debit sellers, and restore inventory (once).\n\nContinue?'
      );
      if (!ok) return;

      // IMPORTANT:
      // ‚úÖ DO NOT SEND "amount" (this enforces full refund behavior in your API)
      const body = {
        refundId,
        reason: 'Admin FULL refund',
        allowWhenUnpaid
      };

      try {
        showToast('Submitting full refund‚Ä¶', null);

        const r = await fetch('/api/admin/orders/' + encodeURIComponent(orderId) + '/refund', {
          method: 'POST',
          credentials: 'include',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify(body)
        });

        const data = await r.json().catch(() => ({}));
        if (!r.ok || !data.ok) throw new Error(data.message || 'Refund failed.');

        showToast(data.message || 'Refund recorded (full).', 'good');
        await load();
      } catch (e) {
        console.error(e);
        showToast(e.message || 'Refund failed.', 'bad');
      }
    }

    // Events
    reloadBtn.addEventListener('click', load);

    searchInput.addEventListener('input', () => {
      render(filterOrders(searchInput.value));
    });

    limitSelect.addEventListener('change', load);

    tbody.addEventListener('click', (ev) => {
      const btn = ev.target && ev.target.closest && ev.target.closest('button[data-action="full-refund"]');
      if (!btn) return;
      const orderId = btn.getAttribute('data-orderid');
      if (!orderId) return;
      fullRefund(orderId);
    });

    // init
    load();
  })();
</script>