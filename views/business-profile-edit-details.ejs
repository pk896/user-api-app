<!-- views/business-profile-edit-details.ejs -->
<% const NONCE = typeof nonce !== 'undefined' ? nonce : '' %>
<% const b = business || {} %>
<% const ver = (b.verification || {}) %>
<% const st = String(ver.status || 'pending').toLowerCase() %>
<% const payouts = (b && b.payouts) ? b.payouts : {} %>
<% const payoutsEnabled = typeof payouts.enabled === 'boolean' ? payouts.enabled : false %>
<% const paypalEmail = payouts.paypalEmail || '' %>

<%
  // ------------------------------------------------------------
  // ‚úÖ Address safe defaults (prevents "street1 is not defined")
  // ------------------------------------------------------------
  const addrObj =
    (b && typeof b.address === 'object' && b.address) ? b.address :
    (b && typeof b.addressObj === 'object' && b.addressObj) ? b.addressObj :
    (b && typeof b.pickupAddress === 'object' && b.pickupAddress) ? b.pickupAddress :
    {};

  const addrString = (b && typeof b.address === 'string') ? b.address : '';

  const street1 = String(
    addrObj.street1 || addrObj.line1 || b.street1 || b.addressLine1 || addrString || ''
  ).trim();

  const street2 = String(
    addrObj.street2 || addrObj.line2 || b.street2 || b.addressLine2 || ''
  ).trim();

  const stateProv = String(
    addrObj.state || addrObj.province || b.state || b.province || ''
  ).trim();

  const postalCode = String(
    addrObj.postalCode || addrObj.zip || b.postalCode || b.zip || ''
  ).trim();

  const countryCode = String(
    addrObj.countryCode || b.countryCode || ''
  ).trim();
%>

<section class="business-edit-page">
  <div class="container">

    <!-- Page Header -->
    <div class="page-header" style="background: linear-gradient(135deg, #7C3AED, #8B5CF6);">
      <div class="header-content">
        <div class="header-icon">
          <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
        </div>
        <div class="header-text">
          <h1 class="page-title">Edit Business Details</h1>
          <p class="page-subtitle">Update your company information. Changes to official number require admin review.</p>
        </div>
      </div>
      <a href="/business/profile" class="back-btn" style="border-color: rgba(255,255,255,0.3); color: white;">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
        </svg>
        Back to Profile
      </a>
    </div>

    <!-- Verification Status Banner -->
    <div class="status-banner <%= st === 'verified' ? 'verified' : (st === 'rejected' ? 'rejected' : 'pending') %>">
      <div class="status-icon">
        <% if (st === 'verified') { %>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
        <% } else if (st === 'rejected') { %>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
          </svg>
        <% } else { %>
          <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
          </svg>
        <% } %>
      </div>

      <div class="status-content">
        <h3>Official Number Verification</h3>
        <div class="status-info">
          <span class="status-tag <%= st === 'verified' ? 'verified' : (st === 'rejected' ? 'rejected' : 'pending') %>">
            <%= st === 'verified' ? 'Verified' : (st === 'rejected' ? 'Rejected' : 'Pending Review') %>
          </span>
          <p>
            being Verified by <strong>Unicoporate.com Admin</strong>.
            <% if (st === 'rejected') { %>
              <span class="rejection-reason">Reason: <%= ver.reason || 'Not specified' %></span>
            <% } else if (st === 'pending') { %>
              <span>Changes to official number will reset status to pending.</span>
            <% } %>
          </p>
        </div>
      </div>
    </div>

    <!-- Main Form -->
    <form class="business-form" action="/business/profile/update-details" method="POST" autocomplete="on">

      <% if (typeof csrfToken !== 'undefined' && csrfToken) { %>
        <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <% } %>

      <!-- Business Identity Section (Blue) -->
      <div class="form-section" style="border-color: #2563EB;">
        <div class="section-header" style="color: #2563EB;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          <h2>Business Identity</h2>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="name" style="color: #2563EB;">
              <span class="label-icon">üè¢</span>
              Business Name *
            </label>
            <input
              type="text"
              id="name"
              name="name"
              value="<%= b.name || '' %>"
              required
              placeholder="Enter your company name (e.g., Unicoporate Trading)"
              autocomplete="organization"
              style="border-color: rgba(37, 99, 235, 0.3);"
            >
            <div class="field-hint" style="color: #2563EB;">Official registered business name</div>
          </div>

          <div class="form-group">
            <label for="role" style="color: #2563EB;">
              <span class="label-icon">üë§</span>
              Account Role
            </label>
            <input
              type="text"
              id="role"
              value="<%= b.role || '' %>"
              disabled
              placeholder="Managed by system administrator"
              style="border-color: rgba(37, 99, 235, 0.3); background: rgba(37, 99, 235, 0.05);"
            >
            <div class="field-hint" style="color: #2563EB;">Role changes require admin approval</div>
          </div>
        </div>
      </div>

      <!-- Contact Information Section (Purple) -->
      <div class="form-section" style="border-color: #7C3AED;">
        <div class="section-header" style="color: #7C3AED;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          <h2>Contact Information</h2>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="email" style="color: #7C3AED;">
              <span class="label-icon">üìß</span>
              Email Address *
            </label>
            <input
              type="email"
              id="email"
              name="email"
              value="<%= b.email || '' %>"
              required
              placeholder="Enter primary business email (e.g., admin@company.com)"
              autocomplete="email"
              inputmode="email"
              style="border-color: rgba(124, 58, 237, 0.3);"
            >
            <div class="field-hint" style="color: #7C3AED;">Email changes may require re-verification</div>
          </div>

          <div class="form-group">
            <label for="phone" style="color: #7C3AED;">
              <span class="label-icon">üì±</span>
              Phone Number *
            </label>
            <input
              type="tel"
              id="phone"
              name="phone"
              value="<%= b.phone || '' %>"
              required
              placeholder="Enter business phone (e.g., +27 81 234 5678)"
              autocomplete="tel"
              inputmode="tel"
              style="border-color: rgba(124, 58, 237, 0.3);"
            >
            <div class="field-hint" style="color: #7C3AED;">Include country code</div>
          </div>

          <!-- ‚úÖ PayPal Payouts -->
          <div class="form-group full-width">
            <label for="paypalEmail" style="color: #7C3AED;">
              <span class="label-icon">üÖøÔ∏è</span>
              PayPal Email (for payouts)
            </label>
            <input
              type="email"
              id="paypalEmail"
              name="paypalEmail"
              value="<%= paypalEmail %>"
              placeholder="paypal@email.com"
              autocomplete="email"
              inputmode="email"
              style="border-color: rgba(124, 58, 237, 0.3);"
            >

            <div class="field-hint" style="color: #7C3AED;">
              This is where Unicoporate sends your <strong>seller payouts</strong>. Leave empty to disable PayPal payouts.
            </div>
          </div>

          <div class="form-group full-width">
            <label style="color: #7C3AED;">
              <span class="label-icon">‚úÖ</span>
              Enable PayPal Payouts
            </label>

            <!-- Hidden so backend ALWAYS receives a value (0) even when unchecked -->
            <input type="hidden" name="payoutsEnabled" value="0" />

            <label class="toggle">
              <input
                type="checkbox"
                name="payoutsEnabled"
                value="1"
                <%= payoutsEnabled ? 'checked' : '' %>
              />
              <span class="toggle-ui" aria-hidden="true"></span>
              <span class="toggle-text" data-on="Enabled" data-off="Disabled">
                <%= payoutsEnabled ? 'Enabled' : 'Disabled' %>
              </span>
            </label>

            <div class="field-hint" style="color: #7C3AED;">
              To be eligible: payouts must be enabled + PayPal email must be set + you must have available balance.
            </div>
          </div>
        </div>
      </div>

      <!-- Location Details Section (Green) -->
      <div class="form-section" style="border-color: #22C55E;">
        <div class="section-header" style="color: #22C55E;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <h2>Location Details</h2>
        </div>

        <div class="form-grid">
          <div class="form-group full-width">
            <label style="color: #22C55E;">
              <span class="label-icon">üåç</span>
              Country *
            </label>

            <div class="country-dropdown">
              <div class="country-selected" id="countrySelected">
                <span class="country-selected-left">
                  <img id="countrySelectedFlagImg" class="country-flag-img" alt="" aria-hidden="true" />
                  <span id="countrySelectedText">
                    <%= b.country || 'Select your country' %>
                  </span>
                </span>
                <span class="country-arrow">‚ñæ</span>
              </div>

              <div class="country-menu" id="countryMenu">
                <input
                  type="text"
                  id="countrySearch"
                  placeholder="Search country..."
                  autocomplete="off"
                  class="country-search-input"
                />

                <div class="country-list">
                  <% if (Array.isArray(COUNTRIES)) { %>
                    <% COUNTRIES.forEach(function(c) { %>
                      <div
                        class="country-option <%= b.country === c.name ? 'active' : '' %>"
                        data-value="<%= c.name %>"
                        data-code="<%= c.code %>"
                      >
                        <img
                          class="country-flag-img"
                          src="https://flagcdn.com/20x15/<%= String(c.code || '').toLowerCase() %>.png"
                          alt=""
                          loading="lazy"
                        />
                        <span class="country-name"><%= c.name %></span>
                      </div>
                    <% }) %>
                  <% } %>
                </div>
              </div>

              <!-- Hidden REAL select (backend safe) -->
              <select id="country" name="country" required style="display:none;">
                <option value="">Select your country</option>
                <% if (Array.isArray(COUNTRIES)) { %>
                  <% COUNTRIES.forEach(function(c) { %>
                    <option
                      value="<%= c.name %>"
                      data-code="<%= c.code %>"
                      <%= b.country === c.name ? 'selected' : '' %>
                    >
                      <%= c.name %>
                    </option>
                  <% }) %>
                <% } %>
              </select>
            </div>

            <div class="field-hint" style="color: #22C55E;">
              Select primary operating country
            </div>
          </div>

          <div class="form-group">
            <label for="city" style="color: #22C55E;">
              <span class="label-icon">üèôÔ∏è</span>
              City *
            </label>
            <input
              type="text"
              id="city"
              name="city"
              value="<%= b.city || '' %>"
              required
              placeholder="Enter city (e.g., Johannesburg)"
              autocomplete="address-level2"
              style="border-color: rgba(34, 197, 94, 0.3);"
            >
            <div class="field-hint" style="color: #22C55E;">City where business is located</div>
          </div>

          <!-- ‚úÖ Shippo-ready address fields -->
          <div class="form-group full-width">
            <label for="street1" style="color: #22C55E;">
              <span class="label-icon">üìç</span>
              Street Address (Line 1) *
            </label>
            <input
              type="text"
              id="street1"
              name="street1"
              value="<%= street1 %>"
              required
              placeholder="Street number + street name (e.g., 12 Main Road)"
              autocomplete="address-line1"
              style="border-color: rgba(34, 197, 94, 0.3);"
            >
            <div class="field-hint" style="color: #22C55E;">Required for Shippo pickup/shipping</div>
          </div>

          <div class="form-group full-width">
            <label for="street2" style="color: #22C55E;">
              <span class="label-icon">üèòÔ∏è</span>
              Address Line 2 (optional)
            </label>
            <input
              type="text"
              id="street2"
              name="street2"
              value="<%= street2 %>"
              placeholder="Suburb, unit, complex, floor (optional)"
              autocomplete="address-line2"
              style="border-color: rgba(34, 197, 94, 0.3);"
            >
          </div>

          <div class="form-group">
            <label for="state" style="color: #22C55E;">
              <span class="label-icon">üó∫Ô∏è</span>
              Province / State *
            </label>
            <input
              type="text"
              id="state"
              name="state"
              value="<%= stateProv || '' %>"
              required
              placeholder="e.g., Gauteng"
              autocomplete="address-level1"
              style="border-color: rgba(34, 197, 94, 0.3);"
            >
          </div>

          <div class="form-group">
            <label for="postalCode" style="color: #22C55E;">
              <span class="label-icon">üè∑Ô∏è</span>
              Postal Code *
            </label>
            <input
              type="text"
              id="postalCode"
              name="postalCode"
              value="<%= postalCode || '' %>"
              required
              placeholder="e.g., 2001"
              autocomplete="postal-code"
              inputmode="numeric"
              style="border-color: rgba(34, 197, 94, 0.3);"
            >
          </div>

          <!-- hidden Shippo country code (2-letter) -->
          <input type="hidden" id="countryCode" name="countryCode" value="<%= countryCode %>">
        </div>
      </div>

      <!-- Official Registration Section (Black) -->
      <div class="form-section" style="border-color: #0F172A;">
        <div class="section-header" style="color: #0F172A;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <h2>Official Registration</h2>
        </div>

        <div class="verification-notice" style="background: rgba(124, 58, 237, 0.1); border-color: rgba(124, 58, 237, 0.2);">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor" style="color: #7C3AED;">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
          <div>
            <strong>Important:</strong> Changing official number resets verification to <strong>Pending</strong> until admin review.
          </div>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label for="officialNumber" style="color: #0F172A;">
              <span class="label-icon">üÜî</span>
              Official Number *
            </label>
            <input
              type="text"
              id="officialNumber"
              name="officialNumber"
              value="<%= b.officialNumber || '' %>"
              required
              placeholder="Enter company registration/VAT/tax number"
              autocomplete="off"
              inputmode="text"
              style="border-color: rgba(15, 23, 42, 0.3);"
            >
            <div class="field-hint" style="color: #0F172A;">Unique business identification number</div>
          </div>

          <div class="form-group">
            <label for="officialNumberType" style="color: #0F172A;">
              <span class="label-icon">üìã</span>
              Number Type
            </label>
            <select
              id="officialNumberType"
              name="officialNumberType"
              style="border-color: rgba(15, 23, 42, 0.3); background: rgba(15, 23, 42, 0.05);"
            >
              <option value="CIPC_REG" <%= b.officialNumberType === 'CIPC_REG' ? 'selected' : '' %>>Company Registration (CIPC)</option>
              <option value="VAT" <%= b.officialNumberType === 'VAT' ? 'selected' : '' %>>VAT Number</option>
              <option value="TIN" <%= b.officialNumberType === 'TIN' ? 'selected' : '' %>>Tax Identification (TIN)</option>
              <option value="OTHER" <%= (!b.officialNumberType || b.officialNumberType === 'OTHER') ? 'selected' : '' %>>Other Official Number</option>
            </select>
            <div class="field-hint" style="color: #0F172A;">Helps admin verify faster</div>
          </div>
        </div>
      </div>

      <!-- Form Actions -->
      <div class="form-actions">
        <button type="submit" class="btn btn-primary" style="background: linear-gradient(135deg, #7C3AED, #8B5CF6);">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
          </svg>
          Save Business Details
        </button>
        <a href="/business/profile" class="btn btn-outline" style="border-color: #7C3AED; color: #7C3AED;">
          Cancel
        </a>
      </div>
    </form>

    <!-- Quick Links -->
    <div class="quick-links">
      <h3 class="links-title">Quick Actions</h3>
      <div class="links-grid">
        <a href="#" class="link-card" style="background: linear-gradient(135deg, #7C3AED, #8B5CF6);">
          <div class="link-icon">‚öôÔ∏è</div>
          <div class="link-content">
            <h4>Advanced Editor</h4>
            <p>key details only for privacy</p>
          </div>
          <div class="link-arrow">‚Üí</div>
        </a>

        <a href="/business/change-password" class="link-card" style="background: linear-gradient(135deg, #0F172A, #334155);">
          <div class="link-icon">üîí</div>
          <div class="link-content">
            <h4>Change Password</h4>
            <p>Update security credentials</p>
          </div>
          <div class="link-arrow">‚Üí</div>
        </a>

        <a href="/business/profile/edit-bank" class="link-card" style="background: linear-gradient(135deg, #22C55E, #10B981);">
          <div class="link-icon">üè¶</div>
          <div class="link-content">
            <h4>Bank Details</h4>
            <p>Update payout information</p>
          </div>
          <div class="link-arrow">‚Üí</div>
        </a>
      </div>
    </div>

  </div>
</section>

<style nonce="<%= NONCE %>">
  .business-edit-page {
    --blue: #2563EB;
    --purple: #7C3AED;
    --green: #22C55E;
    --black: #0F172A;
    --gray-50: #F8FAFC;
    --gray-100: #F1F5F9;
    --gray-200: #E2E8F0;
    --gray-300: #CBD5E1;
    --gray-400: #94A3B8;
    --gray-500: #64748B;
    --gray-600: #475569;
    --gray-700: #334155;
    --gray-800: #1E293B;
    --gray-900: #0F172A;
    padding: 0.75rem 0 2rem;
    background: var(--gray-50);
    min-height: 100vh;
  }

  .container { max-width: 1000px; margin: 0 auto; padding: 0 1rem; }

  .page-header {
    background: linear-gradient(135deg, var(--purple), #8B5CF6);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    color: white;
  }

  .header-content { display: flex; align-items: center; gap: 1rem; }
  .header-icon {
    width: 56px; height: 56px;
    border-radius: 14px;
    background: rgba(255, 255, 255, 0.2);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .page-title { font-size: 1.5rem; font-weight: 700; margin: 0 0 0.25rem 0; color: white; }
  .page-subtitle { margin: 0; font-size: 0.875rem; color: rgba(255, 255, 255, 0.9); max-width: 500px; }

  .back-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    border-radius: 10px;
    font-weight: 600;
    text-decoration: none;
    font-size: 0.875rem;
    transition: all 0.2s;
    border: 2px solid;
    background: rgba(255, 255, 255, 0.1);
  }
  .back-btn:hover { background: rgba(255, 255, 255, 0.2); transform: translateX(-2px); }

  .status-banner {
    padding: 1rem;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    display: flex;
    gap: 1rem;
    align-items: flex-start;
  }
  .status-banner.verified { background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); }
  .status-banner.pending  { background: rgba(245, 158, 11, 0.1); border: 1px solid rgba(245, 158, 11, 0.2); }
  .status-banner.rejected { background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); }

  .status-icon {
    width: 40px; height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }
  .status-banner.verified .status-icon { background: #22C55E; color: white; }
  .status-banner.pending  .status-icon { background: #F59E0B; color: white; }
  .status-banner.rejected .status-icon { background: #EF4444; color: white; }

  .status-content h3 { margin: 0 0 0.5rem 0; font-size: 1rem; font-weight: 600; color: var(--gray-900); }
  .status-info { display: flex; flex-direction: column; gap: 0.5rem; }
  @media (min-width: 640px) { .status-info { flex-direction: row; align-items: center; } }

  .status-tag {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    white-space: nowrap;
  }
  .status-tag.verified { background: rgba(34, 197, 94, 0.2); color: #166534; }
  .status-tag.pending  { background: rgba(245, 158, 11, 0.2); color: #92400E; }
  .status-tag.rejected { background: rgba(239, 68, 68, 0.2); color: #991B1B; }

  .status-info p { margin: 0; font-size: 0.875rem; color: var(--gray-600); }
  .rejection-reason { color: #DC2626; font-weight: 600; margin-left: 0.5rem; }

  .business-form {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    margin-bottom: 1.5rem;
    border: 1px solid var(--gray-200);
  }

  .form-section { padding: 1.5rem; border-bottom: 3px solid; }
  .form-section:last-child { border-bottom: none; }

  .section-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; font-weight: 600; }
  .section-header h2 { margin: 0; font-size: 1.125rem; }

  .form-grid { display: grid; gap: 1.25rem; }
  @media (min-width: 768px) { .form-grid { grid-template-columns: repeat(2, 1fr); } }

  .form-group { display: flex; flex-direction: column; }
  .form-group.full-width { grid-column: 1 / -1; }

  /* Country Dropdown */
  .country-dropdown {
    position: relative;
  }

  .country-selected {
    padding: 0.75rem 1rem;
    border: 2px solid rgba(34, 197, 94, 0.3);
    border-radius: 10px;
    cursor: pointer;
    background: rgba(34, 197, 94, 0.05);
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
  }

  .country-dropdown.open .country-menu {
    display: block;
  }

  .country-selected-left{
    display: inline-flex;
    align-items: center;
    gap: 0.55rem;
    min-width: 0;
  }

  .country-flag-img{
    width: 18px;
    height: 13px;
    border-radius: 3px;
    object-fit: cover;
    flex: 0 0 auto;
    box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.35);
  }

  .country-name{
    display: inline-block;
    min-width: 0;
  }

  .country-menu {
    position: absolute;
    top: 105%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #E2E8F0;
    border-radius: 10px;
    max-height: 260px;
    overflow-y: auto;
    display: none;
    z-index: 50;
    box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  }

  .country-search-input {
    width: 100%;
    padding: 0.6rem;
    border: none;
    border-bottom: 1px solid #E2E8F0;
    outline: none;
  }

  .country-option {
    padding: 0.6rem 1rem;
    cursor: pointer;
    font-size: 0.875rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }

  .country-option:hover {
    background: rgba(124, 58, 237, 0.08);
  }

  .country-option.active {
    background: rgba(124, 58, 237, 0.15);
    font-weight: 600;
  }

  label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }
  .label-icon { font-size: 1rem; }

  input, select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 2px solid;
    border-radius: 10px;
    font-size: 0.875rem;
    transition: all 0.2s;
    outline: none;
    background: white;
  }
  input:focus, select:focus { box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); transform: translateY(-1px); }
  input::placeholder { color: var(--gray-400); }
  input:disabled { background: rgba(15, 23, 42, 0.05); color: var(--gray-500); cursor: not-allowed; }

  .field-hint { font-size: 0.75rem; margin-top: 0.375rem; font-weight: 500; }

  /* Toggle */
  .toggle { display:flex; align-items:center; gap:10px; user-select:none; }
  .toggle input { position:absolute; opacity:0; pointer-events:none; }
  .toggle-ui {
    width:52px; height:30px;
    border-radius:999px;
    background: rgba(124,58,237,.25);
    border: 2px solid rgba(124,58,237,.35);
    position:relative;
    transition: all .2s ease;
    flex-shrink:0;
  }
  .toggle-ui::after{
    content:'';
    position:absolute;
    top:50%;
    left:3px;
    width:24px;
    height:24px;
    border-radius:999px;
    background:#fff;
    transform: translateY(-50%);
    transition: all .2s ease;
    box-shadow: 0 6px 14px rgba(15,23,42,.18);
  }
  .toggle input:checked + .toggle-ui { background: rgba(34,197,94,.25); border-color: rgba(34,197,94,.45); }
  .toggle input:checked + .toggle-ui::after { left:23px; }
  .toggle-text { font-size:.875rem; font-weight:700; color: var(--gray-700); }

  .verification-notice {
    padding: 0.875rem 1rem;
    border-radius: 10px;
    margin-bottom: 1rem;
    display: flex;
    gap: 0.75rem;
    align-items: flex-start;
    border: 1px solid rgba(124, 58, 237, 0.2);
  }
  .verification-notice strong { color: var(--purple); }

  .form-actions {
    padding: 1.5rem;
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
    border-top: 1px solid var(--gray-200);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.875rem 1.5rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.875rem;
    cursor: pointer;
    text-decoration: none;
    transition: all 0.2s;
    border: 2px solid transparent;
  }
  .btn-primary { color: white; border: none; }
  .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3); }

  .btn-outline { background: white; }
  .btn-outline:hover { background: var(--gray-50); transform: translateY(-2px); }

  .quick-links { margin-top: 2rem; }
  .links-title { font-size: 1.125rem; font-weight: 600; color: var(--gray-900); margin: 0 0 1rem 0; }

  .links-grid { display: grid; gap: 1rem; }
  @media (min-width: 640px) { .links-grid { grid-template-columns: repeat(3, 1fr); } }

  .link-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1.25rem;
    border-radius: 12px;
    text-decoration: none;
    color: white;
    transition: all 0.2s;
    border: 1px solid transparent;
  }
  .link-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
  }

  .link-icon {
    font-size: 1.5rem;
    width: 48px;
    height: 48px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .link-content { flex: 1; }
  .link-content h4 { margin: 0 0 0.25rem 0; font-size: 1rem; font-weight: 600; }
  .link-content p { margin: 0; font-size: 0.75rem; opacity: 0.9; }
  .link-arrow { font-size: 1.25rem; font-weight: 700; opacity: 0.8; }

  @media (max-width: 360px) {
    .container { padding: 0 0.75rem; }
    .page-header { flex-direction: column; align-items: stretch; gap: 1rem; }
    .header-content { flex-direction: column; text-align: center; }
    .back-btn { width: 100%; justify-content: center; }
    .status-banner { flex-direction: column; text-align: center; }
    .form-grid { grid-template-columns: 1fr; }
    .form-actions { flex-direction: column; }
    .btn { width: 100%; justify-content: center; }
    .links-grid { grid-template-columns: 1fr; }
    .link-card { flex-direction: column; text-align: center; }
    .link-content { text-align: center; }
  }

  @media (prefers-color-scheme: dark) {
    .business-edit-page { background: var(--gray-900); }
    .business-form { background: var(--gray-800); border-color: var(--gray-700); }
    .links-title { color: var(--gray-100); }
    .status-content h3 { color: var(--gray-100); }
    input, select { background: var(--gray-800); border-color: var(--gray-700); color: var(--gray-100); }
    input::placeholder { color: var(--gray-500); }
    input:disabled { background: rgba(15, 23, 42, 0.2); color: var(--gray-500); }
    .verification-notice { background: rgba(124, 58, 237, 0.15); border-color: rgba(124, 58, 237, 0.3); }
    .btn-outline { background: var(--gray-800); color: var(--gray-100); border-color: var(--gray-600); }
    .btn-outline:hover { background: var(--gray-700); }
    .toggle-text { color: var(--gray-200); }
  }
</style>

<script nonce="<%= NONCE %>">
  (function () {
    // -----------------------------
    // 1) Keep hidden countryCode synced
    // -----------------------------
    const countrySelect = document.getElementById('country');
    const countryCodeHidden = document.getElementById('countryCode');
    
    // -----------------------------
    // 0) Custom Country Dropdown Logic
    // -----------------------------
    const dropdown = document.querySelector('.country-dropdown');
    const selected = document.getElementById('countrySelected');
    const selectedText = document.getElementById('countrySelectedText');
    const selectedFlagImg = document.getElementById('countrySelectedFlagImg');

    const setSelectedFlagFromCode = (cc) => {
      if (!selectedFlagImg) return;
      const c = String(cc || '').trim().toLowerCase();
      if (!c) {
        selectedFlagImg.removeAttribute('src');
        return;
      }
      selectedFlagImg.src = `https://flagcdn.com/20x15/${c}.png`;
    };
    const menu = document.getElementById('countryMenu');
    const searchInput = document.getElementById('countrySearch');
    const options = document.querySelectorAll('.country-option');

    if (dropdown && selected && menu) {

      // Toggle dropdown open/close
      selected.addEventListener('click', () => {
        dropdown.classList.toggle('open');
      });

      // Click outside closes dropdown
      document.addEventListener('click', (e) => {
        if (!dropdown.contains(e.target)) {
          dropdown.classList.remove('open');
        }
      });

      // Handle option click
      options.forEach(opt => {
        opt.addEventListener('click', () => {
          const value = opt.dataset.value || '';
          const code = opt.dataset.code || '';

          // Update visible text + flag
          if (selectedText) selectedText.textContent = value;
          setSelectedFlagFromCode(code);

          // Update hidden select
          if (countrySelect) {
            countrySelect.value = value;

            // Update selected option manually
            const realOptions = countrySelect.querySelectorAll('option');
            realOptions.forEach(o => {
              o.selected = (o.value === value);
            });
          }

          if (countryCodeHidden) {
            countryCodeHidden.value = String(code || '').trim();
          }

          // Update active class
          options.forEach(o => o.classList.remove('active'));
          opt.classList.add('active');

          dropdown.classList.remove('open');
        });
      });

      // Search filter
      if (searchInput) {
        searchInput.addEventListener('input', () => {
          const term = searchInput.value.toLowerCase().trim();

          options.forEach(opt => {
            const text = opt.textContent.toLowerCase();
            opt.style.display = text.includes(term) ? 'block' : 'none';
          });
        });
      }
    }

    const syncCountryCode = () => {
      if (!countrySelect || !countryCodeHidden) return;
      const opt = countrySelect.options[countrySelect.selectedIndex];
      const code = (opt && opt.dataset && opt.dataset.code) ? String(opt.dataset.code) : '';
      const clean = code.trim();
      countryCodeHidden.value = clean;
      setSelectedFlagFromCode(clean);
    };

    if (countrySelect && countryCodeHidden) {
      countrySelect.addEventListener('change', syncCountryCode);

      // ‚úÖ initial: sync from the real <select> (sets hidden + flag)
      syncCountryCode();
    }

    // -----------------------------
    // 2) PayPal toggle: require PayPal email ONLY when enabled
    // -----------------------------
    const paypal = document.getElementById('paypalEmail');
    const payoutsCheckbox = document.querySelector('input[type="checkbox"][name="payoutsEnabled"][value="1"]');
    const toggleText = document.querySelector('.toggle .toggle-text');

    const renderPayouts = () => {
      const on = !!(payoutsCheckbox && payoutsCheckbox.checked);

      if (toggleText) {
        toggleText.textContent = on ? (toggleText.dataset.on || 'Enabled') : (toggleText.dataset.off || 'Disabled');
      }

      if (paypal) {
        // IMPORTANT:
        // - do NOT disable paypal field (disabled inputs do NOT submit)
        // - only require it when payouts is enabled
        if (on) paypal.setAttribute('required', 'required');
        else paypal.removeAttribute('required');
      }
    };

    if (payoutsCheckbox) {
      payoutsCheckbox.addEventListener('change', renderPayouts);
      renderPayouts(); // initial
    }

    // -----------------------------
    // 3) Debug: show which field blocks submit
    // -----------------------------
    const form = document.querySelector('form.business-form');
    if (form) {
      // On submit attempt, if something is invalid, show it clearly
      form.addEventListener('submit', (e) => {
        // browser validation
        if (!form.checkValidity()) {
          e.preventDefault();

          // Find the first invalid element
          const firstInvalid = form.querySelector(':invalid');
          if (firstInvalid) {
            // Make it obvious
            firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstInvalid.focus({ preventScroll: true });

            // Friendly label text if possible
            const label = form.querySelector(`label[for="${firstInvalid.id}"]`);
            const labelText = label ? label.textContent.trim() : (firstInvalid.name || firstInvalid.id || 'a field');

            alert(`‚ùå Please fix: ${labelText}`);

            console.log('BLOCKED SUBMIT (invalid field):', {
              id: firstInvalid.id,
              name: firstInvalid.name,
              value: firstInvalid.value
            });
          } else {
            alert('‚ùå Please fill all required fields.');
            console.log('BLOCKED SUBMIT: form invalid but no :invalid found');
          }

          return;
        }

        // If valid, log what will be submitted (helps debug server-side)
        const fd = new FormData(form);
        console.log('‚úÖ SUBMITTING update-details with:', Object.fromEntries(fd.entries()));
      });

      // Also log any invalid event
      form.addEventListener('invalid', (e) => {
        console.log('INVALID EVENT:', e.target.name || e.target.id, e.target.validationMessage);
      }, true);
    }
  })();
</script>
