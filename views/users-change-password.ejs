<!-- views/users-change-password.ejs -->
<section class="auth-page mini">
  <!-- Brand Header -->
  <div class="brand-header">
    <div class="logo-preview">
      <div class="logo-color blue"></div>
      <div class="logo-color purple"></div>
      <div class="logo-color green"></div>
      <div class="logo-color black"></div>
    </div>
    <h1 class="page-title">üîê Update Your Password</h1>
    <p class="page-subtitle">
      Secure your account by setting a strong, unique password
    </p>
  </div>

  <!-- Flash Messages -->
  <% (success || []).forEach(msg => { %>
    <div class="flash flash-success">
      <svg class="flash-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="20 6 9 17 4 12"></polyline>
      </svg>
      <div class="flash-content">
        <strong>Success!</strong> <%= msg %>
      </div>
    </div>
  <% }) %>

  <% (error || []).forEach(msg => { %>
    <div class="flash flash-error">
      <svg class="flash-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <line x1="15" y1="9" x2="9" y2="15"></line>
        <line x1="9" y1="9" x2="15" y2="15"></line>
      </svg>
      <div class="flash-content">
        <strong>Error:</strong> <%= msg %>
      </div>
    </div>
  <% }) %>

  <!-- Security Status -->
  <div class="security-status">
    <div class="status-icon">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
      </svg>
    </div>
    <div class="status-content">
      <h3>Password Security</h3>
      <p>Changing your password regularly helps protect your account</p>
    </div>
  </div>

  <!-- Password Change Form -->
  <form
    action="/users/change-password"
    method="post"
    class="auth-form card"
    autocomplete="off"
    novalidate
    id="passwordForm"
  >
    <div class="form-section">
      <!-- Current Password -->
      <div class="input-group">
        <label class="floating-label">
          <input
            id="current"
            type="password"
            name="current"
            required
            minlength="6"
            autocomplete="current-password"
            placeholder=" "
            class="password-input"
          />
          <span class="label-text">Current Password</span>
          <div class="input-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M17 7v5c0 1.06.56 2 1.4 2.6A5 5 0 0 1 20 16c0 2.8-2.2 5-5 5s-5-2.2-5-5v-5a5 5 0 1 1 10 0z"></path>
              <path d="M8.5 12h.01"></path>
            </svg>
          </div>
          <button
            type="button"
            class="password-toggle"
            data-target="current"
            aria-label="Show current password"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </label>
        
        <!-- Current Password Validation -->
        <div class="validation-hint">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          Enter your current account password
        </div>
      </div>

      <!-- New Password -->
      <div class="input-group">
        <label class="floating-label">
          <input
            id="next"
            type="password"
            name="next"
            required
            minlength="6"
            autocomplete="new-password"
            placeholder=" "
            class="password-input"
            data-strength-meter="true"
          />
          <span class="label-text">New Password</span>
          <div class="input-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
              <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
          </div>
          <button
            type="button"
            class="password-toggle"
            data-target="next"
            aria-label="Show new password"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </label>
        
        <!-- Password Strength Meter -->
        <div class="password-strength">
          <div class="strength-label">
            <span class="label-text">Password Strength</span>
            <span class="strength-value" id="strengthValue">Weak</span>
          </div>
          <div class="strength-meter">
            <div class="meter-bar"></div>
            <div class="meter-bar"></div>
            <div class="meter-bar"></div>
            <div class="meter-bar"></div>
          </div>
        </div>
      </div>

      <!-- Confirm New Password -->
      <div class="input-group">
        <label class="floating-label">
          <input
            id="confirm"
            type="password"
            name="confirm"
            required
            minlength="6"
            autocomplete="new-password"
            placeholder=" "
            class="password-input"
          />
          <span class="label-text">Confirm New Password</span>
          <div class="input-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
              <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
          </div>
          <button
            type="button"
            class="password-toggle"
            data-target="confirm"
            aria-label="Show confirm password"
          >
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
            </svg>
          </button>
        </label>
        
        <!-- Password Match Indicator -->
        <div class="match-indicator" id="matchIndicator">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span>Passwords will be checked for match</span>
        </div>
      </div>

      <!-- Password Requirements -->
      <div class="password-requirements">
        <h4 class="requirements-title">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          Password Requirements
        </h4>
        <ul class="requirements-list">
          <li class="requirement-item" data-requirement="length">
            <span class="requirement-check"></span>
            At least 6 characters
          </li>
          <li class="requirement-item" data-requirement="number">
            <span class="requirement-check"></span>
            Contains a number
          </li>
          <li class="requirement-item" data-requirement="lowercase">
            <span class="requirement-check"></span>
            Contains a lowercase letter
          </li>
          <li class="requirement-item" data-requirement="uppercase">
            <span class="requirement-check"></span>
            Contains an uppercase letter
          </li>
          <li class="requirement-item" data-requirement="special">
            <span class="requirement-check"></span>
            Contains a special character (!@#$%^&*)
          </li>
        </ul>
      </div>

      <!-- Password Tips -->
      <div class="password-tips">
        <div class="tip-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          <span>Use a unique password that you don't use elsewhere</span>
        </div>
        <div class="tip-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          <span>Consider using a password manager for better security</span>
        </div>
        <div class="tip-item">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="16" x2="12" y2="12"></line>
            <line x1="12" y1="8" x2="12.01" y2="8"></line>
          </svg>
          <span>Avoid personal information like birthdays or names</span>
        </div>
      </div>
    </div>

    <!-- Submit Button -->
    <button type="submit" class="btn primary wfull submit-btn" id="submitBtn">
      <span class="btn-text">Update Password</span>
      <div class="spinner hidden">
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
        <div class="spinner-dot"></div>
      </div>
    </button>

    <!-- Password Last Changed -->
    <div class="password-history" id="passwordHistory" hidden>
      <h4>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"></circle>
          <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Password History
      </h4>
      <p>Your password was last changed <span id="lastChanged">recently</span></p>
    </div>
  </form>

  <!-- Success State -->
  <div class="success-state card hidden" id="successState">
    <div class="success-icon">
      <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
        <polyline points="22 4 12 14.01 9 11.01"></polyline>
      </svg>
    </div>
    <h3>Password Updated!</h3>
    <p>Your password has been successfully changed. You'll need to use your new password next time you sign in.</p>
    
    <div class="success-actions">
      <a href="/users/profile" class="btn primary wfull" data-nav="true">
        <svg class="btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
          <circle cx="12" cy="7" r="4"></circle>
        </svg>
        Back to Profile
      </a>
      
      <a href="/users/logout" class="btn outline wfull" data-nav="true">
        <svg class="btn-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
          <polyline points="16 17 21 12 16 7"></polyline>
          <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Sign Out & Test
      </a>
    </div>
  </div>

  <!-- Navigation Links -->
  <div class="navigation-links">
    <a href="/users/profile" class="nav-link back-link" data-nav="true">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
      Back to Profile
    </a>
    
    <span class="link-divider">‚Ä¢</span>
    
    <a href="/users/password/forgot" class="nav-link forgot-link" data-nav="true">
      Forgot Password?
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </a>
  </div>

  <!-- Password Generator Modal -->
  <div class="modal" id="passwordGeneratorModal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Generate Strong Password</h3>
        <button type="button" class="modal-close" aria-label="Close">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div class="generator-controls">
          <div class="control-group">
            <label class="control-label">Length: <span id="lengthValue">12</span></label>
            <input type="range" id="lengthSlider" min="8" max="24" value="12" class="range-slider">
          </div>
          
          <div class="control-group">
            <label class="checkbox-control">
              <input type="checkbox" id="uppercaseCheck" checked>
              <span class="checkmark"></span>
              <span class="checkbox-text">Uppercase Letters</span>
            </label>
            
            <label class="checkbox-control">
              <input type="checkbox" id="lowercaseCheck" checked>
              <span class="checkmark"></span>
              <span class="checkbox-text">Lowercase Letters</span>
            </label>
            
            <label class="checkbox-control">
              <input type="checkbox" id="numbersCheck" checked>
              <span class="checkmark"></span>
              <span class="checkbox-text">Numbers</span>
            </label>
            
            <label class="checkbox-control">
              <input type="checkbox" id="symbolsCheck" checked>
              <span class="checkmark"></span>
              <span class="checkbox-text">Symbols</span>
            </label>
          </div>
        </div>
        
        <div class="generator-output">
          <input type="text" readonly id="generatedPassword" class="password-output">
          <button type="button" class="btn secondary" id="copyPassword">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            Copy
          </button>
        </div>
        
        <button type="button" class="btn primary wfull" id="generatePassword">
          Generate New Password
        </button>
      </div>
    </div>
  </div>
</section>

<style nonce="<%= typeof nonce !== 'undefined' ? nonce : '' %>">
  /* Brand Color Variables */
  :root {
    --brand-blue: #2563EB;    /* Trust & Reliability */
    --brand-purple: #7C3AED;  /* Innovation & Creativity */
    --brand-green: #22C55E;   /* Growth & Success (Primary) */
    --brand-black: #0F172A;   /* Sophistication & Premium */
    
    --bg-primary: #22C55E;
    --bg-secondary: #f0fdf4;
    --text-primary: #0F172A;
    --text-secondary: #475569;
    --card-bg: #ffffff;
    --card-border: #e2e8f0;
    --input-bg: #f8fafc;
    --success-light: #dcfce7;
    --error-light: #fee2e2;
    --warning-light: #fef3c7;
  }

  .dark-theme {
    --bg-primary: #16a34a;
    --bg-secondary: #052e16;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --card-bg: #1e293b;
    --card-border: #334155;
    --input-bg: #0f172a;
    --success-light: #064e3b;
    --error-light: #7f1d1d;
    --warning-light: #78350f;
  }

  /* Base Styles */
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  body {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, #ffffff 100%);
    color: var(--text-primary);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    line-height: 1.5;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .dark-theme body {
    background: linear-gradient(135deg, var(--bg-secondary) 0%, #0f172a 100%);
  }

  /* Main Container */
  .auth-page.mini {
    max-width: 480px;
    width: 100%;
    margin: 0 auto;
  }

  /* Brand Header */
  .brand-header {
    text-align: center;
    margin-bottom: 2rem;
  }

  .logo-preview {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 1rem;
  }

  .logo-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
  }

  .logo-color.blue { background: var(--brand-blue); }
  .logo-color.purple { background: var(--brand-purple); }
  .logo-color.green { background: var(--brand-green); }
  .logo-color.black { background: var(--brand-black); }

  .page-title {
    font-size: 1.75rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    background: linear-gradient(135deg, var(--brand-blue), var(--brand-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .page-subtitle {
    color: var(--text-secondary);
    font-size: 0.9375rem;
    line-height: 1.4;
  }

  /* Flash Messages */
  .flash {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    padding: 1rem 1.25rem;
    border-radius: 12px;
    margin-bottom: 1.25rem;
    font-size: 0.875rem;
    line-height: 1.4;
    animation: slideIn 0.3s ease;
  }

  .flash-success {
    background: var(--success-light);
    color: #065f46;
    border: 1px solid #a7f3d0;
  }

  .flash-error {
    background: var(--error-light);
    color: #991b1b;
    border: 1px solid #fecaca;
  }

  .flash-icon {
    flex-shrink: 0;
    margin-top: 0.125rem;
  }

  .flash-content {
    flex: 1;
  }

  .flash-content strong {
    font-weight: 600;
  }

  .dark-theme .flash-success {
    color: #a7f3d0;
  }

  .dark-theme .flash-error {
    color: #fecaca;
  }

  /* Security Status */
  .security-status {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    background: linear-gradient(135deg, rgba(37, 99, 235, 0.1), rgba(124, 58, 237, 0.1));
    border-radius: 12px;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(124, 58, 237, 0.2);
  }

  .status-icon {
    color: var(--brand-purple);
    flex-shrink: 0;
  }

  .status-content h3 {
    font-size: 0.9375rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
    color: var(--text-primary);
  }

  .status-content p {
    font-size: 0.8125rem;
    color: var(--text-secondary);
  }

  /* Card */
  .card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    position: relative;
    overflow: hidden;
  }

  .card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--brand-blue), var(--brand-purple));
  }

  .dark-theme .card {
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
  }

  /* Form */
  .auth-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-section {
    display: flex;
    flex-direction: column;
    gap: 1.25rem;
  }

  /* Floating Labels */
  .input-group {
    position: relative;
  }

  .floating-label {
    position: relative;
  }

  .floating-label input {
    width: 100%;
    padding: 1rem 3.5rem 0.5rem 1rem;
    font-size: 0.9375rem;
    background: var(--input-bg);
    border: 2px solid var(--card-border);
    border-radius: 10px;
    color: var(--text-primary);
    transition: all 0.2s ease;
  }

  .floating-label input:focus {
    outline: none;
    border-color: var(--brand-green);
    box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.1);
  }

  .floating-label input:focus + .label-text,
  .floating-label input:not(:placeholder-shown) + .label-text {
    top: 0.5rem;
    font-size: 0.75rem;
    color: var(--brand-green);
  }

  .label-text {
    position: absolute;
    top: 1rem;
    left: 1rem;
    color: var(--text-secondary);
    font-size: 0.9375rem;
    transition: all 0.2s ease;
    pointer-events: none;
    background: var(--input-bg);
    padding: 0 0.25rem;
  }

  .input-icon {
    position: absolute;
    right: 3rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--text-secondary);
  }

  .password-toggle {
    position: absolute;
    right: 1rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: color 0.2s ease;
  }

  .password-toggle:hover {
    color: var(--brand-green);
  }

  /* Validation Hints */
  .validation-hint {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
  }

  /* Password Strength */
  .password-strength {
    margin-top: 0.75rem;
  }

  .strength-label {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .strength-label .label-text {
    position: static;
    font-size: 0.75rem;
    color: var(--text-secondary);
    background: none;
  }

  .strength-value {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-secondary);
  }

  .strength-meter {
    display: flex;
    gap: 2px;
  }

  .meter-bar {
    flex: 1;
    height: 6px;
    background: var(--card-border);
    border-radius: 3px;
    transition: all 0.3s ease;
  }

  .meter-bar.active {
    background: var(--brand-green);
  }

  .meter-bar.active.weak { background: #ef4444; }
  .meter-bar.active.medium { background: #f59e0b; }
  .meter-bar.active.strong { background: #22c55e; }
  .meter-bar.active.very-strong { background: #16a34a; }

  /* Match Indicator */
  .match-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-top: 0.5rem;
    padding: 0.5rem 0.75rem;
    background: var(--warning-light);
    border-radius: 8px;
    font-size: 0.8125rem;
    color: #92400e;
  }

  .match-indicator.matching {
    background: var(--success-light);
    color: #065f46;
  }

  .match-indicator.matching svg {
    stroke: #22c55e;
  }

  .match-indicator.mismatch {
    background: var(--error-light);
    color: #991b1b;
  }

  .match-indicator.mismatch svg {
    stroke: #ef4444;
  }

  .dark-theme .match-indicator {
    color: #fbbf24;
  }

  .dark-theme .match-indicator.matching {
    color: #a7f3d0;
  }

  .dark-theme .match-indicator.mismatch {
    color: #fecaca;
  }

  /* Password Requirements */
  .password-requirements {
    background: var(--input-bg);
    border-radius: 12px;
    padding: 1.25rem;
  }

  .requirements-title {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
  }

  .requirements-title svg {
    color: var(--brand-blue);
  }

  .requirements-list {
    list-style: none;
  }

  .requirement-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    padding: 0.25rem 0;
  }

  .requirement-check {
    width: 16px;
    height: 16px;
    border: 2px solid var(--card-border);
    border-radius: 50%;
    position: relative;
    flex-shrink: 0;
    transition: all 0.2s ease;
  }

  .requirement-item.valid .requirement-check {
    background: var(--brand-green);
    border-color: var(--brand-green);
  }

  .requirement-item.valid .requirement-check::after {
    content: '';
    position: absolute;
    left: 4px;
    top: 1px;
    width: 5px;
    height: 9px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  /* Password Tips */
  .password-tips {
    background: linear-gradient(135deg, rgba(124, 58, 237, 0.05), rgba(37, 99, 235, 0.05));
    border-radius: 12px;
    padding: 1rem;
    border: 1px solid rgba(124, 58, 237, 0.1);
  }

  .tip-item {
    display: flex;
    align-items: flex-start;
    gap: 0.75rem;
    font-size: 0.8125rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
  }

  .tip-item:last-child {
    margin-bottom: 0;
  }

  .tip-item svg {
    flex-shrink: 0;
    color: var(--brand-purple);
    margin-top: 0.125rem;
  }

  /* Buttons */
  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.875rem 1.5rem;
    font-size: 0.9375rem;
    font-weight: 600;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    position: relative;
    overflow: hidden;
  }

  .btn.primary {
    background: linear-gradient(135deg, var(--brand-green), #16a34a);
    color: white;
  }

  .btn.primary:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(34, 197, 94, 0.3);
  }

  .btn.primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
  }

  .btn.secondary {
    background: linear-gradient(135deg, var(--brand-purple), #9333ea);
    color: white;
  }

  .btn.secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(124, 58, 237, 0.3);
  }

  .btn.outline {
    background: transparent;
    color: var(--text-primary);
    border: 2px solid var(--card-border);
  }

  .btn.outline:hover {
    border-color: var(--brand-blue);
    background: rgba(37, 99, 235, 0.05);
  }

  .btn.wfull {
    width: 100%;
  }

  .submit-btn {
    height: 48px;
  }

  .btn-text {
    transition: opacity 0.2s ease;
  }

  .spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    gap: 4px;
  }

  .spinner.hidden {
    display: none;
  }

  .spinner-dot {
    width: 6px;
    height: 6px;
    background: white;
    border-radius: 50%;
    animation: bounce 1.4s infinite ease-in-out both;
  }

  .spinner-dot:nth-child(1) { animation-delay: -0.32s; }
  .spinner-dot:nth-child(2) { animation-delay: -0.16s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }

  /* Password History */
  .password-history {
    background: var(--input-bg);
    border-radius: 12px;
    padding: 1rem;
    margin-top: 1rem;
  }

  .password-history h4 {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-primary);
  }

  .password-history p {
    font-size: 0.8125rem;
    color: var(--text-secondary);
  }

  /* Success State */
  .success-state {
    text-align: center;
    animation: fadeIn 0.5s ease;
  }

  .success-state.hidden {
    display: none;
  }

  .success-icon {
    width: 72px;
    height: 72px;
    background: linear-gradient(135deg, var(--brand-green), #16a34a);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 1.5rem;
  }

  .success-icon svg {
    width: 32px;
    height: 32px;
    color: white;
  }

  .success-state h3 {
    font-size: 1.25rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    color: var(--text-primary);
  }

  .success-state p {
    color: var(--text-secondary);
    font-size: 0.9375rem;
    margin-bottom: 1.5rem;
    line-height: 1.5;
  }

  .success-actions {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  /* Navigation Links */
  .navigation-links {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 1rem;
    margin-top: 1.5rem;
    flex-wrap: wrap;
  }

  .nav-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    color: var(--brand-blue);
    text-decoration: none;
    font-size: 0.875rem;
    font-weight: 500;
    transition: color 0.2s ease;
  }

  .nav-link:hover {
    color: var(--brand-purple);
    text-decoration: underline;
  }

  .link-divider {
    color: var(--text-secondary);
    font-size: 0.875rem;
    opacity: 0.5;
  }

  /* Modal */
  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    align-items: center;
    justify-content: center;
    padding: 1rem;
  }

  .modal.active {
    display: flex;
  }

  .modal-content {
    background: var(--card-bg);
    border-radius: 16px;
    max-width: 440px;
    width: 100%;
    animation: modalSlideIn 0.3s ease;
  }

  .modal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1.25rem 1.5rem;
    border-bottom: 1px solid var(--card-border);
  }

  .modal-header h3 {
    font-size: 1.125rem;
    font-weight: 600;
    color: var(--text-primary);
  }

  .modal-close {
    background: none;
    border: none;
    color: var(--text-secondary);
    cursor: pointer;
    padding: 0.25rem;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .modal-close:hover {
    background: var(--card-border);
  }

  .modal-body {
    padding: 1.5rem;
  }

  .generator-controls {
    margin-bottom: 1.5rem;
  }

  .control-group {
    margin-bottom: 1rem;
  }

  .control-group:last-child {
    margin-bottom: 0;
  }

  .control-label {
    display: block;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
  }

  .range-slider {
    width: 100%;
    height: 6px;
    background: var(--card-border);
    border-radius: 3px;
    outline: none;
    -webkit-appearance: none;
  }

  .range-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 20px;
    height: 20px;
    background: var(--brand-green);
    border-radius: 50%;
    cursor: pointer;
  }

  .checkbox-control {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
  }

  .checkbox-control:last-child {
    margin-bottom: 0;
  }

  .checkbox-control input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
  }

  .checkmark {
    width: 18px;
    height: 18px;
    background: var(--input-bg);
    border: 2px solid var(--card-border);
    border-radius: 4px;
    position: relative;
    transition: all 0.2s ease;
  }

  .checkbox-control input:checked ~ .checkmark {
    background: var(--brand-green);
    border-color: var(--brand-green);
  }

  .checkmark::after {
    content: '';
    position: absolute;
    display: none;
    left: 5px;
    top: 2px;
    width: 5px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
  }

  .checkbox-control input:checked ~ .checkmark::after {
    display: block;
  }

  .checkbox-text {
    font-size: 0.875rem;
    color: var(--text-primary);
  }

  .generator-output {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
  }

  .password-output {
    flex: 1;
    padding: 0.75rem 1rem;
    background: var(--input-bg);
    border: 2px solid var(--card-border);
    border-radius: 8px;
    font-family: monospace;
    font-size: 0.875rem;
    color: var(--text-primary);
  }

  /* Animations */
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Mobile Optimizations for Hisense U50 Lite (360px width) */
  @media (max-width: 360px) {
    body {
      padding: 0.5rem;
      align-items: flex-start;
    }

    .auth-page.mini {
      padding: 0;
    }

    .page-title {
      font-size: 1.5rem;
    }

    .page-subtitle {
      font-size: 0.875rem;
    }

    .card {
      padding: 1.5rem 1.25rem;
      border-radius: 16px;
    }

    .security-status {
      flex-direction: column;
      text-align: center;
      gap: 0.75rem;
    }

    .floating-label input {
      padding: 0.875rem 3.25rem 0.375rem 0.875rem;
      font-size: 0.875rem;
    }

    .input-icon {
      right: 2.75rem;
    }

    .btn {
      padding: 0.75rem 1.25rem;
      font-size: 0.875rem;
    }

    .password-requirements {
      padding: 1rem;
    }

    .navigation-links {
      flex-direction: column;
      gap: 0.75rem;
    }

    .link-divider {
      display: none;
    }

    .success-actions {
      flex-direction: column;
    }

    .generator-output {
      flex-direction: column;
    }
  }

  /* Accessibility */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Focus styles for keyboard navigation */
  :focus-visible {
    outline: 2px solid var(--brand-green);
    outline-offset: 2px;
  }
</style>

<script nonce="<%= typeof nonce !== 'undefined' ? nonce : '' %>">
  (function () {
    'use strict';

    // Navigation Helper
    const initNavigation = () => {
      document.querySelectorAll('a[data-nav="true"]').forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = link.href;
        });
      });
    };

    // Password Toggle
    const initPasswordToggle = () => {
      document.querySelectorAll('.password-toggle').forEach(button => {
        button.addEventListener('click', () => {
          const targetId = button.getAttribute('data-target');
          const input = document.getElementById(targetId);
          if (!input) return;

          const isPassword = input.type === 'password';
          input.type = isPassword ? 'text' : 'password';
          
          const eyeIcon = button.querySelector('svg');
          if (eyeIcon) {
            if (isPassword) {
              eyeIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line>';
            } else {
              eyeIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>';
            }
          }
        });
      });
    };

    // Password Strength Calculator
    const calculatePasswordStrength = (password) => {
      let score = 0;
      const requirements = {
        length: password.length >= 6,
        number: /[0-9]/.test(password),
        lowercase: /[a-z]/.test(password),
        uppercase: /[A-Z]/.test(password),
        special: /[!@#$%^&*]/.test(password)
      };

      // Calculate score
      Object.values(requirements).forEach(met => {
        if (met) score++;
      });

      // Strength levels
      const levels = [
        { min: 0, max: 1, label: 'Very Weak', color: '#ef4444', className: 'weak' },
        { min: 2, max: 2, label: 'Weak', color: '#ef4444', className: 'weak' },
        { min: 3, max: 3, label: 'Medium', color: '#f59e0b', className: 'medium' },
        { min: 4, max: 4, label: 'Strong', color: '#22c55e', className: 'strong' },
        { min: 5, max: 5, label: 'Very Strong', color: '#16a34a', className: 'very-strong' }
      ];

      const level = levels.find(l => score >= l.min && score <= l.max) || levels[0];
      
      return {
        score,
        requirements,
        level
      };
    };

    // Update Password Strength Display
    const updatePasswordStrength = (password) => {
      const strength = calculatePasswordStrength(password);
      const strengthValue = document.getElementById('strengthValue');
      const meterBars = document.querySelectorAll('.meter-bar');
      
      // Update strength value
      if (strengthValue) {
        strengthValue.textContent = strength.level.label;
        strengthValue.style.color = strength.level.color;
      }
      
      // Update meter bars
      meterBars.forEach((bar, index) => {
        bar.className = 'meter-bar';
        if (index < strength.score) {
          bar.classList.add('active', strength.level.className);
        }
      });
      
      // Update requirements
      const requirementItems = document.querySelectorAll('.requirement-item');
      requirementItems.forEach(item => {
        const requirement = item.getAttribute('data-requirement');
        if (strength.requirements[requirement]) {
          item.classList.add('valid');
        } else {
          item.classList.remove('valid');
        }
      });
      
      return strength;
    };

    // Password Match Checker
    const checkPasswordMatch = () => {
      const newPassword = document.getElementById('next').value;
      const confirmPassword = document.getElementById('confirm').value;
      const matchIndicator = document.getElementById('matchIndicator');
      
      if (!newPassword && !confirmPassword) {
        // Both empty
        matchIndicator.className = 'match-indicator';
        matchIndicator.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span>Passwords will be checked for match</span>
        `;
        return false;
      } else if (!newPassword || !confirmPassword) {
        // One empty
        matchIndicator.className = 'match-indicator';
        matchIndicator.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="12" y1="8" x2="12" y2="12"></line>
            <line x1="12" y1="16" x2="12.01" y2="16"></line>
          </svg>
          <span>Enter both passwords to check</span>
        `;
        return false;
      } else if (newPassword === confirmPassword) {
        // Match
        matchIndicator.className = 'match-indicator matching';
        matchIndicator.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <span>Passwords match ‚úì</span>
        `;
        return true;
      } else {
        // Mismatch
        matchIndicator.className = 'match-indicator mismatch';
        matchIndicator.innerHTML = `
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <line x1="8" y1="8" x2="16" y2="16"></line>
            <line x1="16" y1="8" x2="8" y2="16"></line>
          </svg>
          <span>Passwords do not match ‚úó</span>
        `;
        return false;
      }
    };

    // Form Validation
    const initFormValidation = () => {
      const form = document.getElementById('passwordForm');
      const currentPasswordInput = document.getElementById('current');
      const newPasswordInput = document.getElementById('next');
      const confirmPasswordInput = document.getElementById('confirm');
      const submitBtn = document.getElementById('submitBtn');
      const btnText = submitBtn?.querySelector('.btn-text');
      const spinner = submitBtn?.querySelector('.spinner');
      const successState = document.getElementById('successState');
      
      if (!form) return;

      let isCurrentValid = false;
      let isNewPasswordValid = false;
      let passwordsMatch = false;

      // Real-time validation
      const validateInputs = () => {
        const currentPassword = currentPasswordInput.value;
        const newPassword = newPasswordInput.value;
        const confirmPassword = confirmPasswordInput.value;
        
        // Validate current password
        isCurrentValid = currentPassword.length >= 6;
        
        // Validate new password strength
        const strength = updatePasswordStrength(newPassword);
        isNewPasswordValid = strength.score >= 3; // At least medium strength
        
        // Validate password match
        passwordsMatch = checkPasswordMatch();
        
        // Update submit button state
        const isValid = isCurrentValid && isNewPasswordValid && passwordsMatch;
        submitBtn.disabled = !isValid;
        
        // Visual feedback for button
        if (isValid) {
          submitBtn.style.opacity = '1';
          submitBtn.style.cursor = 'pointer';
        } else {
          submitBtn.style.opacity = '0.7';
          submitBtn.style.cursor = 'not-allowed';
        }
      };

      // Event listeners for real-time validation
      currentPasswordInput.addEventListener('input', validateInputs);
      newPasswordInput.addEventListener('input', validateInputs);
      confirmPasswordInput.addEventListener('input', validateInputs);

      // Form submission
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Validate final state
        validateInputs();
        
        if (!isCurrentValid) {
          showFlashMessage('Current password must be at least 6 characters', 'error');
          currentPasswordInput.focus();
          return;
        }
        
        if (!isNewPasswordValid) {
          showFlashMessage('New password is too weak. Please choose a stronger password.', 'error');
          newPasswordInput.focus();
          return;
        }
        
        if (!passwordsMatch) {
          showFlashMessage('New passwords do not match. Please check and try again.', 'error');
          confirmPasswordInput.focus();
          return;
        }
        
        // Check if new password is same as current
        if (currentPasswordInput.value === newPasswordInput.value) {
          showFlashMessage('New password cannot be the same as your current password', 'error');
          newPasswordInput.focus();
          return;
        }
        
        // Show loading state
        if (btnText) btnText.style.opacity = '0';
        if (spinner) spinner.classList.remove('hidden');
        submitBtn.disabled = true;
        
        try {
          // Submit the form
          const formData = new FormData(form);
          const response = await fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
              'Accept': 'application/json'
            }
          });
          
          if (response.ok) {
            // Success - show success state
            form.style.display = 'none';
            if (successState) {
              successState.classList.remove('hidden');
            }
            
            // Store password change timestamp
            try {
              localStorage.setItem('passwordLastChanged', new Date().toISOString());
            } catch (error) {
              console.error('Failed to store password change timestamp:', error);
            }
            
            // Update button text
            if (btnText) {
              btnText.style.opacity = '1';
              btnText.textContent = 'Password Updated!';
            }
          } else {
            throw new Error('Failed to change password');
          }
          
        } catch (error) {
          console.error('Error:', error);
          showFlashMessage('Failed to update password. Please check your current password and try again.', 'error');
          
          // Reset button state
          if (btnText) {
            btnText.style.opacity = '1';
            btnText.textContent = 'Update Password';
          }
          if (spinner) spinner.classList.add('hidden');
          submitBtn.disabled = false;
        }
      });

      // Initial validation
      validateInputs();
      
      // Auto-focus current password field
      setTimeout(() => {
        if (currentPasswordInput && !currentPasswordInput.value) {
          currentPasswordInput.focus();
        }
      }, 100);
    };

    // Password Generator
    const initPasswordGenerator = () => {
      const generatorBtn = document.createElement('button');
      generatorBtn.type = 'button';
      generatorBtn.className = 'btn secondary';
      generatorBtn.innerHTML = `
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M12 2v4"></path>
          <path d="M12 18v4"></path>
          <path d="M4.93 4.93l2.83 2.83"></path>
          <path d="M16.24 16.24l2.83 2.83"></path>
          <path d="M2 12h4"></path>
          <path d="M18 12h4"></path>
          <path d="M4.93 19.07l2.83-2.83"></path>
          <path d="M16.24 7.76l2.83-2.83"></path>
        </svg>
        Generate Strong Password
      `;
      
      const newPasswordGroup = document.querySelector('.input-group:nth-child(2)');
      if (newPasswordGroup) {
        newPasswordGroup.appendChild(generatorBtn);
      }
      
      const modal = document.getElementById('passwordGeneratorModal');
      const closeBtn = modal?.querySelector('.modal-close');
      const lengthSlider = document.getElementById('lengthSlider');
      const lengthValue = document.getElementById('lengthValue');
      const generateBtn = document.getElementById('generatePassword');
      const copyBtn = document.getElementById('copyPassword');
      const generatedPassword = document.getElementById('generatedPassword');
      
      // Open modal
      generatorBtn.addEventListener('click', () => {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        generateRandomPassword();
      });
      
      // Close modal
      const closeModal = () => {
        modal.classList.remove('active');
        document.body.style.overflow = 'auto';
      };
      
      if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
      }
      
      // Close on outside click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
          closeModal();
        }
      });
      
      // Update length value
      if (lengthSlider && lengthValue) {
        lengthSlider.addEventListener('input', () => {
          lengthValue.textContent = lengthSlider.value;
        });
      }
      
      // Generate password
      const generateRandomPassword = () => {
        const length = parseInt(lengthSlider.value);
        const uppercase = document.getElementById('uppercaseCheck').checked;
        const lowercase = document.getElementById('lowercaseCheck').checked;
        const numbers = document.getElementById('numbersCheck').checked;
        const symbols = document.getElementById('symbolsCheck').checked;
        
        const chars = [];
        if (uppercase) chars.push('ABCDEFGHIJKLMNOPQRSTUVWXYZ');
        if (lowercase) chars.push('abcdefghijklmnopqrstuvwxyz');
        if (numbers) chars.push('0123456789');
        if (symbols) chars.push('!@#$%^&*');
        
        if (chars.length === 0) {
          generatedPassword.value = 'Select at least one character type';
          return;
        }
        
        let password = '';
        const allChars = chars.join('');
        
        // Ensure at least one character from each selected type
        chars.forEach(charSet => {
          password += charSet[Math.floor(Math.random() * charSet.length)];
        });
        
        // Fill the rest randomly
        for (let i = password.length; i < length; i++) {
          password += allChars[Math.floor(Math.random() * allChars.length)];
        }
        
        // Shuffle the password
        password = password.split('').sort(() => Math.random() - 0.5).join('');
        
        generatedPassword.value = password;
      };
      
      if (generateBtn) {
        generateBtn.addEventListener('click', generateRandomPassword);
      }
      
      // Copy password
      if (copyBtn && generatedPassword) {
        copyBtn.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(generatedPassword.value);
            
            // Show success feedback
            const originalText = copyBtn.innerHTML;
            copyBtn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg> Copied!';
            copyBtn.style.background = '#22C55E';
            
            // Auto-fill password field
            const newPasswordInput = document.getElementById('next');
            if (newPasswordInput) {
              newPasswordInput.value = generatedPassword.value;
              newPasswordInput.dispatchEvent(new Event('input'));
            }
            
            setTimeout(() => {
              copyBtn.innerHTML = originalText;
              copyBtn.style.background = '';
            }, 2000);
          } catch (err) {
            console.error('Failed to copy:', err);
            showFlashMessage('Failed to copy password', 'error');
          }
        });
      }
      
      // Initial generation
      generateRandomPassword();
    };

    // Load Password History
    const initPasswordHistory = () => {
      const historySection = document.getElementById('passwordHistory');
      const lastChangedElement = document.getElementById('lastChanged');
      
      if (!historySection || !lastChangedElement) return;
      
      try {
        const lastChanged = localStorage.getItem('passwordLastChanged');
        if (lastChanged) {
          const date = new Date(lastChanged);
          const now = new Date();
          const diff = now - date;
          const days = Math.floor(diff / (1000 * 60 * 60 * 24));
          
          let timeText;
          if (days === 0) {
            timeText = 'today';
          } else if (days === 1) {
            timeText = 'yesterday';
          } else if (days < 7) {
            timeText = `${days} days ago`;
          } else if (days < 30) {
            timeText = `${Math.floor(days / 7)} weeks ago`;
          } else {
            timeText = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }
          
          lastChangedElement.textContent = timeText;
          historySection.hidden = false;
        }
      } catch (error) {
        console.error('Failed to load password history:', error);
      }
    };

    // Flash Message Helper
    const showFlashMessage = (message, type = 'success') => {
      // Remove existing flash messages
      document.querySelectorAll('.flash').forEach(flash => flash.remove());
      
      const flash = document.createElement('div');
      flash.className = `flash flash-${type}`;
      flash.innerHTML = `
        <svg class="flash-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          ${type === 'success' ? 
            '<polyline points="20 6 9 17 4 12"></polyline>' :
            '<circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line>'
          }
        </svg>
        <div class="flash-content">
          <strong>${type === 'success' ? 'Success!' : 'Error:'}</strong> ${message}
        </div>
      `;
      
      // Insert after brand header
      const brandHeader = document.querySelector('.brand-header');
      if (brandHeader) {
        brandHeader.parentNode.insertBefore(flash, brandHeader.nextSibling);
      }
      
      // Remove after 5 seconds
      setTimeout(() => {
        if (flash.parentNode) {
          flash.style.opacity = '0';
          flash.style.transform = 'translateY(-10px)';
          flash.style.transition = 'all 0.3s ease';
          
          setTimeout(() => {
            if (flash.parentNode) {
              flash.parentNode.removeChild(flash);
            }
          }, 300);
        }
      }, 5000);
    };

    // Initialize everything when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      initNavigation();
      initPasswordToggle();
      initFormValidation();
      initPasswordGenerator();
      initPasswordHistory();
      
      // Add entrance animation
      const form = document.querySelector('.auth-form');
      if (form) {
        form.style.opacity = '0';
        form.style.transform = 'translateY(20px)';
        
        setTimeout(() => {
          form.style.transition = 'opacity 0.4s ease, transform 0.4s ease';
          form.style.opacity = '1';
          form.style.transform = 'translateY(0)';
        }, 100);
      }
    });

  })();
</script>